# CookTip 美食菜谱小程序后端 API

## 项目简介

CookTip 是一个基于微信小程序的美食菜谱分享平台后端服务，使用 Nest.js + TypeScript + MySQL 开发。

### 技术栈

- **后端框架**: Nest.js (Node.js + TypeScript)
- **数据库**: 微信云托管 MySQL
- **ORM**: TypeORM
- **认证**: JWT + 微信小程序登录
- **API文档**: Swagger
- **部署**: 微信云托管 + Docker

### 主要功能

✅ 认证模块 - 微信登录、Token刷新、退出登录  
✅ 用户模块 - 用户信息管理、统计数据  
✅ 食谱模块 - 食谱CRUD、点赞、收藏、浏览  
✅ 评论模块 - 评论管理、点赞、回复  
✅ 收藏模块 - 收藏管理、状态检查  
✅ 搜索模块 - 食谱搜索、热门搜索词  
✅ 购物清单模块 - 购物清单管理  
✅ 分类模块 - 分类管理  
✅ 文件上传模块 - 图片上传  
✅ 统计模块 - 数据统计、首页推荐  

---

## 🌐 生产环境

### 服务地址
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```

### API 基础路径
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1
```

### API 文档 (Swagger)
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/docs
```

### 快速测试
```bash
# 测试健康检查
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/

# 测试分类接口
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories

# 访问 API 文档
浏览器打开: https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/docs
```

---

## 快速开始

### 前置要求

- Node.js >= 16.x
- MySQL >= 5.7
- npm 或 yarn

### 安装依赖

```bash
npm install
```

### 配置环境变量

**⚠️ 重要：本项目使用微信云托管 MySQL 数据库**

请先参考 [云数据库配置.md](./云数据库配置.md) 完成云数据库配置。

复制 `.env.example` 为 `.env`，并修改配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件，填入真实配置：

```env
# 应用配置
NODE_ENV=development
PORT=3000
API_PREFIX=api/v1

# 微信云托管 MySQL 数据库配置
# 云托管环境使用内网地址
DB_HOST=10.32.104.72
DB_PORT=3306

# 本地开发使用外网地址（需配置IP白名单）
# DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
# DB_PORT=27821

DB_USER=您的数据库账号
DB_PASSWORD=您的数据库密码
DB_NAME=cooktip
DB_SYNCHRONIZE=false

# JWT 配置
JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d

# 微信小程序配置
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c
```

### 初始化数据库

**方式一：通过云托管服务器（推荐）**

```bash
# 使用内网地址连接
mysql -h 10.32.104.72 -P 3306 -u 数据库账号 -p cooktip < database/init.sql
```

**方式二：本地执行（使用外网地址）**

```bash
# 使用外网地址连接（需配置IP白名单）
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u 数据库账号 -p cooktip < database/init.sql
```

详细配置步骤请参考 [云数据库配置.md](./云数据库配置.md)

### 运行项目

```bash
# 开发环境
npm run start:dev

# 生产环境
npm run build
npm run start:prod
```

### 访问服务

- 应用地址: http://localhost:3000
- API文档: http://localhost:3000/api/docs
- 健康检查: http://localhost:3000/api/v1/health

## API 接口文档

启动项目后，访问 Swagger 文档查看完整 API 接口：

http://localhost:3000/api/docs

### 主要接口

| 模块 | 接口数量 | 路径前缀 |
|------|---------|----------|
| 认证模块 | 3个 | `/api/v1/auth` |
| 用户模块 | 5个 | `/api/v1/users` |
| 食谱模块 | 8个 | `/api/v1/recipes` |
| 评论模块 | 5个 | `/api/v1/comments` |
| 收藏模块 | 4个 | `/api/v1/favorites` |
| 搜索模块 | 3个 | `/api/v1/search` |
| 购物清单模块 | 5个 | `/api/v1/shopping-list` |
| 分类模块 | 2个 | `/api/v1/categories` |
| 文件上传模块 | 2个 | `/api/v1/upload` |
| 统计模块 | 3个 | `/api/v1/stats` |

## 项目结构

```
cooktip-backend/
├── src/
│   ├── common/              # 公共模块
│   │   ├── decorators/      # 装饰器
│   │   ├── filters/         # 异常过滤器
│   │   ├── guards/          # 守卫
│   │   └── interceptors/    # 拦截器
│   ├── entities/            # 数据库实体
│   │   ├── user.entity.ts
│   │   ├── recipe.entity.ts
│   │   ├── comment.entity.ts
│   │   ├── favorite.entity.ts
│   │   ├── like.entity.ts
│   │   ├── shopping-list.entity.ts
│   │   └── category.entity.ts
│   ├── modules/             # 业务模块
│   │   ├── auth/            # 认证模块
│   │   ├── user/            # 用户模块
│   │   ├── recipe/          # 食谱模块
│   │   ├── comment/         # 评论模块
│   │   ├── favorite/        # 收藏模块
│   │   ├── search/          # 搜索模块
│   │   ├── shopping-list/   # 购物清单模块
│   │   ├── category/        # 分类模块
│   │   ├── upload/          # 文件上传模块
│   │   └── stats/           # 统计模块
│   ├── app.module.ts        # 应用模块
│   └── main.ts              # 入口文件
├── database/                # 数据库脚本
│   ├── init.sql             # 初始化脚本
│   └── seed.sql             # 测试数据
├── uploads/                 # 上传文件目录
├── .env.example             # 环境变量示例
├── .gitignore
├── Dockerfile
├── docker-compose.yml
├── nest-cli.json
├── package.json
├── tsconfig.json
└── 项目说明.md
```

## Docker 部署

### 使用 Docker Compose

```bash
# 构建并启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 单独使用 Docker

```bash
# 构建镜像
docker build -t cooktip-backend .

# 运行容器
docker run -d \
  -p 3000:3000 \
  --env-file .env \
  --name cooktip-api \
  cooktip-backend
```

## 微信云托管部署

1. 安装微信云托管 CLI
```bash
npm install -g @cloudbase/cli
```

2. 登录微信云托管
```bash
tcb login
```

3. 初始化云托管
```bash
tcb init
```

4. 部署服务
```bash
tcb fn deploy cooktip-api
```

## 开发指南

### 代码规范

```bash
# 代码格式化
npm run format

# 代码检查
npm run lint
```

### 测试

```bash
# 单元测试
npm run test

# 端到端测试
npm run test:e2e

# 测试覆盖率
npm run test:cov
```

## 数据库设计

项目使用 TypeORM 管理数据库，主要数据表：

- `users` - 用户表
- `recipes` - 食谱表
- `comments` - 评论表
- `favorites` - 收藏表
- `likes` - 点赞表
- `shopping_list` - 购物清单表
- `categories` - 分类表

详细表结构请查看 `database/init.sql`

## 性能优化

- ✅ 使用索引优化数据库查询
- ✅ 实现 JWT Token 认证
- ✅ 全局响应拦截器
- ✅ 全局异常处理
- ✅ 参数验证管道
- ✅ API 限流保护

## 安全性

- ✅ JWT Token 认证
- ✅ 参数验证（class-validator）
- ✅ SQL 注入防护（TypeORM）
- ✅ XSS 防护
- ✅ 限流保护
- ✅ CORS 配置

## 常见问题

### 1. 数据库连接失败

检查 `.env` 文件中的数据库配置是否正确。

### 2. 微信登录失败

确保 `WECHAT_APPID` 和 `WECHAT_SECRET` 配置正确。

### 3. 文件上传失败

检查 `uploads` 目录是否存在且有写入权限。

## 贡献指南

欢迎提交 Issue 和 Pull Request！

## 许可证

[MIT](LICENSE)

## 联系方式

- 邮箱: 3509204288@qq.com
- 项目文档: 查看 `后端API开发文档.md`
- 技术选型: 查看 `后端技术选型方案.md`

## 更新日志

### v1.0.0 (2025-01-08)

- ✅ 完成所有核心功能模块开发
- ✅ 实现 40 个 API 接口
- ✅ 集成 Swagger API 文档
- ✅ Docker 容器化部署支持
- ✅ 微信云托管部署支持

---

**CookTip 开发团队** 🍳

