# 🚀 临时解决方案 - 无需自定义域名

**问题**：云托管默认域名无法用作 request 合法域名  
**发现**：downloadFile 可以使用云托管默认域名  
**方案**：使用微信云开发环境作为 API 代理  
**时间**：30 分钟配置

---

## 📊 域名限制总结

| 域名用途 | 云托管默认域名 | 自定义域名 | 云开发域名 |
|---------|--------------|-----------|-----------|
| request（API 请求） | ❌ 不可用 | ✅ 可用 | ✅ 可用 |
| uploadFile（上传） | ❌ 不可用 | ✅ 可用 | ✅ 可用 |
| downloadFile（下载） | ✅ **可用** | ✅ 可用 | ✅ 可用 |

---

## 🎯 可选方案对比

### 方案 A：配置自定义域名（推荐，生产环境）

**优点**：
- ✅ 专业、稳定
- ✅ 完全控制
- ✅ 适合生产环境

**缺点**：
- ❌ 需要已备案的域名
- ❌ 备案时间长（7-20 天）
- ❌ 有一定成本（50-100 元/年）

**适用场景**：正式上线的生产环境

**参考文档**：`自定义域名配置指南.md`

---

### 方案 B：使用云开发 HTTP API（临时方案）

**优点**：
- ✅ 无需域名
- ✅ 立即可用
- ✅ 微信官方支持
- ✅ 自动在白名单中

**缺点**：
- ⚠️ 需要改造后端接口
- ⚠️ 有请求次数限制
- ⚠️ 仅限微信环境

**适用场景**：快速测试、MVP 验证

---

### 方案 C：仅使用开发者工具（临时调试）

**优点**：
- ✅ 无需任何配置
- ✅ 立即可用

**缺点**：
- ❌ 仅限开发工具
- ❌ 无法真机预览
- ❌ 无法发布

**适用场景**：纯本地开发调试

---

## 🚀 方案 B 详细步骤：使用云开发 HTTP API

### 原理说明

```
小程序 → 云开发 HTTP API → 云托管后端服务
        (微信官方域名)      (内网访问)
```

**优势**：
1. 云开发的域名自动在小程序白名单中
2. 云开发可以通过内网访问云托管
3. 无需购买域名和备案

---

### 第 1 步：开通云开发环境

#### 1.1 在微信开发者工具开通

1. 打开微信开发者工具
2. 点击 **云开发** 按钮
3. 首次使用需要开通云开发环境
4. 选择套餐：**免费版**（足够测试使用）
5. 环境名称：`cooktip-prod`
6. 等待创建完成（约 2-3 分钟）

#### 1.2 获取环境 ID

创建完成后，会得到一个环境 ID，类似：
```
cooktip-prod-xxx
```

记下这个 ID，后面要用。

---

### 第 2 步：创建云函数作为 API 代理

#### 2.1 在云开发控制台创建云函数

1. 点击 **云开发控制台**
2. 选择 **云函数** 标签
3. 点击 **新建云函数**
4. 函数名称：`api-proxy`
5. 运行环境：Node.js 16

#### 2.2 编写云函数代码

在云函数目录创建 `index.js`：

```javascript
// 云函数入口文件
const cloud = require('wx-server-sdk')
const axios = require('axios')

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

// 云托管内网地址
const API_BASE_URL = 'http://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com'

exports.main = async (event, context) => {
  const { method = 'GET', path = '/', data = {}, headers = {} } = event

  try {
    // 转发请求到云托管
    const response = await axios({
      method: method.toUpperCase(),
      url: `${API_BASE_URL}${path}`,
      data: method.toUpperCase() === 'GET' ? undefined : data,
      params: method.toUpperCase() === 'GET' ? data : undefined,
      headers: {
        'Content-Type': 'application/json',
        ...headers
      },
      timeout: 10000
    })

    return {
      statusCode: response.status,
      data: response.data
    }
  } catch (error) {
    console.error('API 转发错误:', error.message)
    
    return {
      statusCode: error.response?.status || 500,
      data: {
        code: error.response?.status || 500,
        message: error.response?.data?.message || error.message
      }
    }
  }
}
```

#### 2.3 配置 package.json

在云函数目录创建 `package.json`：

```json
{
  "name": "api-proxy",
  "version": "1.0.0",
  "description": "API 代理云函数",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "latest",
    "axios": "^1.6.2"
  }
}
```

#### 2.4 上传并部署

1. 右键云函数目录
2. 点击 **云端安装依赖**
3. 等待依赖安装完成
4. 右键云函数目录
5. 点击 **上传并部署：云端安装依赖**

---

### 第 3 步：前端调用云函数

#### 3.1 初始化云开发

在小程序 `app.js` 中初始化：

```javascript
App({
  onLaunch: function () {
    // 初始化云开发
    wx.cloud.init({
      env: 'cooktip-prod-xxx', // 替换为您的环境 ID
      traceUser: true
    })
  }
})
```

#### 3.2 创建统一请求方法

创建 `utils/cloudRequest.js`：

```javascript
/**
 * 通过云函数代理请求后端 API
 */
function cloudRequest(options) {
  const { url, method = 'GET', data = {}, header = {} } = options
  
  return new Promise((resolve, reject) => {
    wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: method.toUpperCase(),
        path: url,
        data: data,
        headers: header
      },
      success: (res) => {
        if (res.result.statusCode === 200) {
          resolve(res.result.data)
        } else {
          wx.showToast({
            title: res.result.data.message || '请求失败',
            icon: 'none'
          })
          reject(res.result.data)
        }
      },
      fail: (err) => {
        console.error('云函数调用失败:', err)
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        })
        reject(err)
      }
    })
  })
}

module.exports = {
  cloudRequest
}
```

#### 3.3 使用示例

```javascript
const { cloudRequest } = require('../../utils/cloudRequest')

Page({
  data: {
    categories: [],
    recipes: []
  },
  
  async onLoad() {
    try {
      // 获取分类列表
      const categoriesRes = await cloudRequest({
        url: '/api/v1/categories',
        method: 'GET'
      })
      this.setData({
        categories: categoriesRes.data
      })
      
      // 获取食谱列表
      const recipesRes = await cloudRequest({
        url: '/api/v1/recipes',
        method: 'GET',
        data: {
          page: 1,
          limit: 10
        }
      })
      this.setData({
        recipes: recipesRes.data.items
      })
      
    } catch (error) {
      console.error('加载失败:', error)
    }
  }
})
```

---

### 第 4 步：处理图片 URL

**重要**：图片 URL 需要特殊处理，因为它们指向对象存储。

#### 方案 1：图片继续使用对象存储（推荐）

图片 URL 已经是对象存储地址，直接使用即可：

```javascript
// 后端返回的图片 URL
{
  "cover_image": "https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/xxx.jpg"
}

// 前端直接使用
<image src="{{recipe.cover_image}}" />
```

**微信小程序 downloadFile 域名配置**：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

#### 方案 2：图片通过云托管下载

如果图片也要通过云托管，可以配置：

**downloadFile 合法域名**：
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

**✅ 这个可以配置**，因为 downloadFile 支持云托管默认域名！

---

## 📊 完整方案对比

### 方案对比表

| 特性 | 方案A（自定义域名） | 方案B（云函数代理） | 方案C（开发工具） |
|------|-------------------|-------------------|------------------|
| 需要域名 | ✅ 需要 | ❌ 不需要 | ❌ 不需要 |
| 需要备案 | ✅ 需要 | ❌ 不需要 | ❌ 不需要 |
| 配置时间 | 1-20 天 | 30 分钟 | 0 分钟 |
| 真机预览 | ✅ 支持 | ✅ 支持 | ❌ 不支持 |
| 正式发布 | ✅ 支持 | ✅ 支持 | ❌ 不支持 |
| 性能 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 稳定性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 适用场景 | 生产环境 | 快速上线/测试 | 仅本地开发 |

---

## 🎯 推荐策略

### 短期方案（立即可用）

**使用方案 B（云函数代理）**：
1. ✅ 无需域名和备案
2. ✅ 30 分钟配置完成
3. ✅ 可以真机预览和发布
4. ✅ 性能和稳定性都不错

**配置域名白名单**：
```
downloadFile 合法域名：
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

---

### 长期方案（生产环境）

**并行准备方案 A（自定义域名）**：
1. 购买域名（如 `cooktip.com`）
2. 提交 ICP 备案（7-20 天）
3. 备案完成后配置自定义域名
4. 切换到自定义域名

**优势**：
- 更专业的访问地址
- 更好的性能和稳定性
- 完全控制

---

## 📋 快速决策指南

### 如果您想**立即上线测试**

👉 **选择方案 B（云函数代理）**

优势：
- ✅ 无需等待备案
- ✅ 30 分钟可完成
- ✅ 功能完整

### 如果您想**正式生产环境**

👉 **选择方案 A（自定义域名）**

优势：
- ✅ 更稳定可靠
- ✅ 更专业
- ✅ 适合长期运营

### 如果您**只是本地开发调试**

👉 **选择方案 C（开发工具）**

在微信开发者工具中：
1. `详情` → `本地设置`
2. 勾选 "不校验合法域名..."
3. 直接使用云托管公网地址

---

## ⚠️ 注意事项

### 关于云函数代理方案（方案B）

**优点**：
- ✅ 快速部署
- ✅ 无需域名
- ✅ 微信官方支持

**限制**：
- ⚠️ 免费版有请求次数限制（10 万次/月）
- ⚠️ 云函数有执行时间限制（20 秒）
- ⚠️ 多一层转发，性能略低

**建议**：
- 作为快速上线的临时方案
- 后续备案完成后切换到自定义域名

---

## 📞 需要帮助？

### 如果选择方案 B（云函数代理）

1. 参考上面的详细步骤
2. 遇到问题可以查看云函数日志
3. 测试时注意查看控制台输出

### 如果选择方案 A（自定义域名）

1. 参考：`自定义域名配置指南.md`
2. 准备域名和备案材料
3. 按步骤配置

---

## ✅ 总结

| 方案 | 时间 | 成本 | 适用场景 |
|------|------|------|---------|
| **方案 A：自定义域名** | 1-20 天 | 50-100 元/年 | 生产环境 |
| **方案 B：云函数代理** | 30 分钟 | 免费 | 快速上线/测试 |
| **方案 C：开发工具** | 0 分钟 | 免费 | 本地开发 |

**我的建议**：
1. 🚀 **立即**：使用方案 B 快速上线
2. 📋 **同时**：开始准备方案 A（购买域名、备案）
3. 🔄 **后续**：备案完成后切换到方案 A

这样既能快速上线，又为长期运营做好准备！

---

**更新时间**：2025-10-16

