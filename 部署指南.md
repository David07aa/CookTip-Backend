# CookTip åç«¯éƒ¨ç½²æŒ‡å—

## éƒ¨ç½²å‰å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 20.04+ æ¨è) / CentOS 7+
- **å†…å­˜**: æœ€ä½ 1GBï¼Œæ¨è 2GB+
- **CPU**: æœ€ä½ 1 æ ¸ï¼Œæ¨è 2 æ ¸+
- **ç£ç›˜**: æœ€ä½ 10GB å¯ç”¨ç©ºé—´

### 2. è½¯ä»¶è¦æ±‚

- Node.js 16.x æˆ–æ›´é«˜ç‰ˆæœ¬
- MySQL 5.7 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆæˆ–ä½¿ç”¨ SQLPubï¼‰
- Dockerï¼ˆå¯é€‰ï¼Œç”¨äºå®¹å™¨åŒ–éƒ¨ç½²ï¼‰
- Git

---

## éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šç›´æ¥éƒ¨ç½²ï¼ˆNode.jsï¼‰

#### 1. å…‹éš†ä»£ç 

```bash
git clone <repository-url>
cd cooktip-backend
```

#### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥çœŸå®é…ç½®
vim .env
```

**å¿…é¡»é…ç½®çš„ç¯å¢ƒå˜é‡**ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=your-sqlpub-host.sqlpub.com
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=cooktip

# JWTå¯†é’¥ï¼ˆé‡è¦ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
JWT_SECRET=your-super-secure-jwt-secret-key-min-32-chars

# å¾®ä¿¡å°ç¨‹åº
WECHAT_APPID=your-wx-appid
WECHAT_SECRET=your-wx-secret
```

#### 4. åˆå§‹åŒ–æ•°æ®åº“

```bash
# è¿æ¥åˆ°æ•°æ®åº“
mysql -h <DB_HOST> -P <DB_PORT> -u <DB_USER> -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE cooktip DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci;

# é€€å‡ºMySQLï¼Œå¯¼å…¥è¡¨ç»“æ„
mysql -h <DB_HOST> -P <DB_PORT> -u <DB_USER> -p cooktip < database/init.sql

# ï¼ˆå¯é€‰ï¼‰å¯¼å…¥æµ‹è¯•æ•°æ®
mysql -h <DB_HOST> -P <DB_PORT> -u <DB_USER> -p cooktip < database/seed.sql
```

#### 5. æ„å»ºå’Œå¯åŠ¨

```bash
# æ„å»ºé¡¹ç›®
npm run build

# å¯åŠ¨æœåŠ¡
npm run start:prod
```

#### 6. ä½¿ç”¨ PM2 å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ¨èï¼‰

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨åº”ç”¨
pm2 start dist/main.js --name cooktip-api

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æ—¥å¿—
pm2 logs cooktip-api

# é‡å¯åº”ç”¨
pm2 restart cooktip-api

# åœæ­¢åº”ç”¨
pm2 stop cooktip-api
```

---

### æ–¹å¼äºŒï¼šDocker éƒ¨ç½²

#### 1. æ„å»ºé•œåƒ

```bash
docker build -t cooktip-backend .
```

#### 2. è¿è¡Œå®¹å™¨

```bash
docker run -d \
  --name cooktip-api \
  -p 3000:3000 \
  --env-file .env \
  -v $(pwd)/uploads:/app/uploads \
  --restart unless-stopped \
  cooktip-backend
```

#### 3. æŸ¥çœ‹æ—¥å¿—

```bash
docker logs -f cooktip-api
```

#### 4. åœæ­¢å’Œåˆ é™¤

```bash
docker stop cooktip-api
docker rm cooktip-api
```

---

### æ–¹å¼ä¸‰ï¼šDocker Compose éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 1. ç¼–è¾‘é…ç½®

ç¼–è¾‘ `docker-compose.yml` å’Œ `.env` æ–‡ä»¶

#### 2. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down

# é‡å¯æœåŠ¡
docker-compose restart
```

---

### æ–¹å¼å››ï¼šå¾®ä¿¡äº‘æ‰˜ç®¡éƒ¨ç½²

#### 1. å®‰è£…äº‘æ‰˜ç®¡ CLI

```bash
npm install -g @cloudbase/cli
```

#### 2. ç™»å½•

```bash
tcb login
```

#### 3. åˆå§‹åŒ–é¡¹ç›®

```bash
tcb init
```

é€‰æ‹©äº‘æ‰˜ç®¡æœåŠ¡ï¼Œåˆ›å»ºæœåŠ¡é…ç½®ã€‚

#### 4. é…ç½® cloudbaserc.json

```json
{
  "envId": "your-env-id",
  "functionRoot": "./",
  "functions": [],
  "framework": {
    "name": "cooktip-api",
    "plugins": {
      "node": {
        "use": "@cloudbase/framework-plugin-node",
        "inputs": {
          "entry": "dist/main.js",
          "name": "cooktip-api",
          "runtime": "Nodejs16",
          "installCommand": "npm install",
          "buildCommand": "npm run build"
        }
      }
    }
  }
}
```

#### 5. éƒ¨ç½²

```bash
tcb fn deploy cooktip-api
```

#### 6. é…ç½®ç¯å¢ƒå˜é‡

åœ¨äº‘æ‰˜ç®¡æ§åˆ¶å°é…ç½®ç¯å¢ƒå˜é‡ã€‚

---

## é…ç½® Nginx åå‘ä»£ç†

### 1. å®‰è£… Nginx

```bash
sudo apt update
sudo apt install nginx
```

### 2. é…ç½®ç«™ç‚¹

åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š`/etc/nginx/sites-available/cooktip-api`

```nginx
server {
    listen 80;
    server_name api.cooktip.com;  # ä¿®æ”¹ä¸ºä½ çš„åŸŸå

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€æ–‡ä»¶
    location /uploads {
        alias /path/to/cooktip-backend/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. å¯ç”¨ç«™ç‚¹

```bash
sudo ln -s /etc/nginx/sites-available/cooktip-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 4. é…ç½® HTTPSï¼ˆæ¨èï¼‰

ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ï¼š

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d api.cooktip.com
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å¯ç”¨ Gzip å‹ç¼©

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

### 2. é…ç½®ç¼“å­˜

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. ä½¿ç”¨ Redis ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

å®‰è£… Redisï¼š

```bash
sudo apt install redis-server
```

åœ¨ä»£ç ä¸­é›†æˆ Redis ç¼“å­˜æ¨¡å—ã€‚

---

## ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨æ—¥å¿—

ä½¿ç”¨ PM2 æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
pm2 logs cooktip-api
```

ä½¿ç”¨ Docker æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
docker logs -f cooktip-api
```

### 2. æ•°æ®åº“ç›‘æ§

å®šæœŸæ£€æŸ¥æ•°æ®åº“æ€§èƒ½å’Œæ…¢æŸ¥è¯¢ã€‚

### 3. æœåŠ¡å™¨ç›‘æ§

æ¨èå·¥å…·ï¼š
- **Prometheus + Grafana**
- **é˜¿é‡Œäº‘äº‘ç›‘æ§**
- **è…¾è®¯äº‘äº‘ç›‘æ§**

---

## æ•°æ®å¤‡ä»½

### 1. æ•°æ®åº“å¤‡ä»½

```bash
# å¤‡ä»½è„šæœ¬
mysqldump -h <DB_HOST> -u <DB_USER> -p <DB_NAME> > backup_$(date +%Y%m%d).sql

# å®šæ—¶å¤‡ä»½ï¼ˆcrontabï¼‰
0 2 * * * /path/to/backup.sh
```

### 2. ä¸Šä¼ æ–‡ä»¶å¤‡ä»½

```bash
# å¤‡ä»½ uploads ç›®å½•
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz uploads/
```

---

## å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :3000

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

- æ£€æŸ¥æ•°æ®åº“é…ç½®
- æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
- æ£€æŸ¥ MySQL ç”¨æˆ·æƒé™

### 3. å†…å­˜ä¸è¶³

- å¢åŠ æœåŠ¡å™¨å†…å­˜
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- ä½¿ç”¨ç¼“å­˜

---

## å®‰å…¨å»ºè®®

1. âœ… ä½¿ç”¨ HTTPS
2. âœ… å®šæœŸæ›´æ–°ä¾èµ–åŒ…
3. âœ… é…ç½®é˜²ç«å¢™
4. âœ… é™åˆ¶ API è®¿é—®é¢‘ç‡
5. âœ… å®šæœŸå¤‡ä»½æ•°æ®
6. âœ… ä½¿ç”¨å¼ºå¯†ç 
7. âœ… ç¦ç”¨ä¸å¿…è¦çš„ç«¯å£
8. âœ… é…ç½®æ—¥å¿—å®¡è®¡

---

## æ•…éšœæ’æŸ¥

### æŸ¥çœ‹åº”ç”¨çŠ¶æ€

```bash
# PM2
pm2 status

# Docker
docker ps

# ç³»ç»ŸæœåŠ¡
systemctl status nginx
systemctl status mysql
```

### æŸ¥çœ‹é”™è¯¯æ—¥å¿—

```bash
# åº”ç”¨æ—¥å¿—
pm2 logs cooktip-api --lines 100

# Nginx æ—¥å¿—
tail -f /var/log/nginx/error.log

# ç³»ç»Ÿæ—¥å¿—
journalctl -xe
```

---

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- é‚®ç®±: 3509204288@qq.com
- é¡¹ç›®æ–‡æ¡£: æŸ¥çœ‹ `åç«¯APIå¼€å‘æ–‡æ¡£.md`

---

**CookTip å¼€å‘å›¢é˜Ÿ** ğŸ³

