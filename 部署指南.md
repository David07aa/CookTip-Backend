# CookTip 后端部署指南

## 部署前准备

### 1. 服务器要求

- **操作系统**: Linux (Ubuntu 20.04+ 推荐) / CentOS 7+
- **内存**: 最低 1GB，推荐 2GB+
- **CPU**: 最低 1 核，推荐 2 核+
- **磁盘**: 最低 10GB 可用空间

### 2. 软件要求

- Node.js 16.x 或更高版本
- MySQL 5.7 或更高版本（或使用 SQLPub）
- Docker（可选，用于容器化部署）
- Git

---

## 部署方式

### 方式一：直接部署（Node.js）

#### 1. 克隆代码

```bash
git clone <repository-url>
cd cooktip-backend
```

#### 2. 安装依赖

```bash
npm install
```

#### 3. 配置环境变量

```bash
cp .env.example .env
# 编辑 .env 文件，填入真实配置
vim .env
```

**必须配置的环境变量**：

```env
# 数据库配置
DB_HOST=your-sqlpub-host.sqlpub.com
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=cooktip

# JWT密钥（重要：生产环境必须修改）
JWT_SECRET=your-super-secure-jwt-secret-key-min-32-chars

# 微信小程序
WECHAT_APPID=your-wx-appid
WECHAT_SECRET=your-wx-secret
```

#### 4. 初始化数据库

```bash
# 连接到数据库
mysql -h <DB_HOST> -P <DB_PORT> -u <DB_USER> -p

# 创建数据库
CREATE DATABASE cooktip DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 退出MySQL，导入表结构
mysql -h <DB_HOST> -P <DB_PORT> -u <DB_USER> -p cooktip < database/init.sql

# （可选）导入测试数据
mysql -h <DB_HOST> -P <DB_PORT> -u <DB_USER> -p cooktip < database/seed.sql
```

#### 5. 构建和启动

```bash
# 构建项目
npm run build

# 启动服务
npm run start:prod
```

#### 6. 使用 PM2 守护进程（推荐）

```bash
# 安装 PM2
npm install -g pm2

# 启动应用
pm2 start dist/main.js --name cooktip-api

# 设置开机自启
pm2 startup
pm2 save

# 查看日志
pm2 logs cooktip-api

# 重启应用
pm2 restart cooktip-api

# 停止应用
pm2 stop cooktip-api
```

---

### 方式二：Docker 部署

#### 1. 构建镜像

```bash
docker build -t cooktip-backend .
```

#### 2. 运行容器

```bash
docker run -d \
  --name cooktip-api \
  -p 3000:3000 \
  --env-file .env \
  -v $(pwd)/uploads:/app/uploads \
  --restart unless-stopped \
  cooktip-backend
```

#### 3. 查看日志

```bash
docker logs -f cooktip-api
```

#### 4. 停止和删除

```bash
docker stop cooktip-api
docker rm cooktip-api
```

---

### 方式三：Docker Compose 部署（推荐）

#### 1. 编辑配置

编辑 `docker-compose.yml` 和 `.env` 文件

#### 2. 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

---

### 方式四：微信云托管部署

#### 1. 安装云托管 CLI

```bash
npm install -g @cloudbase/cli
```

#### 2. 登录

```bash
tcb login
```

#### 3. 初始化项目

```bash
tcb init
```

选择云托管服务，创建服务配置。

#### 4. 配置 cloudbaserc.json

```json
{
  "envId": "your-env-id",
  "functionRoot": "./",
  "functions": [],
  "framework": {
    "name": "cooktip-api",
    "plugins": {
      "node": {
        "use": "@cloudbase/framework-plugin-node",
        "inputs": {
          "entry": "dist/main.js",
          "name": "cooktip-api",
          "runtime": "Nodejs16",
          "installCommand": "npm install",
          "buildCommand": "npm run build"
        }
      }
    }
  }
}
```

#### 5. 部署

```bash
tcb fn deploy cooktip-api
```

#### 6. 配置环境变量

在云托管控制台配置环境变量。

---

## 配置 Nginx 反向代理

### 1. 安装 Nginx

```bash
sudo apt update
sudo apt install nginx
```

### 2. 配置站点

创建配置文件：`/etc/nginx/sites-available/cooktip-api`

```nginx
server {
    listen 80;
    server_name api.cooktip.com;  # 修改为你的域名

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 静态文件
    location /uploads {
        alias /path/to/cooktip-backend/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. 启用站点

```bash
sudo ln -s /etc/nginx/sites-available/cooktip-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 4. 配置 HTTPS（推荐）

使用 Let's Encrypt 免费证书：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d api.cooktip.com
```

---

## 性能优化

### 1. 启用 Gzip 压缩

在 Nginx 配置中添加：

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

### 2. 配置缓存

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. 使用 Redis 缓存（可选）

安装 Redis：

```bash
sudo apt install redis-server
```

在代码中集成 Redis 缓存模块。

---

## 监控和日志

### 1. 应用日志

使用 PM2 查看日志：

```bash
pm2 logs cooktip-api
```

使用 Docker 查看日志：

```bash
docker logs -f cooktip-api
```

### 2. 数据库监控

定期检查数据库性能和慢查询。

### 3. 服务器监控

推荐工具：
- **Prometheus + Grafana**
- **阿里云云监控**
- **腾讯云云监控**

---

## 数据备份

### 1. 数据库备份

```bash
# 备份脚本
mysqldump -h <DB_HOST> -u <DB_USER> -p <DB_NAME> > backup_$(date +%Y%m%d).sql

# 定时备份（crontab）
0 2 * * * /path/to/backup.sh
```

### 2. 上传文件备份

```bash
# 备份 uploads 目录
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz uploads/
```

---

## 常见问题

### 1. 端口被占用

```bash
# 查看端口占用
lsof -i :3000

# 杀死进程
kill -9 <PID>
```

### 2. 数据库连接失败

- 检查数据库配置
- 检查防火墙规则
- 检查 MySQL 用户权限

### 3. 内存不足

- 增加服务器内存
- 优化数据库查询
- 使用缓存

---

## 安全建议

1. ✅ 使用 HTTPS
2. ✅ 定期更新依赖包
3. ✅ 配置防火墙
4. ✅ 限制 API 访问频率
5. ✅ 定期备份数据
6. ✅ 使用强密码
7. ✅ 禁用不必要的端口
8. ✅ 配置日志审计

---

## 故障排查

### 查看应用状态

```bash
# PM2
pm2 status

# Docker
docker ps

# 系统服务
systemctl status nginx
systemctl status mysql
```

### 查看错误日志

```bash
# 应用日志
pm2 logs cooktip-api --lines 100

# Nginx 日志
tail -f /var/log/nginx/error.log

# 系统日志
journalctl -xe
```

---

## 联系支持

如有问题，请联系：
- 邮箱: 3509204288@qq.com
- 项目文档: 查看 `后端API开发文档.md`

---

**CookTip 开发团队** 🍳

