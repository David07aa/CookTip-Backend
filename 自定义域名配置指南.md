# 🌐 自定义域名配置指南

**问题**：云托管默认域名无法添加到微信小程序白名单  
**解决**：配置自定义域名  
**时间**：配置 10 分钟 + 等待生效 1-24 小时

---

## ⚠️ 重要说明

微信小程序**不允许**使用以下类型的域名：
- ❌ 云托管默认域名：`xxx.sh.run.tcloudbase.com`
- ❌ 测试域名：`xxx.test.com`
- ❌ IP 地址：`192.168.x.x`

**必须使用**：
- ✅ 已备案的自定义域名：`api.yourdomain.com`

---

## 📋 前置条件

### 必须准备

1. **已购买的域名**
   - 示例：`cooktip.com`
   - 购买渠道：阿里云、腾讯云、GoDaddy 等
   - 费用：约 50-100 元/年

2. **域名已完成 ICP 备案**（必须）
   - 在哪里备案：域名服务商或云服务商
   - 备案时间：7-20 天
   - 备案费用：免费（需要购买服务器）

3. **域名 DNS 管理权限**
   - 可以添加/修改 DNS 记录

---

## 🚀 配置步骤

### 第 1 步：准备子域名

决定使用哪个子域名作为 API 地址，常见选择：

```
api.cooktip.com           # 推荐
backend.cooktip.com
server.cooktip.com
```

**本指南使用示例**：`api.cooktip.com`（请替换为您的实际域名）

---

### 第 2 步：在云托管添加域名

#### 2.1 打开云托管控制台

访问：https://console.cloud.tencent.com/tcb

#### 2.2 进入域名管理

```
云托管 → 服务管理 → 选择您的服务 → 域名管理
```

#### 2.3 添加自定义域名

1. 点击 **添加域名** 按钮
2. 输入您的域名：`api.cooktip.com`
3. 选择证书类型：**自动申请免费证书**（推荐）
4. 点击 **确定**

#### 2.4 获取 CNAME 记录

添加后，系统会显示一个 CNAME 记录，类似：

```
CNAME 记录值：xxx.cdn.dnsv1.com
```

**重要**：复制这个 CNAME 记录，下一步要用！

---

### 第 3 步：配置 DNS 解析

#### 3.1 登录域名 DNS 管理

根据您购买域名的服务商，登录对应的 DNS 管理：

- **阿里云**：https://dns.console.aliyun.com
- **腾讯云**：https://console.cloud.tencent.com/cns
- **其他服务商**：登录对应的管理后台

#### 3.2 添加 CNAME 记录

| 记录类型 | 主机记录 | 记录值 | TTL |
|---------|---------|--------|-----|
| CNAME | api | 【第2步获取的CNAME值】 | 600 |

**示例配置**：

```
记录类型：CNAME
主机记录：api
记录值：xxx.cdn.dnsv1.com（替换为您实际的CNAME值）
TTL：600（10分钟）
```

#### 3.3 保存配置

点击 **保存** 或 **确认**

---

### 第 4 步：等待生效

#### 4.1 DNS 解析生效时间

- **最快**：5-10 分钟
- **通常**：30 分钟 - 2 小时
- **最长**：24 小时

#### 4.2 SSL 证书申请时间

- 云托管会自动申请免费的 SSL 证书
- 通常 5-10 分钟完成
- 可以在云托管控制台查看进度

#### 4.3 验证域名是否生效

在终端或浏览器测试：

```bash
# 方法 1：ping 测试（DNS 解析）
ping api.cooktip.com

# 方法 2：curl 测试（完整访问）
curl https://api.cooktip.com/health

# 方法 3：浏览器访问
# 打开：https://api.cooktip.com/health
```

**期望结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "status": "healthy",
    "service": "cooktip-backend"
  }
}
```

---

### 第 5 步：更新后端配置（可选）

如果后端有使用域名的地方，需要更新配置。

**通常不需要修改**，因为后端是被动响应请求的。

---

### 第 6 步：更新前端配置

#### 6.1 修改前端 API 配置

找到前端项目的配置文件：

**config/api.config.js**：
```javascript
module.exports = {
  // ✅ 使用自定义域名
  apiBaseUrl: 'https://api.cooktip.com/api/v1',
  
  // 图片 CDN（保持不变）
  storageUrl: 'https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com',
  
  timeout: 10000,
  tokenKey: 'cooktip_token',
  userInfoKey: 'cooktip_userInfo'
}
```

#### 6.2 全局搜索替换

在前端项目中全局搜索并替换：

```
旧地址：yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
新地址：api.cooktip.com
```

---

### 第 7 步：配置微信小程序域名白名单

#### 7.1 登录微信公众平台

访问：https://mp.weixin.qq.com

#### 7.2 配置服务器域名

路径：`开发` → `开发管理` → `开发设置` → `服务器域名`

#### 7.3 添加以下域名

**request 合法域名**：
```
https://api.cooktip.com
```

**uploadFile 合法域名**：
```
https://api.cooktip.com
```

**downloadFile 合法域名**：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

**注意**：
- ✅ 自定义域名可以正常添加
- 配置后等待 5-10 分钟生效
- 每月只能修改 5 次

---

### 第 8 步：测试验证

#### 8.1 在微信开发者工具测试

```javascript
wx.request({
  url: 'https://api.cooktip.com/api/v1/categories',
  method: 'GET',
  success: (res) => {
    console.log('✅ 成功:', res.data)
  },
  fail: (err) => {
    console.error('❌ 失败:', err)
  }
})
```

#### 8.2 真机预览测试

1. 点击 **预览** 按钮
2. 用手机扫码
3. 测试各个功能是否正常

---

## 🔍 常见问题

### 问题 1：DNS 配置后长时间不生效

**可能原因**：
- DNS 记录配置错误
- TTL 设置过长
- 本地 DNS 缓存

**解决方法**：

```bash
# Windows 刷新 DNS 缓存
ipconfig /flushdns

# Mac/Linux 刷新 DNS 缓存
sudo dscacheutil -flushcache

# 使用公共 DNS 测试
nslookup api.cooktip.com 8.8.8.8
```

---

### 问题 2：SSL 证书申请失败

**可能原因**：
- 域名解析未生效
- 域名备案信息有问题
- 80/443 端口被占用

**解决方法**：
1. 确认域名解析已生效
2. 检查域名备案状态
3. 在云托管控制台重新申请证书

---

### 问题 3：小程序提示"不在合法域名列表"

**检查清单**：
- [ ] 域名是否已添加到白名单
- [ ] 域名是否包含 `https://`
- [ ] 白名单是否已生效（等待 10 分钟）
- [ ] 域名拼写是否正确
- [ ] 前端配置是否已更新

---

### 问题 4：没有已备案的域名怎么办？

**选项 A：购买并备案域名（推荐）**

1. **购买域名**（10 分钟）
   - 阿里云：https://wanwang.aliyun.com
   - 腾讯云：https://dnspod.cloud.tencent.com
   - 费用：50-100 元/年

2. **ICP 备案**（7-20 天）
   - 在域名服务商或云服务商备案
   - 需要准备：身份证、手机号、服务器信息
   - 免费（但需要有云服务器）

3. **配置域名**（参考上面步骤）

**选项 B：临时使用开发者工具（仅测试）**

详见下方"方案 B"

---

## 📊 配置清单

### 完成进度

- [ ] 准备已备案的域名
- [ ] 在云托管添加自定义域名
- [ ] 配置 DNS 解析
- [ ] 等待 DNS 生效
- [ ] 等待 SSL 证书申请完成
- [ ] 验证域名可访问
- [ ] 更新前端 API 配置
- [ ] 配置微信小程序域名白名单
- [ ] 等待白名单生效
- [ ] 测试验证（开发工具）
- [ ] 真机预览测试

### 时间估算

| 步骤 | 时间 |
|------|------|
| 添加域名 | 5 分钟 |
| 配置 DNS | 5 分钟 |
| DNS 生效 | 10 分钟 - 24 小时 |
| SSL 证书 | 5-10 分钟 |
| 更新配置 | 5 分钟 |
| 测试验证 | 5 分钟 |
| **总计** | **约 30 分钟 - 1 天** |

---

## 📝 配置示例

### 完整示例（假设域名是 cooktip.com）

#### DNS 配置

| 记录类型 | 主机记录 | 记录值 | TTL |
|---------|---------|--------|-----|
| CNAME | api | xxx.cdn.dnsv1.com | 600 |

#### 前端配置

```javascript
// config/api.config.js
module.exports = {
  apiBaseUrl: 'https://api.cooktip.com/api/v1',
  storageUrl: 'https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com',
  timeout: 10000
}
```

#### 微信小程序白名单

```
request 合法域名：
https://api.cooktip.com

uploadFile 合法域名：
https://api.cooktip.com

downloadFile 合法域名：
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

---

## 🎯 配置后的访问地址

| 原地址 | 新地址 |
|--------|--------|
| `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/health` | `https://api.cooktip.com/health` |
| `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/categories` | `https://api.cooktip.com/api/v1/categories` |
| `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/docs` | `https://api.cooktip.com/api/docs` |

---

**配置完成后，小程序就能正常访问后端 API 了！** ✅

**更新时间**：2025-10-16

