# CookTip 前端对接文档 - 新版

**更新时间**：2025-10-09  
**API 版本**：v1.0  
**后端环境**：微信云托管

---

## 📋 目录

- [1. API 基础配置](#1-api-基础配置)
- [2. 完整接口列表](#2-完整接口列表)
- [3. 认证说明](#3-认证说明)
- [4. 接口详情](#4-接口详情)
- [5. 错误处理](#5-错误处理)
- [6. 小程序配置](#6-小程序配置)

---

## 1. API 基础配置

### 1.1 基础地址

```javascript
// 生产环境（公网访问地址）
const BASE_URL = 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com'
const API_BASE_URL = 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1'

// 对象存储（图片）
const STORAGE_URL = 'https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com'

// ⚠️ 注意：公网域名仅用于测试，生产环境建议配置自定义域名
```

### 1.2 请求配置

```javascript
// config/api.config.js
const config = {
  apiBaseUrl: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1',
  timeout: 10000,
  tokenKey: 'cooktip_token',
  userInfoKey: 'cooktip_userInfo',
}
```

### 1.3 通用响应格式

**成功响应**：
```json
{
  "code": 200,
  "data": { /* 数据 */ },
  "message": "success"
}
```

**错误响应**：
```json
{
  "code": 400,
  "message": "错误信息",
  "error": "详细错误"
}
```

---

## 2. 完整接口列表

### 🏥 健康检查

```
GET  /                    # 根路径健康检查
GET  /health              # 健康状态检查
```

### 📚 API 文档

```
GET  /api/docs            # Swagger API 文档
```

### 🔐 认证模块

```
POST /api/v1/auth/wx-login         # 微信登录
POST /api/v1/auth/wechat-login     # 微信登录（别名）
POST /api/v1/auth/refresh          # 刷新 Token
POST /api/v1/auth/logout           # 退出登录
```

### 👤 用户模块

```
GET    /api/v1/users/me               # 获取当前用户信息
PATCH  /api/v1/users/me               # 更新当前用户信息
GET    /api/v1/users/:userId/recipes  # 获取用户的食谱列表
GET    /api/v1/users/me/favorites     # 获取我的收藏列表
GET    /api/v1/users/:userId/stats    # 获取用户统计信息
```

### 🍳 食谱模块

```
GET    /api/v1/recipes           # 获取食谱列表（支持分页、筛选、排序）
POST   /api/v1/recipes           # 创建食谱（需登录）
GET    /api/v1/recipes/:id       # 获取食谱详情
PATCH  /api/v1/recipes/:id       # 更新食谱（需登录）
DELETE /api/v1/recipes/:id       # 删除食谱（需登录）
POST   /api/v1/recipes/:id/like  # 点赞/取消点赞
POST   /api/v1/recipes/:id/favorite  # 收藏/取消收藏
POST   /api/v1/recipes/:id/view      # 增加浏览量
```

### 📁 分类模块

```
GET  /api/v1/categories      # 获取所有分类
GET  /api/v1/categories/:id  # 获取分类详情
```

### 💬 评论模块

```
GET    /api/v1/comments                      # 获取所有评论
GET    /api/v1/recipes/:recipeId/comments    # 获取食谱的评论
POST   /api/v1/recipes/:recipeId/comments    # 发表评论（需登录）
DELETE /api/v1/comments/:id                  # 删除评论（需登录）
POST   /api/v1/comments/:id/like             # 点赞评论
POST   /api/v1/comments/:id/reply            # 回复评论（需登录）
```

### ⭐ 收藏模块

```
GET   /api/v1/favorites       # 获取收藏列表（需登录）
POST  /api/v1/favorites/check # 批量检查收藏状态
```

### 🔍 搜索模块

```
GET  /api/v1/search/recipes      # 搜索食谱
GET  /api/v1/search/hot-keywords # 获取热门搜索词
GET  /api/v1/search/suggestions  # 获取搜索建议
```

### 🛒 购物清单模块

```
GET    /api/v1/shopping-list           # 获取购物清单（需登录）
POST   /api/v1/shopping-list           # 添加购物清单项（需登录）
PATCH  /api/v1/shopping-list/:id       # 更新购物清单项（需登录）
DELETE /api/v1/shopping-list           # 清空购物清单（需登录）
DELETE /api/v1/shopping-list/checked   # 删除已勾选项（需登录）
```

### 📊 统计模块

```
GET  /api/v1/stats/overview     # 获取统计概览
GET  /api/v1/stats/hot-recipes  # 获取热门食谱
GET  /api/v1/home/feed          # 获取首页推荐
```

### 📤 上传模块

```
POST /api/v1/upload/image   # 上传单张图片（需登录）
POST /api/v1/upload/images  # 上传多张图片（需登录）
```

---

## 3. 认证说明

### 3.1 获取 Token

```javascript
// 1. 微信登录获取 code
wx.login({
  success: (res) => {
    const code = res.code
    
    // 2. 发送 code 到后端
    wx.request({
      url: `${API_BASE_URL}/auth/wx-login`,
      method: 'POST',
      data: { code },
      success: (res) => {
        const { token, userInfo } = res.data.data
        
        // 3. 保存 token
        wx.setStorageSync('cooktip_token', token)
        wx.setStorageSync('cooktip_userInfo', userInfo)
      }
    })
  }
})
```

### 3.2 使用 Token

```javascript
// 在需要登录的接口请求头中添加
wx.request({
  url: `${API_BASE_URL}/recipes`,
  method: 'POST',
  header: {
    'Authorization': `Bearer ${wx.getStorageSync('cooktip_token')}`
  },
  data: { /* ... */ }
})
```

### 3.3 Token 刷新

```javascript
// 当 token 过期时（收到 401 响应）
wx.request({
  url: `${API_BASE_URL}/auth/refresh`,
  method: 'POST',
  header: {
    'Authorization': `Bearer ${oldToken}`
  },
  success: (res) => {
    const { token } = res.data.data
    wx.setStorageSync('cooktip_token', token)
  }
})
```

---

## 4. 接口详情

### 4.1 健康检查

#### GET /

**用途**：检查 API 是否运行

**请求**：
```javascript
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/',
  method: 'GET'
})
```

**响应**：
```json
{
  "status": "ok",
  "message": "CookTip API is running",
  "timestamp": "2025-10-09T13:00:00.000Z"
}
```

---

### 4.2 微信登录

#### POST /api/v1/auth/wx-login

**用途**：微信小程序登录，获取 token

**请求**：
```javascript
{
  "code": "微信登录返回的 code"
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "id": 1,
      "openid": "xxxxx",
      "nickname": "用户昵称",
      "avatar": "头像URL"
    }
  }
}
```

---

### 4.3 获取食谱列表

#### GET /api/v1/recipes

**用途**：获取食谱列表，支持分页、筛选、排序

**查询参数**：
```javascript
{
  page: 1,              // 页码（默认 1）
  limit: 10,            // 每页数量（默认 10）
  categoryId: 1,        // 分类 ID（可选）
  difficulty: '简单',   // 难度：简单、中等、困难（可选）
  sort: 'recommended',  // 排序：recommended、latest、hot（可选）
  keyword: '番茄'       // 搜索关键词（可选）
}
```

**请求**：
```javascript
wx.request({
  url: `${API_BASE_URL}/recipes`,
  method: 'GET',
  data: {
    page: 1,
    limit: 10,
    sort: 'recommended'
  }
})
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "items": [
      {
        "id": 1,
        "title": "番茄炒蛋",
        "cover_image": "https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/番茄鸡蛋面.jpg",
        "description": "经典家常菜",
        "difficulty": "简单",
        "cook_time": 15,
        "servings": 2,
        "category": {
          "id": 1,
          "name": "中餐"
        },
        "likes": 100,
        "favorites": 50,
        "views": 1000
      }
    ],
    "total": 198,
    "page": 1,
    "limit": 10
  }
}
```

---

### 4.4 获取食谱详情

#### GET /api/v1/recipes/:id

**用途**：获取单个食谱的详细信息

**请求**：
```javascript
wx.request({
  url: `${API_BASE_URL}/recipes/1`,
  method: 'GET'
})
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "title": "番茄炒蛋",
    "cover_image": "https://...",
    "description": "经典家常菜",
    "difficulty": "简单",
    "cook_time": 15,
    "servings": 2,
    "taste": "酸甜",
    "ingredients": [
      {
        "name": "番茄",
        "amount": "2个"
      },
      {
        "name": "鸡蛋",
        "amount": "3个"
      }
    ],
    "steps": [
      {
        "step": 1,
        "description": "番茄切块",
        "image": "https://..."
      }
    ],
    "tips": "炒鸡蛋时火不要太大",
    "tags": ["家常菜", "快手菜"],
    "nutrition": {
      "calories": "300kcal",
      "protein": "15g",
      "fat": "10g",
      "carbs": "40g"
    },
    "category": {
      "id": 1,
      "name": "中餐"
    },
    "user": {
      "id": 1,
      "nickname": "美食达人",
      "avatar": "https://..."
    },
    "likes": 100,
    "favorites": 50,
    "comments": 20,
    "views": 1000,
    "created_at": "2025-10-09T10:00:00.000Z"
  }
}
```

---

### 4.5 获取分类列表

#### GET /api/v1/categories

**用途**：获取所有食谱分类

**请求**：
```javascript
wx.request({
  url: `${API_BASE_URL}/categories`,
  method: 'GET'
})
```

**响应**：
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "name": "中餐",
      "icon": "https://...",
      "description": "传统中式美食",
      "sort_order": 1
    },
    {
      "id": 2,
      "name": "西餐",
      "icon": "https://...",
      "description": "西式料理",
      "sort_order": 2
    }
  ]
}
```

---

### 4.6 点赞食谱

#### POST /api/v1/recipes/:id/like

**用途**：点赞或取消点赞食谱（需登录）

**请求**：
```javascript
wx.request({
  url: `${API_BASE_URL}/recipes/1/like`,
  method: 'POST',
  header: {
    'Authorization': `Bearer ${token}`
  }
})
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "isLiked": true,
    "likes": 101
  }
}
```

---

### 4.7 收藏食谱

#### POST /api/v1/recipes/:id/favorite

**用途**：收藏或取消收藏食谱（需登录）

**请求**：
```javascript
wx.request({
  url: `${API_BASE_URL}/recipes/1/favorite`,
  method: 'POST',
  header: {
    'Authorization': `Bearer ${token}`
  }
})
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "isFavorited": true,
    "favorites": 51
  }
}
```

---

### 4.8 发表评论

#### POST /api/v1/recipes/:recipeId/comments

**用途**：发表评论（需登录）

**请求**：
```javascript
{
  "content": "这道菜真好吃！",
  "rating": 5
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "content": "这道菜真好吃！",
    "rating": 5,
    "user": {
      "id": 1,
      "nickname": "用户昵称",
      "avatar": "https://..."
    },
    "created_at": "2025-10-09T13:00:00.000Z"
  }
}
```

---

### 4.9 搜索食谱

#### GET /api/v1/search/recipes

**用途**：搜索食谱

**查询参数**：
```javascript
{
  keyword: '番茄',     // 搜索关键词
  page: 1,
  limit: 10
}
```

**请求**：
```javascript
wx.request({
  url: `${API_BASE_URL}/search/recipes`,
  method: 'GET',
  data: {
    keyword: '番茄',
    page: 1,
    limit: 10
  }
})
```

**响应**：同食谱列表格式

---

### 4.10 上传图片

#### POST /api/v1/upload/image

**用途**：上传图片（需登录）

**请求**：
```javascript
wx.chooseImage({
  count: 1,
  success: (res) => {
    const tempFilePath = res.tempFilePaths[0]
    
    wx.uploadFile({
      url: `${API_BASE_URL}/upload/image`,
      filePath: tempFilePath,
      name: 'file',
      header: {
        'Authorization': `Bearer ${token}`
      },
      success: (res) => {
        const data = JSON.parse(res.data)
        console.log('图片URL:', data.data.url)
      }
    })
  }
})
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "url": "https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/uploads/xxx.jpg",
    "filename": "xxx.jpg",
    "size": 102400
  }
}
```

---

## 5. 错误处理

### 5.1 常见错误码

| 错误码 | 说明 | 处理方式 |
|--------|------|----------|
| 200 | 成功 | - |
| 400 | 请求参数错误 | 检查请求参数 |
| 401 | 未登录或 Token 过期 | 重新登录或刷新 Token |
| 403 | 无权限 | 提示用户无权限操作 |
| 404 | 资源不存在 | 提示资源不存在 |
| 429 | 请求过于频繁 | 限流，稍后重试 |
| 500 | 服务器错误 | 提示用户稍后重试 |

### 5.2 错误处理示例

```javascript
// utils/request.js
function request(options) {
  const token = wx.getStorageSync('cooktip_token')
  
  return new Promise((resolve, reject) => {
    wx.request({
      ...options,
      header: {
        ...options.header,
        'Authorization': token ? `Bearer ${token}` : ''
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data)
        } else if (res.statusCode === 401) {
          // Token 过期，重新登录
          wx.navigateTo({
            url: '/pages/login/login'
          })
          reject(new Error('请先登录'))
        } else {
          wx.showToast({
            title: res.data.message || '请求失败',
            icon: 'none'
          })
          reject(res.data)
        }
      },
      fail: (err) => {
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        })
        reject(err)
      }
    })
  })
}
```

---

## 6. 小程序配置

### 6.1 服务器域名白名单

在微信公众平台配置以下域名：

**request 合法域名**：
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

**uploadFile 合法域名**：
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

**downloadFile 合法域名**：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

**⚠️ 重要提示**：
- 域名配置后需要 5-10 分钟生效
- 必须配置域名白名单，否则小程序无法访问
- 公网域名仅用于测试，生产环境建议配置自定义域名

### 6.2 开发环境配置

在微信开发者工具中：
- 详情 → 本地设置
- 勾选 "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

---

## 7. 快速开始示例

### 7.1 完整的首页加载示例

```javascript
// pages/index/index.js
Page({
  data: {
    categories: [],
    recipes: [],
    hotRecipes: []
  },
  
  onLoad() {
    this.loadData()
  },
  
  async loadData() {
    try {
      // 1. 加载分类
      const categoriesRes = await request({
        url: `${API_BASE_URL}/categories`,
        method: 'GET'
      })
      this.setData({
        categories: categoriesRes.data
      })
      
      // 2. 加载推荐食谱
      const recipesRes = await request({
        url: `${API_BASE_URL}/recipes`,
        method: 'GET',
        data: {
          page: 1,
          limit: 10,
          sort: 'recommended'
        }
      })
      this.setData({
        recipes: recipesRes.data.items
      })
      
      // 3. 加载热门食谱
      const hotRes = await request({
        url: `${API_BASE_URL}/stats/hot-recipes`,
        method: 'GET'
      })
      this.setData({
        hotRecipes: hotRes.data
      })
      
    } catch (error) {
      console.error('加载失败:', error)
    }
  }
})
```

---

## 8. 注意事项

### 8.1 性能优化

1. **图片懒加载**：使用小程序的 `lazy-load` 属性
2. **列表分页**：使用上拉加载更多
3. **缓存策略**：合理使用 `wx.setStorage` 缓存数据
4. **请求防抖**：避免重复请求

### 8.2 错误处理

1. **网络错误**：提示用户检查网络
2. **Token 过期**：自动跳转登录页
3. **请求超时**：设置合理的超时时间（10秒）

### 8.3 数据格式

1. **时间格式**：ISO 8601 格式（`2025-10-09T13:00:00.000Z`）
2. **图片 URL**：完整的 HTTPS URL
3. **JSON 字段**：ingredients、steps、nutrition 等是 JSON 对象

---

## 9. 联系方式

- **API 文档**：https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/docs
- **问题反馈**：GitHub Issues

---

**更新日志**：

- 2025-10-16：**紧急修复** - 更新为正确的公网访问地址
  - 修复：前端无法连接后端的问题
  - 原因：之前使用的是内网地址，外部无法访问
  - 解决：改为公网访问地址
  - 提醒：公网域名仅用于测试，生产环境需配置自定义域名
- 2025-10-09：新版文档，数据库迁移到微信云托管，图片迁移到对象存储
- 添加健康检查端点
- 所有接口路径确认
- 完整的错误处理说明

---

**祝开发顺利！** 🚀

