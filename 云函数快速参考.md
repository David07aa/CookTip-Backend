# ⚡ 云函数快速参考

**3 分钟快速查询手册**

---

## 📁 项目结构

```
CookTip-Backend/
├── cloudfunctions/              # 云函数（部署到小程序）
│   └── api-proxy/
│       ├── index.js            # 主文件 ⭐
│       ├── package.json        # 依赖
│       ├── config.json         # 配置
│       └── README.md           # 说明
│
├── miniprogram-utils/          # 小程序工具类（复制到小程序项目）
│   ├── cloudRequest.js        # 请求工具 ⭐
│   ├── api.js                 # API 封装 ⭐
│   └── 使用示例.md
│
└── 云函数部署完整指南.md     # 详细部署步骤
```

---

## 🚀 快速开始（3 步）

### 1️⃣ 部署云函数

```bash
# 在微信开发者工具中：
# 1. 复制 cloudfunctions/api-proxy 到小程序项目
# 2. 右键 api-proxy → 上传并部署：云端安装依赖
```

### 2️⃣ 初始化云开发

```javascript
// app.js
wx.cloud.init({
  env: 'your-env-id', // 替换为您的环境 ID
  traceUser: true
})
```

### 3️⃣ 调用 API

```javascript
// 复制 miniprogram-utils 到小程序项目的 utils 目录
const api = require('../../utils/api')

// 使用
const res = await api.getCategoryList()
```

---

## 📝 常用代码片段

### 初始化云开发

```javascript
// app.js
App({
  onLaunch() {
    wx.cloud.init({
      env: 'cooktip-prod-xxx',
      traceUser: true
    })
  }
})
```

### 获取数据

```javascript
const api = require('../../utils/api')

// 获取分类
const categories = await api.getCategoryList()

// 获取食谱列表
const recipes = await api.getRecipeList({
  page: 1,
  limit: 10,
  sort: 'recommended'
})

// 获取食谱详情
const recipe = await api.getRecipeDetail(id)
```

### 用户操作

```javascript
// 微信登录
const loginRes = await wx.login()
const res = await api.wxLogin(loginRes.code)
wx.setStorageSync('cooktip_token', res.data.token)

// 点赞食谱
await api.toggleLikeRecipe(recipeId)

// 收藏食谱
await api.toggleFavoriteRecipe(recipeId)
```

### 搜索

```javascript
// 搜索食谱
const results = await api.searchRecipes('番茄', {
  page: 1,
  limit: 20
})

// 获取热门搜索词
const hotKeywords = await api.getHotKeywords()
```

---

## 🔧 配置信息

### 云托管地址

```javascript
// 内网地址（云函数使用）
const API_INTERNAL_URL = 'http://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com'

// 公网地址（浏览器测试）
const API_PUBLIC_URL = 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com'
```

### 域名白名单

**downloadFile 合法域名**：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

---

## 🐛 常见问题

### Q1：云函数调用失败？

```javascript
// 检查初始化
wx.cloud.init({ env: 'your-env-id' })

// 检查云函数名称
wx.cloud.callFunction({ name: 'api-proxy' })
```

### Q2：返回 504 超时？

- 检查后端服务是否运行
- 检查内网地址是否正确
- 查看云函数日志

### Q3：图片无法显示？

- 配置 downloadFile 域名白名单
- 等待 5-10 分钟生效

### Q4：401 未登录？

```javascript
// 确保已保存 Token
wx.setStorageSync('cooktip_token', token)

// 或使用 authRequest
const { authRequest } = require('../../utils/cloudRequest')
```

---

## 📊 API 接口速查

### 认证

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/auth/wx-login` | POST | 微信登录 |
| `/api/v1/auth/refresh` | POST | 刷新 Token |
| `/api/v1/auth/logout` | POST | 退出登录 |

### 食谱

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/recipes` | GET | 获取列表 |
| `/api/v1/recipes/:id` | GET | 获取详情 |
| `/api/v1/recipes` | POST | 创建食谱 |
| `/api/v1/recipes/:id` | PATCH | 更新食谱 |
| `/api/v1/recipes/:id` | DELETE | 删除食谱 |
| `/api/v1/recipes/:id/like` | POST | 点赞 |
| `/api/v1/recipes/:id/favorite` | POST | 收藏 |

### 分类

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/categories` | GET | 获取所有分类 |
| `/api/v1/categories/:id` | GET | 获取分类详情 |

### 评论

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/recipes/:id/comments` | GET | 获取评论 |
| `/api/v1/recipes/:id/comments` | POST | 发表评论 |
| `/api/v1/comments/:id` | DELETE | 删除评论 |

### 搜索

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/search/recipes` | GET | 搜索食谱 |
| `/api/v1/search/hot-keywords` | GET | 热门搜索词 |

---

## 📦 工具函数

### cloudRequest.js

```javascript
const { cloudRequest, get, post, authRequest } = require('./cloudRequest')

// 通用请求
cloudRequest({ url, method, data })

// GET 请求
get(url, query)

// POST 请求
post(url, data)

// 需要登录的请求
authRequest({ url, method, data })
```

### api.js

```javascript
const api = require('./api')

// 所有接口都已封装，直接调用
api.getCategoryList()
api.getRecipeList(query)
api.getRecipeDetail(id)
api.wxLogin(code)
// ...
```

---

## 🎯 性能优化

### 并行请求

```javascript
const [res1, res2, res3] = await Promise.all([
  api.getCategoryList(),
  api.getRecipeList(),
  api.getHotRecipes()
])
```

### 分页加载

```javascript
Page({
  data: { page: 1, recipes: [], hasMore: true },
  
  async loadMore() {
    const res = await api.getRecipeList({
      page: this.data.page,
      limit: 20
    })
    this.setData({
      recipes: [...this.data.recipes, ...res.data.items],
      page: this.data.page + 1
    })
  },
  
  onReachBottom() {
    this.loadMore()
  }
})
```

### 缓存策略

```javascript
// 缓存分类数据
const getCategoriesWithCache = async () => {
  let categories = wx.getStorageSync('categories')
  if (!categories) {
    const res = await api.getCategoryList()
    categories = res.data
    wx.setStorageSync('categories', categories)
  }
  return categories
}
```

---

## 📈 监控与调试

### 查看云函数日志

```
云开发控制台 → 云函数 → api-proxy → 日志
```

### 控制台测试

```javascript
// 开发者工具控制台
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'GET',
    path: '/api/v1/categories'
  },
  success: console.log
})
```

### 日志输出

```javascript
// 云函数会自动输出日志：
// - 收到请求
// - 转发请求
// - 后端响应
```

---

## 💡 最佳实践

1. ✅ **使用 API 封装**：使用 `api.js`，不要直接调用云函数
2. ✅ **错误处理**：工具类已包含错误处理
3. ✅ **加载提示**：需要时传入 `showLoading: true`
4. ✅ **Token 管理**：使用 `authRequest` 自动携带 Token
5. ✅ **缓存数据**：对不常变化的数据使用缓存
6. ✅ **分页加载**：大列表使用分页
7. ✅ **并行请求**：多个独立请求使用 `Promise.all`

---

## 🔗 快速链接

| 文档 | 用途 |
|------|------|
| [云函数部署完整指南.md](./云函数部署完整指南.md) | 详细部署步骤 |
| [使用示例.md](./miniprogram-utils/使用示例.md) | 前端使用示例 |
| [api-proxy/README.md](./cloudfunctions/api-proxy/README.md) | 云函数说明 |
| [域名配置完整方案.md](./域名配置完整方案.md) | 域名配置方案 |

---

## ⚙️ 环境配置

### 开发环境

```javascript
// 开发者工具 → 详情 → 本地设置
// ✅ 勾选：不校验合法域名
```

### 生产环境

```javascript
// 微信公众平台 → 开发设置 → 服务器域名
// 配置 downloadFile 合法域名
```

---

**快速参考完毕！需要详细说明请查看完整文档。** 📚

**更新时间**：2025-10-16

