# 🚨 紧急修复：微信登录 401 错误

## 问题诊断

### 错误现象
```
后端返回: statusCode: 401
错误信息: 登录认证失败
```

### 根本原因

**后端环境变量中没有正确配置微信 AppID 和 Secret！**

---

## 🔧 立即修复（3步）

### 步骤1：检查 cloudbase-env-vars.json

文件位置：`cloudbase-env-vars.json`

确认以下配置存在：

```json
{
  "WX_APPID": "wx8486e57500ac0a55",
  "WECHAT_APPID": "wx8486e57500ac0a55",
  "WX_SECRET": "bd4c652097608bb064350cc7e3b5801c",
  "WECHAT_SECRET": "bd4c652097608bb064350cc7e3b5801c"
}
```

✅ **已确认**：配置文件中有这些配置

---

### 步骤2：在云托管控制台配置环境变量

⚠️ **重要**：`cloudbase-env-vars.json` 只是配置示例，**必须在云托管控制台手动配置**！

#### 操作步骤：

1. **登录微信云托管控制台**
   ```
   https://console.cloud.tencent.com/tcb
   ```

2. **进入环境设置**
   - 选择你的云托管环境（yjsp-ytg-191595-4）
   - 点击左侧菜单 "设置" → "环境变量"

3. **添加以下环境变量**

| 变量名 | 变量值 | 说明 |
|--------|--------|------|
| `WX_APPID` | `wx8486e57500ac0a55` | 小程序 AppID |
| `WX_SECRET` | `bd4c652097608bb064350cc7e3b5801c` | 小程序 Secret |
| `WECHAT_APPID` | `wx8486e57500ac0a55` | 兼容字段 |
| `WECHAT_SECRET` | `bd4c652097608bb064350cc7e3b5801c` | 兼容字段 |

**截图示例**：
```
环境变量配置页面
┌─────────────────────────────────────────────────────┐
│ 变量名          │ 变量值                              │
├─────────────────────────────────────────────────────┤
│ WX_APPID        │ wx8486e57500ac0a55                  │
│ WX_SECRET       │ bd4c652097608bb064350cc7e3b5801c     │
│ WECHAT_APPID    │ wx8486e57500ac0a55                  │
│ WECHAT_SECRET   │ bd4c652097608bb064350cc7e3b5801c     │
└─────────────────────────────────────────────────────┘
```

4. **保存配置**
   - 点击"保存"按钮
   - 等待配置生效（通常需要几秒钟）

---

### 步骤3：重启云托管服务

⚠️ **必须重启服务**才能使环境变量生效！

#### 方式A：通过控制台重启（推荐）

1. 在云托管控制台，点击"服务管理"
2. 找到您的服务
3. 点击"重启"按钮
4. 等待服务重新启动（约1-2分钟）

#### 方式B：通过推送代码触发重新部署

```bash
# 简单修改任意文件触发部署
git commit --allow-empty -m "chore: 重启服务以加载环境变量"
git push origin main
```

---

## ✅ 验证修复

### 1. 前端测试

让前端再次点击登录按钮，查看控制台日志：

**修复成功的日志**：
```
🔐 [WechatLogin] 开始微信登录流程...
👤 [WechatLogin] 调用 wx.getUserProfile...
✅ [WechatLogin] 获取用户信息成功
🔑 [WechatLogin] 调用 wx.login 获取 code...
✅ [WechatLogin] 获取登录凭证成功
📡 [WechatLogin] 发送登录请求到后端...
📊 [WechatLogin] HTTP状态码: 200  ← 成功！
✅ [WechatLogin] 登录成功!
💾 [WechatLogin] 已保存 token 和用户信息到本地
```

**如果仍然失败**：
```
📊 [WechatLogin] HTTP状态码: 401
❌ [WechatLogin] 后端返回401错误（认证失败）
   可能原因：
   1. 微信AppID或Secret配置错误  ← 检查这个！
   2. 微信code无效或已使用
   3. 后端认证守卫配置错误
   详细信息: {...}
```

---

### 2. 检查后端日志

在云托管控制台查看后端日志，应该看到：

**成功日志**：
```
🔐 微信登录 - code2Session 开始
  - Code 长度: 32
  - AppID 存在: true (wx8486...)  ← 成功加载！
  - Secret 存在: true (已配置)   ← 成功加载！
📡 调用微信 API: https://api.weixin.qq.com/sns/jscode2session
📥 微信 API 响应: {"openid":"...","session_key":"..."}
✅ 获取 openid 成功: oXXXX...
✅ 新用户注册成功 / 老用户登录成功
```

**失败日志（环境变量未配置）**：
```
❌ 微信配置缺失: AppID 或 Secret 未配置  ← 问题在这里！
```

---

## 🔍 补充说明

### 为什么需要在控制台配置？

1. **安全性**：敏感信息不应该提交到代码仓库
2. **环境隔离**：不同环境（开发/测试/生产）使用不同的配置
3. **动态更新**：控制台配置可以即时更新，无需重新部署代码

### cloudbase-env-vars.json 的作用

- ✅ 作为配置**模板和文档**
- ✅ 方便团队了解需要哪些环境变量
- ❌ **不会**自动应用到云托管环境
- ❌ **不应该**包含真实的 Secret（应该使用占位符）

### 最佳实践

1. **cloudbase-env-vars.json**：使用占位符
   ```json
   {
     "WX_SECRET": "your_wechat_secret_here"
   }
   ```

2. **云托管控制台**：配置真实值
   ```
   WX_SECRET = bd4c652097608bb064350cc7e3b5801c
   ```

3. **.gitignore**：排除包含敏感信息的文件
   ```
   .env
   .env.local
   ```

---

## 📞 如果还是失败

### 情况1：AppID 或 Secret 不正确

**症状**：
```
微信 API 响应: {"errcode": 40125, "errmsg": "invalid appid"}
```

**解决**：
1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 开发 → 开发管理 → 开发设置
3. 复制正确的 AppID 和 AppSecret
4. 更新云托管环境变量
5. 重启服务

---

### 情况2：code 已被使用

**症状**：
```
微信 API 响应: {"errcode": 40163, "errmsg": "code been used"}
```

**原因**：微信的 code 只能使用一次

**解决**：前端重新获取 code（重新点击登录按钮）

---

### 情况3：环境变量未生效

**检查方式**：

1. 在云托管控制台查看日志
2. 看是否有 "AppID 存在: true" 的日志

**如果日志显示 "AppID 存在: false"**：
- 环境变量未配置或配置错误
- 服务未重启
- 配置的变量名不正确（应该是 `WX_APPID`，不是 `WECHAT_APPID`）

---

## 🎯 快速检查清单

完成后端修复后，按照以下清单检查：

- [ ] cloudbase-env-vars.json 中有配置（参考）
- [ ] 云托管控制台环境变量已配置
- [ ] 已重启云托管服务
- [ ] 后端日志显示 AppID 和 Secret 已加载
- [ ] 前端登录测试返回 200 状态码
- [ ] Token 和用户信息已保存到本地
- [ ] 登录成功并跳转到首页

---

## 📝 配置文件位置总结

| 文件/位置 | 用途 | 是否生效 |
|----------|------|----------|
| `cloudbase-env-vars.json` | 📄 配置模板/文档 | ❌ 不会自动生效 |
| `.env` | 💻 本地开发配置 | ✅ 本地开发时生效 |
| 云托管控制台环境变量 | ☁️ 生产环境配置 | ✅ 生产环境生效 |

---

**修复时间**：预计 5-10 分钟  
**修复优先级**：🔴 高（登录功能完全无法使用）  
**影响范围**：所有用户无法登录

---

**最后更新**: 2024-10-16  
**状态**: ⏳ 等待修复

