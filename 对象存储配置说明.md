# 对象存储配置说明

## 📦 对象存储信息

- **存储桶名称**: `796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091`
- **存储地域**: `ap-shanghai`（上海）
- **基础URL**: `https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com`
- **访问权限**: 公开读，私有写

---

## 🚀 快速开始

### 步骤1：更新数据库中的图片URL

运行更新脚本，将所有老乡鸡图片路径更新为对象存储URL：

```bash
node update-to-storage.js
```

**脚本功能**：
- 自动查找所有本地图片路径
- 转换为对象存储URL
- 批量更新数据库
- 显示更新统计

**预期输出**：
```
🚀 开始更新数据库中的图片URL...

🔗 数据库连接成功！

📦 对象存储信息：
   存储桶：796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091
   地域：ap-shanghai
   基础URL：https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com

🔍 查询需要更新的食谱...

📊 找到 192 条需要更新的记录

✅ [1] 大排面
   旧: /uploads/images/laoxiangji/大排面.png
   新: https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/大排面.png

...

✅ 数据库更新完成！
```

---

### 步骤2：验证迁移结果

运行验证脚本：

```bash
node verify-storage-urls.js
```

**验证内容**：
- ✅ 统计各类URL数量
- ✅ 显示示例URL
- ✅ 测试图片可访问性
- ✅ 提供配置清单

**预期输出**：
```
📊 数据库统计：
============================================================
总食谱数：        192
✅ 对象存储图片：  192 条
⚠️  本地路径1：     0 条 (/uploads/images/)
⚠️  本地路径2：     0 条 (/images/)
❌ 无图片：        0 条
============================================================

✅ 所有图片已迁移到对象存储！
```

---

### 步骤3：配置小程序域名白名单

**必须配置！** 小程序才能访问对象存储的图片。

1. **登录微信公众平台**
   ```
   https://mp.weixin.qq.com
   ```

2. **进入开发设置**
   ```
   开发 → 开发管理 → 开发设置 → 服务器域名
   ```

3. **配置 downloadFile 合法域名**
   
   添加以下域名：
   ```
   https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
   ```

4. **保存配置**
   - 每月最多修改5次
   - 配置后需要重新编译小程序

---

### 步骤4：更新后端环境变量

在 `.env` 文件中添加/更新：

```env
# 对象存储配置
CDN_BASE_URL=https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

**作用**：
- 后续上传的新图片可以直接使用对象存储
- API返回的图片URL使用对象存储域名

---

### 步骤5：清理后端 uploads 目录（可选）

数据库迁移完成并验证无误后，可以移除后端的 uploads 目录，减少容器体积。

**已完成的修改**：
1. ✅ Dockerfile 已注释 `COPY uploads` 行
2. ⏳ 待更新 `.dockerignore` 添加 `uploads`

**手动操作**：

编辑 `.dockerignore`，确保包含：
```
uploads
```

**重新部署**：
```bash
git add Dockerfile .dockerignore
git commit -m "chore: 移除uploads目录，图片已迁移到对象存储"
git push origin main
```

**收益**：
- ✅ 减少镜像大小 15-20MB
- ✅ 降低内存占用
- ✅ 提升服务稳定性

---

## 📋 图片URL格式

### 对象存储URL格式

```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/[文件名]
```

### 示例

```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/大排面.png
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/红烧肉.jpg
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/宫保鸡丁.png
```

---

## 🧪 测试方法

### 1. 浏览器测试

在浏览器中直接打开任意图片URL：

```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/大排面.png
```

**预期结果**：
- ✅ 能看到图片
- ✅ URL栏显示 HTTPS（安全）
- ❌ 如果显示403：检查存储桶权限
- ❌ 如果显示404：检查文件是否上传

---

### 2. API测试

调用后端接口，检查返回的图片URL：

```bash
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/recipes?limit=5
```

**检查返回的 `cover_image` 字段**：
```json
{
  "id": 1,
  "title": "大排面",
  "cover_image": "https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/大排面.png"
}
```

---

### 3. 小程序测试

1. **配置域名白名单**（必须）
2. **重新编译小程序**
3. **打开食谱列表页**
4. **查看图片是否正常显示**

**调试方法**：
- 打开开发者工具 Console
- 查看是否有网络错误
- 常见错误：`request:fail url not in domain list`
  - 解决：配置域名白名单

---

## ⚙️ 对象存储管理

### 访问对象存储控制台

1. **微信云托管控制台**
   ```
   https://console.cloud.tencent.com/tcb
   ```

2. **进入对象存储**
   ```
   服务管理 → 对象存储 → 796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091
   ```

### 权限设置

**当前配置**：公开读，私有写

**说明**：
- ✅ **公开读**：任何人都可以通过URL访问图片（适合公开的食谱图片）
- ✅ **私有写**：只有授权用户可以上传/删除文件

**如需修改**：
1. 进入存储桶设置
2. 权限管理 → 访问权限
3. 选择合适的权限模式

---

### 上传新图片

**方式一：控制台上传**
1. 进入存储桶
2. 选择目录（如 `laoxiangji`）
3. 点击"上传文件"
4. 选择图片并上传

**方式二：通过后端API**
- 后续可以开发上传接口
- 直接上传到对象存储
- 返回对象存储URL

---

## 💰 费用预估

### 当前用量

- **存储空间**：约 20MB（192张图片）
- **月度费用**：约 ¥0.002（几乎免费）

### 流量费用

- **价格**：约 ¥0.5/GB
- **预估**：小程序用户访问，每月几GB
- **月度费用**：约 ¥2-5（可控）

### 请求费用

- **价格**：约 ¥0.01/万次
- **几乎可以忽略**

**总成本**：每月约 ¥2-5，远低于扩容云托管实例

---

## ✅ 迁移检查清单

- [ ] 1. 图片已上传到对象存储桶
- [ ] 2. 存储桶权限设置为"公开读，私有写"
- [ ] 3. 运行 `node update-to-storage.js` 更新数据库
- [ ] 4. 运行 `node verify-storage-urls.js` 验证结果
- [ ] 5. 浏览器测试图片URL可访问
- [ ] 6. 小程序配置域名白名单
- [ ] 7. 小程序测试图片显示正常
- [ ] 8. 更新 `.env` 配置 CDN_BASE_URL
- [ ] 9. 更新 `.dockerignore` 忽略 uploads
- [ ] 10. 提交并部署后端
- [ ] 11. 验证服务稳定性

---

## 🆘 常见问题

### Q1: 图片显示403错误

**原因**：存储桶权限设置为私有

**解决**：
1. 进入对象存储控制台
2. 存储桶设置 → 权限管理
3. 设置为"公开读，私有写"

---

### Q2: 小程序显示"不在域名白名单"

**原因**：未配置域名白名单

**解决**：
1. 登录 https://mp.weixin.qq.com
2. 开发设置 → 服务器域名
3. downloadFile 合法域名添加对象存储URL

---

### Q3: 更新脚本无法连接数据库

**检查**：
1. 数据库配置是否正确
2. 网络是否正常
3. 数据库是否在白名单

---

### Q4: 如何上传新图片到对象存储？

**方式一**：控制台手动上传
**方式二**：开发上传API接口
**方式三**：使用腾讯云CLI工具

---

## 📚 相关文档

- [微信云托管对象存储迁移方案.md](./微信云托管对象存储迁移方案.md) - 完整迁移指南
- [部署信息.md](./部署信息.md) - 生产环境配置
- [快速启动.md](./快速启动.md) - 项目启动指南

---

**更新时间**: 2025-10-09  
**存储桶**: 796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091  
**地域**: ap-shanghai

