# 用户表扩展迁移完整指南

## 📋 概述

本指南提供了安全扩展 `users` 表的完整流程，在保留现有微信登录功能的基础上，为未来扩展（如用户名密码登录、邮箱登录等）预留字段。

---

## 🎯 迁移目标

### ✅ 保留内容
- 微信 OpenID 登录功能
- 所有现有用户数据（3个用户）
- 关联的食谱、评论、收藏等数据
- 所有业务功能

### ➕ 新增内容
- `username` - 用户名（可选）
- `email` - 邮箱（可选）
- `phone` - 手机号（可选）
- `password_hash` - 密码哈希（可选）
- `is_verified` - 验证状态（布尔值）

---

## 📂 相关文件

```
CookTip-Backend/
├── database/migrations/
│   ├── 2025-10-17-extend-user-table.sql       # 迁移 SQL 脚本
│   ├── 2025-10-17-rollback-user-table.sql     # 回滚 SQL 脚本
│   └── user-table-redesign-analysis.md        # 详细分析文档
├── scripts/
│   ├── migrate-user-table.js                  # 迁移执行脚本
│   ├── rollback-user-table.js                 # 回滚执行脚本
│   └── check-current-tables.js                # 数据库检查脚本
├── src/entities/
│   └── user.entity.ts                         # 更新后的 Entity 文件
└── 用户表扩展迁移指南.md                        # 本文档
```

---

## 🚀 执行迁移

### 方式一：使用 Node.js 脚本（推荐）⭐

```bash
# 1. 确保在项目根目录
cd E:\前端项目文档\项目文件夹\CookTip-Backend

# 2. 执行迁移
node scripts/migrate-user-table.js
```

**脚本会自动完成以下操作：**
1. ✅ 连接数据库
2. ✅ 备份现有数据到 `users_backup_20251017` 表
3. ✅ 添加新字段
4. ✅ 创建索引
5. ✅ 验证数据完整性
6. ✅ 显示迁移结果

### 方式二：手动执行 SQL

如果需要手动控制每一步：

```bash
# 1. 使用 Navicat 或其他数据库工具连接
# 2. 打开 database/migrations/2025-10-17-extend-user-table.sql
# 3. 逐步执行 SQL 语句
```

---

## 📊 迁移后的表结构

```sql
CREATE TABLE `users` (
  -- 主键
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  
  -- 微信登录（必需，保留）
  `openid` VARCHAR(100) UNIQUE NOT NULL,
  `session_key` VARCHAR(200),
  
  -- 扩展登录字段（新增，可选）
  `username` VARCHAR(50) UNIQUE,
  `email` VARCHAR(100) UNIQUE,
  `phone` VARCHAR(20) UNIQUE,
  `password_hash` VARCHAR(255),
  `is_verified` BOOLEAN DEFAULT false,
  
  -- 基本信息
  `nickname` VARCHAR(50),
  `avatar` VARCHAR(255),
  `bio` VARCHAR(200),
  
  -- 统计数据
  `recipe_count` INT DEFAULT 0,
  `follower_count` INT DEFAULT 0,
  `following_count` INT DEFAULT 0,
  `favorite_count` INT DEFAULT 0,
  
  -- 时间戳
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- 索引
  INDEX idx_openid (`openid`),
  INDEX idx_username (`username`),
  INDEX idx_email (`email`),
  INDEX idx_phone (`phone`)
);
```

---

## ✅ 验证迁移结果

### 检查表结构
```bash
node scripts/check-current-tables.js
```

### 检查数据完整性
```sql
-- 比较数据数量
SELECT 
  (SELECT COUNT(*) FROM users) as current_count,
  (SELECT COUNT(*) FROM users_backup_20251017) as backup_count;

-- 查看新字段
DESCRIBE users;

-- 查看示例数据
SELECT id, openid, nickname, username, email, is_verified 
FROM users 
LIMIT 5;
```

---

## 🔄 如何回滚

如果迁移后遇到问题，可以立即回滚：

### 方式一：使用脚本
```bash
node scripts/rollback-user-table.js
```

### 方式二：手动回滚
```sql
-- 删除新增字段
ALTER TABLE users DROP COLUMN username;
ALTER TABLE users DROP COLUMN email;
ALTER TABLE users DROP COLUMN phone;
ALTER TABLE users DROP COLUMN password_hash;
ALTER TABLE users DROP COLUMN is_verified;

-- 删除索引
DROP INDEX idx_username ON users;
DROP INDEX idx_email ON users;
DROP INDEX idx_phone ON users;
```

---

## 🛡️ 安全保障

### 数据备份
- ✅ 自动备份到 `users_backup_20251017` 表
- ✅ 备份表与原表独立，互不影响
- ✅ 保留原有所有数据

### 数据完整性
- ✅ 新字段均为 `NULL` 允许，不影响现有数据
- ✅ 外键关系保持不变
- ✅ 现有业务逻辑无需修改

### 回滚机制
- ✅ 提供完整回滚脚本
- ✅ 可以随时恢复到迁移前状态
- ✅ 备份数据永久保留

---

## 📝 后续开发指南

### 1. 使用新字段

**创建支持多种登录方式的用户：**

```typescript
// 微信登录（现有方式，保持不变）
const wechatUser = userRepository.create({
  openid: 'wx_openid_123',
  session_key: 'session_key_abc',
  nickname: '微信用户',
  avatar: 'https://...'
});

// 用户名密码登录（新功能，可选）
const regularUser = userRepository.create({
  openid: 'generated_unique_id',  // 为非微信用户生成唯一ID
  username: 'johndoe',
  email: 'john@example.com',
  password_hash: await bcrypt.hash('password', 10),
  is_verified: false
});

// 手机号登录（新功能，可选）
const phoneUser = userRepository.create({
  openid: 'generated_unique_id',
  phone: '13800138000',
  password_hash: await bcrypt.hash('password', 10),
  is_verified: true
});
```

### 2. 更新 AuthService

在 `src/modules/auth/auth.service.ts` 中添加新的登录方法：

```typescript
// 现有微信登录（保持不变）
async loginWithWechat(code: string) {
  // 现有逻辑
}

// 新增：用户名密码登录
async loginWithPassword(username: string, password: string) {
  const user = await this.userRepository.findOne({
    where: [
      { username },
      { email: username },
      { phone: username }
    ]
  });

  if (!user || !user.password_hash) {
    throw new UnauthorizedException('用户不存在或未设置密码');
  }

  const isPasswordValid = await bcrypt.compare(password, user.password_hash);
  if (!isPasswordValid) {
    throw new UnauthorizedException('密码错误');
  }

  if (!user.is_verified) {
    throw new UnauthorizedException('账号未验证');
  }

  return this.generateToken(user);
}
```

### 3. 验证和安全

```typescript
// DTO 验证
export class RegisterDto {
  @IsString()
  @MinLength(3)
  @MaxLength(50)
  username: string;

  @IsEmail()
  email: string;

  @IsString()
  @MinLength(6)
  password: string;
}

// 密码加密
import * as bcrypt from 'bcrypt';

const hashedPassword = await bcrypt.hash(plainPassword, 10);
```

---

## ⚠️ 注意事项

### 1. OpenID 字段
- ❌ **不要删除** `openid` 字段
- ✅ 对于微信用户，`openid` 是必需的
- ✅ 对于非微信用户，可以生成唯一ID代替

### 2. 兼容性
- ✅ 现有微信登录代码无需修改
- ✅ 新字段都是可选的（允许 NULL）
- ✅ 向后兼容所有现有 API

### 3. 性能考虑
- ✅ 为常用查询字段添加了索引（username, email, phone）
- ✅ 保持单表设计，避免多表 JOIN
- ✅ 查询性能不受影响

---

## 🔍 常见问题

### Q1: 迁移会影响现有功能吗？
**A:** 不会。所有新字段都是可选的，微信登录功能完全保持不变。

### Q2: 现有用户数据会丢失吗？
**A:** 不会。迁移前会自动备份，且所有数据保持完整。

### Q3: 如果迁移出错怎么办？
**A:** 可以立即执行回滚脚本恢复原状，或从备份表恢复数据。

### Q4: 新字段是强制的吗？
**A:** 不是。所有新字段都允许 NULL，可以选择性使用。

### Q5: 需要修改前端代码吗？
**A:** 不需要。现有前端代码可以继续使用，新功能可以逐步开发。

---

## 📈 未来扩展建议

### 阶段一：完成迁移（当前）
- ✅ 扩展 users 表
- ✅ 更新 Entity 文件
- ✅ 验证数据完整性

### 阶段二：实现新登录方式（可选）
- 📝 实现用户名密码登录
- 📝 实现邮箱登录
- 📝 实现手机号登录
- 📝 添加邮箱验证功能

### 阶段三：安全增强（可选）
- 📝 实现两步验证
- 📝 添加登录日志
- 📝 实现密码重置功能
- 📝 添加账号绑定功能

---

## 📞 技术支持

如有问题，请参考：
- 详细分析：`database/migrations/user-table-redesign-analysis.md`
- 数据库脚本：`database/migrations/2025-10-17-*.sql`
- Entity 文件：`src/entities/user.entity.ts`

---

**文档版本**：v1.0  
**创建日期**：2025-10-17  
**适用版本**：CookTip Backend v1.0+  
**维护者**：CookTip 开发团队

---

## ✨ 执行清单

在执行迁移前，请确认：

- [ ] 已阅读完整文档
- [ ] 已了解迁移内容和影响
- [ ] 已准备好数据库连接信息
- [ ] 已了解回滚流程
- [ ] 已在测试环境验证（如有）

**准备好了？开始执行：**

```bash
node scripts/migrate-user-table.js
```

🎉 祝迁移顺利！

