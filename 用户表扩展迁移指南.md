# ç”¨æˆ·è¡¨æ‰©å±•è¿ç§»å®Œæ•´æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†å®‰å…¨æ‰©å±• `users` è¡¨çš„å®Œæ•´æµç¨‹ï¼Œåœ¨ä¿ç•™ç°æœ‰å¾®ä¿¡ç™»å½•åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œä¸ºæœªæ¥æ‰©å±•ï¼ˆå¦‚ç”¨æˆ·åå¯†ç ç™»å½•ã€é‚®ç®±ç™»å½•ç­‰ï¼‰é¢„ç•™å­—æ®µã€‚

---

## ğŸ¯ è¿ç§»ç›®æ ‡

### âœ… ä¿ç•™å†…å®¹
- å¾®ä¿¡ OpenID ç™»å½•åŠŸèƒ½
- æ‰€æœ‰ç°æœ‰ç”¨æˆ·æ•°æ®ï¼ˆ3ä¸ªç”¨æˆ·ï¼‰
- å…³è”çš„é£Ÿè°±ã€è¯„è®ºã€æ”¶è—ç­‰æ•°æ®
- æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½

### â• æ–°å¢å†…å®¹
- `username` - ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
- `email` - é‚®ç®±ï¼ˆå¯é€‰ï¼‰
- `phone` - æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰
- `password_hash` - å¯†ç å“ˆå¸Œï¼ˆå¯é€‰ï¼‰
- `is_verified` - éªŒè¯çŠ¶æ€ï¼ˆå¸ƒå°”å€¼ï¼‰

---

## ğŸ“‚ ç›¸å…³æ–‡ä»¶

```
CookTip-Backend/
â”œâ”€â”€ database/migrations/
â”‚   â”œâ”€â”€ 2025-10-17-extend-user-table.sql       # è¿ç§» SQL è„šæœ¬
â”‚   â”œâ”€â”€ 2025-10-17-rollback-user-table.sql     # å›æ»š SQL è„šæœ¬
â”‚   â””â”€â”€ user-table-redesign-analysis.md        # è¯¦ç»†åˆ†ææ–‡æ¡£
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ migrate-user-table.js                  # è¿ç§»æ‰§è¡Œè„šæœ¬
â”‚   â”œâ”€â”€ rollback-user-table.js                 # å›æ»šæ‰§è¡Œè„šæœ¬
â”‚   â””â”€â”€ check-current-tables.js                # æ•°æ®åº“æ£€æŸ¥è„šæœ¬
â”œâ”€â”€ src/entities/
â”‚   â””â”€â”€ user.entity.ts                         # æ›´æ–°åçš„ Entity æ–‡ä»¶
â””â”€â”€ ç”¨æˆ·è¡¨æ‰©å±•è¿ç§»æŒ‡å—.md                        # æœ¬æ–‡æ¡£
```

---

## ğŸš€ æ‰§è¡Œè¿ç§»

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Node.js è„šæœ¬ï¼ˆæ¨èï¼‰â­

```bash
# 1. ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip-Backend

# 2. æ‰§è¡Œè¿ç§»
node scripts/migrate-user-table.js
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š**
1. âœ… è¿æ¥æ•°æ®åº“
2. âœ… å¤‡ä»½ç°æœ‰æ•°æ®åˆ° `users_backup_20251017` è¡¨
3. âœ… æ·»åŠ æ–°å­—æ®µ
4. âœ… åˆ›å»ºç´¢å¼•
5. âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§
6. âœ… æ˜¾ç¤ºè¿ç§»ç»“æœ

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œ SQL

å¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶æ¯ä¸€æ­¥ï¼š

```bash
# 1. ä½¿ç”¨ Navicat æˆ–å…¶ä»–æ•°æ®åº“å·¥å…·è¿æ¥
# 2. æ‰“å¼€ database/migrations/2025-10-17-extend-user-table.sql
# 3. é€æ­¥æ‰§è¡Œ SQL è¯­å¥
```

---

## ğŸ“Š è¿ç§»åçš„è¡¨ç»“æ„

```sql
CREATE TABLE `users` (
  -- ä¸»é”®
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  
  -- å¾®ä¿¡ç™»å½•ï¼ˆå¿…éœ€ï¼Œä¿ç•™ï¼‰
  `openid` VARCHAR(100) UNIQUE NOT NULL,
  `session_key` VARCHAR(200),
  
  -- æ‰©å±•ç™»å½•å­—æ®µï¼ˆæ–°å¢ï¼Œå¯é€‰ï¼‰
  `username` VARCHAR(50) UNIQUE,
  `email` VARCHAR(100) UNIQUE,
  `phone` VARCHAR(20) UNIQUE,
  `password_hash` VARCHAR(255),
  `is_verified` BOOLEAN DEFAULT false,
  
  -- åŸºæœ¬ä¿¡æ¯
  `nickname` VARCHAR(50),
  `avatar` VARCHAR(255),
  `bio` VARCHAR(200),
  
  -- ç»Ÿè®¡æ•°æ®
  `recipe_count` INT DEFAULT 0,
  `follower_count` INT DEFAULT 0,
  `following_count` INT DEFAULT 0,
  `favorite_count` INT DEFAULT 0,
  
  -- æ—¶é—´æˆ³
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_openid (`openid`),
  INDEX idx_username (`username`),
  INDEX idx_email (`email`),
  INDEX idx_phone (`phone`)
);
```

---

## âœ… éªŒè¯è¿ç§»ç»“æœ

### æ£€æŸ¥è¡¨ç»“æ„
```bash
node scripts/check-current-tables.js
```

### æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
```sql
-- æ¯”è¾ƒæ•°æ®æ•°é‡
SELECT 
  (SELECT COUNT(*) FROM users) as current_count,
  (SELECT COUNT(*) FROM users_backup_20251017) as backup_count;

-- æŸ¥çœ‹æ–°å­—æ®µ
DESCRIBE users;

-- æŸ¥çœ‹ç¤ºä¾‹æ•°æ®
SELECT id, openid, nickname, username, email, is_verified 
FROM users 
LIMIT 5;
```

---

## ğŸ”„ å¦‚ä½•å›æ»š

å¦‚æœè¿ç§»åé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å›æ»šï¼š

### æ–¹å¼ä¸€ï¼šä½¿ç”¨è„šæœ¬
```bash
node scripts/rollback-user-table.js
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å›æ»š
```sql
-- åˆ é™¤æ–°å¢å­—æ®µ
ALTER TABLE users DROP COLUMN username;
ALTER TABLE users DROP COLUMN email;
ALTER TABLE users DROP COLUMN phone;
ALTER TABLE users DROP COLUMN password_hash;
ALTER TABLE users DROP COLUMN is_verified;

-- åˆ é™¤ç´¢å¼•
DROP INDEX idx_username ON users;
DROP INDEX idx_email ON users;
DROP INDEX idx_phone ON users;
```

---

## ğŸ›¡ï¸ å®‰å…¨ä¿éšœ

### æ•°æ®å¤‡ä»½
- âœ… è‡ªåŠ¨å¤‡ä»½åˆ° `users_backup_20251017` è¡¨
- âœ… å¤‡ä»½è¡¨ä¸åŸè¡¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
- âœ… ä¿ç•™åŸæœ‰æ‰€æœ‰æ•°æ®

### æ•°æ®å®Œæ•´æ€§
- âœ… æ–°å­—æ®µå‡ä¸º `NULL` å…è®¸ï¼Œä¸å½±å“ç°æœ‰æ•°æ®
- âœ… å¤–é”®å…³ç³»ä¿æŒä¸å˜
- âœ… ç°æœ‰ä¸šåŠ¡é€»è¾‘æ— éœ€ä¿®æ”¹

### å›æ»šæœºåˆ¶
- âœ… æä¾›å®Œæ•´å›æ»šè„šæœ¬
- âœ… å¯ä»¥éšæ—¶æ¢å¤åˆ°è¿ç§»å‰çŠ¶æ€
- âœ… å¤‡ä»½æ•°æ®æ°¸ä¹…ä¿ç•™

---

## ğŸ“ åç»­å¼€å‘æŒ‡å—

### 1. ä½¿ç”¨æ–°å­—æ®µ

**åˆ›å»ºæ”¯æŒå¤šç§ç™»å½•æ–¹å¼çš„ç”¨æˆ·ï¼š**

```typescript
// å¾®ä¿¡ç™»å½•ï¼ˆç°æœ‰æ–¹å¼ï¼Œä¿æŒä¸å˜ï¼‰
const wechatUser = userRepository.create({
  openid: 'wx_openid_123',
  session_key: 'session_key_abc',
  nickname: 'å¾®ä¿¡ç”¨æˆ·',
  avatar: 'https://...'
});

// ç”¨æˆ·åå¯†ç ç™»å½•ï¼ˆæ–°åŠŸèƒ½ï¼Œå¯é€‰ï¼‰
const regularUser = userRepository.create({
  openid: 'generated_unique_id',  // ä¸ºéå¾®ä¿¡ç”¨æˆ·ç”Ÿæˆå”¯ä¸€ID
  username: 'johndoe',
  email: 'john@example.com',
  password_hash: await bcrypt.hash('password', 10),
  is_verified: false
});

// æ‰‹æœºå·ç™»å½•ï¼ˆæ–°åŠŸèƒ½ï¼Œå¯é€‰ï¼‰
const phoneUser = userRepository.create({
  openid: 'generated_unique_id',
  phone: '13800138000',
  password_hash: await bcrypt.hash('password', 10),
  is_verified: true
});
```

### 2. æ›´æ–° AuthService

åœ¨ `src/modules/auth/auth.service.ts` ä¸­æ·»åŠ æ–°çš„ç™»å½•æ–¹æ³•ï¼š

```typescript
// ç°æœ‰å¾®ä¿¡ç™»å½•ï¼ˆä¿æŒä¸å˜ï¼‰
async loginWithWechat(code: string) {
  // ç°æœ‰é€»è¾‘
}

// æ–°å¢ï¼šç”¨æˆ·åå¯†ç ç™»å½•
async loginWithPassword(username: string, password: string) {
  const user = await this.userRepository.findOne({
    where: [
      { username },
      { email: username },
      { phone: username }
    ]
  });

  if (!user || !user.password_hash) {
    throw new UnauthorizedException('ç”¨æˆ·ä¸å­˜åœ¨æˆ–æœªè®¾ç½®å¯†ç ');
  }

  const isPasswordValid = await bcrypt.compare(password, user.password_hash);
  if (!isPasswordValid) {
    throw new UnauthorizedException('å¯†ç é”™è¯¯');
  }

  if (!user.is_verified) {
    throw new UnauthorizedException('è´¦å·æœªéªŒè¯');
  }

  return this.generateToken(user);
}
```

### 3. éªŒè¯å’Œå®‰å…¨

```typescript
// DTO éªŒè¯
export class RegisterDto {
  @IsString()
  @MinLength(3)
  @MaxLength(50)
  username: string;

  @IsEmail()
  email: string;

  @IsString()
  @MinLength(6)
  password: string;
}

// å¯†ç åŠ å¯†
import * as bcrypt from 'bcrypt';

const hashedPassword = await bcrypt.hash(plainPassword, 10);
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. OpenID å­—æ®µ
- âŒ **ä¸è¦åˆ é™¤** `openid` å­—æ®µ
- âœ… å¯¹äºå¾®ä¿¡ç”¨æˆ·ï¼Œ`openid` æ˜¯å¿…éœ€çš„
- âœ… å¯¹äºéå¾®ä¿¡ç”¨æˆ·ï¼Œå¯ä»¥ç”Ÿæˆå”¯ä¸€IDä»£æ›¿

### 2. å…¼å®¹æ€§
- âœ… ç°æœ‰å¾®ä¿¡ç™»å½•ä»£ç æ— éœ€ä¿®æ”¹
- âœ… æ–°å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼ˆå…è®¸ NULLï¼‰
- âœ… å‘åå…¼å®¹æ‰€æœ‰ç°æœ‰ API

### 3. æ€§èƒ½è€ƒè™‘
- âœ… ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ äº†ç´¢å¼•ï¼ˆusername, email, phoneï¼‰
- âœ… ä¿æŒå•è¡¨è®¾è®¡ï¼Œé¿å…å¤šè¡¨ JOIN
- âœ… æŸ¥è¯¢æ€§èƒ½ä¸å—å½±å“

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: è¿ç§»ä¼šå½±å“ç°æœ‰åŠŸèƒ½å—ï¼Ÿ
**A:** ä¸ä¼šã€‚æ‰€æœ‰æ–°å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œå¾®ä¿¡ç™»å½•åŠŸèƒ½å®Œå…¨ä¿æŒä¸å˜ã€‚

### Q2: ç°æœ‰ç”¨æˆ·æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ
**A:** ä¸ä¼šã€‚è¿ç§»å‰ä¼šè‡ªåŠ¨å¤‡ä»½ï¼Œä¸”æ‰€æœ‰æ•°æ®ä¿æŒå®Œæ•´ã€‚

### Q3: å¦‚æœè¿ç§»å‡ºé”™æ€ä¹ˆåŠï¼Ÿ
**A:** å¯ä»¥ç«‹å³æ‰§è¡Œå›æ»šè„šæœ¬æ¢å¤åŸçŠ¶ï¼Œæˆ–ä»å¤‡ä»½è¡¨æ¢å¤æ•°æ®ã€‚

### Q4: æ–°å­—æ®µæ˜¯å¼ºåˆ¶çš„å—ï¼Ÿ
**A:** ä¸æ˜¯ã€‚æ‰€æœ‰æ–°å­—æ®µéƒ½å…è®¸ NULLï¼Œå¯ä»¥é€‰æ‹©æ€§ä½¿ç”¨ã€‚

### Q5: éœ€è¦ä¿®æ”¹å‰ç«¯ä»£ç å—ï¼Ÿ
**A:** ä¸éœ€è¦ã€‚ç°æœ‰å‰ç«¯ä»£ç å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œæ–°åŠŸèƒ½å¯ä»¥é€æ­¥å¼€å‘ã€‚

---

## ğŸ“ˆ æœªæ¥æ‰©å±•å»ºè®®

### é˜¶æ®µä¸€ï¼šå®Œæˆè¿ç§»ï¼ˆå½“å‰ï¼‰
- âœ… æ‰©å±• users è¡¨
- âœ… æ›´æ–° Entity æ–‡ä»¶
- âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§

### é˜¶æ®µäºŒï¼šå®ç°æ–°ç™»å½•æ–¹å¼ï¼ˆå¯é€‰ï¼‰
- ğŸ“ å®ç°ç”¨æˆ·åå¯†ç ç™»å½•
- ğŸ“ å®ç°é‚®ç®±ç™»å½•
- ğŸ“ å®ç°æ‰‹æœºå·ç™»å½•
- ğŸ“ æ·»åŠ é‚®ç®±éªŒè¯åŠŸèƒ½

### é˜¶æ®µä¸‰ï¼šå®‰å…¨å¢å¼ºï¼ˆå¯é€‰ï¼‰
- ğŸ“ å®ç°ä¸¤æ­¥éªŒè¯
- ğŸ“ æ·»åŠ ç™»å½•æ—¥å¿—
- ğŸ“ å®ç°å¯†ç é‡ç½®åŠŸèƒ½
- ğŸ“ æ·»åŠ è´¦å·ç»‘å®šåŠŸèƒ½

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- è¯¦ç»†åˆ†æï¼š`database/migrations/user-table-redesign-analysis.md`
- æ•°æ®åº“è„šæœ¬ï¼š`database/migrations/2025-10-17-*.sql`
- Entity æ–‡ä»¶ï¼š`src/entities/user.entity.ts`

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-10-17  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šCookTip Backend v1.0+  
**ç»´æŠ¤è€…**ï¼šCookTip å¼€å‘å›¢é˜Ÿ

---

## âœ¨ æ‰§è¡Œæ¸…å•

åœ¨æ‰§è¡Œè¿ç§»å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²é˜…è¯»å®Œæ•´æ–‡æ¡£
- [ ] å·²äº†è§£è¿ç§»å†…å®¹å’Œå½±å“
- [ ] å·²å‡†å¤‡å¥½æ•°æ®åº“è¿æ¥ä¿¡æ¯
- [ ] å·²äº†è§£å›æ»šæµç¨‹
- [ ] å·²åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼ˆå¦‚æœ‰ï¼‰

**å‡†å¤‡å¥½äº†ï¼Ÿå¼€å§‹æ‰§è¡Œï¼š**

```bash
node scripts/migrate-user-table.js
```

ğŸ‰ ç¥è¿ç§»é¡ºåˆ©ï¼

