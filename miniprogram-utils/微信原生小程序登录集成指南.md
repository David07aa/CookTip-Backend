# 微信原生小程序 - 一键登录集成指南

## 📚 概述

本指南提供了基于微信原生小程序框架的完整登录解决方案，参考 [CSDN教程](https://blog.csdn.net/zmz1196167569/article/details/150635408)，适配 NestJS 后端。

---

## 🔄 登录流程图

```
┌─────────────────┐
│ 1. 用户点击登录 │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ 2. wx.login()   │ ← 获取临时登录凭证 code
└────────┬────────┘
         │
         ↓
┌──────────────────────┐
│ 3. wx.getUserProfile()│ ← 获取用户信息（需用户授权）
└────────┬─────────────┘
         │
         ↓
┌─────────────────────────┐
│ 4. 发送请求到后端        │ ← 通过云函数代理
│    POST /api/v1/auth/wx-login │
│    {                          │
│      code: "...",             │
│      nickName: "...",         │
│      avatarUrl: "..."         │
│    }                          │
└────────┬──────────────────────┘
         │
         ↓
┌─────────────────────────────┐
│ 5. 后端调用微信API          │ ← code 换取 openid
│    jscode2session            │
└────────┬────────────────────┘
         │
         ↓
┌─────────────────────────────┐
│ 6. 查询/创建用户            │ ← 根据 openid
└────────┬────────────────────┘
         │
         ↓
┌─────────────────────────────┐
│ 7. 生成 JWT Token           │
└────────┬────────────────────┘
         │
         ↓
┌─────────────────────────────┐
│ 8. 返回 token 和用户信息    │
└────────┬────────────────────┘
         │
         ↓
┌─────────────────────────────┐
│ 9. 保存到本地存储           │ ← wx.setStorageSync
│    access_token             │
│    user_info                │
└─────────────────────────────┘
```

---

## 📦 文件说明

| 文件 | 说明 |
|------|------|
| `wechat-login.js` | 登录核心逻辑封装 |
| `wechat-login-page-example.js` | 登录页面 JS 示例 |
| `wechat-login-page-example.wxml` | 登录页面 WXML 示例 |
| `wechat-login-page-example.wxss` | 登录页面样式示例 |

---

## 🚀 快速开始

### 第一步：复制工具文件

将 `wechat-login.js` 复制到小程序项目的 `utils` 目录：

```
your-miniprogram/
├── utils/
│   └── wechat-login.js  ← 复制这个文件
├── pages/
│   └── login/
│       ├── login.js
│       ├── login.wxml
│       └── login.wxss
```

### 第二步：在登录页面中引入

在 `pages/login/login.js` 中：

```javascript
// 引入登录工具
const wechatAuth = require('../../utils/wechat-login.js');

Page({
  data: {
    isLoading: false
  },

  // 处理登录按钮点击
  handleWechatLogin() {
    if (this.data.isLoading) return;
    
    this.setData({ isLoading: true });
    wx.showLoading({ title: '登录中...' });

    // 调用登录方法
    wechatAuth.wechatLogin()
      .then(result => {
        console.log('登录成功:', result);
        wx.hideLoading();
        wx.showToast({ title: '登录成功', icon: 'success' });
        
        // 跳转到首页
        setTimeout(() => {
          wx.switchTab({ url: '/pages/index/index' });
        }, 1500);
      })
      .catch(error => {
        console.error('登录失败:', error);
        wx.hideLoading();
        wx.showToast({ 
          title: error.message || '登录失败', 
          icon: 'none' 
        });
      })
      .finally(() => {
        this.setData({ isLoading: false });
      });
  }
});
```

### 第三步：在 WXML 中添加登录按钮

在 `pages/login/login.wxml` 中：

```xml
<view class="container">
  <button 
    class="login-btn" 
    type="primary"
    bindtap="handleWechatLogin"
    disabled="{{isLoading}}"
  >
    {{isLoading ? '登录中...' : '微信一键登录'}}
  </button>
</view>
```

---

## 🔑 核心 API 说明

### 1. wechatLogin()

**功能**：执行完整的微信登录流程

**返回值**：
```javascript
{
  success: true,
  token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  userInfo: {
    id: 1,
    openid: "oXXXX...",
    nickname: "张三",
    avatar: "https://...",
    created_at: "2024-10-16T12:00:00.000Z"
  }
}
```

**示例**：
```javascript
const wechatAuth = require('../../utils/wechat-login.js');

wechatAuth.wechatLogin()
  .then(result => {
    console.log('登录成功:', result);
    // 处理登录成功逻辑
  })
  .catch(error => {
    console.error('登录失败:', error);
    // 处理登录失败逻辑
  });
```

---

### 2. checkLoginStatus()

**功能**：检查用户是否已登录

**返回值**：`boolean`

**示例**：
```javascript
const wechatAuth = require('../../utils/wechat-login.js');

Page({
  onLoad() {
    const isLogin = wechatAuth.checkLoginStatus();
    
    if (!isLogin) {
      // 未登录，跳转到登录页
      wx.navigateTo({ url: '/pages/login/login' });
    } else {
      // 已登录，加载页面数据
      this.loadPageData();
    }
  }
});
```

---

### 3. getLocalUserInfo()

**功能**：获取本地存储的用户信息

**返回值**：用户信息对象或 `null`

**示例**：
```javascript
const userInfo = wechatAuth.getLocalUserInfo();

if (userInfo) {
  console.log('当前用户:', userInfo.nickname);
  this.setData({ userInfo });
}
```

---

### 4. getLocalToken()

**功能**：获取本地存储的访问令牌

**返回值**：token 字符串或 `null`

**示例**：
```javascript
const token = wechatAuth.getLocalToken();

if (token) {
  // 在API请求中使用token
  wx.cloud.callFunction({
    name: 'api-proxy',
    data: {
      method: 'GET',
      path: '/api/v1/user/profile',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    }
  });
}
```

---

### 5. logout()

**功能**：退出登录，清除本地数据

**示例**：
```javascript
// 退出登录
wechatAuth.logout();

// 跳转到登录页
wx.reLaunch({ url: '/pages/login/login' });
```

---

### 6. refreshToken()

**功能**：刷新访问令牌

**返回值**：Promise，包含新的 token

**示例**：
```javascript
wechatAuth.refreshToken()
  .then(newToken => {
    console.log('Token 刷新成功:', newToken);
  })
  .catch(error => {
    console.error('Token 刷新失败:', error);
    // Token 过期或无效，需要重新登录
    wx.reLaunch({ url: '/pages/login/login' });
  });
```

---

## 🎨 完整登录页面示例

参考提供的示例文件：
- `wechat-login-page-example.js` - 页面逻辑
- `wechat-login-page-example.wxml` - 页面结构
- `wechat-login-page-example.wxss` - 页面样式

您可以直接复制这些文件到您的项目中，根据需要调整样式和逻辑。

---

## 🔒 权限配置

### 1. app.json 配置

```json
{
  "permission": {
    "scope.userInfo": {
      "desc": "您的用户信息将用于个性化推荐"
    }
  }
}
```

### 2. 云函数权限

确保 `cloudfunctions/api-proxy` 已部署并有正确的权限配置。

### 3. 小程序隐私协议

在微信公众平台配置隐私协议，说明获取用户信息的用途。

---

## ⚠️ 注意事项

### 1. wx.getUserProfile 必须由用户主动触发

`wx.getUserProfile` 必须在用户点击按钮等主动行为后调用，不能在页面加载时自动调用。

**正确示例**：
```javascript
// ✅ 正确：绑定到按钮点击事件
<button bindtap="handleLogin">登录</button>

handleLogin() {
  wechatAuth.wechatLogin(); // OK
}
```

**错误示例**：
```javascript
// ❌ 错误：在 onLoad 中自动调用
onLoad() {
  wechatAuth.wechatLogin(); // 会失败！
}
```

---

### 2. 用户可能拒绝授权

用户可能会拒绝授权，需要处理这种情况：

```javascript
wechatAuth.wechatLogin()
  .catch(error => {
    if (error.message.includes('取消授权')) {
      wx.showModal({
        title: '提示',
        content: '授权后才能使用完整功能哦',
        confirmText: '重新授权',
        success: (res) => {
          if (res.confirm) {
            this.handleWechatLogin(); // 重新尝试登录
          }
        }
      });
    }
  });
```

---

### 3. Token 过期处理

建议在 API 请求失败时检查是否为 401 错误，自动刷新 token 或重新登录：

```javascript
// 在 api.js 中统一处理
function handleApiError(error) {
  if (error.statusCode === 401) {
    // Token 过期，尝试刷新
    return wechatAuth.refreshToken()
      .then(() => {
        // 刷新成功，重试原请求
        return retryRequest();
      })
      .catch(() => {
        // 刷新失败，重新登录
        wx.reLaunch({ url: '/pages/login/login' });
      });
  }
}
```

---

## 🐛 常见问题

### Q1: 调用 wx.getUserProfile 报错 "fail auth deny"

**原因**：
1. 没有在按钮点击等用户主动操作中调用
2. 小程序版本过旧，不支持 wx.getUserProfile

**解决**：
1. 确保在用户点击按钮后调用
2. 在微信开发者工具中检查基础库版本 ≥ 2.10.4

---

### Q2: 登录成功但没有返回用户信息

**原因**：后端环境变量 `WX_APPID` 或 `WX_SECRET` 配置错误

**解决**：
1. 检查 `cloudbase-env-vars.json` 中的配置
2. 在微信公众平台获取正确的 AppID 和 Secret
3. 重启云托管服务使环境变量生效

---

### Q3: code 换取 openid 失败

**原因**：
1. code 已被使用（code 只能使用一次）
2. code 过期（code 有效期 5 分钟）
3. AppID 或 Secret 错误

**解决**：
1. 确保每次登录都重新调用 `wx.login()` 获取新 code
2. 获取 code 后立即发送到后端
3. 检查后端配置

---

## 📖 相关文档

- [微信小程序登录官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [wx.getUserProfile API](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)
- [参考教程 - CSDN](https://blog.csdn.net/zmz1196167569/article/details/150635408)

---

## ✅ 测试清单

在生产环境部署前，请确保：

- [ ] 能够成功调用 wx.login 获取 code
- [ ] 能够成功调用 wx.getUserProfile 获取用户信息
- [ ] 能够成功发送登录请求到后端
- [ ] 后端能够成功调用微信 API 换取 openid
- [ ] 能够正确保存和读取 token
- [ ] 能够正确处理用户拒绝授权的情况
- [ ] 能够正确处理 token 过期的情况
- [ ] 退出登录功能正常
- [ ] Token 刷新功能正常

---

**最后更新**: 2024-10-16  
**版本**: v1.0.0

