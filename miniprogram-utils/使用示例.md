# 小程序使用示例

## 1. 初始化云开发

在 `app.js` 中初始化：

```javascript
// app.js
App({
  onLaunch: function () {
    // 初始化云开发
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力')
    } else {
      wx.cloud.init({
        env: 'cooktip-prod-xxx', // 替换为您的云开发环境 ID
        traceUser: true
      })
    }
  },
  
  globalData: {
    userInfo: null,
    token: null
  }
})
```

## 2. 复制工具类到小程序项目

将以下文件复制到小程序项目的 `utils` 目录：

```
utils/
  ├── cloudRequest.js   # 云函数请求工具
  └── api.js           # API 接口封装
```

## 3. 使用示例

### 首页加载数据

```javascript
// pages/index/index.js
const api = require('../../utils/api')

Page({
  data: {
    categories: [],
    recipes: [],
    hotRecipes: []
  },
  
  onLoad() {
    this.loadData()
  },
  
  async loadData() {
    try {
      // 并行加载多个接口
      const [categoriesRes, recipesRes, hotRes] = await Promise.all([
        api.getCategoryList(),
        api.getRecipeList({
          page: 1,
          limit: 10,
          sort: 'recommended'
        }),
        api.getHotRecipes()
      ])
      
      this.setData({
        categories: categoriesRes.data,
        recipes: recipesRes.data.items,
        hotRecipes: hotRes.data
      })
      
    } catch (error) {
      console.error('加载失败:', error)
    }
  },
  
  // 下拉刷新
  async onPullDownRefresh() {
    await this.loadData()
    wx.stopPullDownRefresh()
  }
})
```

### 食谱详情页

```javascript
// pages/recipe-detail/recipe-detail.js
const api = require('../../utils/api')

Page({
  data: {
    recipe: null,
    comments: []
  },
  
  onLoad(options) {
    const { id } = options
    this.loadRecipeDetail(id)
    this.loadComments(id)
    
    // 增加浏览量
    api.incrementRecipeView(id)
  },
  
  async loadRecipeDetail(id) {
    try {
      const res = await api.getRecipeDetail(id)
      this.setData({
        recipe: res.data
      })
    } catch (error) {
      console.error('加载食谱详情失败:', error)
    }
  },
  
  async loadComments(id) {
    try {
      const res = await api.getRecipeComments(id, {
        page: 1,
        limit: 20
      })
      this.setData({
        comments: res.data
      })
    } catch (error) {
      console.error('加载评论失败:', error)
    }
  },
  
  // 点赞食谱
  async handleLike() {
    try {
      const res = await api.toggleLikeRecipe(this.data.recipe.id)
      
      // 更新点赞状态
      this.setData({
        'recipe.isLiked': res.data.isLiked,
        'recipe.likes': res.data.likes
      })
      
      wx.showToast({
        title: res.data.isLiked ? '已点赞' : '已取消',
        icon: 'success'
      })
    } catch (error) {
      console.error('点赞失败:', error)
    }
  },
  
  // 收藏食谱
  async handleFavorite() {
    try {
      const res = await api.toggleFavoriteRecipe(this.data.recipe.id)
      
      this.setData({
        'recipe.isFavorited': res.data.isFavorited,
        'recipe.favorites': res.data.favorites
      })
      
      wx.showToast({
        title: res.data.isFavorited ? '已收藏' : '已取消',
        icon: 'success'
      })
    } catch (error) {
      console.error('收藏失败:', error)
    }
  }
})
```

### 微信登录

```javascript
// pages/login/login.js
const api = require('../../utils/api')

Page({
  // 微信登录
  async handleWxLogin() {
    try {
      // 1. 调用 wx.login 获取 code
      const loginRes = await wx.login()
      const code = loginRes.code
      
      console.log('获取到 code:', code)
      
      // 2. 发送 code 到后端
      const res = await api.wxLogin(code)
      
      console.log('登录成功:', res)
      
      // 3. 保存 token 和用户信息
      wx.setStorageSync('cooktip_token', res.data.token)
      wx.setStorageSync('cooktip_userInfo', res.data.userInfo)
      
      // 4. 更新全局数据
      const app = getApp()
      app.globalData.token = res.data.token
      app.globalData.userInfo = res.data.userInfo
      
      // 5. 提示并跳转
      wx.showToast({
        title: '登录成功',
        icon: 'success',
        duration: 2000
      })
      
      setTimeout(() => {
        wx.switchTab({
          url: '/pages/index/index'
        })
      }, 2000)
      
    } catch (error) {
      console.error('登录失败:', error)
      wx.showToast({
        title: '登录失败，请重试',
        icon: 'none'
      })
    }
  },
  
  // 获取用户信息授权
  handleGetUserInfo(e) {
    if (e.detail.userInfo) {
      // 用户同意授权
      this.handleWxLogin()
    } else {
      // 用户拒绝授权
      wx.showToast({
        title: '需要授权才能登录',
        icon: 'none'
      })
    }
  }
})
```

### 搜索页面

```javascript
// pages/search/search.js
const api = require('../../utils/api')

Page({
  data: {
    keyword: '',
    hotKeywords: [],
    searchResults: [],
    searching: false
  },
  
  onLoad() {
    this.loadHotKeywords()
  },
  
  // 加载热门搜索词
  async loadHotKeywords() {
    try {
      const res = await api.getHotKeywords()
      this.setData({
        hotKeywords: res.data
      })
    } catch (error) {
      console.error('加载热门搜索词失败:', error)
    }
  },
  
  // 输入搜索关键词
  onKeywordInput(e) {
    this.setData({
      keyword: e.detail.value
    })
  },
  
  // 执行搜索
  async handleSearch() {
    const { keyword } = this.data
    
    if (!keyword.trim()) {
      wx.showToast({
        title: '请输入搜索关键词',
        icon: 'none'
      })
      return
    }
    
    this.setData({ searching: true })
    
    try {
      const res = await api.searchRecipes(keyword, {
        page: 1,
        limit: 20
      })
      
      this.setData({
        searchResults: res.data.items,
        searching: false
      })
      
      if (res.data.items.length === 0) {
        wx.showToast({
          title: '没有找到相关食谱',
          icon: 'none'
        })
      }
      
    } catch (error) {
      console.error('搜索失败:', error)
      this.setData({ searching: false })
    }
  },
  
  // 点击热门搜索词
  onHotKeywordTap(e) {
    const keyword = e.currentTarget.dataset.keyword
    this.setData({ keyword })
    this.handleSearch()
  }
})
```

### 个人中心

```javascript
// pages/profile/profile.js
const api = require('../../utils/api')

Page({
  data: {
    userInfo: null,
    stats: null,
    myRecipes: [],
    myFavorites: []
  },
  
  onLoad() {
    this.loadUserData()
  },
  
  async loadUserData() {
    try {
      // 加载用户信息和统计数据
      const [userRes, statsRes] = await Promise.all([
        api.getUserInfo(),
        api.getUserStats('me')
      ])
      
      this.setData({
        userInfo: userRes.data,
        stats: statsRes.data
      })
      
      // 加载我的食谱
      this.loadMyRecipes()
      
      // 加载我的收藏
      this.loadMyFavorites()
      
    } catch (error) {
      console.error('加载用户数据失败:', error)
    }
  },
  
  async loadMyRecipes() {
    try {
      const res = await api.getUserRecipes('me', {
        page: 1,
        limit: 10
      })
      this.setData({
        myRecipes: res.data.items
      })
    } catch (error) {
      console.error('加载我的食谱失败:', error)
    }
  },
  
  async loadMyFavorites() {
    try {
      const res = await api.getMyFavorites({
        page: 1,
        limit: 10
      })
      this.setData({
        myFavorites: res.data.items
      })
    } catch (error) {
      console.error('加载我的收藏失败:', error)
    }
  },
  
  // 退出登录
  async handleLogout() {
    try {
      await api.logout()
      
      // 清除本地存储
      wx.removeStorageSync('cooktip_token')
      wx.removeStorageSync('cooktip_userInfo')
      
      // 清除全局数据
      const app = getApp()
      app.globalData.token = null
      app.globalData.userInfo = null
      
      // 跳转到登录页
      wx.redirectTo({
        url: '/pages/login/login'
      })
      
    } catch (error) {
      console.error('退出登录失败:', error)
    }
  }
})
```

### 创建食谱

```javascript
// pages/create-recipe/create-recipe.js
const api = require('../../utils/api')

Page({
  data: {
    title: '',
    description: '',
    categoryId: null,
    difficulty: '简单',
    cookTime: 30,
    servings: 2,
    ingredients: [],
    steps: []
  },
  
  // 提交食谱
  async handleSubmit() {
    const { title, description, categoryId } = this.data
    
    // 验证必填项
    if (!title || !description || !categoryId) {
      wx.showToast({
        title: '请填写完整信息',
        icon: 'none'
      })
      return
    }
    
    try {
      const res = await api.createRecipe({
        title: this.data.title,
        description: this.data.description,
        category_id: this.data.categoryId,
        difficulty: this.data.difficulty,
        cook_time: this.data.cookTime,
        servings: this.data.servings,
        ingredients: this.data.ingredients,
        steps: this.data.steps
      })
      
      wx.showToast({
        title: '发布成功',
        icon: 'success'
      })
      
      // 跳转到食谱详情页
      setTimeout(() => {
        wx.redirectTo({
          url: `/pages/recipe-detail/recipe-detail?id=${res.data.id}`
        })
      }, 1500)
      
    } catch (error) {
      console.error('创建食谱失败:', error)
    }
  }
})
```

## 4. 错误处理

工具类已经内置了错误处理，会自动：

- 显示错误提示
- 401 错误自动跳转登录页
- 网络错误提示用户检查网络

## 5. 加载提示

可以在请求时显示加载提示：

```javascript
// 方式 1：使用 API 封装（已内置 loading）
const res = await api.getRecipeList()

// 方式 2：自定义 loading
const { cloudRequest } = require('../../utils/cloudRequest')
const res = await cloudRequest({
  url: '/api/v1/recipes',
  method: 'GET',
  showLoading: true,
  loadingText: '加载中...'
})
```

## 6. Token 管理

### 自动携带 Token

使用 `authRequest` 会自动携带 Token：

```javascript
const { authRequest } = require('../../utils/cloudRequest')

// 自动携带 Token
const res = await authRequest({
  url: '/api/v1/users/me',
  method: 'GET'
})
```

### Token 过期处理

Token 过期（401）会自动：
1. 提示用户"请先登录"
2. 2 秒后跳转到登录页

## 7. 性能优化

### 并行请求

```javascript
// 同时请求多个接口
const [res1, res2, res3] = await Promise.all([
  api.getCategoryList(),
  api.getRecipeList(),
  api.getHotRecipes()
])
```

### 分页加载

```javascript
Page({
  data: {
    page: 1,
    limit: 20,
    recipes: [],
    hasMore: true
  },
  
  async loadMore() {
    if (!this.data.hasMore) return
    
    try {
      const res = await api.getRecipeList({
        page: this.data.page,
        limit: this.data.limit
      })
      
      this.setData({
        recipes: [...this.data.recipes, ...res.data.items],
        page: this.data.page + 1,
        hasMore: res.data.items.length === this.data.limit
      })
    } catch (error) {
      console.error('加载更多失败:', error)
    }
  },
  
  // 触底加载
  onReachBottom() {
    this.loadMore()
  }
})
```

## 8. 调试技巧

### 查看请求日志

在控制台可以看到详细的请求和响应信息：

```
云函数响应: { errMsg: "cloud.callFunction:ok", result: {...} }
```

### 查看云函数日志

1. 打开云开发控制台
2. 选择 **云函数** → **api-proxy**
3. 点击 **日志** 标签
4. 查看详细的转发日志

## 9. 注意事项

1. **初始化云开发**：必须在 app.js 中初始化云开发
2. **环境 ID**：替换为您的实际云开发环境 ID
3. **Token 存储**：登录后记得保存 Token
4. **错误处理**：工具类已包含基本错误处理
5. **加载状态**：注意管理加载状态，避免重复请求

## 10. 完整示例项目结构

```
miniprogram/
├── app.js                    # 应用入口，初始化云开发
├── app.json                  # 应用配置
├── utils/
│   ├── cloudRequest.js      # 云函数请求工具 ⭐
│   └── api.js               # API 接口封装 ⭐
├── pages/
│   ├── index/               # 首页
│   ├── recipe-detail/       # 食谱详情
│   ├── search/              # 搜索页
│   ├── login/               # 登录页
│   ├── profile/             # 个人中心
│   └── create-recipe/       # 创建食谱
└── components/              # 自定义组件
```

完成！现在您可以在小程序中使用云函数访问后端 API 了！ 🎉

