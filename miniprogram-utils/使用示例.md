# å°ç¨‹åºä½¿ç”¨ç¤ºä¾‹

## 1. åˆå§‹åŒ–äº‘å¼€å‘

åœ¨ `app.js` ä¸­åˆå§‹åŒ–ï¼š

```javascript
// app.js
App({
  onLaunch: function () {
    // åˆå§‹åŒ–äº‘å¼€å‘
    if (!wx.cloud) {
      console.error('è¯·ä½¿ç”¨ 2.2.3 æˆ–ä»¥ä¸Šçš„åŸºç¡€åº“ä»¥ä½¿ç”¨äº‘èƒ½åŠ›')
    } else {
      wx.cloud.init({
        env: 'cooktip-prod-xxx', // æ›¿æ¢ä¸ºæ‚¨çš„äº‘å¼€å‘ç¯å¢ƒ ID
        traceUser: true
      })
    }
  },
  
  globalData: {
    userInfo: null,
    token: null
  }
})
```

## 2. å¤åˆ¶å·¥å…·ç±»åˆ°å°ç¨‹åºé¡¹ç›®

å°†ä»¥ä¸‹æ–‡ä»¶å¤åˆ¶åˆ°å°ç¨‹åºé¡¹ç›®çš„ `utils` ç›®å½•ï¼š

```
utils/
  â”œâ”€â”€ cloudRequest.js   # äº‘å‡½æ•°è¯·æ±‚å·¥å…·
  â””â”€â”€ api.js           # API æ¥å£å°è£…
```

## 3. ä½¿ç”¨ç¤ºä¾‹

### é¦–é¡µåŠ è½½æ•°æ®

```javascript
// pages/index/index.js
const api = require('../../utils/api')

Page({
  data: {
    categories: [],
    recipes: [],
    hotRecipes: []
  },
  
  onLoad() {
    this.loadData()
  },
  
  async loadData() {
    try {
      // å¹¶è¡ŒåŠ è½½å¤šä¸ªæ¥å£
      const [categoriesRes, recipesRes, hotRes] = await Promise.all([
        api.getCategoryList(),
        api.getRecipeList({
          page: 1,
          limit: 10,
          sort: 'recommended'
        }),
        api.getHotRecipes()
      ])
      
      this.setData({
        categories: categoriesRes.data,
        recipes: recipesRes.data.items,
        hotRecipes: hotRes.data
      })
      
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥:', error)
    }
  },
  
  // ä¸‹æ‹‰åˆ·æ–°
  async onPullDownRefresh() {
    await this.loadData()
    wx.stopPullDownRefresh()
  }
})
```

### é£Ÿè°±è¯¦æƒ…é¡µ

```javascript
// pages/recipe-detail/recipe-detail.js
const api = require('../../utils/api')

Page({
  data: {
    recipe: null,
    comments: []
  },
  
  onLoad(options) {
    const { id } = options
    this.loadRecipeDetail(id)
    this.loadComments(id)
    
    // å¢åŠ æµè§ˆé‡
    api.incrementRecipeView(id)
  },
  
  async loadRecipeDetail(id) {
    try {
      const res = await api.getRecipeDetail(id)
      this.setData({
        recipe: res.data
      })
    } catch (error) {
      console.error('åŠ è½½é£Ÿè°±è¯¦æƒ…å¤±è´¥:', error)
    }
  },
  
  async loadComments(id) {
    try {
      const res = await api.getRecipeComments(id, {
        page: 1,
        limit: 20
      })
      this.setData({
        comments: res.data
      })
    } catch (error) {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error)
    }
  },
  
  // ç‚¹èµé£Ÿè°±
  async handleLike() {
    try {
      const res = await api.toggleLikeRecipe(this.data.recipe.id)
      
      // æ›´æ–°ç‚¹èµçŠ¶æ€
      this.setData({
        'recipe.isLiked': res.data.isLiked,
        'recipe.likes': res.data.likes
      })
      
      wx.showToast({
        title: res.data.isLiked ? 'å·²ç‚¹èµ' : 'å·²å–æ¶ˆ',
        icon: 'success'
      })
    } catch (error) {
      console.error('ç‚¹èµå¤±è´¥:', error)
    }
  },
  
  // æ”¶è—é£Ÿè°±
  async handleFavorite() {
    try {
      const res = await api.toggleFavoriteRecipe(this.data.recipe.id)
      
      this.setData({
        'recipe.isFavorited': res.data.isFavorited,
        'recipe.favorites': res.data.favorites
      })
      
      wx.showToast({
        title: res.data.isFavorited ? 'å·²æ”¶è—' : 'å·²å–æ¶ˆ',
        icon: 'success'
      })
    } catch (error) {
      console.error('æ”¶è—å¤±è´¥:', error)
    }
  }
})
```

### å¾®ä¿¡ç™»å½•

```javascript
// pages/login/login.js
const api = require('../../utils/api')

Page({
  // å¾®ä¿¡ç™»å½•
  async handleWxLogin() {
    try {
      // 1. è°ƒç”¨ wx.login è·å– code
      const loginRes = await wx.login()
      const code = loginRes.code
      
      console.log('è·å–åˆ° code:', code)
      
      // 2. å‘é€ code åˆ°åç«¯
      const res = await api.wxLogin(code)
      
      console.log('ç™»å½•æˆåŠŸ:', res)
      
      // 3. ä¿å­˜ token å’Œç”¨æˆ·ä¿¡æ¯
      wx.setStorageSync('cooktip_token', res.data.token)
      wx.setStorageSync('cooktip_userInfo', res.data.userInfo)
      
      // 4. æ›´æ–°å…¨å±€æ•°æ®
      const app = getApp()
      app.globalData.token = res.data.token
      app.globalData.userInfo = res.data.userInfo
      
      // 5. æç¤ºå¹¶è·³è½¬
      wx.showToast({
        title: 'ç™»å½•æˆåŠŸ',
        icon: 'success',
        duration: 2000
      })
      
      setTimeout(() => {
        wx.switchTab({
          url: '/pages/index/index'
        })
      }, 2000)
      
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
      wx.showToast({
        title: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      })
    }
  },
  
  // è·å–ç”¨æˆ·ä¿¡æ¯æˆæƒ
  handleGetUserInfo(e) {
    if (e.detail.userInfo) {
      // ç”¨æˆ·åŒæ„æˆæƒ
      this.handleWxLogin()
    } else {
      // ç”¨æˆ·æ‹’ç»æˆæƒ
      wx.showToast({
        title: 'éœ€è¦æˆæƒæ‰èƒ½ç™»å½•',
        icon: 'none'
      })
    }
  }
})
```

### æœç´¢é¡µé¢

```javascript
// pages/search/search.js
const api = require('../../utils/api')

Page({
  data: {
    keyword: '',
    hotKeywords: [],
    searchResults: [],
    searching: false
  },
  
  onLoad() {
    this.loadHotKeywords()
  },
  
  // åŠ è½½çƒ­é—¨æœç´¢è¯
  async loadHotKeywords() {
    try {
      const res = await api.getHotKeywords()
      this.setData({
        hotKeywords: res.data
      })
    } catch (error) {
      console.error('åŠ è½½çƒ­é—¨æœç´¢è¯å¤±è´¥:', error)
    }
  },
  
  // è¾“å…¥æœç´¢å…³é”®è¯
  onKeywordInput(e) {
    this.setData({
      keyword: e.detail.value
    })
  },
  
  // æ‰§è¡Œæœç´¢
  async handleSearch() {
    const { keyword } = this.data
    
    if (!keyword.trim()) {
      wx.showToast({
        title: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯',
        icon: 'none'
      })
      return
    }
    
    this.setData({ searching: true })
    
    try {
      const res = await api.searchRecipes(keyword, {
        page: 1,
        limit: 20
      })
      
      this.setData({
        searchResults: res.data.items,
        searching: false
      })
      
      if (res.data.items.length === 0) {
        wx.showToast({
          title: 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é£Ÿè°±',
          icon: 'none'
        })
      }
      
    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', error)
      this.setData({ searching: false })
    }
  },
  
  // ç‚¹å‡»çƒ­é—¨æœç´¢è¯
  onHotKeywordTap(e) {
    const keyword = e.currentTarget.dataset.keyword
    this.setData({ keyword })
    this.handleSearch()
  }
})
```

### ä¸ªäººä¸­å¿ƒ

```javascript
// pages/profile/profile.js
const api = require('../../utils/api')

Page({
  data: {
    userInfo: null,
    stats: null,
    myRecipes: [],
    myFavorites: []
  },
  
  onLoad() {
    this.loadUserData()
  },
  
  async loadUserData() {
    try {
      // åŠ è½½ç”¨æˆ·ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®
      const [userRes, statsRes] = await Promise.all([
        api.getUserInfo(),
        api.getUserStats('me')
      ])
      
      this.setData({
        userInfo: userRes.data,
        stats: statsRes.data
      })
      
      // åŠ è½½æˆ‘çš„é£Ÿè°±
      this.loadMyRecipes()
      
      // åŠ è½½æˆ‘çš„æ”¶è—
      this.loadMyFavorites()
      
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
    }
  },
  
  async loadMyRecipes() {
    try {
      const res = await api.getUserRecipes('me', {
        page: 1,
        limit: 10
      })
      this.setData({
        myRecipes: res.data.items
      })
    } catch (error) {
      console.error('åŠ è½½æˆ‘çš„é£Ÿè°±å¤±è´¥:', error)
    }
  },
  
  async loadMyFavorites() {
    try {
      const res = await api.getMyFavorites({
        page: 1,
        limit: 10
      })
      this.setData({
        myFavorites: res.data.items
      })
    } catch (error) {
      console.error('åŠ è½½æˆ‘çš„æ”¶è—å¤±è´¥:', error)
    }
  },
  
  // é€€å‡ºç™»å½•
  async handleLogout() {
    try {
      await api.logout()
      
      // æ¸…é™¤æœ¬åœ°å­˜å‚¨
      wx.removeStorageSync('cooktip_token')
      wx.removeStorageSync('cooktip_userInfo')
      
      // æ¸…é™¤å…¨å±€æ•°æ®
      const app = getApp()
      app.globalData.token = null
      app.globalData.userInfo = null
      
      // è·³è½¬åˆ°ç™»å½•é¡µ
      wx.redirectTo({
        url: '/pages/login/login'
      })
      
    } catch (error) {
      console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
    }
  }
})
```

### åˆ›å»ºé£Ÿè°±

```javascript
// pages/create-recipe/create-recipe.js
const api = require('../../utils/api')

Page({
  data: {
    title: '',
    description: '',
    categoryId: null,
    difficulty: 'ç®€å•',
    cookTime: 30,
    servings: 2,
    ingredients: [],
    steps: []
  },
  
  // æäº¤é£Ÿè°±
  async handleSubmit() {
    const { title, description, categoryId } = this.data
    
    // éªŒè¯å¿…å¡«é¡¹
    if (!title || !description || !categoryId) {
      wx.showToast({
        title: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯',
        icon: 'none'
      })
      return
    }
    
    try {
      const res = await api.createRecipe({
        title: this.data.title,
        description: this.data.description,
        category_id: this.data.categoryId,
        difficulty: this.data.difficulty,
        cook_time: this.data.cookTime,
        servings: this.data.servings,
        ingredients: this.data.ingredients,
        steps: this.data.steps
      })
      
      wx.showToast({
        title: 'å‘å¸ƒæˆåŠŸ',
        icon: 'success'
      })
      
      // è·³è½¬åˆ°é£Ÿè°±è¯¦æƒ…é¡µ
      setTimeout(() => {
        wx.redirectTo({
          url: `/pages/recipe-detail/recipe-detail?id=${res.data.id}`
        })
      }, 1500)
      
    } catch (error) {
      console.error('åˆ›å»ºé£Ÿè°±å¤±è´¥:', error)
    }
  }
})
```

## 4. é”™è¯¯å¤„ç†

å·¥å…·ç±»å·²ç»å†…ç½®äº†é”™è¯¯å¤„ç†ï¼Œä¼šè‡ªåŠ¨ï¼š

- æ˜¾ç¤ºé”™è¯¯æç¤º
- 401 é”™è¯¯è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
- ç½‘ç»œé”™è¯¯æç¤ºç”¨æˆ·æ£€æŸ¥ç½‘ç»œ

## 5. åŠ è½½æç¤º

å¯ä»¥åœ¨è¯·æ±‚æ—¶æ˜¾ç¤ºåŠ è½½æç¤ºï¼š

```javascript
// æ–¹å¼ 1ï¼šä½¿ç”¨ API å°è£…ï¼ˆå·²å†…ç½® loadingï¼‰
const res = await api.getRecipeList()

// æ–¹å¼ 2ï¼šè‡ªå®šä¹‰ loading
const { cloudRequest } = require('../../utils/cloudRequest')
const res = await cloudRequest({
  url: '/api/v1/recipes',
  method: 'GET',
  showLoading: true,
  loadingText: 'åŠ è½½ä¸­...'
})
```

## 6. Token ç®¡ç†

### è‡ªåŠ¨æºå¸¦ Token

ä½¿ç”¨ `authRequest` ä¼šè‡ªåŠ¨æºå¸¦ Tokenï¼š

```javascript
const { authRequest } = require('../../utils/cloudRequest')

// è‡ªåŠ¨æºå¸¦ Token
const res = await authRequest({
  url: '/api/v1/users/me',
  method: 'GET'
})
```

### Token è¿‡æœŸå¤„ç†

Token è¿‡æœŸï¼ˆ401ï¼‰ä¼šè‡ªåŠ¨ï¼š
1. æç¤ºç”¨æˆ·"è¯·å…ˆç™»å½•"
2. 2 ç§’åè·³è½¬åˆ°ç™»å½•é¡µ

## 7. æ€§èƒ½ä¼˜åŒ–

### å¹¶è¡Œè¯·æ±‚

```javascript
// åŒæ—¶è¯·æ±‚å¤šä¸ªæ¥å£
const [res1, res2, res3] = await Promise.all([
  api.getCategoryList(),
  api.getRecipeList(),
  api.getHotRecipes()
])
```

### åˆ†é¡µåŠ è½½

```javascript
Page({
  data: {
    page: 1,
    limit: 20,
    recipes: [],
    hasMore: true
  },
  
  async loadMore() {
    if (!this.data.hasMore) return
    
    try {
      const res = await api.getRecipeList({
        page: this.data.page,
        limit: this.data.limit
      })
      
      this.setData({
        recipes: [...this.data.recipes, ...res.data.items],
        page: this.data.page + 1,
        hasMore: res.data.items.length === this.data.limit
      })
    } catch (error) {
      console.error('åŠ è½½æ›´å¤šå¤±è´¥:', error)
    }
  },
  
  // è§¦åº•åŠ è½½
  onReachBottom() {
    this.loadMore()
  }
})
```

## 8. è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹è¯·æ±‚æ—¥å¿—

åœ¨æ§åˆ¶å°å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯ï¼š

```
äº‘å‡½æ•°å“åº”: { errMsg: "cloud.callFunction:ok", result: {...} }
```

### æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—

1. æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°
2. é€‰æ‹© **äº‘å‡½æ•°** â†’ **api-proxy**
3. ç‚¹å‡» **æ—¥å¿—** æ ‡ç­¾
4. æŸ¥çœ‹è¯¦ç»†çš„è½¬å‘æ—¥å¿—

## 9. æ³¨æ„äº‹é¡¹

1. **åˆå§‹åŒ–äº‘å¼€å‘**ï¼šå¿…é¡»åœ¨ app.js ä¸­åˆå§‹åŒ–äº‘å¼€å‘
2. **ç¯å¢ƒ ID**ï¼šæ›¿æ¢ä¸ºæ‚¨çš„å®é™…äº‘å¼€å‘ç¯å¢ƒ ID
3. **Token å­˜å‚¨**ï¼šç™»å½•åè®°å¾—ä¿å­˜ Token
4. **é”™è¯¯å¤„ç†**ï¼šå·¥å…·ç±»å·²åŒ…å«åŸºæœ¬é”™è¯¯å¤„ç†
5. **åŠ è½½çŠ¶æ€**ï¼šæ³¨æ„ç®¡ç†åŠ è½½çŠ¶æ€ï¼Œé¿å…é‡å¤è¯·æ±‚

## 10. å®Œæ•´ç¤ºä¾‹é¡¹ç›®ç»“æ„

```
miniprogram/
â”œâ”€â”€ app.js                    # åº”ç”¨å…¥å£ï¼Œåˆå§‹åŒ–äº‘å¼€å‘
â”œâ”€â”€ app.json                  # åº”ç”¨é…ç½®
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ cloudRequest.js      # äº‘å‡½æ•°è¯·æ±‚å·¥å…· â­
â”‚   â””â”€â”€ api.js               # API æ¥å£å°è£… â­
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ index/               # é¦–é¡µ
â”‚   â”œâ”€â”€ recipe-detail/       # é£Ÿè°±è¯¦æƒ…
â”‚   â”œâ”€â”€ search/              # æœç´¢é¡µ
â”‚   â”œâ”€â”€ login/               # ç™»å½•é¡µ
â”‚   â”œâ”€â”€ profile/             # ä¸ªäººä¸­å¿ƒ
â”‚   â””â”€â”€ create-recipe/       # åˆ›å»ºé£Ÿè°±
â””â”€â”€ components/              # è‡ªå®šä¹‰ç»„ä»¶
```

å®Œæˆï¼ç°åœ¨æ‚¨å¯ä»¥åœ¨å°ç¨‹åºä¸­ä½¿ç”¨äº‘å‡½æ•°è®¿é—®åç«¯ API äº†ï¼ ğŸ‰

