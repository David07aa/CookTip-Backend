# 500 é”™è¯¯ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é—®é¢˜è¯Šæ–­ç»“æœ

é€šè¿‡æµ‹è¯•äº‘æ‰˜ç®¡ APIï¼Œå‘ç°äº†ä»¥ä¸‹é—®é¢˜ï¼š

### âŒ é—®é¢˜ 1: `sort=recommended` å¯¼è‡´ 500 é”™è¯¯
**æ¥å£**: `GET /api/v1/recipes?sort=recommended`  
**åŸå› **: TypeORM çš„ `orderBy()` æ–¹æ³•ä¸æ”¯æŒå¤æ‚çš„ SQL è¡¨è¾¾å¼  
**é”™è¯¯ä»£ç **:
```typescript
queryBuilder.orderBy('(recipe.likes * 3 + recipe.favorites * 2 + recipe.views * 0.1)', 'DESC');
```

### âŒ é—®é¢˜ 2: è¯„è®ºæ¥å£è¿”å› 404
**æ¥å£**: `GET /api/v1/comments?recipeId=4`  
**åŸå› **: åç«¯åªæœ‰ `GET /recipes/:recipeId/comments` è·¯ç”±ï¼Œç¼ºå°‘ `/comments?recipeId=xxx` è·¯ç”±  

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: æ¨èæ’åºç®—æ³•
**æ–‡ä»¶**: `src/modules/recipe/recipe.service.ts`  
**ä¿®æ”¹**:
```typescript
case 'recommended':
  // æ¨èç®—æ³•ï¼šç»¼åˆè€ƒè™‘ç‚¹èµã€æ”¶è—ã€æµè§ˆé‡
  // ä½¿ç”¨ addSelect å’Œ orderBy æ¥å¤„ç†è®¡ç®—å­—æ®µ
  queryBuilder
    .addSelect('(recipe.likes * 3 + recipe.favorites * 2 + recipe.views * 0.1)', 'score')
    .orderBy('score', 'DESC');
  break;
```

**è¯´æ˜**: ä½¿ç”¨ `addSelect` å…ˆåˆ›å»ºä¸€ä¸ªè®¡ç®—å­—æ®µ `score`ï¼Œç„¶åç”¨ `orderBy` å¯¹è¿™ä¸ªå­—æ®µæ’åºã€‚

### ä¿®å¤ 2: æ·»åŠ è¯„è®ºæ¥å£è·¯ç”±
**æ–‡ä»¶**: `src/modules/comment/comment.controller.ts`  
**æ–°å¢æ¥å£**:
```typescript
@Get('comments')
@Public()
@ApiOperation({ summary: 'è·å–è¯„è®ºåˆ—è¡¨ï¼ˆé€šè¿‡æŸ¥è¯¢å‚æ•°ï¼‰' })
@ApiQuery({ name: 'recipeId', required: true, type: Number })
async getComments(
  @Query('recipeId', ParseIntPipe) recipeId: number,
  @Query('page') page: number = 1,
  @Query('limit') limit: number = 10,
  @Query('sort') sort: string = 'latest',
  @CurrentUser('id') currentUserId?: number,
) {
  return this.commentService.getRecipeComments(
    recipeId,
    page,
    limit,
    sort,
    currentUserId,
  );
}
```

**è¯´æ˜**: æ–°å¢äº† `/comments?recipeId=xxx` è·¯ç”±ï¼Œå…¼å®¹å‰ç«¯çš„è¯·æ±‚æ–¹å¼ã€‚

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä»£ç å·²æ¨é€ âœ…
ä¿®å¤ä»£ç å·²æ¨é€åˆ° GitHub `main` åˆ†æ”¯ã€‚

### 2. é‡æ–°éƒ¨ç½²äº‘æ‰˜ç®¡ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
1. æ‰“å¼€ [å¾®ä¿¡äº‘æ‰˜ç®¡æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
2. æ‰¾åˆ°æœåŠ¡ `yjsp-ytg`
3. ç‚¹å‡»ã€Œæ–°å»ºç‰ˆæœ¬ã€
4. é€‰æ‹©ä» GitHub æ‹‰å–ä»£ç ï¼ˆ`main` åˆ†æ”¯ï¼‰
5. ç­‰å¾…æ„å»ºå®Œæˆï¼ˆçº¦ 2-3 åˆ†é’Ÿï¼‰

### 3. éªŒè¯ä¿®å¤

éƒ¨ç½²å®Œæˆåï¼Œæµ‹è¯•ä»¥ä¸‹æ¥å£ï¼š

```bash
# æµ‹è¯• recommended æ’åºï¼ˆä¿®å¤ååº”è¯¥è¿”å› 200ï¼‰
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?page=1&limit=10&sort=recommended"

# æµ‹è¯•è¯„è®ºæ¥å£ï¼ˆä¿®å¤ååº”è¯¥è¿”å› 200ï¼‰
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/comments?recipeId=4&page=1&limit=10"

# æµ‹è¯•é£Ÿè°±è¯¦æƒ…
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes/4"
```

## ğŸ“Š ä¿®å¤åçš„æ’åºé€»è¾‘

æ¨èæ’åºç®—æ³•åŸºäºä»¥ä¸‹æƒé‡ï¼š
- **ç‚¹èµæ•°**: æƒé‡ Ã— 3
- **æ”¶è—æ•°**: æƒé‡ Ã— 2  
- **æµè§ˆé‡**: æƒé‡ Ã— 0.1

**ç¤ºä¾‹è®¡ç®—**ï¼ˆå½“å‰æ•°æ®åº“ä¸­çš„é£Ÿè°±ï¼‰:
- ç•ªèŒ„ç‚’è›‹: 107Ã—3 + 43Ã—2 + 187Ã—0.1 = **424.7 åˆ†**
- çº¢çƒ§æ’éª¨: 39Ã—3 + 52Ã—2 + 375Ã—0.1 = **258.5 åˆ†**
- æˆšé£è›‹ç³•: 36Ã—3 + 33Ã—2 + 421Ã—0.1 = **216.1 åˆ†**

## ğŸ“ ä¿®å¤çš„æ–‡ä»¶

1. `src/modules/recipe/recipe.service.ts` - ä¿®å¤æ¨èæ’åºç®—æ³•
2. `src/modules/comment/comment.controller.ts` - æ·»åŠ è¯„è®ºæ¥å£è·¯ç”±

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»é‡æ–°éƒ¨ç½²**: ä¿®å¤ä»£ç å¿…é¡»åœ¨äº‘æ‰˜ç®¡æ§åˆ¶å°é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆ
2. **éƒ¨ç½²æ—¶é—´**: é€šå¸¸éœ€è¦ 2-3 åˆ†é’Ÿ
3. **å‰ç«¯ç¼“å­˜**: å¦‚æœå‰ç«¯æœ‰ç¼“å­˜ï¼Œå¯èƒ½éœ€è¦æ¸…é™¤ç¼“å­˜æˆ–é‡å¯å°ç¨‹åº

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `åç«¯500é”™è¯¯è§£å†³æ–¹æ¡ˆ.md` - åˆæ­¥è¯Šæ–­æŠ¥å‘Š
- `éƒ¨ç½²æŒ‡å—.md` - è¯¦ç»†çš„éƒ¨ç½²æ­¥éª¤

---

**è¯·ç«‹å³é‡æ–°éƒ¨ç½²äº‘æ‰˜ç®¡æœåŠ¡ï¼Œä¿®å¤å°†ç«‹å³ç”Ÿæ•ˆï¼** ğŸ¯

