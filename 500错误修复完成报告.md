# 500 错误修复完成报告

## 📋 问题诊断结果

通过测试云托管 API，发现了以下问题：

### ❌ 问题 1: `sort=recommended` 导致 500 错误
**接口**: `GET /api/v1/recipes?sort=recommended`  
**原因**: TypeORM 的 `orderBy()` 方法不支持复杂的 SQL 表达式  
**错误代码**:
```typescript
queryBuilder.orderBy('(recipe.likes * 3 + recipe.favorites * 2 + recipe.views * 0.1)', 'DESC');
```

### ❌ 问题 2: 评论接口返回 404
**接口**: `GET /api/v1/comments?recipeId=4`  
**原因**: 后端只有 `GET /recipes/:recipeId/comments` 路由，缺少 `/comments?recipeId=xxx` 路由  

## ✅ 修复方案

### 修复 1: 推荐排序算法
**文件**: `src/modules/recipe/recipe.service.ts`  
**修改**:
```typescript
case 'recommended':
  // 推荐算法：综合考虑点赞、收藏、浏览量
  // 使用 addSelect 和 orderBy 来处理计算字段
  queryBuilder
    .addSelect('(recipe.likes * 3 + recipe.favorites * 2 + recipe.views * 0.1)', 'score')
    .orderBy('score', 'DESC');
  break;
```

**说明**: 使用 `addSelect` 先创建一个计算字段 `score`，然后用 `orderBy` 对这个字段排序。

### 修复 2: 添加评论接口路由
**文件**: `src/modules/comment/comment.controller.ts`  
**新增接口**:
```typescript
@Get('comments')
@Public()
@ApiOperation({ summary: '获取评论列表（通过查询参数）' })
@ApiQuery({ name: 'recipeId', required: true, type: Number })
async getComments(
  @Query('recipeId', ParseIntPipe) recipeId: number,
  @Query('page') page: number = 1,
  @Query('limit') limit: number = 10,
  @Query('sort') sort: string = 'latest',
  @CurrentUser('id') currentUserId?: number,
) {
  return this.commentService.getRecipeComments(
    recipeId,
    page,
    limit,
    sort,
    currentUserId,
  );
}
```

**说明**: 新增了 `/comments?recipeId=xxx` 路由，兼容前端的请求方式。

## 🚀 部署步骤

### 1. 代码已推送 ✅
修复代码已推送到 GitHub `main` 分支。

### 2. 重新部署云托管（必须执行）
1. 打开 [微信云托管控制台](https://console.cloud.tencent.com/tcb)
2. 找到服务 `yjsp-ytg`
3. 点击「新建版本」
4. 选择从 GitHub 拉取代码（`main` 分支）
5. 等待构建完成（约 2-3 分钟）

### 3. 验证修复

部署完成后，测试以下接口：

```bash
# 测试 recommended 排序（修复后应该返回 200）
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?page=1&limit=10&sort=recommended"

# 测试评论接口（修复后应该返回 200）
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/comments?recipeId=4&page=1&limit=10"

# 测试食谱详情
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes/4"
```

## 📊 修复后的排序逻辑

推荐排序算法基于以下权重：
- **点赞数**: 权重 × 3
- **收藏数**: 权重 × 2  
- **浏览量**: 权重 × 0.1

**示例计算**（当前数据库中的食谱）:
- 番茄炒蛋: 107×3 + 43×2 + 187×0.1 = **424.7 分**
- 红烧排骨: 39×3 + 52×2 + 375×0.1 = **258.5 分**
- 戚风蛋糕: 36×3 + 33×2 + 421×0.1 = **216.1 分**

## 📝 修复的文件

1. `src/modules/recipe/recipe.service.ts` - 修复推荐排序算法
2. `src/modules/comment/comment.controller.ts` - 添加评论接口路由

## ⚠️ 注意事项

1. **必须重新部署**: 修复代码必须在云托管控制台重新部署才能生效
2. **部署时间**: 通常需要 2-3 分钟
3. **前端缓存**: 如果前端有缓存，可能需要清除缓存或重启小程序

## 🔗 相关文档

- `后端500错误解决方案.md` - 初步诊断报告
- `部署指南.md` - 详细的部署步骤

---

**请立即重新部署云托管服务，修复将立即生效！** 🎯

