# 微信登录 404 问题解决方案

## 🔍 问题描述

小程序访问微信登录接口时报错：
```
POST https://cooktip-backend.vercel.app/api/auth/wechat 404 (Not Found)
```

## 📊 已确认信息

✅ **后端文件存在**
- `api/auth/wechat.js` 文件存在
- 代码已提交到 Git
- 最近提交：`0f33195` 和 `fae450c`

✅ **Vercel 部署成功**
- 最新部署：26分钟前
- 状态：● Ready
- 生产地址：https://cooktip-backend.vercel.app

✅ **配置正确**
- `vercel.json` 配置正确
- 路由规则：`/api/(.*) → /api/$1`
- 支持 POST 方法

❌ **当前测试受阻**
- 所有测试请求都返回 429（速率限制）
- 无法直接验证接口是否可访问

---

## 🎯 可能的原因

### 1. CDN 缓存问题（最可能）⭐
- Vercel 的 CDN 可能还在缓存旧版本
- 新部署的接口需要时间同步到所有节点
- **预计时间**：5-10 分钟

### 2. 路由配置缓存
- Vercel 边缘网络的路由表未更新
- 需要等待全球 CDN 节点同步

### 3. 函数未正确构建
- `api/auth/wechat.js` 可能未被识别为函数
- 需要验证构建输出

---

## ✅ 解决方案

### 方案 1：等待 CDN 更新（推荐）

**操作步骤：**
1. 等待 **10-15 分钟**
2. 在小程序中重新测试
3. 如果仍然 404，清除小程序缓存

**为什么这样做：**
- Vercel 的全球 CDN 需要时间同步
- 部署成功 ≠ CDN 立即生效
- 这是最常见的原因

---

### 方案 2：清除小程序缓存

**操作步骤：**
1. 微信开发者工具
2. 点击 **清除缓存** → **清除数据缓存** 和 **清除网络缓存**
3. **完全关闭** 开发者工具
4. 重新打开并测试

**为什么这样做：**
- 小程序可能缓存了 404 响应
- 清除缓存强制重新请求

---

### 方案 3：手动验证部署

**在 Vercel Dashboard 中检查：**

1. 访问：https://vercel.com/dashboard
2. 进入项目：`cooktip-backend`
3. 点击最新部署
4. 查看 **Functions** 标签
5. 确认 `api/auth/wechat` 是否在列表中

**预期结果：**
- 应该看到 12 个函数
- 包括 `api/auth/wechat.js`

---

### 方案 4：强制清除 CDN 缓存

**重新部署并清除缓存：**

```powershell
# 方法1：使用一键部署脚本
.\deploy.ps1 "清除CDN缓存重新部署"

# 方法2：手动命令
git commit --allow-empty -m "清除CDN缓存"
git push origin main
vercel --prod --force --token G6jj9jmjazCTlSAsQ7BYhbEf --yes
```

**然后等待 5-10 分钟**

---

### 方案 5：直接测试新部署地址（绕过 CDN）

**使用最新部署的直接地址：**

```javascript
// 临时修改为最新部署地址（不经过 CDN）
const url = 'https://cooktip-backend-8brdoytts-davids-projects-688aeefc.vercel.app/api/auth/wechat';

wx.request({
  url: url,
  method: 'POST',
  data: { code: res.code }
});
```

**预期结果：**
- 如果这个地址可以访问 → CDN 缓存问题
- 如果仍然 404 → 函数未部署

---

## 🔧 验证步骤

### 步骤 1：验证函数是否部署

**命令行验证：**
```powershell
# 查看部署详情
vercel inspect https://cooktip-backend-8brdoytts-davids-projects-688aeefc.vercel.app --token G6jj9jmjazCTlSAsQ7BYhbEf

# 应该看到：
# ├── λ api/auth/wechat.js
```

### 步骤 2：测试直接部署地址

**PowerShell 测试：**
```powershell
$body = @{ code = "test" } | ConvertTo-Json
Invoke-RestMethod -Uri "https://cooktip-backend-8brdoytts-davids-projects-688aeefc.vercel.app/api/auth/wechat" -Method Post -Body $body -ContentType "application/json"
```

### 步骤 3：测试生产地址

**等待 10 分钟后：**
```powershell
$body = @{ code = "test" } | ConvertTo-Json
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/auth/wechat" -Method Post -Body $body -ContentType "application/json"
```

---

## 📋 检查清单

### 立即检查：
- [ ] 等待 10-15 分钟让 CDN 更新
- [ ] 清除小程序缓存
- [ ] 完全关闭并重新打开开发者工具
- [ ] 在小程序中重新测试

### 如果仍然失败：
- [ ] 在 Vercel Dashboard 查看 Functions 列表
- [ ] 测试直接部署地址（绕过 CDN）
- [ ] 重新部署并使用 `--force` 标志
- [ ] 等待 30 分钟后再次测试

### 确认部署：
- [ ] 访问 Vercel Dashboard
- [ ] 查看最新部署状态
- [ ] 确认 Functions 标签下有 12 个函数
- [ ] 确认 `api/auth/wechat` 在列表中

---

## 💡 预防措施

### 后续部署建议：

1. **部署后等待**
   - 部署成功后等待 5-10 分钟
   - 让 CDN 完全同步

2. **清除缓存**
   - 每次部署后清除小程序缓存
   - 避免使用旧版本接口

3. **使用版本号**
   - 考虑在 API 路径中添加版本号
   - 如：`/api/v1/auth/wechat`

4. **监控部署**
   - 查看 Vercel 部署日志
   - 确认所有函数都已构建

---

## 🚀 快速解决方案（最简单）

**如果您急于测试，请按以下步骤操作：**

### 1. 等待（5 分钟）
```
现在时间：记录
等待到：  +10分钟
```

### 2. 清除缓存
```
开发者工具 → 清除缓存 → 清除所有
```

### 3. 重启工具
```
完全关闭开发者工具
重新打开
```

### 4. 测试
```
在小程序中重新登录
查看控制台输出
```

### 5. 如果成功
```
✅ 问题解决 - 是 CDN 缓存问题
```

### 6. 如果仍然失败
```
❌ 使用方案 5：测试直接部署地址
   或联系我们进一步排查
```

---

## 📞 需要帮助？

如果以上方案都无法解决，请提供：

1. **Vercel Dashboard 截图**
   - 最新部署的 Functions 列表
   - 部署状态

2. **小程序错误日志**
   - 完整的错误堆栈
   - 请求和响应详情

3. **测试结果**
   - 直接部署地址的测试结果
   - 生产地址的测试结果

---

## ✅ 预期结果

### 接口正常时应返回：

**测试 code 无效（正常）：**
```json
{
  "code": 401,
  "message": "微信登录失败",
  "data": {
    "error": "invalid code",
    "errcode": 40029
  }
}
```

**真实 code（成功）：**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJ...",
    "user": {
      "id": "uuid",
      "nickName": "用户名",
      ...
    }
  }
}
```

---

**最可能的情况：等待 10 分钟后问题自动解决（CDN 缓存更新）** ⏰

