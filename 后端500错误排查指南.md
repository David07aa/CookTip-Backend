# åç«¯ 500 é”™è¯¯æ’æŸ¥æŒ‡å—

> ğŸ“… åˆ›å»ºæ—¶é—´ï¼š2025-10-09  
> ğŸ”§ é—®é¢˜ï¼šåç«¯è¿”å› 500 Internal Server Error  
> ğŸ¯ å‰ç«¯çŠ¶æ€ï¼šå·²ä¿®å¤å®Œæˆï¼Œå®¹é”™æœºåˆ¶æ­£å¸¸

---

## ğŸ“Š å½“å‰çŠ¶æ€

### âœ… å‰ç«¯ï¼ˆå·²å®Œæˆï¼‰

| æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|--------|------|
| ç½‘ç»œè¿æ¥ | âœ… æ­£å¸¸ï¼ˆèƒ½è®¿é—®å…¬ç½‘åœ°å€ï¼‰|
| API è·¯å¾„æ ¼å¼ | âœ… æ­£ç¡®ï¼ˆæ— é‡å¤è·¯å¾„ï¼‰|
| ç¯å¢ƒé…ç½® | âœ… å®Œæˆï¼ˆå¼€å‘ç”¨å…¬ç½‘ï¼Œç”Ÿäº§ç”¨å†…ç½‘ï¼‰|
| å®¹é”™æœºåˆ¶ | âœ… å·²å®ç°ï¼ˆåŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå¤‡ç”¨æ•°æ®ï¼‰|

**å‰ç«¯è¯·æ±‚çš„ URLï¼ˆæ­£ç¡®ï¼‰**ï¼š
```
âœ… https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/categories
âœ… https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?page=1&limit=10
```

### âŒ åç«¯ï¼ˆéœ€è¦ä¿®å¤ï¼‰

| æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|--------|------|
| æœåŠ¡è¿è¡Œ | âœ… æ­£å¸¸ï¼ˆèƒ½è¿”å› JSONï¼‰|
| æ¥å£å®ç° | âŒ **500 é”™è¯¯** |
| æ•°æ®åº“è¿æ¥ | â“ æœªçŸ¥ï¼ˆéœ€è¦æŸ¥çœ‹æ—¥å¿—ï¼‰|
| è¡¨ç»“æ„ | â“ æœªçŸ¥ï¼ˆéœ€è¦æŸ¥çœ‹æ—¥å¿—ï¼‰|

**åç«¯è¿”å›çš„é”™è¯¯**ï¼š
```json
{
  "statusCode": 500,
  "message": "Internal server error"
}
```

---

## ğŸ” é”™è¯¯è¯Šæ–­

### å®Œæ•´çš„é”™è¯¯ä¿¡æ¯

```bash
GET https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/categories
Status: 500 (Internal Server Error)

Response:
{
  "statusCode": 500,
  "message": "Internal server error"
}
```

### é”™è¯¯ç±»å‹åˆ†æ

**500 Internal Server Error** è¯´æ˜ï¼š
- âœ… å‰ç«¯èƒ½è®¿é—®åç«¯ï¼ˆç½‘ç»œé€šç•…ï¼‰
- âœ… API è·¯å¾„æ­£ç¡®ï¼ˆåç«¯èƒ½æ¥æ”¶åˆ°è¯·æ±‚ï¼‰
- âŒ åç«¯åœ¨å¤„ç†è¯·æ±‚æ—¶å‡ºé”™äº†

---

## ğŸ¯ å¯èƒ½çš„åŸå› 

### 1ï¸âƒ£ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼ˆæœ€å¯èƒ½ï¼‰

**é—®é¢˜**ï¼š
- SQLPub æ•°æ®åº“é…ç½®é”™è¯¯
- æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸æ­£ç¡®
- æ•°æ®åº“æœåŠ¡æœªå¯åŠ¨

**æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹åç«¯ç¯å¢ƒå˜é‡
DATABASE_URL=mysql://user:password@host:port/database

# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -h host -u user -p database
```

### 2ï¸âƒ£ æ•°æ®è¡¨æœªåˆ›å»º

**é—®é¢˜**ï¼š
```sql
-- åç«¯ä»£ç å°è¯•æŸ¥è¯¢è¡¨ï¼Œä½†è¡¨ä¸å­˜åœ¨
SELECT * FROM categories;  -- Error: Table 'categories' doesn't exist
```

**è§£å†³æ–¹æ³•**ï¼š
```sql
-- åˆ›å»ºå¿…è¦çš„æ•°æ®è¡¨
CREATE TABLE categories (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  icon VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE recipes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  cover_image VARCHAR(255),
  -- ... å…¶ä»–å­—æ®µ
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3ï¸âƒ£ åç«¯æ¥å£æœªå®Œå…¨å®ç°

**é—®é¢˜**ï¼š
```typescript
// åç«¯ä»£ç å¯èƒ½åªæ˜¯ä¸ªæ¡†æ¶ï¼Œæ²¡æœ‰å®é™…å®ç°
@Get('categories')
async getCategories() {
  // TODO: å®ç°è·å–åˆ†ç±»åˆ—è¡¨
  throw new Error('Not implemented yet');  // å¯¼è‡´ 500 é”™è¯¯
}
```

**è§£å†³æ–¹æ³•**ï¼š
å®ç°å®Œæ•´çš„æ¥å£é€»è¾‘

### 4ï¸âƒ£ åç«¯ä»£ç æœ‰ bug

**å¸¸è§çš„ bug**ï¼š
```typescript
// ç©ºæŒ‡é’ˆé”™è¯¯
const data = await this.categoryService.findAll();
const result = data.items.map(...)  // Error: data is undefined

// ç±»å‹é”™è¯¯
const page = req.query.page;
const offset = (page - 1) * 10;  // Error: page is string, not number

// æ•°æ®åº“æŸ¥è¯¢é”™è¯¯
const result = await db.query('SELECT * FORM categories');  // Syntax error: FORM â†’ FROM
```

### 5ï¸âƒ£ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡

**é—®é¢˜**ï¼š
```bash
# åç«¯å¯èƒ½ç¼ºå°‘è¿™äº›ç¯å¢ƒå˜é‡
DATABASE_URL=?
JWT_SECRET=?
WECHAT_APP_ID=?
WECHAT_APP_SECRET=?
```

---

## ğŸ› ï¸ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤ 1ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—

**åœ¨å¾®ä¿¡äº‘æ‰˜ç®¡æ§åˆ¶å°**ï¼š

1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
2. è¿›å…¥ã€Œäº‘å¼€å‘ã€â†’ã€Œäº‘æ‰˜ç®¡ã€
3. é€‰æ‹©ä½ çš„æœåŠ¡
4. ç‚¹å‡»ã€Œæ—¥å¿—ã€æŸ¥çœ‹

**æŸ¥æ‰¾å…³é”®ä¿¡æ¯**ï¼š
```bash
# æ•°æ®åº“é”™è¯¯
Error: connect ECONNREFUSED
Error: ER_NO_SUCH_TABLE: Table 'xxx' doesn't exist
Error: Access denied for user 'xxx'@'xxx'

# ä»£ç é”™è¯¯
TypeError: Cannot read property 'xxx' of undefined
ReferenceError: xxx is not defined
Error: xxx is not a function

# ç¯å¢ƒå˜é‡é”™è¯¯
Error: DATABASE_URL is not defined
Error: Missing required environment variable
```

### æ­¥éª¤ 2ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥

**ç™»å½• SQLPub ç®¡ç†é¢æ¿**ï¼š

1. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦åˆ›å»º
2. æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦å­˜åœ¨
3. æ£€æŸ¥æ•°æ®æ˜¯å¦åˆå§‹åŒ–

**æµ‹è¯•è¿æ¥**ï¼š
```bash
# ä½¿ç”¨ MySQL å®¢æˆ·ç«¯æµ‹è¯•
mysql -h <SQLPubä¸»æœº> -u <ç”¨æˆ·å> -p

# æŸ¥çœ‹æ•°æ®åº“
SHOW DATABASES;

# ä½¿ç”¨æ•°æ®åº“
USE your_database;

# æŸ¥çœ‹è¡¨
SHOW TABLES;

# æŸ¥çœ‹è¡¨ç»“æ„
DESCRIBE categories;
DESCRIBE recipes;
```

### æ­¥éª¤ 3ï¼šæ£€æŸ¥åç«¯ç¯å¢ƒå˜é‡

**åœ¨äº‘æ‰˜ç®¡æ§åˆ¶å°**ï¼š

1. è¿›å…¥ã€ŒæœåŠ¡ç®¡ç†ã€
2. ç‚¹å‡»ã€Œç¯å¢ƒå˜é‡ã€
3. æ£€æŸ¥æ˜¯å¦é…ç½®äº†ï¼š
   - `DATABASE_URL`
   - `DATABASE_HOST`
   - `DATABASE_PORT`
   - `DATABASE_USER`
   - `DATABASE_PASSWORD`
   - `DATABASE_NAME`

### æ­¥éª¤ 4ï¼šæœ¬åœ°æµ‹è¯•åç«¯

**å¦‚æœä½ æœ‰åç«¯ä»£ç **ï¼š

```bash
# 1. å…‹éš†åç«¯ä»£ç 
git clone <åç«¯ä»“åº“>

# 2. å®‰è£…ä¾èµ–
npm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥æ•°æ®åº“é…ç½®

# 4. è¿è¡Œåç«¯
npm run dev

# 5. æµ‹è¯•æ¥å£
curl http://localhost:3000/api/v1/categories
```

### æ­¥éª¤ 5ï¼šè”ç³»åç«¯å¼€å‘è€…

å¦‚æœä»¥ä¸Šæ­¥éª¤æ— æ³•è§£å†³ï¼Œè”ç³»åç«¯å¼€å‘è€…å¹¶æä¾›ï¼š

1. **é”™è¯¯æˆªå›¾**ï¼ˆåŒ…å«è¯·æ±‚ URL å’Œå“åº”ï¼‰
2. **åç«¯æ—¥å¿—**ï¼ˆä»äº‘æ‰˜ç®¡æ§åˆ¶å°å¤åˆ¶ï¼‰
3. **æ•°æ®åº“é…ç½®**ï¼ˆè„±æ•åçš„è¿æ¥ä¿¡æ¯ï¼‰

---

## ğŸ“ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### å‰ç«¯å·²æœ‰å®¹é”™æœºåˆ¶

å³ä½¿åç«¯è¿”å› 500 é”™è¯¯ï¼Œå‰ç«¯ä¹Ÿä¸ä¼šç™½å±ï¼

**1. å¤‡ç”¨æ•°æ®ï¼ˆFallback Dataï¼‰**

å‰ç«¯å·²ç»å†…ç½®äº†å¤‡ç”¨æ•°æ®ï¼š

```javascript
// pages/index/index.js
loadCoreData() {
  try {
    // å°è¯•ä»åç«¯åŠ è½½
    const data = await api.category.getCategoryList()
    this.setData({ categories: data })
  } catch (error) {
    // åç«¯å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®
    this.setData({ 
      categories: this.getDefaultCategories(),  // å†…ç½®çš„é»˜è®¤åˆ†ç±»
      recommendRecipes: this.data.fallbackRecipes  // å†…ç½®çš„é»˜è®¤é£Ÿè°±
    })
  }
}
```

**2. ç¼“å­˜æœºåˆ¶**

åˆ†ç±»æ•°æ®ä¼šç¼“å­˜ 30 åˆ†é’Ÿï¼š

```javascript
// api/category.js
getCategoryListCached() {
  // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
  const cached = wx.getStorageSync('category_list')
  if (cached && !expired) {
    return cached.data  // è¿”å›ç¼“å­˜æ•°æ®
  }
  
  // ç¼“å­˜å¤±æ•ˆï¼Œå°è¯•ä»åç«¯åŠ è½½
  try {
    const data = await this.getCategoryList()
    // æ›´æ–°ç¼“å­˜
    wx.setStorageSync('category_list', data)
    return data
  } catch (error) {
    // åç«¯å¤±è´¥ï¼Œè¿”å›è¿‡æœŸçš„ç¼“å­˜ï¼ˆæ€»æ¯”æ²¡æœ‰å¥½ï¼‰
    if (cached) return cached.data
    throw error
  }
}
```

**3. ç”¨æˆ·æç¤º**

åŠ è½½å¤±è´¥æ—¶ä¼šæ˜¾ç¤ºæç¤ºï¼š

```javascript
wx.showToast({
  title: 'åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ•°æ®',
  icon: 'none'
})
```

### ç”¨æˆ·ä½“éªŒ

å³ä½¿åç«¯ 500 é”™è¯¯ï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯ï¼š
- âœ… é¡µé¢æ­£å¸¸æ˜¾ç¤ºï¼ˆä½¿ç”¨å¤‡ç”¨æ•°æ®ï¼‰
- âœ… å¯ä»¥æµè§ˆé»˜è®¤é£Ÿè°±
- âœ… å¯ä»¥ä½¿ç”¨å…¶ä»–åŠŸèƒ½ï¼ˆæ”¶è—ã€æœç´¢ç­‰åŸºäºæœ¬åœ°å­˜å‚¨çš„åŠŸèƒ½ï¼‰
- âš ï¸ æç¤ºã€ŒåŠ è½½å¤±è´¥ã€

---

## ğŸ¯ åç«¯å¼€å‘å»ºè®®

### æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

åˆ›å»º `database/init.sql`ï¼š

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS cooktip CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE cooktip;

-- åˆ†ç±»è¡¨
CREATE TABLE IF NOT EXISTS categories (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  icon VARCHAR(255),
  order_index INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_order (order_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- æ’å…¥é»˜è®¤åˆ†ç±»
INSERT INTO categories (name, icon, order_index) VALUES
('æ—©é¤', 'breakfast.png', 1),
('åˆé¤', 'lunch.png', 2),
('æ™šé¤', 'dinner.png', 3),
('ç”œç‚¹', 'dessert.png', 4),
('æ±¤ç¾¹', 'soup.png', 5);

-- é£Ÿè°±è¡¨
CREATE TABLE IF NOT EXISTS recipes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  cover_image VARCHAR(255),
  category_id INT,
  difficulty ENUM('ç®€å•', 'ä¸­ç­‰', 'å›°éš¾') DEFAULT 'ç®€å•',
  cook_time INT DEFAULT 30,
  servings INT DEFAULT 2,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (category_id) REFERENCES categories(id),
  INDEX idx_category (category_id),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### é”™è¯¯å¤„ç†ä¸­é—´ä»¶

```typescript
// src/middleware/error-handler.ts
import { ExceptionFilter, Catch, ArgumentsHost, HttpException } from '@nestjs/common';

@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    // è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
    console.error('=== 500 é”™è¯¯è¯¦æƒ… ===');
    console.error('URL:', request.url);
    console.error('Method:', request.method);
    console.error('Error:', exception);
    console.error('Stack:', exception.stack);
    console.error('==================');

    // è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    response.status(500).json({
      statusCode: 500,
      message: process.env.NODE_ENV === 'production' 
        ? 'Internal server error'
        : exception.message,  // å¼€å‘ç¯å¢ƒè¿”å›è¯¦ç»†é”™è¯¯
      timestamp: new Date().toISOString(),
      path: request.url,
    });
  }
}
```

### å¥åº·æ£€æŸ¥æ¥å£

```typescript
// src/health/health.controller.ts
@Controller('health')
export class HealthController {
  constructor(private db: DatabaseService) {}

  @Get()
  async check() {
    try {
      // æµ‹è¯•æ•°æ®åº“è¿æ¥
      await this.db.query('SELECT 1');
      
      return {
        status: 'ok',
        database: 'connected',
        timestamp: new Date().toISOString()
      };
    } catch (error) {
      return {
        status: 'error',
        database: 'disconnected',
        error: error.message,
        timestamp: new Date().toISOString()
      };
    }
  }
}
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### å¯¹äºå‰ç«¯å¼€å‘è€…ï¼ˆä½ ï¼‰

âœ… **å‰ç«¯å·¥ä½œå·²å®Œæˆ**ï¼Œæ— éœ€ä¿®æ”¹

ä½ å¯ä»¥ï¼š
1. ç»§ç»­å¼€å‘å…¶ä»–åŠŸèƒ½ï¼ˆä¸ä¾èµ–åç«¯çš„åŠŸèƒ½ï¼‰
2. ä½¿ç”¨å¤‡ç”¨æ•°æ®æµ‹è¯• UI/UX
3. ç­‰å¾…åç«¯ä¿®å¤

### å¯¹äºåç«¯å¼€å‘è€…

âŒ **éœ€è¦ä¿®å¤åç«¯æ¥å£**

ä¼˜å…ˆçº§ï¼š
1. **ç«‹å³**ï¼šæŸ¥çœ‹äº‘æ‰˜ç®¡æ—¥å¿—ï¼Œæ‰¾åˆ°å…·ä½“é”™è¯¯åŸå› 
2. **ç«‹å³**ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„
3. **ç«‹å³**ï¼šå®ç° `/api/v1/categories` æ¥å£
4. **ä»Šå¤©**ï¼šå®ç° `/api/v1/recipes` æ¥å£
5. **æœ¬å‘¨**ï¼šå®ç°å…¶ä»–æ ¸å¿ƒæ¥å£

### è°ƒè¯•å»ºè®®

**åç«¯å¼€å‘è€…å¯ä»¥è¿™æ ·è°ƒè¯•**ï¼š

```typescript
// åœ¨æ¥å£ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—
@Get('categories')
async getCategories() {
  console.log('=== å¼€å§‹è·å–åˆ†ç±»åˆ—è¡¨ ===');
  
  try {
    console.log('1. è¿æ¥æ•°æ®åº“...');
    const connection = await this.db.getConnection();
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
    
    console.log('2. æŸ¥è¯¢åˆ†ç±»...');
    const categories = await this.db.query('SELECT * FROM categories');
    console.log(`âœ… æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${categories.length} æ¡åˆ†ç±»`);
    
    console.log('3. è¿”å›æ•°æ®...');
    return {
      code: 200,
      message: 'success',
      data: categories
    };
  } catch (error) {
    console.error('âŒ é”™è¯¯å‘ç”Ÿåœ¨ï¼š', error.message);
    console.error('âŒ é”™è¯¯å †æ ˆï¼š', error.stack);
    throw error;
  }
}
```

---

## ğŸ‰ æ€»ç»“

### å½“å‰æƒ…å†µ

| æ–¹é¢ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **å‰ç«¯** | âœ… å®Œæˆ | URL æ­£ç¡®ï¼Œå®¹é”™æœºåˆ¶æ­£å¸¸ |
| **ç½‘ç»œ** | âœ… æ­£å¸¸ | èƒ½è®¿é—®åç«¯æœåŠ¡ |
| **åç«¯** | âŒ 500 é”™è¯¯ | éœ€è¦æŸ¥çœ‹æ—¥å¿—è¯Šæ–­ |

### ä¸å½±å“ä½¿ç”¨

è™½ç„¶åç«¯æœ‰é”™è¯¯ï¼Œä½†ï¼š
- âœ… å‰ç«¯æœ‰å¤‡ç”¨æ•°æ®ï¼Œé¡µé¢æ­£å¸¸æ˜¾ç¤º
- âœ… æœ¬åœ°åŠŸèƒ½æ­£å¸¸ï¼ˆæ”¶è—ã€æœç´¢ã€è‰ç¨¿ç­‰ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒä¸å—ä¸¥é‡å½±å“

### ä¸‹ä¸€æ­¥

1. **æŸ¥çœ‹åç«¯æ—¥å¿—**ï¼ˆæœ€é‡è¦ï¼ï¼‰
2. **æ£€æŸ¥æ•°æ®åº“é…ç½®**
3. **ç¡®è®¤è¡¨ç»“æ„å­˜åœ¨**
4. **å¦‚éœ€å¸®åŠ©ï¼Œè”ç³»åç«¯å¼€å‘è€…**

---

**å‰ç«¯å·²ç»å°½åŠ›äº†ï¼ç°åœ¨æ˜¯åç«¯çš„å›åˆäº†ï¼** ğŸ’ª

