# 云托管重新部署指南

## 🎯 部署目的

重新部署云托管服务以使以下更新生效：
- ✅ 修复 api-proxy 云函数网络问题
- ✅ 修复前端响应处理 bug
- ✅ 实现微信头像自动上传到 COS 功能
- ✅ 应用新配置的 COS 环境变量

---

## 🔧 前提条件

确认已在**云托管控制台 → 服务配置 → 环境变量**中添加：

```bash
COS_SECRET_ID=你的SecretId
COS_SECRET_KEY=你的SecretKey
COS_BUCKET=yjsp-1367462091
COS_REGION=ap-nanjing
```

✅ 环境变量已配置完成

---

## 🚀 部署步骤

### 方法1：通过 Git 自动部署（推荐）

#### 1. 确认代码已推送
```bash
# 最新提交应该包含这些内容
git log -3 --oneline
```

应该看到：
- `security: 移除配置文档中的敏感密钥信息`
- `feat: 修复前端响应处理和实现微信头像自动上传COS`
- `fix: 修复api-proxy云函数网络和参数处理问题`

#### 2. 进入云托管控制台

访问：https://console.cloud.tencent.com/tcb/service

#### 3. 选择你的服务

找到服务：**yjsp-ytg-191595-4**（或你的服务名称）

#### 4. 点击"新建版本"

- 部署方式：选择 **代码库**
- 代码来源：选择你的 GitHub 仓库
- 分支：选择 **main**
- 触发方式：手动部署

#### 5. 配置构建设置

- 构建方式：**Dockerfile**
- Dockerfile 路径：`Dockerfile`（默认）
- 构建目录：`.`（根目录）

#### 6. 高级设置（重要！）

**资源配置**：
- CPU：0.5 核
- 内存：1GB
- 最小副本数：0
- 最大副本数：5

**环境变量**（确认已配置）：
- `DATABASE_HOST`
- `DATABASE_PORT`
- `DATABASE_NAME`
- `DATABASE_USER`
- `DATABASE_PASSWORD`
- `WECHAT_APPID`
- `WECHAT_SECRET`
- `JWT_SECRET`
- `COS_SECRET_ID` ⬅️ **新增**
- `COS_SECRET_KEY` ⬅️ **新增**
- `COS_BUCKET` ⬅️ **新增**
- `COS_REGION` ⬅️ **新增**

#### 7. 提交部署

点击**"开始部署"**

#### 8. 等待部署完成

部署时间：约 5-10 分钟

查看部署日志：
- ✅ 构建镜像成功
- ✅ 推送镜像成功
- ✅ 部署成功
- ✅ 服务运行中

---

### 方法2：本地构建镜像上传（备选）

如果 Git 自动部署失败，可以使用本地构建：

#### 1. 构建镜像
```bash
docker build -t cooktip-backend:latest .
```

#### 2. 标记镜像
```bash
docker tag cooktip-backend:latest \
  ccr.ccs.tencentyun.com/[你的命名空间]/cooktip-backend:latest
```

#### 3. 登录腾讯云容器镜像服务
```bash
docker login ccr.ccs.tencentyun.com
```

#### 4. 推送镜像
```bash
docker push ccr.ccs.tencentyun.com/[你的命名空间]/cooktip-backend:latest
```

#### 5. 在云托管控制台选择镜像部署

---

## ✅ 部署验证

### 1. 检查服务状态

在云托管控制台查看：
- 服务状态：**运行中**
- 实例数量：≥ 1
- CPU/内存使用：正常

### 2. 检查日志

点击**"日志"** 标签页，查看启动日志：

```
[Nest] Starting Nest application...
[Nest] DatabaseModule dependencies initialized
[Nest] AuthModule dependencies initialized
[Nest] Nest application successfully started
```

### 3. 测试健康检查

访问：`https://你的云托管地址/health`

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2025-10-18T11:30:00.000Z",
  "uptime": 123.456
}
```

### 4. 测试环境变量

访问：`https://你的云托管地址/health/env-check`

应该看到：
```json
{
  "database": "configured",
  "wechat": "configured",
  "jwt": "configured",
  "cos": "configured" ⬅️ 新增的COS配置
}
```

---

## 🔍 故障排查

### 问题1：部署失败 - 构建超时

**解决方案**：
1. 检查 Dockerfile 是否正确
2. 使用特定版本的基础镜像（已在 Dockerfile 中修复）
3. 清理 Docker 缓存重试

### 问题2：服务启动失败

**错误日志**：`Cannot connect to database`

**解决方案**：
1. 检查数据库环境变量是否正确
2. 检查数据库外网是否开启
3. 检查数据库 IP 白名单

### 问题3：COS 功能不工作

**错误日志**：`COS_SECRET_ID is not defined`

**解决方案**：
1. 确认环境变量已添加
2. **重新部署服务**（环境变量修改后必须重新部署）
3. 检查环境变量值是否正确

### 问题4：部署成功但接口 404

**原因**：路由配置问题

**解决方案**：
1. 检查 `main.ts` 中的全局前缀：`app.setGlobalPrefix('api/v1')`
2. 访问：`https://你的地址/api/v1/health`

---

## 📊 部署后检查清单

- [ ] 服务状态显示"运行中"
- [ ] 健康检查接口返回正常
- [ ] 环境变量检查接口显示 COS 已配置
- [ ] 查看日志无错误信息
- [ ] CPU/内存使用正常

全部打勾后，进入下一步：**测试微信头像上传功能** ✨

---

## 📝 注意事项

1. **环境变量修改后必须重新部署**
2. **部署会短暂中断服务**（约 1-2 分钟）
3. **保留旧版本**以便快速回滚
4. **部署前先测试构建**（本地 `docker build`）

---

## 🎉 部署完成！

部署成功后，你的云托管服务已更新为最新版本，包括：
- ✅ 微信头像自动上传 COS 功能
- ✅ 修复的 API 响应处理
- ✅ 优化的网络配置

下一步：查看**测试指南**，测试所有新功能！

