# API 测试建议

## 当前问题诊断

根据测试结果，出现了 `Failed to fetch` 错误，这是 **Vercel 安全检查点**被触发，不是后端服务问题。

---

## 🎯 推荐测试方案

### 方案1：等待后浏览器测试（最简单）

1. **等待 10-30 分钟**
   - Vercel 安全检查会自动解除
   - 这段时间可以做其他工作

2. **重新打开测试工具**
   - 刷新页面
   - 点击"开始全面测试"

3. **预期结果**
   - ✅ 菜谱列表 - 200 成功
   - ✅ 搜索 - 200 成功
   - ✅ 分类列表 - 200 成功
   - ⚠️ 微信登录 - 401（测试code无效，正常）
   - ⚠️ 需要认证的接口 - 401（未登录，正常）

---

### 方案2：使用 PowerShell 命令行测试（绕过浏览器限制）

创建测试脚本避免浏览器CORS和安全检查：

```powershell
# 测试菜谱列表
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/recipes?page=1&limit=5" -Method Get

# 测试搜索
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/search?keyword=鸡" -Method Get

# 测试分类
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/categories" -Method Get

# 测试微信登录
$body = @{ code = "test-code" } | ConvertTo-Json
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/auth/wechat" -Method Post -Body $body -ContentType "application/json"
```

---

### 方案3：在微信小程序中直接测试（真实环境）

**这是最准确的测试方式**，因为：
- 不会触发 Vercel 安全检查
- 真实的使用场景
- 可以测试真实的微信 code

#### 步骤：
1. 在微信小程序中调用登录接口
2. 使用真实的 `wx.login()` 获取 code
3. 发送到后端验证

---

## 📊 测试结果判断标准

### ✅ 正常响应（不是错误）

| 接口 | 状态码 | 说明 |
|------|--------|------|
| 微信登录 | 401 | 测试code无效，**这是正常的** |
| 用户信息 | 401 | 未登录，**这是正常的** |
| 收藏列表 | 401 | 未登录，**这是正常的** |

### ✅ 成功响应

| 接口 | 状态码 | 说明 |
|------|--------|------|
| 菜谱列表 | 200 | 返回菜谱数据 |
| 搜索 | 200 | 返回搜索结果 |
| 分类列表 | 200 | 返回分类数据 |

### ❌ 真正的错误

| 错误 | 原因 | 解决 |
|------|------|------|
| Failed to fetch | Vercel安全检查 | 等待10-30分钟 |
| 404 | 接口不存在 | 检查部署 |
| 500 | 服务器错误 | 查看日志 |

---

## 🔧 快速验证脚本

保存为 `quick-test.ps1`：

```powershell
Write-Host "`n========== CookTip API 快速测试 ==========`n" -ForegroundColor Cyan

# 1. 测试菜谱列表
Write-Host "1. 测试菜谱列表..." -ForegroundColor Yellow
try {
    $recipes = Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/recipes?limit=3" -Method Get
    Write-Host "✅ 成功! 获取到 $($recipes.data.total) 条菜谱" -ForegroundColor Green
} catch {
    Write-Host "❌ 失败: $($_.Exception.Message)" -ForegroundColor Red
}

Start-Sleep -Seconds 1

# 2. 测试搜索
Write-Host "`n2. 测试搜索..." -ForegroundColor Yellow
try {
    $search = Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/search?keyword=鸡" -Method Get
    Write-Host "✅ 成功! 搜索到 $($search.data.total) 个结果" -ForegroundColor Green
} catch {
    Write-Host "❌ 失败: $($_.Exception.Message)" -ForegroundColor Red
}

Start-Sleep -Seconds 1

# 3. 测试分类
Write-Host "`n3. 测试分类列表..." -ForegroundColor Yellow
try {
    $categories = Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/categories" -Method Get
    Write-Host "✅ 成功! 获取到 $($categories.data.categories.Count) 个分类" -ForegroundColor Green
} catch {
    Write-Host "❌ 失败: $($_.Exception.Message)" -ForegroundColor Red
}

Start-Sleep -Seconds 1

# 4. 测试微信登录（预期401）
Write-Host "`n4. 测试微信登录..." -ForegroundColor Yellow
try {
    $body = @{ code = "test-code" } | ConvertTo-Json
    $login = Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/auth/wechat" -Method Post -Body $body -ContentType "application/json"
    Write-Host "✅ 返回: $($login.message)" -ForegroundColor Green
} catch {
    $statusCode = $_.Exception.Response.StatusCode.value__
    if ($statusCode -eq 401) {
        Write-Host "✅ 正常! 返回 401（测试code无效）" -ForegroundColor Green
    } else {
        Write-Host "❌ 失败: $($_.Exception.Message)" -ForegroundColor Red
    }
}

Write-Host "`n========== 测试完成 ==========`n" -ForegroundColor Cyan
```

---

## 💡 重要提示

### 关于 "Failed to fetch"

这个错误**不是后端服务问题**，而是：

1. **浏览器安全策略**
   - Vercel 检测到频繁请求
   - 触发了防护机制
   - 需要等待自动解除

2. **解决方法**
   - ✅ 等待 10-30 分钟
   - ✅ 使用 PowerShell 测试
   - ✅ 在微信小程序中测试
   - ❌ 不要在浏览器中频繁测试

### 关于 401 错误

**401 不是错误**，而是正常的业务逻辑：

- 微信登录返回 401 = 测试 code 无效（预期）
- 用户信息返回 401 = 未登录（预期）
- 收藏列表返回 401 = 未登录（预期）

---

## 🎯 下一步行动

### 立即可做：
1. ✅ 等待 30 分钟
2. ✅ 运行 PowerShell 测试脚本
3. ✅ 在微信小程序中测试真实登录

### 验证后端正常：
如果 PowerShell 测试全部通过，说明：
- ✅ 后端服务完全正常
- ✅ 所有接口都已部署
- ✅ 数据库连接正常
- ✅ 环境变量配置正确

### 最终测试：
在微信小程序中：
1. 使用 `wx.login()` 获取真实 code
2. 调用登录接口
3. 验证 token 和用户信息
4. 测试其他需要认证的接口

---

**结论：您的后端服务没有问题，只是浏览器测试触发了 Vercel 安全检查。请使用上述其他方式测试。** ✅

