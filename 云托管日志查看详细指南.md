# 🔍 云托管日志查看详细指南（诊断 500 错误）

**目的**: 查看云托管的详细错误日志，定位搜索功能 500 错误的根本原因

---

## 📋 准备工作

已添加的增强功能（Commit: `ed9231e`）：

1. ✅ **全局异常过滤器** (`AllExceptionsFilter`)
   - 捕获所有未处理的异常
   - 记录完整的错误堆栈
   - 返回详细的错误信息

2. ✅ **日志拦截器** (`LoggingInterceptor`)
   - 记录每个请求的详细信息
   - 记录响应时间
   - 记录错误详情

3. ✅ **增强的日志级别**
   - `error`, `warn`, `log`, `debug`, `verbose`
   - 完整的堆栈跟踪

---

## 🚀 第一步：等待部署完成

### 1. 检查部署状态

1. **登录腾讯云控制台**
   - 访问: https://console.cloud.tencent.com/

2. **进入云托管**
   - 左侧菜单: **云产品** → **Serverless** → **云托管**

3. **查看服务状态**
   - 选择你的环境（如 `yjsp-ytg`）
   - 查看服务列表
   - 找到 `CookTip-Backend` 服务

4. **确认部署状态**
   - ✅ **运行中** - 绿色，可以继续
   - ⏳ **部署中** - 黄色，等待 3-5 分钟
   - ❌ **失败** - 红色，查看部署日志

---

## 📊 第二步：查看实时日志

### 方法 A：通过控制台查看（推荐）

#### 1. 进入日志查询

1. **点击服务名称**
   - 进入 `CookTip-Backend` 服务详情

2. **点击"日志"标签页**
   - 在顶部导航栏找到"日志"

3. **选择日志类型**
   - **应用日志**: 查看代码输出的 console.log/error
   - **访问日志**: 查看 HTTP 请求记录

#### 2. 筛选错误日志

**关键搜索词**:
```
[SearchService] Search recipes error
[SearchController] Search error
AllExceptionsFilter
LoggingInterceptor
TypeError
Error:
```

**筛选条件**:
- **时间范围**: 最近 1 小时
- **日志级别**: ERROR
- **关键词**: 上述任一搜索词

#### 3. 查找具体错误信息

**预期看到的日志格式**:

```
[LoggingInterceptor] → GET /api/v1/search/recipes?keyword=鸡
[SearchController] Received request: {keyword: "鸡", page: 1, limit: 10}
[SearchService] Search recipes error: TypeError: Cannot read property 'tags' of undefined
    at SearchService.searchRecipes (/app/dist/modules/search/search.service.js:75:28)
    at SearchController.searchRecipes (/app/dist/modules/search/search.controller.js:45:15)
    ...
[AllExceptionsFilter] [GET] /api/v1/search/recipes?keyword=鸡 - Status: 500
```

---

### 方法 B：通过 CLI 查看（高级）

如果控制台不可用，可以使用腾讯云 CLI：

```bash
# 安装 CLI
npm install -g @cloudbase/cli

# 登录
tcb login

# 查看日志
tcb fn log <函数名> --limit 100
```

---

## 🔎 第三步：分析错误日志

### 常见错误模式

#### 1. **TypeORM 查询错误**

```
QueryFailedError: ER_BAD_FIELD_ERROR: Unknown column 'recipe.tags' in 'field list'
```

**原因**: 数据库表结构与代码不匹配

**解决**: 检查数据库表是否有 `tags` 列

---

#### 2. **JSON 序列化错误**

```
TypeError: Cannot convert undefined or null to object
  at Object.keys (<anonymous>)
  at SearchService.searchRecipes
```

**原因**: JSON 字段包含无效数据

**解决**: 已通过显式 select 排除 JSON 字段

---

#### 3. **数据库连接错误**

```
Error: connect ETIMEDOUT
  at TCPConnectWrap.afterConnect
```

**原因**: 数据库连接超时

**解决**: 检查数据库网络配置

---

#### 4. **空值引用错误**

```
TypeError: Cannot read property 'nickname' of null
  at SearchService.searchRecipes
```

**原因**: `recipe.user` 为 null

**解决**: 已添加空值检查

---

## 📸 第四步：截图并反馈

### 需要提供的信息

如果还是 500 错误，请截图以下内容：

1. **完整的错误堆栈**
   ```
   [AllExceptionsFilter] [GET] /api/v1/search/recipes?keyword=鸡 - Status: 500
   错误详情: ...
   堆栈跟踪: ...
   ```

2. **请求参数**
   ```
   [SearchController] Received request: {
     keyword: "鸡",
     page: 1,
     limit: 10
   }
   ```

3. **部署状态**
   - 服务状态: 运行中 / 部署中 / 失败
   - 最新部署时间
   - Commit ID

---

## 🛠️ 常见问题排查

### Q1: 找不到日志？

**A**: 确认日志查询的时间范围
- 扩大时间范围到"最近 24 小时"
- 检查服务是否正在运行
- 尝试刷新页面

### Q2: 日志太多，看不过来？

**A**: 使用关键词过滤
```
错误关键词: error OR Error OR Exception OR failed
搜索关键词: SearchService OR SearchController
```

### Q3: 部署一直处于"部署中"状态？

**A**: 可能的原因
1. Docker 镜像构建失败
2. 资源不足
3. 网络问题

**解决**: 查看部署日志，检查构建失败原因

---

## 🎯 测试新的日志功能

### 测试端点

访问以下测试端点确认服务正常：

```
GET https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search/test
```

**预期响应**:
```json
{
  "code": 200,
  "message": "Search service is running",
  "data": {
    "timestamp": "2025-10-30T...",
    "service": "healthy"
  }
}
```

### 测试搜索

```
GET https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search/recipes?keyword=鸡
```

**检查日志**:
```
[LoggingInterceptor] → GET /api/v1/search/recipes?keyword=鸡
[SearchController] Received request: {...}
[SearchService] Search recipes...
[LoggingInterceptor] ← GET /api/v1/search/recipes 200 - 150ms
```

---

## 📋 操作清单

- [ ] 1. 等待云托管部署完成（3-5 分钟）
- [ ] 2. 进入云托管控制台
- [ ] 3. 打开日志查询页面
- [ ] 4. 筛选错误日志（关键词: `SearchService`, `error`）
- [ ] 5. 测试搜索端点
- [ ] 6. 截图完整的错误信息
- [ ] 7. 反馈错误日志

---

## 🔄 下一步

**如果仍然 500 错误**，请提供：

1. 📸 云托管日志截图（完整的错误堆栈）
2. 🖥️ 浏览器控制台错误
3. 🔍 搜索关键词
4. ⏰ 测试时间

我会根据详细的日志信息继续深度调试！

---

**等待 3-5 分钟后，请按照上述步骤查看日志！** 🔍

