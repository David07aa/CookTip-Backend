# 🌐 域名配置完整方案

**问题**：微信小程序域名白名单限制  
**更新**：2025-10-16  
**重要发现**：downloadFile 可以使用云托管默认域名 ✅

---

## 📊 域名限制详情

### 微信小程序域名白名单规则

| 域名类型 | 云托管默认域名 | 对象存储域名 | 自定义域名 | 云开发域名 |
|---------|--------------|-------------|-----------|-----------|
| **request** | ❌ 不可用 | ❌ 不可用 | ✅ 可用 | ✅ 可用 |
| **uploadFile** | ❌ 不可用 | ✅ 可用 | ✅ 可用 | ✅ 可用 |
| **downloadFile** | ✅ **可用** | ✅ 可用 | ✅ 可用 | ✅ 可用 |

**关键发现**：
- ❌ API 请求（request）**无法**使用云托管默认域名
- ✅ 文件下载（downloadFile）**可以**使用云托管默认域名

---

## 🎯 可用的域名配置

### 当前后端服务地址

| 地址类型 | 域名 | 用途 | 可用性 |
|---------|------|------|--------|
| **公网测试地址** | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com` | API 请求 | ❌ 不可用于小程序 |
| **内网地址** | `rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com` | 内部通信 | 仅云托管内部 |
| **对象存储** | `https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com` | 图片下载 | ✅ 可配置 |

### 可配置的域名白名单

#### ✅ 方案 1：使用对象存储 + 云函数/自定义域名

**downloadFile 合法域名**（必须配置）：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

**request 合法域名**（二选一）：
```
选项 A：使用云开发（无需域名，立即可用）
选项 B：使用自定义域名（如 https://api.cooktip.com）
```

---

## 📋 完整解决方案对比

### 方案 A：云函数代理（推荐，立即可用）⭐

**配置时间**：30 分钟  
**成本**：免费  
**适用场景**：快速上线、测试、MVP

#### 工作原理
```
小程序 → 云开发 HTTP API → 云托管后端（内网）
        (自动在白名单)      (无需域名)
```

#### 域名配置
```
downloadFile 合法域名：
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

#### 优点
- ✅ **无需购买域名**
- ✅ **无需备案**
- ✅ **30 分钟配置完成**
- ✅ 可以真机预览和发布
- ✅ 微信官方支持

#### 缺点
- ⚠️ 免费版有请求限制（10 万次/月）
- ⚠️ 多一层转发，性能略低
- ⚠️ 云函数有超时限制（20 秒）

#### 配置步骤
详见：`临时解决方案-无需自定义域名.md`

---

### 方案 B：自定义域名（正式生产环境）⭐⭐⭐

**配置时间**：1-20 天（含备案）  
**成本**：50-100 元/年  
**适用场景**：正式生产环境、长期运营

#### 工作原理
```
小程序 → 自定义域名 → 云托管后端
        (api.cooktip.com)
```

#### 域名配置
```
request 合法域名：
https://api.cooktip.com

uploadFile 合法域名：
https://api.cooktip.com

downloadFile 合法域名：
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://api.cooktip.com
```

#### 优点
- ✅ **专业稳定**
- ✅ 性能最优
- ✅ 完全控制
- ✅ 适合生产环境

#### 缺点
- ❌ 需要购买域名
- ❌ 需要 ICP 备案（7-20 天）
- ❌ 有一定成本

#### 配置步骤
详见：`自定义域名配置指南.md`

---

### 方案 C：开发者工具调试（仅开发）

**配置时间**：0 分钟  
**成本**：免费  
**适用场景**：仅本地开发调试

#### 配置方法
在微信开发者工具中：
1. `详情` → `本地设置`
2. 勾选 "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
3. 直接使用云托管公网地址

#### 优点
- ✅ 无需任何配置
- ✅ 立即可用

#### 缺点
- ❌ 仅限开发工具
- ❌ 无法真机预览
- ❌ 无法发布

---

## 🚀 推荐实施路径

### 阶段 1：立即上线（使用方案 A）

**目标**：快速让小程序可用  
**时间**：30 分钟

1. ✅ 开通云开发环境（5 分钟）
2. ✅ 创建云函数代理（10 分钟）
3. ✅ 前端改造调用云函数（10 分钟）
4. ✅ 配置 downloadFile 域名白名单（5 分钟）

**域名白名单配置**：
```
downloadFile 合法域名：
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

**结果**：
- ✅ 小程序可以正常使用
- ✅ 可以真机预览和发布
- ✅ API 通过云函数访问
- ✅ 图片可以正常显示

---

### 阶段 2：准备生产环境（并行进行）

**目标**：为正式运营做准备  
**时间**：1-20 天

1. 📋 购买域名（如 `cooktip.com`）
2. 📋 提交 ICP 备案（7-20 天）
3. 📋 配置自定义域名
4. 📋 测试验证

---

### 阶段 3：切换到生产方案（备案完成后）

**目标**：使用专业的自定义域名  
**时间**：30 分钟

1. ✅ 在云托管添加自定义域名
2. ✅ 配置 DNS 解析
3. ✅ 等待生效
4. ✅ 更新前端配置
5. ✅ 更新域名白名单
6. ✅ 测试验证

**域名白名单配置**：
```
request 合法域名：
https://api.cooktip.com

uploadFile 合法域名：
https://api.cooktip.com

downloadFile 合法域名：
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

---

## 📝 当前可立即配置的域名

### 微信公众平台 → 服务器域名

登录：https://mp.weixin.qq.com  
路径：`开发` → `开发管理` → `开发设置` → `服务器域名`

#### 现在就可以配置（无需等待）

**downloadFile 合法域名**：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

**作用**：
- ✅ 对象存储的图片可以正常下载
- ✅ 通过云托管的文件可以正常下载

**注意**：
- request 域名暂时无法配置（需要云函数代理或自定义域名）
- uploadFile 域名建议通过云函数处理

---

## 🔍 技术细节说明

### 为什么 downloadFile 可以使用云托管域名？

根据微信官方规定：
- request 域名：用于 API 数据请求，安全要求高
- uploadFile 域名：用于文件上传，安全要求高
- downloadFile 域名：用于文件下载，安全要求相对较低

因此：
- ✅ downloadFile 支持更多类型的域名
- ❌ request/uploadFile 只支持已备案的自定义域名

### 云函数代理的性能影响

**延迟对比**：

| 方案 | 平均延迟 | 说明 |
|------|---------|------|
| 直连自定义域名 | 50-100ms | 最快 |
| 云函数代理 | 100-200ms | 多一次转发 |
| 开发工具直连 | 50-100ms | 仅开发环境 |

**影响分析**：
- 增加约 50-100ms 延迟
- 对于一般应用可接受
- 用户体验影响不大

---

## 📊 方案选择决策树

```
┌─ 需要立即上线？
│   ├─ 是 → 使用方案 A（云函数代理）
│   │      └─ 并行准备方案 B
│   └─ 否 → 继续
│
├─ 有已备案的域名？
│   ├─ 是 → 使用方案 B（自定义域名）
│   └─ 否 → 继续
│
├─ 愿意等待备案？
│   ├─ 是 → 购买域名 + 备案 → 方案 B
│   └─ 否 → 使用方案 A（云函数代理）
│
└─ 仅本地开发？
    └─ 是 → 使用方案 C（开发工具）
```

---

## ⚠️ 重要提醒

### 关于域名白名单

1. **每月只能修改 5 次**
   - 请谨慎配置
   - 建议一次性配置完整

2. **配置后需要 5-10 分钟生效**
   - 不要着急
   - 可以先配置 downloadFile

3. **必须使用 HTTPS**
   - HTTP 不被支持
   - 确保域名包含 `https://`

---

## ✅ 立即行动清单

### 现在就可以做（5 分钟）

- [ ] 登录微信公众平台
- [ ] 配置 downloadFile 域名白名单
- [ ] 添加对象存储域名
- [ ] 添加云托管域名（用于 download）

**域名列表**：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

### 选择 API 访问方案

**选项 1：使用云函数代理（推荐）**
- 查看：`临时解决方案-无需自定义域名.md`
- 时间：30 分钟
- 立即可用

**选项 2：配置自定义域名**
- 查看：`自定义域名配置指南.md`
- 时间：1-20 天
- 适合生产环境

---

## 📞 需要帮助？

### 相关文档

| 文档名称 | 用途 |
|---------|------|
| `临时解决方案-无需自定义域名.md` | 云函数代理方案详细步骤 |
| `自定义域名配置指南.md` | 自定义域名配置详细步骤 |
| `域名配置完整方案.md` | 本文档，方案对比 |

### 快速决策

- **想立即上线**：选择云函数代理方案
- **正式生产**：选择自定义域名方案
- **仅本地开发**：使用开发者工具跳过验证

---

**总结**：downloadFile 可以使用云托管域名，先配置上；API 请求需要云函数代理或自定义域名。

**更新时间**：2025-10-16

