# CookTip 项目架构文档

<div align="center">
  <h2>🍳 美食菜谱小程序 - 完整技术架构</h2>
  <p>微信小程序 + NestJS后端 + 云托管 + 对象存储</p>
</div>

---

## 📑 目录

- [项目概述](#项目概述)
- [技术架构](#技术架构)
- [技术栈](#技术栈)
- [目录结构](#目录结构)
- [核心功能](#核心功能)
- [数据库设计](#数据库设计)
- [API文档](#api文档)
- [部署架构](#部署架构)
- [开发指南](#开发指南)
- [文档索引](#文档索引)

---

## 项目概述

### 基本信息

| 项目 | 信息 |
|------|------|
| 项目名称 | CookTip - 美食菜谱小程序 |
| 前端平台 | 微信小程序 |
| 后端框架 | Nest.js (TypeScript) |
| 数据库 | MySQL 8.0 (微信云托管CynosDB) |
| 部署平台 | 微信云托管 (Docker容器) |
| 对象存储 | 腾讯云COS (南京) |
| 当前版本 | v1.0.0 |

### 项目特点

- ✅ **技术栈统一**：前后端均使用TypeScript，降低学习成本
- ✅ **云原生架构**：基于微信云托管，容器化部署
- ✅ **高性能**：内网访问数据库，延迟<1ms
- ✅ **低成本**：云托管按量计费，对象存储独立
- ✅ **易扩展**：模块化设计，易于功能扩展

---

## 技术架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      微信小程序端                              │
│                   (TypeScript + WXML)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │  首页/搜索  │  │  食谱详情   │  │  个人中心   │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     云函数 API网关                            │
│              (api-proxy - 请求转发)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  微信云托管 (后端服务)                         │
│                                                              │
│  ┌───────────────────────────────────────────────────────┐ │
│  │              NestJS 应用 (TypeScript)                   │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │  Controller Layer (API端点)                       │ │ │
│  │  │  • AuthController      • RecipeController       │ │ │
│  │  │  • UserController      • CommentController      │ │ │
│  │  │  • CategoryController  • SearchController       │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  │                                                         │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │  Service Layer (业务逻辑)                          │ │ │
│  │  │  • JWT认证  • 微信登录  • 数据验证  • 业务逻辑  │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  │                                                         │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │  Repository Layer (数据访问)                       │ │ │
│  │  │  TypeORM - Entity - MySQL Driver                │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  中间件/守卫/拦截器                                      │ │
│  │  • JwtAuthGuard  • TransformInterceptor                │ │
│  │  • ThrottlerGuard  • HttpExceptionFilter             │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
            │                                   │
            ↓                                   ↓
┌──────────────────────┐          ┌──────────────────────┐
│  微信云托管 CynosDB   │          │   腾讯云 COS         │
│  (MySQL 8.0)         │          │   (对象存储-南京)     │
│                      │          │                      │
│  • users (用户)      │          │  • 食谱图片           │
│  • recipes (食谱)    │          │  • 用户头像           │
│  • categories (分类) │          │  • 步骤图片           │
│  • comments (评论)   │          │  • 视频封面           │
│  • favorites (收藏)  │          │                      │
│  • likes (点赞)      │          │  域名:               │
│  • shopping_lists    │          │  yjsp-1367462091    │
│                      │          │  .cos.ap-nanjing    │
│  内网: 10.32.104.73  │          │  .myqcloud.com      │
└──────────────────────┘          └──────────────────────┘
```

### 请求流程

#### 小程序API请求流程
```
1. 小程序 → wx.cloud.callFunction('api-proxy')
2. 云函数 → 转发请求到云托管后端
3. 云托管 → NestJS处理业务逻辑
4. NestJS → 查询云托管数据库(内网)
5. 返回响应：数据库 → NestJS → 云函数 → 小程序
```

#### 图片访问流程
```
1. 小程序 → <image src="https://yjsp-1367462091.cos..." />
2. 直接访问腾讯云COS对象存储
3. COS → 返回图片资源
```

---

## 技术栈

### 后端技术栈

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| **核心框架** | NestJS | 10.x | 企业级Node.js框架 |
| **开发语言** | TypeScript | 5.x | 类型安全的JavaScript超集 |
| **数据库** | MySQL | 8.0 | 关系型数据库 |
| **ORM** | TypeORM | 0.3.x | 对象关系映射 |
| **身份认证** | JWT | - | JSON Web Token |
| **接口文档** | Swagger | - | 自动生成API文档 |
| **HTTP客户端** | Axios | 1.x | Promise based HTTP client |
| **环境配置** | dotenv | - | 环境变量管理 |
| **容器化** | Docker | - | 容器化部署 |
| **限流** | @nestjs/throttler | - | 请求频率限制 |
| **验证** | class-validator | - | 数据验证 |
| **转换** | class-transformer | - | 对象转换 |

### 前端技术栈 (小程序)

| 类别 | 技术 | 说明 |
|------|------|------|
| **开发语言** | JavaScript/TypeScript | 小程序开发语言 |
| **视图层** | WXML + WXSS | 小程序标记语言 |
| **云开发** | 云函数 | API网关代理 |
| **状态管理** | 本地存储 | 缓存用户信息 |

### 基础设施

| 服务 | 提供商 | 说明 |
|------|--------|------|
| **云托管** | 腾讯云微信云托管 | Docker容器托管 |
| **数据库** | 微信云托管CynosDB | MySQL 8.0兼容 |
| **对象存储** | 腾讯云COS | 图片/视频存储 |
| **云函数** | 微信云开发 | API网关代理 |

---

## 目录结构

### 后端项目结构

```
CookTip-Backend/
├── src/                           # 源代码目录
│   ├── modules/                   # 业务模块
│   │   ├── auth/                 # 认证模块
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.module.ts
│   │   │   ├── jwt.strategy.ts
│   │   │   └── dto/
│   │   ├── user/                 # 用户模块
│   │   │   ├── user.controller.ts
│   │   │   ├── user.service.ts
│   │   │   ├── user.module.ts
│   │   │   └── dto/
│   │   ├── recipe/               # 食谱模块
│   │   │   ├── recipe.controller.ts
│   │   │   ├── recipe.service.ts
│   │   │   ├── recipe.module.ts
│   │   │   └── dto/
│   │   ├── category/             # 分类模块
│   │   ├── comment/              # 评论模块
│   │   ├── favorite/             # 收藏模块
│   │   ├── search/               # 搜索模块
│   │   ├── stats/                # 统计模块
│   │   ├── upload/               # 上传模块
│   │   └── shopping-list/        # 购物清单模块
│   ├── entities/                 # 数据实体
│   │   ├── user.entity.ts
│   │   ├── recipe.entity.ts
│   │   ├── category.entity.ts
│   │   ├── comment.entity.ts
│   │   ├── favorite.entity.ts
│   │   ├── like.entity.ts
│   │   └── shopping-list.entity.ts
│   ├── common/                   # 公共模块
│   │   ├── decorators/           # 装饰器
│   │   ├── filters/              # 异常过滤器
│   │   ├── guards/               # 守卫
│   │   └── interceptors/         # 拦截器
│   ├── app.module.ts             # 根模块
│   ├── main.ts                   # 应用入口
│   └── health.controller.ts      # 健康检查
├── database/                      # 数据库脚本
│   ├── init.sql                  # 初始化脚本
│   └── seed.sql                  # 测试数据
├── scripts/                       # 工具脚本
│   ├── check-database-images.js  # 检查数据库图片
│   ├── update-image-urls.js      # 更新图片URL
│   └── check-and-update-image-urls.sql
├── cloudfunctions/                # 云函数
│   └── api-proxy/                # API网关代理
│       ├── index.js
│       ├── package.json
│       ├── config.json
│       └── README.md
├── miniprogram-utils/             # 小程序工具
│   ├── cdn.js                    # CDN配置
│   ├── cloudRequest.js           # 云函数请求
│   ├── api.js                    # API封装
│   └── 使用示例.md
├── dist/                          # 编译输出
├── node_modules/                  # 依赖包
├── Dockerfile                     # Docker配置
├── docker-compose.yml             # Docker Compose配置
├── package.json                   # 项目配置
├── tsconfig.json                  # TypeScript配置
├── nest-cli.json                  # NestJS CLI配置
├── .env.example                   # 环境变量示例
├── cloudbase-env-vars.json        # 云托管环境变量
├── cloudbaserc.json               # 云托管配置
└── README.md                      # 项目说明
```

### 文档目录结构

```
docs/
├── 项目架构文档.md               # 本文档
├── README.md                     # 项目总览
├── 后端API开发文档.md            # API接口文档
├── 后端技术选型方案.md           # 技术选型
├── 前端对接文档-新版.md          # 前端对接
├── 云函数部署完整指南.md         # 云函数部署
├── 云函数API网关-README.md       # API网关说明
└── 云函数快速参考.md             # 云函数参考
```

---

## 核心功能

### 1. 用户认证与授权

| 功能 | 端点 | 说明 |
|------|------|------|
| 微信登录 | `POST /auth/login/wechat` | 通过微信code换取session |
| 刷新Token | `POST /auth/refresh` | 刷新JWT token |
| 退出登录 | `POST /auth/logout` | 退出当前账户 |

**技术实现**：
- 微信小程序code换取session_key和openid
- 生成JWT token
- Token存储在小程序Storage
- 请求携带Authorization header

### 2. 食谱管理

| 功能 | 端点 | 说明 |
|------|------|------|
| 获取食谱列表 | `GET /recipes` | 分页、排序、筛选 |
| 获取食谱详情 | `GET /recipes/:id` | 含完整信息 |
| 创建食谱 | `POST /recipes` | 需要认证 |
| 更新食谱 | `PATCH /recipes/:id` | 需要认证 |
| 删除食谱 | `DELETE /recipes/:id` | 需要认证 |
| 点赞/取消 | `POST /recipes/:id/like` | 需要认证 |
| 收藏/取消 | `POST /recipes/:id/favorite` | 需要认证 |
| 增加浏览量 | `POST /recipes/:id/view` | 无需认证 |

**核心字段**：
- 基本信息：标题、描述、分类
- 烹饪信息：难度、时间、份数、口味
- 详细内容：食材列表、步骤、小贴士
- 统计信息：点赞数、收藏数、浏览数、评论数

### 3. 分类管理

| 功能 | 端点 | 说明 |
|------|------|------|
| 获取分类列表 | `GET /categories` | 所有分类 |
| 获取分类详情 | `GET /categories/:id` | 含食谱数量 |

**预设分类**：
- 主食（米饭、面条、饺子等）
- 炒菜（家常炒菜）
- 凉拌（凉菜）
- 烘焙甜点
- 炖菜（炖煮类）
- 汤（汤类）

### 4. 评论系统

| 功能 | 端点 | 说明 |
|------|------|------|
| 获取评论列表 | `GET /comments` | 支持筛选食谱 |
| 创建评论 | `POST /comments` | 需要认证 |
| 删除评论 | `DELETE /comments/:id` | 需要认证 |

### 5. 收藏功能

| 功能 | 端点 | 说明 |
|------|------|------|
| 获取收藏列表 | `GET /favorites` | 当前用户收藏 |
| 添加收藏 | `POST /favorites` | 需要认证 |
| 取消收藏 | `DELETE /favorites/:id` | 需要认证 |

### 6. 搜索功能

| 功能 | 端点 | 说明 |
|------|------|------|
| 搜索食谱 | `GET /search/recipes` | 关键词搜索 |

**搜索字段**：标题、描述、食材、标签

### 7. 统计分析

| 功能 | 端点 | 说明 |
|------|------|------|
| 获取统计信息 | `GET /stats` | 概览统计 |

**统计内容**：
- 总食谱数
- 总用户数
- 今日新增食谱
- 热门食谱Top 10

### 8. 购物清单

| 功能 | 端点 | 说明 |
|------|------|------|
| 获取购物清单 | `GET /shopping-list` | 当前用户清单 |
| 添加食材 | `POST /shopping-list` | 需要认证 |
| 更新状态 | `PATCH /shopping-list/:id` | 标记已购买 |
| 删除食材 | `DELETE /shopping-list/:id` | 需要认证 |

### 9. 文件上传

| 功能 | 端点 | 说明 |
|------|------|------|
| 上传单张图片 | `POST /upload/image` | 封面、头像等 |
| 批量上传图片 | `POST /upload/images` | 步骤图等 |

**上传类型**：
- cover: 封面图
- step: 步骤图
- comment: 评论图
- avatar: 头像

---

## 数据库设计

### ER图

```
┌────────────┐        ┌────────────┐        ┌────────────┐
│   users    │◄───────│  recipes   │───────►│ categories │
│            │        │            │        │            │
│ • id       │        │ • id       │        │ • id       │
│ • openid   │        │ • user_id  │        │ • name     │
│ • nickname │        │ • category │        │ • icon     │
│ • avatar   │        │ • title    │        │ • count    │
└────────────┘        │ • cover    │        └────────────┘
      │               │ • content  │
      │               └────────────┘
      │                     │
      │                     │
      └──────┬──────────────┴──────────┬───────────┐
             │                         │           │
      ┌──────▼─────┐           ┌──────▼─────┐  ┌──▼─────────┐
      │  comments  │           │ favorites  │  │   likes    │
      │            │           │            │  │            │
      │ • id       │           │ • id       │  │ • id       │
      │ • user_id  │           │ • user_id  │  │ • user_id  │
      │ • recipe   │           │ • recipe   │  │ • target   │
      │ • content  │           └────────────┘  └────────────┘
      └────────────┘
```

### 主要数据表

#### 1. users - 用户表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT PRIMARY KEY | 用户ID |
| openid | VARCHAR(100) UNIQUE | 微信唯一标识 |
| nickname | VARCHAR(50) | 昵称 |
| avatar | VARCHAR(255) | 头像URL |
| bio | TEXT | 个人简介 |
| recipe_count | INT | 发布食谱数 |
| favorite_count | INT | 收藏数 |
| follower_count | INT | 粉丝数 |
| following_count | INT | 关注数 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 2. recipes - 食谱表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT PRIMARY KEY | 食谱ID |
| user_id | INT | 作者ID |
| category_id | INT | 分类ID |
| title | VARCHAR(100) | 标题 |
| cover_image | VARCHAR(255) | 封面图 |
| description | TEXT | 描述 |
| difficulty | VARCHAR(20) | 难度 |
| cook_time | INT | 烹饪时间(分钟) |
| servings | INT | 份数 |
| taste | VARCHAR(50) | 口味 |
| ingredients | JSON | 食材列表 |
| steps | JSON | 步骤列表 |
| tips | TEXT | 小贴士 |
| tags | JSON | 标签 |
| likes | INT | 点赞数 |
| favorites | INT | 收藏数 |
| views | INT | 浏览数 |
| comments | INT | 评论数 |
| status | VARCHAR(20) | 状态 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 3. categories - 分类表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT PRIMARY KEY | 分类ID |
| name | VARCHAR(50) | 分类名 |
| icon | VARCHAR(255) | 图标 |
| description | TEXT | 描述 |
| recipe_count | INT | 食谱数量 |
| sort_order | INT | 排序 |

#### 4. comments - 评论表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT PRIMARY KEY | 评论ID |
| recipe_id | INT | 食谱ID |
| user_id | INT | 用户ID |
| content | TEXT | 评论内容 |
| images | JSON | 图片列表 |
| likes | INT | 点赞数 |
| created_at | TIMESTAMP | 创建时间 |

#### 5. favorites - 收藏表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT PRIMARY KEY | 收藏ID |
| user_id | INT | 用户ID |
| recipe_id | INT | 食谱ID |
| created_at | TIMESTAMP | 创建时间 |

#### 6. likes - 点赞表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT PRIMARY KEY | 点赞ID |
| user_id | INT | 用户ID |
| target_type | VARCHAR(20) | 目标类型 |
| target_id | INT | 目标ID |
| created_at | TIMESTAMP | 创建时间 |

#### 7. shopping_lists - 购物清单

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT PRIMARY KEY | 清单ID |
| user_id | INT | 用户ID |
| recipe_id | INT | 食谱ID |
| ingredient_name | VARCHAR(100) | 食材名 |
| amount | VARCHAR(50) | 数量 |
| unit | VARCHAR(20) | 单位 |
| is_purchased | BOOLEAN | 是否已购买 |
| created_at | TIMESTAMP | 创建时间 |

---

## API文档

### 接口规范

#### 请求格式

```javascript
// 通过云函数代理
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'GET',
    path: '/api/v1/recipes',
    query: { page: 1, limit: 10 },
    body: {},
    headers: {
      'Authorization': 'Bearer <token>'
    }
  }
})
```

#### 响应格式

```javascript
// 成功响应
{
  "code": 200,
  "message": "success",
  "data": { /* 实际数据 */ },
  "timestamp": "2024-10-16T12:00:00.000Z"
}

// 错误响应
{
  "code": 400,
  "message": "错误信息",
  "error": "BadRequest",
  "timestamp": "2024-10-16T12:00:00.000Z"
}
```

#### 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 429 | 请求过于频繁 |
| 500 | 服务器错误 |

### Swagger文档

访问地址：`https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/docs`

---

## 部署架构

### 环境配置

#### 开发环境

```
本地开发：localhost:3000
数据库：本地MySQL或云端数据库
对象存储：腾讯云COS测试桶
```

#### 生产环境

```
云托管地址：https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
数据库：微信云托管CynosDB MySQL 8.0
  - 内网地址：10.32.104.73:3306
  - 外网地址：sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com:23831
对象存储：腾讯云COS (南京)
  - https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com
```

### 环境变量

#### 后端环境变量 (cloudbase-env-vars.json)

```json
{
  "NODE_ENV": "production",
  "PORT": "3000",
  "API_PREFIX": "api/v1",
  
  "DB_TYPE": "mysql",
  "DB_HOST": "10.32.104.73",
  "DB_PORT": "3306",
  "DB_USERNAME": "root",
  "DB_PASSWORD": "your_password",
  "DB_DATABASE": "cooktip",
  "DB_CHARSET": "utf8mb4",
  "DB_SYNCHRONIZE": "false",
  
  "JWT_SECRET": "your_jwt_secret_key",
  "JWT_EXPIRES_IN": "7d",
  
  "WX_APPID": "your_miniprogram_appid",
  "WX_SECRET": "your_miniprogram_secret",
  
  "CDN_BASE_URL": "https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com",
  "UPLOAD_DESTINATION": "/app/uploads",
  "MAX_FILE_SIZE": "10485760",
  
  "THROTTLE_TTL": "60",
  "THROTTLE_LIMIT": "10"
}
```

#### 前端小程序域名配置

需要在微信小程序后台配置以下域名：

**downloadFile合法域名**：
```
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com
```

**uploadFile合法域名**：
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com
```

### 部署流程

#### 1. 后端部署（云托管）

```bash
# 推送代码到GitHub
git push origin main

# 微信云托管自动触发部署
# 或手动在云托管控制台触发部署
```

#### 2. 云函数部署

```bash
# 使用微信开发者工具
# 1. 打开cloudfunctions/api-proxy
# 2. 右键 -> 上传并部署：云端安装依赖
```

#### 3. 数据库初始化

```bash
# 连接云托管数据库
mysql -h sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com \\
      -P 23831 -u root -p

# 执行初始化脚本
source database/init.sql
```

### Docker配置

#### Dockerfile

```dockerfile
FROM node:16-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["node", "dist/main"]
```

#### docker-compose.yml

```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
```

---

## 开发指南

### 快速开始

#### 1. 克隆项目

```bash
git clone https://github.com/David07aa/CookTip-Backend.git
cd CookTip-Backend
```

#### 2. 安装依赖

```bash
npm install
```

#### 3. 配置环境变量

```bash
# 复制环境变量示例
cp .env.example .env

# 编辑.env填写数据库配置
vim .env
```

#### 4. 初始化数据库

```bash
# 使用Node.js脚本
node scripts/check-database-images.js
```

#### 5. 启动开发服务器

```bash
npm run start:dev
```

#### 6. 访问API文档

```
http://localhost:3000/api/docs
```

### NPM脚本

| 命令 | 说明 |
|------|------|
| `npm run start` | 启动生产服务器 |
| `npm run start:dev` | 启动开发服务器(热重载) |
| `npm run start:prod` | 启动生产服务器 |
| `npm run build` | 构建生产版本 |
| `npm run lint` | 代码检查 |
| `npm run format` | 代码格式化 |

### 开发规范

#### Git提交规范

```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整(不影响代码运行)
refactor: 重构
test: 测试相关
chore: 构建/工具链
perf: 性能优化
```

#### 代码风格

- 使用TypeScript严格模式
- 遵循ESLint规则
- 使用Prettier格式化代码
- 函数命名使用驼峰命名
- 类命名使用帕斯卡命名

---

## 文档索引

### 核心文档

| 文档 | 说明 | 链接 |
|------|------|------|
| 项目架构文档 | 本文档，完整架构说明 | 当前文档 |
| README.md | 项目总览和快速开始 | [README.md](./README.md) |
| 后端API开发文档 | 完整API接口文档 | [后端API开发文档.md](./后端API开发文档.md) |
| 后端技术选型方案 | 技术栈选型依据 | [后端技术选型方案.md](./后端技术选型方案.md) |
| 前端对接文档 | 小程序对接指南 | [前端对接文档-新版.md](./前端对接文档-新版.md) |

### 云函数文档

| 文档 | 说明 | 链接 |
|------|------|------|
| 云函数部署完整指南 | 云函数详细部署步骤 | [云函数部署完整指南.md](./云函数部署完整指南.md) |
| 云函数API网关 | API网关使用说明 | [云函数API网关-README.md](./云函数API网关-README.md) |
| 云函数快速参考 | 常用云函数参考 | [云函数快速参考.md](./云函数快速参考.md) |

### 工具文档

| 文档 | 说明 | 位置 |
|------|------|------|
| 小程序工具使用示例 | CDN、API封装使用 | [miniprogram-utils/使用示例.md](./miniprogram-utils/使用示例.md) |
| 云函数README | API代理说明 | [cloudfunctions/api-proxy/README.md](./cloudfunctions/api-proxy/README.md) |

---

## 性能优化

### 数据库优化

| 优化项 | 说明 | 效果 |
|--------|------|------|
| 索引优化 | 为常用查询字段添加索引 | 查询速度提升80% |
| 连接池 | 使用连接池复用连接 | 减少连接开销 |
| 内网访问 | 云托管内网访问数据库 | 延迟<1ms |
| 查询优化 | 避免N+1查询,使用JOIN | 减少数据库请求 |

### 接口优化

| 优化项 | 说明 | 效果 |
|--------|------|------|
| 响应压缩 | gzip压缩响应数据 | 传输量减少70% |
| 分页查询 | 列表接口分页返回 | 减少单次数据量 |
| 字段筛选 | 只返回必要字段 | 减少数据传输 |
| 请求限流 | Throttler限制请求频率 | 防止滥用 |

### CDN加速

| 资源类型 | CDN | 效果 |
|---------|-----|------|
| 图片 | 腾讯云COS | 加载速度提升50% |
| 视频封面 | 腾讯云COS | 加载速度提升50% |

---

## 安全措施

### 认证授权

- ✅ JWT Token认证
- ✅ Token过期自动刷新
- ✅ 微信OpenID绑定
- ✅ Guard守卫保护接口

### 数据安全

- ✅ SQL注入防护(TypeORM参数化查询)
- ✅ XSS防护(输入验证和转义)
- ✅ CORS配置
- ✅ 敏感数据加密存储

### 访问控制

- ✅ 请求频率限制(Throttler)
- ✅ 文件上传大小限制
- ✅ 文件类型白名单
- ✅ 环境变量隔离

---

## 监控与日志

### 日志系统

- 应用日志：NestJS Logger
- 错误日志：异常过滤器捕获
- 访问日志：请求拦截器记录

### 健康检查

```bash
# 健康检查端点
GET /health

# 响应
{
  "status": "ok",
  "timestamp": "2024-10-16T12:00:00.000Z"
}
```

---

## 常见问题

### Q1: 如何添加新的业务模块？

```bash
# 使用NestJS CLI生成模块
nest generate module <模块名>
nest generate controller <模块名>
nest generate service <模块名>
```

### Q2: 如何修改数据库结构？

1. 修改Entity文件
2. 生成SQL迁移脚本
3. 在数据库执行SQL
4. 重启服务

### Q3: 如何查看日志？

```bash
# 云托管控制台查看实时日志
# 或使用tcb-cli命令行工具
```

### Q4: 如何优化慢查询？

1. 开启SQL日志
2. 分析慢查询
3. 添加索引
4. 优化SQL语句
5. 考虑缓存

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0.0 | 2024-10-16 | 初始版本发布 |
| - | - | 完成核心功能开发 |
| - | - | 完成云托管部署 |
| - | - | 完成图片存储迁移 |
| - | - | 完成云函数API网关 |

---

## 联系方式

- **项目仓库**: https://github.com/David07aa/CookTip-Backend
- **问题反馈**: GitHub Issues

---

## License

MIT License

---

**Last Updated**: 2024-10-16  
**Current Version**: v1.0.0  
**Author**: CookTip Team


