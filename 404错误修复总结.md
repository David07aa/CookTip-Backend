# 404 错误修复总结

**修复日期**: 2025-10-17  
**问题类型**: 前端登录 404 错误  
**影响范围**: 所有新增的认证接口

---

## 🔍 问题描述

前端调用新开发的认证接口时，所有请求返回 404 错误：

```javascript
Cannot POST /auth/wechat-login (404 Not Found)
Cannot POST /auth/login (404 Not Found)
Cannot POST /auth/register (404 Not Found)
```

### 错误日志

```javascript
[Request] POST /auth/wechat-login {code: "0e3vnsll2et7ug4BIKkl2obVvn4vnsl6", ...}
[Request] Success: POST /auth/wechat-login {
  code: 404, 
  message: "Cannot POST /auth/wechat-login", 
  error: "Not Found"
}
```

---

## 🔎 根本原因分析

### 1. 后端 API 路径配置

后端在 `src/main.ts` 中配置了全局 API 前缀：

```typescript
// src/main.ts:14
const apiPrefix = configService.get('API_PREFIX') || 'api/v1';
app.setGlobalPrefix(apiPrefix);
```

实际的后端路径：
- ✅ `/api/v1/auth/wechat-login`
- ✅ `/api/v1/auth/login`
- ✅ `/api/v1/auth/register`

### 2. 云函数转发逻辑

云函数 `api-proxy` 直接转发前端请求，没有自动添加前缀：

```javascript
// cloudfunctions/api-proxy/index.js (旧版本)
let fullUrl = `${API_INTERNAL_URL}${path}`;  // ❌ 缺少前缀
```

### 3. 前端请求路径

前端按照文档要求，发送的是不带前缀的路径：

```javascript
// 前端代码
path: '/auth/login'  // ❌ 后端需要 /api/v1/auth/login
```

### 问题流程图

```
前端请求: /auth/login
    ↓
云函数转发: http://backend/auth/login  ← 404 (没有这个路径)
    ↓
后端期望: http://backend/api/v1/auth/login  ← 正确路径
```

---

## ✅ 解决方案

### 修改云函数代码

在 `cloudfunctions/api-proxy/index.js` 中添加自动前缀逻辑：

```javascript
// 自动添加 API 前缀（如果路径不是以 /api/v1 开头）
let apiPath = path;
if (!path.startsWith('/api/v1') && !path.startsWith('/health')) {
  apiPath = `/api/v1${path}`;
}

// 构建完整的请求 URL
let fullUrl = `${API_INTERNAL_URL}${apiPath}`;
```

### 修改后的流程

```
前端请求: /auth/login
    ↓
云函数处理: 检测到没有 /api/v1 前缀
    ↓
自动添加前缀: /api/v1/auth/login
    ↓
转发到后端: http://backend/api/v1/auth/login  ← ✅ 正确
    ↓
后端正常响应: 200 OK
```

---

## 📝 修改的文件

### 1. cloudfunctions/api-proxy/index.js
```diff
+ // 自动添加 API 前缀（如果路径不是以 /api/v1 开头）
+ let apiPath = path
+ if (!path.startsWith('/api/v1') && !path.startsWith('/health')) {
+   apiPath = `/api/v1${path}`
+ }
+
- let fullUrl = `${API_INTERNAL_URL}${path}`
+ let fullUrl = `${API_INTERNAL_URL}${apiPath}`
```

### 2. 前端对接完整文档.md
- 添加了路径使用说明
- 更新了常见问题（Q1: 404 错误解决方案）
- 强调云函数调用不需要 `/api/v1` 前缀

### 3. 新增文档
- `修复404错误-部署指南.md` - 详细的部署和测试指南
- `scripts/deploy-api-proxy.sh` - Linux/Mac 部署脚本
- `scripts/deploy-api-proxy.ps1` - Windows 部署脚本

---

## 🚀 部署步骤

### 快速部署（推荐）

**Windows**:
```powershell
.\scripts\deploy-api-proxy.ps1
```

**Mac/Linux**:
```bash
bash scripts/deploy-api-proxy.sh
```

### 手动部署

1. 打开微信开发者工具
2. 找到 `cloudfunctions/api-proxy` 文件夹
3. 右键 → **上传并部署：云端安装依赖**
4. 等待 1-2 分钟生效

---

## 🧪 测试验证

### 1. 健康检查测试

```javascript
// 在小程序控制台执行
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'GET',
    path: '/health'  // 不需要加 /api/v1 前缀
  }
}).then(res => {
  console.log('✅ 测试成功:', res);
  // 预期: {statusCode: 200, data: {status: "ok"}}
});
```

### 2. 登录接口测试

```javascript
// 微信登录测试
wx.login({
  success: (res) => {
    wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'POST',
        path: '/auth/wechat-login',
        body: { code: res.code }
      }
    }).then(result => {
      console.log('✅ 登录成功:', result);
      // 预期: 返回 access_token 和 user 信息
    }).catch(err => {
      console.error('❌ 登录失败:', err);
    });
  }
});
```

### 3. 注册接口测试

```javascript
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'POST',
    path: '/auth/register',
    body: {
      username: 'testuser',
      password: 'Test123456',
      email: 'test@example.com'
    }
  }
}).then(result => {
  console.log('✅ 注册成功:', result);
}).catch(err => {
  console.error('❌ 注册失败:', err);
});
```

### 4. 云函数日志验证

查看云函数日志，确认路径转换正确：

```
✅ 收到请求: {method: "POST", path: "/auth/login"}
✅ 转发请求到: http://xxx.com/api/v1/auth/login  ← 注意这里有 /api/v1
✅ 后端响应: {status: 200}
```

---

## 📊 影响范围

### ✅ 修复的接口

所有新增的认证接口：
- `POST /auth/register` - 用户注册
- `POST /auth/login` - 账号登录
- `POST /auth/bind-account` - 绑定账号
- `GET /auth/credentials` - 获取凭证列表
- `DELETE /auth/credentials/:id` - 解绑账号
- `POST /auth/set-password` - 修改密码

### ✅ 兼容性

保持向后兼容：
- 原有的微信登录功能不受影响
- 所有其他 API（食谱、评论等）正常工作
- 支持已有的完整路径调用（如直接传 `/api/v1/xxx`）

### ⚠️ 注意事项

1. **必须重新部署云函数**，否则修复不生效
2. 部署后等待 1-2 分钟让云函数生效
3. 前端代码**不需要修改**，保持使用简短路径即可

---

## 📈 预防措施

### 1. 文档更新

在前端文档中明确说明：
- 云函数调用不需要 `/api/v1` 前缀
- 直接 HTTP 调用需要完整路径
- 提供清晰的示例代码

### 2. 自动化测试

建议添加云函数集成测试：
```javascript
// test/cloud-function.test.js
describe('API Proxy Cloud Function', () => {
  it('should add /api/v1 prefix automatically', async () => {
    const result = await callCloudFunction('api-proxy', {
      method: 'GET',
      path: '/health'
    });
    expect(result.statusCode).toBe(200);
  });
});
```

### 3. 部署检查清单

每次部署新功能前确认：
- [ ] 云函数代码是最新的
- [ ] API 路径配置正确
- [ ] 前端文档已更新
- [ ] 已进行基本测试

---

## 💡 经验总结

### 问题根源

**架构设计问题**：
- 后端使用全局 API 前缀
- 云函数作为代理层，没有考虑到这个前缀
- 前端和后端之间缺少清晰的契约

### 最佳实践

1. **统一的 API 网关**
   - 云函数应该承担 API 网关的角色
   - 自动处理路径转换、认证、限流等

2. **清晰的接口文档**
   - 明确说明前端需要传递的路径格式
   - 提供完整的示例代码
   - 说明云函数和直接调用的区别

3. **完善的测试**
   - 端到端测试
   - 云函数单元测试
   - API 集成测试

### 改进建议

1. **添加请求日志**
   ```javascript
   console.log(`[API Proxy] ${method} ${path} → ${fullUrl}`);
   ```

2. **错误提示优化**
   - 404 错误时检查是否缺少前缀
   - 返回更友好的错误信息

3. **配置化管理**
   ```javascript
   const config = {
     apiPrefix: '/api/v1',
     excludePaths: ['/health', '/api/v1']
   };
   ```

---

## 📞 相关文档

- **前端对接完整文档.md** - 前端开发指南
- **修复404错误-部署指南.md** - 详细部署步骤
- **后端API开发文档.md** - 完整 API 参考
- **云函数部署完整指南.md** - 云函数部署

---

## ✅ 检查清单

部署完成后，请确认：

- [ ] 云函数 `api-proxy` 已重新部署
- [ ] 等待 1-2 分钟生效时间
- [ ] 健康检查接口测试通过
- [ ] 微信登录功能正常
- [ ] 账号注册功能正常
- [ ] 账号登录功能正常
- [ ] 云函数日志显示正确的路径（包含 `/api/v1`）
- [ ] 前端不再出现 404 错误

---

**修复完成！** 🎉

如有问题，请查看 `修复404错误-部署指南.md` 或联系开发团队。

