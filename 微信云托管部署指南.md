# 微信云托管部署指南

## 📋 部署前检查清单

- ✅ 项目代码已准备好
- ✅ Dockerfile 已配置
- ✅ 数据库已创建（SQLPub MySQL）
- ✅ 微信小程序信息已获取（AppID & Secret）
- ✅ JWT_SECRET 已生成

---

## 🚀 部署方式

### 方式一：通过微信开发者工具部署（推荐）

#### 1️⃣ 安装微信开发者工具

下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

#### 2️⃣ 打开云托管

1. 打开微信开发者工具
2. 登录您的小程序账号
3. 点击 **云开发** → **云托管**
4. 如果第一次使用，需要开通云托管服务

#### 3️⃣ 创建服务

1. 点击 **新建服务**
2. 服务名称：`cooktip-api`
3. 选择镜像上传方式：**上传代码**
4. 选择运行环境：**Node.js**

#### 4️⃣ 配置环境变量

在云托管控制台 → 服务设置 → 环境变量，添加以下配置：

```
# 数据库配置（使用 SQLPub）
DB_TYPE=mysql
DB_HOST=mysql3.sqlpub.com
DB_PORT=3308
DB_USERNAME=david_x
DB_PASSWORD=NVRvnX3rP88UyUET
DB_DATABASE=onefoodlibrary

# JWT 配置
JWT_SECRET=zA5OmJymUqj3VyKFNeO+pwK/4Ju6bDtCUO2vjoL0sT6onHW5ObPXNvZI/u3SD0LvokBS4y5uJ2wrvX7AiT6dRQ==
JWT_EXPIRES_IN=7d

# 微信小程序配置
WX_APPID=wx8486e57500ac0a55
WX_SECRET=bd4c652097608bb064350cc7e3b5801c

# 服务器配置
PORT=3000
NODE_ENV=production

# 限流配置
THROTTLE_TTL=60
THROTTLE_LIMIT=10
```

#### 5️⃣ 上传代码

**方法 A：通过微信开发者工具**

1. 在开发者工具中，选择 **云托管** 标签
2. 点击 **上传代码**
3. 选择项目根目录（`CookTip-Backend`）
4. 等待构建和部署完成

**方法 B：通过命令行（需安装 CloudBase CLI）**

```bash
# 1. 安装 CLI
npm install -g @cloudbase/cli

# 2. 登录
tcb login

# 3. 部署
tcb run:deploy
```

#### 6️⃣ 配置服务路径

1. 在云托管控制台，点击服务名称
2. 配置路径映射：`/` → 容器端口 `3000`
3. 保存配置

#### 7️⃣ 查看部署状态

- 在云托管控制台查看服务状态
- 查看日志：点击 **日志** 标签
- 测试 API：访问分配的云托管域名

---

### 方式二：使用 Docker 镜像部署

#### 1️⃣ 本地构建镜像

```bash
# 在项目根目录执行
docker build -t cooktip-backend:latest .
```

#### 2️⃣ 推送到腾讯云容器镜像服务

```bash
# 登录腾讯云容器镜像服务
docker login ccr.ccs.tencentyun.com

# 标记镜像
docker tag cooktip-backend:latest ccr.ccs.tencentyun.com/[your-namespace]/cooktip-backend:latest

# 推送镜像
docker push ccr.ccs.tencentyun.com/[your-namespace]/cooktip-backend:latest
```

#### 3️⃣ 在云托管中使用镜像

1. 创建服务时选择 **使用镜像**
2. 选择您推送的镜像
3. 配置环境变量和端口
4. 部署

---

### 方式三：通过 Git 仓库自动部署

#### 1️⃣ 推送代码到 Git 仓库

```bash
# 初始化 Git（如果还没有）
git init
git add .
git commit -m "Initial commit"

# 添加远程仓库
git remote add origin <your-git-repo-url>
git push -u origin main
```

#### 2️⃣ 配置云托管自动部署

1. 在云托管控制台，选择服务
2. 点击 **版本管理** → **新建版本**
3. 选择 **Git 仓库部署**
4. 关联您的 Git 仓库
5. 选择分支（如 `main`）
6. 配置构建命令：
   ```
   npm install
   npm run build
   ```
7. 配置启动命令：
   ```
   node dist/main.js
   ```
8. 保存并部署

---

## ⚙️ 云托管配置建议

### 资源配置

| 配置项 | 推荐值 | 说明 |
|-------|--------|------|
| CPU | 1 核 | 小规模应用足够 |
| 内存 | 2GB | 建议配置 |
| 实例数量 | 1-3 个 | 根据流量自动扩缩容 |
| 最小实例数 | 1 | 保证服务可用 |
| 最大实例数 | 5 | 防止成本过高 |

### 弹性伸缩

建议配置自动扩缩容规则：
- CPU 使用率 > 70% 时扩容
- CPU 使用率 < 30% 时缩容
- 扩缩容间隔：5 分钟

### 健康检查

配置健康检查路径：
- 路径：`/api/health` 或 `/`
- 端口：`3000`
- 协议：`HTTP`
- 检查间隔：30 秒

---

## 🔍 部署后验证

### 1. 检查服务状态

在云托管控制台查看：
- 服务是否正常运行
- 实例数量是否符合预期
- 查看实时日志

### 2. 测试 API 接口

```bash
# 替换为您的云托管域名
curl https://your-cloud-run-domain.com/api/health

# 测试微信登录接口
curl -X POST https://your-cloud-run-domain.com/api/auth/wx-login \
  -H "Content-Type: application/json" \
  -d '{"code":"test-code"}'
```

### 3. 查看 API 文档

访问：`https://your-cloud-run-domain.com/api/docs`

---

## 📊 监控和日志

### 查看日志

1. 在云托管控制台，点击服务名称
2. 点击 **日志** 标签
3. 查看实时日志和历史日志

### 设置告警

1. 在云托管控制台，点击 **监控告警**
2. 配置告警规则：
   - CPU 使用率 > 80%
   - 内存使用率 > 80%
   - 请求失败率 > 5%
   - 响应时间 > 3 秒

---

## 🔄 更新部署

### 快速更新

```bash
# 1. 修改代码后提交
git add .
git commit -m "Update: 新功能"
git push

# 2. 在云托管控制台点击「重新部署」
```

### 版本回滚

如果新版本有问题，可以在云托管控制台：
1. 点击 **版本管理**
2. 选择之前的稳定版本
3. 点击 **回滚**

---

## 🌐 配置自定义域名（可选）

### 1. 在云托管控制台添加域名

1. 点击 **域名管理**
2. 添加自定义域名（如 `api.cooktip.com`）
3. 配置 DNS 解析（添加 CNAME 记录）

### 2. 配置 HTTPS

云托管会自动为您申请免费 SSL 证书。

---

## ❗ 常见问题

### 1. 部署失败

**检查项：**
- Dockerfile 是否正确
- 依赖是否完整（package.json）
- 构建日志中的错误信息

### 2. 服务无法访问

**检查项：**
- 端口配置是否正确（3000）
- 路径映射是否正确
- 防火墙规则是否开放

### 3. 数据库连接失败

**检查项：**
- 环境变量是否配置正确
- 数据库地址和端口是否正确
- 数据库用户权限是否正确

### 4. 内存不足

**解决方案：**
- 增加内存配置（升级到 2GB 或 4GB）
- 优化代码，减少内存占用

---

## 💡 最佳实践

1. ✅ **使用环境变量** 管理配置，不要硬编码
2. ✅ **配置健康检查** 确保服务稳定
3. ✅ **设置自动扩缩容** 应对流量波动
4. ✅ **定期查看日志** 及时发现问题
5. ✅ **配置监控告警** 第一时间收到通知
6. ✅ **做好版本管理** 方便回滚
7. ✅ **定期备份数据库** 防止数据丢失

---

## 📞 获取帮助

- **微信云托管官方文档**：https://cloud.weixin.qq.com/cloudrun/
- **技术支持**：在微信开发者社区提问
- **项目问题**：查看 `后端API开发文档.md`

---

**祝部署顺利！🎉**

CookTip 开发团队

