# 🚨 前端配置更新指南 - 紧急修复

**问题**：前端无法连接后端 API（ERR_CONNECTION_CLOSED）  
**原因**：前端使用了内网地址，需要改为公网地址  
**更新时间**：2025-10-16

---

## ✅ 问题已确认并解决

### 原因分析

前端配置中使用的是**内网地址**（仅云托管内部可访问）：
```
❌ 旧地址（内网）：https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```

需要改为**公网地址**（外部可访问）：
```
✅ 新地址（公网）：https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

---

## 🎯 立即修复步骤

### 第 1 步：更新前端 API 配置

找到前端项目中的 API 配置文件，常见位置：

- `config/api.config.js`
- `utils/config.js`
- `utils/request.js`
- `app.js`

**修改前**：
```javascript
const API_BASE_URL = 'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1'
```

**修改后**：
```javascript
const API_BASE_URL = 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1'
```

---

### 第 2 步：配置微信小程序域名白名单 ⚠️ 必须配置

1. **登录微信公众平台**  
   👉 https://mp.weixin.qq.com

2. **进入开发设置**  
   路径：`开发` → `开发管理` → `开发设置` → `服务器域名`

3. **添加以下域名**：

#### request 合法域名（API 请求）
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

#### uploadFile 合法域名（图片上传）
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

#### downloadFile 合法域名（图片下载）
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

**注意**：
- 域名配置后需要 **5-10 分钟** 生效
- 每月只能修改 **5 次**，请谨慎操作
- 必须是 **HTTPS** 协议

---

### 第 3 步：验证修复

#### 在微信开发者工具中测试

1. 清除缓存：`工具` → `清除缓存`
2. 编译代码：`编译`
3. 测试接口：打开首页，查看是否正常加载数据

#### 测试各个接口

在开发者工具控制台运行：

```javascript
// 测试健康检查
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/health',
  method: 'GET',
  success: (res) => {
    console.log('健康检查:', res.data)
  }
})

// 测试分类接口
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/categories',
  method: 'GET',
  success: (res) => {
    console.log('分类列表:', res.data)
  }
})

// 测试食谱列表
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes',
  method: 'GET',
  data: {
    page: 1,
    limit: 10
  },
  success: (res) => {
    console.log('食谱列表:', res.data)
  }
})
```

**期望结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

---

## 📝 完整的前端配置示例

### config/api.config.js

```javascript
// API 配置
const config = {
  // 基础地址
  baseUrl: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com',
  
  // API 基础路径
  apiBaseUrl: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1',
  
  // 对象存储（图片 CDN）
  storageUrl: 'https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com',
  
  // 请求超时时间
  timeout: 10000,
  
  // 本地存储键
  tokenKey: 'cooktip_token',
  userInfoKey: 'cooktip_userInfo',
}

module.exports = config
```

### utils/request.js

```javascript
const { apiBaseUrl, tokenKey } = require('../config/api.config')

/**
 * 通用请求方法
 */
function request(options) {
  const token = wx.getStorageSync(tokenKey)

  return new Promise((resolve, reject) => {
    wx.request({
      url: `${apiBaseUrl}${options.url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data)
        } else if (res.statusCode === 401) {
          // Token 过期，跳转登录
          wx.showToast({
            title: '请先登录',
            icon: 'none'
          })
          setTimeout(() => {
            wx.navigateTo({
              url: '/pages/login/login'
            })
          }, 1500)
          reject(new Error('未登录'))
        } else {
          wx.showToast({
            title: res.data.message || '请求失败',
            icon: 'none'
          })
          reject(res.data)
        }
      },
      fail: (err) => {
        console.error('请求失败:', err)
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        })
        reject(err)
      }
    })
  })
}

module.exports = {
  request
}
```

---

## ⚠️ 重要提示

### 1. 公网地址仅用于测试

根据腾讯云托管说明：

> 公网域名仅能支持测试使用，请勿用于线上生产，且公网域名没有防刷防 DDoS 能力。

**建议**：配置自定义域名用于生产环境

---

### 2. 配置自定义域名（生产环境推荐）

#### 步骤 A：准备域名

1. 购买域名（如 `api.cooktip.com`）
2. 完成 ICP 备案（必须）

#### 步骤 B：在云托管配置

1. 打开云托管控制台
2. 进入：`云托管` → `服务管理` → 您的服务 → `域名管理`
3. 点击 **添加域名**
4. 输入您的域名：`api.cooktip.com`
5. 获取 CNAME 记录

#### 步骤 C：配置 DNS 解析

在您的域名 DNS 服务商（如阿里云、腾讯云）：

| 记录类型 | 主机记录 | 记录值 |
|---------|---------|--------|
| CNAME | api | 云托管提供的 CNAME 地址 |

#### 步骤 D：等待生效

- DNS 解析生效时间：10 分钟 - 24 小时
- SSL 证书自动申请：约 5-10 分钟

#### 步骤 E：更新前端配置

```javascript
const API_BASE_URL = 'https://api.cooktip.com/api/v1'
```

---

## 🔍 故障排查

### 问题 1：配置后仍无法连接

**检查清单**：
- [ ] API 地址是否正确（包含 HTTPS）
- [ ] 微信公众平台域名白名单是否已配置
- [ ] 域名白名单是否已生效（等待 10 分钟）
- [ ] 小程序是否清除了缓存并重新编译

### 问题 2：提示 "不在合法域名列表中"

**原因**：未配置域名白名单或未生效

**解决**：
1. 检查微信公众平台域名配置
2. 等待 10 分钟后重试
3. 确认域名格式正确（必须 HTTPS）

### 问题 3：开发环境可以，真机预览失败

**原因**：开发工具勾选了"不校验合法域名"

**解决**：
1. 必须在微信公众平台配置域名白名单
2. 真机预览会严格校验域名

---

## 📊 验证测试结果

### 已验证接口

✅ 健康检查：`/health`
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "status": "healthy",
    "service": "cooktip-backend"
  }
}
```

✅ 分类列表：`/api/v1/categories`
```json
{
  "code": 200,
  "data": [
    { "id": 1, "name": "主食" },
    { "id": 2, "name": "凉拌" },
    ...
  ]
}
```

✅ 食谱列表：`/api/v1/recipes`
```json
{
  "code": 200,
  "data": {
    "items": [...],
    "total": 198,
    "page": 1,
    "limit": 10
  }
}
```

---

## 📞 需要帮助？

如果修复后仍有问题，请提供：
1. 前端控制台的完整错误信息
2. 网络请求的详细信息（URL、状态码）
3. 微信公众平台域名配置截图

---

## 📌 快速参考

### 正确的地址配置

| 用途 | 地址 |
|------|------|
| API 基础地址 | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1` |
| 健康检查 | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/health` |
| API 文档 | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/docs` |
| 图片 CDN | `https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com` |

### 地址对比

| 类型 | 地址 | 可访问性 |
|------|------|---------|
| ❌ 内网地址 | `rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com` | 仅云托管内部 |
| ✅ 公网地址 | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com` | 全网可访问 |

---

**修复完成后，前端应该能够正常连接后端 API！** 🎉

**更新时间**：2025-10-16  
**下次更新**：配置自定义域名后

