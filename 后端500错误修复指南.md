# 后端 500 错误修复指南

> 📅 创建时间：2025-10-09  
> 🎯 目标：修复后端 500 Internal Server Error  
> ✅ 状态：代码已修复，需要数据库初始化和重新部署

---

## 🔧 已修复的问题

### 1. 参数名不匹配 ✅ 已修复

**问题**：
- 前端使用：`sortBy=recommended`
- 后端接收：`sort=latest`

**修复**：
```typescript
// src/modules/recipe/recipe.controller.ts
async getRecipes(
  @Query('sort') sort?: string,
  @Query('sortBy') sortBy?: string,  // ← 新增支持
  // ...
) {
  // 支持 sort 和 sortBy 两种参数名
  const sortParam = sortBy || sort || 'latest';
  return this.recipeService.getRecipes(..., sortParam, ...);
}
```

### 2. 缺少 recommended 排序 ✅ 已修复

**问题**：
- 前端请求：`sortBy=recommended`
- 后端只支持：`latest`, `hot`, `popular`

**修复**：
```typescript
// src/modules/recipe/recipe.service.ts
switch (sort) {
  case 'hot':
    queryBuilder.orderBy('recipe.likes', 'DESC');
    break;
  case 'popular':
    queryBuilder.orderBy('recipe.views', 'DESC');
    break;
  case 'recommended':  // ← 新增推荐排序
    // 综合考虑点赞、收藏、浏览量
    queryBuilder.orderBy('(recipe.likes * 3 + recipe.favorites * 2 + recipe.views * 0.1)', 'DESC');
    break;
  case 'latest':
  default:
    queryBuilder.orderBy('recipe.created_at', 'DESC');
    break;
}
```

---

## 📋 需要执行的步骤

### 步骤 1：初始化数据库 ⭐ 最重要

数据库可能没有创建表，导致查询失败。

#### 方法A：使用 SQLPub 管理界面

1. **登录 SQLPub**
   ```
   访问：https://sqlpub.com
   用户名：david_x
   ```

2. **选择数据库**
   ```
   数据库：onefoodlibrary
   ```

3. **执行初始化脚本**
   - 点击「SQL 编辑器」
   - 复制 `database/init.sql` 的全部内容
   - 点击「执行」
   - 等待执行完成（应该看到 10 张表被创建）

4. **插入测试数据（可选）**
   - 复制 `database/seed.sql` 的全部内容
   - 点击「执行」
   - 应该看到测试用户、食谱、评论等数据被插入

#### 方法B：使用 MySQL 客户端

```bash
# 1. 连接到数据库
mysql -h mysql3.sqlpub.com -P 3308 -u david_x -p onefoodlibrary

# 2. 执行初始化脚本
source /path/to/database/init.sql

# 3. 插入测试数据
source /path/to/database/seed.sql

# 4. 验证表是否创建成功
SHOW TABLES;

# 应该看到这些表：
# - users
# - categories
# - recipes
# - comments
# - favorites
# - likes
# - shopping_list
```

### 步骤 2：验证数据库

运行以下 SQL 确认表已创建：

```sql
-- 查看所有表
SHOW TABLES;

-- 查看分类数据
SELECT * FROM categories;

-- 查看测试食谱
SELECT id, title, difficulty, cook_time FROM recipes;

-- 查看用户
SELECT id, nickname FROM users;
```

**预期结果**：
- ✅ 7 张表存在
- ✅ 10 个分类数据
- ✅ 3 个测试用户
- ✅ 3 个测试食谱

### 步骤 3：重新部署后端

#### 方法A：GitHub 自动部署（推荐）

```bash
# 1. 提交代码修复
git add .
git commit -m "fix: 修复食谱接口参数和排序问题"
git push origin main

# 2. 登录微信云托管控制台
# 3. 进入「云托管」→「服务管理」→「版本管理」
# 4. 点击「新建版本」
# 5. 选择「从代码仓库拉取」
# 6. 等待自动构建和部署
```

#### 方法B：本地测试

```bash
# 1. 安装依赖
npm install

# 2. 配置 .env 文件
# 确保包含正确的数据库配置

# 3. 启动服务
npm run start:dev

# 4. 测试接口
curl http://localhost:3000/api/v1/categories
curl http://localhost:3000/api/v1/recipes?page=1&limit=10&sortBy=recommended
```

### 步骤 4：测试接口

使用以下命令测试生产环境：

```bash
# 测试分类接口
curl https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/categories

# 测试食谱列表（推荐排序）
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?page=1&limit=10&sortBy=recommended"

# 测试食谱列表（热门排序）
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?page=1&limit=10&sortBy=popular"

# 测试食谱列表（简单难度）
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?page=1&limit=4&difficulty=简单"
```

**预期响应**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [...],
    "total": 3,
    "page": 1,
    "limit": 10,
    "total_pages": 1
  }
}
```

---

## 🔍 如果仍然出现 500 错误

### 检查清单

#### 1. 查看云托管日志

```
路径：微信公众平台 → 云开发 → 云托管 → 服务管理 → 日志
```

**查找关键错误**：

```bash
# 数据库连接错误
Error: connect ECONNREFUSED
Error: Access denied for user 'david_x'@'xxx'
Error: Unknown database 'onefoodlibrary'

# 表不存在错误
Error: ER_NO_SUCH_TABLE: Table 'onefoodlibrary.categories' doesn't exist
Error: ER_NO_SUCH_TABLE: Table 'onefoodlibrary.recipes' doesn't exist

# 代码错误
TypeError: Cannot read property 'xxx' of undefined
Error: recipe is not defined
```

#### 2. 确认环境变量

在云托管控制台检查环境变量：

```bash
# 必需的环境变量
DB_HOST=mysql3.sqlpub.com
DB_PORT=3308
DB_USERNAME=david_x
DB_PASSWORD=NVRvnX3rP88UyUET
DB_DATABASE=onefoodlibrary
DB_CHARSET=utf8mb4

WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c

JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d

NODE_ENV=production
PORT=3000
```

#### 3. 测试数据库连接

创建测试脚本 `test-db.js`：

```javascript
const mysql = require('mysql2/promise');

async function testConnection() {
  try {
    const connection = await mysql.createConnection({
      host: 'mysql3.sqlpub.com',
      port: 3308,
      user: 'david_x',
      password: 'NVRvnX3rP88UyUET',
      database: 'onefoodlibrary',
    });

    console.log('✅ 数据库连接成功');

    // 测试查询
    const [tables] = await connection.query('SHOW TABLES');
    console.log('📊 数据表列表:', tables);

    const [categories] = await connection.query('SELECT * FROM categories');
    console.log(`✅ 分类数据: ${categories.length} 条`);

    const [recipes] = await connection.query('SELECT * FROM recipes');
    console.log(`✅ 食谱数据: ${recipes.length} 条`);

    await connection.end();
  } catch (error) {
    console.error('❌ 数据库错误:', error.message);
  }
}

testConnection();
```

运行测试：

```bash
node test-db.js
```

---

## 📊 数据库表结构

### 核心表

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| `users` | 用户表 | id, openid, nickname, avatar |
| `categories` | 分类表 | id, name, icon, recipe_count |
| `recipes` | 食谱表 | id, user_id, title, cover_image, difficulty |
| `comments` | 评论表 | id, recipe_id, user_id, content |
| `favorites` | 收藏表 | id, user_id, recipe_id |
| `likes` | 点赞表 | id, user_id, target_type, target_id |
| `shopping_list` | 购物清单 | id, user_id, name, checked |

### 初始分类数据

```
1. 中餐
2. 西餐
3. 日韩料理
4. 烘焙甜点
5. 家常菜
6. 快手菜
7. 素食
8. 汤羹
9. 小吃
10. 饮品
```

---

## 🎯 修复后的功能

### 支持的排序方式

| 排序参数 | 说明 | 排序规则 |
|---------|------|---------|
| `latest` | 最新 | 按创建时间倒序 |
| `hot` | 最热 | 按点赞数倒序 |
| `popular` | 热门 | 按浏览量倒序 |
| `recommended` | 推荐 ⭐ | 综合算法（点赞×3 + 收藏×2 + 浏览×0.1）|

### 支持的筛选条件

| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `page` | number | 页码 | 1 |
| `limit` | number | 每页数量 | 10 |
| `sortBy` | string | 排序方式 | recommended |
| `category_id` | number | 分类ID | 5 |
| `difficulty` | string | 难度 | 简单 |
| `cook_time` | number | 烹饪时间（分钟以内） | 30 |
| `tag` | string | 标签 | 家常菜 |

### API 示例

```bash
# 获取推荐食谱
GET /api/v1/recipes?sortBy=recommended&limit=10

# 获取简单的快手菜
GET /api/v1/recipes?difficulty=简单&cook_time=30

# 获取家常菜分类的热门食谱
GET /api/v1/recipes?category_id=5&sortBy=hot

# 获取分类列表
GET /api/v1/categories
```

---

## 🚀 快速修复命令

### 一键修复（复制执行）

```bash
# 1. 提交代码修复
cd /path/to/CookTip-Backend
git add .
git commit -m "fix: 修复食谱接口500错误 - 添加sortBy参数支持和recommended排序"
git push origin main

# 2. 等待 5 分钟让云托管自动部署
# 或者手动触发部署：
# 登录微信云托管控制台 → 新建版本 → 从代码仓库拉取
```

### 测试修复结果

```bash
# 测试分类接口
curl https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/categories

# 测试食谱接口（推荐）
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?page=1&limit=10&sortBy=recommended"

# 测试食谱接口（简单难度）
curl "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes?difficulty=简单&limit=4"
```

---

## ⚠️ 常见错误和解决方案

### 错误 1：Table 'onefoodlibrary.categories' doesn't exist

**原因**：数据库表未创建

**解决**：
1. 登录 SQLPub
2. 执行 `database/init.sql`
3. 重启云托管服务

### 错误 2：Access denied for user 'david_x'

**原因**：
- 数据库密码错误
- IP 不在白名单

**解决**：
1. 检查环境变量 `DB_PASSWORD`
2. 在 SQLPub 添加云托管 IP 到白名单

### 错误 3：connect ETIMEDOUT

**原因**：数据库连接超时

**解决**：
1. 检查 `DB_HOST` 和 `DB_PORT`
2. 确认 SQLPub 服务正常
3. 检查网络连接

### 错误 4：Cannot read property 'map' of undefined

**原因**：查询返回空数据，代码没有处理

**解决**：
1. 执行 `database/seed.sql` 插入测试数据
2. 确保数据库有数据

---

## 📞 需要帮助？

### 诊断信息清单

如果问题仍未解决，请提供以下信息：

1. **云托管日志**（最近 50 行）
2. **数据库表列表**（`SHOW TABLES` 结果）
3. **环境变量截图**（脱敏密码）
4. **测试接口响应**（完整的 curl 输出）

### 联系方式

- **GitHub Issues**：https://github.com/David07aa/CookTip-Backend/issues
- **邮箱**：3509204288@qq.com

---

## ✅ 检查清单

完成后确认以下所有项目：

- [ ] 代码已提交并推送到 GitHub
- [ ] 数据库表已创建（`SHOW TABLES` 显示 7 张表）
- [ ] 测试数据已插入（`SELECT COUNT(*) FROM recipes` > 0）
- [ ] 云托管已重新部署
- [ ] `/api/v1/categories` 返回 200
- [ ] `/api/v1/recipes?sortBy=recommended` 返回 200
- [ ] 前端可以正常加载数据

---

**修复完成后，500 错误应该消失！** 🎉

