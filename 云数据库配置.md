# 微信云托管数据库配置指南

## 📋 配置清单

本项目已切换为使用**微信云托管 MySQL 数据库**，以获得更好的性能和稳定性。

---

## 🚀 第一步：开通微信云托管 MySQL

### 1. 登录微信云托管控制台

访问：https://cloud.weixin.qq.com/

### 2. 创建 MySQL 实例

1. 进入「云数据库」→「MySQL」
2. 点击「新建」
3. 选择配置：
   - **数据库版本**：MySQL 5.7
   - **计费模式**：按量计费（推荐）或包年包月
   - **实例规格**：
     - 开发/测试：1核2GB（约 ¥60/月）
     - 生产环境：2核4GB（约 ¥120/月）
   - **存储空间**：20GB 起
   - **网络**：选择与云托管服务相同的 VPC

4. 点击「立即购买」

### 3. 配置数据库

创建完成后：

1. 进入数据库实例详情
2. 点击「账号管理」→「创建账号」
   - 账号名：`cooktip_admin`（或您自定义）
   - 密码：设置强密码（建议 16 位以上）
   - 权限：选择「读写」
3. 点击「数据库管理」→「创建数据库」
   - 数据库名：`cooktip`
   - 字符集：`utf8mb4`
   - 排序规则：`utf8mb4_unicode_ci`

### 4. 获取连接信息

在数据库实例详情页面，复制以下信息：

- **内网地址**：`10.32.104.72`
- **内网端口**：`3306`
- **外网地址**：`sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com`
- **外网端口**：`27821`
- **账号名**：刚才创建的账号
- **密码**：刚才设置的密码

---

## 🔧 第二步：配置环境变量

创建或修改项目根目录的 `.env` 文件：

```env
# ==========================================
# 应用配置
# ==========================================
NODE_ENV=development
PORT=3000
API_PREFIX=api/v1

# ==========================================
# 微信云托管 MySQL 数据库配置
# 内网地址：10.32.104.72:3306
# 外网地址：sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com:27821
# ==========================================
DB_TYPE=mysql

# 云托管环境使用内网地址（生产环境）
DB_HOST=10.32.104.72
DB_PORT=3306

# 本地开发使用外网地址（开发环境，需配置IP白名单）
# DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
# DB_PORT=27821

DB_USER=cooktip_admin
DB_PASSWORD=您设置的数据库密码
DB_NAME=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false

# ==========================================
# JWT 配置
# ==========================================
JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d

# ==========================================
# 微信小程序配置
# ==========================================
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c

# ==========================================
# 文件上传配置
# ==========================================
UPLOAD_DESTINATION=./uploads
MAX_FILE_SIZE=10485760

# 图片CDN配置（可选，建议使用微信云存储）
CDN_BASE_URL=https://您的云存储域名

# ==========================================
# Redis配置（可选）
# ==========================================
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# ==========================================
# 限流配置
# ==========================================
THROTTLE_TTL=60
THROTTLE_LIMIT=10
```

**重要提示**：
- ✅ 使用**内网地址**，不要使用公网地址
- ✅ 确保云托管服务和数据库在同一个 VPC
- ✅ 密码要设置强密码并妥善保管

---

## 📦 第三步：初始化数据库

### 方式一：通过云托管命令行（推荐）

1. 将数据库初始化脚本上传到云托管服务器：

```bash
# 在云托管服务器上执行（使用内网地址）
mysql -h 10.32.104.72 -P 3306 -u cooktip_admin -p cooktip < database/init.sql
```

### 方式二：通过 Navicat/DBeaver 等工具（使用外网地址）

**连接配置**：
- 主机：`sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com`
- 端口：`27821`
- 用户名：`cooktip_admin`
- 密码：您的数据库密码
- 数据库：`cooktip`

**前提**：需要在云数据库控制台配置您的公网IP到白名单

执行步骤：
1. 连接成功后，打开 `database/init.sql` 脚本
2. 执行脚本创建所有表

### 方式三：使用微信云托管控制台

1. 在控制台找到「云数据库」→「SQL 窗口」
2. 复制 `database/init.sql` 的内容
3. 粘贴并执行

---

## ✅ 第四步：验证数据库连接

### 检查数据表

连接到数据库后，执行：

```sql
USE cooktip;

-- 查看所有表
SHOW TABLES;

-- 应该看到以下 7 张表：
-- categories
-- comments
-- favorites
-- likes
-- recipes
-- shopping_list
-- users

-- 验证分类数据
SELECT COUNT(*) as category_count FROM categories;
-- 应该返回 10

-- 查看表结构
DESCRIBE users;
DESCRIBE recipes;
```

### 测试应用连接

启动应用进行测试：

```bash
# 本地开发环境（需要通过云托管访问）
npm run start:dev

# 查看日志，确认数据库连接成功
```

如果看到类似信息表示成功：
```
[TypeORM] Database connection established
```

---

## 🚀 第五步：部署到微信云托管

### 配置云托管环境变量

在微信云托管控制台：

1. 进入「云托管」→「版本管理」
2. 找到您的服务
3. 点击「环境配置」
4. 添加以下环境变量：

```
NODE_ENV=production
PORT=3000
API_PREFIX=api/v1
DB_TYPE=mysql
DB_HOST=10.32.104.72
DB_PORT=3306
DB_USER=cooktip_admin
DB_PASSWORD=您的数据库密码
DB_NAME=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false
JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c
UPLOAD_DESTINATION=/app/uploads
CDN_BASE_URL=https://您的域名
THROTTLE_TTL=60
THROTTLE_LIMIT=10
```

### 部署应用

```bash
# 使用云托管 CLI 部署
tcb login
tcb fn deploy cooktip-api

# 或者通过 Git 自动部署
git push origin main
```

---

## 🔒 安全配置建议

### 1. 网络安全

✅ **强制使用内网访问**
- 云数据库和云托管服务必须在同一 VPC
- 关闭数据库公网访问（如果已开启）

✅ **配置安全组**
- 仅允许云托管服务的安全组访问数据库
- 端口仅开放 3306

### 2. 访问控制

✅ **数据库账号权限**
- 应用账号：仅授予必要的读写权限
- 不要使用 root 账号

✅ **密码策略**
- 使用强密码（16位以上，包含大小写字母、数字、特殊字符）
- 定期更换密码（建议3个月一次）

### 3. 备份策略

✅ **自动备份**
- 在云数据库控制台配置自动备份
- 建议设置每天备份，保留 7 天

✅ **手动备份**
```bash
# 定期执行手动备份
mysqldump -h 内网地址 -u cooktip_admin -p cooktip > backup_$(date +%Y%m%d).sql
```

---

## 📊 性能优化

### 1. 连接池配置

在 `src/app.module.ts` 中已配置，可根据需要调整：

```typescript
TypeOrmModule.forRootAsync({
  // ... 其他配置
  extra: {
    // 连接池配置
    connectionLimit: 10,        // 最大连接数
    waitForConnections: true,
    queueLimit: 0,
  },
}),
```

### 2. 索引优化

所有必要的索引已在 `database/init.sql` 中创建，包括：
- 用户表：openid 索引
- 食谱表：user_id、category_id、status、created_at 索引
- 评论表：recipe_id、user_id、created_at 索引
- 等等...

### 3. 查询优化

- ✅ 使用 QueryBuilder 进行复杂查询
- ✅ 使用分页减少数据量
- ✅ 使用 leftJoinAndSelect 优化关联查询

---

## 🔍 监控和运维

### 1. 数据库监控

在云数据库控制台查看：
- CPU 使用率
- 内存使用率
- 连接数
- 慢查询日志
- QPS（每秒查询数）

### 2. 告警配置

建议配置以下告警：
- CPU 使用率 > 80%
- 内存使用率 > 80%
- 连接数 > 80%
- 磁盘使用率 > 80%

### 3. 日志查看

```bash
# 查看应用日志
tcb fn log cooktip-api --lines 100

# 查看慢查询
# 在云数据库控制台 → 操作日志 → 慢查询日志
```

---

## 💰 成本估算

### 按量计费（推荐开发阶段）

| 规格 | 配置 | 预估费用/月 |
|------|------|------------|
| 基础版 | 1核2GB | ¥60-80 |
| 标准版 | 2核4GB | ¥120-150 |
| 高配版 | 4核8GB | ¥250-300 |

### 包年包月（推荐生产环境）

| 规格 | 配置 | 1年价格 |
|------|------|---------|
| 基础版 | 1核2GB | ¥600-700 |
| 标准版 | 2核4GB | ¥1200-1500 |

**成本优化建议**：
- 开发环境使用按量计费
- 生产环境使用包年包月（有折扣）
- 合理设置连接池大小
- 定期清理无用数据

---

## 🆚 对比 SQLPub

| 功能 | SQLPub | 微信云托管 MySQL |
|------|--------|-----------------|
| **成本** | ¥9.9/年 | ¥60-80/月 |
| **性能** | 一般 | 优秀（内网访问） |
| **稳定性** | 基础 | 企业级 |
| **运维** | 手动 | 自动化 |
| **扩容** | 需迁移 | 一键扩容 |
| **备份** | 手动 | 自动备份 |
| **监控** | 无 | 完善的监控 |
| **适用场景** | 开发测试 | 生产环境 |

---

## ❓ 常见问题

### Q1: 本地开发如何连接云数据库？

**A**: 有三种方式：

**方式1：使用外网地址（推荐）**
```env
DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
DB_PORT=27821
```
需要在云数据库控制台配置您的公网IP到白名单。

**方式2：SSH 隧道**
```bash
# 通过云托管服务器建立 SSH 隧道
ssh -L 3306:10.32.104.72:3306 用户@云托管服务器IP

# 然后本地连接
DB_HOST=127.0.0.1
DB_PORT=3306
```

**方式3：使用云托管测试环境**
- 在云托管创建测试环境
- 测试环境可以直接访问内网数据库

### Q2: 数据库连接数不够怎么办？

**A**: 
1. 检查应用是否正确关闭连接
2. 调整连接池配置
3. 升级数据库规格（增加最大连接数）

### Q3: 如何进行数据迁移？

**A**: 参考下面的迁移方案

---

## 🔄 数据迁移方案（从 SQLPub 迁移）

如果您之前使用 SQLPub，现在要迁移到云托管：

### 步骤1：导出数据

```bash
# 从 SQLPub 导出
mysqldump -h mysql3.sqlpub.com -P 3308 -u david_x -p onefoodlibrary > backup.sql
```

### 步骤2：导入到云数据库

```bash
# 方式1：从云托管服务器导入（使用内网地址）
mysql -h 10.32.104.72 -P 3306 -u cooktip_admin -p cooktip < backup.sql

# 方式2：从本地导入（使用外网地址）
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u cooktip_admin -p cooktip < backup.sql
```

### 步骤3：验证数据

```sql
-- 检查数据量
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM recipes;
SELECT COUNT(*) FROM comments;
```

### 步骤4：切换配置

修改 `.env` 文件，更新数据库连接信息，重启应用。

---

## 📞 获取帮助

### 官方文档
- [微信云托管文档](https://cloud.weixin.qq.com/cloudrun/document)
- [云数据库文档](https://cloud.tencent.com/document/product/236)

### 技术支持
- 微信云托管工单系统
- 开发者社区：https://developers.weixin.qq.com/community

---

## ✅ 配置完成检查清单

完成以下检查确保配置正确：

- [ ] 已开通微信云托管 MySQL 实例
- [ ] 已创建数据库 `cooktip`
- [ ] 已创建数据库账号和密码
- [ ] 已获取内网连接地址
- [ ] 已配置 `.env` 文件
- [ ] 已执行 `database/init.sql` 初始化脚本
- [ ] 已验证 7 张表都创建成功
- [ ] 已验证分类数据（10条）
- [ ] 已配置云托管环境变量
- [ ] 应用可以成功连接数据库
- [ ] 已配置自动备份
- [ ] 已配置监控告警

---

**切换完成后，您将享受到更好的性能和稳定性！** 🚀

如有问题，请参考本文档或联系技术支持。

