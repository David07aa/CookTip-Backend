# 微信小程序登录开发文档

## 📋 功能概述

已完成微信小程序登录功能的开发，支持：
- ✅ 微信 code 换取 openid
- ✅ 自动注册/登录用户
- ✅ JWT Token 认证
- ✅ 用户信息更新
- ✅ Session Key 存储
- ✅ UnionID 支持（如果绑定了开放平台）

---

## 🗄️ 数据库结构

### users 表字段

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|---------|
| `id` | UUID | 用户唯一标识 | 自动生成 |
| `openid` | VARCHAR(100) | 微信 OpenID | 是（唯一） |
| `session_key` | VARCHAR(100) | 微信 Session Key | 否 |
| `union_id` | VARCHAR(100) | 微信 UnionID | 否 |
| `nick_name` | VARCHAR(100) | 用户昵称 | 否 |
| `avatar` | TEXT | 用户头像 URL | 否 |
| `bio` | TEXT | 个人简介 | 否 |
| `is_vip` | BOOLEAN | 是否VIP | 否（默认false） |
| `followers` | INTEGER | 粉丝数 | 否（默认0） |
| `following` | INTEGER | 关注数 | 否（默认0） |
| `total_likes` | INTEGER | 获赞总数 | 否（默认0） |
| `recipe_count` | INTEGER | 食谱数量 | 否（默认0） |
| `created_at` | TIMESTAMP | 创建时间 | 自动生成 |
| `updated_at` | TIMESTAMP | 更新时间 | 自动更新 |

---

## 🚀 部署步骤

### 1. 更新数据库 Schema

**方式一：通过 API（推荐）**

访问以下 URL（仅需执行一次）：
```
https://cooktip-backend.vercel.app/api/migrate/add-wechat-fields
```

**返回示例**：
```json
{
  "success": true,
  "message": "数据库 schema 更新完成",
  "data": {
    "fields": [
      { "name": "openid", "type": "character varying", "nullable": false },
      { "name": "session_key", "type": "character varying", "nullable": true },
      { "name": "union_id", "type": "character varying", "nullable": true }
    ],
    "message": "已成功添加微信登录相关字段"
  }
}
```

**方式二：直接执行 SQL**

在 Neon 控制台中执行 `scripts/add-wechat-fields.sql`。

---

### 2. 配置环境变量

在 Vercel 项目设置中添加以下环境变量：

| 变量名 | 说明 | 获取方式 |
|--------|------|---------|
| `WECHAT_APPID` | 小程序 AppID | 微信公众平台 → 开发 → 开发管理 → 开发设置 |
| `WECHAT_SECRET` | 小程序 AppSecret | 同上 |

**设置步骤**：
1. 访问 [Vercel Dashboard](https://vercel.com/davids-projects-688aeefc/cooktip-backend)
2. 进入项目 → Settings → Environment Variables
3. 添加两个环境变量
4. 选择所有环境（Production, Preview, Development）
5. 保存并重新部署

---

## 📡 API 接口

### 1. 微信登录接口

**接口地址**：
```
POST https://cooktip-backend.vercel.app/api/auth/wechat
```

**请求头**：
```
Content-Type: application/json
```

**请求体**：
```json
{
  "code": "081xyzABC...",    // 必填，wx.login() 获取的 code
  "nickName": "用户昵称",     // 可选，用户昵称
  "avatar": "头像URL"        // 可选，用户头像
}
```

**成功响应** (200)：
```json
{
  "code": 200,
  "message": "登录成功",  // 或 "注册成功"（新用户）
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "nickName": "用户昵称",
      "avatar": "https://...",
      "isVip": false,
      "isNewUser": true  // 是否是新注册用户
    }
  }
}
```

**失败响应** (401)：
```json
{
  "code": 401,
  "message": "微信登录失败",
  "data": {
    "error": "code已过期",
    "errcode": 40029
  }
}
```

---

## 💻 小程序端使用方法

### 1. 基础登录流程

```javascript
// 1. 在 app.js 或登录页面调用
async function doWechatLogin() {
  try {
    // 步骤1: 调用 wx.login() 获取 code
    const loginRes = await wx.login();
    
    if (!loginRes.code) {
      throw new Error('获取登录凭证失败');
    }
    
    console.log('获取到 code:', loginRes.code);
    
    // 步骤2: 可选 - 获取用户信息（需要用户授权）
    const userProfile = await wx.getUserProfile({
      desc: '用于完善用户资料'
    });
    
    // 步骤3: 将 code 和用户信息发送到后端
    const result = await wx.request({
      url: 'https://cooktip-backend.vercel.app/api/auth/wechat',
      method: 'POST',
      data: {
        code: loginRes.code,
        nickName: userProfile?.userInfo?.nickName,
        avatar: userProfile?.userInfo?.avatarUrl
      }
    });
    
    if (result.data.code === 200) {
      // 步骤4: 保存 token
      const { token, user } = result.data.data;
      
      wx.setStorageSync('token', token);
      wx.setStorageSync('userInfo', user);
      
      console.log('登录成功:', user);
      
      if (user.isNewUser) {
        wx.showToast({
          title: '注册成功',
          icon: 'success'
        });
      }
      
      // 跳转到首页或其他页面
      wx.switchTab({
        url: '/pages/index/index'
      });
      
      return true;
    } else {
      throw new Error(result.data.message);
    }
    
  } catch (error) {
    console.error('登录失败:', error);
    wx.showToast({
      title: error.message || '登录失败',
      icon: 'none'
    });
    return false;
  }
}
```

---

### 2. 封装为工具函数

创建 `utils/auth.js`：

```javascript
// utils/auth.js
const API_BASE = 'https://cooktip-backend.vercel.app/api';

/**
 * 微信登录
 * @param {Object} options - 配置项
 * @param {boolean} options.needUserInfo - 是否需要获取用户信息（默认 true）
 * @returns {Promise<Object>} 登录结果
 */
async function wechatLogin(options = {}) {
  const { needUserInfo = true } = options;
  
  try {
    // 1. 获取 code
    const { code } = await wx.login();
    
    let userData = { code };
    
    // 2. 如果需要用户信息，获取用户授权
    if (needUserInfo) {
      try {
        const { userInfo } = await wx.getUserProfile({
          desc: '用于完善用户资料'
        });
        
        userData.nickName = userInfo.nickName;
        userData.avatar = userInfo.avatarUrl;
      } catch (err) {
        // 用户拒绝授权，继续使用 code 登录
        console.log('用户未授权获取信息');
      }
    }
    
    // 3. 调用登录接口
    const { data } = await wx.request({
      url: `${API_BASE}/auth/wechat`,
      method: 'POST',
      data: userData
    });
    
    if (data.code !== 200) {
      throw new Error(data.message);
    }
    
    // 4. 保存 token 和用户信息
    const { token, user } = data.data;
    wx.setStorageSync('token', token);
    wx.setStorageSync('userInfo', user);
    
    return {
      success: true,
      token,
      user
    };
    
  } catch (error) {
    console.error('登录失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * 检查登录状态
 * @returns {boolean} 是否已登录
 */
function isLoggedIn() {
  const token = wx.getStorageSync('token');
  return !!token;
}

/**
 * 获取 Token
 * @returns {string} Token
 */
function getToken() {
  return wx.getStorageSync('token') || '';
}

/**
 * 获取用户信息
 * @returns {Object} 用户信息
 */
function getUserInfo() {
  return wx.getStorageSync('userInfo') || null;
}

/**
 * 退出登录
 */
function logout() {
  wx.removeStorageSync('token');
  wx.removeStorageSync('userInfo');
  
  // 跳转到登录页
  wx.reLaunch({
    url: '/pages/login/login'
  });
}

module.exports = {
  wechatLogin,
  isLoggedIn,
  getToken,
  getUserInfo,
  logout
};
```

---

### 3. 在页面中使用

```javascript
// pages/login/login.js
const auth = require('../../utils/auth');

Page({
  data: {},
  
  // 点击登录按钮
  async handleLogin() {
    wx.showLoading({ title: '登录中...' });
    
    const result = await auth.wechatLogin({
      needUserInfo: true  // 是否需要获取用户信息
    });
    
    wx.hideLoading();
    
    if (result.success) {
      wx.showToast({
        title: result.user.isNewUser ? '注册成功' : '登录成功',
        icon: 'success'
      });
      
      // 跳转到首页
      setTimeout(() => {
        wx.switchTab({
          url: '/pages/index/index'
        });
      }, 1500);
    } else {
      wx.showToast({
        title: result.error || '登录失败',
        icon: 'none'
      });
    }
  },
  
  // 静默登录（不获取用户信息）
  async silentLogin() {
    const result = await auth.wechatLogin({
      needUserInfo: false
    });
    
    if (result.success) {
      console.log('静默登录成功');
    }
  }
});
```

---

### 4. 请求拦截器（自动添加 Token）

创建 `utils/request.js`：

```javascript
// utils/request.js
const auth = require('./auth');

const API_BASE = 'https://cooktip-backend.vercel.app/api';

/**
 * 封装的请求方法
 * @param {Object} options - 请求配置
 */
function request(options) {
  return new Promise((resolve, reject) => {
    // 自动添加 token
    const token = auth.getToken();
    const header = options.header || {};
    
    if (token) {
      header.Authorization = `Bearer ${token}`;
    }
    
    wx.request({
      url: `${API_BASE}${options.url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        ...header
      },
      success: (res) => {
        if (res.statusCode === 401) {
          // Token 过期或无效，跳转到登录页
          wx.showToast({
            title: '登录已过期',
            icon: 'none'
          });
          
          auth.logout();
          reject(new Error('登录已过期'));
          return;
        }
        
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res.data);
        } else {
          reject(new Error(res.data.message || '请求失败'));
        }
      },
      fail: (err) => {
        console.error('请求失败:', err);
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        });
        reject(err);
      }
    });
  });
}

// 导出便捷方法
module.exports = {
  get: (url, data) => request({ url, method: 'GET', data }),
  post: (url, data) => request({ url, method: 'POST', data }),
  put: (url, data) => request({ url, method: 'PUT', data }),
  delete: (url, data) => request({ url, method: 'DELETE', data })
};
```

**使用示例**：

```javascript
// pages/recipe/detail.js
const request = require('../../utils/request');

Page({
  data: {
    recipe: null
  },
  
  async onLoad(options) {
    const { id } = options;
    
    try {
      // 自动带上 token
      const result = await request.get(`/recipes/${id}`);
      
      if (result.code === 200) {
        this.setData({
          recipe: result.data
        });
      }
    } catch (error) {
      wx.showToast({
        title: error.message,
        icon: 'none'
      });
    }
  }
});
```

---

## 🔐 Token 验证

其他需要登录的接口都可以使用中间件验证：

```javascript
// 示例：创建食谱接口
const { requireAuth } = require('../../middleware/auth');

module.exports = async (req, res) => {
  // 验证登录
  const authError = await requireAuth(req, res);
  if (authError) return;
  
  // req.user 中包含用户信息
  const userId = req.user.id;
  
  // 继续处理业务逻辑...
};
```

---

## 🧪 测试步骤

### 1. 更新数据库
```
访问: https://cooktip-backend.vercel.app/api/migrate/add-wechat-fields
```

### 2. 配置环境变量
在 Vercel 中添加 `WECHAT_APPID` 和 `WECHAT_SECRET`

### 3. 小程序端测试
```javascript
// 测试代码
wx.login({
  success: (res) => {
    wx.request({
      url: 'https://cooktip-backend.vercel.app/api/auth/wechat',
      method: 'POST',
      data: {
        code: res.code
      },
      success: (res) => {
        console.log('登录结果:', res.data);
      }
    });
  }
});
```

---

## 🔍 常见问题

### 1. code 已使用或过期

**错误**：`{ errcode: 40029, errmsg: "invalid code" }`

**原因**：每个 code 只能使用一次，5分钟内有效

**解决**：重新调用 `wx.login()` 获取新的 code

---

### 2. AppID 或 AppSecret 错误

**错误**：`{ errcode: 40013, errmsg: "invalid appid" }`

**解决**：检查 Vercel 环境变量是否正确配置

---

### 3. 获取不到 unionid

**原因**：需要满足以下条件之一：
- 小程序已绑定到微信开放平台
- 小程序已关联公众号，且用户已关注该公众号

**解决**：unionid 是可选的，不影响基础登录功能

---

### 4. Token 验证失败

**错误**：`401 Unauthorized`

**原因**：
- Token 已过期（默认7天）
- Token 格式不正确
- 请求头中没有携带 Authorization

**解决**：
- 检查请求头：`Authorization: Bearer <token>`
- Token 过期需要重新登录

---

## 📚 相关文档

- **API 接口文档**: `API接口文档.md`
- **前端对接文档**: `前端对接文档.md`
- **小程序配置指南**: `小程序配置指南.md`
- **微信官方文档**: https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html

---

**创建时间**: 2025-10-02  
**状态**: ✅ 已完成开发
**下一步**: 配置环境变量并测试

