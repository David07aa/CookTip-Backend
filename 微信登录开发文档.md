# å¾®ä¿¡å°ç¨‹åºç™»å½•å¼€å‘æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²å®Œæˆå¾®ä¿¡å°ç¨‹åºç™»å½•åŠŸèƒ½çš„å¼€å‘ï¼Œæ”¯æŒï¼š
- âœ… å¾®ä¿¡ code æ¢å– openid
- âœ… è‡ªåŠ¨æ³¨å†Œ/ç™»å½•ç”¨æˆ·
- âœ… JWT Token è®¤è¯
- âœ… ç”¨æˆ·ä¿¡æ¯æ›´æ–°
- âœ… Session Key å­˜å‚¨
- âœ… UnionID æ”¯æŒï¼ˆå¦‚æœç»‘å®šäº†å¼€æ”¾å¹³å°ï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### users è¡¨å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | æ˜¯å¦å¿…å¡« |
|--------|------|------|---------|
| `id` | UUID | ç”¨æˆ·å”¯ä¸€æ ‡è¯† | è‡ªåŠ¨ç”Ÿæˆ |
| `openid` | VARCHAR(100) | å¾®ä¿¡ OpenID | æ˜¯ï¼ˆå”¯ä¸€ï¼‰ |
| `session_key` | VARCHAR(100) | å¾®ä¿¡ Session Key | å¦ |
| `union_id` | VARCHAR(100) | å¾®ä¿¡ UnionID | å¦ |
| `nick_name` | VARCHAR(100) | ç”¨æˆ·æ˜µç§° | å¦ |
| `avatar` | TEXT | ç”¨æˆ·å¤´åƒ URL | å¦ |
| `bio` | TEXT | ä¸ªäººç®€ä»‹ | å¦ |
| `is_vip` | BOOLEAN | æ˜¯å¦VIP | å¦ï¼ˆé»˜è®¤falseï¼‰ |
| `followers` | INTEGER | ç²‰ä¸æ•° | å¦ï¼ˆé»˜è®¤0ï¼‰ |
| `following` | INTEGER | å…³æ³¨æ•° | å¦ï¼ˆé»˜è®¤0ï¼‰ |
| `total_likes` | INTEGER | è·èµæ€»æ•° | å¦ï¼ˆé»˜è®¤0ï¼‰ |
| `recipe_count` | INTEGER | é£Ÿè°±æ•°é‡ | å¦ï¼ˆé»˜è®¤0ï¼‰ |
| `created_at` | TIMESTAMP | åˆ›å»ºæ—¶é—´ | è‡ªåŠ¨ç”Ÿæˆ |
| `updated_at` | TIMESTAMP | æ›´æ–°æ—¶é—´ | è‡ªåŠ¨æ›´æ–° |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ›´æ–°æ•°æ®åº“ Schema

**æ–¹å¼ä¸€ï¼šé€šè¿‡ APIï¼ˆæ¨èï¼‰**

è®¿é—®ä»¥ä¸‹ URLï¼ˆä»…éœ€æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼š
```
https://cooktip-backend.vercel.app/api/migrate/add-wechat-fields
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "æ•°æ®åº“ schema æ›´æ–°å®Œæˆ",
  "data": {
    "fields": [
      { "name": "openid", "type": "character varying", "nullable": false },
      { "name": "session_key", "type": "character varying", "nullable": true },
      { "name": "union_id", "type": "character varying", "nullable": true }
    ],
    "message": "å·²æˆåŠŸæ·»åŠ å¾®ä¿¡ç™»å½•ç›¸å…³å­—æ®µ"
  }
}
```

**æ–¹å¼äºŒï¼šç›´æ¥æ‰§è¡Œ SQL**

åœ¨ Neon æ§åˆ¶å°ä¸­æ‰§è¡Œ `scripts/add-wechat-fields.sql`ã€‚

---

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

| å˜é‡å | è¯´æ˜ | è·å–æ–¹å¼ |
|--------|------|---------|
| `WECHAT_APPID` | å°ç¨‹åº AppID | å¾®ä¿¡å…¬ä¼—å¹³å° â†’ å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® |
| `WECHAT_SECRET` | å°ç¨‹åº AppSecret | åŒä¸Š |

**è®¾ç½®æ­¥éª¤**ï¼š
1. è®¿é—® [Vercel Dashboard](https://vercel.com/davids-projects-688aeefc/cooktip-backend)
2. è¿›å…¥é¡¹ç›® â†’ Settings â†’ Environment Variables
3. æ·»åŠ ä¸¤ä¸ªç¯å¢ƒå˜é‡
4. é€‰æ‹©æ‰€æœ‰ç¯å¢ƒï¼ˆProduction, Preview, Developmentï¼‰
5. ä¿å­˜å¹¶é‡æ–°éƒ¨ç½²

---

## ğŸ“¡ API æ¥å£

### 1. å¾®ä¿¡ç™»å½•æ¥å£

**æ¥å£åœ°å€**ï¼š
```
POST https://cooktip-backend.vercel.app/api/auth/wechat
```

**è¯·æ±‚å¤´**ï¼š
```
Content-Type: application/json
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "code": "081xyzABC...",    // å¿…å¡«ï¼Œwx.login() è·å–çš„ code
  "nickName": "ç”¨æˆ·æ˜µç§°",     // å¯é€‰ï¼Œç”¨æˆ·æ˜µç§°
  "avatar": "å¤´åƒURL"        // å¯é€‰ï¼Œç”¨æˆ·å¤´åƒ
}
```

**æˆåŠŸå“åº”** (200)ï¼š
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",  // æˆ– "æ³¨å†ŒæˆåŠŸ"ï¼ˆæ–°ç”¨æˆ·ï¼‰
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "nickName": "ç”¨æˆ·æ˜µç§°",
      "avatar": "https://...",
      "isVip": false,
      "isNewUser": true  // æ˜¯å¦æ˜¯æ–°æ³¨å†Œç”¨æˆ·
    }
  }
}
```

**å¤±è´¥å“åº”** (401)ï¼š
```json
{
  "code": 401,
  "message": "å¾®ä¿¡ç™»å½•å¤±è´¥",
  "data": {
    "error": "codeå·²è¿‡æœŸ",
    "errcode": 40029
  }
}
```

---

## ğŸ’» å°ç¨‹åºç«¯ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ç™»å½•æµç¨‹

```javascript
// 1. åœ¨ app.js æˆ–ç™»å½•é¡µé¢è°ƒç”¨
async function doWechatLogin() {
  try {
    // æ­¥éª¤1: è°ƒç”¨ wx.login() è·å– code
    const loginRes = await wx.login();
    
    if (!loginRes.code) {
      throw new Error('è·å–ç™»å½•å‡­è¯å¤±è´¥');
    }
    
    console.log('è·å–åˆ° code:', loginRes.code);
    
    // æ­¥éª¤2: å¯é€‰ - è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç”¨æˆ·æˆæƒï¼‰
    const userProfile = await wx.getUserProfile({
      desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™'
    });
    
    // æ­¥éª¤3: å°† code å’Œç”¨æˆ·ä¿¡æ¯å‘é€åˆ°åç«¯
    const result = await wx.request({
      url: 'https://cooktip-backend.vercel.app/api/auth/wechat',
      method: 'POST',
      data: {
        code: loginRes.code,
        nickName: userProfile?.userInfo?.nickName,
        avatar: userProfile?.userInfo?.avatarUrl
      }
    });
    
    if (result.data.code === 200) {
      // æ­¥éª¤4: ä¿å­˜ token
      const { token, user } = result.data.data;
      
      wx.setStorageSync('token', token);
      wx.setStorageSync('userInfo', user);
      
      console.log('ç™»å½•æˆåŠŸ:', user);
      
      if (user.isNewUser) {
        wx.showToast({
          title: 'æ³¨å†ŒæˆåŠŸ',
          icon: 'success'
        });
      }
      
      // è·³è½¬åˆ°é¦–é¡µæˆ–å…¶ä»–é¡µé¢
      wx.switchTab({
        url: '/pages/index/index'
      });
      
      return true;
    } else {
      throw new Error(result.data.message);
    }
    
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    wx.showToast({
      title: error.message || 'ç™»å½•å¤±è´¥',
      icon: 'none'
    });
    return false;
  }
}
```

---

### 2. å°è£…ä¸ºå·¥å…·å‡½æ•°

åˆ›å»º `utils/auth.js`ï¼š

```javascript
// utils/auth.js
const API_BASE = 'https://cooktip-backend.vercel.app/api';

/**
 * å¾®ä¿¡ç™»å½•
 * @param {Object} options - é…ç½®é¡¹
 * @param {boolean} options.needUserInfo - æ˜¯å¦éœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆé»˜è®¤ trueï¼‰
 * @returns {Promise<Object>} ç™»å½•ç»“æœ
 */
async function wechatLogin(options = {}) {
  const { needUserInfo = true } = options;
  
  try {
    // 1. è·å– code
    const { code } = await wx.login();
    
    let userData = { code };
    
    // 2. å¦‚æœéœ€è¦ç”¨æˆ·ä¿¡æ¯ï¼Œè·å–ç”¨æˆ·æˆæƒ
    if (needUserInfo) {
      try {
        const { userInfo } = await wx.getUserProfile({
          desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™'
        });
        
        userData.nickName = userInfo.nickName;
        userData.avatar = userInfo.avatarUrl;
      } catch (err) {
        // ç”¨æˆ·æ‹’ç»æˆæƒï¼Œç»§ç»­ä½¿ç”¨ code ç™»å½•
        console.log('ç”¨æˆ·æœªæˆæƒè·å–ä¿¡æ¯');
      }
    }
    
    // 3. è°ƒç”¨ç™»å½•æ¥å£
    const { data } = await wx.request({
      url: `${API_BASE}/auth/wechat`,
      method: 'POST',
      data: userData
    });
    
    if (data.code !== 200) {
      throw new Error(data.message);
    }
    
    // 4. ä¿å­˜ token å’Œç”¨æˆ·ä¿¡æ¯
    const { token, user } = data.data;
    wx.setStorageSync('token', token);
    wx.setStorageSync('userInfo', user);
    
    return {
      success: true,
      token,
      user
    };
    
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * æ£€æŸ¥ç™»å½•çŠ¶æ€
 * @returns {boolean} æ˜¯å¦å·²ç™»å½•
 */
function isLoggedIn() {
  const token = wx.getStorageSync('token');
  return !!token;
}

/**
 * è·å– Token
 * @returns {string} Token
 */
function getToken() {
  return wx.getStorageSync('token') || '';
}

/**
 * è·å–ç”¨æˆ·ä¿¡æ¯
 * @returns {Object} ç”¨æˆ·ä¿¡æ¯
 */
function getUserInfo() {
  return wx.getStorageSync('userInfo') || null;
}

/**
 * é€€å‡ºç™»å½•
 */
function logout() {
  wx.removeStorageSync('token');
  wx.removeStorageSync('userInfo');
  
  // è·³è½¬åˆ°ç™»å½•é¡µ
  wx.reLaunch({
    url: '/pages/login/login'
  });
}

module.exports = {
  wechatLogin,
  isLoggedIn,
  getToken,
  getUserInfo,
  logout
};
```

---

### 3. åœ¨é¡µé¢ä¸­ä½¿ç”¨

```javascript
// pages/login/login.js
const auth = require('../../utils/auth');

Page({
  data: {},
  
  // ç‚¹å‡»ç™»å½•æŒ‰é’®
  async handleLogin() {
    wx.showLoading({ title: 'ç™»å½•ä¸­...' });
    
    const result = await auth.wechatLogin({
      needUserInfo: true  // æ˜¯å¦éœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯
    });
    
    wx.hideLoading();
    
    if (result.success) {
      wx.showToast({
        title: result.user.isNewUser ? 'æ³¨å†ŒæˆåŠŸ' : 'ç™»å½•æˆåŠŸ',
        icon: 'success'
      });
      
      // è·³è½¬åˆ°é¦–é¡µ
      setTimeout(() => {
        wx.switchTab({
          url: '/pages/index/index'
        });
      }, 1500);
    } else {
      wx.showToast({
        title: result.error || 'ç™»å½•å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // é™é»˜ç™»å½•ï¼ˆä¸è·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
  async silentLogin() {
    const result = await auth.wechatLogin({
      needUserInfo: false
    });
    
    if (result.success) {
      console.log('é™é»˜ç™»å½•æˆåŠŸ');
    }
  }
});
```

---

### 4. è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨æ·»åŠ  Tokenï¼‰

åˆ›å»º `utils/request.js`ï¼š

```javascript
// utils/request.js
const auth = require('./auth');

const API_BASE = 'https://cooktip-backend.vercel.app/api';

/**
 * å°è£…çš„è¯·æ±‚æ–¹æ³•
 * @param {Object} options - è¯·æ±‚é…ç½®
 */
function request(options) {
  return new Promise((resolve, reject) => {
    // è‡ªåŠ¨æ·»åŠ  token
    const token = auth.getToken();
    const header = options.header || {};
    
    if (token) {
      header.Authorization = `Bearer ${token}`;
    }
    
    wx.request({
      url: `${API_BASE}${options.url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        ...header
      },
      success: (res) => {
        if (res.statusCode === 401) {
          // Token è¿‡æœŸæˆ–æ— æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          wx.showToast({
            title: 'ç™»å½•å·²è¿‡æœŸ',
            icon: 'none'
          });
          
          auth.logout();
          reject(new Error('ç™»å½•å·²è¿‡æœŸ'));
          return;
        }
        
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res.data);
        } else {
          reject(new Error(res.data.message || 'è¯·æ±‚å¤±è´¥'));
        }
      },
      fail: (err) => {
        console.error('è¯·æ±‚å¤±è´¥:', err);
        wx.showToast({
          title: 'ç½‘ç»œé”™è¯¯',
          icon: 'none'
        });
        reject(err);
      }
    });
  });
}

// å¯¼å‡ºä¾¿æ·æ–¹æ³•
module.exports = {
  get: (url, data) => request({ url, method: 'GET', data }),
  post: (url, data) => request({ url, method: 'POST', data }),
  put: (url, data) => request({ url, method: 'PUT', data }),
  delete: (url, data) => request({ url, method: 'DELETE', data })
};
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```javascript
// pages/recipe/detail.js
const request = require('../../utils/request');

Page({
  data: {
    recipe: null
  },
  
  async onLoad(options) {
    const { id } = options;
    
    try {
      // è‡ªåŠ¨å¸¦ä¸Š token
      const result = await request.get(`/recipes/${id}`);
      
      if (result.code === 200) {
        this.setData({
          recipe: result.data
        });
      }
    } catch (error) {
      wx.showToast({
        title: error.message,
        icon: 'none'
      });
    }
  }
});
```

---

## ğŸ” Token éªŒè¯

å…¶ä»–éœ€è¦ç™»å½•çš„æ¥å£éƒ½å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶éªŒè¯ï¼š

```javascript
// ç¤ºä¾‹ï¼šåˆ›å»ºé£Ÿè°±æ¥å£
const { requireAuth } = require('../../middleware/auth');

module.exports = async (req, res) => {
  // éªŒè¯ç™»å½•
  const authError = await requireAuth(req, res);
  if (authError) return;
  
  // req.user ä¸­åŒ…å«ç”¨æˆ·ä¿¡æ¯
  const userId = req.user.id;
  
  // ç»§ç»­å¤„ç†ä¸šåŠ¡é€»è¾‘...
};
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æ›´æ–°æ•°æ®åº“
```
è®¿é—®: https://cooktip-backend.vercel.app/api/migrate/add-wechat-fields
```

### 2. é…ç½®ç¯å¢ƒå˜é‡
åœ¨ Vercel ä¸­æ·»åŠ  `WECHAT_APPID` å’Œ `WECHAT_SECRET`

### 3. å°ç¨‹åºç«¯æµ‹è¯•
```javascript
// æµ‹è¯•ä»£ç 
wx.login({
  success: (res) => {
    wx.request({
      url: 'https://cooktip-backend.vercel.app/api/auth/wechat',
      method: 'POST',
      data: {
        code: res.code
      },
      success: (res) => {
        console.log('ç™»å½•ç»“æœ:', res.data);
      }
    });
  }
});
```

---

## ğŸ” å¸¸è§é—®é¢˜

### 1. code å·²ä½¿ç”¨æˆ–è¿‡æœŸ

**é”™è¯¯**ï¼š`{ errcode: 40029, errmsg: "invalid code" }`

**åŸå› **ï¼šæ¯ä¸ª code åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆ

**è§£å†³**ï¼šé‡æ–°è°ƒç”¨ `wx.login()` è·å–æ–°çš„ code

---

### 2. AppID æˆ– AppSecret é”™è¯¯

**é”™è¯¯**ï¼š`{ errcode: 40013, errmsg: "invalid appid" }`

**è§£å†³**ï¼šæ£€æŸ¥ Vercel ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®

---

### 3. è·å–ä¸åˆ° unionid

**åŸå› **ï¼šéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼š
- å°ç¨‹åºå·²ç»‘å®šåˆ°å¾®ä¿¡å¼€æ”¾å¹³å°
- å°ç¨‹åºå·²å…³è”å…¬ä¼—å·ï¼Œä¸”ç”¨æˆ·å·²å…³æ³¨è¯¥å…¬ä¼—å·

**è§£å†³**ï¼šunionid æ˜¯å¯é€‰çš„ï¼Œä¸å½±å“åŸºç¡€ç™»å½•åŠŸèƒ½

---

### 4. Token éªŒè¯å¤±è´¥

**é”™è¯¯**ï¼š`401 Unauthorized`

**åŸå› **ï¼š
- Token å·²è¿‡æœŸï¼ˆé»˜è®¤7å¤©ï¼‰
- Token æ ¼å¼ä¸æ­£ç¡®
- è¯·æ±‚å¤´ä¸­æ²¡æœ‰æºå¸¦ Authorization

**è§£å†³**ï¼š
- æ£€æŸ¥è¯·æ±‚å¤´ï¼š`Authorization: Bearer <token>`
- Token è¿‡æœŸéœ€è¦é‡æ–°ç™»å½•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **API æ¥å£æ–‡æ¡£**: `APIæ¥å£æ–‡æ¡£.md`
- **å‰ç«¯å¯¹æ¥æ–‡æ¡£**: `å‰ç«¯å¯¹æ¥æ–‡æ¡£.md`
- **å°ç¨‹åºé…ç½®æŒ‡å—**: `å°ç¨‹åºé…ç½®æŒ‡å—.md`
- **å¾®ä¿¡å®˜æ–¹æ–‡æ¡£**: https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html

---

**åˆ›å»ºæ—¶é—´**: 2025-10-02  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¼€å‘
**ä¸‹ä¸€æ­¥**: é…ç½®ç¯å¢ƒå˜é‡å¹¶æµ‹è¯•

