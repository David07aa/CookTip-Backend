# 🔧 微信登录401错误 - 完整诊断手册

## 📊 当前状态

| 项目 | 状态 | 说明 |
|------|------|------|
| 后端服务 | ✅ 正常 | 健康检查通过 |
| 云函数转发 | ✅ 正常 | HTTP请求成功到达后端 |
| 微信登录 | ❌ 失败 | 返回401 - "微信登录失败，请重试" |

## 🎯 问题定位

根据后端代码分析，401错误可能由以下原因导致：

1. **环境变量未配置**（最常见）
2. **环境变量配置错误**
3. **微信API调用失败**
4. **网络问题**

---

## 🚀 立即诊断（3步）

### 步骤1：重新部署后端（应用新代码）

1. 打开腾讯云控制台
2. 进入：**云托管** → **CookTip-Backend**
3. 点击：**版本管理** → **新建版本**
4. 部署方式选择：**代码仓库部署**
5. 等待部署完成（约2-5分钟）

### 步骤2：访问环境变量检查端点

部署完成后，访问以下URL（在浏览器打开）：

```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/health/env-check
```

**预期看到的响应**：

```json
{
  "status": "ok",
  "timestamp": "2025-10-16T14:30:00.000Z",
  "environment": {
    "nodeEnv": "production",
    "port": "80"
  },
  "wechat": {
    "appIdConfigured": true,     ← 必须是 true
    "appIdPrefix": "wx1234***",  ← 必须以 wx 开头
    "secretConfigured": true,    ← 必须是 true
    "secretLength": 32           ← 必须大于 0
  },
  "database": {
    "host": "sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com",
    "port": "23831",
    "database": "cooktip",
    "userConfigured": true
  }
}
```

### 步骤3：根据结果判断

#### ✅ 情况A：appIdConfigured = true, secretConfigured = true

**说明**：环境变量配置正确！

**下一步**：查看云托管后端日志，查找具体错误

1. 云托管 → 日志
2. 搜索关键字：`code2Session`
3. 查看微信API返回的具体错误码
4. 参考下面的"错误码对照表"

#### ❌ 情况B：appIdConfigured = false 或 secretConfigured = false

**说明**：环境变量未配置或未生效！

**立即解决**：

1. 云托管 → **环境变量** 标签
2. 点击 **"新增环境变量"**
3. 添加以下两个变量：
   ```
   键: WX_APPID
   值: wx... （你的小程序AppID，从微信公众平台复制）
   
   键: WX_SECRET
   值: ... （你的小程序AppSecret，从微信公众平台复制）
   ```
4. 点击 **"保存"**
5. **重启服务**（非常重要！）
6. 等待1-2分钟
7. 重新访问 `/health/env-check` 确认配置生效

---

## 📖 微信错误码对照表

如果环境变量配置正确，但仍然401错误，查看日志中的微信错误码：

| 错误码 | 错误信息 | 原因 | 解决方案 |
|--------|----------|------|----------|
| 40013 | invalid appid | AppID错误 | 从微信公众平台重新复制正确的AppID |
| 40125 | invalid appsecret | Secret错误 | 从微信公众平台重新复制正确的AppSecret |
| 40029 | code been used | code已使用 | ✅正常！微信code只能用一次，重新登录即可 |
| 40163 | code been used (v2) | code已使用 | ✅正常！重新登录即可 |
| 45011 | API minute-quota reach limit | API调用频率超限 | 等待1分钟后重试 |
| 45011 | API frequency out of limit | API调用频率超限 | 等待1分钟后重试 |

---

## 🔍 如何获取正确的AppID和AppSecret

### 步骤1：登录微信公众平台

访问：https://mp.weixin.qq.com/

### 步骤2：进入开发设置

左侧菜单：**开发管理** → **开发设置**

### 步骤3：复制信息

在 **"开发者ID"** 区域：

```
AppID (小程序ID)：  wx1234567890abcdef  ← 复制这个
AppSecret (小程序密钥)：  点击"生成"或"重置"  ← 复制这个
```

⚠️ **注意**：
- AppID 必须以 `wx` 开头
- AppSecret 是一长串随机字符（32位）
- 重置密钥后，旧密钥立即失效

---

## 🛠️ 完整操作流程（图文版）

### 1️⃣ 重新部署后端

```
腾讯云控制台
  └─ 云托管
      └─ 服务列表
          └─ CookTip-Backend
              └─ 版本管理
                  └─ 新建版本（选择代码仓库）
```

### 2️⃣ 检查环境变量

**方法1：通过API**
```
浏览器访问：
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/health/env-check
```

**方法2：通过控制台**
```
腾讯云控制台
  └─ 云托管
      └─ CookTip-Backend
          └─ 环境变量标签
```

### 3️⃣ 配置环境变量

```
点击"新增环境变量"
  
  键: WX_APPID
  值: wx1234567890abcdef
  保存
  
  键: WX_SECRET
  值: 32位随机字符串
  保存
```

### 4️⃣ 重启服务

```
服务详情页
  └─ 右上角"重启"按钮
  └─ 确认重启
  └─ 等待1-2分钟
```

### 5️⃣ 验证修复

```
重新访问：/health/env-check
  ✅ appIdConfigured: true
  ✅ secretConfigured: true

前端重新登录：
  ✅ 应该能成功！
```

---

## 📸 需要提供的信息

如果按照上述步骤操作后仍然失败，请提供：

1. **环境变量检查结果**（访问 `/health/env-check` 的完整响应）
2. **云托管后端日志截图**（搜索 `code2Session` 和 `微信`）
3. **前端错误截图**（完整的控制台日志）

---

## ⚡ 快速自助检查清单

操作前，先快速检查：

- [ ] 已重新部署后端（应用最新代码）
- [ ] 访问了 `/health/env-check` 端点
- [ ] `appIdConfigured` 和 `secretConfigured` 都是 `true`
- [ ] `appIdPrefix` 以 `wx` 开头
- [ ] `secretLength` 大于 0
- [ ] 配置环境变量后已重启服务
- [ ] 等待了1-2分钟让配置生效
- [ ] AppID 和 Secret 从小程序后台正确复制

---

## 🎯 最可能的问题

根据经验，**90%的401错误**是以下原因：

1. ❌ **环境变量未配置** → 在云托管控制台添加
2. ❌ **配置后未重启服务** → 点击重启按钮
3. ❌ **AppID/Secret复制错误** → 重新从微信公众平台复制
4. ❌ **新代码未部署** → 重新部署版本

---

**现在请按照上述步骤操作，并告诉我 `/health/env-check` 的返回结果！** 🚀

