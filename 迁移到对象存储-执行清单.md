# 🚀 迁移到对象存储 - 执行清单

## 📦 您的对象存储信息

- **存储桶**: `796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091`
- **地域**: `ap-shanghai`
- **基础URL**: `https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com`

---

## ✅ 立即执行（5步完成）

### 第1步：更新数据库（2分钟）

```bash
node update-to-storage.js
```

**作用**：将所有老乡鸡图片的URL从本地路径更新为对象存储URL

**预期结果**：
```
✅ 成功：192 条
✅ 数据库更新完成！
```

---

### 第2步：验证迁移结果（1分钟）

```bash
node verify-storage-urls.js
```

**预期结果**：
```
✅ 对象存储图片： 192 条
✅ 所有图片已迁移到对象存储！
✅ 图片访问成功！
```

---

### 第3步：浏览器测试（1分钟）

在浏览器打开任意示例URL（从步骤2的输出中复制）：

```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/大排面.png
```

**预期**：能看到图片 ✅

---

### 第4步：配置小程序域名白名单（3分钟）

1. **登录微信公众平台**
   ```
   https://mp.weixin.qq.com
   ```

2. **导航到配置页面**
   ```
   开发 → 开发管理 → 开发设置 → 服务器域名
   ```

3. **添加 downloadFile 合法域名**
   
   点击"修改"，在 downloadFile 合法域名中添加：
   ```
   https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
   ```

4. **保存配置**

⚠️ **重要**：配置后需要重新编译小程序才能生效！

---

### 第5步：小程序测试（2分钟）

1. **重新编译小程序**
2. **打开食谱列表页**
3. **检查图片是否正常显示**

**预期**：所有老乡鸡食谱的图片正常显示 ✅

---

## 🎉 完成！

如果以上5步都成功，恭喜您已完成迁移！

### 立即收益

✅ **ERR_CONNECTION_CLOSED 问题已解决**  
✅ **后端服务不再托管图片文件**  
✅ **服务稳定性大幅提升**  
✅ **图片加载速度更快（对象存储有CDN）**

---

## 🧹 后续优化（可选）

### 清理后端 uploads 目录

数据库迁移完成后，可以移除后端的 uploads 目录。

#### 已完成
✅ Dockerfile 已注释 `COPY uploads` 行

#### 需要手动操作

1. **更新 `.dockerignore`**

编辑 `.dockerignore` 文件，添加：
```
uploads
```

2. **提交更改**

```bash
git add Dockerfile .dockerignore
git commit -m "chore: 移除uploads目录，图片已迁移到对象存储"
git push origin main
```

3. **等待自动部署**

- GitHub推送后自动触发云托管部署
- 新镜像不再包含 uploads 目录

#### 收益

✅ **镜像大小减少** ~20MB  
✅ **部署速度更快**  
✅ **内存占用更低**

---

## 📊 验证服务稳定性

部署完成后，监控以下指标：

### 1. 内存使用

**之前**：512MB + 20MB (uploads) ≈ 532MB  
**现在**：512MB 左右  
**优化**：约 20MB

### 2. 响应时间

- 图片请求不再占用后端实例资源
- API响应更快

### 3. 错误率

- ERR_CONNECTION_CLOSED 错误应该消失
- 服务更稳定

---

## 🔍 监控和调试

### 查看云托管日志

```bash
# 实时日志
tcb fn log cooktip-api --tail

# 最近100条
tcb fn log cooktip-api --lines 100
```

### 检查数据库

```bash
# 运行验证脚本
node verify-storage-urls.js
```

### 测试API接口

```bash
# 获取食谱列表
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/recipes?limit=5

# 检查返回的 cover_image 字段是否使用对象存储URL
```

---

## 🆘 故障排查

### 问题1：图片显示403

**原因**：存储桶权限为私有

**解决**：
1. 进入对象存储控制台
2. 存储桶设置 → 权限管理
3. 设置为"公开读，私有写"

---

### 问题2：小程序报"域名不在白名单"

**原因**：未配置域名白名单

**解决**：
1. 按第4步配置域名白名单
2. 重新编译小程序

---

### 问题3：数据库更新失败

**检查**：
- 数据库连接配置是否正确
- 网络是否正常
- 查看错误提示

---

## 📋 最终检查清单

执行完毕后，请确认：

- [x] 图片已上传到对象存储（您已完成）
- [ ] 数据库已更新（运行 update-to-storage.js）
- [ ] 验证脚本通过（运行 verify-storage-urls.js）
- [ ] 浏览器能访问图片URL
- [ ] 小程序已配置域名白名单
- [ ] 小程序图片显示正常
- [ ] Dockerfile 已更新
- [ ] （可选）.dockerignore 已更新
- [ ] （可选）已重新部署

---

## 📞 需要帮助？

如有问题，请检查：

1. **对象存储配置说明.md** - 详细配置文档
2. **微信云托管对象存储迁移方案.md** - 完整迁移方案
3. 运行验证脚本查看详细信息

---

**开始时间**: _______________  
**完成时间**: _______________  
**执行人**: _______________

✅ 迁移成功！

