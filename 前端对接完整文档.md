# CookTip 前端对接完整文档

**版本**: v2.0  
**更新日期**: 2025-10-17  
**适用平台**: 微信小程序  
**后端版本**: NestJS v10.x

---

## 📋 目录

- [1. 快速开始](#1-快速开始)
- [2. 登录方式概览](#2-登录方式概览)
- [3. UI设计建议](#3-ui设计建议)
- [4. API接口详解](#4-api接口详解)
- [5. 完整代码示例](#5-完整代码示例)
- [6. 最佳实践](#6-最佳实践)
- [7. 常见问题](#7-常见问题)

---

## 1. 快速开始

### 1.1 环境配置

```json
// miniprogram/app.json
{
  "cloud": true,
  "plugins": {},
  "sitemapLocation": "sitemap.json"
}
```

### 1.2 API 基础信息

```javascript
// config.js
export const API_CONFIG = {
  baseURL: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1',
  timeout: 10000,
  cloudFunction: 'api-proxy' // 云函数名称
};

export const CDN_BASE = 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com';
```

**重要说明**：
- 🔔 **通过云函数调用时，路径不需要加 `/api/v1` 前缀**，云函数会自动添加
- 🔔 **直接HTTP调用时，需要完整路径**（包含 `/api/v1`）
- 例如：
  - ✅ 云函数调用：`path: '/auth/login'` 
  - ✅ HTTP调用：`https://xxx.com/api/v1/auth/login`

---

## 2. 登录方式概览

### 2.1 支持的登录方式

| 登录方式 | 接口 | 是否需要密码 | 适用场景 | 优先级 |
|---------|------|------------|---------|--------|
| **微信一键登录** | `/auth/wechat-login` | ❌ | 首次使用，快速注册 | ⭐⭐⭐⭐⭐ |
| **用户名密码** | `/auth/login` | ✅ | 已注册用户 | ⭐⭐⭐⭐ |
| **邮箱密码** | `/auth/login` | ✅ | 已绑定邮箱用户 | ⭐⭐⭐ |
| **手机号密码** | `/auth/login` | ✅ | 已绑定手机用户 | ⭐⭐⭐ |

### 2.2 登录流程图

```
┌─────────────────────────────────────┐
│    用户打开小程序                    │
└────────────┬────────────────────────┘
             │
             ↓
      ┌──────────┐
      │ 是否有Token? │
      └──────────┘
         │      │
    否   │      │   是
         │      └──────→ 直接进入首页
         ↓
    ┌─────────┐
    │ 登录页面 │
    └─────────┘
         │
    ┌────┴────┬────────┬────────┐
    │         │        │        │
    ↓         ↓        ↓        ↓
微信登录  用户名   邮箱    手机号
(推荐)    密码    密码     密码
```

---

## 3. UI设计建议

### 3.1 登录页面设计（多Tab）

#### 方案一：Tab切换式（推荐）⭐⭐⭐⭐⭐

```
┌─────────────────────────────────────┐
│          CookTip 美食菜谱            │
│                                     │
│  ┌───────┐  ┌───────┐  ┌───────┐  │
│  │微信登录│  │账号登录│  │注册账号│  │
│  └───┬───┘  └───────┘  └───────┘  │
│ ━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                     │
│    ┌─────────────────────┐        │
│    │                     │        │
│    │      [微信图标]      │        │
│    │                     │        │
│    │   微信一键登录注册    │        │
│    │                     │        │
│    └─────────────────────┘        │
│                                     │
│    安全便捷，无需记忆密码            │
│                                     │
└─────────────────────────────────────┘
```

#### 账号登录Tab

```
┌─────────────────────────────────────┐
│          CookTip 美食菜谱            │
│                                     │
│  ┌───────┐  ┌───────┐  ┌───────┐  │
│  │微信登录│  │账号登录│  │注册账号│  │
│  └───────┘  └───┬───┘  └───────┘  │
│ ━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━ │
│                                     │
│  账号：┌─────────────────────┐    │
│       │ 用户名/邮箱/手机号    │    │
│       └─────────────────────┘    │
│                                     │
│  密码：┌─────────────────────┐    │
│       │ ••••••••            │    │
│       └─────────────────────┘    │
│                                     │
│  [ ] 记住我        忘记密码？      │
│                                     │
│    ┌─────────────────────┐        │
│    │      登 录          │        │
│    └─────────────────────┘        │
│                                     │
│         还没有账号？去注册           │
│                                     │
└─────────────────────────────────────┘
```

#### 注册账号Tab

```
┌─────────────────────────────────────┐
│          CookTip 美食菜谱            │
│                                     │
│  ┌───────┐  ┌───────┐  ┌───────┐  │
│  │微信登录│  │账号登录│  │注册账号│  │
│  └───────┘  └───────┘  └───┬───┘  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━ │
│                                     │
│  用户名：┌─────────────────────┐  │
│         │ 3-50个字符          │  │
│         └─────────────────────┘  │
│                                     │
│  密码：  ┌─────────────────────┐  │
│         │ 至少6位，含大小写数字 │  │
│         └─────────────────────┘  │
│                                     │
│  邮箱：  ┌─────────────────────┐  │
│  (可选) │ example@email.com   │  │
│         └─────────────────────┘  │
│                                     │
│  手机号：┌─────────────────────┐  │
│  (可选) │ 13800138000         │  │
│         └─────────────────────┘  │
│                                     │
│    ┌─────────────────────┐        │
│    │      注 册          │        │
│    └─────────────────────┘        │
│                                     │
│        已有账号？去登录             │
│                                     │
└─────────────────────────────────────┘
```

### 3.2 个人中心 - 账号管理

```
┌─────────────────────────────────────┐
│  ←  账号与安全                       │
├─────────────────────────────────────┤
│                                     │
│  登录方式                            │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ 👤 用户名                      │ │
│  │    johndoe                    │ │
│  │                      主账号 ✓ │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ 📧 邮箱                        │ │
│  │    john@example.com           │ │
│  │                      已验证 ✓ │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ 📱 手机号                      │ │
│  │    138****8000                │ │
│  │                      待验证 ⚠ │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ 🔑 修改密码              →   │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ ➕ 绑定新账号            →   │ │
│  └───────────────────────────────┘ │
│                                     │
└─────────────────────────────────────┘
```

### 3.3 绑定账号弹窗

```
┌─────────────────────────────────────┐
│           绑定新账号                 │
├─────────────────────────────────────┤
│                                     │
│  选择类型：                          │
│  ┌────┐  ┌────┐  ┌────┐           │
│  │邮箱 │  │手机 │  │用户名│           │
│  └─┬──┘  └────┘  └────┘           │
│ ━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                     │
│  邮箱地址：┌─────────────────────┐ │
│           │ 输入邮箱地址         │ │
│           └─────────────────────┘ │
│                                     │
│  验证码：  ┌──────────┐           │
│           │ 6位验证码 │ [获取验证码]│
│           └──────────┘           │
│                                     │
│    ┌──────┐        ┌──────┐      │
│    │ 取消 │        │ 绑定 │      │
│    └──────┘        └──────┘      │
│                                     │
└─────────────────────────────────────┘
```

### 3.4 颜色和图标建议

```css
/* 主题色 */
--primary-color: #FF6B35;      /* 主色调（橙红色）*/
--success-color: #07C160;      /* 成功（绿色）*/
--warning-color: #FF976A;      /* 警告（浅橙色）*/
--danger-color: #FA5151;       /* 危险（红色）*/
--text-primary: #333333;       /* 主文本 */
--text-secondary: #999999;     /* 次要文本 */
--border-color: #EEEEEE;       /* 边框颜色 */
--bg-color: #F7F8FA;           /* 背景颜色 */

/* 登录按钮样式 */
.btn-wechat {
  background: linear-gradient(135deg, #07C160 0%, #06AE56 100%);
  color: white;
}

.btn-account {
  background: linear-gradient(135deg, #FF6B35 0%, #FF5722 100%);
  color: white;
}

.btn-register {
  background: linear-gradient(135deg, #576574 0%, #3D4752 100%);
  color: white;
}
```

### 3.5 页面路由设计

```javascript
// pages 目录结构
pages/
├── auth/
│   ├── login/            // 登录页（包含3个Tab）
│   │   ├── index.wxml
│   │   ├── index.wxss
│   │   └── index.js
│   ├── register/         // 注册页（如果需要独立页面）
│   │   ├── index.wxml
│   │   ├── index.wxss
│   │   └── index.js
│   └── bind-account/     // 绑定账号页
│       ├── index.wxml
│       ├── index.wxss
│       └── index.js
├── account/
│   ├── security/         // 账号安全
│   │   ├── index.wxml
│   │   ├── index.wxss
│   │   └── index.js
│   └── credentials/      // 凭证管理
│       ├── index.wxml
│       ├── index.wxss
│       └── index.js
└── profile/              // 个人中心
    ├── index.wxml
    ├── index.wxss
    └── index.js
```

---

## 4. API接口详解

### 4.1 微信一键登录

#### 接口信息
```
POST /auth/wechat-login
无需 Token
```

#### 前端实现
```javascript
// pages/auth/login/index.js
async wechatLogin() {
  try {
    wx.showLoading({ title: '登录中...' });
    
    // 1. 获取微信 code
    const { code } = await wx.login();
    
    // 2. 获取用户信息（可选）
    const userInfo = await this.getUserProfile();
    
    // 3. 调用后端接口
    const result = await wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'POST',
        path: '/auth/wechat-login',
        body: {
          code: code,
          nickname: userInfo?.nickName,
          avatar: userInfo?.avatarUrl
        }
      }
    });
    
    // 4. 保存 Token
    const { access_token, user } = result.result.data;
    wx.setStorageSync('token', access_token);
    wx.setStorageSync('userInfo', user);
    
    // 5. 跳转到首页
    wx.switchTab({ url: '/pages/index/index' });
    
    wx.hideLoading();
    wx.showToast({ title: '登录成功', icon: 'success' });
    
  } catch (error) {
    wx.hideLoading();
    wx.showToast({ 
      title: error.message || '登录失败', 
      icon: 'none' 
    });
  }
},

// 获取用户信息（需要用户授权）
async getUserProfile() {
  return new Promise((resolve) => {
    wx.getUserProfile({
      desc: '用于完善用户资料',
      success: (res) => resolve(res.userInfo),
      fail: () => resolve(null) // 用户拒绝也继续登录
    });
  });
}
```

### 4.2 用户名密码登录

#### 接口信息
```
POST /auth/login
无需 Token
限流：1分钟5次
```

#### 前端实现
```javascript
// pages/auth/login/index.js
data: {
  account: '',    // 用户名/邮箱/手机号
  password: '',
  rememberMe: false
},

async accountLogin() {
  // 1. 表单验证
  if (!this.data.account) {
    wx.showToast({ title: '请输入账号', icon: 'none' });
    return;
  }
  
  if (!this.data.password) {
    wx.showToast({ title: '请输入密码', icon: 'none' });
    return;
  }
  
  try {
    wx.showLoading({ title: '登录中...' });
    
    // 2. 调用登录接口
    const result = await wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'POST',
        path: '/auth/login',
        body: {
          account: this.data.account,
          password: this.data.password
        }
      }
    });
    
    // 3. 处理响应
    if (result.result.code === 200) {
      const { access_token, user } = result.result.data;
      
      // 保存 Token
      wx.setStorageSync('token', access_token);
      wx.setStorageSync('userInfo', user);
      
      // 记住账号
      if (this.data.rememberMe) {
        wx.setStorageSync('savedAccount', this.data.account);
      }
      
      wx.switchTab({ url: '/pages/index/index' });
      wx.showToast({ title: '登录成功', icon: 'success' });
    }
    
  } catch (error) {
    wx.showToast({ 
      title: error.message || '登录失败', 
      icon: 'none' 
    });
  } finally {
    wx.hideLoading();
  }
}
```

### 4.3 用户注册

#### 接口信息
```
POST /auth/register
无需 Token
限流：1分钟3次
```

#### 前端实现
```javascript
// pages/auth/register/index.js
data: {
  username: '',
  password: '',
  confirmPassword: '',
  email: '',
  phone: '',
  nickname: ''
},

async register() {
  // 1. 表单验证
  if (!this.validateForm()) return;
  
  try {
    wx.showLoading({ title: '注册中...' });
    
    const result = await wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'POST',
        path: '/auth/register',
        body: {
          username: this.data.username,
          password: this.data.password,
          email: this.data.email || undefined,
          phone: this.data.phone || undefined,
          nickname: this.data.nickname || undefined
        }
      }
    });
    
    if (result.result.code === 201) {
      const { access_token, user } = result.result.data;
      
      wx.setStorageSync('token', access_token);
      wx.setStorageSync('userInfo', user);
      
      wx.showToast({ title: '注册成功', icon: 'success' });
      
      setTimeout(() => {
        wx.switchTab({ url: '/pages/index/index' });
      }, 1500);
    }
    
  } catch (error) {
    const msg = error.message || '注册失败';
    wx.showToast({ title: msg, icon: 'none', duration: 2000 });
  } finally {
    wx.hideLoading();
  }
},

validateForm() {
  const { username, password, confirmPassword, email, phone } = this.data;
  
  // 用户名验证
  if (!username) {
    wx.showToast({ title: '请输入用户名', icon: 'none' });
    return false;
  }
  if (!/^[a-zA-Z0-9_-]{3,50}$/.test(username)) {
    wx.showToast({ 
      title: '用户名只能包含字母、数字、下划线和横线',
      icon: 'none',
      duration: 2000
    });
    return false;
  }
  
  // 密码验证
  if (!password) {
    wx.showToast({ title: '请输入密码', icon: 'none' });
    return false;
  }
  if (password.length < 6) {
    wx.showToast({ title: '密码至少6个字符', icon: 'none' });
    return false;
  }
  if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
    wx.showToast({ 
      title: '密码必须包含大小写字母和数字',
      icon: 'none',
      duration: 2000
    });
    return false;
  }
  
  // 确认密码
  if (password !== confirmPassword) {
    wx.showToast({ title: '两次密码不一致', icon: 'none' });
    return false;
  }
  
  // 邮箱验证（可选）
  if (email && !/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(email)) {
    wx.showToast({ title: '邮箱格式不正确', icon: 'none' });
    return false;
  }
  
  // 手机号验证（可选）
  if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
    wx.showToast({ title: '手机号格式不正确', icon: 'none' });
    return false;
  }
  
  return true;
}
```

### 4.4 获取用户凭证列表

#### 接口信息
```
GET /auth/credentials
需要 Token
```

#### 前端实现
```javascript
// pages/account/security/index.js
async loadCredentials() {
  try {
    wx.showLoading({ title: '加载中...' });
    
    const token = wx.getStorageSync('token');
    
    const result = await wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'GET',
        path: '/auth/credentials',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      }
    });
    
    if (result.result.code === 200) {
      this.setData({
        credentials: result.result.data.credentials
      });
    }
    
  } catch (error) {
    wx.showToast({ 
      title: '加载失败', 
      icon: 'none' 
    });
  } finally {
    wx.hideLoading();
  }
}
```

### 4.5 绑定新账号

#### 接口信息
```
POST /auth/bind-account
需要 Token
```

#### 前端实现
```javascript
// pages/account/bind/index.js
data: {
  type: 'email',  // email | phone | username
  account: '',
  verificationCode: ''
},

async bindAccount() {
  if (!this.data.account) {
    wx.showToast({ title: '请输入账号', icon: 'none' });
    return;
  }
  
  try {
    wx.showLoading({ title: '绑定中...' });
    
    const token = wx.getStorageSync('token');
    
    const result = await wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'POST',
        path: '/auth/bind-account',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: {
          type: this.data.type,
          account: this.data.account,
          verificationCode: this.data.verificationCode
        }
      }
    });
    
    if (result.result.code === 200) {
      wx.showToast({ title: '绑定成功', icon: 'success' });
      setTimeout(() => {
        wx.navigateBack();
      }, 1500);
    }
    
  } catch (error) {
    wx.showToast({ 
      title: error.message || '绑定失败', 
      icon: 'none' 
    });
  } finally {
    wx.hideLoading();
  }
}
```

### 4.6 解绑账号

#### 接口信息
```
DELETE /auth/credentials/:id
需要 Token
```

#### 前端实现
```javascript
async unbindAccount(credentialId) {
  // 确认对话框
  const confirmed = await this.showConfirm('确定要解绑该账号吗？');
  if (!confirmed) return;
  
  try {
    wx.showLoading({ title: '解绑中...' });
    
    const token = wx.getStorageSync('token');
    
    const result = await wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'DELETE',
        path: `/auth/credentials/${credentialId}`,
        headers: {
          'Authorization': `Bearer ${token}`
        }
      }
    });
    
    if (result.result.code === 200) {
      wx.showToast({ title: '解绑成功', icon: 'success' });
      this.loadCredentials(); // 刷新列表
    }
    
  } catch (error) {
    wx.showToast({ 
      title: error.message || '解绑失败', 
      icon: 'none' 
    });
  } finally {
    wx.hideLoading();
  }
},

showConfirm(content) {
  return new Promise((resolve) => {
    wx.showModal({
      title: '提示',
      content,
      success: (res) => resolve(res.confirm)
    });
  });
}
```

### 4.7 修改密码

#### 接口信息
```
POST /auth/set-password
需要 Token
```

#### 前端实现
```javascript
// pages/account/change-password/index.js
data: {
  newPassword: '',
  confirmPassword: ''
},

async changePassword() {
  const { newPassword, confirmPassword } = this.data;
  
  // 验证
  if (!newPassword) {
    wx.showToast({ title: '请输入新密码', icon: 'none' });
    return;
  }
  
  if (newPassword.length < 6) {
    wx.showToast({ title: '密码至少6个字符', icon: 'none' });
    return;
  }
  
  if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(newPassword)) {
    wx.showToast({ 
      title: '密码必须包含大小写字母和数字',
      icon: 'none',
      duration: 2000
    });
    return;
  }
  
  if (newPassword !== confirmPassword) {
    wx.showToast({ title: '两次密码不一致', icon: 'none' });
    return;
  }
  
  try {
    wx.showLoading({ title: '修改中...' });
    
    const token = wx.getStorageSync('token');
    
    const result = await wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'POST',
        path: '/auth/set-password',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: {
          password: newPassword
        }
      }
    });
    
    if (result.result.code === 200) {
      wx.showToast({ title: '修改成功', icon: 'success' });
      setTimeout(() => {
        wx.navigateBack();
      }, 1500);
    }
    
  } catch (error) {
    wx.showToast({ 
      title: error.message || '修改失败', 
      icon: 'none' 
    });
  } finally {
    wx.hideLoading();
  }
}
```

---

## 5. 完整代码示例

### 5.1 登录页面完整代码

#### index.wxml
```xml
<!-- pages/auth/login/index.wxml -->
<view class="login-container">
  <!-- 顶部Logo -->
  <view class="header">
    <image class="logo" src="/images/logo.png" mode="aspectFit" />
    <text class="app-name">CookTip 美食菜谱</text>
    <text class="slogan">发现美食，享受生活</text>
  </view>

  <!-- Tab切换 -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === 0 ? 'active' : ''}}"
      bindtap="switchTab"
      data-index="0"
    >
      微信登录
    </view>
    <view 
      class="tab-item {{activeTab === 1 ? 'active' : ''}}"
      bindtap="switchTab"
      data-index="1"
    >
      账号登录
    </view>
    <view 
      class="tab-item {{activeTab === 2 ? 'active' : ''}}"
      bindtap="switchTab"
      data-index="2"
    >
      注册账号
    </view>
  </view>

  <!-- Tab内容 -->
  <view class="tab-content">
    <!-- 微信登录 -->
    <view class="tab-panel" wx:if="{{activeTab === 0}}">
      <view class="wechat-login">
        <image class="wechat-icon" src="/images/wechat.png" />
        <text class="wechat-text">微信一键登录注册</text>
        <button 
          class="btn btn-wechat" 
          bindtap="wechatLogin"
        >
          立即登录
        </button>
        <text class="tips">安全便捷，无需记忆密码</text>
      </view>
    </view>

    <!-- 账号登录 -->
    <view class="tab-panel" wx:if="{{activeTab === 1}}">
      <view class="form">
        <view class="form-item">
          <text class="label">账号</text>
          <input 
            class="input" 
            placeholder="用户名/邮箱/手机号"
            value="{{account}}"
            bindinput="onAccountInput"
          />
        </view>
        <view class="form-item">
          <text class="label">密码</text>
          <input 
            class="input" 
            type="password"
            placeholder="请输入密码"
            value="{{password}}"
            bindinput="onPasswordInput"
          />
        </view>
        <view class="form-options">
          <label class="checkbox">
            <checkbox checked="{{rememberMe}}" bindtap="toggleRemember" />
            记住我
          </label>
          <text class="link">忘记密码？</text>
        </view>
        <button class="btn btn-account" bindtap="accountLogin">
          登录
        </button>
      </view>
    </view>

    <!-- 注册账号 -->
    <view class="tab-panel" wx:if="{{activeTab === 2}}">
      <view class="form">
        <view class="form-item">
          <text class="label">用户名 *</text>
          <input 
            class="input" 
            placeholder="3-50个字符"
            value="{{registerForm.username}}"
            data-field="username"
            bindinput="onRegisterInput"
          />
        </view>
        <view class="form-item">
          <text class="label">密码 *</text>
          <input 
            class="input" 
            type="password"
            placeholder="至少6位，含大小写数字"
            value="{{registerForm.password}}"
            data-field="password"
            bindinput="onRegisterInput"
          />
        </view>
        <view class="form-item">
          <text class="label">确认密码 *</text>
          <input 
            class="input" 
            type="password"
            placeholder="再次输入密码"
            value="{{registerForm.confirmPassword}}"
            data-field="confirmPassword"
            bindinput="onRegisterInput"
          />
        </view>
        <view class="form-item">
          <text class="label">邮箱</text>
          <input 
            class="input" 
            placeholder="选填"
            value="{{registerForm.email}}"
            data-field="email"
            bindinput="onRegisterInput"
          />
        </view>
        <view class="form-item">
          <text class="label">手机号</text>
          <input 
            class="input" 
            placeholder="选填"
            value="{{registerForm.phone}}"
            data-field="phone"
            bindinput="onRegisterInput"
          />
        </view>
        <button class="btn btn-register" bindtap="register">
          注册
        </button>
      </view>
    </view>
  </view>
</view>
```

#### index.js
```javascript
// pages/auth/login/index.js
Page({
  data: {
    activeTab: 0,
    account: '',
    password: '',
    rememberMe: false,
    registerForm: {
      username: '',
      password: '',
      confirmPassword: '',
      email: '',
      phone: ''
    }
  },

  onLoad() {
    // 检查是否已登录
    const token = wx.getStorageSync('token');
    if (token) {
      wx.switchTab({ url: '/pages/index/index' });
      return;
    }

    // 读取记住的账号
    const savedAccount = wx.getStorageSync('savedAccount');
    if (savedAccount) {
      this.setData({ 
        account: savedAccount,
        rememberMe: true
      });
    }
  },

  // 切换Tab
  switchTab(e) {
    const index = e.currentTarget.dataset.index;
    this.setData({ activeTab: index });
  },

  // 输入处理
  onAccountInput(e) {
    this.setData({ account: e.detail.value });
  },

  onPasswordInput(e) {
    this.setData({ password: e.detail.value });
  },

  toggleRemember() {
    this.setData({ rememberMe: !this.data.rememberMe });
  },

  onRegisterInput(e) {
    const field = e.currentTarget.dataset.field;
    this.setData({
      [`registerForm.${field}`]: e.detail.value
    });
  },

  // 微信登录
  async wechatLogin() {
    try {
      wx.showLoading({ title: '登录中...' });

      const { code } = await wx.login();
      const userInfo = await this.getUserProfile();

      const result = await wx.cloud.callFunction({
        name: 'api-proxy',
        data: {
          method: 'POST',
          path: '/auth/wechat-login',
          body: {
            code,
            nickname: userInfo?.nickName,
            avatar: userInfo?.avatarUrl
          }
        }
      });

      if (result.result.code === 200) {
        const { access_token, user } = result.result.data;
        wx.setStorageSync('token', access_token);
        wx.setStorageSync('userInfo', user);

        wx.switchTab({ url: '/pages/index/index' });
        wx.showToast({ title: '登录成功', icon: 'success' });
      }

    } catch (error) {
      wx.showToast({ 
        title: error.message || '登录失败', 
        icon: 'none' 
      });
    } finally {
      wx.hideLoading();
    }
  },

  // 账号登录
  async accountLogin() {
    if (!this.data.account) {
      wx.showToast({ title: '请输入账号', icon: 'none' });
      return;
    }

    if (!this.data.password) {
      wx.showToast({ title: '请输入密码', icon: 'none' });
      return;
    }

    try {
      wx.showLoading({ title: '登录中...' });

      const result = await wx.cloud.callFunction({
        name: 'api-proxy',
        data: {
          method: 'POST',
          path: '/auth/login',
          body: {
            account: this.data.account,
            password: this.data.password
          }
        }
      });

      if (result.result.code === 200) {
        const { access_token, user } = result.result.data;
        wx.setStorageSync('token', access_token);
        wx.setStorageSync('userInfo', user);

        if (this.data.rememberMe) {
          wx.setStorageSync('savedAccount', this.data.account);
        } else {
          wx.removeStorageSync('savedAccount');
        }

        wx.switchTab({ url: '/pages/index/index' });
        wx.showToast({ title: '登录成功', icon: 'success' });
      }

    } catch (error) {
      wx.showToast({ 
        title: error.message || '登录失败', 
        icon: 'none' 
      });
    } finally {
      wx.hideLoading();
    }
  },

  // 注册
  async register() {
    const form = this.data.registerForm;

    // 表单验证
    if (!this.validateRegisterForm(form)) return;

    try {
      wx.showLoading({ title: '注册中...' });

      const result = await wx.cloud.callFunction({
        name: 'api-proxy',
        data: {
          method: 'POST',
          path: '/auth/register',
          body: {
            username: form.username,
            password: form.password,
            email: form.email || undefined,
            phone: form.phone || undefined
          }
        }
      });

      if (result.result.code === 201) {
        const { access_token, user } = result.result.data;
        wx.setStorageSync('token', access_token);
        wx.setStorageSync('userInfo', user);

        wx.showToast({ title: '注册成功', icon: 'success' });
        setTimeout(() => {
          wx.switchTab({ url: '/pages/index/index' });
        }, 1500);
      }

    } catch (error) {
      wx.showToast({ 
        title: error.message || '注册失败', 
        icon: 'none',
        duration: 2000
      });
    } finally {
      wx.hideLoading();
    }
  },

  // 表单验证
  validateRegisterForm(form) {
    if (!form.username) {
      wx.showToast({ title: '请输入用户名', icon: 'none' });
      return false;
    }

    if (!/^[a-zA-Z0-9_-]{3,50}$/.test(form.username)) {
      wx.showToast({ 
        title: '用户名只能包含字母、数字、下划线和横线',
        icon: 'none',
        duration: 2000
      });
      return false;
    }

    if (!form.password || form.password.length < 6) {
      wx.showToast({ title: '密码至少6个字符', icon: 'none' });
      return false;
    }

    if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(form.password)) {
      wx.showToast({ 
        title: '密码必须包含大小写字母和数字',
        icon: 'none',
        duration: 2000
      });
      return false;
    }

    if (form.password !== form.confirmPassword) {
      wx.showToast({ title: '两次密码不一致', icon: 'none' });
      return false;
    }

    if (form.email && !/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(form.email)) {
      wx.showToast({ title: '邮箱格式不正确', icon: 'none' });
      return false;
    }

    if (form.phone && !/^1[3-9]\d{9}$/.test(form.phone)) {
      wx.showToast({ title: '手机号格式不正确', icon: 'none' });
      return false;
    }

    return true;
  },

  // 获取用户信息
  getUserProfile() {
    return new Promise((resolve) => {
      wx.getUserProfile({
        desc: '用于完善用户资料',
        success: (res) => resolve(res.userInfo),
        fail: () => resolve(null)
      });
    });
  }
});
```

#### index.wxss
```css
/* pages/auth/login/index.wxss */
.login-container {
  min-height: 100vh;
  background: linear-gradient(180deg, #FF6B35 0%, #FFFFFF 40%);
  padding: 60rpx 40rpx;
}

.header {
  text-align: center;
  margin-bottom: 80rpx;
}

.logo {
  width: 160rpx;
  height: 160rpx;
  margin-bottom: 24rpx;
}

.app-name {
  display: block;
  font-size: 48rpx;
  font-weight: bold;
  color: white;
  margin-bottom: 16rpx;
}

.slogan {
  display: block;
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.9);
}

/* Tab样式 */
.tabs {
  display: flex;
  background: white;
  border-radius: 16rpx 16rpx 0 0;
  overflow: hidden;
}

.tab-item {
  flex: 1;
  text-align: center;
  padding: 32rpx 0;
  font-size: 30rpx;
  color: #999;
  position: relative;
}

.tab-item.active {
  color: #FF6B35;
  font-weight: bold;
}

.tab-item.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60rpx;
  height: 6rpx;
  background: #FF6B35;
  border-radius: 3rpx;
}

/* Tab内容 */
.tab-content {
  background: white;
  border-radius: 0 0 16rpx 16rpx;
  padding: 60rpx 40rpx;
  min-height: 600rpx;
}

/* 微信登录样式 */
.wechat-login {
  text-align: center;
  padding: 60rpx 0;
}

.wechat-icon {
  width: 160rpx;
  height: 160rpx;
  margin-bottom: 40rpx;
}

.wechat-text {
  display: block;
  font-size: 32rpx;
  color: #333;
  margin-bottom: 60rpx;
}

.tips {
  display: block;
  margin-top: 24rpx;
  font-size: 24rpx;
  color: #999;
}

/* 表单样式 */
.form {
  padding: 20rpx 0;
}

.form-item {
  margin-bottom: 40rpx;
}

.label {
  display: block;
  font-size: 28rpx;
  color: #333;
  margin-bottom: 16rpx;
}

.input {
  width: 100%;
  height: 88rpx;
  padding: 0 24rpx;
  background: #F7F8FA;
  border-radius: 12rpx;
  font-size: 28rpx;
}

.form-options {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 40rpx;
  font-size: 26rpx;
}

.checkbox {
  color: #666;
}

.link {
  color: #FF6B35;
}

/* 按钮样式 */
.btn {
  width: 100%;
  height: 88rpx;
  line-height: 88rpx;
  border-radius: 44rpx;
  font-size: 32rpx;
  font-weight: bold;
  border: none;
}

.btn-wechat {
  background: linear-gradient(135deg, #07C160 0%, #06AE56 100%);
  color: white;
}

.btn-account {
  background: linear-gradient(135deg, #FF6B35 0%, #FF5722 100%);
  color: white;
}

.btn-register {
  background: linear-gradient(135deg, #576574 0%, #3D4752 100%);
  color: white;
}

.btn::after {
  border: none;
}
```

---

## 6. 最佳实践

### 6.1 Token 管理

```javascript
// utils/auth.js
class AuthManager {
  // 保存 Token
  static saveToken(token) {
    wx.setStorageSync('token', token);
    wx.setStorageSync('tokenTime', Date.now());
  }

  // 获取 Token
  static getToken() {
    return wx.getStorageSync('token');
  }

  // 检查 Token 是否过期（7天）
  static isTokenExpired() {
    const tokenTime = wx.getStorageSync('tokenTime');
    if (!tokenTime) return true;
    
    const days = (Date.now() - tokenTime) / (1000 * 60 * 60 * 24);
    return days > 7;
  }

  // 清除 Token
  static clearToken() {
    wx.removeStorageSync('token');
    wx.removeStorageSync('tokenTime');
    wx.removeStorageSync('userInfo');
  }

  // 检查登录状态
  static checkLogin() {
    const token = this.getToken();
    if (!token || this.isTokenExpired()) {
      this.clearToken();
      wx.redirectTo({ url: '/pages/auth/login/index' });
      return false;
    }
    return true;
  }
}

module.exports = AuthManager;
```

### 6.2 API 请求封装

```javascript
// utils/request.js
const AuthManager = require('./auth');

class Request {
  static async call(options) {
    const { method, path, body, headers = {}, needAuth = true } = options;

    // 添加 Token
    if (needAuth) {
      const token = AuthManager.getToken();
      if (!token) {
        wx.redirectTo({ url: '/pages/auth/login/index' });
        throw new Error('请先登录');
      }
      headers.Authorization = `Bearer ${token}`;
    }

    try {
      const result = await wx.cloud.callFunction({
        name: 'api-proxy',
        data: {
          method,
          path,
          body,
          headers
        }
      });

      // Token 过期处理
      if (result.result.code === 401) {
        AuthManager.clearToken();
        wx.redirectTo({ url: '/pages/auth/login/index' });
        throw new Error('登录已过期');
      }

      return result.result;

    } catch (error) {
      console.error('API请求失败:', error);
      throw error;
    }
  }

  // GET 请求
  static get(path, needAuth = true) {
    return this.call({ method: 'GET', path, needAuth });
  }

  // POST 请求
  static post(path, body, needAuth = true) {
    return this.call({ method: 'POST', path, body, needAuth });
  }

  // PUT 请求
  static put(path, body, needAuth = true) {
    return this.call({ method: 'PUT', path, body, needAuth });
  }

  // DELETE 请求
  static delete(path, needAuth = true) {
    return this.call({ method: 'DELETE', path, needAuth });
  }
}

module.exports = Request;
```

### 6.3 使用示例

```javascript
// pages/some-page/index.js
const Request = require('../../utils/request');
const AuthManager = require('../../utils/auth');

Page({
  onLoad() {
    // 检查登录状态
    if (!AuthManager.checkLogin()) return;
    
    this.loadData();
  },

  async loadData() {
    try {
      const result = await Request.get('/recipes');
      if (result.code === 200) {
        this.setData({ recipes: result.data.items });
      }
    } catch (error) {
      wx.showToast({ title: '加载失败', icon: 'none' });
    }
  }
});
```

### 6.4 全局登录拦截

```javascript
// app.js
const AuthManager = require('./utils/auth');

App({
  onLaunch() {
    // 初始化云开发
    wx.cloud.init({
      env: 'your-env-id',
      traceUser: true
    });
  },

  onShow() {
    // 检查 Token 是否过期
    if (AuthManager.isTokenExpired()) {
      const pages = getCurrentPages();
      const currentPage = pages[pages.length - 1];
      
      // 非登录页才跳转
      if (!currentPage.route.includes('auth/login')) {
        AuthManager.clearToken();
        wx.redirectTo({ url: '/pages/auth/login/index' });
      }
    }
  }
});
```

---

## 7. 常见问题

### Q1: 所有登录接口返回 404 错误怎么办？

**错误信息**：
```
Cannot POST /auth/wechat-login (404 Not Found)
Cannot POST /auth/login (404 Not Found)
```

**原因**：云函数没有最新的代码（缺少自动添加 `/api/v1` 前缀的逻辑）

**解决方案**：

1. **快速部署（推荐）**
   ```powershell
   # Windows
   .\scripts\deploy-api-proxy.ps1
   
   # Mac/Linux
   bash scripts/deploy-api-proxy.sh
   ```

2. **手动部署**
   - 打开微信开发者工具
   - 找到 `cloudfunctions/api-proxy` 文件夹
   - 右键 → **上传并部署：云端安装依赖**
   - 等待 1-2 分钟生效

3. **验证修复**
   ```javascript
   // 在小程序控制台测试
   wx.cloud.callFunction({
     name: 'api-proxy',
     data: {
       method: 'GET',
       path: '/health'  // 不需要 /api/v1 前缀
     }
   }).then(res => console.log('✅ 修复成功', res))
   ```

📚 **详细文档**: `修复404错误-部署指南.md`

---

### Q2: 用户忘记密码怎么办？

**A:** 目前暂不支持密码重置功能。建议：
1. 如果绑定了微信，可以使用微信登录
2. 联系客服重置密码
3. 后续版本会添加邮箱/手机号验证码重置功能

### Q3: 一个微信号可以绑定多个账号吗？

**A:** 不可以。一个微信 OpenID 只能对应一个用户账号。但一个用户账号可以绑定多种登录方式（用户名、邮箱、手机号）。

---

### Q4: 如何实现自动登录？

**A:** Token 有效期为 7 天，只需在 `app.onLaunch()` 时检查 Token 是否有效即可：

```javascript
// app.js
onLaunch() {
  const token = wx.getStorageSync('token');
  if (token && !AuthManager.isTokenExpired()) {
    // Token 有效，自动登录
    this.globalData.isLoggedIn = true;
  }
}
```

### Q5: 如何处理 Token 过期？

**A:** 在 API 请求封装中统一处理 401 错误：

```javascript
if (result.code === 401) {
  AuthManager.clearToken();
  wx.redirectTo({ url: '/pages/auth/login/index' });
}
```

### Q6: 微信登录失败怎么办？

**A:** 常见原因：
1. 检查小程序 AppID 和 AppSecret 配置
2. 确保后端服务正常运行
3. 查看云函数日志
4. 确认网络连接正常

### Q7: 如何在开发时测试不同登录方式？

**A:** 建议流程：
1. 先测试微信登录（最常用）
2. 注册一个测试账号
3. 测试用户名/邮箱/手机号登录
4. 测试账号绑定功能

---

## 📞 技术支持

### 相关文档
- **项目架构文档.md** - 后端架构说明
- **后端API开发文档.md** - 完整 API 参考
- **云函数部署完整指南.md** - 云函数部署

### API 地址
- **生产环境**: `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1`
- **Swagger 文档**: `/api/docs`

### 联系方式
- GitHub: [CookTip-Backend](https://github.com/David07aa/CookTip-Backend)
- Email: 3509204288@qq.com

---

## 📝 更新日志

### v2.0 (2025-10-17)
- ✅ 新增用户名密码登录
- ✅ 新增用户注册功能
- ✅ 新增账号绑定功能
- ✅ 支持邮箱/手机号登录
- ✅ 优化 UI 设计
- ✅ 完善安全机制

### v1.0
- ✅ 微信登录
- ✅ 基础 API 功能

---

**文档版本**: v2.0  
**最后更新**: 2025-10-17  
**维护者**: CookTip 开发团队

🎉 **祝开发顺利！**

