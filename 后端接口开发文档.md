# ğŸ”Œ CookTip åç«¯æ¥å£å¼€å‘æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ1æ—¥  
**é€‚ç”¨é¡¹ç›®**: CookTip ç¾é£Ÿé£Ÿè°±å°ç¨‹åº

---

## ğŸ“‹ ç›®å½•

1. [å¾®ä¿¡ç™»å½•æ¥å£](#å¾®ä¿¡ç™»å½•æ¥å£)
2. [æ¥å£è°ƒç”¨æµç¨‹](#æ¥å£è°ƒç”¨æµç¨‹)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [é”™è¯¯ç è§„èŒƒ](#é”™è¯¯ç è§„èŒƒ)
5. [å®‰å…¨å»ºè®®](#å®‰å…¨å»ºè®®)
6. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ğŸ” å¾®ä¿¡ç™»å½•æ¥å£

### æ¥å£åœ°å€
```
POST /api/auth/wechat
```

### æ¥å£è¯´æ˜
ç”¨äºå¾®ä¿¡å°ç¨‹åºç”¨æˆ·ç™»å½•/æ³¨å†Œã€‚åç«¯éœ€è¦ä½¿ç”¨å‰ç«¯ä¼ æ¥çš„ `code` è°ƒç”¨å¾®ä¿¡æœåŠ¡å™¨æ¥å£æ¢å– `openid`ï¼Œç„¶ååˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œæœ€åè¿”å› JWT tokenã€‚

---

### è¯·æ±‚å‚æ•°

#### Headers
```
Content-Type: application/json
```

#### Body (JSON)
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| code | String | âœ… æ˜¯ | å¾®ä¿¡ç™»å½•å‡­è¯ï¼Œé€šè¿‡ wx.login() è·å– | `"0x1abc2def..."` |
| nickName | String | âŒ å¦ | ç”¨æˆ·æ˜µç§°ï¼ˆç”¨æˆ·æˆæƒåæ‰æœ‰ï¼‰ | `"å¼ ä¸‰"` |
| avatar | String | âŒ å¦ | ç”¨æˆ·å¤´åƒ URLï¼ˆç”¨æˆ·æˆæƒåæ‰æœ‰ï¼‰ | `"https://..."` |

#### è¯·æ±‚ç¤ºä¾‹
```json
{
  "code": "0x1abc2def3g4h5i6j7k8l9m0n",
  "nickName": "å¼ ä¸‰",
  "avatar": "https://thirdwx.qlogo.cn/..."
}
```

**è¯´æ˜**ï¼š
- `code` æ˜¯å¿…å¡«çš„ï¼Œæœ‰æ•ˆæœŸ 5 åˆ†é’Ÿï¼Œä¸”åªèƒ½ä½¿ç”¨ä¸€æ¬¡
- `nickName` å’Œ `avatar` æ˜¯å¯é€‰çš„ï¼Œåªæœ‰ç”¨æˆ·æˆæƒäº†æ‰ä¼šä¼ é€’
- å¦‚æœç”¨æˆ·æ‹’ç»æˆæƒï¼Œåªä¼šä¼ é€’ `code`ï¼Œæ­¤æ—¶åº”è¯¥é™é»˜ç™»å½•

---

### å“åº”å‚æ•°

#### æˆåŠŸå“åº” (HTTP 200)

```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 123,
      "openid": "oXXXX-xxxxxxxxxxxxxxx",
      "nickName": "å¼ ä¸‰",
      "avatar": "https://thirdwx.qlogo.cn/...",
      "phone": null,
      "email": null,
      "gender": 0,
      "createdAt": "2025-10-01T08:00:00.000Z",
      "updatedAt": "2025-10-01T08:00:00.000Z",
      "isNewUser": true
    }
  }
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| code | Number | ä¸šåŠ¡çŠ¶æ€ç ï¼Œ200 è¡¨ç¤ºæˆåŠŸ |
| message | String | æç¤ºä¿¡æ¯ |
| data | Object | è¿”å›æ•°æ® |
| data.token | String | JWT tokenï¼Œæœ‰æ•ˆæœŸå»ºè®® 7-30 å¤© |
| data.user | Object | ç”¨æˆ·ä¿¡æ¯ |
| data.user.id | Number | ç”¨æˆ· ID |
| data.user.openid | String | å¾®ä¿¡ openidï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ |
| data.user.nickName | String | ç”¨æˆ·æ˜µç§° |
| data.user.avatar | String | ç”¨æˆ·å¤´åƒ URL |
| data.user.phone | String | æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰ |
| data.user.email | String | é‚®ç®±ï¼ˆå¯é€‰ï¼‰ |
| data.user.gender | Number | æ€§åˆ«ï¼š0-æœªçŸ¥ï¼Œ1-ç”·ï¼Œ2-å¥³ |
| data.user.createdAt | String | æ³¨å†Œæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| data.user.updatedAt | String | æ›´æ–°æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| data.user.isNewUser | Boolean | æ˜¯å¦æ–°ç”¨æˆ·ï¼ˆé¦–æ¬¡ç™»å½•ä¸º trueï¼‰ |

---

#### å¤±è´¥å“åº”

##### 1. code å‚æ•°ç¼ºå¤± (HTTP 400)
```json
{
  "code": 400,
  "message": "ç¼ºå°‘å¿…å¡«å‚æ•° code",
  "data": null
}
```

##### 2. code å·²è¿‡æœŸæˆ–æ— æ•ˆ (HTTP 400)
```json
{
  "code": 40029,
  "message": "code å·²è¿‡æœŸæˆ–æ— æ•ˆ",
  "data": null
}
```

##### 3. code å·²è¢«ä½¿ç”¨ (HTTP 400)
```json
{
  "code": 40163,
  "message": "code å·²è¢«ä½¿ç”¨",
  "data": null
}
```

##### 4. å¾®ä¿¡æœåŠ¡å™¨é”™è¯¯ (HTTP 500)
```json
{
  "code": 500,
  "message": "è°ƒç”¨å¾®ä¿¡æ¥å£å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
  "data": null
}
```

##### 5. æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (HTTP 500)
```json
{
  "code": 500,
  "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
  "data": null
}
```

---

## ğŸ”„ æ¥å£è°ƒç”¨æµç¨‹

### å®Œæ•´æ—¶åºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚          â”‚  åç«¯    â”‚          â”‚  æ•°æ®åº“  â”‚          â”‚  å¾®ä¿¡æœåŠ¡å™¨  â”‚
â”‚ (å°ç¨‹åº) â”‚          â”‚  API     â”‚          â”‚          â”‚          â”‚              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚ 1. wx.login()       â”‚                     â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                       â”‚
     â”‚ è¿”å› code            â”‚                     â”‚                       â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚ 2. POST /api/auth/wechat                  â”‚                       â”‚
     â”‚     { code, nickName, avatar }            â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚                     â”‚ 3. è°ƒç”¨ code2session æ¥å£                    â”‚
     â”‚                     â”‚     (appid + secret + code)                â”‚
     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚                     â”‚ 4. è¿”å› openid + session_key               â”‚
     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚                     â”‚ 5. æŸ¥è¯¢ç”¨æˆ·         â”‚                       â”‚
     â”‚                     â”‚  WHERE openid = ?   â”‚                       â”‚
     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚                     â”‚ 6. è¿”å›ç”¨æˆ· or null â”‚                       â”‚
     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚                     â”‚ 7a. å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼šåˆ›å»ºç”¨æˆ·è®°å½•              â”‚
     â”‚                     â”‚     INSERT INTO users ...                  â”‚
     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚                     â”‚ 7b. å¦‚æœæ˜¯è€ç”¨æˆ·ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰      â”‚
     â”‚                     â”‚     UPDATE users SET nickName=?, avatar=?  â”‚
     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚                     â”‚ 8. ç”Ÿæˆ JWT token   â”‚                       â”‚
     â”‚                     â”‚   (åŒ…å« userId, openid)                    â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚ 9. è¿”å› { token, user, message }          â”‚                       â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
     â”‚ 10. ä¿å­˜ token      â”‚                     â”‚                       â”‚
     â”‚     åˆ°æœ¬åœ°å­˜å‚¨       â”‚                     â”‚                       â”‚
     â”‚                     â”‚                     â”‚                       â”‚
```

---

### åç«¯å¤„ç†æ­¥éª¤è¯¦è§£

#### æ­¥éª¤ 1: æ¥æ”¶å‰ç«¯è¯·æ±‚
```javascript
// ç¤ºä¾‹ä»£ç ï¼ˆNode.js + Expressï¼‰
app.post('/api/auth/wechat', async (req, res) => {
  const { code, nickName, avatar } = req.body
  
  // éªŒè¯å¿…å¡«å‚æ•°
  if (!code) {
    return res.status(400).json({
      code: 400,
      message: 'ç¼ºå°‘å¿…å¡«å‚æ•° code',
      data: null
    })
  }
  
  // ç»§ç»­å¤„ç†...
})
```

#### æ­¥éª¤ 2: è°ƒç”¨å¾®ä¿¡æ¥å£æ¢å– openid
```javascript
// å¾®ä¿¡æ¥å£åœ°å€
const WECHAT_API = 'https://api.weixin.qq.com/sns/jscode2session'

// è°ƒç”¨å¾®ä¿¡æ¥å£
const response = await axios.get(WECHAT_API, {
  params: {
    appid: YOUR_APPID,           // å°ç¨‹åº AppID
    secret: YOUR_SECRET,         // å°ç¨‹åº AppSecret
    js_code: code,               // å‰ç«¯ä¼ æ¥çš„ code
    grant_type: 'authorization_code'
  }
})

// å¾®ä¿¡æ¥å£è¿”å›ç¤ºä¾‹
// æˆåŠŸï¼š
// {
//   "openid": "oXXXX-xxxxxxxxxxxxxxx",
//   "session_key": "xxxxxxxxxxxxxx",
//   "unionid": "oXXXX-xxxxxxxxxxxxxxx"  // å¯é€‰ï¼Œç»‘å®šå¼€æ”¾å¹³å°æ‰æœ‰
// }
//
// å¤±è´¥ï¼š
// {
//   "errcode": 40029,
//   "errmsg": "invalid code"
// }

const { openid, session_key, errcode, errmsg } = response.data

// å¤„ç†é”™è¯¯
if (errcode) {
  console.error('å¾®ä¿¡æ¥å£é”™è¯¯:', errcode, errmsg)
  
  // å¸¸è§é”™è¯¯ç 
  if (errcode === 40029) {
    return res.status(400).json({
      code: 40029,
      message: 'code å·²è¿‡æœŸæˆ–æ— æ•ˆ',
      data: null
    })
  } else if (errcode === 40163) {
    return res.status(400).json({
      code: 40163,
      message: 'code å·²è¢«ä½¿ç”¨',
      data: null
    })
  } else {
    return res.status(500).json({
      code: 500,
      message: 'è°ƒç”¨å¾®ä¿¡æ¥å£å¤±è´¥',
      data: null
    })
  }
}

if (!openid) {
  return res.status(500).json({
    code: 500,
    message: 'è·å–ç”¨æˆ· openid å¤±è´¥',
    data: null
  })
}
```

#### æ­¥éª¤ 3: æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·
```javascript
// æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
let user = await User.findOne({ where: { openid } })

let isNewUser = false

if (!user) {
  // æ–°ç”¨æˆ·ï¼šåˆ›å»ºç”¨æˆ·è®°å½•
  isNewUser = true
  
  user = await User.create({
    openid: openid,
    sessionKey: session_key,  // å»ºè®®ä¿å­˜ï¼Œç”¨äºè§£å¯†æ‰‹æœºå·ç­‰
    nickName: nickName || 'å¾®ä¿¡ç”¨æˆ·',
    avatar: avatar || '',
    gender: 0,
    createdAt: new Date(),
    updatedAt: new Date()
  })
  
  console.log('åˆ›å»ºæ–°ç”¨æˆ·:', user.id)
} else {
  // è€ç”¨æˆ·ï¼šæ›´æ–°ä¿¡æ¯ï¼ˆå¦‚æœå‰ç«¯ä¼ äº†æ–°çš„æ˜µç§°/å¤´åƒï¼‰
  isNewUser = false
  
  const updates = {
    sessionKey: session_key,  // æ›´æ–° session_key
    updatedAt: new Date()
  }
  
  // åªæœ‰ç”¨æˆ·æˆæƒäº†æ‰æ›´æ–°æ˜µç§°å’Œå¤´åƒ
  if (nickName) {
    updates.nickName = nickName
  }
  if (avatar) {
    updates.avatar = avatar
  }
  
  await user.update(updates)
  
  console.log('æ›´æ–°ç”¨æˆ·:', user.id)
}
```

#### æ­¥éª¤ 4: ç”Ÿæˆ JWT Token
```javascript
const jwt = require('jsonwebtoken')

// JWT å¯†é’¥ï¼ˆå¿…é¡»ä¿å¯†ï¼ï¼‰
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'

// ç”Ÿæˆ token
const token = jwt.sign(
  {
    userId: user.id,
    openid: user.openid,
    // å¯ä»¥åŠ å…¥å…¶ä»–ä¿¡æ¯
  },
  JWT_SECRET,
  {
    expiresIn: '30d'  // 30 å¤©è¿‡æœŸ
  }
)

console.log('ç”Ÿæˆ token:', token.substring(0, 20) + '...')
```

#### æ­¥éª¤ 5: è¿”å›å“åº”
```javascript
return res.status(200).json({
  code: 200,
  message: isNewUser ? 'æ³¨å†ŒæˆåŠŸ' : 'ç™»å½•æˆåŠŸ',
  data: {
    token: token,
    user: {
      id: user.id,
      openid: user.openid,
      nickName: user.nickName,
      avatar: user.avatar,
      phone: user.phone,
      email: user.email,
      gender: user.gender,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
      isNewUser: isNewUser
    }
  }
})
```

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### users è¡¨

```sql
CREATE TABLE `users` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `openid` VARCHAR(100) NOT NULL COMMENT 'å¾®ä¿¡openidï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰',
  `unionid` VARCHAR(100) DEFAULT NULL COMMENT 'å¾®ä¿¡unionidï¼ˆå¯é€‰ï¼‰',
  `session_key` VARCHAR(100) DEFAULT NULL COMMENT 'å¾®ä¿¡ä¼šè¯å¯†é’¥',
  `nick_name` VARCHAR(100) DEFAULT 'å¾®ä¿¡ç”¨æˆ·' COMMENT 'ç”¨æˆ·æ˜µç§°',
  `avatar` VARCHAR(500) DEFAULT '' COMMENT 'ç”¨æˆ·å¤´åƒURL',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `email` VARCHAR(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `gender` TINYINT DEFAULT 0 COMMENT 'æ€§åˆ«ï¼š0-æœªçŸ¥ï¼Œ1-ç”·ï¼Œ2-å¥³',
  `created_at` DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ˜¯å¦å¿…å¡« |
|------|------|------|----------|
| id | INT | ç”¨æˆ·IDï¼Œä¸»é”®ï¼Œè‡ªå¢ | âœ… |
| openid | VARCHAR(100) | å¾®ä¿¡ openidï¼Œå”¯ä¸€ç´¢å¼• | âœ… |
| unionid | VARCHAR(100) | å¾®ä¿¡ unionidï¼ˆç»‘å®šå¼€æ”¾å¹³å°æ‰æœ‰ï¼‰ | âŒ |
| session_key | VARCHAR(100) | å¾®ä¿¡ä¼šè¯å¯†é’¥ï¼ˆç”¨äºè§£å¯†æ‰‹æœºå·ç­‰ï¼‰ | âŒ |
| nick_name | VARCHAR(100) | ç”¨æˆ·æ˜µç§°ï¼Œé»˜è®¤"å¾®ä¿¡ç”¨æˆ·" | âœ… |
| avatar | VARCHAR(500) | ç”¨æˆ·å¤´åƒ URL | âŒ |
| phone | VARCHAR(20) | æ‰‹æœºå· | âŒ |
| email | VARCHAR(100) | é‚®ç®± | âŒ |
| gender | TINYINT | æ€§åˆ«ï¼š0-æœªçŸ¥ï¼Œ1-ç”·ï¼Œ2-å¥³ | âœ… |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | âœ… |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ | âœ… |

---

## ğŸ“Š é”™è¯¯ç è§„èŒƒ

### HTTP çŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜ |
|--------|------|
| 200 | è¯·æ±‚æˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªç™»å½•æˆ– token æ— æ•ˆ |
| 403 | æ²¡æœ‰æƒé™ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

### ä¸šåŠ¡çŠ¶æ€ç  (code)

| çŠ¶æ€ç  | è¯´æ˜ |
|--------|------|
| 200 | æˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªç™»å½• |
| 403 | æ²¡æœ‰æƒé™ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 40029 | å¾®ä¿¡ code æ— æ•ˆæˆ–è¿‡æœŸ |
| 40163 | å¾®ä¿¡ code å·²è¢«ä½¿ç”¨ |
| 500 | æœåŠ¡å™¨é”™è¯¯ |

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä¿æŠ¤å°ç¨‹åºå¯†é’¥
```javascript
// âŒ é”™è¯¯ï¼šå¯†é’¥å†™æ­»åœ¨ä»£ç ä¸­
const APPID = 'wx1234567890abcdef'
const SECRET = 'abcdef1234567890abcdef1234567890'

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
const APPID = process.env.WECHAT_APPID
const SECRET = process.env.WECHAT_SECRET
```

### 2. JWT å¯†é’¥ç®¡ç†
```javascript
// âœ… ä½¿ç”¨å¼ºå¯†é’¥
const JWT_SECRET = process.env.JWT_SECRET  // è‡³å°‘ 32 ä½éšæœºå­—ç¬¦ä¸²

// âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
jwt.sign(payload, JWT_SECRET, { expiresIn: '30d' })
```

### 3. HTTPS é€šä¿¡
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- å¾®ä¿¡å°ç¨‹åºé»˜è®¤è¦æ±‚ HTTPS

### 4. é˜²æ­¢é‡æ”¾æ”»å‡»
```javascript
// å¯ä»¥è®°å½•å·²ä½¿ç”¨çš„ codeï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨
// ä½¿ç”¨ Redis ç¼“å­˜ï¼Œè®¾ç½® 5 åˆ†é’Ÿè¿‡æœŸ
await redis.set(`wechat:code:${code}`, '1', 'EX', 300)

// æ£€æŸ¥ code æ˜¯å¦å·²ä½¿ç”¨
const used = await redis.get(`wechat:code:${code}`)
if (used) {
  return res.status(400).json({
    code: 40163,
    message: 'code å·²è¢«ä½¿ç”¨',
    data: null
  })
}
```

### 5. é™åˆ¶è¯·æ±‚é¢‘ç‡
```javascript
// ä½¿ç”¨ express-rate-limit
const rateLimit = require('express-rate-limit')

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 åˆ†é’Ÿ
  max: 10,  // æœ€å¤š 10 æ¬¡è¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
})

app.post('/api/auth/wechat', loginLimiter, async (req, res) => {
  // ...
})
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•å·¥å…·
æ¨èä½¿ç”¨ **Postman** æˆ– **curl** è¿›è¡Œæµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹ 1: æ­£å¸¸ç™»å½•
```bash
curl -X POST https://your-api.com/api/auth/wechat \
  -H "Content-Type: application/json" \
  -d '{
    "code": "0x1abc2def3g4h5i6j7k8l9m0n",
    "nickName": "å¼ ä¸‰",
    "avatar": "https://thirdwx.qlogo.cn/..."
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": { ... }
  }
}
```

### æµ‹è¯•ç”¨ä¾‹ 2: ç¼ºå°‘ code
```bash
curl -X POST https://your-api.com/api/auth/wechat \
  -H "Content-Type: application/json" \
  -d '{
    "nickName": "å¼ ä¸‰"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 400,
  "message": "ç¼ºå°‘å¿…å¡«å‚æ•° code",
  "data": null
}
```

### æµ‹è¯•ç”¨ä¾‹ 3: code æ— æ•ˆ
```bash
curl -X POST https://your-api.com/api/auth/wechat \
  -H "Content-Type: application/json" \
  -d '{
    "code": "invalid-code"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 40029,
  "message": "code å·²è¿‡æœŸæˆ–æ— æ•ˆ",
  "data": null
}
```

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ä»£ç 

### Node.js + Express + Sequelize

```javascript
const express = require('express')
const axios = require('axios')
const jwt = require('jsonwebtoken')
const { User } = require('./models')

const app = express()
app.use(express.json())

// é…ç½®
const APPID = process.env.WECHAT_APPID
const SECRET = process.env.WECHAT_SECRET
const JWT_SECRET = process.env.JWT_SECRET

/**
 * å¾®ä¿¡ç™»å½•æ¥å£
 * POST /api/auth/wechat
 */
app.post('/api/auth/wechat', async (req, res) => {
  try {
    const { code, nickName, avatar } = req.body
    
    // 1. éªŒè¯å‚æ•°
    if (!code) {
      return res.status(400).json({
        code: 400,
        message: 'ç¼ºå°‘å¿…å¡«å‚æ•° code',
        data: null
      })
    }
    
    // 2. è°ƒç”¨å¾®ä¿¡æ¥å£
    const wechatRes = await axios.get(
      'https://api.weixin.qq.com/sns/jscode2session',
      {
        params: {
          appid: APPID,
          secret: SECRET,
          js_code: code,
          grant_type: 'authorization_code'
        }
      }
    )
    
    const { openid, session_key, errcode, errmsg } = wechatRes.data
    
    // 3. å¤„ç†å¾®ä¿¡æ¥å£é”™è¯¯
    if (errcode) {
      console.error('å¾®ä¿¡æ¥å£é”™è¯¯:', errcode, errmsg)
      
      if (errcode === 40029) {
        return res.status(400).json({
          code: 40029,
          message: 'code å·²è¿‡æœŸæˆ–æ— æ•ˆ',
          data: null
        })
      } else if (errcode === 40163) {
        return res.status(400).json({
          code: 40163,
          message: 'code å·²è¢«ä½¿ç”¨',
          data: null
        })
      } else {
        return res.status(500).json({
          code: 500,
          message: 'è°ƒç”¨å¾®ä¿¡æ¥å£å¤±è´¥',
          data: null
        })
      }
    }
    
    if (!openid) {
      return res.status(500).json({
        code: 500,
        message: 'è·å– openid å¤±è´¥',
        data: null
      })
    }
    
    // 4. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·
    let user = await User.findOne({ where: { openid } })
    let isNewUser = false
    
    if (!user) {
      // æ–°ç”¨æˆ·
      isNewUser = true
      user = await User.create({
        openid,
        sessionKey: session_key,
        nickName: nickName || 'å¾®ä¿¡ç”¨æˆ·',
        avatar: avatar || '',
        gender: 0
      })
    } else {
      // è€ç”¨æˆ·
      const updates = {
        sessionKey: session_key,
        updatedAt: new Date()
      }
      if (nickName) updates.nickName = nickName
      if (avatar) updates.avatar = avatar
      
      await user.update(updates)
    }
    
    // 5. ç”Ÿæˆ JWT token
    const token = jwt.sign(
      { userId: user.id, openid: user.openid },
      JWT_SECRET,
      { expiresIn: '30d' }
    )
    
    // 6. è¿”å›å“åº”
    return res.status(200).json({
      code: 200,
      message: isNewUser ? 'æ³¨å†ŒæˆåŠŸ' : 'ç™»å½•æˆåŠŸ',
      data: {
        token,
        user: {
          id: user.id,
          openid: user.openid,
          nickName: user.nickName,
          avatar: user.avatar,
          phone: user.phone,
          email: user.email,
          gender: user.gender,
          createdAt: user.createdAt,
          updatedAt: user.updatedAt,
          isNewUser
        }
      }
    })
    
  } catch (error) {
    console.error('ç™»å½•æ¥å£é”™è¯¯:', error)
    return res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      data: null
    })
  }
})

// å¯åŠ¨æœåŠ¡å™¨
app.listen(3000, () => {
  console.log('æœåŠ¡å™¨å¯åŠ¨: http://localhost:3000')
})
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### å¾®ä¿¡å®˜æ–¹æ–‡æ¡£
- [å°ç¨‹åºç™»å½•æµç¨‹](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [wx.login API](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)
- [code2Session æ¥å£](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html)

### JWT ç›¸å…³
- [JWT å®˜ç½‘](https://jwt.io/)
- [jsonwebtoken (Node.js)](https://www.npmjs.com/package/jsonwebtoken)

---

## âœ… å¼€å‘æ£€æŸ¥æ¸…å•

### åç«¯å¼€å‘
- [ ] è·å–å°ç¨‹åº AppID å’Œ AppSecret
- [ ] é…ç½®ç¯å¢ƒå˜é‡ï¼ˆAPPID, SECRET, JWT_SECRETï¼‰
- [ ] åˆ›å»º users æ•°æ®è¡¨
- [ ] å®ç° `/api/auth/wechat` æ¥å£
- [ ] è°ƒç”¨å¾®ä¿¡ code2session æ¥å£
- [ ] å¤„ç†æ–°ç”¨æˆ·æ³¨å†Œå’Œè€ç”¨æˆ·ç™»å½•
- [ ] ç”Ÿæˆ JWT token
- [ ] å®ç°é”™è¯¯å¤„ç†
- [ ] æ·»åŠ æ¥å£æ—¥å¿—
- [ ] é…ç½® HTTPS
- [ ] æµ‹è¯•æ¥å£åŠŸèƒ½

### å‰ç«¯é…ç½®
- [ ] é…ç½®åç«¯ API åœ°å€ï¼ˆutils/config.jsï¼‰
- [ ] æµ‹è¯•ç™»å½•åŠŸèƒ½
- [ ] éªŒè¯ token ä¿å­˜
- [ ] éªŒè¯ç”¨æˆ·ä¿¡æ¯ä¿å­˜

### éƒ¨ç½²é…ç½®
- [ ] åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æœåŠ¡å™¨åŸŸå
- [ ] ç¡®ä¿ä½¿ç”¨ HTTPS
- [ ] é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
- [ ] æµ‹è¯•ç”Ÿäº§ç¯å¢ƒç™»å½•

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæµç¨‹
1. **å‰ç«¯**: `wx.login()` â†’ è·å– `code` â†’ å‘é€åˆ°åç«¯
2. **åç«¯**: æ¥æ”¶ `code` â†’ è°ƒç”¨å¾®ä¿¡æ¥å£æ¢ `openid` â†’ åˆ›å»º/æ›´æ–°ç”¨æˆ· â†’ ç”Ÿæˆ `token` â†’ è¿”å›å‰ç«¯
3. **å‰ç«¯**: ä¿å­˜ `token` å’Œ `user` â†’ åç»­è¯·æ±‚å¸¦ä¸Š `token`

### å…³é”®ç‚¹
- âœ… `code` æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡
- âœ… `openid` æ˜¯ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†
- âœ… `session_key` ç”¨äºè§£å¯†æ•æ„Ÿæ•°æ®ï¼ˆå¦‚æ‰‹æœºå·ï¼‰
- âœ… JWT token å»ºè®®æœ‰æ•ˆæœŸ 7-30 å¤©
- âœ… ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- âœ… å°ç¨‹åºå¯†é’¥å¿…é¡»ä¿å¯†

### å¾®ä¿¡ code2session æ¥å£å‚æ•°
```
GET https://api.weixin.qq.com/sns/jscode2session

å‚æ•°:
  appid: å°ç¨‹åº AppID
  secret: å°ç¨‹åº AppSecret
  js_code: å‰ç«¯ä¼ æ¥çš„ code
  grant_type: authorization_codeï¼ˆå›ºå®šå€¼ï¼‰
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´10æœˆ1æ—¥  
**ç»´æŠ¤è€…**: AI Assistant

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒï¼š
- [å¾®ä¿¡ç™»å½•åŠŸèƒ½å®Œæ•´å®ç°.md](./ğŸ”å¾®ä¿¡ç™»å½•åŠŸèƒ½å®Œæ•´å®ç°.md)
- [å¾®ä¿¡å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)

