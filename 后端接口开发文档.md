# 🔌 CookTip 后端接口开发文档

**文档版本**: v1.0  
**更新时间**: 2025年10月1日  
**适用项目**: CookTip 美食食谱小程序

---

## 📋 目录

1. [微信登录接口](#微信登录接口)
2. [接口调用流程](#接口调用流程)
3. [数据库设计](#数据库设计)
4. [错误码规范](#错误码规范)
5. [安全建议](#安全建议)
6. [测试用例](#测试用例)

---

## 🔐 微信登录接口

### 接口地址
```
POST /api/auth/wechat
```

### 接口说明
用于微信小程序用户登录/注册。后端需要使用前端传来的 `code` 调用微信服务器接口换取 `openid`，然后创建或更新用户信息，最后返回 JWT token。

---

### 请求参数

#### Headers
```
Content-Type: application/json
```

#### Body (JSON)
| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| code | String | ✅ 是 | 微信登录凭证，通过 wx.login() 获取 | `"0x1abc2def..."` |
| nickName | String | ❌ 否 | 用户昵称（用户授权后才有） | `"张三"` |
| avatar | String | ❌ 否 | 用户头像 URL（用户授权后才有） | `"https://..."` |

#### 请求示例
```json
{
  "code": "0x1abc2def3g4h5i6j7k8l9m0n",
  "nickName": "张三",
  "avatar": "https://thirdwx.qlogo.cn/..."
}
```

**说明**：
- `code` 是必填的，有效期 5 分钟，且只能使用一次
- `nickName` 和 `avatar` 是可选的，只有用户授权了才会传递
- 如果用户拒绝授权，只会传递 `code`，此时应该静默登录

---

### 响应参数

#### 成功响应 (HTTP 200)

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 123,
      "openid": "oXXXX-xxxxxxxxxxxxxxx",
      "nickName": "张三",
      "avatar": "https://thirdwx.qlogo.cn/...",
      "phone": null,
      "email": null,
      "gender": 0,
      "createdAt": "2025-10-01T08:00:00.000Z",
      "updatedAt": "2025-10-01T08:00:00.000Z",
      "isNewUser": true
    }
  }
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| code | Number | 业务状态码，200 表示成功 |
| message | String | 提示信息 |
| data | Object | 返回数据 |
| data.token | String | JWT token，有效期建议 7-30 天 |
| data.user | Object | 用户信息 |
| data.user.id | Number | 用户 ID |
| data.user.openid | String | 微信 openid（唯一标识） |
| data.user.nickName | String | 用户昵称 |
| data.user.avatar | String | 用户头像 URL |
| data.user.phone | String | 手机号（可选） |
| data.user.email | String | 邮箱（可选） |
| data.user.gender | Number | 性别：0-未知，1-男，2-女 |
| data.user.createdAt | String | 注册时间（ISO 8601 格式） |
| data.user.updatedAt | String | 更新时间（ISO 8601 格式） |
| data.user.isNewUser | Boolean | 是否新用户（首次登录为 true） |

---

#### 失败响应

##### 1. code 参数缺失 (HTTP 400)
```json
{
  "code": 400,
  "message": "缺少必填参数 code",
  "data": null
}
```

##### 2. code 已过期或无效 (HTTP 400)
```json
{
  "code": 40029,
  "message": "code 已过期或无效",
  "data": null
}
```

##### 3. code 已被使用 (HTTP 400)
```json
{
  "code": 40163,
  "message": "code 已被使用",
  "data": null
}
```

##### 4. 微信服务器错误 (HTTP 500)
```json
{
  "code": 500,
  "message": "调用微信接口失败，请稍后重试",
  "data": null
}
```

##### 5. 服务器内部错误 (HTTP 500)
```json
{
  "code": 500,
  "message": "服务器内部错误",
  "data": null
}
```

---

## 🔄 接口调用流程

### 完整时序图

```
┌──────────┐          ┌──────────┐          ┌──────────┐          ┌──────────────┐
│  前端    │          │  后端    │          │  数据库  │          │  微信服务器  │
│ (小程序) │          │  API     │          │          │          │              │
└────┬─────┘          └────┬─────┘          └────┬─────┘          └──────┬───────┘
     │                     │                     │                       │
     │ 1. wx.login()       │                     │                       │
     │────────────────────>│                     │                       │
     │ 返回 code            │                     │                       │
     │<────────────────────│                     │                       │
     │                     │                     │                       │
     │ 2. POST /api/auth/wechat                  │                       │
     │     { code, nickName, avatar }            │                       │
     │────────────────────>│                     │                       │
     │                     │                     │                       │
     │                     │ 3. 调用 code2session 接口                    │
     │                     │     (appid + secret + code)                │
     │                     │────────────────────────────────────────────>│
     │                     │                     │                       │
     │                     │ 4. 返回 openid + session_key               │
     │                     │<────────────────────────────────────────────│
     │                     │                     │                       │
     │                     │ 5. 查询用户         │                       │
     │                     │  WHERE openid = ?   │                       │
     │                     │────────────────────>│                       │
     │                     │                     │                       │
     │                     │ 6. 返回用户 or null │                       │
     │                     │<────────────────────│                       │
     │                     │                     │                       │
     │                     │ 7a. 如果是新用户：创建用户记录              │
     │                     │     INSERT INTO users ...                  │
     │                     │────────────────────>│                       │
     │                     │<────────────────────│                       │
     │                     │                     │                       │
     │                     │ 7b. 如果是老用户：更新用户信息（如有）      │
     │                     │     UPDATE users SET nickName=?, avatar=?  │
     │                     │────────────────────>│                       │
     │                     │<────────────────────│                       │
     │                     │                     │                       │
     │                     │ 8. 生成 JWT token   │                       │
     │                     │   (包含 userId, openid)                    │
     │                     │                     │                       │
     │ 9. 返回 { token, user, message }          │                       │
     │<────────────────────│                     │                       │
     │                     │                     │                       │
     │ 10. 保存 token      │                     │                       │
     │     到本地存储       │                     │                       │
     │                     │                     │                       │
```

---

### 后端处理步骤详解

#### 步骤 1: 接收前端请求
```javascript
// 示例代码（Node.js + Express）
app.post('/api/auth/wechat', async (req, res) => {
  const { code, nickName, avatar } = req.body
  
  // 验证必填参数
  if (!code) {
    return res.status(400).json({
      code: 400,
      message: '缺少必填参数 code',
      data: null
    })
  }
  
  // 继续处理...
})
```

#### 步骤 2: 调用微信接口换取 openid
```javascript
// 微信接口地址
const WECHAT_API = 'https://api.weixin.qq.com/sns/jscode2session'

// 调用微信接口
const response = await axios.get(WECHAT_API, {
  params: {
    appid: YOUR_APPID,           // 小程序 AppID
    secret: YOUR_SECRET,         // 小程序 AppSecret
    js_code: code,               // 前端传来的 code
    grant_type: 'authorization_code'
  }
})

// 微信接口返回示例
// 成功：
// {
//   "openid": "oXXXX-xxxxxxxxxxxxxxx",
//   "session_key": "xxxxxxxxxxxxxx",
//   "unionid": "oXXXX-xxxxxxxxxxxxxxx"  // 可选，绑定开放平台才有
// }
//
// 失败：
// {
//   "errcode": 40029,
//   "errmsg": "invalid code"
// }

const { openid, session_key, errcode, errmsg } = response.data

// 处理错误
if (errcode) {
  console.error('微信接口错误:', errcode, errmsg)
  
  // 常见错误码
  if (errcode === 40029) {
    return res.status(400).json({
      code: 40029,
      message: 'code 已过期或无效',
      data: null
    })
  } else if (errcode === 40163) {
    return res.status(400).json({
      code: 40163,
      message: 'code 已被使用',
      data: null
    })
  } else {
    return res.status(500).json({
      code: 500,
      message: '调用微信接口失败',
      data: null
    })
  }
}

if (!openid) {
  return res.status(500).json({
    code: 500,
    message: '获取用户 openid 失败',
    data: null
  })
}
```

#### 步骤 3: 查询或创建用户
```javascript
// 查询用户是否存在
let user = await User.findOne({ where: { openid } })

let isNewUser = false

if (!user) {
  // 新用户：创建用户记录
  isNewUser = true
  
  user = await User.create({
    openid: openid,
    sessionKey: session_key,  // 建议保存，用于解密手机号等
    nickName: nickName || '微信用户',
    avatar: avatar || '',
    gender: 0,
    createdAt: new Date(),
    updatedAt: new Date()
  })
  
  console.log('创建新用户:', user.id)
} else {
  // 老用户：更新信息（如果前端传了新的昵称/头像）
  isNewUser = false
  
  const updates = {
    sessionKey: session_key,  // 更新 session_key
    updatedAt: new Date()
  }
  
  // 只有用户授权了才更新昵称和头像
  if (nickName) {
    updates.nickName = nickName
  }
  if (avatar) {
    updates.avatar = avatar
  }
  
  await user.update(updates)
  
  console.log('更新用户:', user.id)
}
```

#### 步骤 4: 生成 JWT Token
```javascript
const jwt = require('jsonwebtoken')

// JWT 密钥（必须保密！）
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'

// 生成 token
const token = jwt.sign(
  {
    userId: user.id,
    openid: user.openid,
    // 可以加入其他信息
  },
  JWT_SECRET,
  {
    expiresIn: '30d'  // 30 天过期
  }
)

console.log('生成 token:', token.substring(0, 20) + '...')
```

#### 步骤 5: 返回响应
```javascript
return res.status(200).json({
  code: 200,
  message: isNewUser ? '注册成功' : '登录成功',
  data: {
    token: token,
    user: {
      id: user.id,
      openid: user.openid,
      nickName: user.nickName,
      avatar: user.avatar,
      phone: user.phone,
      email: user.email,
      gender: user.gender,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
      isNewUser: isNewUser
    }
  }
})
```

---

## 💾 数据库设计

### users 表

```sql
CREATE TABLE `users` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `openid` VARCHAR(100) NOT NULL COMMENT '微信openid（唯一标识）',
  `unionid` VARCHAR(100) DEFAULT NULL COMMENT '微信unionid（可选）',
  `session_key` VARCHAR(100) DEFAULT NULL COMMENT '微信会话密钥',
  `nick_name` VARCHAR(100) DEFAULT '微信用户' COMMENT '用户昵称',
  `avatar` VARCHAR(500) DEFAULT '' COMMENT '用户头像URL',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `gender` TINYINT DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
  `created_at` DATETIME NOT NULL COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 字段说明

| 字段 | 类型 | 说明 | 是否必填 |
|------|------|------|----------|
| id | INT | 用户ID，主键，自增 | ✅ |
| openid | VARCHAR(100) | 微信 openid，唯一索引 | ✅ |
| unionid | VARCHAR(100) | 微信 unionid（绑定开放平台才有） | ❌ |
| session_key | VARCHAR(100) | 微信会话密钥（用于解密手机号等） | ❌ |
| nick_name | VARCHAR(100) | 用户昵称，默认"微信用户" | ✅ |
| avatar | VARCHAR(500) | 用户头像 URL | ❌ |
| phone | VARCHAR(20) | 手机号 | ❌ |
| email | VARCHAR(100) | 邮箱 | ❌ |
| gender | TINYINT | 性别：0-未知，1-男，2-女 | ✅ |
| created_at | DATETIME | 创建时间 | ✅ |
| updated_at | DATETIME | 更新时间 | ✅ |

---

## 📊 错误码规范

### HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未登录或 token 无效 |
| 403 | 没有权限 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 业务状态码 (code)

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未登录 |
| 403 | 没有权限 |
| 404 | 资源不存在 |
| 40029 | 微信 code 无效或过期 |
| 40163 | 微信 code 已被使用 |
| 500 | 服务器错误 |

---

## 🔒 安全建议

### 1. 保护小程序密钥
```javascript
// ❌ 错误：密钥写死在代码中
const APPID = 'wx1234567890abcdef'
const SECRET = 'abcdef1234567890abcdef1234567890'

// ✅ 正确：使用环境变量
const APPID = process.env.WECHAT_APPID
const SECRET = process.env.WECHAT_SECRET
```

### 2. JWT 密钥管理
```javascript
// ✅ 使用强密钥
const JWT_SECRET = process.env.JWT_SECRET  // 至少 32 位随机字符串

// ✅ 设置合理的过期时间
jwt.sign(payload, JWT_SECRET, { expiresIn: '30d' })
```

### 3. HTTPS 通信
- 生产环境必须使用 HTTPS
- 微信小程序默认要求 HTTPS

### 4. 防止重放攻击
```javascript
// 可以记录已使用的 code，防止重复使用
// 使用 Redis 缓存，设置 5 分钟过期
await redis.set(`wechat:code:${code}`, '1', 'EX', 300)

// 检查 code 是否已使用
const used = await redis.get(`wechat:code:${code}`)
if (used) {
  return res.status(400).json({
    code: 40163,
    message: 'code 已被使用',
    data: null
  })
}
```

### 5. 限制请求频率
```javascript
// 使用 express-rate-limit
const rateLimit = require('express-rate-limit')

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 分钟
  max: 10,  // 最多 10 次请求
  message: '请求过于频繁，请稍后再试'
})

app.post('/api/auth/wechat', loginLimiter, async (req, res) => {
  // ...
})
```

---

## 🧪 测试用例

### 测试工具
推荐使用 **Postman** 或 **curl** 进行测试

### 测试用例 1: 正常登录
```bash
curl -X POST https://your-api.com/api/auth/wechat \
  -H "Content-Type: application/json" \
  -d '{
    "code": "0x1abc2def3g4h5i6j7k8l9m0n",
    "nickName": "张三",
    "avatar": "https://thirdwx.qlogo.cn/..."
  }'
```

**预期响应**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": { ... }
  }
}
```

### 测试用例 2: 缺少 code
```bash
curl -X POST https://your-api.com/api/auth/wechat \
  -H "Content-Type: application/json" \
  -d '{
    "nickName": "张三"
  }'
```

**预期响应**:
```json
{
  "code": 400,
  "message": "缺少必填参数 code",
  "data": null
}
```

### 测试用例 3: code 无效
```bash
curl -X POST https://your-api.com/api/auth/wechat \
  -H "Content-Type: application/json" \
  -d '{
    "code": "invalid-code"
  }'
```

**预期响应**:
```json
{
  "code": 40029,
  "message": "code 已过期或无效",
  "data": null
}
```

---

## 📝 完整示例代码

### Node.js + Express + Sequelize

```javascript
const express = require('express')
const axios = require('axios')
const jwt = require('jsonwebtoken')
const { User } = require('./models')

const app = express()
app.use(express.json())

// 配置
const APPID = process.env.WECHAT_APPID
const SECRET = process.env.WECHAT_SECRET
const JWT_SECRET = process.env.JWT_SECRET

/**
 * 微信登录接口
 * POST /api/auth/wechat
 */
app.post('/api/auth/wechat', async (req, res) => {
  try {
    const { code, nickName, avatar } = req.body
    
    // 1. 验证参数
    if (!code) {
      return res.status(400).json({
        code: 400,
        message: '缺少必填参数 code',
        data: null
      })
    }
    
    // 2. 调用微信接口
    const wechatRes = await axios.get(
      'https://api.weixin.qq.com/sns/jscode2session',
      {
        params: {
          appid: APPID,
          secret: SECRET,
          js_code: code,
          grant_type: 'authorization_code'
        }
      }
    )
    
    const { openid, session_key, errcode, errmsg } = wechatRes.data
    
    // 3. 处理微信接口错误
    if (errcode) {
      console.error('微信接口错误:', errcode, errmsg)
      
      if (errcode === 40029) {
        return res.status(400).json({
          code: 40029,
          message: 'code 已过期或无效',
          data: null
        })
      } else if (errcode === 40163) {
        return res.status(400).json({
          code: 40163,
          message: 'code 已被使用',
          data: null
        })
      } else {
        return res.status(500).json({
          code: 500,
          message: '调用微信接口失败',
          data: null
        })
      }
    }
    
    if (!openid) {
      return res.status(500).json({
        code: 500,
        message: '获取 openid 失败',
        data: null
      })
    }
    
    // 4. 查询或创建用户
    let user = await User.findOne({ where: { openid } })
    let isNewUser = false
    
    if (!user) {
      // 新用户
      isNewUser = true
      user = await User.create({
        openid,
        sessionKey: session_key,
        nickName: nickName || '微信用户',
        avatar: avatar || '',
        gender: 0
      })
    } else {
      // 老用户
      const updates = {
        sessionKey: session_key,
        updatedAt: new Date()
      }
      if (nickName) updates.nickName = nickName
      if (avatar) updates.avatar = avatar
      
      await user.update(updates)
    }
    
    // 5. 生成 JWT token
    const token = jwt.sign(
      { userId: user.id, openid: user.openid },
      JWT_SECRET,
      { expiresIn: '30d' }
    )
    
    // 6. 返回响应
    return res.status(200).json({
      code: 200,
      message: isNewUser ? '注册成功' : '登录成功',
      data: {
        token,
        user: {
          id: user.id,
          openid: user.openid,
          nickName: user.nickName,
          avatar: user.avatar,
          phone: user.phone,
          email: user.email,
          gender: user.gender,
          createdAt: user.createdAt,
          updatedAt: user.updatedAt,
          isNewUser
        }
      }
    })
    
  } catch (error) {
    console.error('登录接口错误:', error)
    return res.status(500).json({
      code: 500,
      message: '服务器内部错误',
      data: null
    })
  }
})

// 启动服务器
app.listen(3000, () => {
  console.log('服务器启动: http://localhost:3000')
})
```

---

## 📚 相关文档

### 微信官方文档
- [小程序登录流程](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [wx.login API](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)
- [code2Session 接口](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html)

### JWT 相关
- [JWT 官网](https://jwt.io/)
- [jsonwebtoken (Node.js)](https://www.npmjs.com/package/jsonwebtoken)

---

## ✅ 开发检查清单

### 后端开发
- [ ] 获取小程序 AppID 和 AppSecret
- [ ] 配置环境变量（APPID, SECRET, JWT_SECRET）
- [ ] 创建 users 数据表
- [ ] 实现 `/api/auth/wechat` 接口
- [ ] 调用微信 code2session 接口
- [ ] 处理新用户注册和老用户登录
- [ ] 生成 JWT token
- [ ] 实现错误处理
- [ ] 添加接口日志
- [ ] 配置 HTTPS
- [ ] 测试接口功能

### 前端配置
- [ ] 配置后端 API 地址（utils/config.js）
- [ ] 测试登录功能
- [ ] 验证 token 保存
- [ ] 验证用户信息保存

### 部署配置
- [ ] 在微信公众平台配置服务器域名
- [ ] 确保使用 HTTPS
- [ ] 配置生产环境变量
- [ ] 测试生产环境登录

---

## 🎯 总结

### 核心流程
1. **前端**: `wx.login()` → 获取 `code` → 发送到后端
2. **后端**: 接收 `code` → 调用微信接口换 `openid` → 创建/更新用户 → 生成 `token` → 返回前端
3. **前端**: 保存 `token` 和 `user` → 后续请求带上 `token`

### 关键点
- ✅ `code` 有效期 5 分钟，只能使用一次
- ✅ `openid` 是用户的唯一标识
- ✅ `session_key` 用于解密敏感数据（如手机号）
- ✅ JWT token 建议有效期 7-30 天
- ✅ 生产环境必须使用 HTTPS
- ✅ 小程序密钥必须保密

### 微信 code2session 接口参数
```
GET https://api.weixin.qq.com/sns/jscode2session

参数:
  appid: 小程序 AppID
  secret: 小程序 AppSecret
  js_code: 前端传来的 code
  grant_type: authorization_code（固定值）
```

---

**文档版本**: v1.0  
**创建时间**: 2025年10月1日  
**维护者**: AI Assistant

如有疑问，请参考：
- [微信登录功能完整实现.md](./🔐微信登录功能完整实现.md)
- [微信官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)

