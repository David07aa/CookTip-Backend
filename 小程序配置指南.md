# 微信小程序服务器域名配置指南

## 📍 配置位置

### 微信公众平台后台
1. 登录：https://mp.weixin.qq.com/
2. 路径：**开发** → **开发管理** → **开发设置** → **服务器域名**
3. 点击 **修改** 按钮

## 🌐 需要配置的域名

### request合法域名（必须）
```
https://cooktip-backend.vercel.app
```

⚠️ **Vercel 域名可能遇到的问题**：
- Vercel 提供的 `.vercel.app` 域名可能无法通过微信的域名备案验证
- 如果提示"域名未备案"或"域名格式不正确"，需要使用自己的已备案域名

---

## 🔧 开发阶段解决方案

### 方案一：开发者工具跳过校验（推荐）

在**微信开发者工具**中：

1. 点击右上角 **详情** 按钮
2. 选择 **本地设置** 标签
3. 勾选以下选项：
   ```
   ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   ```

**优点**：
- 开发阶段可以直接使用任何 API
- 无需等待域名配置生效
- 可以随时切换测试环境

**缺点**：
- 仅在开发工具中有效
- 真机预览和体验版仍需要配置合法域名

---

### 方案二：使用自己的已备案域名

如果你有已备案的域名（如 `yourdomain.com`），推荐使用此方案：

#### 步骤1：在 Vercel 添加自定义域名

1. 访问 [Vercel Dashboard](https://vercel.com/davids-projects-688aeefc/cooktip-backend)
2. 进入项目 → **Settings** → **Domains**
3. 点击 **Add Domain**
4. 输入你的域名，如：`api.yourdomain.com`

#### 步骤2：配置 DNS

在你的域名服务商（如阿里云、腾讯云）配置 DNS：

**添加 CNAME 记录**：
```
主机记录: api
记录类型: CNAME
记录值: cname.vercel-dns.com
TTL: 600
```

#### 步骤3：等待生效

- DNS 生效时间：5-30 分钟
- Vercel 会自动配置 HTTPS 证书

#### 步骤4：在小程序后台配置

在微信公众平台配置：
```
https://api.yourdomain.com
```

---

## 📱 小程序代码配置

### config.js（环境配置文件）

创建 `config/config.js`：

```javascript
// config/config.js
const isDev = process.env.NODE_ENV === 'development';

module.exports = {
  // 开发环境（开发者工具中使用，需勾选"不校验合法域名"）
  devApiUrl: 'https://cooktip-backend.vercel.app/api',
  
  // 生产环境（真机、体验版、正式版使用）
  prodApiUrl: 'https://api.yourdomain.com/api', // 替换为你的已备案域名
  
  // 当前使用的 API 地址
  apiUrl: isDev ? 
    'https://cooktip-backend.vercel.app/api' : 
    'https://api.yourdomain.com/api'
};
```

### 在页面中使用

```javascript
// pages/index/index.js
const config = require('../../config/config.js');

Page({
  data: {
    recipes: []
  },
  
  onLoad() {
    this.getRecipes();
  },
  
  getRecipes() {
    wx.request({
      url: `${config.apiUrl}/recipes`,
      method: 'GET',
      data: {
        page: 1,
        limit: 10
      },
      success: (res) => {
        if (res.data.code === 200) {
          this.setData({
            recipes: res.data.data.list
          });
        }
      },
      fail: (err) => {
        console.error('请求失败:', err);
        wx.showToast({
          title: '加载失败',
          icon: 'none'
        });
      }
    });
  }
});
```

---

## ✅ 配置验证

### 开发阶段验证

1. 在开发者工具中勾选"不校验合法域名"
2. 打开控制台（Console）
3. 测试请求：
   ```javascript
   wx.request({
     url: 'https://cooktip-backend.vercel.app/api/categories',
     success: (res) => console.log(res)
   });
   ```
4. 应该能看到返回的分类数据

### 生产环境验证

1. 在小程序后台配置域名后，等待 5 分钟
2. 在开发者工具中**取消勾选**"不校验合法域名"
3. 重新编译项目
4. 测试请求是否正常
5. 使用真机预览测试

---

## 🚨 常见问题

### 1. 域名配置后仍然报错

**原因**：配置生效需要时间

**解决**：
- 等待 5-30 分钟
- 在开发者工具中清除缓存并重新编译
- 检查域名是否完全一致（不要有多余的空格或字符）

### 2. 提示"域名未备案"

**原因**：Vercel 的 `.vercel.app` 域名未在中国备案

**解决**：
- 开发阶段：使用"不校验合法域名"选项
- 生产阶段：使用自己的已备案域名

### 3. 真机预览无法请求

**原因**：真机预览会校验合法域名

**解决**：
- 必须在小程序后台配置合法域名
- 或者使用"体验版"功能，体验版会使用配置的域名

### 4. request:fail 错误

**原因**：
- 域名未配置
- 网络问题
- 接口返回格式错误

**排查步骤**：
1. 检查是否勾选"不校验合法域名"（开发阶段）
2. 在浏览器中直接访问 API 确认可用
3. 查看控制台详细错误信息
4. 检查请求参数是否正确

---

## 📋 配置检查清单

### 开发阶段
- [ ] 在开发者工具中勾选"不校验合法域名"
- [ ] 测试 API 请求是否正常
- [ ] 确认数据格式正确

### 生产阶段（可选）
- [ ] 准备已备案域名
- [ ] 在 Vercel 添加自定义域名
- [ ] 配置 DNS CNAME 记录
- [ ] 等待 DNS 生效
- [ ] 在小程序后台配置合法域名
- [ ] 取消"不校验合法域名"选项
- [ ] 真机测试验证

---

## 🔗 相关链接

- **Vercel 项目**: https://vercel.com/davids-projects-688aeefc/cooktip-backend
- **API 基础地址**: https://cooktip-backend.vercel.app/api
- **微信公众平台**: https://mp.weixin.qq.com/
- **API 文档**: 查看项目中的 `API接口文档.md`
- **前端对接**: 查看项目中的 `前端对接文档.md`

---

## 💡 推荐方案总结

### 快速开发（推荐）
1. 在开发者工具勾选"不校验合法域名"
2. 直接使用 `https://cooktip-backend.vercel.app/api`
3. 快速开发和调试

### 长期生产
1. 购买并备案域名（如已有可直接使用）
2. 在 Vercel 配置自定义域名
3. 在小程序后台配置合法域名
4. 确保真机和正式版可用

---

**建议**：开发阶段先使用"不校验合法域名"快速开发，等小程序功能开发完成后，再考虑域名配置问题。

---

**创建时间**: 2025-10-02  
**后端项目**: CookTip Backend

