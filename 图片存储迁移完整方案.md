# 图片存储迁移完整方案

## 📋 迁移概述

**从**：云开发存储 → **到**：腾讯云COS对象存储

- **旧域名**：`https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com`
- **新域名**：`https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com`

## ✅ 已完成的更新

### 1. 后端环境变量配置
- ✅ 更新 `cloudbase-env-vars.json`
- ✅ 更新 `env.cloudbase.example`
- ✅ 更新 `miniprogram-utils/cdn.js`（前端CDN配置）

### 2. 需要部署的更改
后端环境变量已更新，但需要：
- 🔄 **重新部署云托管服务**（使新环境变量生效）
- 🔄 **迁移图片文件**（从旧存储到新COS）
- 🔄 **更新数据库中的图片URL**（如果有存储完整URL）

---

## 🚀 立即执行的步骤

### 步骤1：检查数据库中的图片URL

连接到数据库并执行以下查询，看是否存储了完整的旧域名URL：

```sql
-- 检查 recipes 表中的图片字段
SELECT 
  id, 
  title,
  cover_image,
  CASE 
    WHEN cover_image LIKE '%796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com%' 
    THEN '需要更新'
    ELSE '无需更新'
  END as status
FROM recipes 
WHERE cover_image IS NOT NULL
LIMIT 10;

-- 统计需要更新的记录数
SELECT 
  COUNT(*) as total_recipes,
  SUM(CASE WHEN cover_image LIKE '%796a-yjsp-wxxcx%' THEN 1 ELSE 0 END) as need_update
FROM recipes;
```

### 步骤2：根据检查结果选择方案

#### 🎯 情况A：数据库存储的是**相对路径**（最理想）

**示例数据**：
```json
{
  "cover_image": "/laoxiangji/番茄炒蛋.png"
}
```

✅ **无需更新数据库**，只需：
1. 更新云托管环境变量（已完成）
2. 重新部署后端服务
3. 迁移图片文件到新COS

---

#### 🎯 情况B：数据库存储的是**完整URL**（需要更新）

**示例数据**：
```json
{
  "cover_image": "https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com/laoxiangji/番茄炒蛋.png"
}
```

❌ **需要更新数据库**，执行以下SQL：

```sql
-- 备份数据（重要！）
CREATE TABLE recipes_backup_20241016 AS SELECT * FROM recipes;

-- 更新 recipes 表的 cover_image 字段
UPDATE recipes 
SET cover_image = REPLACE(
  cover_image, 
  'https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com',
  'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com'
)
WHERE cover_image LIKE '%796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com%';

-- 如果有其他字段也存储图片URL，也需要更新
-- 例如：用户头像
UPDATE users 
SET avatar = REPLACE(
  avatar,
  'https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com',
  'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com'
)
WHERE avatar LIKE '%796a-yjsp-wxxcx%';

-- 验证更新结果
SELECT 
  id, 
  title,
  cover_image
FROM recipes 
WHERE cover_image LIKE '%yjsp-1367462091.cos.ap-nanjing%'
LIMIT 10;
```

---

### 步骤3：迁移图片文件

#### 方案A：使用腾讯云COS迁移工具（推荐）

**使用 COS Migration Tool**：

1. 下载工具：https://cloud.tencent.com/document/product/436/15392

2. 创建配置文件 `config.ini`：

```ini
[common]
secretId = 您的SecretId
secretKey = 您的SecretKey
region = ap-nanjing

[source]
type = CloudBase
accessKeyId = 云开发SecretId
accessKeySecret = 云开发SecretKey
region = ap-shanghai
bucket = 796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091

[destination]
bucket = yjsp-1367462091
region = ap-nanjing
storageClass = STANDARD
```

3. 运行迁移：
```bash
java -jar cos_migrate_tool.jar
```

#### 方案B：使用 COSCMD 命令行工具

**步骤详解**：

```bash
# 1. 安装COSCMD
pip install coscmd

# 2. 配置新的COS存储桶
coscmd config -a 您的SecretId -s 您的SecretKey -b yjsp-1367462091 -r ap-nanjing

# 3. 下载旧存储中的图片（先在本地准备图片）
# 如果您已经有图片文件，跳过此步

# 4. 上传到新COS存储桶
coscmd upload -r ./laoxiangji/ /laoxiangji/

# 5. 验证上传
coscmd list laoxiangji/
```

#### 方案C：使用控制台手动迁移（小量数据）

1. 登录腾讯云COS控制台
2. 从旧的云开发存储下载图片
3. 上传到新的COS存储桶 `yjsp-1367462091`
4. 保持目录结构一致（如 `/laoxiangji/` 目录）

---

### 步骤4：配置新COS存储桶权限

确保新COS存储桶可以公开访问：

```bash
# 登录腾讯云COS控制台
# 选择存储桶：yjsp-1367462091
# 权限管理 -> 存储桶访问权限 -> 公共权限
# 设置为：公有读私有写
```

或使用COSCMD：

```bash
coscmd putbucketacl --grant-read "*"
```

---

### 步骤5：配置小程序downloadFile合法域名

在微信小程序后台配置：

**登录**：https://mp.weixin.qq.com

**路径**：开发管理 → 开发设置 → 服务器域名 → downloadFile合法域名

**添加**：
```
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com
```

⚠️ **注意**：配置后需等待3-5分钟生效。

---

### 步骤6：更新云托管环境变量并重启

**方法A：通过控制台**

1. 登录腾讯云托管控制台
2. 选择您的服务
3. 进入"环境变量"配置
4. 更新 `CDN_BASE_URL` 为：
   ```
   https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com
   ```
5. 保存并重启服务

**方法B：通过命令行**

```bash
# 使用 cloudbaserc.json 配置
# 更新环境变量后重新部署
npm run deploy
```

---

### 步骤7：验证迁移

#### 7.1 验证图片可访问性

在浏览器中测试：

```
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/大大大块牛腩面.png
```

应该能正常显示图片。

#### 7.2 验证API返回

调用后端API，检查返回的图片URL：

```bash
curl https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes/1
```

返回的 `cover_image` 应该是新的COS域名。

#### 7.3 验证小程序

1. 在小程序开发者工具中测试
2. 查看图片是否正常加载
3. 检查控制台是否还有 `ERR_CONNECTION_CLOSED` 错误

---

## 📝 完整迁移检查清单

### 后端更新
- [x] 更新 `cloudbase-env-vars.json`（已完成）
- [x] 更新 `env.cloudbase.example`（已完成）
- [ ] 检查数据库中的图片URL格式
- [ ] 如有需要，更新数据库中的URL
- [ ] 更新云托管环境变量
- [ ] 重新部署后端服务

### 图片迁移
- [ ] 从旧存储下载所有图片
- [ ] 上传到新COS存储桶
- [ ] 保持目录结构一致
- [ ] 设置COS存储桶为公有读
- [ ] 验证图片可通过新URL访问

### 前端更新
- [x] 更新 `cdn.js` 配置（已完成）
- [ ] 确保前端使用 `cdn.js` 的配置
- [ ] 配置小程序 downloadFile 合法域名
- [ ] 测试小程序图片加载

### 验证测试
- [ ] 浏览器访问新URL测试
- [ ] API返回的URL正确
- [ ] 小程序开发工具测试
- [ ] 小程序真机测试
- [ ] 无 ERR_CONNECTION_CLOSED 错误

---

## 🎯 快速数据库检查脚本

创建文件 `scripts/check-image-urls.js`：

```javascript
const mysql = require('mysql2/promise');

async function checkImageUrls() {
  const connection = await mysql.createConnection({
    host: '10.32.104.73',
    port: 3306,
    user: 'root',
    password: '050710Xzl',
    database: 'cooktip'
  });

  console.log('=== 检查数据库中的图片URL ===\n');

  // 检查 recipes 表
  const [recipes] = await connection.execute(
    'SELECT id, title, cover_image FROM recipes WHERE cover_image IS NOT NULL LIMIT 5'
  );

  console.log('前5条食谱记录：');
  recipes.forEach(recipe => {
    console.log(`ID: ${recipe.id}`);
    console.log(`标题: ${recipe.title}`);
    console.log(`封面: ${recipe.cover_image}`);
    console.log(`包含旧域名: ${recipe.cover_image?.includes('796a-yjsp-wxxcx') ? '是' : '否'}`);
    console.log('---');
  });

  // 统计
  const [stats] = await connection.execute(`
    SELECT 
      COUNT(*) as total,
      SUM(CASE WHEN cover_image LIKE '%796a-yjsp-wxxcx%' THEN 1 ELSE 0 END) as old_domain,
      SUM(CASE WHEN cover_image LIKE '%yjsp-1367462091.cos%' THEN 1 ELSE 0 END) as new_domain,
      SUM(CASE WHEN cover_image NOT LIKE 'http%' THEN 1 ELSE 0 END) as relative_path
    FROM recipes 
    WHERE cover_image IS NOT NULL
  `);

  console.log('\n统计信息：');
  console.log(`总记录数: ${stats[0].total}`);
  console.log(`使用旧域名: ${stats[0].old_domain}`);
  console.log(`使用新域名: ${stats[0].new_domain}`);
  console.log(`使用相对路径: ${stats[0].relative_path}`);

  await connection.end();
}

checkImageUrls().catch(console.error);
```

运行：
```bash
node scripts/check-image-urls.js
```

---

## 🆘 常见问题

### Q1: 迁移后图片仍显示旧URL？

**原因**：
- 云托管服务未重启
- 环境变量未更新
- 数据库中存储了完整的旧URL

**解决**：
1. 确认环境变量已更新
2. 重启云托管服务
3. 清除小程序缓存重新编译

### Q2: 部分图片迁移后404？

**原因**：
- 图片文件名包含中文或特殊字符
- 目录结构不一致
- URL编码问题

**解决**：
1. 检查COS中的文件列表
2. 确保中文文件名已正确编码
3. 保持与旧存储相同的目录结构

### Q3: 小程序仍报ERR_CONNECTION_CLOSED？

**原因**：
- downloadFile域名未配置
- 域名配置未生效
- COS权限设置为私有

**解决**：
1. 确认小程序后台域名配置
2. 等待5分钟后重试
3. 检查COS存储桶权限

---

## 📞 下一步

请执行：

1. **运行数据库检查脚本**，告诉我结果
2. **告诉我图片存储情况**：
   - 图片是否已在新COS中？
   - 图片总数大约多少？
   - 目录结构如何？

然后我会提供精确的迁移和更新方案！

