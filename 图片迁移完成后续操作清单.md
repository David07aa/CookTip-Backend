# 图片迁移完成后续操作清单 ✅

## 📋 已完成

- ✅ **步骤1**：数据库URL已更新（179条记录）
- ✅ **步骤2**：后端环境变量配置已更新
- ✅ **步骤3**：前端CDN配置已更新

---

## 🔴 紧急待办（按顺序执行）

### 任务1：迁移图片文件到新COS存储桶（最重要！）

**当前状态**：数据库URL已更新，但图片文件可能还在旧存储中

**操作步骤**：

#### 方案A：使用腾讯云COS批量复制（推荐）

1. **登录腾讯云控制台**
   - 访问：https://console.cloud.tencent.com/cos

2. **打开旧的云开发存储桶**
   - 找到：`796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091`
   - 区域：上海（ap-shanghai）

3. **选择需要复制的文件**
   - 进入 `/laoxiangji/` 目录
   - 全选所有图片文件（约179个PNG文件）

4. **批量复制到新COS**
   - 点击"复制"按钮
   - 目标存储桶：`yjsp-1367462091`
   - 目标区域：南京（ap-nanjing）
   - 目标路径：`/laoxiangji/`
   - 保持文件名不变
   - 点击确定

5. **等待复制完成**
   - 查看任务进度
   - 确认所有文件已复制成功

#### 方案B：使用COSCMD命令行工具

```bash
# 1. 安装COSCMD
pip install coscmd

# 2. 配置源存储桶（旧的云开发存储）
coscmd config -a 您的SecretId -s 您的SecretKey \\
  -b 796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091 \\
  -r ap-shanghai

# 3. 下载所有图片到本地
mkdir temp_images
coscmd download -r laoxiangji/ ./temp_images/laoxiangji/

# 4. 配置目标存储桶（新的COS）
coscmd config -a 您的SecretId -s 您的SecretKey \\
  -b yjsp-1367462091 \\
  -r ap-nanjing

# 5. 上传到新COS
coscmd upload -r ./temp_images/laoxiangji/ /laoxiangji/

# 6. 验证上传
coscmd list laoxiangji/
```

---

### 任务2：配置新COS存储桶权限

1. **登录腾讯云COS控制台**
   - 选择存储桶：`yjsp-1367462091`

2. **设置公有读权限**
   - 权限管理 → 存储桶访问权限
   - 公共权限 → 选择 **公有读私有写**
   - 保存

3. **验证权限**
   - 在浏览器访问测试：
   ```
   https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/大大大块牛腩面.png
   ```
   - 应该能正常显示图片

---

### 任务3：更新云托管环境变量并重启

#### 3.1 登录腾讯云托管控制台

访问：https://console.cloud.tencent.com/tcb

#### 3.2 更新环境变量

1. 进入您的云托管服务
2. 点击"环境变量"或"版本配置"
3. 找到或添加环境变量：
   ```
   CDN_BASE_URL=https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com
   ```
4. 保存配置

#### 3.3 重启服务（重要！）

- 点击"重启"或"重新部署"按钮
- 等待服务重启完成（约1-2分钟）

#### 3.4 验证环境变量生效

```bash
# 调用API查看返回的图片URL
curl https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes/1

# 检查返回的 cover_image 字段是否是新COS域名
```

---

### 任务4：配置小程序downloadFile合法域名

#### 4.1 登录微信小程序后台

访问：https://mp.weixin.qq.com

#### 4.2 配置服务器域名

1. 开发管理 → 开发设置 → 服务器域名
2. 在 **downloadFile合法域名** 中添加：
   ```
   https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com
   ```
3. 点击保存

⚠️ **注意**：
- 配置后需等待 **3-5分钟** 才能生效
- 每月只能修改5次，请确认域名正确

#### 4.3 临时解决方案（开发环境）

在小程序开发者工具中：
- 详情 → 本地设置
- 勾选 **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**

---

### 任务5：提交代码更改

```bash
cd E:\\前端项目文档\\项目文件夹\\CookTip-Backend

# 查看更改
git status

# 添加所有更改
git add .

# 提交
git commit -m "fix: 完成图片存储迁移到新COS

- 更新数据库中的图片URL (179条记录)
- 更新环境变量 CDN_BASE_URL
- 添加数据库检查和更新脚本
- 创建完整的迁移文档和操作指南"

# 推送
git push origin main
```

---

### 任务6：测试验证

#### 6.1 验证图片可访问性

**在浏览器中测试几个图片URL**：

```
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/大大大块牛腩面.png
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/大排面.png
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/杂粮饭.png
```

**预期结果**：所有图片都能正常显示

#### 6.2 验证API返回

```bash
# 查看API返回的数据
curl https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/recipes/1 | json_pp
```

**检查**：`cover_image` 字段应该是新的COS域名

#### 6.3 验证小程序

1. **打开小程序开发者工具**
2. **清除缓存**：工具 → 清除缓存 → 清除所有缓存
3. **重新编译**
4. **查看图片加载情况**
   - 首页食谱列表
   - 食谱详情页
   - 搜索结果页
5. **检查控制台**
   - 应该没有 `ERR_CONNECTION_CLOSED` 错误
   - 图片加载正常

#### 6.4 真机测试

1. 点击"预览"生成二维码
2. 使用微信扫码
3. 查看图片是否正常显示

---

## 📝 完整检查清单

### 必须完成的任务

- [ ] **任务1**：迁移图片文件到新COS
  - [ ] 使用控制台批量复制
  - [ ] 或使用COSCMD命令行工具
  - [ ] 验证所有文件已复制

- [ ] **任务2**：配置COS权限为"公有读私有写"
  - [ ] 在浏览器测试图片可访问

- [ ] **任务3**：更新云托管环境变量
  - [ ] 设置 CDN_BASE_URL
  - [ ] 重启云托管服务
  - [ ] 验证API返回新URL

- [ ] **任务4**：配置小程序域名
  - [ ] 添加 downloadFile 合法域名
  - [ ] 等待3-5分钟生效

- [ ] **任务5**：提交代码
  - [ ] git add & commit & push

- [ ] **任务6**：测试验证
  - [ ] 浏览器测试图片
  - [ ] API返回正确
  - [ ] 小程序图片正常
  - [ ] 真机测试通过

---

## 🎯 当前最紧急的任务

### 🔴 立即执行：迁移图片文件

**为什么紧急**：
- 数据库URL已更新为新域名
- 但图片文件可能还在旧存储中
- 如果不迁移，所有图片都会404

**验证方法**：
在浏览器打开：
```
https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/大大大块牛腩面.png
```

**如果显示404**：
→ 需要立即迁移图片文件（任务1）

**如果能看到图片**：
→ 图片已经在新COS中，跳到任务2

---

## 🆘 遇到问题？

### 问题1：图片迁移后仍然404

**检查**：
1. 文件名是否正确（注意中文编码）
2. 目录结构是否一致（`/laoxiangji/`）
3. 是否有文件上传失败

**解决**：
```bash
# 列出新COS中的文件
coscmd list laoxiangji/

# 对比旧存储中的文件数量
```

### 问题2：图片403权限错误

**检查**：
- COS存储桶权限是否设置为"公有读"

**解决**：
- 在COS控制台设置公共权限

### 问题3：小程序仍报ERR_CONNECTION_CLOSED

**检查**：
1. downloadFile域名是否已配置
2. 是否等待了3-5分钟
3. 开发工具是否勾选"不校验域名"

---

## 📞 下一步

**请告诉我**：

1. **图片文件迁移状态**：
   - 图片是否已在新COS中？
   - 在浏览器测试新URL能否访问？

2. **云托管环境变量更新状态**：
   - 是否已更新并重启服务？

3. **遇到的任何问题**

我会根据您的进度继续提供帮助！ 🚀

