# 🚨 接口地址修复清单

**问题**：前端报错 `ERR_CONNECTION_CLOSED`  
**原因**：使用了内网地址，需要改为公网地址  
**状态**：✅ 已解决

---

## 📋 快速修复步骤（3步完成）

### ✅ 第 1 步：更新前端 API 地址（2分钟）

找到前端项目的配置文件，将地址改为：

#### ❌ 旧地址（删除）
```javascript
'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com'
```

#### ✅ 新地址（使用）
```javascript
'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com'
```

**可能的文件位置**：
- `config/api.config.js`
- `utils/config.js`
- `utils/request.js`
- `app.js`

---

### ✅ 第 2 步：配置微信域名白名单（3分钟）

1. 登录：https://mp.weixin.qq.com
2. 进入：`开发` → `开发管理` → `开发设置` → `服务器域名`
3. 添加以下域名：

#### request 合法域名
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

#### uploadFile 合法域名
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

#### downloadFile 合法域名
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

**注意**：配置后等待 5-10 分钟生效

---

### ✅ 第 3 步：测试验证（1分钟）

在微信开发者工具控制台运行：

```javascript
// 测试分类接口
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/categories',
  success: (res) => console.log('✅ 成功:', res.data),
  fail: (err) => console.error('❌ 失败:', err)
})
```

**期望结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": [...]
}
```

---

## 🔍 完整地址对比

| 用途 | 旧地址（内网） | 新地址（公网） |
|------|---------------|---------------|
| 基础地址 | `rnvvjhwh.yjsp-ytg...` | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com` |
| API 地址 | `rnvvjhwh.yjsp-ytg.../api/v1` | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1` |
| 可访问性 | ❌ 仅云托管内部 | ✅ 全网可访问 |

---

## ✅ 已验证接口

| 接口 | 状态 | 测试时间 |
|------|------|---------|
| `/health` | ✅ 正常 | 2025-10-16 |
| `/api/v1/categories` | ✅ 正常 | 2025-10-16 |
| `/api/v1/recipes` | ✅ 正常 | 2025-10-16 |
| `/api/docs` | ✅ 正常 | 2025-10-16 |

---

## ⚠️ 重要提示

### 1. 公网域名限制
根据腾讯云托管说明：
> 公网域名仅能支持测试使用，请勿用于线上生产

**建议**：生产环境配置自定义域名（如 `api.cooktip.com`）

### 2. 域名白名单限制
- 每月只能修改 **5 次**
- 必须是 **HTTPS** 协议
- 配置后需要 **5-10 分钟** 生效

### 3. 开发调试
在微信开发者工具中：
- `详情` → `本地设置`
- 勾选 "不校验合法域名..." 可跳过域名验证
- ⚠️ 真机预览必须配置域名白名单

---

## 📝 配置示例代码

### config/api.config.js

```javascript
module.exports = {
  // API 基础地址
  apiBaseUrl: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1',
  
  // 图片 CDN
  storageUrl: 'https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com',
  
  // 请求超时
  timeout: 10000,
  
  // 存储键
  tokenKey: 'cooktip_token',
  userInfoKey: 'cooktip_userInfo'
}
```

### utils/request.js

```javascript
const { apiBaseUrl, tokenKey } = require('../config/api.config')

function request(options) {
  const token = wx.getStorageSync(tokenKey)
  
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${apiBaseUrl}${options.url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data)
        } else {
          reject(res.data)
        }
      },
      fail: reject
    })
  })
}

module.exports = { request }
```

---

## 🆘 故障排查

### 问题：修改后仍然无法连接

**检查清单**：
- [ ] 前端配置是否已修改并保存
- [ ] 是否清除了缓存并重新编译
- [ ] 域名白名单是否已配置
- [ ] 域名白名单是否已生效（等待10分钟）
- [ ] 是否使用了 HTTPS 协议

### 问题：提示"不在合法域名列表中"

**原因**：域名白名单未配置或未生效

**解决**：
1. 检查微信公众平台域名配置
2. 确认域名格式正确（必须包含 https://）
3. 等待 10 分钟后重试

### 问题：开发工具正常，真机预览失败

**原因**：开发工具可以跳过域名验证，真机不行

**解决**：必须在微信公众平台配置域名白名单

---

## 📞 需要帮助？

如果按照以上步骤操作后仍有问题，请提供：
1. 前端控制台完整错误信息
2. 网络请求详情（URL、状态码、响应）
3. 微信公众平台域名配置截图

---

## 📌 相关文档

- 详细配置指南：`前端配置更新指南-紧急修复.md`
- 完整接口文档：`前端对接文档-新版.md`
- 后端 API 文档：https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/docs

---

**按照以上步骤操作，3 步 6 分钟内即可修复！** ✅

**更新时间**：2025-10-16

