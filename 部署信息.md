# CookTip 后端部署信息

## 🌐 生产环境

### 云托管地址
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```

### API 基础路径
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1
```

### Swagger API 文档
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/docs
```

---

## 📋 API 接口列表

### 认证模块
- **微信登录**: `POST /api/v1/auth/wx-login`
- **刷新 Token**: `POST /api/v1/auth/refresh`
- **退出登录**: `POST /api/v1/auth/logout`

### 用户模块
- **获取用户信息**: `GET /api/v1/user/profile`
- **更新用户信息**: `PUT /api/v1/user/profile`
- **获取用户食谱**: `GET /api/v1/user/recipes`
- **获取用户收藏**: `GET /api/v1/user/favorites`

### 食谱模块
- **食谱列表**: `GET /api/v1/recipes`
- **创建食谱**: `POST /api/v1/recipes`
- **食谱详情**: `GET /api/v1/recipes/:id`
- **更新食谱**: `PUT /api/v1/recipes/:id`
- **删除食谱**: `DELETE /api/v1/recipes/:id`
- **点赞食谱**: `POST /api/v1/recipes/:id/like`
- **取消点赞**: `DELETE /api/v1/recipes/:id/like`

### 评论模块
- **获取评论**: `GET /api/v1/comments/recipe/:recipeId`
- **创建评论**: `POST /api/v1/comments`
- **删除评论**: `DELETE /api/v1/comments/:id`

### 收藏模块
- **收藏食谱**: `POST /api/v1/favorites`
- **取消收藏**: `DELETE /api/v1/favorites/:recipeId`
- **我的收藏**: `GET /api/v1/favorites`

### 搜索模块
- **搜索食谱**: `GET /api/v1/search?keyword=xxx`
- **热门搜索**: `GET /api/v1/search/hot`

### 购物清单模块
- **购物清单**: `GET /api/v1/shopping-list`
- **添加购物项**: `POST /api/v1/shopping-list`
- **更新购物项**: `PUT /api/v1/shopping-list/:id`
- **删除购物项**: `DELETE /api/v1/shopping-list/:id`

### 分类模块
- **分类列表**: `GET /api/v1/categories`
- **分类下的食谱**: `GET /api/v1/categories/:id/recipes`

### 文件上传模块
- **上传图片**: `POST /api/v1/upload/image`

### 统计模块
- **首页统计**: `GET /api/v1/stats/overview`
- **推荐食谱**: `GET /api/v1/stats/recommended`

---

## 🔧 小程序配置

### 在小程序中配置 API 地址

**config.js:**
```javascript
// 生产环境配置
const production = {
  apiBaseUrl: 'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1',
  uploadUrl: 'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/upload/image',
};

// 开发环境配置
const development = {
  apiBaseUrl: 'http://localhost:3000/api/v1',
  uploadUrl: 'http://localhost:3000/api/v1/upload/image',
};

// 导出配置
module.exports = process.env.NODE_ENV === 'production' ? production : development;
```

### 使用示例

**登录:**
```javascript
const config = require('./config');

wx.login({
  success: (res) => {
    if (res.code) {
      wx.request({
        url: `${config.apiBaseUrl}/auth/wx-login`,
        method: 'POST',
        data: { code: res.code },
        success: (response) => {
          const { token } = response.data.data;
          wx.setStorageSync('token', token);
        }
      });
    }
  }
});
```

**获取食谱列表:**
```javascript
wx.request({
  url: `${config.apiBaseUrl}/recipes`,
  method: 'GET',
  header: {
    'Authorization': `Bearer ${wx.getStorageSync('token')}`
  },
  data: {
    page: 1,
    limit: 10
  },
  success: (res) => {
    console.log(res.data.data);
  }
});
```

**上传图片:**
```javascript
wx.chooseImage({
  count: 1,
  success: (res) => {
    const tempFilePath = res.tempFilePaths[0];
    wx.uploadFile({
      url: config.uploadUrl,
      filePath: tempFilePath,
      name: 'file',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (uploadRes) => {
        const data = JSON.parse(uploadRes.data);
        console.log('图片URL:', data.data.url);
      }
    });
  }
});
```

---

## 📊 快速测试

### 1. 测试健康检查
```bash
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/
```

### 2. 访问 API 文档
浏览器打开：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/docs
```

### 3. 测试分类接口
```bash
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
```

### 4. 测试微信登录（需要真实 code）
```bash
curl -X POST https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/auth/wx-login \
  -H "Content-Type: application/json" \
  -d '{"code":"your-wx-code"}'
```

---

## 🔐 环境变量

当前生产环境配置：

```
DB_TYPE=mysql
DB_HOST=mysql3.sqlpub.com
DB_PORT=3308
DB_USERNAME=david_x
DB_DATABASE=onefoodlibrary
JWT_EXPIRES_IN=7d
WX_APPID=wx8486e57500ac0a55
PORT=3000
NODE_ENV=production
THROTTLE_TTL=60
THROTTLE_LIMIT=10
```

---

## 📝 注意事项

1. **小程序配置服务器域名**
   - 登录微信公众平台：https://mp.weixin.qq.com
   - 开发 → 开发管理 → 开发设置 → 服务器域名
   - 添加以下域名到 request 合法域名：
     ```
     https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
     ```
   - 添加以下域名到 uploadFile 合法域名：
     ```
     https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
     ```

2. **HTTPS 访问**
   - 云托管已自动配置 HTTPS
   - 小程序必须使用 HTTPS 协议

3. **跨域配置**
   - 后端已启用 CORS，允许所有来源
   - 生产环境建议限制特定域名

---

## 🚀 部署信息

- **部署时间**: 2025-10-08
- **部署方式**: 微信云托管
- **代码仓库**: https://github.com/David07aa/CookTip-Backend
- **运行环境**: Node.js 18 + Nest.js
- **数据库**: SQLPub MySQL 8.4.3

---

**更新时间**: 2025-10-08

