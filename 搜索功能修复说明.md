# æœç´¢åŠŸèƒ½ä¿®å¤è¯´æ˜

**ä¿®å¤æ—¶é—´**: 2025-10-30  
**é—®é¢˜ç±»å‹**: 500 Internal Server Error  
**å½±å“èŒƒå›´**: å°ç¨‹åºæœç´¢é¡µé¢

---

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨å°ç¨‹åºæœç´¢é¡µé¢æœç´¢é£Ÿè°±æ—¶ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```
äº‘å‡½æ•°å“åº”: {
  errMsg: "cloud.callFunction:ok", 
  result: {
    statusCode: 500, 
    data: {...}
  }
}

[Search] Perform search failed: Error: Internal server error
```

åŒæ—¶å‰ç«¯å¤‡ç”¨æ•°æ®ä½¿ç”¨äº†æ— æ•ˆçš„å›¾ç‰‡é“¾æ¥ï¼ˆunsplashï¼‰ï¼Œå¯¼è‡´ 404 é”™è¯¯ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. åç«¯ 500 é”™è¯¯åŸå› 

**ä½ç½®**: `src/modules/search/search.service.ts`

**é—®é¢˜ä»£ç **:
```typescript
items: items.map((recipe) => ({
  id: recipe.id,
  user: {
    id: recipe.user.id,        // âŒ å½“ recipe.user ä¸º null æ—¶å´©æºƒ
    nickname: recipe.user.nickname,
    avatar: recipe.user.avatar,
  },
  // ...
}))
```

**æ ¹æœ¬åŸå› **: 
- æ•°æ®åº“ä¸­æŸäº›é£Ÿè°±çš„ `user_id` å¯èƒ½ä¸º `null` æˆ–å¯¹åº”çš„ç”¨æˆ·å·²è¢«åˆ é™¤
- ä»£ç æ²¡æœ‰è¿›è¡Œç©ºå€¼æ£€æŸ¥ï¼Œç›´æ¥è®¿é—® `recipe.user.id` å¯¼è‡´ `TypeError`

### 2. å‰ç«¯å›¾ç‰‡ 404 é”™è¯¯

**ä½ç½®**: `E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip\pages\search\search.js`

**é—®é¢˜ä»£ç **:
```javascript
// å¤‡ç”¨å›¾ç‰‡ä½¿ç”¨äº†å¤–éƒ¨æœåŠ¡ï¼Œå¯èƒ½è¢«å¢™æˆ–å¤±æ•ˆ
image: 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=400'
image: 'https://images.unsplash.com/photo-1603073545352-f53f2070e40e?w=400'
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. åç«¯ä¿®å¤

**æ–‡ä»¶**: `src/modules/search/search.service.ts`

**ä¿®å¤å†…å®¹**:
```typescript
items: items.map((recipe) => ({
  id: recipe.id,
  user: recipe.user ? {           // âœ… æ·»åŠ ç©ºå€¼æ£€æŸ¥
    id: recipe.user.id,
    nickname: recipe.user.nickname,
    avatar: recipe.user.avatar,
  } : null,                        // âœ… user ä¸ºç©ºæ—¶è¿”å› null
  title: recipe.title,
  cover_image: recipe.cover_image,
  description: recipe.description,
  difficulty: recipe.difficulty,
  cook_time: recipe.cook_time,
  tags: recipe.tags,
  likes: recipe.likes,
  favorites: recipe.favorites,
  views: recipe.views,
  created_at: recipe.created_at,
}))
```

**æ•ˆæœ**:
- âœ… å³ä½¿é£Ÿè°±çš„ `user` ä¸º `null`ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ 500 é”™è¯¯
- âœ… å‰ç«¯å¯ä»¥å®‰å…¨å¤„ç† `user: null` çš„æƒ…å†µ
- âœ… æé«˜ç³»ç»Ÿå¥å£®æ€§

### 2. å‰ç«¯ä¿®å¤

**æ–‡ä»¶**: `E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip\pages\search\search.js`

**ä¿®å¤ä½ç½® 1** - `getRecommendRecipes()`:
```javascript
// é»˜è®¤å›¾ç‰‡
image: recipe.coverImage || recipe.cover_image || 
  'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg'

// å¤‡ç”¨æ•°æ®
{
  id: 1,
  title: 'ç•ªèŒ„ç‚–ç‰›è…©',
  image: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg',
  cookTime: 90,
  difficulty: 'ä¸­ç­‰'
}
```

**ä¿®å¤ä½ç½® 2** - `getMockResults()`:
```javascript
{
  id: 1,
  title: 'ç»å…¸ç•ªèŒ„ç‚–ç‰›è…©',
  introduction: 'æµ“éƒç•ªèŒ„æ±¤æ±ï¼Œè½¯çƒ‚å…¥å‘³çš„ç‰›è…©ï¼Œè¥å…»ä¸°å¯Œçš„å®¶å¸¸èœ',
  image: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg',
  tags: ['ä¸­é¤', 'ç‚–èœ', 'ç‰›è‚‰'],
  cookTime: 90,
  difficulty: 'ä¸­ç­‰',
  likes: 1520
}
```

**æ•ˆæœ**:
- âœ… æ‰€æœ‰å¤‡ç”¨å›¾ç‰‡ä½¿ç”¨é¡¹ç›® COS å­˜å‚¨çš„å›¾ç‰‡
- âœ… ä¸å†ä¾èµ–å¤–éƒ¨å›¾ç‰‡æœåŠ¡
- âœ… æ¶ˆé™¤ 404 é”™è¯¯

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### åç«¯éƒ¨ç½²

1. **ä»£ç å·²æ¨é€åˆ° GitHub**:
   ```bash
   git add src/modules/search/search.service.ts
   git commit -m "fix: ä¿®å¤æœç´¢æœåŠ¡çš„ç”¨æˆ·ç©ºå€¼æ£€æŸ¥é—®é¢˜"
   git push origin main
   ```
   âœ… Commit: `3cfbf84`

2. **äº‘æ‰˜ç®¡è‡ªåŠ¨éƒ¨ç½²**:
   - è…¾è®¯äº‘ Cloud Run ä¼šè‡ªåŠ¨æ‹‰å–æœ€æ–°ä»£ç 
   - ç­‰å¾…çº¦ 3-5 åˆ†é’Ÿå®Œæˆæ„å»ºå’Œéƒ¨ç½²

### å‰ç«¯éƒ¨ç½²

1. **æ–‡ä»¶å·²ä¿®æ”¹**:
   - âœ… `E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip\pages\search\search.js`

2. **äº‘å‡½æ•°åŒæ­¥**:
   - âœ… `E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip\cloudfunctions\api-proxy\index.js`
   - ï¼ˆå·²åŒæ­¥ï¼Œæ— éœ€é¢å¤–ä¿®æ”¹ï¼‰

3. **éƒ¨ç½²äº‘å‡½æ•°**:
   ```bash
   # åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­
   # å³é”® cloudfunctions/api-proxy æ–‡ä»¶å¤¹
   # ç‚¹å‡»"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
   ```

4. **é‡æ–°ç¼–è¯‘å°ç¨‹åº**:
   - åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ç‚¹å‡»"ç¼–è¯‘"
   - éªŒè¯æœç´¢åŠŸèƒ½æ˜¯å¦æ­£å¸¸

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ‰“å¼€å°ç¨‹åºæœç´¢é¡µé¢**
   - è¿›å…¥"æœç´¢"Tab

2. **æµ‹è¯•æœç´¢åŠŸèƒ½**
   - è¾“å…¥å…³é”®è¯ï¼ˆå¦‚"é¸¡"ï¼‰
   - ç‚¹å‡»æœç´¢æˆ–ç­‰å¾…è‡ªåŠ¨æœç´¢

3. **éªŒè¯ç»“æœ**
   - âœ… ä¸å†å‡ºç° 500 é”™è¯¯
   - âœ… èƒ½æ­£å¸¸æ˜¾ç¤ºæœç´¢ç»“æœ
   - âœ… å›¾ç‰‡èƒ½æ­£å¸¸åŠ è½½ï¼Œæ—  404 é”™è¯¯
   - âœ… å³ä½¿æŸäº›é£Ÿè°±æ²¡æœ‰ä½œè€…ä¿¡æ¯ï¼Œä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º

### é¢„æœŸç»“æœ

```javascript
// æˆåŠŸå“åº”
äº‘å‡½æ•°å“åº”: {
  errMsg: "cloud.callFunction:ok",
  result: {
    statusCode: 200,  // âœ… æˆåŠŸ
    data: {
      code: 200,
      message: "success",
      data: {
        items: [...],
        total: 10,
        page: 1,
        limit: 10
      }
    }
  }
}
```

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

| é¡¹ç›® | ä¿®å¤å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| åç«¯ç©ºå€¼æ£€æŸ¥ | æ·»åŠ  `recipe.user` ç©ºå€¼åˆ¤æ–­ | âœ… å·²å®Œæˆ |
| å‰ç«¯å¤‡ç”¨å›¾ç‰‡ | æ›¿æ¢ä¸º COS å›¾ç‰‡é“¾æ¥ï¼ˆ3å¤„ï¼‰ | âœ… å·²å®Œæˆ |
| äº‘å‡½æ•°åŒæ­¥ | åŒæ­¥ `api-proxy` åˆ°å‰ç«¯é¡¹ç›® | âœ… å·²å®Œæˆ |
| ä»£ç æ¨é€ | æ¨é€åˆ° GitHub ä»“åº“ | âœ… å·²å®Œæˆ |

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç©ºå€¼å®‰å…¨å¤„ç†

**âŒ é”™è¯¯åšæ³•**:
```typescript
user: {
  id: recipe.user.id  // å¦‚æœ user ä¸º nullï¼Œç›´æ¥å´©æºƒ
}
```

**âœ… æ­£ç¡®åšæ³•**:
```typescript
user: recipe.user ? {
  id: recipe.user.id,
  nickname: recipe.user.nickname
} : null
```

### 2. å¤‡ç”¨èµ„æºç®¡ç†

**âŒ é”™è¯¯åšæ³•**:
```javascript
// ä½¿ç”¨å¤–éƒ¨æœåŠ¡ï¼Œå¯èƒ½å¤±æ•ˆ
image: 'https://images.unsplash.com/xxx'
```

**âœ… æ­£ç¡®åšæ³•**:
```javascript
// ä½¿ç”¨é¡¹ç›®è‡ªå·±çš„ COS å­˜å‚¨
image: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg'
```

### 3. é”™è¯¯å¤„ç†

**å‰ç«¯å¤„ç†**:
```javascript
try {
  const result = await api.search.searchRecipes(keyword, {...})
  // å¤„ç†æˆåŠŸç»“æœ
} catch (error) {
  console.error('[Search] Error:', error)
  // ä½¿ç”¨å¤‡ç”¨æ•°æ®
  this.$setData({ searchResults: this.getMockResults() })
}
```

**åç«¯å¤„ç†**:
```typescript
// æ·»åŠ  try-catch åŒ…è£¹å…³é”®é€»è¾‘
try {
  const [items, total] = await queryBuilder.getManyAndCount()
  return { items: items.map(...), total, ... }
} catch (error) {
  this.logger.error('Search failed:', error)
  throw new InternalServerErrorException('æœç´¢å¤±è´¥')
}
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [æœç´¢æœåŠ¡æºç ](src/modules/search/search.service.ts)
- [å‰ç«¯æœç´¢é¡µé¢](E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip\pages\search\search.js)
- [äº‘å‡½æ•°ä»£ç†](E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip\cloudfunctions\api-proxy\index.js)

---

## âœ¨ ä¿®å¤å®Œæˆ

**æ‰€æœ‰ä¿®å¤å·²å®Œæˆå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼**  
**å‰ç«¯ä¿®å¤å·²åŒæ­¥åˆ°å°ç¨‹åºé¡¹ç›®ï¼**  
**å¯ä»¥å¼€å§‹æµ‹è¯•æœç´¢åŠŸèƒ½ï¼** ğŸ‰

