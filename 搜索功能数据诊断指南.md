# 🔍 搜索功能数据诊断指南

**目的**: 检查数据库中是否有食谱数据，并诊断为什么搜索返回空结果

---

## 📋 问题描述

用户反馈：搜索功能返回"没有搜索到"，而不是返回实际的搜索结果。

**可能的原因**:
1. 数据库中没有食谱数据
2. 所有食谱的状态不是 `published`
3. 搜索关键词没有匹配到任何食谱
4. 数据库查询条件过于严格

---

## 🚀 第一步：等待部署（3-5 分钟）

已添加的优化（Commit: `539e40b`）：

1. ✅ **详细的查询日志**
   - 记录搜索参数
   - 记录数据库总数
   - 记录生成的 SQL
   - 记录查询结果

2. ✅ **调试端点**
   - `GET /api/v1/search/debug/all-recipes`
   - 直接返回数据库中的前 10 条食谱
   - 不进行任何过滤

3. ✅ **优化搜索逻辑**
   - 关键词为空时返回所有食谱
   - 更灵活的查询条件

---

## 🧪 第二步：测试调试端点

### 方法 A：使用浏览器（推荐）

**直接访问**:
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search/debug/all-recipes
```

**预期响应**（如果有数据）:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "recipes": [
      {
        "id": 1,
        "title": "宫保鸡丁",
        "status": "published",
        "user": { "id": 1, "nickname": "美食达人" },
        "created_at": "2025-10-29T..."
      },
      ...
    ]
  }
}
```

**如果没有数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 0,
    "recipes": []
  }
}
```

### 方法 B：使用 curl

```bash
curl https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search/debug/all-recipes
```

---

## 📊 第三步：查看云托管日志

### 搜索关键词

在云托管日志中搜索：

```
[SearchService] Total recipes in database
[SearchService] Building query
[SearchService] Generated SQL
[SearchService] Query result
```

### 预期日志

**如果有数据**:
```
[SearchService] Debug: Found recipes: 10
[SearchService] Total recipes in database: 50
[SearchService] Building query: {keyword: "鸡", pageNum: 1, ...}
[SearchService] Generated SQL: SELECT recipe.id, recipe.title, ... FROM recipes ...
[SearchService] Query result: {itemsCount: 5, total: 5, firstItem: {id: 1, title: "宫保鸡丁"}}
```

**如果没有数据**:
```
[SearchService] Debug: Found recipes: 0
[SearchService] Total recipes in database: 0
[SearchService] Query result: {itemsCount: 0, total: 0, firstItem: null}
```

---

## 🔎 第四步：诊断问题

### 情况 1: 数据库完全没有数据

**日志显示**:
```
[SearchService] Total recipes in database: 0
[SearchService] Debug: Found recipes: 0
```

**原因**: 数据库是空的

**解决方案**: 需要导入食谱数据

```sql
-- 查看数据库中的食谱数量
SELECT COUNT(*) FROM recipes;

-- 查看食谱状态分布
SELECT status, COUNT(*) FROM recipes GROUP BY status;
```

---

### 情况 2: 有数据但都不是 published 状态

**日志显示**:
```
[SearchService] Total recipes in database: 50
[SearchService] Debug: Found recipes: 10
[SearchService] Query result: {itemsCount: 0, total: 0}  // 搜索结果为0
```

**原因**: 所有食谱的状态不是 `published`

**解决方案**: 更新食谱状态

```sql
-- 查看所有状态
SELECT status, COUNT(*) FROM recipes GROUP BY status;

-- 如果需要，将所有食谱改为 published
UPDATE recipes SET status = 'published' WHERE status != 'published';
```

---

### 情况 3: 有 published 数据但搜索不到

**日志显示**:
```
[SearchService] Total recipes in database: 50
[SearchService] Debug: Found recipes: 10 (有 published 状态的)
[SearchService] Query result: {itemsCount: 0, total: 0, firstItem: null}
[SearchService] Generated SQL: ... WHERE recipe.title LIKE '%鸡%' OR recipe.description LIKE '%鸡%'
```

**原因**: 关键词没有匹配到任何食谱

**解决方案**: 
1. 尝试搜索其他关键词
2. 检查数据库中食谱的标题

```sql
-- 查看所有食谱标题
SELECT id, title, description FROM recipes WHERE status = 'published' LIMIT 10;

-- 搜索包含"鸡"的食谱
SELECT id, title FROM recipes WHERE (title LIKE '%鸡%' OR description LIKE '%鸡%') AND status = 'published';
```

---

### 情况 4: MySQL 字符集问题（中文搜索）

**症状**: 英文可以搜索，中文搜索不到

**解决方案**: 检查数据库字符集

```sql
-- 检查数据库字符集
SHOW VARIABLES LIKE 'character_set%';

-- 检查表字符集
SHOW CREATE TABLE recipes;

-- 如果需要，修改字符集
ALTER TABLE recipes CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE recipes MODIFY title VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE recipes MODIFY description TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

---

## 🛠️ 第五步：修复方案

### 方案 A: 导入测试数据（如果数据库为空）

```sql
INSERT INTO recipes (user_id, title, cover_image, description, difficulty, cook_time, status, created_at, updated_at) VALUES
(1, '宫保鸡丁', 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg', '经典川菜，鸡肉鲜嫩，花生酥脆', '中等', 30, 'published', NOW(), NOW()),
(1, '红烧肉', 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg', '肥而不腻，入口即化', '简单', 60, 'published', NOW(), NOW()),
(1, '麻婆豆腐', 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg', '麻辣鲜香，豆腐嫩滑', '简单', 20, 'published', NOW(), NOW()),
(1, '酸菜鱼', 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg', '鱼肉鲜嫩，酸辣开胃', '中等', 40, 'published', NOW(), NOW()),
(1, '西红柿炒鸡蛋', 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg', '家常菜，营养丰富', '简单', 10, 'published', NOW(), NOW());
```

### 方案 B: 更新现有食谱状态

```sql
-- 将所有食谱改为 published
UPDATE recipes SET status = 'published';
```

### 方案 C: 修改搜索逻辑（临时方案）

如果数据库中确实有数据，但搜索逻辑有问题，可以临时移除 `status` 过滤：

```typescript
// 临时：不过滤状态，搜索所有食谱
// queryBuilder.andWhere('recipe.status = :status', { status: 'published' });
```

---

## 📋 操作清单

- [ ] 1. 等待云托管部署完成（3-5 分钟）
- [ ] 2. 访问调试端点：`/api/v1/search/debug/all-recipes`
- [ ] 3. 查看返回结果
- [ ] 4. 查看云托管日志
- [ ] 5. 根据诊断结果选择修复方案
- [ ] 6. 测试搜索功能
- [ ] 7. 反馈结果

---

## 📞 反馈模板

```
调试端点响应:
```json
[粘贴响应JSON]
```

云托管日志:
```
[粘贴相关日志]
```

数据库状态:
- 总食谱数: ___
- Published 食谱数: ___
- 搜索关键词: ___
- 搜索结果数: ___

需要帮助: 是 / 否
```

---

**等待 3-5 分钟后，请按照上述步骤进行诊断！** 🔍

