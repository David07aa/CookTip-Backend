# 🎯 CookTip 后端 - 下一步工作清单

## 📊 当前完成状态（95%）

### ✅ 已完成
- ✅ 项目初始化和配置
- ✅ GitHub 仓库创建和代码推送
- ✅ Vercel 项目创建和部署
- ✅ Neon PostgreSQL 数据库创建
- ✅ 数据库连接配置
- ✅ 数据库表结构创建（7 张表）
- ✅ 数据库索引创建（13 个）
- ✅ 数据库触发器创建（2 个）
- ✅ 健康检查端点（已适配 PostgreSQL）
- ✅ 环境变量配置

### ⏳ 待完成（最后 5%）
- ⏳ 更新 12 个 API 文件以适配 PostgreSQL 语法
- ⏳ 测试所有 API 端点
- ⏳ 添加测试数据

---

## 🔄 需要更新的 API 文件清单

### 优先级 1：核心认证和用户 API（必须）

#### 1. `/api/auth/login.js` - 微信登录
**需要修改的地方：**
```javascript
// MySQL 方式（旧）
const userId = generateUUID();
await query('INSERT INTO users...', [userId, ...]);

// PostgreSQL 方式（新）
const result = await sql`
  INSERT INTO users (openid, nick_name, avatar) 
  VALUES (${openid}, ${nickName}, ${avatar})
  RETURNING id, openid, nick_name, avatar
`;
const user = result.rows[0];
```

**关键改动：**
- 不需要手动生成 UUID（数据库自动生成）
- 使用 `RETURNING` 子句获取插入的数据
- 使用 `sql` 标签模板语法

---

#### 2. `/api/user/info.js` - 用户信息
**需要修改的地方：**
```javascript
// MySQL 方式（旧）
const user = await queryOne('SELECT * FROM users WHERE id = ?', [userId]);

// PostgreSQL 方式（新）
const result = await sql`SELECT * FROM users WHERE id = ${userId}`;
const user = result.rows[0];
```

**关键改动：**
- 使用 `sql` 标签模板
- 从 `result.rows[0]` 获取数据

---

#### 3. `/api/users/[id].js` - 用户详情
**需要修改：**
- 同上，查询语法改为 PostgreSQL

---

### 优先级 2：食谱相关 API（核心功能）

#### 4. `/api/recipes/index.js` - 食谱列表和创建
**需要修改的地方：**

**创建食谱（POST）：**
```javascript
// MySQL 方式（旧）
const recipeId = generateUUID();
await query('INSERT INTO recipes...', [recipeId, title, ...]);

// PostgreSQL 方式（新）
const result = await sql`
  INSERT INTO recipes (
    title, cover_image, introduction, author_id, 
    cook_time, difficulty, servings, taste, category,
    tags, ingredients, steps, tips, nutrition
  ) VALUES (
    ${title}, ${coverImage}, ${introduction}, ${authorId},
    ${cookTime}, ${difficulty}, ${servings}, ${taste}, ${category},
    ${JSON.stringify(tags)}::jsonb,
    ${JSON.stringify(ingredients)}::jsonb,
    ${JSON.stringify(steps)}::jsonb,
    ${tips}, ${nutrition ? JSON.stringify(nutrition) : null}::jsonb
  )
  RETURNING id, title, cover_image, created_at
`;
```

**查询列表（GET）：**
```javascript
// MySQL 方式（旧）
const recipes = await query(`
  SELECT * FROM recipes 
  WHERE category = ? AND difficulty = ?
  LIMIT ? OFFSET ?
`, [category, difficulty, limit, offset]);

// PostgreSQL 方式（新）
const result = await sql`
  SELECT * FROM recipes 
  WHERE category = ${category} 
  AND difficulty = ${difficulty}
  ORDER BY created_at DESC
  LIMIT ${limit} OFFSET ${offset}
`;
const recipes = result.rows;
```

**关键改动：**
- JSONB 字段需要显式类型转换 `::jsonb`
- 参数使用 `${param}` 而不是 `?`
- 结果从 `result.rows` 获取

---

#### 5. `/api/recipes/[id].js` - 食谱详情、更新、删除
**需要修改的地方：**

**获取详情（GET）：**
```javascript
// PostgreSQL 方式
const result = await sql`
  SELECT 
    r.*,
    u.id as author_id,
    u.nick_name as author_nick_name,
    u.avatar as author_avatar
  FROM recipes r
  LEFT JOIN users u ON r.author_id = u.id
  WHERE r.id = ${id}::uuid AND r.status = 'published'
`;
const recipe = result.rows[0];
```

**更新（PUT）：**
```javascript
// PostgreSQL 方式
await sql`
  UPDATE recipes 
  SET title = ${title},
      cover_image = ${coverImage},
      updated_at = CURRENT_TIMESTAMP
  WHERE id = ${id}::uuid AND author_id = ${userId}::uuid
`;
```

**删除（DELETE）：**
```javascript
// PostgreSQL 方式
await sql`DELETE FROM recipes WHERE id = ${id}::uuid`;
```

**关键改动：**
- UUID 参数需要类型转换 `${id}::uuid`
- 时间戳使用 `CURRENT_TIMESTAMP`

---

#### 6. `/api/user/recipes.js` - 用户食谱列表
**需要修改：**
- 查询语法改为 PostgreSQL
- JSONB 字段解析

---

#### 7. `/api/categories/index.js` - 分类列表
**需要修改：**
```javascript
// PostgreSQL 方式
const result = await sql`
  SELECT DISTINCT category, COUNT(*) as count
  FROM recipes
  WHERE status = 'published'
  GROUP BY category
  ORDER BY count DESC
`;
const categories = result.rows;
```

---

#### 8. `/api/search/index.js` - 搜索
**需要修改：**
```javascript
// MySQL 方式（旧）
WHERE (title LIKE ? OR introduction LIKE ?)

// PostgreSQL 方式（新 - 更好的全文搜索）
WHERE (title ILIKE ${`%${keyword}%`} OR introduction ILIKE ${`%${keyword}%`})
```

**关键改动：**
- 使用 `ILIKE` 代替 `LIKE`（不区分大小写）
- 或使用 PostgreSQL 的全文搜索功能

---

### 优先级 3：互动功能 API

#### 9. `/api/comments/index.js` - 评论列表和发布
**需要修改：**
```javascript
// 创建评论
const result = await sql`
  INSERT INTO comments (recipe_id, user_id, content, images, reply_to)
  VALUES (
    ${recipeId}::uuid, 
    ${userId}::uuid, 
    ${content}, 
    ${JSON.stringify(images)}::jsonb,
    ${replyTo || null}::uuid
  )
  RETURNING id, content, created_at
`;
```

---

#### 10. `/api/comments/[id].js` - 删除评论
**需要修改：**
```javascript
// PostgreSQL 方式
await sql`
  DELETE FROM comments 
  WHERE id = ${id}::uuid AND user_id = ${userId}::uuid
`;
```

---

#### 11. `/api/likes/index.js` - 点赞
**需要修改：**
```javascript
// 添加点赞
await sql`
  INSERT INTO likes (user_id, recipe_id)
  VALUES (${userId}::uuid, ${recipeId}::uuid)
  ON CONFLICT (user_id, recipe_id) DO NOTHING
`;

// 删除点赞
await sql`
  DELETE FROM likes 
  WHERE user_id = ${userId}::uuid AND recipe_id = ${recipeId}::uuid
`;
```

**关键改动：**
- 使用 `ON CONFLICT ... DO NOTHING` 处理重复

---

#### 12. `/api/favorites/index.js` - 收藏
**需要修改：**
```javascript
// 添加收藏
await sql`
  INSERT INTO favorites (user_id, recipe_id)
  VALUES (${userId}::uuid, ${recipeId}::uuid)
  ON CONFLICT (user_id, recipe_id) DO NOTHING
`;
```

---

## 📋 详细操作步骤

### 步骤 1：更新辅助函数

在 `lib/db.js` 中添加辅助函数：

```javascript
// 添加到 lib/db.js

/**
 * 执行查询并返回所有行
 */
async function query(sqlQuery, params = []) {
  try {
    const result = await sql.query(sqlQuery, params);
    return result.rows;
  } catch (error) {
    console.error('数据库查询错误:', error);
    throw error;
  }
}

/**
 * 执行查询并返回第一行
 */
async function queryOne(sqlQuery, params = []) {
  const rows = await query(sqlQuery, params);
  return rows.length > 0 ? rows[0] : null;
}

module.exports = {
  sql,
  query,
  queryOne,
  testConnection
};
```

### 步骤 2：逐个更新 API 文件

按照上面的优先级顺序，逐个更新 API 文件。

**对于每个文件：**
1. 备份原文件（可选）
2. 更新导入语句：`const { sql } = require('../../lib/db');`
3. 将所有 MySQL 查询改为 PostgreSQL 语法
4. 测试该 API 端点

### 步骤 3：通用替换规则

**导入语句：**
```javascript
// 旧
const { query, queryOne } = require('../../lib/db');

// 新
const { sql } = require('../../lib/db');
```

**UUID 生成：**
```javascript
// 旧：手动生成
const id = generateUUID();

// 新：数据库自动生成（使用 RETURNING）
const result = await sql`INSERT ... RETURNING id`;
const id = result.rows[0].id;
```

**参数占位符：**
```javascript
// 旧：MySQL
WHERE id = ? AND status = ?

// 新：PostgreSQL
WHERE id = ${id} AND status = ${status}
```

**JSON 字段：**
```javascript
// 旧：MySQL
tags = '${JSON.stringify(tags)}'

// 新：PostgreSQL
tags = ${JSON.stringify(tags)}::jsonb
```

**UUID 类型转换：**
```javascript
// 当参数是 UUID 字符串时
WHERE id = ${id}::uuid
```

---

## 🧪 测试清单

更新完所有 API 后，按以下顺序测试：

### 1. 认证测试
- [ ] POST `/api/auth/login` - 微信登录
- [ ] GET `/api/user/info` - 获取当前用户信息
- [ ] PUT `/api/user/info` - 更新用户信息

### 2. 食谱测试
- [ ] GET `/api/recipes` - 获取食谱列表
- [ ] POST `/api/recipes` - 创建食谱
- [ ] GET `/api/recipes/:id` - 获取食谱详情
- [ ] PUT `/api/recipes/:id` - 更新食谱
- [ ] DELETE `/api/recipes/:id` - 删除食谱
- [ ] GET `/api/user/recipes` - 获取用户食谱

### 3. 分类和搜索
- [ ] GET `/api/categories` - 获取分类列表
- [ ] GET `/api/search?keyword=xxx` - 搜索食谱

### 4. 互动功能
- [ ] GET `/api/comments?recipeId=xxx` - 获取评论
- [ ] POST `/api/comments` - 发表评论
- [ ] DELETE `/api/comments/:id` - 删除评论
- [ ] POST `/api/likes` - 点赞
- [ ] DELETE `/api/likes` - 取消点赞
- [ ] POST `/api/favorites` - 收藏
- [ ] DELETE `/api/favorites` - 取消收藏

---

## 📝 注意事项

1. **UUID 处理**
   - PostgreSQL 的 UUID 是真正的 UUID 类型，不是字符串
   - 需要在查询中使用 `::uuid` 进行类型转换

2. **JSONB 字段**
   - PostgreSQL 使用 JSONB 类型存储 JSON
   - 插入时需要 `::jsonb` 类型转换
   - 查询 JSONB 字段可以使用 `->` 和 `->>` 操作符

3. **事务处理**
   - 如果需要事务，使用 `BEGIN`、`COMMIT`、`ROLLBACK`

4. **错误处理**
   - PostgreSQL 的错误代码与 MySQL 不同
   - 注意捕获和处理数据库错误

5. **性能优化**
   - PostgreSQL 已经创建了所有必要的索引
   - JSONB 字段查询性能很好

---

## 🚀 快速开始命令

```bash
# 1. 拉取最新代码
git pull

# 2. 安装依赖
npm install

# 3. 拉取环境变量
vercel env pull .env.local

# 4. 验证数据库
node -r dotenv/config scripts/verify-db.js dotenv_config_path=.env.local

# 5. 开始更新 API 文件
# （按照上面的清单逐个更新）

# 6. 本地测试（可选）
vercel dev

# 7. 提交更改
git add .
git commit -m "✅ 更新所有 API 以适配 PostgreSQL"
git push

# 8. 部署到 Vercel
vercel --prod
```

---

## 📞 需要帮助？

如果在更新过程中遇到问题：

1. **查看 PostgreSQL 文档**：https://www.postgresql.org/docs/
2. **查看 Vercel Postgres 文档**：https://vercel.com/docs/storage/vercel-postgres
3. **查看 @vercel/postgres SDK**：https://www.npmjs.com/package/@vercel/postgres
4. **参考 schema-postgres.sql** 了解表结构
5. **运行 verify-db.js** 验证数据库状态

---

## 🎯 预计工作量

- **简单 API**（只有查询）：5-10 分钟/个
- **复杂 API**（多表关联）：15-20 分钟/个
- **总预计时间**：2-3 小时

**建议分批完成：**
- 第 1 批：认证 + 用户（3 个 API）
- 第 2 批：食谱核心（4 个 API）
- 第 3 批：分类搜索（2 个 API）
- 第 4 批：互动功能（3 个 API）

---

**祝工作顺利！🎉**
