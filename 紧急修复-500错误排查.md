# ç´§æ€¥ä¿®å¤ï¼šé¦–é¡µAPIè¿”å›500é”™è¯¯

## ğŸš¨ é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**:
```
GET https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/home/feed 500 (Internal Server Error)
```

**å‰ç«¯æ—¥å¿—**:
```javascript
[Index] Load core data failed: {statusCode: 500, message: "Internal server error"}
```

---

## ğŸ” å¯èƒ½åŸå› 

### åŸå› 1: äº‘æ‰˜ç®¡è¿˜åœ¨éƒ¨ç½²ä¸­ â³

**æ£€æŸ¥æ–¹æ³•**:
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥"äº‘æ‰˜ç®¡" â†’ "æœåŠ¡ç®¡ç†"
3. æŸ¥çœ‹"éƒ¨ç½²å†å²"
4. ç¡®è®¤æœ€æ–°çš„éƒ¨ç½²çŠ¶æ€

**é¢„æœŸçŠ¶æ€**:
- âœ… éƒ¨ç½²æˆåŠŸ
- â³ éƒ¨ç½²ä¸­ï¼ˆç­‰å¾…3-5åˆ†é’Ÿï¼‰
- âŒ éƒ¨ç½²å¤±è´¥ï¼ˆæŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼‰

---

### åŸå› 2: æ•°æ®åº“è¿æ¥å¤±è´¥ ğŸ—„ï¸

**æ£€æŸ¥æ–¹æ³•**:
æŸ¥çœ‹äº‘æ‰˜ç®¡æ—¥å¿—ä¸­æ˜¯å¦æœ‰æ•°æ®åº“è¿æ¥é”™è¯¯ï¼š
```
getaddrinfo ENOTFOUND
Connection refused
Timeout
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®è®¤æ•°æ®åº“å®ä¾‹æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
- éªŒè¯æ•°æ®åº“ç™½åå•

---

### åŸå› 3: ä»£ç bugå¯¼è‡´å¼‚å¸¸ ğŸ›

**å¯èƒ½çš„é—®é¢˜ç‚¹**:
1. `recipe.user` ä¸º nullï¼ˆç”¨æˆ·æ•°æ®ç¼ºå¤±ï¼‰
2. åˆ†ç±»æ•°æ®æŸ¥è¯¢å¤±è´¥
3. è¿”å›æ ¼å¼é—®é¢˜

---

## ğŸ”§ ç«‹å³æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥äº‘æ‰˜ç®¡éƒ¨ç½²çŠ¶æ€

```bash
# æœ¬åœ°æµ‹è¯•ï¼šéªŒè¯ä»£ç ç¼–è¯‘
cd E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip-Backend
npm run build
```

**é¢„æœŸç»“æœ**:
- âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— æŠ¥é”™
- âŒ ç¼–è¯‘å¤±è´¥ï¼Œä¿®å¤TypeScripté”™è¯¯

---

### æ­¥éª¤2: æŸ¥çœ‹äº‘æ‰˜ç®¡æ—¥å¿—

1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥"äº‘æ‰˜ç®¡" â†’ "æ—¥å¿—ç®¡ç†"
3. ç­›é€‰æ—¶é—´ï¼šæœ€è¿‘10åˆ†é’Ÿ
4. æœç´¢å…³é”®è¯ï¼š`error` æˆ– `500`

**å…³é”®æ—¥å¿—**:
```
[NestJS] Error: ...
TypeError: Cannot read property 'user' of undefined
Database connection failed
```

---

### æ­¥éª¤3: æµ‹è¯•APIæ¥å£

```bash
# ç›´æ¥è®¿é—®API
curl -X GET "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/home/feed" -v
```

**æ­£å¸¸å“åº”** (200):
```json
{
  "banners": [...],
  "categories": [...],
  "hot_recipes": [...],
  "latest_recipes": [...],
  "recommended_recipes": [...]
}
```

**é”™è¯¯å“åº”** (500):
```json
{
  "statusCode": 500,
  "message": "Internal server error"
}
```

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ç­‰å¾…éƒ¨ç½²å®Œæˆ

å¦‚æœéƒ¨ç½²è¿˜åœ¨è¿›è¡Œä¸­ï¼š
1. â³ ç­‰å¾…3-5åˆ†é’Ÿ
2. ğŸ”„ åˆ·æ–°å°ç¨‹åºé¡µé¢
3. âœ… ç¡®è®¤æ˜¯å¦æ­£å¸¸

---

### æ–¹æ¡ˆ2: ä¿®å¤æ•°æ®å®Œæ•´æ€§é—®é¢˜

å¦‚æœæ˜¯å› ä¸º `recipe.user` ä¸º null å¯¼è‡´çš„é”™è¯¯ï¼Œä¿®æ”¹åç«¯ä»£ç ï¼š

**ä¿®æ”¹ `src/modules/stats/stats.service.ts`**:

```typescript
const formatRecipes = (recipes: Recipe[]) =>
  recipes.map((recipe) => ({
    id: recipe.id,
    title: recipe.title,
    cover_image: recipe.cover_image,
    description: recipe.description,
    difficulty: recipe.difficulty,
    cook_time: recipe.cook_time,
    tags: recipe.tags,
    likes: recipe.likes,
    favorites: recipe.favorites,
    views: recipe.views,
    user: recipe.user ? {  // âœ… æ·»åŠ ç©ºå€¼æ£€æŸ¥
      id: recipe.user.id,
      nickname: recipe.user.nickname,
      avatar: recipe.user.avatar,
    } : {  // âœ… é»˜è®¤ç”¨æˆ·ä¿¡æ¯
      id: 0,
      nickname: 'ç¾é£Ÿè¾¾äºº',
      avatar: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/userImage/Defaultavatar.png',
    },
    created_at: recipe.created_at,
  }));
```

---

### æ–¹æ¡ˆ3: æ·»åŠ é”™è¯¯æ•è·

**ä¿®æ”¹ `src/modules/stats/stats.service.ts`**:

```typescript
async getHomeFeed(page: number = 1, limit: number = 10) {
  try {
    const skip = (page - 1) * limit;

    // è·å–åˆ†ç±»
    const categories = await this.categoryRepository.find({
      order: { sort_order: 'ASC' },
      take: 10,
    });

    // è·å–çƒ­é—¨é£Ÿè°±ï¼ˆæŒ‰ç‚¹èµæ•°ï¼‰
    const hotRecipes = await this.recipeRepository
      .createQueryBuilder('recipe')
      .leftJoinAndSelect('recipe.user', 'user')
      .where('recipe.status = :status', { status: 'published' })
      .orderBy('recipe.likes', 'DESC')
      .take(10)
      .getMany();

    // å…¶ä»–æŸ¥è¯¢...
    
    // è¿”å›æ•°æ®
    return {
      banners,
      categories: categories.map((cat) => ({...})),
      hot_recipes: formatRecipes(hotRecipes),
      latest_recipes: formatRecipes(latestRecipes),
      recommended_recipes: formatRecipes(recommendedRecipes),
    };
  } catch (error) {
    console.error('[StatsService] getHomeFeed error:', error);
    throw error;  // æŠ›å‡ºé”™è¯¯ï¼Œè®©NestJSå¤„ç†
  }
}
```

---

### æ–¹æ¡ˆ4: ä¸´æ—¶è¿”å›é»˜è®¤æ•°æ®

å¦‚æœæ€¥éœ€ä¿®å¤ï¼Œå¯ä»¥å…ˆè¿”å›é»˜è®¤æ•°æ®ï¼š

**ä¿®æ”¹ `src/modules/stats/stats.service.ts`**:

```typescript
async getHomeFeed(page: number = 1, limit: number = 10) {
  try {
    // åŸæœ‰æŸ¥è¯¢é€»è¾‘...
  } catch (error) {
    console.error('[StatsService] getHomeFeed error:', error);
    
    // âœ… è¿”å›é»˜è®¤æ•°æ®ï¼Œé¿å…å‰ç«¯æŠ¥é”™
    return {
      banners: [
        {
          id: 1,
          image: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg',
          link: '/pages/index/index',
          title: 'è€ä¹¡é¸¡ç¾é£Ÿ',
        },
      ],
      categories: [],
      hot_recipes: [],
      latest_recipes: [],
      recommended_recipes: [],
    };
  }
}
```

---

## ğŸš€ é‡æ–°éƒ¨ç½²æ­¥éª¤

å¦‚æœéœ€è¦ä¿®æ”¹ä»£ç ï¼š

```bash
cd E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip-Backend

# 1. ä¿®æ”¹ä»£ç ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
# ...

# 2. æœ¬åœ°æµ‹è¯•
npm run build

# 3. æäº¤ä»£ç 
git add src/modules/stats/stats.service.ts
git commit -m "fix: æ·»åŠ é¦–é¡µAPIé”™è¯¯å¤„ç†å’Œç©ºå€¼æ£€æŸ¥"

# 4. æ¨é€åˆ°è¿œç¨‹
git push origin main

# 5. ç­‰å¾…äº‘æ‰˜ç®¡è‡ªåŠ¨éƒ¨ç½²ï¼ˆ3-5åˆ†é’Ÿï¼‰
```

---

## ğŸ“Š è°ƒè¯•å»ºè®®

### ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å¤‡ç”¨æ•°æ®

**ä¿®æ”¹å‰ç«¯ `pages/index/index.js`**:

åœ¨ `loadCoreData` æ–¹æ³•ä¸­æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†ï¼š

```javascript
async loadCoreData() {
  try {
    // å¹¶è¡Œè¯·æ±‚é¦–é¡µæ•°æ®ã€åˆ†ç±»å’Œæ¨èé£Ÿè°±
    const results = await Promise.all([
      api.stats.getHomeFeed(),  // è·å–é¦–é¡µæ•°æ®ï¼ˆåŒ…å«bannersï¼‰
      api.category.getCategoryListCached(),
      api.recipe.getRecipeList({
        page: 1,
        limit: 10,
        sort: 'recommended'
      })
    ])
    
    const homeData = results[0]
    const categories = results[1]
    const recipes = results[2]
    
    this.$batchSetData({
      banners: homeData.banners || [],
      categories: this.formatCategories(categories),
      recommendRecipes: this.formatRecipes(recipes.items || recipes.list || []),
      loading: false
    }, 0)
    
    console.log('[Index] Banners loaded:', homeData.banners)
  } catch (error) {
    console.error('[Index] Load core data failed:', error)
    
    // âœ… ä½¿ç”¨å¤‡ç”¨æ•°æ®ï¼Œç¡®ä¿é¡µé¢å¯ä»¥æ­£å¸¸æ˜¾ç¤º
    this.$batchSetData({
      banners: [
        {
          id: 1,
          image: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg',
          link: '/pages/index/index',
          title: 'è€ä¹¡é¸¡ç¾é£Ÿ'
        }
      ],  // âœ… æ·»åŠ é»˜è®¤banner
      categories: this.getDefaultCategories(),
      recommendRecipes: this.data.fallbackRecipes,
      loading: false
    }, 0)
    
    // æç¤ºç”¨æˆ·
    wx.showToast({
      title: 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      icon: 'none',
      duration: 2000
    })
  }
}
```

---

## ğŸ¯ å¿«é€ŸéªŒè¯æ¸…å•

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤éªŒè¯ï¼š

- [ ] **äº‘æ‰˜ç®¡éƒ¨ç½²çŠ¶æ€**
  - [ ] ç™»å½•äº‘æ‰˜ç®¡æ§åˆ¶å°
  - [ ] æŸ¥çœ‹æœ€æ–°éƒ¨ç½²è®°å½•
  - [ ] ç¡®è®¤éƒ¨ç½²æˆåŠŸ

- [ ] **æŸ¥çœ‹åç«¯æ—¥å¿—**
  - [ ] æœç´¢ `error` å…³é”®è¯
  - [ ] æŸ¥æ‰¾ `500` çŠ¶æ€ç 
  - [ ] å®šä½å…·ä½“é”™è¯¯åŸå› 

- [ ] **æµ‹è¯•APIæ¥å£**
  - [ ] ä½¿ç”¨curlæµ‹è¯• `/api/v1/home/feed`
  - [ ] æ£€æŸ¥å“åº”çŠ¶æ€ç 
  - [ ] éªŒè¯è¿”å›æ•°æ®æ ¼å¼

- [ ] **æ£€æŸ¥æ•°æ®åº“**
  - [ ] ç¡®è®¤æ•°æ®åº“å®ä¾‹è¿è¡Œæ­£å¸¸
  - [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§
  - [ ] æ£€æŸ¥ç”¨æˆ·æ•°æ®æ˜¯å¦å…³è”æ­£ç¡®

- [ ] **å‰ç«¯è°ƒè¯•**
  - [ ] æŸ¥çœ‹Networké¢æ¿
  - [ ] æ£€æŸ¥Consoleé”™è¯¯
  - [ ] éªŒè¯APIè°ƒç”¨å‚æ•°

---

## ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®

### å¦‚æœæ˜¯éƒ¨ç½²ä¸­

â³ **è¯·ç­‰å¾…3-5åˆ†é’Ÿ**ï¼Œç„¶åï¼š
1. åˆ·æ–°å°ç¨‹åºé¡µé¢
2. æŸ¥çœ‹æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
3. å¦‚æœä»ç„¶æŠ¥é”™ï¼ŒæŸ¥çœ‹åç«¯æ—¥å¿—

### å¦‚æœæ˜¯ä»£ç bug

ğŸ› **è¯·æä¾›åç«¯æ—¥å¿—**ï¼Œæˆ‘ä¼šå¸®æ‚¨ï¼š
1. å®šä½å…·ä½“é”™è¯¯
2. ä¿®å¤ä»£ç é—®é¢˜
3. é‡æ–°éƒ¨ç½²

### å¦‚æœæ˜¯æ•°æ®é—®é¢˜

ğŸ—„ï¸ **éœ€è¦ä¿®å¤æ•°æ®**ï¼š
1. æ·»åŠ ç©ºå€¼æ£€æŸ¥
2. è¡¥å……ç¼ºå¤±çš„ç”¨æˆ·æ•°æ®
3. éªŒè¯æ•°æ®å®Œæ•´æ€§

---

## ğŸ“ éœ€è¦æä¾›çš„ä¿¡æ¯

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ï¼š

1. **äº‘æ‰˜ç®¡éƒ¨ç½²çŠ¶æ€**
   - æœ€æ–°éƒ¨ç½²è®°å½•çš„çŠ¶æ€
   - éƒ¨ç½²æ—¶é—´

2. **åç«¯æ—¥å¿—**
   ```
   # åœ¨äº‘æ‰˜ç®¡æ—¥å¿—ä¸­æœç´¢
   å…³é”®è¯: error, 500
   æ—¶é—´èŒƒå›´: æœ€è¿‘10åˆ†é’Ÿ
   ```

3. **APIæµ‹è¯•ç»“æœ**
   ```bash
   curl -X GET "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/home/feed" -v
   ```

4. **æ•°æ®åº“çŠ¶æ€**
   - æ•°æ®åº“å®ä¾‹æ˜¯å¦è¿è¡Œ
   - recipesè¡¨çš„è®°å½•æ•°
   - usersè¡¨çš„è®°å½•æ•°

---

**åˆ›å»ºæ—¶é—´**: 2025å¹´10æœˆ29æ—¥  
**é—®é¢˜ç±»å‹**: é¦–é¡µAPIè¿”å›500é”™è¯¯  
**ä¼˜å…ˆçº§**: ğŸš¨ é«˜

