# 紧急修复：首页API返回500错误

## 🚨 问题描述

**错误信息**:
```
GET https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/home/feed 500 (Internal Server Error)
```

**前端日志**:
```javascript
[Index] Load core data failed: {statusCode: 500, message: "Internal server error"}
```

---

## 🔍 可能原因

### 原因1: 云托管还在部署中 ⏳

**检查方法**:
1. 登录腾讯云控制台
2. 进入"云托管" → "服务管理"
3. 查看"部署历史"
4. 确认最新的部署状态

**预期状态**:
- ✅ 部署成功
- ⏳ 部署中（等待3-5分钟）
- ❌ 部署失败（查看错误日志）

---

### 原因2: 数据库连接失败 🗄️

**检查方法**:
查看云托管日志中是否有数据库连接错误：
```
getaddrinfo ENOTFOUND
Connection refused
Timeout
```

**解决方案**:
- 确认数据库实例是否运行
- 检查环境变量配置
- 验证数据库白名单

---

### 原因3: 代码bug导致异常 🐛

**可能的问题点**:
1. `recipe.user` 为 null（用户数据缺失）
2. 分类数据查询失败
3. 返回格式问题

---

## 🔧 立即排查步骤

### 步骤1: 检查云托管部署状态

```bash
# 本地测试：验证代码编译
cd E:\前端项目文档\项目文件夹\CookTip-Backend
npm run build
```

**预期结果**:
- ✅ 编译成功，无报错
- ❌ 编译失败，修复TypeScript错误

---

### 步骤2: 查看云托管日志

1. 登录腾讯云控制台
2. 进入"云托管" → "日志管理"
3. 筛选时间：最近10分钟
4. 搜索关键词：`error` 或 `500`

**关键日志**:
```
[NestJS] Error: ...
TypeError: Cannot read property 'user' of undefined
Database connection failed
```

---

### 步骤3: 测试API接口

```bash
# 直接访问API
curl -X GET "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/home/feed" -v
```

**正常响应** (200):
```json
{
  "banners": [...],
  "categories": [...],
  "hot_recipes": [...],
  "latest_recipes": [...],
  "recommended_recipes": [...]
}
```

**错误响应** (500):
```json
{
  "statusCode": 500,
  "message": "Internal server error"
}
```

---

## 🛠️ 修复方案

### 方案1: 等待部署完成

如果部署还在进行中：
1. ⏳ 等待3-5分钟
2. 🔄 刷新小程序页面
3. ✅ 确认是否正常

---

### 方案2: 修复数据完整性问题

如果是因为 `recipe.user` 为 null 导致的错误，修改后端代码：

**修改 `src/modules/stats/stats.service.ts`**:

```typescript
const formatRecipes = (recipes: Recipe[]) =>
  recipes.map((recipe) => ({
    id: recipe.id,
    title: recipe.title,
    cover_image: recipe.cover_image,
    description: recipe.description,
    difficulty: recipe.difficulty,
    cook_time: recipe.cook_time,
    tags: recipe.tags,
    likes: recipe.likes,
    favorites: recipe.favorites,
    views: recipe.views,
    user: recipe.user ? {  // ✅ 添加空值检查
      id: recipe.user.id,
      nickname: recipe.user.nickname,
      avatar: recipe.user.avatar,
    } : {  // ✅ 默认用户信息
      id: 0,
      nickname: '美食达人',
      avatar: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/userImage/Defaultavatar.png',
    },
    created_at: recipe.created_at,
  }));
```

---

### 方案3: 添加错误捕获

**修改 `src/modules/stats/stats.service.ts`**:

```typescript
async getHomeFeed(page: number = 1, limit: number = 10) {
  try {
    const skip = (page - 1) * limit;

    // 获取分类
    const categories = await this.categoryRepository.find({
      order: { sort_order: 'ASC' },
      take: 10,
    });

    // 获取热门食谱（按点赞数）
    const hotRecipes = await this.recipeRepository
      .createQueryBuilder('recipe')
      .leftJoinAndSelect('recipe.user', 'user')
      .where('recipe.status = :status', { status: 'published' })
      .orderBy('recipe.likes', 'DESC')
      .take(10)
      .getMany();

    // 其他查询...
    
    // 返回数据
    return {
      banners,
      categories: categories.map((cat) => ({...})),
      hot_recipes: formatRecipes(hotRecipes),
      latest_recipes: formatRecipes(latestRecipes),
      recommended_recipes: formatRecipes(recommendedRecipes),
    };
  } catch (error) {
    console.error('[StatsService] getHomeFeed error:', error);
    throw error;  // 抛出错误，让NestJS处理
  }
}
```

---

### 方案4: 临时返回默认数据

如果急需修复，可以先返回默认数据：

**修改 `src/modules/stats/stats.service.ts`**:

```typescript
async getHomeFeed(page: number = 1, limit: number = 10) {
  try {
    // 原有查询逻辑...
  } catch (error) {
    console.error('[StatsService] getHomeFeed error:', error);
    
    // ✅ 返回默认数据，避免前端报错
    return {
      banners: [
        {
          id: 1,
          image: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg',
          link: '/pages/index/index',
          title: '老乡鸡美食',
        },
      ],
      categories: [],
      hot_recipes: [],
      latest_recipes: [],
      recommended_recipes: [],
    };
  }
}
```

---

## 🚀 重新部署步骤

如果需要修改代码：

```bash
cd E:\前端项目文档\项目文件夹\CookTip-Backend

# 1. 修改代码（添加错误处理）
# ...

# 2. 本地测试
npm run build

# 3. 提交代码
git add src/modules/stats/stats.service.ts
git commit -m "fix: 添加首页API错误处理和空值检查"

# 4. 推送到远程
git push origin main

# 5. 等待云托管自动部署（3-5分钟）
```

---

## 📊 调试建议

### 临时解决方案：使用备用数据

**修改前端 `pages/index/index.js`**:

在 `loadCoreData` 方法中添加更详细的错误处理：

```javascript
async loadCoreData() {
  try {
    // 并行请求首页数据、分类和推荐食谱
    const results = await Promise.all([
      api.stats.getHomeFeed(),  // 获取首页数据（包含banners）
      api.category.getCategoryListCached(),
      api.recipe.getRecipeList({
        page: 1,
        limit: 10,
        sort: 'recommended'
      })
    ])
    
    const homeData = results[0]
    const categories = results[1]
    const recipes = results[2]
    
    this.$batchSetData({
      banners: homeData.banners || [],
      categories: this.formatCategories(categories),
      recommendRecipes: this.formatRecipes(recipes.items || recipes.list || []),
      loading: false
    }, 0)
    
    console.log('[Index] Banners loaded:', homeData.banners)
  } catch (error) {
    console.error('[Index] Load core data failed:', error)
    
    // ✅ 使用备用数据，确保页面可以正常显示
    this.$batchSetData({
      banners: [
        {
          id: 1,
          image: 'https://yjsp-1367462091.cos.ap-nanjing.myqcloud.com/laoxiangji/LXJLOGO/LxjAd.jpg',
          link: '/pages/index/index',
          title: '老乡鸡美食'
        }
      ],  // ✅ 添加默认banner
      categories: this.getDefaultCategories(),
      recommendRecipes: this.data.fallbackRecipes,
      loading: false
    }, 0)
    
    // 提示用户
    wx.showToast({
      title: '数据加载失败，请稍后重试',
      icon: 'none',
      duration: 2000
    })
  }
}
```

---

## 🎯 快速验证清单

请按照以下步骤验证：

- [ ] **云托管部署状态**
  - [ ] 登录云托管控制台
  - [ ] 查看最新部署记录
  - [ ] 确认部署成功

- [ ] **查看后端日志**
  - [ ] 搜索 `error` 关键词
  - [ ] 查找 `500` 状态码
  - [ ] 定位具体错误原因

- [ ] **测试API接口**
  - [ ] 使用curl测试 `/api/v1/home/feed`
  - [ ] 检查响应状态码
  - [ ] 验证返回数据格式

- [ ] **检查数据库**
  - [ ] 确认数据库实例运行正常
  - [ ] 验证数据完整性
  - [ ] 检查用户数据是否关联正确

- [ ] **前端调试**
  - [ ] 查看Network面板
  - [ ] 检查Console错误
  - [ ] 验证API调用参数

---

## 💡 下一步建议

### 如果是部署中

⏳ **请等待3-5分钟**，然后：
1. 刷新小程序页面
2. 查看是否正常显示
3. 如果仍然报错，查看后端日志

### 如果是代码bug

🐛 **请提供后端日志**，我会帮您：
1. 定位具体错误
2. 修复代码问题
3. 重新部署

### 如果是数据问题

🗄️ **需要修复数据**：
1. 添加空值检查
2. 补充缺失的用户数据
3. 验证数据完整性

---

## 📞 需要提供的信息

如果问题仍未解决，请提供：

1. **云托管部署状态**
   - 最新部署记录的状态
   - 部署时间

2. **后端日志**
   ```
   # 在云托管日志中搜索
   关键词: error, 500
   时间范围: 最近10分钟
   ```

3. **API测试结果**
   ```bash
   curl -X GET "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/home/feed" -v
   ```

4. **数据库状态**
   - 数据库实例是否运行
   - recipes表的记录数
   - users表的记录数

---

**创建时间**: 2025年10月29日  
**问题类型**: 首页API返回500错误  
**优先级**: 🚨 高

