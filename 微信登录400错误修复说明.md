# å¾®ä¿¡ç™»å½• 400 é”™è¯¯ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

å‰ç«¯è¯·æ±‚å¾®ä¿¡ç™»å½•æ¥å£æ—¶è¿”å› 400 é”™è¯¯ï¼š

```json
{
  "code": 400,
  "message": "property nickName should not exist",
  "error": "Bad Request",
  "timestamp": "2025-10-09T08:42:33.643Z",
  "path": "/api/v1/auth/wx-login"
}
```

## ğŸ” é—®é¢˜åŸå› 

**å­—æ®µå‘½åä¸åŒ¹é…**ï¼š

å‰ç«¯å‘é€çš„æ•°æ®ï¼š
```javascript
{
  code: "0a3kZZ000T...",
  nickName: "å¾®ä¿¡ç”¨æˆ·",  // é©¼å³°å¼å‘½å
  avatar: "https://..."   
}
```

åç«¯ DTO æœŸæœ›çš„å­—æ®µï¼š
```typescript
{
  code: string;
  nickname?: string;  // å…¨å°å†™å‘½å
  avatar?: string;
}
```

Nest.js çš„ `class-validator` ä¸¥æ ¼æ ¡éªŒäº† DTO å­—æ®µï¼Œä¸å…è®¸é¢å¤–çš„å­—æ®µï¼ˆ`nickName`ï¼‰å­˜åœ¨ï¼Œå› æ­¤è¿”å› 400 Bad Requestã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1ï¸âƒ£ æ›´æ–° DTOï¼ˆæ”¯æŒä¸¤ç§å‘½åæ–¹å¼ï¼‰

ä¿®æ”¹ `src/modules/auth/dto/wechat-login.dto.ts`ï¼š

```typescript
export class WechatLoginDto {
  @ApiProperty({ description: 'å¾®ä¿¡ç™»å½•å‡­è¯ code' })
  @IsString()
  code: string;

  // æ”¯æŒå…¨å°å†™å‘½å
  @ApiPropertyOptional({ description: 'ç”¨æˆ·æ˜µç§°' })
  @IsOptional()
  @IsString()
  nickname?: string;

  // å…¼å®¹é©¼å³°å¼å‘½åï¼ˆå‰ç«¯ä½¿ç”¨ï¼‰
  @ApiPropertyOptional({ description: 'ç”¨æˆ·æ˜µç§°ï¼ˆé©¼å³°å¼ï¼Œå…¼å®¹å‰ç«¯ï¼‰' })
  @IsOptional()
  @IsString()
  nickName?: string;

  // æ”¯æŒ avatar
  @ApiPropertyOptional({ description: 'ç”¨æˆ·å¤´åƒURL' })
  @IsOptional()
  @IsString()
  avatar?: string;

  // å…¼å®¹ avatarUrl
  @ApiPropertyOptional({ description: 'ç”¨æˆ·å¤´åƒURLï¼ˆé©¼å³°å¼ï¼Œå…¼å®¹å‰ç«¯ï¼‰' })
  @IsOptional()
  @IsString()
  avatarUrl?: string;

  @ApiPropertyOptional({ description: 'æ˜¯å¦æœ‰å¤´åƒ' })
  @IsOptional()
  hasAvatar?: boolean;
}
```

### 2ï¸âƒ£ æ›´æ–°ç™»å½•æœåŠ¡é€»è¾‘

ä¿®æ”¹ `src/modules/auth/auth.service.ts`ï¼š

```typescript
async wechatLogin(wechatLoginDto: WechatLoginDto) {
  const { code, nickname, nickName, avatar, avatarUrl } = wechatLoginDto;

  // å…¼å®¹ä¸¤ç§å‘½åæ–¹å¼ï¼šä¼˜å…ˆä½¿ç”¨é©¼å³°å¼
  const userNickname = nickName || nickname;
  const userAvatar = avatarUrl || avatar;

  // 1. é€šè¿‡ code æ¢å– openid
  const { openid, session_key } = await this.code2Session(code);

  // 2. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
  let user = await this.userRepository.findOne({ where: { openid } });

  if (!user) {
    user = this.userRepository.create({
      openid,
      nickname: userNickname || 'ç¾é£Ÿçˆ±å¥½è€…',
      avatar: userAvatar || '',
    });
    await this.userRepository.save(user);
  } else {
    if (userNickname) user.nickname = userNickname;
    if (userAvatar) user.avatar = userAvatar;
    await this.userRepository.save(user);
  }

  // 3. ç”Ÿæˆ JWT Token
  const access_token = this.generateToken(user);

  return {
    access_token,
    user: { /* ... */ }
  };
}
```

### 3ï¸âƒ£ å…¼å®¹ç¯å¢ƒå˜é‡

åŒæ—¶æ”¯æŒ `WX_APPID`/`WX_SECRET` å’Œ `WECHAT_APPID`/`WECHAT_SECRET`ï¼š

```typescript
private async code2Session(code: string) {
  const appid = this.configService.get('WX_APPID') || this.configService.get('WECHAT_APPID');
  const secret = this.configService.get('WX_SECRET') || this.configService.get('WECHAT_SECRET');
  // ...
}
```

## ğŸ“‹ æ”¯æŒçš„è¯·æ±‚æ ¼å¼

ä¿®å¤åï¼Œåç«¯åŒæ—¶æ”¯æŒä»¥ä¸‹è¯·æ±‚æ ¼å¼ï¼š

### æ ¼å¼ 1: å…¨å°å†™ï¼ˆæ ‡å‡†ï¼‰
```json
{
  "code": "0a3kZZ000T...",
  "nickname": "å¾®ä¿¡ç”¨æˆ·",
  "avatar": "https://..."
}
```

### æ ¼å¼ 2: é©¼å³°å¼ï¼ˆå‰ç«¯ä½¿ç”¨ï¼‰
```json
{
  "code": "0a3kZZ000T...",
  "nickName": "å¾®ä¿¡ç”¨æˆ·",
  "avatarUrl": "https://..."
}
```

### æ ¼å¼ 3: æ··åˆï¼ˆéƒ½æ”¯æŒï¼‰
```json
{
  "code": "0a3kZZ000T...",
  "nickName": "å¾®ä¿¡ç”¨æˆ·",
  "avatar": "https://...",
  "hasAvatar": true
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æœ¬åœ°æµ‹è¯•

```bash
# ä½¿ç”¨é©¼å³°å¼å‘½å
curl -X POST "http://localhost:3000/api/v1/auth/wx-login" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "test-code",
    "nickName": "æµ‹è¯•ç”¨æˆ·",
    "avatarUrl": "https://test.com/avatar.jpg"
  }'

# ä½¿ç”¨å…¨å°å†™å‘½å
curl -X POST "http://localhost:3000/api/v1/auth/wx-login" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "test-code",
    "nickname": "æµ‹è¯•ç”¨æˆ·",
    "avatar": "https://test.com/avatar.jpg"
  }'
```

### å°ç¨‹åºæµ‹è¯•

```javascript
// pages/login/login.js
async handleWechatLogin() {
  try {
    // 1. è·å–å¾®ä¿¡æˆæƒä¿¡æ¯
    const userInfo = await wx.getUserProfile({
      desc: 'ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™'
    });

    // 2. è·å–ç™»å½• code
    const loginRes = await wx.login();
    
    // 3. è°ƒç”¨åç«¯ç™»å½•æ¥å£
    const res = await wx.request({
      url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wx-login',
      method: 'POST',
      data: {
        code: loginRes.code,
        nickName: userInfo.userInfo.nickName,  // é©¼å³°å¼ï¼Œç°åœ¨æ”¯æŒäº†ï¼
        avatarUrl: userInfo.userInfo.avatarUrl
      }
    });

    if (res.data.code === 200) {
      console.log('ç™»å½•æˆåŠŸ:', res.data.data);
      
      // ä¿å­˜ token
      wx.setStorageSync('token', res.data.data.access_token);
      wx.setStorageSync('userInfo', res.data.data.user);
      
      // è·³è½¬åˆ°é¦–é¡µ
      wx.switchTab({ url: '/pages/index/index' });
    }
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    wx.showToast({
      title: 'ç™»å½•å¤±è´¥',
      icon: 'none'
    });
  }
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1ï¸âƒ£ ä»£ç å·²æ¨é€ âœ…
ä¿®å¤ä»£ç å·²æ¨é€åˆ° GitHub `main` åˆ†æ”¯ã€‚

### 2ï¸âƒ£ é‡æ–°éƒ¨ç½²äº‘æ‰˜ç®¡ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰

1. æ‰“å¼€ [å¾®ä¿¡äº‘æ‰˜ç®¡æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
2. æ‰¾åˆ°æœåŠ¡ `yjsp-ytg`
3. ç‚¹å‡»ã€Œæ–°å»ºç‰ˆæœ¬ã€
4. é€‰æ‹©ä» GitHub æ‹‰å–ä»£ç ï¼ˆ`main` åˆ†æ”¯ï¼‰
5. ç­‰å¾…æ„å»ºå®Œæˆï¼ˆçº¦ 2-3 åˆ†é’Ÿï¼‰

### 3ï¸âƒ£ éªŒè¯ä¿®å¤

éƒ¨ç½²å®Œæˆåï¼Œåœ¨å°ç¨‹åºä¸­æµ‹è¯•ç™»å½•åŠŸèƒ½ï¼š

**æœŸæœ›ç»“æœ**ï¼š
- âœ… è¿”å›çŠ¶æ€ç  `200`
- âœ… è¿”å›åŒ…å« `access_token` å’Œ `user` å¯¹è±¡
- âŒ ä¸åº”è¯¥å†å‡ºç° `400` æˆ– `"property nickName should not exist"` é”™è¯¯

## ğŸ“Š å®Œæ•´çš„ç™»å½•æµç¨‹

```
1. å‰ç«¯è°ƒç”¨ wx.getUserProfile()
   â†“
2. è·å–ç”¨æˆ·æ˜µç§°å’Œå¤´åƒ
   â†“
3. å‰ç«¯è°ƒç”¨ wx.login()
   â†“
4. è·å–ä¸´æ—¶ç™»å½•å‡­è¯ code
   â†“
5. å‰ç«¯å‘é€ {code, nickName, avatarUrl} åˆ°åç«¯
   â†“
6. åç«¯è°ƒç”¨å¾®ä¿¡ API: code2Session
   â†“
7. è·å– openid å’Œ session_key
   â†“
8. åç«¯æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
   â†“
9. ç”Ÿæˆ JWT Token
   â†“
10. è¿”å› {access_token, user} ç»™å‰ç«¯
    â†“
11. å‰ç«¯ä¿å­˜ token åˆ°æœ¬åœ°å­˜å‚¨
    â†“
12. ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿åœ¨äº‘æ‰˜ç®¡æ§åˆ¶å°é…ç½®äº†ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```env
WX_APPID=wx8486e57500ac0a55
WX_SECRET=bd4c652097608bb064350cc7e3b5801c
```

æˆ–è€…ä½¿ç”¨ï¼š

```env
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c
```

**ä¸¤ç§é…ç½®éƒ½æ”¯æŒï¼**

### 2. å¾®ä¿¡å°ç¨‹åºé…ç½®

ç¡®ä¿å°ç¨‹åºçš„ AppID ä¸ç¯å¢ƒå˜é‡ä¸­çš„ `WX_APPID` ä¸€è‡´ã€‚

### 3. æœåŠ¡å™¨åŸŸåé…ç½®

åœ¨å¾®ä¿¡å°ç¨‹åºåå°é…ç½®æœåŠ¡å™¨åŸŸåï¼š
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦æ”¯æŒä¸¤ç§å‘½åæ–¹å¼ï¼Ÿ
**A**: å‰ç«¯å°ç¨‹åºæ¡†æ¶é€šå¸¸ä½¿ç”¨é©¼å³°å¼å‘½åï¼ˆ`nickName`ï¼‰ï¼Œè€Œåç«¯å¼€å‘è§„èŒƒå»ºè®®ä½¿ç”¨å…¨å°å†™ï¼ˆ`nickname`ï¼‰ã€‚ä¸ºäº†å…¼å®¹æ€§å’Œçµæ´»æ€§ï¼Œåç«¯åŒæ—¶æ”¯æŒä¸¤ç§æ–¹å¼ã€‚

### Q2: ä¼˜å…ˆä½¿ç”¨å“ªä¸ªå­—æ®µï¼Ÿ
**A**: ä»£ç ä¸­ä¼˜å…ˆä½¿ç”¨é©¼å³°å¼å­—æ®µï¼š
```typescript
const userNickname = nickName || nickname;  // ä¼˜å…ˆ nickName
```

### Q3: è¿˜æ˜¯è¿”å› 400 æ€ä¹ˆåŠï¼Ÿ
**A**: 
1. ç¡®è®¤å·²é‡æ–°éƒ¨ç½²äº‘æ‰˜ç®¡
2. æ£€æŸ¥å‰ç«¯å‘é€çš„å­—æ®µåæ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹äº‘æ‰˜ç®¡æ—¥å¿—æ’æŸ¥é”™è¯¯

### Q4: ç™»å½•åè¿˜æ˜¯è¿”å› 401ï¼Ÿ
**A**: å¯èƒ½çš„åŸå› ï¼š
- å¾®ä¿¡ code å·²è¿‡æœŸï¼ˆæœ‰æ•ˆæœŸ 5 åˆ†é’Ÿï¼‰
- AppID æˆ– Secret é…ç½®é”™è¯¯
- å¾®ä¿¡æœåŠ¡å™¨ç½‘ç»œé—®é¢˜

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `å¾®ä¿¡ç™»å½•æ¥å£ä¿®å¤è¯´æ˜.md` - ä¹‹å‰çš„ 404 é”™è¯¯ä¿®å¤
- `æ¥å£é—®é¢˜æ±‡æ€»åŠä¿®å¤æŠ¥å‘Š.md` - æ‰€æœ‰é—®é¢˜æ±‡æ€»

## ğŸ¯ å·²ä¿®å¤çš„æ‰€æœ‰ç™»å½•é—®é¢˜

| é—®é¢˜ | çŠ¶æ€ | ä¿®å¤å†…å®¹ |
|------|------|----------|
| 404: è·¯ç”±ä¸å­˜åœ¨ | âœ… å·²ä¿®å¤ | æ·»åŠ  `wx-login` è·¯ç”±åˆ«å |
| 400: å­—æ®µåä¸åŒ¹é… | âœ… å·²ä¿®å¤ | æ”¯æŒ `nickName` å’Œ `nickname` |
| ç¯å¢ƒå˜é‡ä¸åŒ¹é… | âœ… å·²ä¿®å¤ | æ”¯æŒ `WX_APPID` å’Œ `WECHAT_APPID` |

---

**ä¿®å¤å·²å®Œæˆï¼Œè¯·é‡æ–°éƒ¨ç½²äº‘æ‰˜ç®¡æœåŠ¡åæµ‹è¯•ï¼** ğŸš€

