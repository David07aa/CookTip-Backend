# 微信登录 400 错误修复说明

## 🐛 问题描述

前端请求微信登录接口时返回 400 错误：

```json
{
  "code": 400,
  "message": "property nickName should not exist",
  "error": "Bad Request",
  "timestamp": "2025-10-09T08:42:33.643Z",
  "path": "/api/v1/auth/wx-login"
}
```

## 🔍 问题原因

**字段命名不匹配**：

前端发送的数据：
```javascript
{
  code: "0a3kZZ000T...",
  nickName: "微信用户",  // 驼峰式命名
  avatar: "https://..."   
}
```

后端 DTO 期望的字段：
```typescript
{
  code: string;
  nickname?: string;  // 全小写命名
  avatar?: string;
}
```

Nest.js 的 `class-validator` 严格校验了 DTO 字段，不允许额外的字段（`nickName`）存在，因此返回 400 Bad Request。

## ✅ 修复方案

### 1️⃣ 更新 DTO（支持两种命名方式）

修改 `src/modules/auth/dto/wechat-login.dto.ts`：

```typescript
export class WechatLoginDto {
  @ApiProperty({ description: '微信登录凭证 code' })
  @IsString()
  code: string;

  // 支持全小写命名
  @ApiPropertyOptional({ description: '用户昵称' })
  @IsOptional()
  @IsString()
  nickname?: string;

  // 兼容驼峰式命名（前端使用）
  @ApiPropertyOptional({ description: '用户昵称（驼峰式，兼容前端）' })
  @IsOptional()
  @IsString()
  nickName?: string;

  // 支持 avatar
  @ApiPropertyOptional({ description: '用户头像URL' })
  @IsOptional()
  @IsString()
  avatar?: string;

  // 兼容 avatarUrl
  @ApiPropertyOptional({ description: '用户头像URL（驼峰式，兼容前端）' })
  @IsOptional()
  @IsString()
  avatarUrl?: string;

  @ApiPropertyOptional({ description: '是否有头像' })
  @IsOptional()
  hasAvatar?: boolean;
}
```

### 2️⃣ 更新登录服务逻辑

修改 `src/modules/auth/auth.service.ts`：

```typescript
async wechatLogin(wechatLoginDto: WechatLoginDto) {
  const { code, nickname, nickName, avatar, avatarUrl } = wechatLoginDto;

  // 兼容两种命名方式：优先使用驼峰式
  const userNickname = nickName || nickname;
  const userAvatar = avatarUrl || avatar;

  // 1. 通过 code 换取 openid
  const { openid, session_key } = await this.code2Session(code);

  // 2. 查找或创建用户
  let user = await this.userRepository.findOne({ where: { openid } });

  if (!user) {
    user = this.userRepository.create({
      openid,
      nickname: userNickname || '美食爱好者',
      avatar: userAvatar || '',
    });
    await this.userRepository.save(user);
  } else {
    if (userNickname) user.nickname = userNickname;
    if (userAvatar) user.avatar = userAvatar;
    await this.userRepository.save(user);
  }

  // 3. 生成 JWT Token
  const access_token = this.generateToken(user);

  return {
    access_token,
    user: { /* ... */ }
  };
}
```

### 3️⃣ 兼容环境变量

同时支持 `WX_APPID`/`WX_SECRET` 和 `WECHAT_APPID`/`WECHAT_SECRET`：

```typescript
private async code2Session(code: string) {
  const appid = this.configService.get('WX_APPID') || this.configService.get('WECHAT_APPID');
  const secret = this.configService.get('WX_SECRET') || this.configService.get('WECHAT_SECRET');
  // ...
}
```

## 📋 支持的请求格式

修复后，后端同时支持以下请求格式：

### 格式 1: 全小写（标准）
```json
{
  "code": "0a3kZZ000T...",
  "nickname": "微信用户",
  "avatar": "https://..."
}
```

### 格式 2: 驼峰式（前端使用）
```json
{
  "code": "0a3kZZ000T...",
  "nickName": "微信用户",
  "avatarUrl": "https://..."
}
```

### 格式 3: 混合（都支持）
```json
{
  "code": "0a3kZZ000T...",
  "nickName": "微信用户",
  "avatar": "https://...",
  "hasAvatar": true
}
```

## 🧪 测试验证

### 本地测试

```bash
# 使用驼峰式命名
curl -X POST "http://localhost:3000/api/v1/auth/wx-login" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "test-code",
    "nickName": "测试用户",
    "avatarUrl": "https://test.com/avatar.jpg"
  }'

# 使用全小写命名
curl -X POST "http://localhost:3000/api/v1/auth/wx-login" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "test-code",
    "nickname": "测试用户",
    "avatar": "https://test.com/avatar.jpg"
  }'
```

### 小程序测试

```javascript
// pages/login/login.js
async handleWechatLogin() {
  try {
    // 1. 获取微信授权信息
    const userInfo = await wx.getUserProfile({
      desc: '用于完善会员资料'
    });

    // 2. 获取登录 code
    const loginRes = await wx.login();
    
    // 3. 调用后端登录接口
    const res = await wx.request({
      url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wx-login',
      method: 'POST',
      data: {
        code: loginRes.code,
        nickName: userInfo.userInfo.nickName,  // 驼峰式，现在支持了！
        avatarUrl: userInfo.userInfo.avatarUrl
      }
    });

    if (res.data.code === 200) {
      console.log('登录成功:', res.data.data);
      
      // 保存 token
      wx.setStorageSync('token', res.data.data.access_token);
      wx.setStorageSync('userInfo', res.data.data.user);
      
      // 跳转到首页
      wx.switchTab({ url: '/pages/index/index' });
    }
  } catch (error) {
    console.error('登录失败:', error);
    wx.showToast({
      title: '登录失败',
      icon: 'none'
    });
  }
}
```

## 🚀 部署步骤

### 1️⃣ 代码已推送 ✅
修复代码已推送到 GitHub `main` 分支。

### 2️⃣ 重新部署云托管（必须执行）

1. 打开 [微信云托管控制台](https://console.cloud.tencent.com/tcb)
2. 找到服务 `yjsp-ytg`
3. 点击「新建版本」
4. 选择从 GitHub 拉取代码（`main` 分支）
5. 等待构建完成（约 2-3 分钟）

### 3️⃣ 验证修复

部署完成后，在小程序中测试登录功能：

**期望结果**：
- ✅ 返回状态码 `200`
- ✅ 返回包含 `access_token` 和 `user` 对象
- ❌ 不应该再出现 `400` 或 `"property nickName should not exist"` 错误

## 📊 完整的登录流程

```
1. 前端调用 wx.getUserProfile()
   ↓
2. 获取用户昵称和头像
   ↓
3. 前端调用 wx.login()
   ↓
4. 获取临时登录凭证 code
   ↓
5. 前端发送 {code, nickName, avatarUrl} 到后端
   ↓
6. 后端调用微信 API: code2Session
   ↓
7. 获取 openid 和 session_key
   ↓
8. 后端查找或创建用户
   ↓
9. 生成 JWT Token
   ↓
10. 返回 {access_token, user} 给前端
    ↓
11. 前端保存 token 到本地存储
    ↓
12. 登录成功，跳转到首页
```

## ⚠️ 注意事项

### 1. 环境变量配置

确保在云托管控制台配置了以下环境变量：

```env
WX_APPID=wx8486e57500ac0a55
WX_SECRET=bd4c652097608bb064350cc7e3b5801c
```

或者使用：

```env
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c
```

**两种配置都支持！**

### 2. 微信小程序配置

确保小程序的 AppID 与环境变量中的 `WX_APPID` 一致。

### 3. 服务器域名配置

在微信小程序后台配置服务器域名：
```
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

## 🔧 常见问题

### Q1: 为什么要支持两种命名方式？
**A**: 前端小程序框架通常使用驼峰式命名（`nickName`），而后端开发规范建议使用全小写（`nickname`）。为了兼容性和灵活性，后端同时支持两种方式。

### Q2: 优先使用哪个字段？
**A**: 代码中优先使用驼峰式字段：
```typescript
const userNickname = nickName || nickname;  // 优先 nickName
```

### Q3: 还是返回 400 怎么办？
**A**: 
1. 确认已重新部署云托管
2. 检查前端发送的字段名是否正确
3. 查看云托管日志排查错误

### Q4: 登录后还是返回 401？
**A**: 可能的原因：
- 微信 code 已过期（有效期 5 分钟）
- AppID 或 Secret 配置错误
- 微信服务器网络问题

## 📚 相关文档

- `微信登录接口修复说明.md` - 之前的 404 错误修复
- `接口问题汇总及修复报告.md` - 所有问题汇总

## 🎯 已修复的所有登录问题

| 问题 | 状态 | 修复内容 |
|------|------|----------|
| 404: 路由不存在 | ✅ 已修复 | 添加 `wx-login` 路由别名 |
| 400: 字段名不匹配 | ✅ 已修复 | 支持 `nickName` 和 `nickname` |
| 环境变量不匹配 | ✅ 已修复 | 支持 `WX_APPID` 和 `WECHAT_APPID` |

---

**修复已完成，请重新部署云托管服务后测试！** 🚀

