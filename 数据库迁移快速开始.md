# 数据库迁移到云托管 - 快速开始

## 📦 云托管数据库信息

- **外网地址**：`sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com:23831`
- **内网地址**：`10.32.104.73:3306`
- **数据库名**：`cooktip`

---

## 🚀 快速执行（3步完成）

### 第1步：配置数据库账号密码

**编辑两个文件，填写相同的账号密码**：

#### 文件1：`init-cloudbase-db.js`（初始化脚本）

```javascript
const DB_CONFIG = {
  host: 'sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com',
  port: 23831,
  user: '您的账号',      // ⚠️ 这里
  password: '您的密码',   // ⚠️ 这里
  database: 'cooktip',
  charset: 'utf8mb4',
  multipleStatements: true
};
```

#### 文件2：`migrate-to-cloudbase.js`（迁移脚本）

```javascript
const TARGET_DB = {
  host: 'sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com',
  port: 23831,
  user: '您的账号',      // ⚠️ 这里
  password: '您的密码',   // ⚠️ 这里
  database: 'cooktip',
  charset: 'utf8mb4'
};
```

---

### 第2步：初始化数据库表结构

```bash
node init-cloudbase-db.js
```

**预期输出**：
```
🚀 开始初始化微信云托管数据库...
🔗 连接云托管数据库...
✅ 数据库连接成功！
📦 第一步：读取初始化SQL脚本...
✅ SQL脚本读取成功
🔨 第二步：创建数据库表结构...
✅ 表结构创建成功！
🔍 第三步：验证表结构...
已创建的表：
  1. categories
  2. comments
  3. favorites
  4. likes
  5. recipes
  6. shopping_list
  7. users
✅ 数据库初始化完成！
```

---

### 第3步：迁移数据

```bash
node migrate-to-cloudbase.js
```

**功能**：
- ✅ 从 SQLPub 导出所有数据
- ✅ 导入到云托管数据库
- ✅ 自动验证数据完整性
- ✅ 自动更新图片URL到对象存储

**预期输出**：
```
📦 第一步：导出数据
📤 导出表: users
   找到 10 条记录
📤 导出表: categories
   找到 10 条记录
📤 导出表: recipes
   找到 198 条记录
...

📥 第二步：导入数据
📥 导入表: users
   ✅ 已导入 10/10
   ✅ users 导入完成
...

🔍 第三步：验证迁移结果
✅ users               源: 10   目标: 10
✅ categories          源: 10   目标: 10
✅ recipes             源: 198  目标: 198
...

✅ 数据库迁移完成！
```

---

## ✅ 完成！接下来做什么？

### 1. 更新后端环境配置

编辑 `.env` 文件：

```env
# 数据库配置（微信云托管）
DB_TYPE=mysql

# 生产环境使用内网地址（推荐）
DB_HOST=10.32.104.73
DB_PORT=3306

# 本地开发使用外网地址（需配置IP白名单）
# DB_HOST=sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com
# DB_PORT=23831

DB_USERNAME=您的数据库账号
DB_PASSWORD=您的数据库密码
DB_DATABASE=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false
```

### 2. 重启后端服务

**本地开发**：
```bash
npm run start:dev
```

**生产环境（云托管）**：
```bash
# 提交代码
git add .
git commit -m "chore: 迁移到云托管数据库"
git push origin main

# 等待自动部署
```

### 3. 测试 API

```bash
# 测试分类接口
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories

# 测试食谱接口
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/recipes?limit=5
```

---

## 🎁 迁移优势

| 优势 | 说明 |
|------|------|
| 🚀 **性能** | 内网访问延迟 < 1ms（vs 外网 50-100ms）|
| ✅ **稳定** | 避免锁超时，不再有连接问题 |
| 💰 **成本** | 节省约 ¥10/月 |
| 🔐 **安全** | VPC内网访问更安全 |
| 📊 **管理** | 统一在云托管控制台管理 |

---

## 🆘 常见问题

### Q1: 连接数据库失败

**错误**：`ENOTFOUND` 或 `ETIMEDOUT`

**解决**：
1. 检查数据库地址是否正确
2. 检查网络连接
3. 本地开发需要配置IP白名单

**配置IP白名单**：
1. 登录微信云托管控制台
2. 云数据库 → 安全设置 → IP白名单
3. 添加您的公网IP

### Q2: 权限不足

**错误**：`ER_ACCESS_DENIED_ERROR`

**解决**：
1. 检查账号密码是否正确
2. 确保账号有创建表的权限

### Q3: 数据库不存在

**错误**：`ER_BAD_DB_ERROR`

**解决**：
1. 登录云数据库控制台
2. 创建数据库 `cooktip`
3. 重新运行初始化脚本

---

## 📊 数据库状态检查

迁移完成后，可以登录云数据库控制台查看：

1. **表数量**：7个表
2. **数据量**：
   - users: ~10 条
   - categories: 10 条
   - recipes: 198 条
   - comments: ~50 条
   - favorites: ~30 条
   - likes: ~100 条
   - shopping_list: ~20 条

---

## 🔄 回滚方案

如果需要回滚到 SQLPub：

```env
# .env 文件
DB_HOST=mysql3.sqlpub.com
DB_PORT=3308
DB_USERNAME=david_x
DB_DATABASE=onefoodlibrary
```

---

**准备好了吗？开始迁移吧！** 🚀

1. 配置账号密码
2. 运行 `node init-cloudbase-db.js`
3. 运行 `node migrate-to-cloudbase.js`
4. 更新 .env 配置
5. 重启服务

**预计时间**：15-20分钟  
**风险等级**：低（有回滚方案）

