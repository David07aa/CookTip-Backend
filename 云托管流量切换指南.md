# 🚦 云托管流量切换指南

## ✅ 问题确认

**后端服务状态**：🟢 正常运行  
**日志显示**：✅ Nest application successfully started  
**问题现象**：❌ 域名无法访问 (ERR_CONNECTION_CLOSED)

**诊断结论**：服务已启动，但流量未切换到新版本！

---

## 🎯 解决方案：切换流量到新版本

### 步骤 1：打开版本管理

1. 登录云托管控制台：https://console.cloud.tencent.com/tcb
2. 点击 **云托管** → **服务管理**
3. 选择您的服务
4. 点击 **版本管理** 标签

---

### 步骤 2：查看版本列表

您会看到类似这样的列表：

| 版本名称 | 状态 | 创建时间 | 流量比例 |
|---------|------|----------|----------|
| v1.0.3 | 运行中 🟢 | 2025-10-09 20:30 | 0% |
| v1.0.2 | 运行中 🟢 | 2025-10-09 18:00 | 100% ⚠️ |

**问题所在**：新版本 (v1.0.3) 流量是 0%，旧版本 (v1.0.2) 还占 100%！

---

### 步骤 3：调整流量到新版本

#### 方法 A：直接切换（推荐）

1. 找到最新版本（创建时间最新的）
2. 点击该版本的 **调整流量** 按钮
3. 将流量设置为 **100%**
4. 点击 **确定**

#### 方法 B：灰度发布（稳妥）

1. 先将新版本流量调整为 **50%**
2. 测试 5 分钟，观察是否有错误
3. 确认无误后，调整为 **100%**

---

### 步骤 4：等待生效

⏱️ 等待 **1-3 分钟**，流量会自动切换

---

### 步骤 5：验证

在浏览器访问：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
```

**期望结果**：返回分类数据的 JSON

```json
{
  "code": 200,
  "data": [...]
}
```

---

## 🔍 其他可能的问题

### 问题 A：没有版本管理标签

如果看不到 **版本管理** 标签：

1. 检查是否在 **服务详情** 页面
2. 或者查看 **部署记录**
3. 找到最新的部署，点击 **上线** 或 **启用**

---

### 问题 B：端口配置

如果流量已经是 100% 但还是无法访问：

1. 点击 **服务配置** 标签
2. 查看 **端口映射**：
   - 容器端口：`3000` ✅
   - 协议：`HTTP` 或 `HTTP/HTTPS`
   - 服务端口：`80` (HTTP) 或 `443` (HTTPS)

如果不对，修改为：
```
容器端口: 3000
服务端口: 80
协议: HTTP
```

保存并重启服务。

---

### 问题 C：健康检查失败

检查 **健康检查配置**：

1. 服务配置 → 健康检查
2. 配置：
   ```
   路径: /
   端口: 3000
   协议: HTTP
   ```

---

## 📋 快速检查清单

请逐项检查：

- [ ] 新版本的流量比例是 100%
- [ ] 容器端口是 3000
- [ ] 服务端口是 80 或 443
- [ ] 健康检查通过（绿色）
- [ ] 等待了 2-3 分钟让配置生效

---

## 🆘 如果还是不行

### 终极方案 1：重启服务

1. 服务管理 → 点击 **停止**
2. 等待完全停止（约 30 秒）
3. 点击 **启动**
4. 等待启动完成（3-5 分钟）

---

### 终极方案 2：重新部署

1. 版本管理 → 点击 **新建版本**
2. 选择 GitHub 仓库和分支
3. 部署
4. 等待部署完成
5. 将流量切换到新版本

---

## 📊 流量切换示意图

```
切换前：
旧版本 (v1.0.2) ████████████████████ 100% ← 流量在这里
新版本 (v1.0.3) ░░░░░░░░░░░░░░░░░░░░ 0%

切换后：
旧版本 (v1.0.2) ░░░░░░░░░░░░░░░░░░░░ 0%
新版本 (v1.0.3) ████████████████████ 100% ← 流量切换到这里
```

---

## ✅ 成功标志

流量切换成功后：

1. ✅ API 接口可以访问
2. ✅ 小程序可以加载数据
3. ✅ 图片可以正常显示
4. ✅ 没有 ERR_CONNECTION_CLOSED 错误

---

**立即去检查流量配置！** 🚀

