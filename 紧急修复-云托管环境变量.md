# 🚨 紧急修复：配置云托管环境变量

## ❌ 问题现象
```
ERR_CONNECTION_CLOSED
GET https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
```

**原因**：数据库已迁移到云托管，但环境变量还是旧的 SQLPub 配置！

---

## ✅ 快速修复（5分钟）

### 步骤 1: 登录云托管控制台

1. 打开：https://console.cloud.tencent.com/tcb
2. 点击左侧菜单 **云托管**
3. 选择 **服务管理**
4. 找到您的服务（cooktip-backend）

---

### 步骤 2: 配置环境变量

点击 **环境配置** 标签，添加/修改以下环境变量：

#### 🔴 必须立即修改的数据库配置

```bash
# 使用云托管内网地址（超快！）
DB_HOST=10.32.104.73
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=050710Xzl
DB_DATABASE=cooktip
```

#### ✅ 完整环境变量列表（复制全部）

```bash
NODE_ENV=production
PORT=3000
API_PREFIX=api/v1

# 数据库配置（云托管内网地址）
DB_TYPE=mysql
DB_HOST=10.32.104.73
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=050710Xzl
DB_DATABASE=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false

# JWT 配置
JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d

# 微信小程序配置
WX_APPID=wx8486e57500ac0a55
WECHAT_APPID=wx8486e57500ac0a55
WX_SECRET=bd4c652097608bb064350cc7e3b5801c
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c

# 对象存储配置
CDN_BASE_URL=https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com

# 文件上传配置
UPLOAD_DESTINATION=/app/uploads
MAX_FILE_SIZE=10485760

# 限流配置
THROTTLE_TTL=60
THROTTLE_LIMIT=10
```

---

### 步骤 3: 保存并重启服务

1. 点击 **保存** 按钮
2. 找到 **部署** 按钮，点击 **新建部署**
3. 选择最新的版本（刚才推送的）
4. 点击 **部署**

⏱️ **等待 3-5 分钟**部署完成

---

### 步骤 4: 验证服务

部署完成后，在浏览器访问：

```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
```

**期望结果**：返回 15 个分类数据的 JSON

```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "name": "中餐",
      "icon": "...",
      ...
    }
  ]
}
```

---

## 🔍 如何在控制台检查日志

如果还是有问题，查看日志：

1. 云托管控制台 → **日志管理**
2. 查看最近的错误日志
3. 常见错误提示：
   - `ECONNREFUSED` → 数据库地址配置错误
   - `Access denied` → 数据库密码错误
   - `Unknown database` → 数据库名错误

---

## 📋 配置检查清单

- [ ] DB_HOST = `10.32.104.73` （内网地址，不是外网！）
- [ ] DB_PORT = `3306` （不是 23831）
- [ ] DB_USERNAME = `root`
- [ ] DB_PASSWORD = `050710Xzl`
- [ ] DB_DATABASE = `cooktip`
- [ ] 点击了保存按钮
- [ ] 重新部署了服务
- [ ] 等待 3-5 分钟部署完成

---

## 🎯 配置要点

### ⚠️ 重要：内网地址 vs 外网地址

| 环境 | 地址 | 端口 | 速度 |
|------|------|------|------|
| **云托管（生产）** | `10.32.104.73` | `3306` | ⚡ <1ms |
| 本地开发 | `sh-cynosdbmysql-grp-qksrb4s2.sql.tencentcdb.com` | `23831` | 🐢 50-100ms |

**云托管必须使用内网地址！**

---

## ✅ 修复完成后

1. 刷新小程序
2. 应该能看到首页数据
3. 图片也应该正常加载

---

## 🆘 如果还是不行

1. **检查云托管服务状态**
   - 控制台 → 云托管 → 服务管理
   - 确认服务状态为 "运行中"

2. **查看实时日志**
   - 点击 "日志管理"
   - 查看是否有数据库连接错误

3. **重启服务**
   - 点击 "停止" → 等待 → 点击 "启动"

---

**配置好后立即刷新小程序测试！** 🚀

