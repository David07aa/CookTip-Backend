# 🚀 CookTip Backend 部署规则

## 📋 部署流程规则

**重要规则**: 所有代码更改后，必须按以下顺序执行：

1. **提交到 GitHub**
2. **部署到 Vercel**

这样确保代码仓库和生产环境始终保持同步。

---

## 🛠️ 部署方式

### 方式一：使用一键部署脚本（推荐）

```powershell
.\deploy.ps1 "你的提交信息"
```

**示例**:
```powershell
.\deploy.ps1 "修复搜索接口参数问题"
.\deploy.ps1 "添加新的分类功能"
.\deploy.ps1 "优化数据库查询性能"
```

**脚本会自动执行**:
- ✅ `git add -A` - 添加所有更改
- ✅ `git commit -m "..."` - 提交更改
- ✅ `git push origin main` - 推送到 GitHub
- ✅ `vercel --prod` - 部署到 Vercel 生产环境
- ✅ 显示部署结果和测试链接

---

### 方式二：手动执行命令

如果需要更精细的控制，可以手动执行：

```powershell
# 1. 添加更改
git add -A

# 2. 提交
git commit -m "你的提交信息"

# 3. 推送到 GitHub
git push origin main

# 4. 部署到 Vercel
vercel --prod --token G6jj9jmjazCTlSAsQ7BYhbEf --yes
```

---

## ⚠️ 注意事项

### 1. 部署前检查

- [ ] 代码无语法错误
- [ ] 本地测试通过（如有条件）
- [ ] 环境变量已在 Vercel 配置
- [ ] 数据库连接正常

### 2. 提交信息规范

使用清晰的提交信息，推荐格式：

```
修复[模块名]: 具体问题描述
添加[功能名]: 功能说明
优化[模块名]: 优化内容
更新[文档名]: 更新内容
```

**好的示例**:
- ✅ `修复搜索接口: SQL参数索引错误`
- ✅ `添加收藏功能: 支持用户收藏食谱`
- ✅ `优化食谱列表: 添加分页缓存`
- ✅ `更新API文档: 添加新接口说明`

**不好的示例**:
- ❌ `修复bug`
- ❌ `更新`
- ❌ `test`

### 3. 部署后验证

每次部署后，至少测试以下接口：

1. **健康检查**
   ```
   https://cooktip-backend.vercel.app/api/categories
   ```

2. **核心功能**（根据修改的模块选择）
   - 食谱列表: `/api/recipes?page=1&limit=5`
   - 搜索功能: `/api/search?keyword=鸡&page=1&pageSize=5`
   - 用户相关: `/api/auth/login`

3. **查看 Vercel 日志**
   - 访问: https://vercel.com/davids-projects-688aeefc/cooktip-backend
   - 检查是否有错误日志

---

## 🔄 回滚流程

如果部署后发现问题，可以快速回滚：

### 1. GitHub 回滚

```powershell
# 查看最近的提交
git log --oneline -5

# 回滚到指定提交
git reset --hard <commit-hash>

# 强制推送
git push -f origin main
```

### 2. Vercel 回滚

```powershell
# 方法1: 通过 CLI
vercel rollback --token G6jj9jmjazCTlSAsQ7BYhbEf

# 方法2: 通过 Dashboard
# 访问 Vercel Dashboard → Deployments → 选择之前的部署 → Promote to Production
```

---

## 📊 部署历史追踪

### 查看部署状态

```powershell
# 查看最近的部署
vercel ls --token G6jj9jmjazCTlSAsQ7BYhbEf

# 查看特定部署的日志
vercel logs <deployment-url> --token G6jj9jmjazCTlSAsQ7BYhbEf
```

### Git 提交历史

```powershell
# 查看提交历史
git log --oneline --graph -10

# 查看文件修改历史
git log --oneline -- <file-path>
```

---

## 🎯 快速测试命令

部署后快速测试所有核心接口：

```powershell
# PowerShell 测试脚本
.\test-api.ps1
```

或手动测试：

```powershell
# 测试食谱列表
Invoke-RestMethod "https://cooktip-backend.vercel.app/api/recipes?page=1&limit=5"

# 测试搜索
Invoke-RestMethod "https://cooktip-backend.vercel.app/api/search?keyword=鸡&page=1&pageSize=5"

# 测试分类
Invoke-RestMethod "https://cooktip-backend.vercel.app/api/categories"
```

---

## 📝 部署检查清单

每次部署前后使用此检查清单：

### 部署前
- [ ] 代码已在本地测试
- [ ] 提交信息清晰明确
- [ ] 无未解决的 Git 冲突
- [ ] 数据库 schema 变更已同步

### 部署中
- [ ] GitHub 推送成功
- [ ] Vercel 构建成功
- [ ] 无构建错误或警告

### 部署后
- [ ] 至少测试 2-3 个核心接口
- [ ] 检查 Vercel 日志无错误
- [ ] 响应时间正常（< 3秒）
- [ ] 数据格式正确

---

## 🔗 相关链接

- **生产环境**: https://cooktip-backend.vercel.app
- **Vercel Dashboard**: https://vercel.com/davids-projects-688aeefc/cooktip-backend
- **GitHub 仓库**: https://github.com/David07aa/CookTip-Backend
- **API 文档**: 查看项目中的 `API接口文档.md`
- **前端对接**: 查看项目中的 `前端对接文档.md`

---

## 🆘 故障处理

### 常见问题

**1. Vercel 部署失败**
- 检查 `vercel.json` 配置
- 查看构建日志定位错误
- 确认依赖包版本兼容

**2. GitHub 推送失败**
- 检查网络连接
- 拉取最新代码: `git pull --rebase`
- 解决冲突后重新推送

**3. API 返回 500 错误**
- 查看 Vercel Function 日志
- 检查数据库连接
- 验证 SQL 查询语法

**4. 环境变量问题**
- 在 Vercel Dashboard 中检查环境变量
- 确保所有环境（Production/Preview/Development）都已设置
- 重新部署使环境变量生效

---

**规则制定日期**: 2025-10-02  
**最后更新**: 2025-10-02  
**适用项目**: CookTip Backend

