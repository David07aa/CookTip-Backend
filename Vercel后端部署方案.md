# ğŸš€ ä¸€å®¶é£Ÿè°± - Vercel Serverless åç«¯éƒ¨ç½²æ–¹æ¡ˆ

> ä½¿ç”¨ Vercel Serverless Functions + å¤–éƒ¨æ•°æ®åº“çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“… æ–‡æ¡£ç‰ˆæœ¬
- **åˆ›å»ºæ—¥æœŸ**ï¼š2025å¹´9æœˆ30æ—¥
- **éƒ¨ç½²å¹³å°**ï¼šVercel
- **æ•°æ®åº“**ï¼šå¤–éƒ¨æ•°æ®åº“ï¼ˆSQLPub / Supabase / PlanetScaleï¼‰
- **é€‚ç”¨é¡¹ç›®**ï¼šä¸€å®¶é£Ÿè°±å¾®ä¿¡å°ç¨‹åº

---

## ğŸ¯ æ–¹æ¡ˆæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å¾®ä¿¡å°ç¨‹åºï¼ˆå‰ç«¯ï¼‰              â”‚
â”‚      AppID: wx8486e57500ac0a55      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTPS API
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Vercelï¼ˆServerless åç«¯ï¼‰      â”‚
â”‚  â”œâ”€ API Routes (Serverless Functions)â”‚
â”‚  â”œâ”€ è‡ªåŠ¨HTTPS                        â”‚
â”‚  â”œâ”€ å…¨çƒCDNåŠ é€Ÿ                      â”‚
â”‚  â””â”€ è‡ªåŠ¨æ‰©å®¹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å¤–éƒ¨æ•°æ®åº“æœåŠ¡                  â”‚
â”‚  â”œâ”€ SQLPub / Supabase / PlanetScale â”‚
â”‚  â”œâ”€ PostgreSQL / MySQL               â”‚
â”‚  â””â”€ è‡ªåŠ¨å¤‡ä»½                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      äº‘å­˜å‚¨æœåŠ¡ï¼ˆå›¾ç‰‡ï¼‰              â”‚
â”‚  â”œâ”€ Cloudinaryï¼ˆæ¨èï¼‰               â”‚
â”‚  â””â”€ æˆ– Vercel Blob Storage          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ Vercel æ–¹æ¡ˆä¼˜åŠ¿

### ä¸ºä»€ä¹ˆé€‰æ‹© Vercelï¼Ÿ

1. âœ… **é›¶æœåŠ¡å™¨è¿ç»´** - å®Œå…¨ Serverlessï¼Œæ— éœ€ç®¡ç†æœåŠ¡å™¨
2. âœ… **å…è´¹é¢åº¦å……è¶³** - ä¸ªäººé¡¹ç›®å®Œå…¨å¤Ÿç”¨
3. âœ… **è‡ªåŠ¨HTTPS** - è‡ªåŠ¨é…ç½®SSLè¯ä¹¦
4. âœ… **å…¨çƒCDN** - è‡ªåŠ¨è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²ï¼Œè®¿é—®é€Ÿåº¦å¿«
5. âœ… **Gité›†æˆ** - æ¨é€ä»£ç è‡ªåŠ¨éƒ¨ç½²
6. âœ… **ç¯å¢ƒå˜é‡** - å®‰å…¨ç®¡ç†æ•æ„Ÿä¿¡æ¯
7. âœ… **é›¶é…ç½®éƒ¨ç½²** - å‡ åˆ†é’Ÿå®Œæˆéƒ¨ç½²

### è´¹ç”¨å¯¹æ¯”

| é¡¹ç›® | Vercelå…è´¹ç‰ˆ | ä¼ ç»Ÿäº‘æœåŠ¡å™¨ |
|-----|------------|------------|
| **æœåŠ¡å™¨** | ï¿¥0 | ï¿¥60-200/æœˆ |
| **å¸¦å®½** | 100GB/æœˆå…è´¹ | æŒ‰æµé‡è®¡è´¹ |
| **å‡½æ•°è°ƒç”¨** | 100ä¸‡æ¬¡/æœˆ | æ— é™åˆ¶ |
| **éƒ¨ç½²** | æ— é™æ¬¡ | éœ€æ‰‹åŠ¨éƒ¨ç½² |
| **SSLè¯ä¹¦** | å…è´¹è‡ªåŠ¨ | éœ€æ‰‹åŠ¨é…ç½® |
| **æ€»æˆæœ¬** | **ï¿¥0-20/æœˆ** | **ï¿¥150-500/æœˆ** |

---

## ğŸ—„ï¸ æ•°æ®åº“é€‰æ‹©

### æ¨èæ–¹æ¡ˆå¯¹æ¯”

| æ•°æ®åº“æœåŠ¡ | ç±»å‹ | å…è´¹é¢åº¦ | æ¨èåº¦ | ç‰¹ç‚¹ |
|-----------|------|---------|--------|------|
| **Supabase** | PostgreSQL | 500MB + 50K è¡Œ | â­â­â­â­â­ | å¼€æºã€åŠŸèƒ½å¼ºå¤§ã€è‡ªå¸¦åå° |
| **PlanetScale** | MySQL | 5GB | â­â­â­â­â­ | æ— æœåŠ¡å™¨MySQLï¼Œæ€§èƒ½å¥½ |
| **Railway** | PostgreSQL/MySQL | 500å°æ—¶è¿è¡Œæ—¶é—´ | â­â­â­â­ | ç®€å•æ˜“ç”¨ |
| **Neon** | PostgreSQL | 0.5GB | â­â­â­â­ | Serverless PostgreSQL |
| **SQLPub** | PostgreSQL/MySQL | æ ¹æ®å¥—é¤ | â­â­â­ | å›½å†…æœåŠ¡ï¼Œé€Ÿåº¦å¿« |

### ğŸ† æ¨èï¼šSupabaseï¼ˆæœ€ä½³é€‰æ‹©ï¼‰

**ä¸ºä»€ä¹ˆæ¨è Supabaseï¼Ÿ**

1. âœ… **å…è´¹é¢åº¦å……è¶³** - 500MBæ•°æ®åº“ + 1GBæ–‡ä»¶å­˜å‚¨
2. âœ… **åŠŸèƒ½å®Œæ•´** - æ•°æ®åº“ + å­˜å‚¨ + è®¤è¯ + å®æ—¶è®¢é˜…
3. âœ… **è‡ªå¸¦åå°** - å¯è§†åŒ–ç®¡ç†ç•Œé¢
4. âœ… **RESTful API** - è‡ªåŠ¨ç”ŸæˆAPI
5. âœ… **è¡Œçº§å®‰å…¨** - å†…ç½®æƒé™ç³»ç»Ÿ
6. âœ… **å¼€æº** - å¯è‡ªå·±éƒ¨ç½²

**å®˜ç½‘**ï¼šhttps://supabase.com/

---

## ğŸ—ï¸ Vercel é¡¹ç›®ç»“æ„

```
cooktip-api/
â”œâ”€â”€ api/                     # Vercel Serverless Functions
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ login.js         # å¾®ä¿¡ç™»å½•
â”‚   â”œâ”€â”€ recipes/
â”‚   â”‚   â”œâ”€â”€ index.js         # è·å–é£Ÿè°±åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ [id].js          # é£Ÿè°±è¯¦æƒ…
â”‚   â”‚   â””â”€â”€ create.js        # åˆ›å»ºé£Ÿè°±
â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â””â”€â”€ [id].js          # ç”¨æˆ·ä¿¡æ¯
â”‚   â”œâ”€â”€ comments/
â”‚   â”‚   â””â”€â”€ index.js         # è¯„è®º
â”‚   â”œâ”€â”€ favorites/
â”‚   â”‚   â””â”€â”€ index.js         # æ”¶è—
â”‚   â””â”€â”€ upload/
â”‚       â””â”€â”€ image.js         # å›¾ç‰‡ä¸Šä¼ 
â”‚
â”œâ”€â”€ lib/                     # å·¥å…·åº“
â”‚   â”œâ”€â”€ db.js                # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ auth.js              # è®¤è¯å·¥å…·
â”‚   â”œâ”€â”€ storage.js           # å­˜å‚¨å·¥å…·
â”‚   â””â”€â”€ wechat.js            # å¾®ä¿¡API
â”‚
â”œâ”€â”€ middleware/              # ä¸­é—´ä»¶
â”‚   â””â”€â”€ auth.js              # è®¤è¯ä¸­é—´ä»¶
â”‚
â”œâ”€â”€ .env.local               # æœ¬åœ°ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.production          # ç”Ÿäº§ç¯å¢ƒå˜é‡
â”œâ”€â”€ package.json
â”œâ”€â”€ vercel.json              # Vercelé…ç½®
â””â”€â”€ README.md
```

---

## ğŸ“ å®Œæ•´å®æ–½æ­¥éª¤

### ç¬¬1æ­¥ï¼šåˆ›å»º Vercel é¡¹ç›®

```bash
# 1. åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir cooktip-api
cd cooktip-api

# 2. åˆå§‹åŒ–é¡¹ç›®
npm init -y

# 3. å®‰è£…ä¾èµ–
npm install @supabase/supabase-js
npm install jsonwebtoken
npm install axios
npm install cors

# 4. å®‰è£… Vercel CLI
npm install -g vercel

# 5. ç™»å½• Vercel
vercel login
```

### ç¬¬2æ­¥ï¼šé…ç½® Supabase æ•°æ®åº“

#### 2.1 æ³¨å†Œå¹¶åˆ›å»ºé¡¹ç›®
1. è®¿é—® https://supabase.com/
2. åˆ›å»ºè´¦å·å¹¶æ–°å»ºé¡¹ç›®
3. è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
   - Project URL: `https://xxxxx.supabase.co`
   - API Key (anon, public): `eyJhbGc...`
   - API Key (service_role, secret): `eyJhbGc...`

#### 2.2 åˆ›å»ºæ•°æ®è¡¨

åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­è¿è¡Œï¼š

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  openid VARCHAR(100) UNIQUE NOT NULL,
  nick_name VARCHAR(100),
  avatar TEXT,
  bio TEXT,
  is_vip BOOLEAN DEFAULT false,
  followers INTEGER DEFAULT 0,
  following INTEGER DEFAULT 0,
  total_likes INTEGER DEFAULT 0,
  recipe_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- é£Ÿè°±è¡¨
CREATE TABLE recipes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(100) NOT NULL,
  cover_image TEXT NOT NULL,
  introduction TEXT NOT NULL,
  author_id UUID REFERENCES users(id),
  cook_time INTEGER NOT NULL,
  difficulty VARCHAR(20) NOT NULL,
  servings INTEGER NOT NULL,
  taste VARCHAR(50),
  category VARCHAR(50) NOT NULL,
  tags TEXT[],
  ingredients JSONB NOT NULL,
  steps JSONB NOT NULL,
  tips TEXT,
  nutrition JSONB,
  views INTEGER DEFAULT 0,
  likes INTEGER DEFAULT 0,
  collects INTEGER DEFAULT 0,
  comments INTEGER DEFAULT 0,
  shares INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'published',
  is_recommended BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- è¯„è®ºè¡¨
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  recipe_id UUID REFERENCES recipes(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id),
  content TEXT NOT NULL,
  images TEXT[],
  likes INTEGER DEFAULT 0,
  reply_to UUID REFERENCES comments(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- æ”¶è—è¡¨
CREATE TABLE favorites (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  recipe_id UUID REFERENCES recipes(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, recipe_id)
);

-- ç‚¹èµè¡¨
CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  recipe_id UUID REFERENCES recipes(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, recipe_id)
);

-- è´­ç‰©æ¸…å•è¡¨
CREATE TABLE shopping_lists (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  items JSONB NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- å…³æ³¨è¡¨
CREATE TABLE follows (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  follower_id UUID REFERENCES users(id),
  following_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(follower_id, following_id)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_recipes_category ON recipes(category);
CREATE INDEX idx_recipes_author ON recipes(author_id);
CREATE INDEX idx_recipes_created ON recipes(created_at DESC);
CREATE INDEX idx_comments_recipe ON comments(recipe_id);
CREATE INDEX idx_favorites_user ON favorites(user_id);
CREATE INDEX idx_favorites_recipe ON favorites(recipe_id);
```

### ç¬¬3æ­¥ï¼šåˆ›å»º Vercel API

#### `vercel.json`ï¼ˆVercel é…ç½®ï¼‰
```json
{
  "version": 2,
  "builds": [
    {
      "src": "api/**/*.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api/$1"
    }
  ],
  "env": {
    "SUPABASE_URL": "@supabase-url",
    "SUPABASE_KEY": "@supabase-key",
    "WECHAT_APPID": "@wechat-appid",
    "WECHAT_SECRET": "@wechat-secret",
    "JWT_SECRET": "@jwt-secret"
  }
}
```

#### `lib/db.js`ï¼ˆæ•°æ®åº“è¿æ¥ï¼‰
```javascript
const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_KEY
);

module.exports = supabase;
```

#### `lib/auth.js`ï¼ˆè®¤è¯å·¥å…·ï¼‰
```javascript
const jwt = require('jsonwebtoken');

// ç”ŸæˆJWT Token
function generateToken(userId) {
  return jwt.sign(
    { id: userId },
    process.env.JWT_SECRET,
    { expiresIn: '7d' }
  );
}

// éªŒè¯JWT Token
function verifyToken(token) {
  try {
    return jwt.verify(token, process.env.JWT_SECRET);
  } catch (error) {
    return null;
  }
}

// ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·ID
function getUserFromRequest(req) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (!token) return null;
  
  const decoded = verifyToken(token);
  return decoded ? decoded.id : null;
}

module.exports = {
  generateToken,
  verifyToken,
  getUserFromRequest
};
```

#### `middleware/auth.js`ï¼ˆè®¤è¯ä¸­é—´ä»¶ï¼‰
```javascript
const { getUserFromRequest } = require('../lib/auth');
const supabase = require('../lib/db');

async function requireAuth(req, res) {
  const userId = getUserFromRequest(req);
  
  if (!userId) {
    return res.status(401).json({
      error: 'æœªæˆæƒ',
      message: 'è¯·å…ˆç™»å½•'
    });
  }
  
  // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
  const { data: user, error } = await supabase
    .from('users')
    .select('*')
    .eq('id', userId)
    .single();
  
  if (error || !user) {
    return res.status(401).json({
      error: 'ç”¨æˆ·ä¸å­˜åœ¨'
    });
  }
  
  req.user = user;
  return null; // è®¤è¯æˆåŠŸ
}

module.exports = { requireAuth };
```

#### `api/auth/login.js`ï¼ˆå¾®ä¿¡ç™»å½•ï¼‰
```javascript
const axios = require('axios');
const supabase = require('../../lib/db');
const { generateToken } = require('../../lib/auth');

module.exports = async (req, res) => {
  // è®¾ç½®CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'ä»…æ”¯æŒPOSTè¯·æ±‚' });
  }

  try {
    const { code } = req.body;

    if (!code) {
      return res.status(400).json({ error: 'ç¼ºå°‘codeå‚æ•°' });
    }

    // 1. è°ƒç”¨å¾®ä¿¡APIè·å–openid
    const wxResponse = await axios.get('https://api.weixin.qq.com/sns/jscode2session', {
      params: {
        appid: process.env.WECHAT_APPID,
        secret: process.env.WECHAT_SECRET,
        js_code: code,
        grant_type: 'authorization_code'
      }
    });

    const { openid, session_key, errcode, errmsg } = wxResponse.data;

    if (errcode) {
      return res.status(400).json({
        error: 'å¾®ä¿¡ç™»å½•å¤±è´¥',
        message: errmsg
      });
    }

    // 2. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    let { data: user, error } = await supabase
      .from('users')
      .select('*')
      .eq('openid', openid)
      .single();

    if (error || !user) {
      // åˆ›å»ºæ–°ç”¨æˆ·
      const { data: newUser, error: createError } = await supabase
        .from('users')
        .insert([{
          openid,
          nick_name: 'ç¾é£Ÿçˆ±å¥½è€…',
          avatar: 'https://i.pravatar.cc/300'
        }])
        .select()
        .single();

      if (createError) {
        return res.status(500).json({ error: 'åˆ›å»ºç”¨æˆ·å¤±è´¥' });
      }

      user = newUser;
    }

    // 3. ç”ŸæˆJWT token
    const token = generateToken(user.id);

    res.json({
      token,
      user: {
        id: user.id,
        nickName: user.nick_name,
        avatar: user.avatar,
        isVip: user.is_vip
      }
    });

  } catch (error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    res.status(500).json({
      error: 'æœåŠ¡å™¨é”™è¯¯',
      message: error.message
    });
  }
};
```

#### `api/recipes/index.js`ï¼ˆè·å–é£Ÿè°±åˆ—è¡¨ï¼‰
```javascript
const supabase = require('../../lib/db');

module.exports = async (req, res) => {
  // è®¾ç½®CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  try {
    const {
      page = 1,
      limit = 10,
      category,
      difficulty,
      sort = 'created_at'
    } = req.query;

    let query = supabase
      .from('recipes')
      .select(`
        *,
        author:users(id, nick_name, avatar)
      `)
      .eq('status', 'published');

    // ç­›é€‰æ¡ä»¶
    if (category) {
      query = query.eq('category', category);
    }
    
    if (difficulty) {
      query = query.eq('difficulty', difficulty);
    }

    // æ’åº
    const sortField = sort.startsWith('-') ? sort.slice(1) : sort;
    const sortOrder = sort.startsWith('-') ? 'desc' : 'asc';
    query = query.order(sortField, { ascending: sortOrder === 'asc' });

    // åˆ†é¡µ
    const from = (page - 1) * limit;
    const to = from + parseInt(limit) - 1;
    query = query.range(from, to);

    const { data: recipes, error, count } = await query;

    if (error) {
      return res.status(500).json({ error: 'æŸ¥è¯¢å¤±è´¥', message: error.message });
    }

    res.json({
      recipes,
      total: count,
      page: parseInt(page),
      totalPages: Math.ceil(count / limit)
    });

  } catch (error) {
    console.error('è·å–é£Ÿè°±åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      error: 'æœåŠ¡å™¨é”™è¯¯',
      message: error.message
    });
  }
};
```

#### `api/recipes/[id].js`ï¼ˆé£Ÿè°±è¯¦æƒ…ï¼‰
```javascript
const supabase = require('../../lib/db');

module.exports = async (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  const { id } = req.query;

  try {
    // è·å–é£Ÿè°±è¯¦æƒ…
    const { data: recipe, error } = await supabase
      .from('recipes')
      .select(`
        *,
        author:users(id, nick_name, avatar, followers)
      `)
      .eq('id', id)
      .single();

    if (error || !recipe) {
      return res.status(404).json({ error: 'é£Ÿè°±ä¸å­˜åœ¨' });
    }

    // å¢åŠ æµè§ˆé‡
    await supabase
      .from('recipes')
      .update({ views: recipe.views + 1 })
      .eq('id', id);

    recipe.views += 1;

    res.json(recipe);

  } catch (error) {
    console.error('è·å–é£Ÿè°±è¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      error: 'æœåŠ¡å™¨é”™è¯¯',
      message: error.message
    });
  }
};
```

#### `api/recipes/create.js`ï¼ˆåˆ›å»ºé£Ÿè°±ï¼‰
```javascript
const supabase = require('../../lib/db');
const { requireAuth } = require('../../middleware/auth');

module.exports = async (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'ä»…æ”¯æŒPOSTè¯·æ±‚' });
  }

  // éªŒè¯è®¤è¯
  const authError = await requireAuth(req, res);
  if (authError) return;

  try {
    const recipeData = {
      ...req.body,
      author_id: req.user.id,
      status: 'published'
    };

    const { data: recipe, error } = await supabase
      .from('recipes')
      .insert([recipeData])
      .select()
      .single();

    if (error) {
      return res.status(500).json({ error: 'åˆ›å»ºå¤±è´¥', message: error.message });
    }

    // æ›´æ–°ç”¨æˆ·é£Ÿè°±æ•°
    await supabase
      .from('users')
      .update({ recipe_count: req.user.recipe_count + 1 })
      .eq('id', req.user.id);

    res.status(201).json({
      message: 'é£Ÿè°±åˆ›å»ºæˆåŠŸ',
      recipe
    });

  } catch (error) {
    console.error('åˆ›å»ºé£Ÿè°±é”™è¯¯:', error);
    res.status(500).json({
      error: 'æœåŠ¡å™¨é”™è¯¯',
      message: error.message
    });
  }
};
```

#### `api/favorites/index.js`ï¼ˆæ”¶è—åŠŸèƒ½ï¼‰
```javascript
const supabase = require('../../lib/db');
const { requireAuth } = require('../../middleware/auth');

module.exports = async (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  const authError = await requireAuth(req, res);
  if (authError) return;

  try {
    // GET - è·å–æ”¶è—åˆ—è¡¨
    if (req.method === 'GET') {
      const { data: favorites, error } = await supabase
        .from('favorites')
        .select(`
          *,
          recipe:recipes(*)
        `)
        .eq('user_id', req.user.id)
        .order('created_at', { ascending: false });

      if (error) {
        return res.status(500).json({ error: error.message });
      }

      return res.json(favorites);
    }

    // POST - æ·»åŠ æ”¶è—
    if (req.method === 'POST') {
      const { recipeId } = req.body;

      const { data, error } = await supabase
        .from('favorites')
        .insert([{
          user_id: req.user.id,
          recipe_id: recipeId
        }])
        .select()
        .single();

      if (error) {
        if (error.code === '23505') {
          return res.status(400).json({ error: 'å·²ç»æ”¶è—è¿‡äº†' });
        }
        return res.status(500).json({ error: error.message });
      }

      // æ›´æ–°é£Ÿè°±æ”¶è—æ•°
      await supabase.rpc('increment_collect', { recipe_id: recipeId });

      return res.json({ message: 'æ”¶è—æˆåŠŸ', data });
    }

    // DELETE - å–æ¶ˆæ”¶è—
    if (req.method === 'DELETE') {
      const { recipeId } = req.query;

      const { error } = await supabase
        .from('favorites')
        .delete()
        .eq('user_id', req.user.id)
        .eq('recipe_id', recipeId);

      if (error) {
        return res.status(500).json({ error: error.message });
      }

      // æ›´æ–°é£Ÿè°±æ”¶è—æ•°
      await supabase.rpc('decrement_collect', { recipe_id: recipeId });

      return res.json({ message: 'å–æ¶ˆæ”¶è—æˆåŠŸ' });
    }

  } catch (error) {
    console.error('æ”¶è—æ“ä½œé”™è¯¯:', error);
    res.status(500).json({
      error: 'æœåŠ¡å™¨é”™è¯¯',
      message: error.message
    });
  }
};
```

#### `api/upload/image.js`ï¼ˆå›¾ç‰‡ä¸Šä¼  - ä½¿ç”¨ Cloudinaryï¼‰
```javascript
const formidable = require('formidable');
const cloudinary = require('cloudinary').v2;

// é…ç½® Cloudinary
cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_API_SECRET
});

export const config = {
  api: {
    bodyParser: false, // ç¦ç”¨é»˜è®¤çš„bodyè§£æ
  },
};

module.exports = async (req, res) => {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'ä»…æ”¯æŒPOSTè¯·æ±‚' });
  }

  try {
    const form = new formidable.IncomingForm();
    
    form.parse(req, async (err, fields, files) => {
      if (err) {
        return res.status(500).json({ error: 'æ–‡ä»¶è§£æå¤±è´¥' });
      }

      const file = files.file;
      
      // ä¸Šä¼ åˆ° Cloudinary
      const result = await cloudinary.uploader.upload(file.filepath, {
        folder: 'cooktip',
        transformation: [
          { width: 800, height: 600, crop: 'limit' },
          { quality: 'auto' }
        ]
      });

      res.json({
        url: result.secure_url,
        publicId: result.public_id
      });
    });

  } catch (error) {
    console.error('ä¸Šä¼ é”™è¯¯:', error);
    res.status(500).json({
      error: 'ä¸Šä¼ å¤±è´¥',
      message: error.message
    });
  }
};
```

### ç¬¬4æ­¥ï¼šéƒ¨ç½²åˆ° Vercel

```bash
# 1. åˆå§‹åŒ– Git
git init
git add .
git commit -m "Initial commit"

# 2. æ¨é€åˆ° GitHub
git remote add origin https://github.com/yourusername/cooktip-api.git
git push -u origin main

# 3. éƒ¨ç½²åˆ° Vercel
vercel

# æˆ–è€…é€šè¿‡ Vercel ç½‘ç«™å¯¼å…¥ GitHub ä»“åº“
# https://vercel.com/new
```

### ç¬¬5æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

åœ¨ Vercel Dashboard ä¸­é…ç½®ï¼š

```
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_KEY=eyJhbGc...
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=your_wechat_secret
JWT_SECRET=your_random_secret_key
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

---

## ğŸ“± å°ç¨‹åºç«¯å¯¹æ¥

### ä¿®æ”¹ `app.js`

```javascript
App({
  onLaunch() {
    // è·å–token
    const token = wx.getStorageSync('token');
    if (token) {
      this.globalData.token = token;
    }
  },
  
  globalData: {
    userInfo: null,
    token: null,
    baseURL: 'https://your-project.vercel.app/api' // VercelåŸŸå
  }
});
```

### åˆ›å»º `utils/request.js`ï¼ˆç»Ÿä¸€è¯·æ±‚ï¼‰

```javascript
const app = getApp();

function request(url, options = {}) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${app.globalData.baseURL}${url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': app.globalData.token ? `Bearer ${app.globalData.token}` : ''
      },
      success: (res) => {
        if (res.statusCode === 200 || res.statusCode === 201) {
          resolve(res.data);
        } else if (res.statusCode === 401) {
          // Tokenå¤±æ•ˆï¼Œé‡æ–°ç™»å½•
          wx.removeStorageSync('token');
          app.globalData.token = null;
          
          // è·³è½¬ç™»å½•
          wx.showToast({
            title: 'è¯·é‡æ–°ç™»å½•',
            icon: 'none'
          });
          
          reject(new Error('æœªæˆæƒ'));
        } else {
          reject(new Error(res.data.message || res.data.error || 'è¯·æ±‚å¤±è´¥'));
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
}

module.exports = {
  // ç™»å½•
  login: (code) => request('/auth/login', {
    method: 'POST',
    data: { code }
  }),

  // é£Ÿè°±åˆ—è¡¨
  getRecipes: (params) => request('/recipes', {
    method: 'GET',
    data: params
  }),

  // é£Ÿè°±è¯¦æƒ…
  getRecipeDetail: (id) => request(`/recipes/${id}`),

  // åˆ›å»ºé£Ÿè°±
  createRecipe: (data) => request('/recipes/create', {
    method: 'POST',
    data
  }),

  // æ”¶è—
  getFavorites: () => request('/favorites'),
  
  addFavorite: (recipeId) => request('/favorites', {
    method: 'POST',
    data: { recipeId }
  }),
  
  removeFavorite: (recipeId) => request(`/favorites?recipeId=${recipeId}`, {
    method: 'DELETE'
  }),

  // ç‚¹èµ
  likeRecipe: (recipeId) => request(`/likes`, {
    method: 'POST',
    data: { recipeId }
  }),

  // ä¸Šä¼ å›¾ç‰‡
  uploadImage: (filePath) => {
    return new Promise((resolve, reject) => {
      wx.uploadFile({
        url: `${app.globalData.baseURL}/upload/image`,
        filePath: filePath,
        name: 'file',
        header: {
          'Authorization': app.globalData.token ? `Bearer ${app.globalData.token}` : ''
        },
        success: (res) => {
          const data = JSON.parse(res.data);
          resolve(data);
        },
        fail: reject
      });
    });
  }
};
```

### åœ¨é¡µé¢ä¸­ä½¿ç”¨

```javascript
// pages/index/index.js
const api = require('../../utils/request');

Page({
  data: {
    recipes: []
  },

  async onLoad() {
    await this.loadRecipes();
  },

  async loadRecipes() {
    try {
      wx.showLoading({ title: 'åŠ è½½ä¸­...' });

      const result = await api.getRecipes({
        page: 1,
        limit: 10,
        category: 'ä¸­é¤'
      });

      this.setData({
        recommendRecipes: result.recipes
      });

      wx.hideLoading();
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: error.message || 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

---

## ğŸ”§ å›¾ç‰‡å­˜å‚¨æ–¹æ¡ˆ

### æ¨èï¼šCloudinaryï¼ˆæœ€ç®€å•ï¼‰

#### ä¼˜åŠ¿
- âœ… å…è´¹é¢åº¦ï¼š25GBå­˜å‚¨ + 25GBæµé‡/æœˆ
- âœ… è‡ªåŠ¨å›¾ç‰‡ä¼˜åŒ–å’ŒCDN
- âœ… å®æ—¶å›¾ç‰‡è½¬æ¢
- âœ… ç®€å•æ˜“ç”¨çš„API

#### æ³¨å†Œå’Œé…ç½®
1. è®¿é—® https://cloudinary.com/
2. æ³¨å†Œå…è´¹è´¦å·
3. è·å–é…ç½®ä¿¡æ¯ï¼ˆDashboard ä¸­ï¼‰

```javascript
// ç¯å¢ƒå˜é‡
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=123456789012345
CLOUDINARY_API_SECRET=your_api_secret
```

### å¤‡é€‰ï¼šVercel Blob Storage

```bash
npm install @vercel/blob
```

```javascript
// api/upload/blob.js
import { put } from '@vercel/blob';

export default async function handler(req, res) {
  const { searchParams } = new URL(req.url);
  const filename = searchParams.get('filename');

  const blob = await put(filename, req.body, {
    access: 'public',
  });

  return res.json(blob);
}
```

---

## ğŸš€ éƒ¨ç½²æ¸…å•

### âœ… éƒ¨ç½²å‰æ£€æŸ¥

- [ ] Vercel è´¦å·å·²æ³¨å†Œ
- [ ] Supabase é¡¹ç›®å·²åˆ›å»º
- [ ] æ•°æ®è¡¨å·²åˆ›å»º
- [ ] å¾®ä¿¡å°ç¨‹åº AppSecret å·²è·å–
- [ ] Cloudinary è´¦å·å·²é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] GitHub ä»“åº“å·²åˆ›å»º

### âœ… éƒ¨ç½²æ­¥éª¤

1. [ ] åˆ›å»ºåç«¯é¡¹ç›®ä»£ç 
2. [ ] é…ç½® `vercel.json`
3. [ ] æ¨é€åˆ° GitHub
4. [ ] Vercel å¯¼å…¥é¡¹ç›®
5. [ ] é…ç½®ç¯å¢ƒå˜é‡
6. [ ] éƒ¨ç½²æˆåŠŸ
7. [ ] è·å–APIåŸŸå
8. [ ] å°ç¨‹åºé…ç½®æœåŠ¡å™¨åŸŸå
9. [ ] æµ‹è¯•APIæ¥å£
10. [ ] å°ç¨‹åºå¯¹æ¥API

---

## ğŸ’° æˆæœ¬é¢„ä¼°

### å…è´¹æ–¹æ¡ˆï¼ˆæ¨èå…¥é—¨ï¼‰

| æœåŠ¡ | å¥—é¤ | æœˆæˆæœ¬ |
|-----|------|--------|
| Vercel | Hobbyï¼ˆå…è´¹ï¼‰ | ï¿¥0 |
| Supabase | Free Tier | ï¿¥0 |
| Cloudinary | Free | ï¿¥0 |
| **æ€»è®¡** | | **ï¿¥0/æœˆ** |

**é™åˆ¶**ï¼š
- Vercelï¼š100GBæµé‡/æœˆï¼Œ100ä¸‡æ¬¡å‡½æ•°è°ƒç”¨
- Supabaseï¼š500MBæ•°æ®åº“ï¼Œ1GBå­˜å‚¨
- Cloudinaryï¼š25GBæµé‡/æœˆ

**é€‚ç”¨åœºæ™¯**ï¼š
- æ—¥æ´» < 1000
- æœˆè¯·æ±‚é‡ < 50ä¸‡
- æ•°æ®é‡ < 500MB

### ä»˜è´¹æ–¹æ¡ˆï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

| æœåŠ¡ | å¥—é¤ | æœˆæˆæœ¬ |
|-----|------|--------|
| Vercel | Pro | ï¿¥140 |
| Supabase | Pro | ï¿¥170 |
| Cloudinary | Plus | ï¿¥300 |
| **æ€»è®¡** | | **ï¿¥610/æœˆ** |

**æ‰©å±•èƒ½åŠ›**ï¼š
- æ— é™æµé‡
- 8GBæ•°æ®åº“
- 190GBæ–‡ä»¶å­˜å‚¨
- æ›´å¿«çš„å‡½æ•°æ‰§è¡Œ

---

## ğŸ¯ Vercel ç‰¹åˆ«æ³¨æ„äº‹é¡¹

### é™åˆ¶å’Œè§£å†³æ–¹æ¡ˆ

#### 1. å‡½æ•°æ‰§è¡Œæ—¶é—´é™åˆ¶
**é—®é¢˜**ï¼šå…è´¹ç‰ˆ10ç§’ï¼ŒProç‰ˆ60ç§’

**è§£å†³**ï¼š
- ä¼˜åŒ–æŸ¥è¯¢ï¼Œä½¿ç”¨ç´¢å¼•
- å¤æ‚ä»»åŠ¡ä½¿ç”¨åå°ä»»åŠ¡é˜Ÿåˆ—
- å¤§æ–‡ä»¶ä¸Šä¼ ç›´æ¥ä¸Šä¼ åˆ°äº‘å­˜å‚¨

#### 2. æ— çŠ¶æ€å‡½æ•°
**é—®é¢˜**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯æ–°çš„å‡½æ•°å®ä¾‹

**è§£å†³**ï¼š
- ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“ï¼ˆSupabaseï¼‰
- ä½¿ç”¨ Redisï¼ˆUpstashï¼‰åšç¼“å­˜
- WebSocket ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆPusherï¼‰

#### 3. å†·å¯åŠ¨
**é—®é¢˜**ï¼šå‡½æ•°é•¿æ—¶é—´ä¸ç”¨ä¼šå†·å¯åŠ¨ï¼Œé¦–æ¬¡è¯·æ±‚æ…¢

**è§£å†³**ï¼š
- ä½¿ç”¨å®šæ—¶ä»»åŠ¡ä¿æŒæ´»è·ƒ
- ä¼˜åŒ–ä¾èµ–åŒ…å¤§å°
- ä½¿ç”¨ Edge Functionsï¼ˆæ›´å¿«ï¼‰

---

## ğŸ“š å®Œæ•´éƒ¨ç½²æ•™ç¨‹

### å¿«é€Ÿéƒ¨ç½²ï¼ˆ20åˆ†é’Ÿï¼‰

#### æ­¥éª¤1ï¼šåˆ›å»º Supabase é¡¹ç›®ï¼ˆ5åˆ†é’Ÿï¼‰
```bash
1. è®¿é—® https://supabase.com/
2. ç‚¹å‡» "Start your project"
3. åˆ›å»ºç»„ç»‡å’Œé¡¹ç›®
4. ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–
5. å¤åˆ¶ Project URL å’Œ API Key
```

#### æ­¥éª¤2ï¼šåˆ›å»ºæ•°æ®è¡¨ï¼ˆ3åˆ†é’Ÿï¼‰
```bash
1. è¿›å…¥ Supabase Dashboard
2. ç‚¹å‡» "SQL Editor"
3. ç²˜è´´ä¸Šé¢çš„å»ºè¡¨SQL
4. ç‚¹å‡» "Run" æ‰§è¡Œ
```

#### æ­¥éª¤3ï¼šåˆ›å»º Vercel é¡¹ç›®ï¼ˆ5åˆ†é’Ÿï¼‰
```bash
# æœ¬åœ°æ“ä½œ
mkdir cooktip-api
cd cooktip-api
npm init -y
npm install @supabase/supabase-js jsonwebtoken axios

# åˆ›å»ºå¿…è¦æ–‡ä»¶ï¼ˆä½¿ç”¨ä¸Šé¢çš„ä»£ç ï¼‰
# - vercel.json
# - lib/db.js
# - api/recipes/index.js
# ç­‰...

git init
git add .
git commit -m "Initial commit"
```

#### æ­¥éª¤4ï¼šéƒ¨ç½²åˆ° Vercelï¼ˆ5åˆ†é’Ÿï¼‰
```bash
1. æ¨é€åˆ° GitHub
2. è®¿é—® https://vercel.com/
3. ç‚¹å‡» "Import Project"
4. é€‰æ‹©ä½ çš„ GitHub ä»“åº“
5. é…ç½®ç¯å¢ƒå˜é‡
6. ç‚¹å‡» "Deploy"
```

#### æ­¥éª¤5ï¼šå°ç¨‹åºé…ç½®ï¼ˆ2åˆ†é’Ÿï¼‰
```bash
1. è·å– Vercel åŸŸåï¼ˆå¦‚ï¼šyour-project.vercel.appï¼‰
2. ä¿®æ”¹å°ç¨‹åº app.js ä¸­çš„ baseURL
3. åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æœåŠ¡å™¨åŸŸå
4. é‡æ–°ç¼–è¯‘æµ‹è¯•
```

---

## ğŸ”¥ æ¨èçš„å®Œæ•´æŠ€æœ¯æ ˆ

```
å‰ç«¯ï¼šå¾®ä¿¡å°ç¨‹åºï¼ˆåŸç”Ÿï¼‰
â”œâ”€ AppID: wx8486e57500ac0a55
â””â”€ UIæ¡†æ¶ï¼šWeUIï¼ˆå¯é€‰ï¼‰

åç«¯ï¼šVercel Serverless Functions
â”œâ”€ è¿è¡Œæ—¶ï¼šNode.js 18
â”œâ”€ æ¡†æ¶ï¼šNext.js API Routes / çº¯Node.js
â””â”€ éƒ¨ç½²ï¼šè‡ªåŠ¨CI/CD

æ•°æ®åº“ï¼šSupabaseï¼ˆPostgreSQLï¼‰
â”œâ”€ ORMï¼šSupabase Client
â”œâ”€ è®¤è¯ï¼šJWT
â””â”€ å­˜å‚¨ï¼šSupabase Storageï¼ˆæˆ–Cloudinaryï¼‰

å›¾ç‰‡ï¼šCloudinary
â”œâ”€ CDNï¼šå…¨çƒåŠ é€Ÿ
â”œâ”€ ä¼˜åŒ–ï¼šè‡ªåŠ¨å‹ç¼©ã€æ ¼å¼è½¬æ¢
â””â”€ è½¬æ¢ï¼šå®æ—¶ç¼©æ”¾ã€è£å‰ª

ç¼“å­˜ï¼šUpstash Redisï¼ˆå¯é€‰ï¼‰
â””â”€ ç”¨é€”ï¼šçƒ­ç‚¹æ•°æ®ã€é™æµ
```

---

## ğŸ“‹ å®Œæ•´çš„ package.json

```json
{
  "name": "cooktip-api",
  "version": "1.0.0",
  "description": "ä¸€å®¶é£Ÿè°±å°ç¨‹åº Vercel Serverless API",
  "main": "index.js",
  "scripts": {
    "dev": "vercel dev",
    "deploy": "vercel --prod"
  },
  "keywords": ["recipe", "wechat", "serverless", "vercel"],
  "author": "",
  "license": "MIT",
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0",
    "jsonwebtoken": "^9.0.2",
    "axios": "^1.6.0",
    "cors": "^2.8.5",
    "formidable": "^3.5.1",
    "cloudinary": "^1.41.0"
  },
  "devDependencies": {
    "vercel": "^33.0.0"
  }
}
```

---

## ğŸ¯ ä½¿ç”¨ SQLPub çš„é…ç½®

å¦‚æœæ‚¨ä½¿ç”¨ [SQLPub](https://sqlpub.com/) ä½œä¸ºæ•°æ®åº“ï¼š

### è¿æ¥é…ç½®

```javascript
// lib/db.jsï¼ˆä½¿ç”¨åŸç”Ÿ PostgreSQL å®¢æˆ·ç«¯ï¼‰
const { Pool } = require('pg');

const pool = new Pool({
  host: process.env.DB_HOST,        // SQLPub æä¾›çš„ä¸»æœºåœ°å€
  port: process.env.DB_PORT || 5432,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  ssl: {
    rejectUnauthorized: false
  },
  // Vercel Serverless ä¼˜åŒ–
  max: 1,                   // æ¯ä¸ªå‡½æ•°æœ€å¤š1ä¸ªè¿æ¥
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

// æŸ¥è¯¢å°è£…
async function query(text, params) {
  const client = await pool.connect();
  try {
    const result = await client.query(text, params);
    return result;
  } finally {
    client.release();
  }
}

module.exports = { query, pool };
```

### ç¯å¢ƒå˜é‡ï¼ˆVercelï¼‰

```env
# SQLPub æ•°æ®åº“é…ç½®
DB_HOST=your-sqlpub-host.com
DB_PORT=5432
DB_NAME=cooktip
DB_USER=your_username
DB_PASSWORD=your_password
```

### API ç¤ºä¾‹ï¼ˆä½¿ç”¨åŸç”ŸSQLï¼‰

```javascript
// api/recipes/index.js
const { query } = require('../../lib/db');

module.exports = async (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  
  try {
    const { page = 1, limit = 10, category } = req.query;
    const offset = (page - 1) * limit;

    let sql = `
      SELECT r.*, 
             json_build_object(
               'id', u.id, 
               'nick_name', u.nick_name, 
               'avatar', u.avatar
             ) as author
      FROM recipes r
      LEFT JOIN users u ON r.author_id = u.id
      WHERE r.status = 'published'
    `;

    const params = [];
    let paramIndex = 1;

    if (category) {
      sql += ` AND r.category = $${paramIndex}`;
      params.push(category);
      paramIndex++;
    }

    sql += ` ORDER BY r.created_at DESC LIMIT $${paramIndex} OFFSET $${paramIndex + 1}`;
    params.push(limit, offset);

    const result = await query(sql, params);

    res.json({
      recipes: result.rows,
      page: parseInt(page),
      limit: parseInt(limit)
    });

  } catch (error) {
    console.error('æŸ¥è¯¢é”™è¯¯:', error);
    res.status(500).json({ error: error.message });
  }
};
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
```sql
-- åˆ›å»ºå¿…è¦çš„ç´¢å¼•
CREATE INDEX idx_recipes_category ON recipes(category);
CREATE INDEX idx_recipes_status ON recipes(status);
CREATE INDEX idx_recipes_created ON recipes(created_at DESC);
CREATE INDEX idx_recipes_author ON recipes(author_id);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_recipes_search ON recipes USING GIN(to_tsvector('chinese', title || ' ' || introduction));
```

### 2. API ç¼“å­˜
```javascript
// ä½¿ç”¨ Vercel Edge Config æˆ– Upstash Redis
const { get, set } = require('@upstash/redis');

// ç¼“å­˜çƒ­é—¨é£Ÿè°±
const cacheKey = `recipes:hot:${category}`;
const cached = await get(cacheKey);

if (cached) {
  return res.json(cached);
}

// æŸ¥è¯¢æ•°æ®åº“...
await set(cacheKey, result, { ex: 300 }); // ç¼“å­˜5åˆ†é’Ÿ
```

### 3. å›¾ç‰‡ä¼˜åŒ–
```javascript
// Cloudinary è‡ªåŠ¨ä¼˜åŒ–
const optimizedUrl = cloudinary.url('sample.jpg', {
  fetch_format: 'auto',
  quality: 'auto',
  width: 800
});
```

---

## ğŸ› å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šVercelå‡½æ•°è¶…æ—¶
**è§£å†³**ï¼š
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- ä½¿ç”¨ç´¢å¼•
- å‡å°‘JOINæ“ä½œ
- å‡çº§åˆ° Pro ç‰ˆæœ¬ï¼ˆ60ç§’ï¼‰

### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥æ± è€—å°½
**è§£å†³**ï¼š
```javascript
// ä½¿ç”¨è¿æ¥æ± ï¼Œæ¯ä¸ªå‡½æ•°æœ€å¤š1ä¸ªè¿æ¥
const pool = new Pool({ max: 1 });
```

### é—®é¢˜3ï¼šCORS è·¨åŸŸé—®é¢˜
**è§£å†³**ï¼š
```javascript
res.setHeader('Access-Control-Allow-Origin', '*');
res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
```

### é—®é¢˜4ï¼šå›¾ç‰‡ä¸Šä¼ å¤±è´¥
**è§£å†³**ï¼š
- æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆVercel: 4.5MBï¼‰
- ä½¿ç”¨å‰ç«¯ç›´ä¼ åˆ°äº‘å­˜å‚¨
- æˆ–ä½¿ç”¨ Vercel Blob

---

## ğŸ“Š å®Œæ•´å¯¹æ¯”ï¼šVercel vs ä¼ ç»ŸæœåŠ¡å™¨

| ç‰¹æ€§ | Vercel Serverless | ä¼ ç»Ÿäº‘æœåŠ¡å™¨ |
|-----|------------------|------------|
| **éƒ¨ç½²æ—¶é—´** | 2åˆ†é’Ÿ | 30-60åˆ†é’Ÿ |
| **æœˆæˆæœ¬** | ï¿¥0-140 | ï¿¥150-500 |
| **è¿ç»´éš¾åº¦** | é›¶è¿ç»´ | éœ€è¦è¿ç»´ |
| **æ‰©å±•æ€§** | è‡ªåŠ¨æ‰©å®¹ | æ‰‹åŠ¨æ‰©å®¹ |
| **HTTPS** | è‡ªåŠ¨é…ç½® | éœ€æ‰‹åŠ¨é…ç½® |
| **å…¨çƒè®¿é—®** | å…¨çƒCDN | å•åœ°åŸŸ |
| **å¯é æ€§** | 99.99% | å–å†³äºé…ç½® |

---

## ğŸ‰ æ€»ç»“

### Vercel + Supabase æ–¹æ¡ˆçš„ä¼˜åŠ¿

1. **ğŸš€ è¶…å¿«éƒ¨ç½²** - 20åˆ†é’Ÿä»é›¶åˆ°ä¸Šçº¿
2. **ğŸ’° æˆæœ¬æä½** - å…è´¹é¢åº¦å……è¶³ï¼Œä¸ªäººé¡¹ç›®å®Œå…¨å¤Ÿç”¨
3. **ğŸ”§ é›¶è¿ç»´** - æ— éœ€ç®¡ç†æœåŠ¡å™¨ï¼Œä¸“æ³¨ä¸šåŠ¡é€»è¾‘
4. **ğŸŒ å…¨çƒåŠ é€Ÿ** - è‡ªåŠ¨CDNï¼Œè®¿é—®é€Ÿåº¦å¿«
5. **ğŸ“ˆ è‡ªåŠ¨æ‰©å®¹** - æ— éœ€æ‹…å¿ƒå¹¶å‘é—®é¢˜
6. **ğŸ”’ å®‰å…¨å¯é ** - è‡ªåŠ¨HTTPSï¼ŒSupabaseè¡Œçº§å®‰å…¨

### é€‚ç”¨åœºæ™¯

âœ… ä¸ªäººé¡¹ç›®
âœ… MVPå¿«é€ŸéªŒè¯
âœ… ä¸­å°è§„æ¨¡åº”ç”¨ï¼ˆæ—¥æ´» < 5000ï¼‰
âœ… é¢„ç®—æœ‰é™çš„é¡¹ç›®
âœ… å‰ç«¯å¼€å‘è€…ç‹¬ç«‹å¼€å‘

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

æˆ‘å¯ä»¥å¸®æ‚¨ï¼š

1. **ç”Ÿæˆå®Œæ•´çš„ Vercel API ä»£ç **
   - æ‰€æœ‰APIæ¥å£
   - è®¤è¯ä¸­é—´ä»¶
   - æ•°æ®åº“æ“ä½œ
   
2. **æä¾›è¯¦ç»†çš„éƒ¨ç½²æ•™ç¨‹**
   - å›¾æ–‡æ­¥éª¤
   - é…ç½®æ¸…å•
   - æµ‹è¯•æ–¹æ³•

3. **åˆ›å»ºå°ç¨‹åºç«¯å¯¹æ¥ä»£ç **
   - APIå·¥å…·ç±»
   - è¯·æ±‚å°è£…
   - é”™è¯¯å¤„ç†

**æ‚¨æƒ³è®©æˆ‘å¸®æ‚¨å®æ–½å“ªä¸€æ­¥ï¼Ÿ** ğŸš€

---

*åŸºäº Vercel Serverless çš„ç°ä»£åŒ–åç«¯æ–¹æ¡ˆï¼Œè®©æ‚¨çš„å°ç¨‹åºåç«¯éƒ¨ç½²å˜å¾—ç®€å•ï¼*
