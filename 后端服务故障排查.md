# 🔍 后端服务故障深度排查

## ❌ 问题现象
```
ERR_CONNECTION_CLOSED
GET https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
```

**已尝试**：✅ 配置环境变量 ✅ 重新部署  
**结果**：❌ 仍然无法连接

**诊断**：后端服务可能启动失败！

---

## 🚨 立即检查（按顺序）

### 检查 1：服务是否在运行？

1. 打开云托管控制台
   ```
   https://console.cloud.tencent.com/tcb
   ```

2. 查看服务状态
   - 路径：**云托管 → 服务管理 → 您的服务**
   - 查看 **运行状态** 列
   
   **期望**：显示 "运行中" 🟢  
   **异常**：显示 "异常" / "启动失败" 🔴

---

### 检查 2：查看实时日志 ⚠️ 关键

1. 点击 **日志管理** 标签
2. 选择 **实时日志**
3. 查看最近 5-10 分钟的日志

#### 常见错误及解决方案：

**错误 A：数据库连接失败**
```
Error: connect ETIMEDOUT 10.32.104.73:3306
Error: ER_ACCESS_DENIED_ERROR
Error: Unknown database 'cooktip'
```

**解决**：
- 检查 `DB_HOST`、`DB_PORT`、`DB_PASSWORD`、`DB_DATABASE` 是否正确
- 确认数据库实例是否在运行

---

**错误 B：端口被占用**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决**：
- 重启服务
- 或更改 `PORT` 环境变量

---

**错误 C：缺少环境变量**
```
TypeError: Cannot read property 'xxx' of undefined
Missing required environment variable
```

**解决**：
- 检查是否所有必需的环境变量都已配置

---

**错误 D：依赖包问题**
```
Cannot find module 'xxx'
Error: Cannot find package 'xxx'
```

**解决**：
- 重新构建并部署

---

### 检查 3：直接访问后端健康检查

在浏览器打开以下URL：

```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/
```

**期望结果**：
- 返回 "Hello World" 或类似欢迎信息
- 或者 404（说明服务在运行，只是根路径没有路由）

**如果显示**：
- `ERR_CONNECTION_CLOSED` → 服务未启动
- `502 Bad Gateway` → 服务启动失败
- `503 Service Unavailable` → 服务正在启动中，等待

---

### 检查 4：验证 API 文档路径

访问 Swagger 文档：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/docs
```

**期望**：显示 Swagger API 文档页面  
**异常**：无法访问 → 服务未正常启动

---

## 🛠️ 快速修复方案

### 方案 1：查看并修复日志错误

1. **查看日志** → 找到具体错误信息
2. **根据错误** → 修复对应配置
3. **重新部署** → 等待服务启动

---

### 方案 2：强制重启服务

1. 云托管控制台 → 服务管理
2. 点击 **停止服务**
3. 等待完全停止（约 30 秒）
4. 点击 **启动服务**
5. 等待启动（3-5 分钟）

---

### 方案 3：回滚到上一个版本

如果新版本有问题：

1. 云托管控制台 → **版本管理**
2. 找到上一个可用版本
3. 点击 **回滚**

---

### 方案 4：手动测试数据库连接

创建测试脚本验证数据库：

```javascript
// test-db-connection.js
const mysql = require('mysql2/promise');

async function testConnection() {
  try {
    const connection = await mysql.createConnection({
      host: '10.32.104.73',
      port: 3306,
      user: 'root',
      password: '050710Xzl',
      database: 'cooktip'
    });
    
    console.log('✅ 数据库连接成功！');
    
    const [rows] = await connection.execute('SELECT COUNT(*) as count FROM recipes');
    console.log('✅ 食谱数量:', rows[0].count);
    
    await connection.end();
  } catch (error) {
    console.error('❌ 数据库连接失败:', error.message);
  }
}

testConnection();
```

本地运行：
```bash
node test-db-connection.js
```

---

## 📋 排查清单

请逐项检查并告诉我结果：

- [ ] **服务状态是否为 "运行中"？**
  - [ ] 是 → 继续下一项
  - [ ] 否 → 查看为什么服务停止了

- [ ] **访问根路径有响应吗？** (`https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/`)
  - [ ] 有 → 继续下一项
  - [ ] 无 → 服务未启动

- [ ] **日志中有错误吗？**
  - [ ] 有 → 把错误信息发给我
  - [ ] 无 → 可能是网络问题

- [ ] **环境变量全部配置了吗？**（共 21 个）
  - [ ] 是
  - [ ] 否 → 参考 `cloudbase-env-vars.json`

- [ ] **数据库实例在运行吗？**
  - 访问：https://console.cloud.tencent.com/cynosdb
  - 检查 cooktip 数据库状态

---

## 🔬 深度诊断命令

### 在云托管终端执行（如果可以）

```bash
# 检查进程
ps aux | grep node

# 检查端口
netstat -tlnp | grep 3000

# 检查日志
tail -f /var/log/app.log

# 测试数据库连接
mysql -h 10.32.104.73 -P 3306 -u root -p
```

---

## 💡 最可能的原因

根据经验，`ERR_CONNECTION_CLOSED` + 配置已更新 = 以下原因之一：

1. **🔴 数据库连接失败** (70% 可能性)
   - 密码错误
   - 数据库实例未运行
   - 内网地址配置错误

2. **🟡 服务启动失败** (20% 可能性)
   - 代码有 bug
   - 缺少依赖
   - 端口冲突

3. **🟢 网络问题** (10% 可能性)
   - CDN 缓存
   - 域名解析问题

---

## 🆘 紧急联系方式

**请立即执行以下操作并反馈结果**：

### 步骤 1：截图服务状态
云托管控制台 → 服务管理 → 截图服务状态

### 步骤 2：复制最新日志
云托管控制台 → 日志管理 → 复制最近 20 行日志

### 步骤 3：测试根路径
在浏览器访问：`https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/`
告诉我看到了什么

---

**把上面三个结果发给我，我立即帮您诊断！** 🚑

