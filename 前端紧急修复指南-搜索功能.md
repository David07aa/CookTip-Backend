# 🔧 前端紧急修复指南 - 搜索功能 404 错误

**问题**：搜索功能报 404 错误  
**原因**：前端直接访问公网地址 + 接口路径错误  
**修复时间**：5-10 分钟

---

## ❌ 当前错误

```
GET https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search?keyword=酸菜鱼&page=1&limit=10
404 (Not Found)
```

**错误原因**：
1. ❌ 前端直接访问了公网地址（应该通过云函数访问）
2. ❌ 接口路径错误（`/api/v1/search` 应该是 `/api/v1/search/recipes`）

---

## ✅ 正确的做法

### 必须使用云函数访问后端 API

```
❌ 错误：小程序 → 公网地址（不在白名单）→ 后端
✅ 正确：小程序 → 云函数（自动在白名单）→ 后端
```

### 正确的接口路径

| 功能 | ❌ 错误路径 | ✅ 正确路径 |
|------|-----------|-----------|
| 搜索食谱 | `/api/v1/search` | `/api/v1/search/recipes` |
| 热门搜索词 | - | `/api/v1/search/hot-keywords` |
| 搜索建议 | - | `/api/v1/search/suggestions` |

---

## 🔧 修复步骤

### 第 1 步：确认工具类已复制

检查以下文件是否存在：

```
小程序项目/
└── miniprogram/
    └── utils/
        ├── cloudRequest.js  ✅ 必须有
        └── api.js          ✅ 必须有
```

**如果没有**，从后端项目复制：
```
从：CookTip-Backend/miniprogram-utils/cloudRequest.js
到：小程序项目/miniprogram/utils/cloudRequest.js

从：CookTip-Backend/miniprogram-utils/api.js
到：小程序项目/miniprogram/utils/api.js
```

---

### 第 2 步：找到搜索页面代码

在小程序项目中找到搜索相关的文件，可能是：
- `pages/search/search.js`
- `pages/index/index.js`（如果搜索在首页）
- 或其他包含搜索功能的页面

---

### 第 3 步：修改搜索请求代码

#### 查找需要修改的代码

搜索以下关键词：
```javascript
// 可能的错误代码特征：
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search'
  // 或
  url: '/api/v1/search'
})
```

#### 替换为正确的代码

**完整的搜索页面代码示例**：

```javascript
// pages/search/search.js
const api = require('../../utils/api')  // ⭐ 引入 API 工具类

Page({
  data: {
    keyword: '',              // 搜索关键词
    searchResults: [],        // 搜索结果
    searching: false,         // 搜索中状态
    hotKeywords: []           // 热门搜索词
  },
  
  onLoad() {
    // 加载热门搜索词
    this.loadHotKeywords()
  },
  
  // ⭐ 加载热门搜索词
  async loadHotKeywords() {
    try {
      const res = await api.getHotKeywords()
      this.setData({
        hotKeywords: res.data || []
      })
    } catch (error) {
      console.error('加载热门搜索词失败:', error)
    }
  },
  
  // 输入搜索关键词
  onKeywordInput(e) {
    this.setData({
      keyword: e.detail.value
    })
  },
  
  // ⭐ 执行搜索（核心方法）
  async performSearch() {
    const { keyword } = this.data
    
    // 验证关键词
    if (!keyword || !keyword.trim()) {
      wx.showToast({
        title: '请输入搜索关键词',
        icon: 'none'
      })
      return
    }
    
    // 显示加载状态
    this.setData({ searching: true })
    
    try {
      // ✅ 正确：使用封装好的 API（通过云函数）
      const res = await api.searchRecipes(keyword, {
        page: 1,
        limit: 20
      })
      
      console.log('✅ 搜索成功:', res)
      
      // 更新搜索结果
      this.setData({
        searchResults: res.data.items || res.data,
        searching: false
      })
      
      // 提示用户
      if ((res.data.items || res.data).length === 0) {
        wx.showToast({
          title: '没有找到相关食谱',
          icon: 'none'
        })
      }
      
    } catch (error) {
      console.error('❌ 搜索失败:', error)
      
      this.setData({ searching: false })
      
      wx.showToast({
        title: '搜索失败，请重试',
        icon: 'none'
      })
    }
  },
  
  // 点击搜索按钮
  onSearchButtonTap() {
    this.performSearch()
  },
  
  // 点击热门搜索词
  onHotKeywordTap(e) {
    const keyword = e.currentTarget.dataset.keyword
    this.setData({ keyword })
    this.performSearch()
  },
  
  // 清除搜索
  onClearKeyword() {
    this.setData({
      keyword: '',
      searchResults: []
    })
  }
})
```

---

### 第 4 步：删除或注释旧的错误代码

**找到并删除/注释这些代码**：

```javascript
// ❌ 删除这样的代码
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search',
  method: 'GET',
  data: {
    keyword: keyword,
    page: 1,
    limit: 10
  },
  success: (res) => {
    // ...
  }
})

// ❌ 也要删除使用 request 工具的代码（如果有）
request({
  url: '/api/v1/search',
  method: 'GET',
  data: { keyword }
})
```

---

## 📝 其他可能需要修改的地方

### 1. 如果有自定义的 request 工具类

**查找**：`utils/request.js` 或 `utils/http.js`

**如果存在**：确保它也配置了正确的基础 URL，或者直接使用我们提供的 `cloudRequest.js`

---

### 2. 如果在其他页面也有搜索功能

**需要检查的文件**：
- `pages/index/index.js`（首页搜索）
- `pages/recipe-list/recipe-list.js`（食谱列表搜索）
- 其他可能包含搜索的页面

**统一使用**：
```javascript
const api = require('../../utils/api')
const res = await api.searchRecipes(keyword, { page, limit })
```

---

### 3. 配置文件检查

**如果有 `config.js` 或 `config.json`**：

```javascript
// config/config.js 或 utils/config.js
module.exports = {
  // ❌ 删除或注释这些
  // apiBaseUrl: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1',
  
  // ✅ 不需要配置 API 地址了，因为使用云函数
  // 如果需要配置其他内容：
  timeout: 10000,
  tokenKey: 'cooktip_token'
}
```

---

## 🧪 测试验证

### 测试 1：控制台测试

在微信开发者工具控制台运行：

```javascript
// 测试 API 工具类
const api = require('../../utils/api')

// 测试搜索功能
api.searchRecipes('酸菜鱼', {
  page: 1,
  limit: 10
}).then(res => {
  console.log('✅ 搜索成功:', res)
  console.log('结果数量:', res.data.items ? res.data.items.length : res.data.length)
}).catch(err => {
  console.error('❌ 搜索失败:', err)
})

// 测试热门搜索词
api.getHotKeywords().then(res => {
  console.log('✅ 热门搜索词:', res)
}).catch(err => {
  console.error('❌ 获取失败:', err)
})
```

**期望结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [...],
    "total": 5,
    "page": 1,
    "limit": 10
  }
}
```

---

### 测试 2：页面功能测试

1. **输入搜索关键词**：如"酸菜鱼"、"番茄炒蛋"
2. **点击搜索按钮**
3. **检查**：
   - ✅ 是否显示搜索结果
   - ✅ 控制台是否有成功日志
   - ✅ 是否没有 404 错误

---

### 测试 3：真机预览

1. 点击 **预览** 按钮
2. 手机扫码
3. 测试搜索功能
4. 确认一切正常

---

## 📋 完整的 API 方法参考

工具类 `api.js` 提供的搜索相关方法：

```javascript
const api = require('../../utils/api')

// 1. 搜索食谱
api.searchRecipes(keyword, { page, limit, category_id, difficulty, sort })

// 2. 获取热门搜索词
api.getHotKeywords()

// 3. 获取搜索建议
api.getSearchSuggestions(keyword)
```

**完整示例**：

```javascript
// 搜索食谱
const searchResult = await api.searchRecipes('番茄炒蛋', {
  page: 1,
  limit: 10,
  difficulty: '简单',  // 可选：筛选难度
  sort: 'latest'       // 可选：排序方式
})

// 获取热门搜索词
const hotKeywords = await api.getHotKeywords()

// 获取搜索建议（输入时的自动补全）
const suggestions = await api.getSearchSuggestions('番茄')
```

---

## 🔍 常见问题

### Q1：修改后还是 404？

**检查清单**：
- [ ] 确认 `api.js` 和 `cloudRequest.js` 已复制
- [ ] 确认代码中使用了 `api.searchRecipes()`
- [ ] 确认没有遗漏的 `wx.request` 调用
- [ ] 清除缓存并重新编译

**清除缓存方法**：
1. 点击开发者工具右上角 **清缓存** → **全部清除**
2. 重新编译项目

---

### Q2：提示 "api is not defined"？

**原因**：没有正确引入 API 工具类

**解决**：在页面顶部添加：
```javascript
const api = require('../../utils/api')
```

**注意路径**：
- 如果是 `pages/search/search.js`：`../../utils/api`
- 如果是 `pages/index/index.js`：`../../utils/api`
- 根据实际文件层级调整路径

---

### Q3：云函数调用失败？

**检查 `app.js` 是否已初始化云开发**：

```javascript
// app.js
App({
  onLaunch() {
    wx.cloud.init({
      env: 'your-env-id',  // ⚠️ 确认环境 ID 正确
      traceUser: true
    })
  }
})
```

---

### Q4：搜索结果为空？

**可能原因**：
1. 数据库中没有匹配的数据
2. 关键词拼写错误

**测试方法**：
```javascript
// 尝试搜索已知存在的食谱
api.searchRecipes('鸡', { page: 1, limit: 10 })
```

---

## 📊 修改前后对比

### 修改前（错误）❌

```javascript
// ❌ 直接访问公网地址
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/search',
  method: 'GET',
  data: {
    keyword: '酸菜鱼',
    page: 1,
    limit: 10
  },
  success: (res) => {
    console.log(res)
  },
  fail: (err) => {
    console.error(err)  // 报 404 错误
  }
})
```

### 修改后（正确）✅

```javascript
// ✅ 使用云函数 API
const api = require('../../utils/api')

try {
  const res = await api.searchRecipes('酸菜鱼', {
    page: 1,
    limit: 10
  })
  console.log('搜索成功:', res)
  // 处理结果...
} catch (error) {
  console.error('搜索失败:', error)
}
```

---

## ✅ 修复完成检查清单

修复完成后，确认以下事项：

- [ ] ✅ 工具类文件已复制到 `miniprogram/utils/`
- [ ] ✅ 搜索页面引入了 `api.js`
- [ ] ✅ 使用 `api.searchRecipes()` 方法
- [ ] ✅ 删除了所有 `wx.request` 直接调用
- [ ] ✅ 控制台测试通过
- [ ] ✅ 页面搜索功能正常
- [ ] ✅ 没有 404 错误
- [ ] ✅ 能正常显示搜索结果
- [ ] ✅ 真机预览测试通过

---

## 🆘 需要帮助？

如果修改后还有问题，请提供：

1. **错误截图**：包含完整的错误信息
2. **代码截图**：搜索页面的关键代码
3. **控制台输出**：完整的日志信息
4. **文件结构**：`utils` 目录下的文件列表

---

## 📚 相关文档

- **云函数部署指南**：`云函数部署完整指南.md`
- **API 使用示例**：`miniprogram-utils/使用示例.md`
- **快速参考**：`云函数快速参考.md`

---

## 🎯 总结

**核心要点**：
1. ✅ 使用云函数访问后端 API（通过 `api.js`）
2. ✅ 不要直接使用 `wx.request` 访问公网地址
3. ✅ 搜索接口路径：`/api/v1/search/recipes`
4. ✅ 使用 `api.searchRecipes()` 方法

**修复后**：
- ✅ 搜索功能正常工作
- ✅ 没有 404 错误
- ✅ 能返回正确的搜索结果

---

**修复完成后，搜索功能应该可以正常使用了！** 🎉

**更新时间**：2025-10-16  
**适用版本**：CookTip 小程序 v1.0

