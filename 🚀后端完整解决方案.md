# ğŸš€ åç«¯å®Œæ•´è§£å†³æ–¹æ¡ˆ

> æœ¬æ–‡æ¡£æä¾›ç»™åç«¯å¼€å‘äººå‘˜ï¼ŒåŒ…å«å®Œæ•´çš„APIå®ç°å’ŒCORSé…ç½®

## ğŸ“Š é—®é¢˜åˆ†æ

### å‰ç«¯æŠ¥é”™ä¿¡æ¯
```
request:fail invalid url "/api/categories"
```

### é—®é¢˜å¯èƒ½åŸå› 
1. âŒ **å‰ç«¯URLæ‹¼æ¥é—®é¢˜**ï¼ˆå·²æ’é™¤ï¼Œå‰ç«¯ä»£ç æ­£ç¡®ï¼‰
2. âš ï¸ **åç«¯CORSé…ç½®ç¼ºå¤±æˆ–é”™è¯¯**
3. âš ï¸ **åç«¯APIè·¯ç”±æœªæ­£ç¡®é…ç½®**
4. âš ï¸ **Verceléƒ¨ç½²é…ç½®é—®é¢˜**

## ğŸ¯ åç«¯æŠ€æœ¯æ ˆè¦æ±‚

æ ¹æ® `å‰ç«¯å¯¹æ¥æ–‡æ¡£.md`ï¼Œåç«¯åº”è¯¥ä½¿ç”¨ï¼š
- **æ¡†æ¶**: Express.js / Koa.js / Fastify ç­‰ Node.js æ¡†æ¶
- **æ•°æ®åº“**: MySQL / PostgreSQL / MongoDB
- **éƒ¨ç½²**: Vercel / Netlify / è‡ªå»ºæœåŠ¡å™¨
- **åŸŸå**: `https://cooktip-backend.vercel.app`

## ğŸ”§ æ ¸å¿ƒé…ç½®

### 1. CORS è·¨åŸŸé…ç½®ï¼ˆå…³é”®ï¼ï¼‰

#### Express.js ç‰ˆæœ¬
```javascript
// app.js æˆ– server.js
const express = require('express')
const cors = require('cors')

const app = express()

// CORSé…ç½® - å…è®¸å¾®ä¿¡å°ç¨‹åºè®¿é—®
app.use(cors({
  origin: '*',  // ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®å…·ä½“åŸŸå
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400  // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´
}))

// å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚
app.options('*', cors())

// è§£æ JSON body
app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true, limit: '10mb' }))

// æ·»åŠ å“åº”å¤´ä¸­é—´ä»¶ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*')
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization')
  
  if (req.method === 'OPTIONS') {
    return res.sendStatus(200)
  }
  next()
})
```

#### Koa.js ç‰ˆæœ¬
```javascript
const Koa = require('koa')
const cors = require('@koa/cors')
const bodyParser = require('koa-bodyparser')

const app = new Koa()

// CORSé…ç½®
app.use(cors({
  origin: '*',
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}))

// è§£æè¯·æ±‚ä½“
app.use(bodyParser({
  jsonLimit: '10mb',
  formLimit: '10mb'
}))
```

### 2. Vercel éƒ¨ç½²é…ç½®

åˆ›å»º `vercel.json` æ–‡ä»¶ï¼š

```json
{
  "version": 2,
  "builds": [
    {
      "src": "app.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/app.js",
      "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
      "headers": {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type, Authorization"
      }
    }
  ],
  "env": {
    "DATABASE_URL": "@database_url",
    "JWT_SECRET": "@jwt_secret"
  }
}
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“é…ç½®
DATABASE_URL=your_database_connection_string

# JWTå¯†é’¥
JWT_SECRET=your_super_secret_jwt_key_change_this_in_production

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# APIé…ç½®
API_BASE_URL=https://cooktip-backend.vercel.app

# å›¾ç‰‡ä¸Šä¼ é…ç½®ï¼ˆå¦‚ä½¿ç”¨äº‘å­˜å‚¨ï¼‰
CLOUD_STORAGE_BUCKET=your_bucket_name
CLOUD_STORAGE_KEY=your_storage_key
```

## ğŸ“ å®Œæ•´APIå®ç°

### ç›®å½•ç»“æ„
```
cooktip-backend/
â”œâ”€â”€ app.js                 # ä¸»åº”ç”¨æ–‡ä»¶
â”œâ”€â”€ vercel.json           # Vercelé…ç½®
â”œâ”€â”€ package.json
â”œâ”€â”€ .env
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.js           # è®¤è¯è·¯ç”±
â”‚   â”œâ”€â”€ user.js           # ç”¨æˆ·è·¯ç”±
â”‚   â”œâ”€â”€ recipe.js         # é£Ÿè°±è·¯ç”±
â”‚   â”œâ”€â”€ category.js       # åˆ†ç±»è·¯ç”±
â”‚   â”œâ”€â”€ favorite.js       # æ”¶è—è·¯ç”±
â”‚   â”œâ”€â”€ like.js           # ç‚¹èµè·¯ç”±
â”‚   â”œâ”€â”€ comment.js        # è¯„è®ºè·¯ç”±
â”‚   â””â”€â”€ search.js         # æœç´¢è·¯ç”±
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ models/
â”‚   â””â”€â”€ ...
â””â”€â”€ middleware/
    â”œâ”€â”€ auth.js           # JWTè®¤è¯ä¸­é—´ä»¶
    â””â”€â”€ errorHandler.js   # é”™è¯¯å¤„ç†
```

### ä¸»åº”ç”¨æ–‡ä»¶ `app.js`

```javascript
const express = require('express')
const cors = require('cors')
require('dotenv').config()

const app = express()

// ==================== ä¸­é—´ä»¶é…ç½® ====================

// CORSé…ç½®ï¼ˆå¿…é¡»åœ¨æ‰€æœ‰è·¯ç”±ä¹‹å‰ï¼‰
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}))

app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true, limit: '10mb' }))

// è¯·æ±‚æ—¥å¿—
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`)
  next()
})

// ==================== è·¯ç”±é…ç½® ====================

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({
    code: 200,
    message: 'OK',
    data: {
      status: 'healthy',
      timestamp: new Date().toISOString()
    }
  })
})

// APIè·¯ç”±
app.use('/api/auth', require('./routes/auth'))
app.use('/api/users', require('./routes/user'))
app.use('/api/recipes', require('./routes/recipe'))
app.use('/api/categories', require('./routes/category'))
app.use('/api/favorites', require('./routes/favorite'))
app.use('/api/likes', require('./routes/like'))
app.use('/api/comments', require('./routes/comment'))
app.use('/api/search', require('./routes/search'))

// ==================== é”™è¯¯å¤„ç† ====================

// 404å¤„ç†
app.use((req, res) => {
  res.status(404).json({
    code: 404,
    message: 'API endpoint not found',
    data: null
  })
})

// å…¨å±€é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error('Error:', err)
  res.status(err.status || 500).json({
    code: err.status || 500,
    message: err.message || 'Internal Server Error',
    data: null
  })
})

// ==================== å¯åŠ¨æœåŠ¡å™¨ ====================

const PORT = process.env.PORT || 3000

if (process.env.NODE_ENV !== 'production') {
  app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`)
    console.log(`Environment: ${process.env.NODE_ENV}`)
  })
}

// Vercel éœ€è¦å¯¼å‡º app
module.exports = app
```

### åˆ†ç±»è·¯ç”± `routes/category.js`

```javascript
const express = require('express')
const router = express.Router()

// GET /api/categories - è·å–åˆ†ç±»åˆ—è¡¨
router.get('/', async (req, res) => {
  try {
    // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…åº”è¯¥ä»æ•°æ®åº“æŸ¥è¯¢ï¼‰
    const categories = [
      'ä¸­å¼', 'è¥¿å¼', 'æ—¥å¼', 'çƒ˜ç„™', 
      'æ±¤å“', 'å¿«æ‰‹èœ', 'ç”œå“', 'ç´ é£Ÿ'
    ]

    res.json({
      code: 200,
      message: 'success',
      data: categories
    })
  } catch (error) {
    console.error('Get categories error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

module.exports = router
```

### é£Ÿè°±è·¯ç”± `routes/recipe.js`

```javascript
const express = require('express')
const router = express.Router()
const { authenticate } = require('../middleware/auth')

// GET /api/recipes - è·å–é£Ÿè°±åˆ—è¡¨
router.get('/', async (req, res) => {
  try {
    const {
      page = 1,
      limit = 10,
      category,
      difficulty,
      sortBy = 'latest'
    } = req.query

    // TODO: ä»æ•°æ®åº“æŸ¥è¯¢
    // è¿™é‡Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
    const recipes = []
    
    res.json({
      code: 200,
      message: 'success',
      data: {
        list: recipes,
        total: 0,
        page: parseInt(page),
        pageSize: parseInt(limit),
        hasMore: false
      }
    })
  } catch (error) {
    console.error('Get recipes error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// GET /api/recipes/:id - è·å–é£Ÿè°±è¯¦æƒ…
router.get('/:id', async (req, res) => {
  try {
    const { id } = req.params
    
    // TODO: ä»æ•°æ®åº“æŸ¥è¯¢
    
    res.json({
      code: 200,
      message: 'success',
      data: {
        id,
        title: 'ç¤ºä¾‹é£Ÿè°±',
        // ... å…¶ä»–å­—æ®µ
      }
    })
  } catch (error) {
    console.error('Get recipe detail error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// POST /api/recipes - åˆ›å»ºé£Ÿè°±ï¼ˆéœ€è¦è®¤è¯ï¼‰
router.post('/', authenticate, async (req, res) => {
  try {
    const recipeData = req.body
    const userId = req.user.id
    
    // TODO: ä¿å­˜åˆ°æ•°æ®åº“
    
    res.json({
      code: 200,
      message: 'Recipe created successfully',
      data: {
        id: 'new_recipe_id',
        ...recipeData
      }
    })
  } catch (error) {
    console.error('Create recipe error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// PUT /api/recipes/:id - æ›´æ–°é£Ÿè°±ï¼ˆéœ€è¦è®¤è¯ï¼‰
router.put('/:id', authenticate, async (req, res) => {
  try {
    const { id } = req.params
    const updateData = req.body
    const userId = req.user.id
    
    // TODO: æ›´æ–°æ•°æ®åº“
    
    res.json({
      code: 200,
      message: 'Recipe updated successfully',
      data: null
    })
  } catch (error) {
    console.error('Update recipe error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// DELETE /api/recipes/:id - åˆ é™¤é£Ÿè°±ï¼ˆéœ€è¦è®¤è¯ï¼‰
router.delete('/:id', authenticate, async (req, res) => {
  try {
    const { id } = req.params
    const userId = req.user.id
    
    // TODO: ä»æ•°æ®åº“åˆ é™¤
    
    res.json({
      code: 200,
      message: 'Recipe deleted successfully',
      data: null
    })
  } catch (error) {
    console.error('Delete recipe error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

module.exports = router
```

### JWTè®¤è¯ä¸­é—´ä»¶ `middleware/auth.js`

```javascript
const jwt = require('jsonwebtoken')

// JWTè®¤è¯ä¸­é—´ä»¶
function authenticate(req, res, next) {
  try {
    // ä»è¯·æ±‚å¤´è·å–token
    const authHeader = req.headers.authorization
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        code: 401,
        message: 'Authentication required',
        data: null
      })
    }
    
    const token = authHeader.substring(7) // ç§»é™¤ "Bearer "
    
    // éªŒè¯token
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    
    // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    req.user = decoded
    
    next()
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({
        code: 401,
        message: 'Invalid token',
        data: null
      })
    }
    
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        code: 401,
        message: 'Token expired',
        data: null
      })
    }
    
    return res.status(500).json({
      code: 500,
      message: 'Authentication error',
      data: null
    })
  }
}

module.exports = { authenticate }
```

### package.json

```json
{
  "name": "cooktip-backend",
  "version": "1.0.0",
  "description": "CookTip Backend API",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js",
    "test": "jest"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "jsonwebtoken": "^9.0.2",
    "bcrypt": "^5.1.1",
    "mysql2": "^3.6.0",
    "sequelize": "^6.32.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

## ğŸ§ª æµ‹è¯•API

### ä½¿ç”¨curlæµ‹è¯•

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl https://cooktip-backend.vercel.app/health

# æµ‹è¯•åˆ†ç±»æ¥å£
curl https://cooktip-backend.vercel.app/api/categories

# æµ‹è¯•é£Ÿè°±åˆ—è¡¨
curl "https://cooktip-backend.vercel.app/api/recipes?page=1&limit=10"

# æµ‹è¯•é£Ÿè°±è¯¦æƒ…
curl https://cooktip-backend.vercel.app/api/recipes/123
```

### é¢„æœŸå“åº”æ ¼å¼

```json
{
  "code": 200,
  "message": "success",
  "data": [
    "ä¸­å¼", "è¥¿å¼", "æ—¥å¼", "çƒ˜ç„™", 
    "æ±¤å“", "å¿«æ‰‹èœ", "ç”œå“", "ç´ é£Ÿ"
  ]
}
```

## ğŸš€ éƒ¨ç½²åˆ°Vercel

### 1. å®‰è£…Vercel CLI
```bash
npm install -g vercel
```

### 2. ç™»å½•Vercel
```bash
vercel login
```

### 3. éƒ¨ç½²é¡¹ç›®
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
vercel

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
vercel --prod
```

### 4. é…ç½®ç¯å¢ƒå˜é‡
```bash
# é€šè¿‡CLIé…ç½®
vercel env add DATABASE_URL
vercel env add JWT_SECRET

# æˆ–åœ¨Vercel Dashboardä¸­é…ç½®
```

## ğŸ“‹ åç«¯æ£€æŸ¥æ¸…å•

éƒ¨ç½²åè¯·ç¡®è®¤ï¼š

- [ ] CORSé…ç½®å·²æ·»åŠ ä¸”åŒ…å«æ‰€æœ‰å¿…éœ€çš„è¯·æ±‚å¤´
- [ ] æ‰€æœ‰APIç«¯ç‚¹éƒ½è¿”å›æ­£ç¡®çš„JSONæ ¼å¼
- [ ] å“åº”æ ¼å¼ç¬¦åˆå‰ç«¯å¯¹æ¥æ–‡æ¡£ï¼š`{ code, message, data }`
- [ ] `/health` ç«¯ç‚¹å¯è®¿é—®
- [ ] `/api/categories` è¿”å›åˆ†ç±»æ•°ç»„
- [ ] `/api/recipes` è¿”å›é£Ÿè°±åˆ—è¡¨
- [ ] JWTè®¤è¯ä¸­é—´ä»¶æ­£å¸¸å·¥ä½œ
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæ•´
- [ ] Verceléƒ¨ç½²æˆåŠŸä¸”åŸŸåæ­£ç¡®

## ğŸ”— ç›¸å…³èµ„æº

- [Express CORSæ–‡æ¡£](https://expressjs.com/en/resources/middleware/cors.html)
- [Verceléƒ¨ç½²æ–‡æ¡£](https://vercel.com/docs)
- [å¾®ä¿¡å°ç¨‹åºç½‘ç»œè¯·æ±‚æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)

---

**åˆ›å»ºæ—¶é—´**: 2025-10-02  
**ç»´æŠ¤è€…**: åç«¯å¼€å‘å›¢é˜Ÿ  
**å‰ç«¯å¯¹æ¥æ–‡æ¡£**: `å‰ç«¯å¯¹æ¥æ–‡æ¡£.md`

