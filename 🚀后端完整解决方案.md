# 🚀 后端完整解决方案

> 本文档提供给后端开发人员，包含完整的API实现和CORS配置

## 📊 问题分析

### 前端报错信息
```
request:fail invalid url "/api/categories"
```

### 问题可能原因
1. ❌ **前端URL拼接问题**（已排除，前端代码正确）
2. ⚠️ **后端CORS配置缺失或错误**
3. ⚠️ **后端API路由未正确配置**
4. ⚠️ **Vercel部署配置问题**

## 🎯 后端技术栈要求

根据 `前端对接文档.md`，后端应该使用：
- **框架**: Express.js / Koa.js / Fastify 等 Node.js 框架
- **数据库**: MySQL / PostgreSQL / MongoDB
- **部署**: Vercel / Netlify / 自建服务器
- **域名**: `https://cooktip-backend.vercel.app`

## 🔧 核心配置

### 1. CORS 跨域配置（关键！）

#### Express.js 版本
```javascript
// app.js 或 server.js
const express = require('express')
const cors = require('cors')

const app = express()

// CORS配置 - 允许微信小程序访问
app.use(cors({
  origin: '*',  // 生产环境建议配置具体域名
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400  // 预检请求缓存时间
}))

// 处理 OPTIONS 预检请求
app.options('*', cors())

// 解析 JSON body
app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true, limit: '10mb' }))

// 添加响应头中间件（备用方案）
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*')
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization')
  
  if (req.method === 'OPTIONS') {
    return res.sendStatus(200)
  }
  next()
})
```

#### Koa.js 版本
```javascript
const Koa = require('koa')
const cors = require('@koa/cors')
const bodyParser = require('koa-bodyparser')

const app = new Koa()

// CORS配置
app.use(cors({
  origin: '*',
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}))

// 解析请求体
app.use(bodyParser({
  jsonLimit: '10mb',
  formLimit: '10mb'
}))
```

### 2. Vercel 部署配置

创建 `vercel.json` 文件：

```json
{
  "version": 2,
  "builds": [
    {
      "src": "app.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/app.js",
      "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
      "headers": {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type, Authorization"
      }
    }
  ],
  "env": {
    "DATABASE_URL": "@database_url",
    "JWT_SECRET": "@jwt_secret"
  }
}
```

### 3. 环境变量配置

创建 `.env` 文件：

```env
# 数据库配置
DATABASE_URL=your_database_connection_string

# JWT密钥
JWT_SECRET=your_super_secret_jwt_key_change_this_in_production

# 服务器配置
PORT=3000
NODE_ENV=production

# API配置
API_BASE_URL=https://cooktip-backend.vercel.app

# 图片上传配置（如使用云存储）
CLOUD_STORAGE_BUCKET=your_bucket_name
CLOUD_STORAGE_KEY=your_storage_key
```

## 📝 完整API实现

### 目录结构
```
cooktip-backend/
├── app.js                 # 主应用文件
├── vercel.json           # Vercel配置
├── package.json
├── .env
├── routes/
│   ├── auth.js           # 认证路由
│   ├── user.js           # 用户路由
│   ├── recipe.js         # 食谱路由
│   ├── category.js       # 分类路由
│   ├── favorite.js       # 收藏路由
│   ├── like.js           # 点赞路由
│   ├── comment.js        # 评论路由
│   └── search.js         # 搜索路由
├── controllers/
│   └── ...
├── models/
│   └── ...
└── middleware/
    ├── auth.js           # JWT认证中间件
    └── errorHandler.js   # 错误处理
```

### 主应用文件 `app.js`

```javascript
const express = require('express')
const cors = require('cors')
require('dotenv').config()

const app = express()

// ==================== 中间件配置 ====================

// CORS配置（必须在所有路由之前）
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}))

app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true, limit: '10mb' }))

// 请求日志
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`)
  next()
})

// ==================== 路由配置 ====================

// 健康检查
app.get('/health', (req, res) => {
  res.json({
    code: 200,
    message: 'OK',
    data: {
      status: 'healthy',
      timestamp: new Date().toISOString()
    }
  })
})

// API路由
app.use('/api/auth', require('./routes/auth'))
app.use('/api/users', require('./routes/user'))
app.use('/api/recipes', require('./routes/recipe'))
app.use('/api/categories', require('./routes/category'))
app.use('/api/favorites', require('./routes/favorite'))
app.use('/api/likes', require('./routes/like'))
app.use('/api/comments', require('./routes/comment'))
app.use('/api/search', require('./routes/search'))

// ==================== 错误处理 ====================

// 404处理
app.use((req, res) => {
  res.status(404).json({
    code: 404,
    message: 'API endpoint not found',
    data: null
  })
})

// 全局错误处理
app.use((err, req, res, next) => {
  console.error('Error:', err)
  res.status(err.status || 500).json({
    code: err.status || 500,
    message: err.message || 'Internal Server Error',
    data: null
  })
})

// ==================== 启动服务器 ====================

const PORT = process.env.PORT || 3000

if (process.env.NODE_ENV !== 'production') {
  app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`)
    console.log(`Environment: ${process.env.NODE_ENV}`)
  })
}

// Vercel 需要导出 app
module.exports = app
```

### 分类路由 `routes/category.js`

```javascript
const express = require('express')
const router = express.Router()

// GET /api/categories - 获取分类列表
router.get('/', async (req, res) => {
  try {
    // 模拟数据（实际应该从数据库查询）
    const categories = [
      '中式', '西式', '日式', '烘焙', 
      '汤品', '快手菜', '甜品', '素食'
    ]

    res.json({
      code: 200,
      message: 'success',
      data: categories
    })
  } catch (error) {
    console.error('Get categories error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

module.exports = router
```

### 食谱路由 `routes/recipe.js`

```javascript
const express = require('express')
const router = express.Router()
const { authenticate } = require('../middleware/auth')

// GET /api/recipes - 获取食谱列表
router.get('/', async (req, res) => {
  try {
    const {
      page = 1,
      limit = 10,
      category,
      difficulty,
      sortBy = 'latest'
    } = req.query

    // TODO: 从数据库查询
    // 这里返回模拟数据
    const recipes = []
    
    res.json({
      code: 200,
      message: 'success',
      data: {
        list: recipes,
        total: 0,
        page: parseInt(page),
        pageSize: parseInt(limit),
        hasMore: false
      }
    })
  } catch (error) {
    console.error('Get recipes error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// GET /api/recipes/:id - 获取食谱详情
router.get('/:id', async (req, res) => {
  try {
    const { id } = req.params
    
    // TODO: 从数据库查询
    
    res.json({
      code: 200,
      message: 'success',
      data: {
        id,
        title: '示例食谱',
        // ... 其他字段
      }
    })
  } catch (error) {
    console.error('Get recipe detail error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// POST /api/recipes - 创建食谱（需要认证）
router.post('/', authenticate, async (req, res) => {
  try {
    const recipeData = req.body
    const userId = req.user.id
    
    // TODO: 保存到数据库
    
    res.json({
      code: 200,
      message: 'Recipe created successfully',
      data: {
        id: 'new_recipe_id',
        ...recipeData
      }
    })
  } catch (error) {
    console.error('Create recipe error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// PUT /api/recipes/:id - 更新食谱（需要认证）
router.put('/:id', authenticate, async (req, res) => {
  try {
    const { id } = req.params
    const updateData = req.body
    const userId = req.user.id
    
    // TODO: 更新数据库
    
    res.json({
      code: 200,
      message: 'Recipe updated successfully',
      data: null
    })
  } catch (error) {
    console.error('Update recipe error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

// DELETE /api/recipes/:id - 删除食谱（需要认证）
router.delete('/:id', authenticate, async (req, res) => {
  try {
    const { id } = req.params
    const userId = req.user.id
    
    // TODO: 从数据库删除
    
    res.json({
      code: 200,
      message: 'Recipe deleted successfully',
      data: null
    })
  } catch (error) {
    console.error('Delete recipe error:', error)
    res.status(500).json({
      code: 500,
      message: error.message,
      data: null
    })
  }
})

module.exports = router
```

### JWT认证中间件 `middleware/auth.js`

```javascript
const jwt = require('jsonwebtoken')

// JWT认证中间件
function authenticate(req, res, next) {
  try {
    // 从请求头获取token
    const authHeader = req.headers.authorization
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        code: 401,
        message: 'Authentication required',
        data: null
      })
    }
    
    const token = authHeader.substring(7) // 移除 "Bearer "
    
    // 验证token
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    
    // 将用户信息附加到请求对象
    req.user = decoded
    
    next()
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({
        code: 401,
        message: 'Invalid token',
        data: null
      })
    }
    
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        code: 401,
        message: 'Token expired',
        data: null
      })
    }
    
    return res.status(500).json({
      code: 500,
      message: 'Authentication error',
      data: null
    })
  }
}

module.exports = { authenticate }
```

### package.json

```json
{
  "name": "cooktip-backend",
  "version": "1.0.0",
  "description": "CookTip Backend API",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js",
    "test": "jest"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "jsonwebtoken": "^9.0.2",
    "bcrypt": "^5.1.1",
    "mysql2": "^3.6.0",
    "sequelize": "^6.32.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

## 🧪 测试API

### 使用curl测试

```bash
# 测试健康检查
curl https://cooktip-backend.vercel.app/health

# 测试分类接口
curl https://cooktip-backend.vercel.app/api/categories

# 测试食谱列表
curl "https://cooktip-backend.vercel.app/api/recipes?page=1&limit=10"

# 测试食谱详情
curl https://cooktip-backend.vercel.app/api/recipes/123
```

### 预期响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": [
    "中式", "西式", "日式", "烘焙", 
    "汤品", "快手菜", "甜品", "素食"
  ]
}
```

## 🚀 部署到Vercel

### 1. 安装Vercel CLI
```bash
npm install -g vercel
```

### 2. 登录Vercel
```bash
vercel login
```

### 3. 部署项目
```bash
# 在项目根目录执行
vercel

# 生产环境部署
vercel --prod
```

### 4. 配置环境变量
```bash
# 通过CLI配置
vercel env add DATABASE_URL
vercel env add JWT_SECRET

# 或在Vercel Dashboard中配置
```

## 📋 后端检查清单

部署后请确认：

- [ ] CORS配置已添加且包含所有必需的请求头
- [ ] 所有API端点都返回正确的JSON格式
- [ ] 响应格式符合前端对接文档：`{ code, message, data }`
- [ ] `/health` 端点可访问
- [ ] `/api/categories` 返回分类数组
- [ ] `/api/recipes` 返回食谱列表
- [ ] JWT认证中间件正常工作
- [ ] 数据库连接正常
- [ ] 环境变量配置完整
- [ ] Vercel部署成功且域名正确

## 🔗 相关资源

- [Express CORS文档](https://expressjs.com/en/resources/middleware/cors.html)
- [Vercel部署文档](https://vercel.com/docs)
- [微信小程序网络请求文档](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)

---

**创建时间**: 2025-10-02  
**维护者**: 后端开发团队  
**前端对接文档**: `前端对接文档.md`

