# CookTip 后端快速启动指南

## ⚠️ 重要提示

本项目使用 **微信云托管 MySQL 数据库**，请先完成云数据库配置。

**📋 配置文档**：请查看 [云数据库配置.md](./云数据库配置.md)

---

## 🎯 快速启动流程

### 前置准备

在开始之前，您需要：

1. ✅ 已开通微信云托管 MySQL 数据库
2. ✅ 已获取数据库内网连接信息
3. ✅ 已创建数据库 `cooktip`
4. ✅ Node.js 16.x 或更高版本

如果还没有完成数据库配置，**请先查看 [云数据库配置.md](./云数据库配置.md)**

---

## 📝 第一步：配置环境变量

在项目根目录创建 `.env` 文件：

```env
# ==========================================
# 应用配置
# ==========================================
NODE_ENV=development
PORT=3000
API_PREFIX=api/v1

# ==========================================
# 微信云托管 MySQL 数据库配置
# 内网地址：10.32.104.72:3306
# 外网地址：sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com:27821
# ==========================================
DB_TYPE=mysql

# 云托管环境使用内网地址（推荐）
DB_HOST=10.32.104.72
DB_PORT=3306

# 本地开发可使用外网地址（需配置IP白名单）
# DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
# DB_PORT=27821

DB_USER=您的数据库账号
DB_PASSWORD=您的数据库密码
DB_NAME=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false

# ==========================================
# JWT 配置
# ==========================================
JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d

# ==========================================
# 微信小程序配置
# ==========================================
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c

# ==========================================
# 文件上传配置
# ==========================================
UPLOAD_DESTINATION=./uploads
MAX_FILE_SIZE=10485760

# 图片CDN配置（可选）
CDN_BASE_URL=http://localhost:3000

# ==========================================
# 限流配置
# ==========================================
THROTTLE_TTL=60
THROTTLE_LIMIT=10
```

**重要**：
- **内网地址**：`10.32.104.72:3306`（云托管环境使用）
- **外网地址**：`sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com:27821`（本地开发使用，需配置IP白名单）
- 将 `DB_USER` 和 `DB_PASSWORD` 替换为您的数据库账号密码
- ⚠️ 云托管部署必须使用**内网地址**以获得最佳性能

---

## 📦 第二步：安装依赖

```bash
npm install
```

如果安装速度慢，可以使用国内镜像：

```bash
npm install --registry=https://registry.npmmirror.com
```

---

## 🗄️ 第三步：初始化数据库

### 方式一：通过云托管服务器（推荐）

如果您已经部署了云托管服务：

```bash
# SSH 登录到云托管服务器
# 使用内网地址连接
mysql -h 10.32.104.72 -P 3306 -u 数据库账号 -p cooktip < database/init.sql
```

### 方式二：通过云数据库控制台

1. 登录微信云托管控制台
2. 进入「云数据库」→ 您的实例
3. 点击「SQL 窗口」
4. 复制 `database/init.sql` 的内容
5. 粘贴并执行

### 方式三：本地直接连接（使用外网地址）

**前提**：需要在云数据库控制台配置您的公网IP到白名单

```bash
# 使用外网地址连接
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u 数据库账号 -p cooktip < database/init.sql
```

**注意**：如果连接失败，请检查：
1. 云数据库控制台是否已开启外网访问
2. 您的公网IP是否已加入白名单

### 验证数据库初始化

连接数据库后执行：

```sql
USE cooktip;

-- 查看所有表
SHOW TABLES;
-- 应该看到 7 张表

-- 验证分类数据
SELECT COUNT(*) FROM categories;
-- 应该返回 10
```

---

## 📁 第四步：创建上传目录

```bash
# Windows CMD
mkdir uploads

# PowerShell
New-Item -ItemType Directory -Path uploads -Force

# Linux/Mac
mkdir -p uploads
```

---

## 🚀 第五步：启动开发服务

### 本地开发（使用外网地址）

**方式一：使用外网地址（推荐）**

修改 `.env` 文件使用外网地址：

```env
DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
DB_PORT=27821
```

然后启动应用：

```bash
npm run start:dev
```

**注意**：需要在云数据库控制台将您的公网IP加入白名单！

**方式二：使用 SSH 隧道**

如果不想开启外网访问：

```bash
# 终端1：建立 SSH 隧道
ssh -L 3306:10.32.104.72:3306 用户@云托管服务器IP

# 终端2：启动应用（.env 中 DB_HOST=127.0.0.1 DB_PORT=3306）
npm run start:dev
```

### 云托管环境（推荐）

直接在云托管环境开发和测试，可以直接访问内网数据库。

---

## ✅ 第六步：验证服务

启动成功后，您应该看到：

```
🚀 Application is running on: http://localhost:3000
📚 API Documentation: http://localhost:3000/api/docs
```

访问以下地址验证：

- **Swagger API 文档**: http://localhost:3000/api/docs
- **健康检查**: http://localhost:3000/api/v1/health（如果有）

---

## 🧪 测试 API 接口

### 在 Swagger 文档中测试

1. 访问 http://localhost:3000/api/docs
2. 找到「认证模块」→「微信登录」接口
3. 点击「Try it out」
4. 输入测试数据：

```json
{
  "code": "test_code_001",
  "nickname": "测试用户",
  "avatar": "https://example.com/avatar.jpg"
}
```

5. 点击「Execute」

### 使用 Postman/Apifox 测试

```bash
POST http://localhost:3000/api/v1/auth/wechat-login
Content-Type: application/json

{
  "code": "test_code_001",
  "nickname": "测试用户",
  "avatar": "https://example.com/avatar.jpg"
}
```

---

## 🔧 开发建议

### 1. 启用测试模式

由于微信 code2session 接口需要真实环境，建议在开发时添加测试模式。

编辑 `src/modules/auth/auth.service.ts`，在 `code2Session` 方法开头添加：

```typescript
private async code2Session(code: string) {
  // 开发环境测试模式
  if (process.env.NODE_ENV === 'development' && code.startsWith('test_')) {
    return {
      openid: code.replace('test_', 'openid_'),
      session_key: 'test_session_key',
    };
  }
  
  // 正常的微信登录逻辑
  const appid = this.configService.get('WECHAT_APPID');
  // ...
}
```

这样就可以使用 `test_001`、`test_002` 等 code 进行测试。

### 2. 导入测试数据（可选）

```bash
mysql -h 云数据库内网地址 -u 数据库账号 -p cooktip < database/seed.sql
```

测试数据包括：
- 3 个测试用户
- 3 个测试食谱
- 若干评论和收藏

### 3. 常用开发命令

```bash
# 开发环境（热重载）
npm run start:dev

# 生产环境构建
npm run build

# 生产环境运行
npm run start:prod

# 代码格式化
npm run format

# 代码检查
npm run lint

# 运行测试
npm run test
```

---

## 🚀 部署到微信云托管

### 配置云托管环境变量

在微信云托管控制台：

1. 进入「云托管」→「版本管理」
2. 选择您的服务
3. 点击「环境配置」
4. 添加以下环境变量：

```
NODE_ENV=production
PORT=3000
API_PREFIX=api/v1
DB_TYPE=mysql
DB_HOST=10.32.104.72
DB_PORT=3306
DB_USER=您的数据库账号
DB_PASSWORD=您的数据库密码
DB_NAME=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false
JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d
WECHAT_APPID=wx8486e57500ac0a55
WECHAT_SECRET=bd4c652097608bb064350cc7e3b5801c
UPLOAD_DESTINATION=/app/uploads
CDN_BASE_URL=https://您的域名
THROTTLE_TTL=60
THROTTLE_LIMIT=10
```

### 部署方式

**方式一：使用云托管 CLI**

```bash
# 安装 CLI
npm install -g @cloudbase/cli

# 登录
tcb login

# 部署
tcb fn deploy cooktip-api
```

**方式二：通过 Git 自动部署**

1. 在云托管控制台配置 Git 仓库
2. 推送代码到远程仓库
3. 自动触发部署

```bash
git add .
git commit -m "部署到云托管"
git push origin main
```

---

## 🐛 常见问题

### Q1: 数据库连接失败

**错误**：`ER_ACCESS_DENIED_ERROR` 或 `ECONNREFUSED`

**解决方案**：
1. ✅ 确认使用的是内网地址，不是公网地址
2. ✅ 检查数据库账号密码是否正确
3. ✅ 确认云托管服务和数据库在同一个 VPC
4. ✅ 检查数据库安全组配置

### Q2: 本地开发无法连接数据库

**解决方案**：

**方案一：使用外网地址（推荐）**
```env
DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
DB_PORT=27821
```
需要在云数据库控制台配置IP白名单。

**方案二：使用 SSH 隧道**
```bash
ssh -L 3306:10.32.104.72:3306 用户@云托管服务器
```

**方案三：在云托管创建测试环境**

### Q3: 端口 3000 被占用

**解决方案**：

```bash
# Windows
netstat -ano | findstr :3000
taskkill /PID <PID> /F

# 或修改 .env 中的 PORT=3001
```

### Q4: TypeORM 连接池错误

**错误**：`Too many connections`

**解决方案**：
1. 检查是否正确关闭数据库连接
2. 调整连接池配置（在 `app.module.ts`）
3. 升级数据库规格

---

## 📊 性能监控

### 1. 数据库监控

在云数据库控制台查看：
- CPU 使用率
- 内存使用率  
- 连接数
- QPS（每秒查询数）
- 慢查询日志

### 2. 应用监控

```bash
# 查看云托管日志
tcb fn log cooktip-api --lines 100

# 实时日志
tcb fn log cooktip-api --tail
```

### 3. 设置告警

建议配置以下告警：
- 数据库 CPU > 80%
- 数据库内存 > 80%
- 数据库连接数 > 80%
- 应用错误率 > 5%

---

## 📚 相关文档

- [云数据库配置.md](./云数据库配置.md) - 云数据库详细配置指南
- [项目说明.md](./项目说明.md) - 项目完整说明
- [部署指南.md](./部署指南.md) - 部署文档
- [项目总结.md](./项目总结.md) - 项目总结
- [后端API开发文档.md](./后端API开发文档.md) - API 接口详情

---

## 📋 启动检查清单

完成以下检查确保项目正常运行：

- [ ] 已开通微信云托管 MySQL 数据库
- [ ] 已获取数据库内网连接信息
- [ ] 已配置 `.env` 文件
- [ ] 已安装项目依赖 `npm install`
- [ ] 已执行数据库初始化脚本
- [ ] 已创建 uploads 目录
- [ ] 应用成功启动
- [ ] 可以访问 Swagger 文档
- [ ] 已测试微信登录接口
- [ ] （可选）已导入测试数据
- [ ] （可选）已配置云托管环境

---

## 🎯 下一步

1. ✅ 完成本地开发环境搭建
2. ✅ 测试所有 API 接口
3. 📱 对接微信小程序前端
4. 🚀 部署到云托管生产环境
5. 📊 配置监控和告警

---

**祝您开发顺利！** 🍳

如有问题，请查看相关文档或联系技术支持。

