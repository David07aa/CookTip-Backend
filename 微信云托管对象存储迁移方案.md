# 微信云托管对象存储迁移方案

将老乡鸡图片迁移到**微信云托管对象存储**

官方文档：https://cloud.weixin.qq.com/cloudrun/storage

---

## 🎯 什么是云托管对象存储？

微信云托管自带的对象存储服务，特点：

- ✅ 与云托管服务在同一环境
- ✅ 无需单独开通COS
- ✅ 按量计费
- ✅ 通过HTTPS访问
- ✅ 可配置公开/私有访问

---

## 📋 迁移步骤

### 步骤一：开通对象存储

1. **访问微信云托管控制台**
   - 网页：https://console.cloud.tencent.com/tcb
   - 或：微信开发者工具 → 云开发 → 云托管

2. **进入对象存储**
   - 左侧菜单：服务管理 → 对象存储
   - 或直接访问：https://cloud.weixin.qq.com/cloudrun/storage

3. **创建存储桶（Bucket）**
   - 点击"新建存储桶"
   - 存储桶名称：`cooktip-images`（或自定义）
   - 访问权限：**公开读，私有写**
   - 地域：与云托管服务同一地域

---

### 步骤二：上传图片

#### 方式一：通过控制台上传（推荐，最简单）

1. **进入存储桶**
   - 点击刚创建的存储桶名称

2. **创建目录**
   - 点击"新建文件夹"
   - 文件夹名：`laoxiangji`

3. **批量上传**
   - 进入 `laoxiangji` 文件夹
   - 点击"上传文件"
   - 选择本地的192张图片
   - 批量上传

4. **记录访问URL格式**
   上传后，URL格式类似：
   ```
   https://[存储桶名称].storage.[region].myqcloud.com/laoxiangji/大排面.png
   ```

---

#### 方式二：使用云托管API上传（程序化）

在后端服务中添加上传接口：

```typescript
// src/modules/storage/storage.controller.ts
import { Controller, Post, UseInterceptors, UploadedFile } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { CloudRunStorageService } from './cloud-run-storage.service';

@Controller('storage')
export class StorageController {
  constructor(private storageService: CloudRunStorageService) {}

  @Post('upload')
  @UseInterceptors(FileInterceptor('file'))
  async upload(@UploadedFile() file: Express.Multer.File) {
    const url = await this.storageService.upload(
      `laoxiangji/${file.originalname}`,
      file.buffer
    );
    return { url };
  }
}
```

---

#### 方式三：使用命令行工具（批量上传）

如果云托管对象存储支持COS CLI工具：

```bash
# 安装腾讯云COS工具
npm install -g coscmd

# 配置（使用云托管提供的密钥）
coscmd config -a [SecretId] -s [SecretKey] -b [bucket-name] -r [region]

# 批量上传
coscmd upload -r ./uploads/images/laoxiangji/ /laoxiangji/
```

---

### 步骤三：获取图片访问URL

上传完成后，每张图片都有一个HTTPS访问URL：

**URL格式**：
```
https://cooktip-images.storage.sh.myqcloud.com/laoxiangji/大排面.png
```

**参数说明**：
- `cooktip-images`：存储桶名称
- `storage.sh.myqcloud.com`：对象存储域名（根据地域不同）
- `/laoxiangji/大排面.png`：文件路径

---

### 步骤四：配置自定义域名（可选，推荐）

为了URL更简洁和便于管理：

1. **在对象存储控制台**
   - 进入存储桶设置
   - 找到"自定义域名"
   - 添加自定义域名，如：`images.cooktip.com`

2. **配置DNS**
   - 在域名服务商添加CNAME记录
   - 指向存储桶的默认域名

3. **配置HTTPS证书**
   - 云托管会自动申请免费SSL证书

**配置后URL**：
```
https://images.cooktip.com/laoxiangji/大排面.png
```

---

### 步骤五：更新数据库

#### 方案A：批量更新SQL（推荐）

```sql
-- 更新所有老乡鸡图片URL
UPDATE recipes 
SET cover_image = CONCAT(
  'https://cooktip-images.storage.sh.myqcloud.com/laoxiangji/',
  SUBSTRING_INDEX(cover_image, '/', -1)
)
WHERE cover_image LIKE '/images/laoxiangji/%';

-- 验证结果
SELECT id, title, cover_image 
FROM recipes 
WHERE cover_image LIKE 'https://cooktip-images.storage%' 
LIMIT 10;
```

#### 方案B：使用Node.js脚本

```javascript
// update-to-storage.js
const mysql = require('mysql2/promise');

const DB_CONFIG = {
  host: 'mysql3.sqlpub.com',
  port: 3308,
  user: 'david_x',
  password: 'NVRvnX3rP88UyUET',
  database: 'onefoodlibrary'
};

// 对象存储基础URL（替换为您的实际URL）
const STORAGE_BASE_URL = 'https://cooktip-images.storage.sh.myqcloud.com';

async function updateDatabase() {
  const connection = await mysql.createConnection(DB_CONFIG);
  
  console.log('🔄 开始更新数据库...\n');

  // 获取所有需要更新的食谱
  const [recipes] = await connection.execute(
    'SELECT id, title, cover_image FROM recipes WHERE cover_image LIKE "/images/laoxiangji/%"'
  );

  console.log(`找到 ${recipes.length} 条需要更新的记录\n`);

  for (const recipe of recipes) {
    // 提取文件名：/images/laoxiangji/大排面.png → 大排面.png
    const filename = recipe.cover_image.split('/').pop();
    
    // 生成新的URL
    const newUrl = `${STORAGE_BASE_URL}/laoxiangji/${filename}`;
    
    // 更新数据库
    await connection.execute(
      'UPDATE recipes SET cover_image = ? WHERE id = ?',
      [newUrl, recipe.id]
    );
    
    console.log(`✅ ${recipe.id}: ${recipe.title}`);
    console.log(`   ${newUrl}\n`);
  }

  console.log('✅ 数据库更新完成！');
  await connection.end();
}

updateDatabase().catch(console.error);
```

---

### 步骤六：小程序配置域名白名单

**重要**：需要将对象存储的域名添加到小程序白名单

1. **登录微信公众平台** https://mp.weixin.qq.com

2. **进入开发设置**
   - 开发 → 开发管理 → 开发设置

3. **配置服务器域名**

   **downloadFile合法域名**（用于图片下载）：
   ```
   https://cooktip-images.storage.sh.myqcloud.com
   ```
   
   或自定义域名：
   ```
   https://images.cooktip.com
   ```

   **注意**：
   - 如果使用默认域名，填写存储桶域名
   - 如果配置了自定义域名，填写自定义域名

---

### 步骤七：小程序中使用

#### 直接使用（无需修改代码）

```xml
<!-- pages/recipe/detail.wxml -->
<image src="{{recipe.cover_image}}" mode="aspectFill" />
```

**数据格式**：
```javascript
{
  id: 1,
  title: "大排面",
  cover_image: "https://cooktip-images.storage.sh.myqcloud.com/laoxiangji/大排面.png"
}
```

**说明**：
- 对象存储提供标准HTTPS URL
- 小程序像访问普通图片一样使用
- 无需特殊处理

---

## 🔍 验证迁移结果

### 1. 浏览器测试

在浏览器中直接打开图片URL：
```
https://cooktip-images.storage.sh.myqcloud.com/laoxiangji/大排面.png
```

**预期结果**：能看到图片 ✅

---

### 2. 检查数据库

```javascript
// check-storage-urls.js
const mysql = require('mysql2/promise');

async function check() {
  const connection = await mysql.createConnection({
    host: 'mysql3.sqlpub.com',
    port: 3308,
    user: 'david_x',
    password: 'NVRvnX3rP88UyUET',
    database: 'onefoodlibrary'
  });

  // 统计
  const [stats] = await connection.execute(`
    SELECT 
      COUNT(*) as total,
      COUNT(CASE WHEN cover_image LIKE 'https://%.storage.%.myqcloud.com%' THEN 1 END) as storage_images,
      COUNT(CASE WHEN cover_image LIKE '/images/%' THEN 1 END) as old_images
    FROM recipes
  `);

  console.log('📊 统计：');
  console.log(`总食谱数: ${stats[0].total}`);
  console.log(`对象存储图片: ${stats[0].storage_images}`);
  console.log(`旧路径: ${stats[0].old_images}`);

  // 显示示例
  const [samples] = await connection.execute(`
    SELECT id, title, cover_image 
    FROM recipes 
    WHERE cover_image LIKE 'https://%.storage%' 
    LIMIT 5
  `);

  console.log('\n📋 示例URL：');
  samples.forEach(r => {
    console.log(`${r.title}: ${r.cover_image}`);
  });

  await connection.end();
}

check();
```

---

### 3. 小程序测试

1. **配置域名白名单**（必须）
2. **重新编译小程序**
3. **查看食谱列表**
4. **确认图片正常显示**

---

## 💰 费用说明

微信云托管对象存储计费：

### 存储费用
- **价格**：约 ¥0.1/GB/月
- **192张图片约20MB**：约 ¥0.002/月
- **几乎免费**

### 流量费用
- **价格**：约 ¥0.5/GB
- **预估**：小程序用户访问，每月几GB
- **成本**：可控

### 请求费用
- **价格**：约 ¥0.01/万次
- **几乎可以忽略**

---

## 🎁 迁移后的好处

### 问题全部解决！

✅ **ERR_CONNECTION_CLOSED** - 彻底解决（不占用云托管实例内存）  
✅ **服务器内存** - 从 512MB+20MB 降到 512MB  
✅ **服务稳定性** - 大幅提升  
✅ **图片访问速度** - 对象存储有CDN  
✅ **成本** - 比云托管实例扩容更低  

---

## 🔧 后续优化

### 1. 删除后端的uploads目录

迁移完成并验证无误后：

**修改 Dockerfile**：
```dockerfile
# 注释或删除这行
# COPY --from=builder /app/uploads ./uploads
```

**删除 .dockerignore 中的注释**：
```
# 恢复忽略uploads（因为已经迁移到对象存储）
uploads
```

**提交并推送**：
```bash
git add Dockerfile .dockerignore
git commit -m "chore: 移除uploads目录，图片已迁移到对象存储"
git push origin main
```

### 2. 重新部署

- GitHub推送后自动触发云托管部署
- **镜像大小减少 15-20MB**
- **内存占用降低**
- **服务更稳定**

---

## 🆚 对比其他方案

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **云托管对象存储** | ✅ 与云托管集成<br>✅ 配置简单<br>✅ 成本低 | ⚠️ 需配置域名白名单 | ⭐⭐⭐⭐⭐ |
| 云开发云存储 | ✅ 无需域名配置<br>✅ 小程序原生支持 | ⚠️ 需要云开发环境 | ⭐⭐⭐⭐ |
| 腾讯云COS | ✅ 功能强大<br>✅ 稳定性高 | ❌ 配置复杂<br>❌ 需要单独开通 | ⭐⭐⭐ |
| 后端服务器 | ✅ 无需迁移 | ❌ 占用内存<br>❌ 服务不稳定 | ⭐ |

---

## 📝 迁移清单

- [ ] 开通微信云托管对象存储
- [ ] 创建存储桶 `cooktip-images`
- [ ] 设置访问权限：公开读，私有写
- [ ] 创建文件夹 `laoxiangji`
- [ ] 上传192张图片
- [ ] 记录存储桶访问URL
- [ ] 更新数据库中的图片URL
- [ ] 配置小程序域名白名单
- [ ] 小程序测试图片显示
- [ ] 删除后端的 uploads 目录
- [ ] 更新 Dockerfile 和 .dockerignore
- [ ] 重新部署后端
- [ ] 验证服务稳定性提升

---

## ❓ 常见问题

### Q1: 对象存储URL格式是什么？

**A**: 
```
https://[存储桶名].storage.[地域].myqcloud.com/[路径]/[文件名]
```

例如：
```
https://cooktip-images.storage.sh.myqcloud.com/laoxiangji/大排面.png
```

---

### Q2: 需要配置域名白名单吗？

**A**: **需要！** 在小程序公众平台配置：
- downloadFile合法域名：存储桶域名或自定义域名

---

### Q3: 可以配置自定义域名吗？

**A**: 可以！在对象存储控制台配置CNAME，使用更友好的域名。

---

### Q4: 图片可以设置私有访问吗？

**A**: 可以，但需要：
- 存储桶设置为私有
- 后端生成带签名的临时URL
- 小程序使用临时URL访问

**对于公开的食谱图片，建议设置为公开读。**

---

### Q5: 如何批量上传图片？

**A**: 三种方式：
1. **控制台批量上传**（最简单）
2. **使用COS CLI工具**
3. **通过API编程上传**

---

## 🚀 推荐流程

### 今天立即执行：

1. **开通对象存储**（5分钟）
2. **上传图片**（10分钟）
3. **更新数据库**（5分钟）
4. **配置域名白名单**（3分钟）
5. **小程序测试**（2分钟）

**总计：约25分钟完成迁移** ✅

### 测试通过后：

1. 删除后端 uploads 目录
2. 更新 Dockerfile
3. 重新部署

**服务稳定性大幅提升** 🎉

---

**更新时间**: 2025-10-09  
**文档版本**: v1.0

