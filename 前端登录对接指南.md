# 微信小程序登录对接指南

## 📋 文档说明

本文档提供微信小程序登录功能的完整实现代码和配置说明，包含错误处理、Token管理和最佳实践。

---

## 🔧 前置准备

### 1. 配置服务器域名白名单

**必须操作**：在微信小程序后台添加服务器域名

#### 操作路径
```
微信小程序后台 → 开发管理 → 开发设置 → 服务器域名
```

#### 添加域名
在 **request合法域名** 中添加：
```
https://cooktip-backend.vercel.app
```

⚠️ **注意**：
- 必须使用 `https://` 协议
- 不能包含端口号
- 配置后等待 3-5 分钟生效

---

## 🎯 API 接口信息

### 登录接口

- **URL**: `https://cooktip-backend.vercel.app/api/auth/wechat`
- **方法**: `POST`
- **Content-Type**: `application/json`

### 请求参数

```javascript
{
  "code": "string",       // 必需，wx.login() 获取的 code
  "nickName": "string",   // 可选，用户昵称
  "avatar": "string"      // 可选，用户头像 URL
}
```

### 响应格式

#### 成功响应 (200)
```javascript
{
  "code": 200,
  "message": "登录成功", // 或 "注册成功"
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",  // JWT token
    "user": {
      "id": "uuid",
      "nickName": "用户昵称",
      "avatar": "头像URL",
      "isVip": false,
      "isNewUser": false  // true 表示新注册用户
    }
  }
}
```

#### 失败响应 (400/401/500)
```javascript
{
  "code": 400,
  "message": "错误描述",
  "data": null  // 或包含错误详情
}
```

---

## 💻 完整登录代码

### 方式一：完整登录流程（推荐）

```javascript
// pages/login/login.js

Page({
  data: {
    isLoading: false
  },

  /**
   * 用户点击登录按钮
   */
  onLogin() {
    const that = this;
    
    // 防止重复点击
    if (that.data.isLoading) {
      return;
    }
    
    that.setData({ isLoading: true });
    
    // 显示加载提示
    wx.showLoading({
      title: '登录中...',
      mask: true
    });

    // 1. 获取微信登录凭证
    wx.login({
      success: (loginRes) => {
        if (loginRes.code) {
          console.log('获取 code 成功:', loginRes.code);
          
          // 2. 发送 code 到后端服务器
          that.loginToBackend(loginRes.code);
        } else {
          console.error('获取 code 失败:', loginRes.errMsg);
          that.showError('获取登录凭证失败');
          that.setData({ isLoading: false });
        }
      },
      fail: (error) => {
        console.error('wx.login 失败:', error);
        that.showError('微信登录失败');
        that.setData({ isLoading: false });
      }
    });
  },

  /**
   * 发送登录请求到后端
   */
  loginToBackend(code) {
    const that = this;
    
    wx.request({
      url: 'https://cooktip-backend.vercel.app/api/auth/wechat',
      method: 'POST',
      header: {
        'content-type': 'application/json'
      },
      data: {
        code: code,
        // 可选：如果已获取用户信息，可以一起发送
        // nickName: '用户昵称',
        // avatar: '头像URL'
      },
      success: (res) => {
        console.log('登录响应:', res);
        wx.hideLoading();
        
        if (res.statusCode === 200 && res.data.code === 200) {
          // 登录成功
          that.handleLoginSuccess(res.data.data);
        } else if (res.statusCode === 401) {
          // 微信 code 无效
          console.error('微信登录失败:', res.data);
          that.showError(res.data.message || '登录失败，请重试');
        } else if (res.statusCode === 400) {
          // 参数错误
          console.error('参数错误:', res.data);
          that.showError(res.data.message || '登录参数错误');
        } else if (res.statusCode === 500) {
          // 服务器错误
          console.error('服务器错误:', res.data);
          that.showError('服务器错误，请稍后重试');
        } else {
          // 其他错误
          console.error('未知错误:', res);
          that.showError('登录失败，请重试');
        }
        
        that.setData({ isLoading: false });
      },
      fail: (error) => {
        console.error('请求失败:', error);
        wx.hideLoading();
        
        // 判断错误类型
        if (error.errMsg.includes('url not in domain list')) {
          that.showError('请在小程序后台配置服务器域名');
        } else if (error.errMsg.includes('timeout')) {
          that.showError('网络超时，请检查网络连接');
        } else {
          that.showError('网络错误，请重试');
        }
        
        that.setData({ isLoading: false });
      }
    });
  },

  /**
   * 处理登录成功
   */
  handleLoginSuccess(data) {
    console.log('登录成功，用户信息:', data.user);
    
    // 1. 保存 Token 到本地存储
    wx.setStorageSync('token', data.token);
    
    // 2. 保存用户信息到本地存储
    wx.setStorageSync('userInfo', data.user);
    
    // 3. 保存登录状态
    wx.setStorageSync('isLoggedIn', true);
    
    // 4. 显示成功提示
    wx.showToast({
      title: data.user.isNewUser ? '注册成功' : '登录成功',
      icon: 'success',
      duration: 2000
    });
    
    // 5. 跳转到首页（延迟跳转，让用户看到成功提示）
    setTimeout(() => {
      wx.switchTab({
        url: '/pages/index/index'
      });
    }, 1500);
  },

  /**
   * 显示错误提示
   */
  showError(message) {
    wx.showToast({
      title: message,
      icon: 'none',
      duration: 3000
    });
  }
});
```

### 方式二：简化版登录

```javascript
// 适用于快速集成
function quickLogin() {
  wx.showLoading({ title: '登录中...' });
  
  wx.login({
    success: (res) => {
      if (!res.code) {
        wx.showToast({ title: '登录失败', icon: 'none' });
        return;
      }
      
      wx.request({
        url: 'https://cooktip-backend.vercel.app/api/auth/wechat',
        method: 'POST',
        data: { code: res.code },
        success: (response) => {
          wx.hideLoading();
          
          if (response.data.code === 200) {
            // 保存登录信息
            wx.setStorageSync('token', response.data.data.token);
            wx.setStorageSync('userInfo', response.data.data.user);
            
            wx.showToast({ title: '登录成功', icon: 'success' });
            
            // 跳转首页
            setTimeout(() => {
              wx.switchTab({ url: '/pages/index/index' });
            }, 1500);
          } else {
            wx.showToast({ 
              title: response.data.message || '登录失败', 
              icon: 'none' 
            });
          }
        },
        fail: () => {
          wx.hideLoading();
          wx.showToast({ title: '网络错误', icon: 'none' });
        }
      });
    }
  });
}

// 使用
Page({
  onLogin() {
    quickLogin();
  }
});
```

---

## 🔐 Token 使用说明

### 保存 Token

登录成功后，Token 已通过 `wx.setStorageSync('token', token)` 保存到本地。

### 在后续请求中使用 Token

访问需要登录的接口时，在请求头中携带 Token：

```javascript
wx.request({
  url: 'https://cooktip-backend.vercel.app/api/recipes',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  },
  success: (res) => {
    console.log('获取菜谱成功:', res.data);
  }
});
```

### 统一请求封装（推荐）

创建 `utils/request.js`：

```javascript
/**
 * 统一请求封装
 */
const BASE_URL = 'https://cooktip-backend.vercel.app';

function request(options) {
  return new Promise((resolve, reject) => {
    // 获取 Token
    const token = wx.getStorageSync('token');
    
    wx.request({
      url: BASE_URL + options.url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'content-type': 'application/json',
        // 如果有 Token，自动添加到请求头
        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
      },
      success: (res) => {
        // 统一处理响应
        if (res.statusCode === 200) {
          resolve(res.data);
        } else if (res.statusCode === 401) {
          // Token 过期或无效，跳转到登录页
          wx.showToast({
            title: '请先登录',
            icon: 'none'
          });
          wx.redirectTo({
            url: '/pages/login/login'
          });
          reject(res.data);
        } else {
          wx.showToast({
            title: res.data.message || '请求失败',
            icon: 'none'
          });
          reject(res.data);
        }
      },
      fail: (error) => {
        console.error('请求失败:', error);
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        });
        reject(error);
      }
    });
  });
}

module.exports = {
  request
};
```

使用封装后的请求：

```javascript
const { request } = require('../../utils/request.js');

// 获取菜谱列表
request({
  url: '/api/recipes',
  method: 'GET'
}).then(data => {
  console.log('获取成功:', data);
}).catch(error => {
  console.error('获取失败:', error);
});

// 创建评论
request({
  url: '/api/comments',
  method: 'POST',
  data: {
    recipeId: 'xxx',
    content: '好吃！'
  }
}).then(data => {
  console.log('评论成功:', data);
});
```

---

## 🎨 登录页面示例

### WXML (pages/login/login.wxml)

```xml
<view class="login-container">
  <!-- Logo -->
  <view class="logo-section">
    <image class="logo" src="/images/logo.png" mode="aspectFit"></image>
    <text class="app-name">CookTip</text>
    <text class="app-slogan">发现美味，分享生活</text>
  </view>

  <!-- 登录按钮 -->
  <view class="login-section">
    <button 
      class="login-btn" 
      bindtap="onLogin"
      disabled="{{isLoading}}"
    >
      <text wx:if="{{!isLoading}}">微信一键登录</text>
      <text wx:else>登录中...</text>
    </button>
    
    <view class="tips">
      <text>登录即表示同意</text>
      <text class="link">《用户协议》</text>
      <text>和</text>
      <text class="link">《隐私政策》</text>
    </view>
  </view>
</view>
```

### WXSS (pages/login/login.wxss)

```css
.login-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 80rpx 60rpx 100rpx;
}

.logo-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 120rpx;
}

.logo {
  width: 180rpx;
  height: 180rpx;
  border-radius: 40rpx;
  background: white;
  box-shadow: 0 10rpx 40rpx rgba(0, 0, 0, 0.1);
}

.app-name {
  font-size: 56rpx;
  font-weight: bold;
  color: white;
  margin-top: 40rpx;
}

.app-slogan {
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.8);
  margin-top: 20rpx;
}

.login-section {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.login-btn {
  width: 100%;
  height: 96rpx;
  background: white;
  color: #667eea;
  border-radius: 48rpx;
  font-size: 32rpx;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.15);
}

.login-btn[disabled] {
  opacity: 0.6;
}

.tips {
  margin-top: 40rpx;
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.8);
  text-align: center;
}

.tips .link {
  color: white;
  text-decoration: underline;
}
```

---

## 🔍 检查登录状态

### 在 app.js 中检查登录

```javascript
// app.js
App({
  onLaunch() {
    // 检查登录状态
    this.checkLoginStatus();
  },

  /**
   * 检查登录状态
   */
  checkLoginStatus() {
    const token = wx.getStorageSync('token');
    const userInfo = wx.getStorageSync('userInfo');
    
    if (token && userInfo) {
      console.log('已登录，用户信息:', userInfo);
      this.globalData.isLoggedIn = true;
      this.globalData.userInfo = userInfo;
    } else {
      console.log('未登录');
      this.globalData.isLoggedIn = false;
    }
  },

  /**
   * 全局数据
   */
  globalData: {
    isLoggedIn: false,
    userInfo: null
  }
});
```

### 在页面中使用登录状态

```javascript
// pages/profile/profile.js
const app = getApp();

Page({
  onLoad() {
    // 检查登录状态
    if (!app.globalData.isLoggedIn) {
      // 未登录，跳转到登录页
      wx.redirectTo({
        url: '/pages/login/login'
      });
      return;
    }
    
    // 已登录，获取用户信息
    const userInfo = app.globalData.userInfo;
    this.setData({ userInfo });
  }
});
```

---

## ⚠️ 常见错误处理

### 错误码对照表

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 参数错误 | 检查请求参数格式 |
| 401 | 微信登录失败 | code 无效或已使用，重新调用 wx.login() |
| 500 | 服务器错误 | 联系后端检查日志 |
| 40029 | code 无效 | code 已使用或过期（5分钟有效期） |
| 40163 | code 已被使用 | 重新获取 code |

### 常见问题

#### 1. `url not in domain list`

**原因**：未在小程序后台配置服务器域名

**解决**：
1. 登录微信小程序后台
2. 进入：开发管理 → 开发设置 → 服务器域名
3. 添加：`https://cooktip-backend.vercel.app`

#### 2. `request:fail`

**原因**：网络连接问题

**解决**：
1. 检查手机网络连接
2. 尝试切换网络（WiFi/4G）
3. 检查小程序是否有网络权限

#### 3. 登录后立即失效

**原因**：Token 未正确保存

**解决**：
```javascript
// 确保使用同步方法保存
wx.setStorageSync('token', token);

// 或使用异步方法并等待完成
wx.setStorage({
  key: 'token',
  data: token,
  success: () => {
    console.log('Token 保存成功');
  }
});
```

---

## 🧪 测试清单

### 开发阶段测试

- [ ] 在微信开发者工具中测试登录
- [ ] 查看控制台日志，确认 code 获取成功
- [ ] 查看 Network 标签，确认请求发送成功
- [ ] 检查 Storage 标签，确认 Token 和用户信息已保存

### 真机测试

- [ ] 扫码在真实设备上测试
- [ ] 测试首次登录（新用户注册）
- [ ] 测试二次登录（老用户登录）
- [ ] 测试退出后重新登录
- [ ] 测试网络异常情况

### 边界情况测试

- [ ] 快速重复点击登录按钮
- [ ] 网络断开时点击登录
- [ ] 登录过程中切换页面
- [ ] 登录成功后立即访问需要认证的接口

---

## 📚 相关文档

- [微信登录API详细文档](./微信登录API对接文档.md)
- [API接口文档](./前端对接文档.md)
- [环境变量配置](./配置Vercel环境变量.md)

---

## 💡 最佳实践

1. **防止重复登录**
   - 在登录过程中禁用登录按钮
   - 使用 `isLoading` 状态控制

2. **友好的错误提示**
   - 根据不同错误类型显示相应提示
   - 避免向用户展示技术性错误信息

3. **Token 管理**
   - 登录成功后立即保存 Token
   - 在所有需要认证的请求中携带 Token
   - Token 失效时自动跳转登录页

4. **用户体验**
   - 显示加载状态
   - 登录成功后延迟跳转，让用户看到成功提示
   - 保持登录状态，下次打开直接进入

5. **安全性**
   - 不要在代码中硬编码敏感信息
   - 使用 HTTPS 协议
   - 定期检查 Token 有效性

---

## 🆘 需要帮助？

如果遇到问题：

1. **查看控制台日志**
   ```javascript
   console.log('code:', code);
   console.log('响应:', response);
   ```

2. **检查网络请求**
   - 在微信开发者工具的 Network 标签查看请求详情

3. **查看 Vercel 日志**
   - 访问：https://vercel.com/dashboard
   - 进入项目 → Deployments → 查看 Logs

4. **联系后端**
   - 提供完整的错误信息
   - 提供请求时间和大致时间点

---

## 📝 更新日志

- **2025-10-02**: 初始版本，完整登录流程实现
- 后端部署地址：https://cooktip-backend.vercel.app
- 后端最新部署时间：2025-10-02

---

## ✅ 快速开始

1. ✅ 在微信后台配置服务器域名
2. ✅ 复制登录页面代码到项目
3. ✅ 测试登录功能
4. ✅ 集成到现有项目

**祝开发顺利！🎉**

