# 404错误完整排查指南

## 📋 问题描述

前端报错：
```
[渲染层网络层错误] Failed to load image https://example.com/logo.png
the server responded with a status of 404 (HTTP/1.1 404) 
From server 127.0.0.1(env: Windows,mp,1.06.2504030; lib: 3.5.8)
```

---

## 🔍 问题定位

### ✅ 步骤1: 数据库检查（已完成）

**检查结果**:
- ✅ 用户表: 0 条记录包含示例URL
- ✅ 食谱表: 0 条记录包含示例URL
- ✅ 分类表: 0 条记录包含示例URL

**结论**: 数据库数据是干净的，问题不在后端数据。

---

### 🔍 步骤2: 前端代码检查

#### 检查项1: 搜索 `example.com/logo.png`

在前端项目中搜索这个具体的URL：

```bash
cd "E:\前端项目文档\项目文件夹\CookTip"

# 搜索 logo.png
grep -r "logo.png" pages/
grep -r "logo.png" utils/
grep -r "logo.png" components/

# 搜索 example.com
grep -r "example.com" pages/
grep -r "example.com" utils/
```

#### 检查项2: 检查页面初始数据

查看以下文件中的 `data` 对象：

1. **index.js** - 首页数据
```javascript
// pages/index/index.js
data: {
  banners: [],  // 检查是否有示例banner图
  categories: [],  // 检查分类数据
  recommendRecipes: [],  // 检查推荐食谱
  hotRecipes: []  // 检查热门食谱
}
```

2. **recipe-detail.js** - 食谱详情页备用数据
```javascript
// pages/recipe-detail/recipe-detail.js
// 第64-140行有备用数据，检查是否有 example.com URL
```

3. **profile.js** - 个人中心数据
```javascript
// pages/profile/profile.js
data: {
  userInfo: null,  // 检查用户信息
  stats: {}  // 检查统计数据
}
```

#### 检查项3: 检查组件配置

检查以下组件是否使用了硬编码的示例URL：

1. **banner组件** (如果有)
2. **category组件**
3. **recipe-card组件**

---

### 🔍 步骤3: 检查后端API返回

#### 测试API接口

使用Postman或curl测试所有图片相关的API：

```bash
# 1. 测试首页数据
curl http://localhost:3000/api/v1/stats/homepage

# 2. 测试食谱列表
curl http://localhost:3000/api/v1/recipes

# 3. 测试食谱详情
curl http://localhost:3000/api/v1/recipes/1

# 4. 测试分类列表
curl http://localhost:3000/api/v1/categories

# 5. 测试用户信息
curl http://localhost:3000/api/v1/users/me \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**检查要点**:
- 所有返回的JSON中搜索 `example.com`
- 检查图片字段：`cover_image`, `avatar`, `icon`, `image`
- 记录包含 `example.com` 的具体字段和值

---

### 🔍 步骤4: 检查网络请求

#### 在微信开发者工具中调试

1. **打开Network面板**
   - 微信开发者工具 → 调试器 → Network

2. **重新加载页面**
   - 清除缓存
   - 刷新页面

3. **查找404请求**
   - 筛选出状态码为404的请求
   - 记录完整的请求URL
   - 查看请求的来源（Initiator）

4. **查看Console日志**
   - 切换到Console面板
   - 查看是否有图片加载失败的日志
   - 记录错误的完整堆栈信息

#### 定位具体页面

逐个测试以下页面：

- [ ] 登录页 (`pages/login/login`)
- [ ] 首页 (`pages/index/index`)
- [ ] 搜索页 (`pages/search/search`)
- [ ] 食谱详情页 (`pages/recipe-detail/recipe-detail`)
- [ ] 个人中心 (`pages/profile/profile`)
- [ ] 设置页 (`pages/settings/settings`)
- [ ] 发布食谱页 (`pages/submit/submit`)

**记录**:
- 哪个页面出现404错误？
- 是在哪个组件或区域？
- 是否与特定操作相关（如登录、点击等）？

---

### 🔍 步骤5: 检查小程序配置

#### 检查 app.json

```json
// app.json
{
  "pages": [...],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "美食菜谱",
    "navigationBarTextStyle": "black",
    "backgroundImage": ""  // ⚠️ 检查这里
  },
  "tabBar": {
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "/images/tabbar/home.png",  // ⚠️ 检查图标路径
        "selectedIconPath": "/images/tabbar/home-active.png"
      },
      ...
    ]
  }
}
```

#### 检查页面配置

查看每个页面的 `.json` 文件：

```json
// pages/login/login.json
{
  "navigationBarTitleText": "登录",
  "backgroundImage": ""  // ⚠️ 检查这里
}
```

---

### 🔍 步骤6: 检查缓存和本地存储

#### 清除小程序缓存

```javascript
// 在控制台执行
wx.clearStorageSync()
wx.reLaunch({ url: '/pages/index/index' })
```

#### 检查本地存储

```javascript
// 在控制台执行
console.log(wx.getStorageInfoSync())

// 查看所有存储的key
const info = wx.getStorageInfoSync()
info.keys.forEach(key => {
  const data = wx.getStorageSync(key)
  console.log(key, data)
  
  // 检查数据中是否有 example.com
  if (JSON.stringify(data).includes('example.com')) {
    console.warn('发现示例URL:', key, data)
  }
})
```

---

## 🛠️ 常见原因和解决方案

### 原因1: 前端备用数据包含示例URL

**定位**:
```bash
grep -n "example.com" pages/**/*.js
```

**解决**:
将所有 `example.com` URL替换为实际URL或空字符串。

### 原因2: 后端stats接口返回示例banner

**定位**:
检查 `src/modules/stats/stats.service.ts` 中的备用数据：

```typescript
// src/modules/stats/stats.service.ts
banners: [
  {
    id: 1,
    image: 'https://example.com/banner1.jpg',  // ⚠️ 这里
    link: '/recipes/1',
  },
],
```

**解决**:
修改 `stats.service.ts`，替换为实际URL或返回空数组。

### 原因3: 旧数据缓存

**解决**:
```javascript
// 清除所有缓存
wx.clearStorageSync()
wx.removeStorageSync('recipeList')
wx.removeStorageSync('userInfo')
wx.removeStorageSync('categories')
```

### 原因4: recipe-detail备用数据

**定位**:
`pages/recipe-detail/recipe-detail.js` 第64-140行

**解决**:
修改备用数据中的所有图片URL：

```javascript
// pages/recipe-detail/recipe-detail.js
const recipe = {
  id: id,
  title: '番茄炖牛腩',
  cover_image: 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=800',  // ✅ 已使用实际URL
  // ...
}
```

---

## 📝 调试技巧

### 技巧1: 添加全局图片加载监听

在 `app.js` 中添加：

```javascript
// app.js
App({
  onLaunch() {
    // 监听图片加载错误
    wx.onError((error) => {
      console.error('[Global Error]', error)
      
      if (error.includes('example.com')) {
        console.error('⚠️ 发现示例URL加载失败:', error)
      }
    })
  }
})
```

### 技巧2: 重写 wx.request 添加日志

```javascript
// utils/request.js
const originalRequest = wx.request

wx.request = function(options) {
  // 检查URL
  if (options.url && options.url.includes('example.com')) {
    console.error('⚠️ 检测到示例URL请求:', options.url)
  }
  
  return originalRequest.call(this, options)
}
```

### 技巧3: 图片组件添加错误处理

```xml
<!-- 在所有 image 组件添加 binderror -->
<image 
  src="{{imageUrl}}" 
  binderror="onImageError"
  mode="aspectFill"
></image>
```

```javascript
// 页面JS
onImageError(e) {
  console.error('[Image Load Error]', e.detail)
  console.error('Image URL:', e.currentTarget.dataset.src)
  
  if (e.detail.errMsg.includes('example.com')) {
    wx.showToast({
      title: '图片加载失败',
      icon: 'none'
    })
  }
}
```

---

## 🎯 快速排查清单

- [ ] 数据库中无 `example.com` URL
- [ ] 前端代码中无 `example.com` URL
- [ ] 后端API返回无 `example.com` URL
- [ ] 小程序配置文件中无 `example.com` URL
- [ ] 清除缓存后问题仍存在
- [ ] Network面板中找到404请求的来源
- [ ] Console中找到错误的堆栈信息
- [ ] 定位到具体的页面和组件

---

## 📞 进一步帮助

如果以上步骤都无法定位问题，请提供：

1. **完整的错误日志**
   - 包含堆栈信息
   - 请求URL
   - 请求来源（Initiator）

2. **Network截图**
   - 404请求的详情
   - Request Headers
   - Response Headers

3. **复现步骤**
   - 具体操作路径
   - 是否每次都出现
   - 出现频率

4. **环境信息**
   - 微信开发者工具版本
   - 基础库版本
   - 操作系统

---

**创建时间**: 2025年10月29日  
**作者**: CookTip 开发团队

