# 🔍 前端连接后端问题排查

## 📋 当前状态

- ✅ 后端服务已启动
- ✅ 已全量上线
- ❌ 前端请求不到数据

---

## 🚨 立即检查（按顺序）

### 检查 1: 浏览器直接访问 API

**在电脑浏览器（Chrome/Edge）打开**：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
```

#### 结果 A：返回 JSON 数据 ✅
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "name": "中餐",
      ...
    }
  ]
}
```

**说明**：后端正常！问题在小程序配置

**解决方案**：→ 跳到 **检查 2**

---

#### 结果 B：ERR_CONNECTION_CLOSED / 无法访问 ❌

**说明**：服务还没上线成功，或等待时间不够

**解决方案**：
1. 再等待 2-3 分钟
2. 检查云托管流量是否真的是 100%
3. 重启服务试试

---

#### 结果 C：502/503 错误 ❌

**说明**：服务启动失败

**解决方案**：
1. 查看云托管日志，找最新的错误
2. 把错误发给我

---

### 检查 2: 小程序服务器域名白名单 ⚠️ 最可能

**这是小程序最常见的问题！**

#### 步骤 1: 登录微信公众平台
```
https://mp.weixin.qq.com
```

#### 步骤 2: 配置服务器域名
1. 点击左侧菜单 **开发** → **开发管理**
2. 点击 **开发设置**
3. 找到 **服务器域名** 部分

#### 步骤 3: 添加以下域名

**request 合法域名**（必须）：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```

**uploadFile 合法域名**（如果有上传功能）：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```

**downloadFile 合法域名**（必须，用于加载图片）：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
```

#### 步骤 4: 保存
点击 **保存并提交**

#### 步骤 5: 等待生效
⏱️ 通常立即生效，最多等待 5 分钟

---

### 检查 3: 小程序开发工具设置

#### 如果是开发环境（开发者工具）

1. 打开微信开发者工具
2. 点击右上角 **详情**
3. 找到 **本地设置**
4. 勾选 **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**

这样开发时就不受域名限制。

#### 如果是真机预览/体验版

**必须配置服务器域名白名单！** 否则无法访问。

---

### 检查 4: 前端代码检查

#### 检查 API 配置

文件：`config/api.config.js`

确认：
```javascript
const PUBLIC_URL = 'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com'
const baseUrl = isDev ? PUBLIC_URL : PRIVATE_URL
apiBaseUrl: `${baseUrl}/api/v1`
```

✅ 已确认配置正确

#### 检查请求代码

文件：`utils/request.js`

查看是否有：
- 请求超时设置（建议 10000ms）
- 错误处理
- Token 处理

---

### 检查 5: 网络请求日志

#### 在小程序开发工具中查看

1. 打开 **调试器**
2. 点击 **Network** 标签
3. 刷新页面
4. 查看请求列表

**查看请求详情**：
- 请求 URL 是否正确
- 状态码是多少
- 响应内容是什么

---

## 📊 问题诊断流程图

```
浏览器能访问 API？
├─ 是 ✅
│  └─ 小程序能访问？
│     ├─ 否 ❌ → 配置服务器域名白名单
│     └─ 是 ✅ → 检查前端代码
│
└─ 否 ❌
   └─ 后端服务问题
      ├─ 检查流量配置
      ├─ 查看服务日志
      └─ 重启服务
```

---

## 🛠️ 快速修复步骤（最可能的解决方案）

### 方案 1: 配置服务器域名白名单（80% 可能性）

```
1. 登录 mp.weixin.qq.com
2. 开发 → 开发管理 → 开发设置
3. 服务器域名 → request 合法域名
4. 添加：https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
5. 添加 downloadFile：对象存储域名
6. 保存
```

---

### 方案 2: 开发工具不校验域名（开发阶段）

```
1. 微信开发者工具 → 详情
2. 本地设置 → 勾选"不校验合法域名"
3. 重新编译
```

---

### 方案 3: 检查后端是否真的上线

```
1. 浏览器访问：
   https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
   
2. 应该返回 JSON 数据
```

---

## 📝 排查清单

请逐项检查并告诉我结果：

- [ ] **浏览器能访问 API 吗？**
  - URL: https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories
  - 结果：？

- [ ] **小程序服务器域名配置了吗？**
  - request 合法域名：？
  - downloadFile 合法域名：？

- [ ] **开发工具勾选了"不校验域名"吗？**（如果是开发环境）
  - 是/否：？

- [ ] **前端控制台有什么错误？**
  - 错误信息：？

---

## 🆘 告诉我以下信息

1. **浏览器访问 API 的结果**（直接在浏览器打开那个链接）
   - 看到了什么？

2. **小程序控制台的错误信息**
   - 完整的错误提示是什么？

3. **您现在是在哪里测试？**
   - A. 微信开发者工具
   - B. 真机预览
   - C. 体验版
   - D. 正式版

---

**先在浏览器测试 API，然后告诉我结果！** 🚀

