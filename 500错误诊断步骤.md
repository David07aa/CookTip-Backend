# 🔧 500 错误诊断步骤

## 📊 当前状态

**问题**: 食谱列表和搜索功能返回 500 服务器错误

**已采取的行动**:
- ✅ 创建了诊断 API: `/api/test-db`
- ✅ 推送到 GitHub (commit: 934c0a4)
- ⏳ Vercel 正在自动部署 (需要 2-3 分钟)

---

## 🧪 诊断步骤

### 步骤 1: 等待部署完成 (2-3 分钟)

Vercel 正在部署新版本，包含诊断 API。

### 步骤 2: 访问诊断 API (3 分钟后)

在浏览器中访问:

```
https://cooktip-backend.vercel.app/api/test-db
```

这个 API 会返回详细的诊断信息，包括:
- ✅ 数据库连接状态
- ✅ recipes 表结构
- ✅ recipes 总数
- ✅ published 状态的 recipes 数量
- ✅ 实际查询测试
- ✅ 详细的错误信息（如果有）

### 步骤 3: 查看诊断结果

**正常结果示例:**
```json
{
  "code": 200,
  "message": "Diagnostics completed",
  "data": {
    "timestamp": "2025-10-02T...",
    "environment": {
      "hasPostgresUrl": true,
      "hasPostgresPrismaUrl": true,
      "nodeEnv": "production"
    },
    "tests": [
      {
        "name": "数据库连接",
        "status": "success",
        "result": {...}
      },
      {
        "name": "recipes总数",
        "status": "success",
        "result": {"total": 198}
      },
      ...
    ]
  }
}
```

**如果有错误:**
```json
{
  "code": 500,
  "message": "...",
  "data": {
    "tests": [
      {
        "name": "某个测试",
        "status": "error",
        "error": "具体错误信息",
        "stack": "错误堆栈"
      }
    ]
  }
}
```

---

## 🔍 可能的问题和解决方案

### 问题 1: 数据库连接失败

**症状**: `数据库连接` 测试失败

**可能原因**:
- Vercel 环境变量未配置
- Neon 数据库连接断开
- POSTGRES_URL 配置错误

**解决方案**:
1. 检查 Vercel Dashboard -> Settings -> Environment Variables
2. 确认 `POSTGRES_URL` 已配置且正确
3. 确认 `POSTGRES_PRISMA_URL` 已配置（如有）

### 问题 2: recipes 表不存在

**症状**: `recipes表结构` 测试失败

**可能原因**:
- 数据库未初始化
- 表被删除

**解决方案**:
```bash
# 本地运行初始化脚本
node scripts/init-db-postgres.js

# 重新导入数据
node scripts/import-lxj-recipes.js
```

### 问题 3: 数据为空

**症状**: `recipes总数` 返回 0

**可能原因**:
- 数据未导入
- 导入失败

**解决方案**:
```bash
# 重新导入老乡鸡菜谱
node scripts/import-lxj-recipes.js
```

### 问题 4: SQL 查询错误

**症状**: `实际查询测试` 失败

**可能原因**:
- SQL 语法错误
- 字段名不匹配
- JOIN 语句错误

**解决方案**:
- 查看具体的错误信息
- 修复 API 代码中的 SQL 查询

---

## 📝 请反馈以下信息

等待 3 分钟部署完成后，请访问诊断 API 并告诉我:

1. **整体状态**: 返回 200 还是 500?
2. **具体结果**: 复制完整的 JSON 响应
3. **哪些测试失败了**: 查看 `tests` 数组中 `status: "error"` 的项
4. **错误信息**: 如果有错误，复制 `error` 和 `stack` 字段

---

## ⏰ 时间表

```
现在           → 部署中
+ 2 分钟       → 部署完成
+ 3 分钟       → 可以访问诊断 API
```

---

## 🚀 快速测试命令

**浏览器测试**:
```
1. 诊断API: https://cooktip-backend.vercel.app/api/test-db
2. 食谱列表: https://cooktip-backend.vercel.app/api/recipes?page=1&limit=5
3. 搜索功能: https://cooktip-backend.vercel.app/api/search?keyword=鸡
```

**PowerShell 测试** (如果浏览器不方便):
```powershell
# 测试诊断API
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/test-db" | ConvertTo-Json -Depth 10

# 保存到文件方便查看
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/test-db" | ConvertTo-Json -Depth 10 | Out-File diagnosis.json
```

---

## 💡 下一步

根据诊断结果，我会:

1. 如果是数据库连接问题 → 检查环境变量配置
2. 如果是数据为空问题 → 重新导入数据
3. 如果是 SQL 查询问题 → 修复 API 代码
4. 如果是其他问题 → 针对性解决

---

**等待 3 分钟后，请访问诊断 API 并把结果告诉我！** 🙏

**诊断 API 地址**: https://cooktip-backend.vercel.app/api/test-db

