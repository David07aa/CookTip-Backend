# æœç´¢åŠŸèƒ½å¢å¼ºä¿®å¤è¯´æ˜

**ä¿®å¤æ—¶é—´**: 2025-10-30  
**é—®é¢˜ç±»å‹**: 500 Internal Server Error (å¢å¼ºç‰ˆ)  
**Commit**: `e554d37`

---

## ğŸ” é—®é¢˜åˆ†æ

### ç”¨æˆ·æŠ¥å‘Šçš„é”™è¯¯

```
äº‘å‡½æ•°å“åº”: {
  errMsg: "cloud.callFunction:ok", 
  result: {statusCode: 500, ...}
}

[Search] Perform search failed: Error: Internal server error
```

### æ·±å±‚åŸå› 

è™½ç„¶å·²ç»æ·»åŠ äº† `user` ç©ºå€¼æ£€æŸ¥ï¼Œä½†å¯èƒ½è¿˜å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **JSON å­—æ®µå¤„ç†ä¸å½“**
   - `tags` å­—æ®µç±»å‹ä¸º `json`ï¼Œå¯èƒ½è¿”å› `null`ã€`string`ã€æˆ– `array`
   - ç›´æ¥è¿”å›å¯èƒ½å¯¼è‡´åºåˆ—åŒ–é”™è¯¯

2. **å…¶ä»–å­—æ®µç¼ºå°‘é»˜è®¤å€¼**
   - `cover_image`ã€`description` ç­‰å­—æ®µå¯èƒ½ä¸º `null`
   - å‰ç«¯æœŸæœ›å­—ç¬¦ä¸²ä½†æ”¶åˆ° `null` å¯¼è‡´é”™è¯¯

3. **ç¼ºå°‘é”™è¯¯æ—¥å¿—**
   - æ²¡æœ‰ try-catch åŒ…è£¹ï¼Œæ— æ³•å®šä½å…·ä½“é”™è¯¯ä½ç½®

---

## âœ… å¢å¼ºä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ  try-catch é”™è¯¯å¤„ç†

```typescript
async searchRecipes(...) {
  try {
    // ... æœç´¢é€»è¾‘
  } catch (error) {
    console.error('[SearchService] Search recipes error:', error);
    throw error;
  }
}
```

**æ•ˆæœ**:
- âœ… æ•è·å¹¶è®°å½•æ‰€æœ‰é”™è¯¯
- âœ… ä¾¿äºè°ƒè¯•å’Œå®šä½é—®é¢˜

### 2. ä¸ºæ‰€æœ‰å­—æ®µæ·»åŠ é»˜è®¤å€¼

```typescript
items: items.map((recipe) => ({
  id: recipe.id,
  user: recipe.user ? {
    id: recipe.user.id,
    nickname: recipe.user.nickname || 'ç¾é£Ÿè¾¾äºº',  // âœ… é»˜è®¤æ˜µç§°
    avatar: recipe.user.avatar || '',              // âœ… é»˜è®¤å¤´åƒ
  } : null,
  title: recipe.title || '',                       // âœ… é»˜è®¤æ ‡é¢˜
  cover_image: recipe.cover_image || '',           // âœ… é»˜è®¤å°é¢
  description: recipe.description || '',           // âœ… é»˜è®¤æè¿°
  difficulty: recipe.difficulty || 'ä¸­ç­‰',         // âœ… é»˜è®¤éš¾åº¦
  cook_time: recipe.cook_time || 30,               // âœ… é»˜è®¤æ—¶é—´
  tags: Array.isArray(recipe.tags) 
    ? recipe.tags 
    : (recipe.tags ? [recipe.tags] : []),          // âœ… ç»Ÿä¸€ä¸ºæ•°ç»„
  likes: recipe.likes || 0,                        // âœ… é»˜è®¤ç‚¹èµæ•°
  favorites: recipe.favorites || 0,                // âœ… é»˜è®¤æ”¶è—æ•°
  views: recipe.views || 0,                        // âœ… é»˜è®¤æµè§ˆæ•°
  created_at: recipe.created_at,
}))
```

**æ•ˆæœ**:
- âœ… æ‰€æœ‰å­—æ®µéƒ½æœ‰æœ‰æ•ˆå€¼
- âœ… `tags` ç»Ÿä¸€å¤„ç†ä¸ºæ•°ç»„æ ¼å¼
- âœ… é¿å… `null` æˆ– `undefined` å¯¼è‡´çš„é”™è¯¯

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åç«¯éƒ¨ç½²ï¼ˆè‡ªåŠ¨ï¼‰

ä»£ç å·²æ¨é€åˆ° GitHubï¼š
```bash
git commit -m "fix: å¢å¼ºæœç´¢æœåŠ¡çš„å¥å£®æ€§ï¼Œæ·»åŠ æ‰€æœ‰å­—æ®µçš„é»˜è®¤å€¼å’Œç±»å‹æ£€æŸ¥"
git push origin main
```

âœ… **Commit**: `e554d37`

**ç­‰å¾… 3-5 åˆ†é’Ÿ**ï¼Œäº‘æ‰˜ç®¡ä¼šè‡ªåŠ¨éƒ¨ç½²ã€‚

### 2. éªŒè¯éƒ¨ç½²çŠ¶æ€

è®¿é—®äº‘æ‰˜ç®¡æ§åˆ¶å°ï¼Œæ£€æŸ¥ï¼š
- âœ… æ„å»ºçŠ¶æ€ï¼šæˆåŠŸ
- âœ… éƒ¨ç½²çŠ¶æ€ï¼šè¿è¡Œä¸­
- âœ… æœåŠ¡å¥åº·ï¼šæ­£å¸¸

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: åŸºæœ¬æœç´¢

1. **æ‰“å¼€å°ç¨‹åºæœç´¢é¡µé¢**
2. **è¾“å…¥å…³é”®è¯**: "é¸¡"
3. **è§‚å¯Ÿæ§åˆ¶å°**

**é¢„æœŸç»“æœ**:
```
âœ… äº‘å‡½æ•°å“åº”: {statusCode: 200}
âœ… [Search] Search results: [...]
âœ… å›¾ç‰‡æ­£å¸¸åŠ è½½
âœ… æ ‡ç­¾æ­£å¸¸æ˜¾ç¤ºï¼ˆæ•°ç»„æ ¼å¼ï¼‰
```

**å¦‚æœä»ç„¶ 500**:
```
æŸ¥çœ‹äº‘æ‰˜ç®¡æ—¥å¿—:
1. æ‰“å¼€è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥"äº‘æ‰˜ç®¡" â†’ "æ—¥å¿—æŸ¥è¯¢"
3. æœç´¢ "[SearchService] Search recipes error"
4. æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯
```

### æµ‹è¯• 2: ç©ºæ•°æ®å¤„ç†

1. **æœç´¢ä¸å­˜åœ¨çš„å…³é”®è¯**: "xyzabc123"
2. **éªŒè¯**:
   - âœ… è¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯é”™è¯¯
   - âœ… æ˜¾ç¤º"æš‚æ— æœç´¢ç»“æœ"

### æµ‹è¯• 3: ç‰¹æ®Šå­—ç¬¦æœç´¢

1. **æœç´¢åŒ…å«ç‰¹æ®Šå­—ç¬¦**: "éº»å©†è±†è…"
2. **éªŒè¯**:
   - âœ… èƒ½æ­£ç¡®æœç´¢ä¸­æ–‡
   - âœ… ç»“æœå‡†ç¡®

---

## ğŸ› å¦‚æœä»ç„¶æŠ¥é”™

### æ–¹æ¡ˆ A: æ£€æŸ¥æ•°æ®åº“æ•°æ®

ä½¿ç”¨ MCP å·¥å…·è¿æ¥æ•°æ®åº“ï¼ˆå¦‚æœå¤–ç½‘å·²å¼€å¯ï¼‰ï¼š

```javascript
// æŸ¥è¯¢æœ‰é—®é¢˜çš„æ•°æ®
SELECT id, title, user_id, tags, cover_image 
FROM recipes 
WHERE title LIKE '%é¸¡%' 
LIMIT 5;

// æ£€æŸ¥æ˜¯å¦æœ‰ NULL å€¼
SELECT COUNT(*) FROM recipes WHERE user_id IS NULL;
SELECT COUNT(*) FROM recipes WHERE tags IS NOT NULL AND JSON_VALID(tags) = 0;
```

### æ–¹æ¡ˆ B: æŸ¥çœ‹äº‘æ‰˜ç®¡æ—¥å¿—

1. **æ‰“å¼€è…¾è®¯äº‘æ§åˆ¶å°**
2. **è¿›å…¥äº‘æ‰˜ç®¡** â†’ é€‰æ‹©æœåŠ¡
3. **ç‚¹å‡»"æ—¥å¿—æŸ¥è¯¢"**
4. **ç­›é€‰æ¡ä»¶**:
   - æ—¶é—´ï¼šæœ€è¿‘ 1 å°æ—¶
   - æ—¥å¿—çº§åˆ«ï¼šError
   - å…³é”®è¯ï¼š`SearchService`

5. **æŸ¥æ‰¾é”™è¯¯æ ˆ**:
```
[SearchService] Search recipes error: TypeError: ...
  at SearchService.searchRecipes (...)
  at ...
```

### æ–¹æ¡ˆ C: ä¸´æ—¶ç¦ç”¨æœç´¢ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®

å¦‚æœå®åœ¨æ— æ³•ä¿®å¤ï¼Œå¯ä»¥ä¸´æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®ï¼š

```typescript
// åœ¨ search.service.ts ä¸­
async searchRecipes(...) {
  try {
    // ... ç°æœ‰ä»£ç 
  } catch (error) {
    console.error('[SearchService] Search failed, returning mock data:', error);
    
    // è¿”å›æ¨¡æ‹Ÿæ•°æ®
    return {
      items: [],
      total: 0,
      page: 1,
      limit: 10,
      total_pages: 0,
    };
  }
}
```

---

## ğŸ“Š ä¿®å¤å¯¹ç…§è¡¨

| ä¿®å¤é¡¹ | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|--------|--------|--------|------|
| user ç©ºå€¼æ£€æŸ¥ | âŒ æ— æ£€æŸ¥ | âœ… `recipe.user ? {...} : null` | âœ… å·²å®Œæˆ |
| nickname é»˜è®¤å€¼ | âŒ å¯èƒ½ä¸º null | âœ… `|| 'ç¾é£Ÿè¾¾äºº'` | âœ… å·²å®Œæˆ |
| avatar é»˜è®¤å€¼ | âŒ å¯èƒ½ä¸º null | âœ… `|| ''` | âœ… å·²å®Œæˆ |
| tags ç±»å‹å¤„ç† | âŒ å¯èƒ½éæ•°ç»„ | âœ… `Array.isArray()` æ£€æŸ¥ | âœ… å·²å®Œæˆ |
| å…¶ä»–å­—æ®µé»˜è®¤å€¼ | âŒ å¯èƒ½ä¸º null | âœ… å…¨éƒ¨æ·»åŠ é»˜è®¤å€¼ | âœ… å·²å®Œæˆ |
| é”™è¯¯æ—¥å¿— | âŒ æ—  | âœ… try-catch + console.error | âœ… å·²å®Œæˆ |

---

## ğŸ’¡ è°ƒè¯•å»ºè®®

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨ `src/main.ts` ä¸­è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º `debug`:

```typescript
app.useLogger(['error', 'warn', 'log', 'debug']);
```

### 2. æ·»åŠ è¯·æ±‚æ—¥å¿—

åœ¨æœç´¢æ§åˆ¶å™¨ä¸­æ·»åŠ ï¼š

```typescript
@Get('recipes')
async searchRecipes(...) {
  console.log('[SearchController] Received search request:', {
    keyword,
    page,
    limit,
    categoryId,
    difficulty,
    sort
  });
  
  const result = await this.searchService.searchRecipes(...);
  
  console.log('[SearchController] Search result count:', result.items.length);
  
  return result;
}
```

### 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥

```typescript
// åœ¨ search.service.ts ä¸­
async searchRecipes(...) {
  try {
    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    const testQuery = await this.recipeRepository.count();
    console.log('[SearchService] Total recipes in DB:', testQuery);
    
    // ... ç°æœ‰æœç´¢é€»è¾‘
  } catch (error) {
    console.error('[SearchService] Error:', error);
    throw error;
  }
}
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **åç«¯æœç´¢æœåŠ¡**: `src/modules/search/search.service.ts`
- **å‰ç«¯æœç´¢é¡µé¢**: `E:\å‰ç«¯é¡¹ç›®æ–‡æ¡£\é¡¹ç›®æ–‡ä»¶å¤¹\CookTip\pages\search\search.js`
- **Recipe å®ä½“**: `src/entities/recipe.entity.ts`

---

## âœ¨ ä¸‹ä¸€æ­¥

1. â±ï¸ **ç­‰å¾… 3-5 åˆ†é’Ÿ** äº‘æ‰˜ç®¡è‡ªåŠ¨éƒ¨ç½²
2. ğŸ§ª **æµ‹è¯•æœç´¢åŠŸèƒ½**
3. ğŸ“‹ **åé¦ˆæµ‹è¯•ç»“æœ**:
   - âœ… æˆåŠŸï¼šæœç´¢æ­£å¸¸å·¥ä½œ
   - âŒ å¤±è´¥ï¼šæä¾›äº‘æ‰˜ç®¡æ—¥å¿—æˆªå›¾

**å¦‚æœä»ç„¶å¤±è´¥ï¼Œè¯·æä¾›äº‘æ‰˜ç®¡çš„é”™è¯¯æ—¥å¿—ï¼** ğŸ”

