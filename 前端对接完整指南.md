# 🎯 前端对接完整指南

## ✅ 已完成的后端优化

### 1. CORS 配置全面升级 ✅

**更新内容:**
- ✅ 更新 `vercel.json` 添加完整的 CORS 配置
- ✅ 创建统一的 CORS 中间件 `middleware/cors.js`
- ✅ 添加预检请求 (OPTIONS) 处理
- ✅ 支持所有必要的请求头

**关键配置:**
```json
{
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET,OPTIONS,PATCH,DELETE,POST,PUT",
  "Access-Control-Allow-Headers": "X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization"
}
```

### 2. 代码已部署 ✅

- ✅ 推送到 GitHub: `c8f26ee`
- ✅ Vercel 自动部署中 (通常需要 2-3 分钟)
- ✅ 部署完成后 CORS 问题应该解决

---

## 📱 前端配置步骤

### 步骤 1: 配置微信小程序服务器域名

**必须配置，否则线上版本无法使用！**

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入: 开发 -> 开发管理 -> 开发设置 -> 服务器域名
3. 添加以下域名:

```
request合法域名:
https://cooktip-backend.vercel.app
```

**注意事项:**
- 域名必须是 HTTPS
- 不能包含端口号
- 不能是 IP 地址
- 需要等待几分钟生效

### 步骤 2: 开发工具临时配置（仅开发时）

在微信开发者工具中:

1. 打开项目
2. 点击右上角 "详情"
3. 勾选: **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

⚠️ **注意**: 这个设置只在开发时有效，正式发布必须配置服务器域名！

### 步骤 3: 检查前端代码配置

#### 正确的请求方式 ✅

```javascript
// utils/api.js 或 config.js
const BASE_URL = 'https://cooktip-backend.vercel.app'; // ✅ 正确

// 请求示例
wx.request({
  url: `${BASE_URL}/api/categories`,  // ✅ 正确
  method: 'GET',
  success: (res) => {
    console.log(res.data);
  },
  fail: (err) => {
    console.error(err);
  }
});
```

#### 常见错误 ❌

```javascript
// ❌ 错误 1: 使用相对路径
url: '/api/categories'

// ❌ 错误 2: 缺少斜杠
url: `${BASE_URL}api/categories`

// ❌ 错误 3: 多余的斜杠
url: `${BASE_URL}//api/categories`

// ❌ 错误 4: 没有使用 BASE_URL
url: 'api/categories'
```

---

## 🧪 API 测试步骤

### 方法 1: 浏览器直接测试 (推荐，最快)

**等待 5-10 分钟让速率限制重置**，然后在浏览器中访问:

1. **分类列表**:  
   https://cooktip-backend.vercel.app/api/categories

2. **食谱列表**:  
   https://cooktip-backend.vercel.app/api/recipes?page=1&limit=5

3. **搜索功能**:  
   https://cooktip-backend.vercel.app/api/search?keyword=鸡&page=1&pageSize=5

**预期结果:**
```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "list": [...]
  }
}
```

### 方法 2: 使用微信小程序测试代码

1. 在小程序中创建测试页面: `pages/test/test.js`
2. 复制 `微信小程序测试代码.js` 中的代码
3. 运行小程序并点击测试按钮

**测试代码位置:**
```
项目根目录/微信小程序测试代码.js
```

### 方法 3: PowerShell 测试（Windows）

等待 10 分钟后运行:

```powershell
# 测试分类接口
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/categories"

# 测试食谱列表
Invoke-RestMethod -Uri "https://cooktip-backend.vercel.app/api/recipes?page=1&limit=5"
```

---

## 🔍 问题诊断

### 问题 1: `request:fail invalid url "/api/categories"`

**原因**: 使用了相对路径

**解决方案:**
```javascript
// 修改前端代码
const BASE_URL = 'https://cooktip-backend.vercel.app';
url: `${BASE_URL}/api/categories`
```

### 问题 2: `request:fail url not in domain list`

**原因**: 未配置服务器域名白名单

**解决方案:**
1. 开发时: 勾选 "不校验合法域名"
2. 生产时: 在微信公众平台配置域名

### 问题 3: `Failed to fetch` 或 CORS 错误

**原因**: CORS 配置问题

**解决方案:**
- ✅ 已修复！重新部署后应该解决
- 如果还有问题，请提供完整错误信息

### 问题 4: `429 Too Many Requests`

**原因**: 请求过于频繁

**解决方案:**
- 等待 10-15 分钟
- 添加请求防抖/节流
- 减少不必要的请求

### 问题 5: 数据返回为空或不正确

**检查步骤:**
1. 确认 API URL 正确
2. 检查请求参数是否正确
3. 查看微信开发者工具 Network 标签
4. 查看返回的 `code` 和 `message`

---

## 📋 完整的 API 接口列表

### 1. 分类相关

#### 获取分类列表
```
GET /api/categories
```

**响应示例:**
```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "list": [
      {
        "categoryId": "cat_001",
        "name": "炒菜",
        "icon": "https://...",
        "recipeCount": 50
      }
    ]
  }
}
```

### 2. 食谱相关

#### 获取食谱列表
```
GET /api/recipes?page=1&limit=10&category=炒菜&difficulty=简单
```

**查询参数:**
- `page`: 页码 (默认 1)
- `limit`: 每页数量 (默认 10)
- `category`: 分类筛选 (可选)
- `difficulty`: 难度筛选 (可选)
- `sortBy`: 排序字段 (可选: created_at, views, likes, collects)

**响应示例:**
```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "list": [
      {
        "id": "uuid",
        "title": "宫保鸡丁",
        "coverImage": "https://...",
        "introduction": "经典川菜...",
        "difficulty": "中等",
        "cookTime": 30,
        "category": "炒菜",
        "likes": 100,
        "collects": 50,
        "authorName": "大厨张三"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 198,
      "totalPages": 20
    }
  }
}
```

#### 获取食谱详情
```
GET /api/recipes/{id}
```

**响应示例:**
```json
{
  "code": 200,
  "data": {
    "id": "uuid",
    "title": "宫保鸡丁",
    "coverImage": "https://...",
    "introduction": "经典川菜...",
    "difficulty": "中等",
    "cookTime": 30,
    "servings": 2,
    "category": "炒菜",
    "ingredients": [
      {
        "name": "鸡胸肉",
        "amount": "200g"
      }
    ],
    "steps": [
      {
        "order": 1,
        "content": "鸡胸肉切丁...",
        "image": "https://..."
      }
    ],
    "tips": "小贴士内容",
    "nutrition": {
      "calories": "350kcal",
      "protein": "25g"
    },
    "likes": 100,
    "collects": 50,
    "views": 1000,
    "author": {
      "id": "uuid",
      "nickName": "大厨张三",
      "avatar": "https://..."
    }
  }
}
```

### 3. 搜索相关

#### 搜索食谱
```
GET /api/search?keyword=鸡&page=1&pageSize=10&category=炒菜
```

**查询参数:**
- `keyword`: 搜索关键词 (必需)
- `page`: 页码 (默认 1)
- `pageSize`: 每页数量 (默认 10)
- `category`: 分类筛选 (可选)
- `difficulty`: 难度筛选 (可选)

### 4. 用户认证 (需要 JWT Token)

#### 微信登录
```
POST /api/auth/login
Content-Type: application/json

{
  "code": "微信登录code"
}
```

#### 获取用户信息
```
GET /api/user/info
Authorization: Bearer {token}
```

#### 获取收藏列表
```
GET /api/favorites?page=1&limit=10
Authorization: Bearer {token}
```

---

## 📊 数据统计

### 当前数据库内容

- ✅ **食谱总数**: 198 个 (老乡鸡菜谱)
- ✅ **分类**: 多个分类 (炒菜、凉菜、蒸菜、主食等)
- ✅ **数据库**: PostgreSQL (Neon)
- ✅ **部署状态**: 已部署到 Vercel

---

## 🚨 重要提醒

### 开发阶段 (现在)

1. ✅ 勾选 "不校验合法域名"
2. ✅ 等待 10 分钟让速率限制重置
3. ✅ 使用浏览器测试 API 是否正常
4. ✅ 在小程序中测试数据获取

### 发布前必做

1. ⚠️ **必须在微信公众平台配置服务器域名**
2. ⚠️ 取消勾选 "不校验合法域名"
3. ⚠️ 完整测试所有功能
4. ⚠️ 检查所有请求都使用完整 URL

---

## 📞 如果还有问题

### 需要提供的信息

1. **完整的错误信息**
   - 微信开发者工具 Console 截图
   - Network 标签中的请求详情

2. **前端请求代码**
   - 完整的 `wx.request` 调用代码
   - `BASE_URL` 配置

3. **测试结果**
   - 浏览器直接访问 API 是否正常
   - 微信开发者工具 Network 中的响应

4. **配置情况**
   - 是否勾选了 "不校验合法域名"
   - 是否配置了服务器域名白名单

---

## ⏰ 时间线

| 时间 | 操作 | 状态 |
|------|------|------|
| 现在 | 等待 Vercel 部署完成 | ⏳ 进行中 (2-3分钟) |
| +5分钟 | 速率限制重置 | ⏰ 等待中 |
| +10分钟 | 可以开始浏览器测试 | ✅ 可执行 |
| +15分钟 | 可以开始小程序测试 | ✅ 可执行 |

---

## 🎉 下一步

1. ⏰ **等待 10 分钟** (让部署完成 + 速率限制重置)
2. 🌐 **浏览器测试** API 是否正常返回数据
3. 📱 **小程序测试** 使用提供的测试代码
4. ✅ **确认数据正常** 后开始前端开发
5. 🚀 **发布前** 记得配置服务器域名白名单

---

**创建时间**: 2025-10-02  
**更新时间**: 2025-10-02  
**部署版本**: c8f26ee  
**状态**: ✅ CORS 已优化，等待测试

