# 数据库迁移到微信云托管指南

## 🎯 迁移目标

从 SQLPub 迁移到微信云托管自带的 MySQL 数据库

## 📦 迁移架构

**源数据库**：
- 平台：SQLPub
- 地址：mysql3.sqlpub.com:3308
- 数据库：onefoodlibrary

**目标数据库**：
- 平台：微信云托管 MySQL
- 外网地址：sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com:27821
- 内网地址：10.32.104.72:3306
- 数据库：cooktip

## ✅ 迁移优势

1. ✅ **性能提升** - 云托管服务和数据库在同一VPC，内网访问更快
2. ✅ **更稳定** - 避免外部数据库的锁超时问题
3. ✅ **统一管理** - 所有资源都在微信云托管
4. ✅ **成本优化** - 云托管数据库通常有优惠
5. ✅ **更安全** - 内网访问，无需暴露外网端口

---

## 🚀 迁移步骤

### 步骤1：配置目标数据库账号密码

编辑 `migrate-to-cloudbase.js` 文件，填写您的云托管数据库信息：

```javascript
const TARGET_DB = {
  host: 'sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com',
  port: 27821,
  user: '您的数据库账号',      // ⚠️ 填写这里
  password: '您的数据库密码',   // ⚠️ 填写这里
  database: 'cooktip',
  charset: 'utf8mb4'
};
```

### 步骤2：确保目标数据库已创建表结构

在云托管数据库中执行 `database/init.sql` 创建表结构：

```bash
# 方式一：通过云数据库控制台执行
# 1. 登录微信云托管控制台
# 2. 进入云数据库 → SQL 窗口
# 3. 复制 database/init.sql 内容并执行

# 方式二：通过命令行（需要配置IP白名单）
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u 账号 -p cooktip < database/init.sql
```

### 步骤3：执行迁移脚本

```bash
node migrate-to-cloudbase.js
```

**迁移内容**：
- ✅ users (用户表)
- ✅ recipes (食谱表)
- ✅ categories (分类表)
- ✅ comments (评论表)
- ✅ favorites (收藏表)
- ✅ likes (点赞表)
- ✅ shopping_list (购物清单表)

**自动处理**：
- ✅ 批量导入数据
- ✅ 验证记录数量
- ✅ 自动更新图片URL到对象存储

### 步骤4：更新 .env 配置

迁移成功后，更新 `.env` 文件：

```env
# ==========================================
# 数据库配置（微信云托管 MySQL）
# ==========================================
DB_TYPE=mysql

# 生产环境使用内网地址（推荐）
DB_HOST=10.32.104.72
DB_PORT=3306

# 本地开发使用外网地址（需配置IP白名单）
# DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
# DB_PORT=27821

DB_USERNAME=您的数据库账号
DB_PASSWORD=您的数据库密码
DB_DATABASE=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false
```

### 步骤5：重启后端服务

**本地开发**：
```bash
npm run start:dev
```

**生产环境**：
```bash
# 提交代码，触发自动部署
git add .
git commit -m "chore: 迁移数据库到微信云托管"
git push origin main
```

### 步骤6：验证迁移结果

```bash
# 测试 API
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/categories

# 测试食谱接口
curl https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/recipes?limit=5
```

---

## 📊 迁移预期结果

### 数据量统计

| 表名 | 预期记录数 |
|------|-----------|
| users | ~10 |
| categories | 10 |
| recipes | 198 |
| comments | ~50 |
| favorites | ~30 |
| likes | ~100 |
| shopping_list | ~20 |

### 验证检查清单

- [ ] 所有表的记录数量一致
- [ ] 食谱图片URL已更新为对象存储
- [ ] API接口正常返回数据
- [ ] 小程序可以正常显示内容
- [ ] 图片正常加载

---

## ⚙️ 环境配置

### 本地开发环境

使用外网地址 + IP白名单：

```env
DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
DB_PORT=27821
```

**配置IP白名单**：
1. 登录微信云托管控制台
2. 云数据库 → 安全设置
3. 添加您的公网IP

### 生产环境（云托管）

使用内网地址（性能最佳）：

```env
DB_HOST=10.32.104.72
DB_PORT=3306
```

**环境变量配置**：
1. 微信云托管控制台
2. 服务管理 → 环境配置
3. 添加数据库配置

---

## 🔧 故障排查

### Q1: 连接超时

**原因**：IP白名单未配置

**解决**：
1. 进入云数据库控制台
2. 安全设置 → IP白名单
3. 添加您的公网IP

### Q2: 权限不足

**原因**：数据库账号权限不够

**解决**：
1. 确保账号有读写权限
2. 检查账号密码是否正确

### Q3: 表不存在

**原因**：未执行 init.sql

**解决**：
```bash
mysql -h ... -u ... -p cooktip < database/init.sql
```

---

## 💰 成本对比

| 项目 | SQLPub | 微信云托管 | 节省 |
|------|--------|-----------|------|
| 数据库费用 | ¥30/月 | ¥20/月 | ¥10 |
| 网络流量 | 外网 | 内网免费 | ¥5 |
| **总计** | **¥30/月** | **¥20/月** | **¥10/月** |

---

## 📌 迁移后优势

### 性能提升

- ⚡ 内网访问延迟：< 1ms（vs 外网 50-100ms）
- ⚡ 查询速度提升：50-80%
- ⚡ 不再有锁超时问题

### 稳定性提升

- ✅ 同一VPC，网络更稳定
- ✅ 避免外部依赖
- ✅ 更好的容灾能力

### 管理简化

- ✅ 统一在微信云托管管理
- ✅ 统一监控告警
- ✅ 统一备份恢复

---

## 🔄 回滚方案

如果迁移后出现问题，可以快速回滚：

1. **修改 .env 文件**
   ```env
   DB_HOST=mysql3.sqlpub.com
   DB_PORT=3308
   DB_USERNAME=david_x
   DB_DATABASE=onefoodlibrary
   ```

2. **重启服务**
   ```bash
   npm run start:dev
   ```

---

## 📋 迁移检查清单

- [ ] 已配置目标数据库账号密码
- [ ] 已在目标数据库执行 init.sql
- [ ] 已执行迁移脚本
- [ ] 所有表数据验证通过
- [ ] 图片URL已更新为对象存储
- [ ] 已更新 .env 配置
- [ ] 后端服务正常启动
- [ ] API 接口测试通过
- [ ] 小程序测试通过
- [ ] 图片正常显示

---

**迁移时间**：预计 15-20 分钟  
**停机时间**：0（可以先迁移后切换）  
**风险等级**：低（有完整回滚方案）

---

**准备好后，执行迁移吧！** 🚀

