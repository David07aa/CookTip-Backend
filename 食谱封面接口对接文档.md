# 食谱封面接口对接文档

> 📅 更新时间：2025-10-08  
> 🌐 API 基础地址：`https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1`  
> 📚 在线文档：`https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/docs`

---

## 📋 目录

- [1. 功能说明](#1-功能说明)
- [2. 上传封面图片](#2-上传封面图片)
- [3. 创建食谱时设置封面](#3-创建食谱时设置封面)
- [4. 更新食谱封面](#4-更新食谱封面)
- [5. 获取食谱封面](#5-获取食谱封面)
- [6. 完整示例代码](#6-完整示例代码)
- [7. 常见问题](#7-常见问题)

---

## 1. 功能说明

### 1.1 封面字段

每个食谱都有一个独立的 **`cover_image`** 字段用于存储封面图片URL。

**字段说明**：
- **字段名**：`cover_image`
- **类型**：字符串（URL）
- **是否必填**：否（可选，但强烈推荐）
- **最大长度**：255 字符
- **示例值**：`"https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/recipe-cover-123.jpg"`

### 1.2 使用流程

```
步骤1: 用户选择图片
  ↓
步骤2: 上传图片到服务器 (POST /upload/image)
  ↓
步骤3: 获取图片URL
  ↓
步骤4: 创建/更新食谱时传入URL (POST/PUT /recipes)
  ↓
步骤5: 列表/详情接口返回封面URL
```

---

## 2. 上传封面图片

### 2.1 接口信息

| 项目 | 内容 |
|------|------|
| **接口地址** | `POST /upload/image` |
| **完整URL** | `https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/upload/image` |
| **请求方式** | `POST` |
| **Content-Type** | `multipart/form-data` |
| **是否需要认证** | ✅ 是（需要 Token） |

### 2.2 请求参数

| 参数名 | 类型 | 是否必填 | 说明 |
|--------|------|---------|------|
| `file` | File | 是 | 图片文件 |

**请求头**：
```http
Authorization: Bearer {access_token}
Content-Type: multipart/form-data
```

### 2.3 文件限制

| 限制项 | 说明 |
|--------|------|
| **支持格式** | JPG、JPEG、PNG、GIF、WebP |
| **文件大小** | 最大 5MB |
| **建议尺寸** | 宽度 750px - 1200px，高度 500px - 800px |
| **建议比例** | 3:2 或 4:3 |

### 2.4 响应数据

**成功响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "url": "https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/recipe-cover-1234567890.jpg",
    "filename": "recipe-cover-1234567890.jpg",
    "size": 102400,
    "mimetype": "image/jpeg"
  }
}
```

**失败响应**：
```json
{
  "code": 400,
  "message": "文件大小超过限制",
  "error": "文件大小不能超过 5MB"
}
```

### 2.5 小程序示例代码

```javascript
/**
 * 上传食谱封面图片
 */
uploadCoverImage() {
  // 1. 选择图片
  wx.chooseImage({
    count: 1,                      // 只选择1张
    sizeType: ['compressed'],      // 使用压缩图
    sourceType: ['album', 'camera'], // 可从相册或相机选择
    success: (res) => {
      const tempFilePath = res.tempFilePaths[0];
      
      // 2. 上传图片
      this.uploadToServer(tempFilePath);
    },
    fail: (err) => {
      console.error('选择图片失败:', err);
      wx.showToast({
        title: '选择图片失败',
        icon: 'none'
      });
    }
  });
},

/**
 * 上传图片到服务器
 */
uploadToServer(filePath) {
  wx.showLoading({
    title: '上传封面中...',
    mask: true
  });
  
  wx.uploadFile({
    url: 'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/upload/image',
    filePath: filePath,
    name: 'file',  // 必须是 'file'
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('cooktip_token')}`
    },
    success: (res) => {
      wx.hideLoading();
      
      try {
        const data = JSON.parse(res.data);
        
        if (data.code === 200) {
          // 上传成功，保存封面URL
          const coverImageUrl = data.data.url;
          
          this.setData({
            coverImage: coverImageUrl
          });
          
          wx.showToast({
            title: '封面上传成功',
            icon: 'success'
          });
          
          console.log('封面URL:', coverImageUrl);
        } else {
          wx.showToast({
            title: data.message || '上传失败',
            icon: 'none'
          });
        }
      } catch (error) {
        console.error('解析响应失败:', error);
        wx.showToast({
          title: '上传失败',
          icon: 'none'
        });
      }
    },
    fail: (err) => {
      wx.hideLoading();
      console.error('上传失败:', err);
      wx.showToast({
        title: '网络错误，请重试',
        icon: 'none'
      });
    }
  });
}
```

---

## 3. 创建食谱时设置封面

### 3.1 接口信息

| 项目 | 内容 |
|------|------|
| **接口地址** | `POST /recipes` |
| **完整URL** | `https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/recipes` |
| **请求方式** | `POST` |
| **Content-Type** | `application/json` |
| **是否需要认证** | ✅ 是（需要 Token） |

### 3.2 请求参数

```json
{
  "title": "红烧肉",
  "cover_image": "https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/cover-123.jpg",
  "description": "美味的红烧肉，肥而不腻",
  "difficulty": "简单",
  "cook_time": 60,
  "servings": 4,
  "ingredients": [
    { "name": "五花肉", "amount": "500g" },
    { "name": "冰糖", "amount": "30g" }
  ],
  "steps": [
    { "order": 1, "content": "将五花肉切块", "image": null },
    { "order": 2, "content": "焯水去腥", "image": null }
  ],
  "category_id": 1
}
```

**关键字段说明**：

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `title` | string | ✅ 是 | 食谱标题 | "红烧肉" |
| `cover_image` | string | ⭐ 推荐 | 封面图片URL | "https://..." |
| `description` | string | 否 | 食谱简介 | "美味的红烧肉" |
| `difficulty` | string | 否 | 难度（超简单/简单/中等/困难） | "简单" |
| `cook_time` | number | 否 | 烹饪时间（分钟） | 60 |
| `servings` | number | 否 | 份量 | 4 |
| `ingredients` | array | 否 | 食材列表 | [...] |
| `steps` | array | 否 | 步骤列表 | [...] |
| `category_id` | number | 否 | 分类ID | 1 |

### 3.3 响应数据

**成功响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "title": "红烧肉",
    "cover_image": "https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/cover-123.jpg",
    "description": "美味的红烧肉，肥而不腻",
    "difficulty": "简单",
    "cook_time": 60,
    "servings": 4,
    "likeCount": 0,
    "commentCount": 0,
    "viewCount": 0,
    "createdAt": "2025-10-08T12:00:00.000Z"
  }
}
```

### 3.4 小程序示例代码

```javascript
const request = require('../../utils/request');

/**
 * 发布食谱（包含封面）
 */
async publishRecipe() {
  // 1. 验证封面是否已上传
  if (!this.data.coverImage) {
    wx.showToast({
      title: '请先上传封面图片',
      icon: 'none'
    });
    return;
  }
  
  // 2. 验证标题
  if (!this.data.title || !this.data.title.trim()) {
    wx.showToast({
      title: '请输入食谱标题',
      icon: 'none'
    });
    return;
  }
  
  wx.showLoading({
    title: '发布中...',
    mask: true
  });
  
  try {
    // 3. 发送请求
    const recipe = await request({
      url: '/recipes',
      method: 'POST',
      data: {
        title: this.data.title,
        cover_image: this.data.coverImage,  // ← 传入封面URL
        description: this.data.description,
        difficulty: this.data.difficulty,
        cook_time: this.data.cookTime,
        servings: this.data.servings,
        ingredients: this.data.ingredients,
        steps: this.data.steps,
        category_id: this.data.categoryId
      }
    });
    
    wx.hideLoading();
    
    wx.showToast({
      title: '发布成功',
      icon: 'success',
      duration: 2000
    });
    
    // 4. 跳转到详情页
    setTimeout(() => {
      wx.redirectTo({
        url: `/pages/recipe-detail/recipe-detail?id=${recipe.id}`
      });
    }, 2000);
    
  } catch (error) {
    wx.hideLoading();
    console.error('发布食谱失败:', error);
    
    wx.showModal({
      title: '发布失败',
      content: error.message || '网络错误，请重试',
      showCancel: false
    });
  }
}
```

---

## 4. 更新食谱封面

### 4.1 接口信息

| 项目 | 内容 |
|------|------|
| **接口地址** | `PUT /recipes/:id` |
| **完整URL** | `https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/recipes/{id}` |
| **请求方式** | `PUT` |
| **Content-Type** | `application/json` |
| **是否需要认证** | ✅ 是（需要 Token，且必须是作者本人） |

### 4.2 请求参数

```json
{
  "cover_image": "https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/new-cover.jpg"
}
```

**说明**：只需要传入要更新的字段，其他字段保持不变。

### 4.3 小程序示例代码

```javascript
/**
 * 更新食谱封面
 */
async updateCover(recipeId) {
  // 1. 上传新封面
  wx.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: async (res) => {
      const tempFilePath = res.tempFilePaths[0];
      
      wx.showLoading({ title: '上传中...' });
      
      // 2. 上传图片
      wx.uploadFile({
        url: 'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/upload/image',
        filePath: tempFilePath,
        name: 'file',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('cooktip_token')}`
        },
        success: async (uploadRes) => {
          const uploadData = JSON.parse(uploadRes.data);
          
          if (uploadData.code === 200) {
            const newCoverUrl = uploadData.data.url;
            
            try {
              // 3. 更新食谱封面
              await request({
                url: `/recipes/${recipeId}`,
                method: 'PUT',
                data: {
                  cover_image: newCoverUrl
                }
              });
              
              wx.hideLoading();
              
              wx.showToast({
                title: '封面更新成功',
                icon: 'success'
              });
              
              // 4. 更新页面显示
              this.setData({
                'recipe.cover_image': newCoverUrl
              });
              
            } catch (error) {
              wx.hideLoading();
              console.error('更新封面失败:', error);
              wx.showToast({
                title: '更新失败',
                icon: 'none'
              });
            }
          }
        }
      });
    }
  });
}
```

---

## 5. 获取食谱封面

### 5.1 获取食谱列表

**接口地址**：`GET /recipes`

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "title": "红烧肉",
        "cover_image": "https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/cover-123.jpg",
        "description": "美味的红烧肉",
        "likeCount": 100,
        "viewCount": 500
      },
      {
        "id": 2,
        "title": "糖醋排骨",
        "cover_image": "https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/cover-456.jpg",
        "description": "酸甜可口的排骨",
        "likeCount": 80,
        "viewCount": 300
      }
    ],
    "total": 50,
    "page": 1,
    "limit": 10
  }
}
```

### 5.2 获取食谱详情

**接口地址**：`GET /recipes/:id`

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "title": "红烧肉",
    "cover_image": "https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/uploads/cover-123.jpg",
    "description": "美味的红烧肉，肥而不腻",
    "difficulty": "简单",
    "cook_time": 60,
    "servings": 4,
    "ingredients": [...],
    "steps": [...]
  }
}
```

### 5.3 小程序显示封面

**WXML**：
```xml
<!-- 食谱列表 -->
<view class="recipe-list">
  <view 
    class="recipe-item" 
    wx:for="{{recipes}}" 
    wx:key="id"
    bindtap="goToDetail"
    data-id="{{item.id}}"
  >
    <!-- 封面图片 -->
    <image 
      class="recipe-cover" 
      src="{{item.cover_image}}" 
      mode="aspectFill"
      lazy-load="{{true}}"
    />
    
    <view class="recipe-info">
      <text class="recipe-title">{{item.title}}</text>
      <text class="recipe-desc">{{item.description}}</text>
      
      <view class="recipe-stats">
        <text>👍 {{item.likeCount}}</text>
        <text>👁 {{item.viewCount}}</text>
      </view>
    </view>
  </view>
</view>
```

**WXSS**：
```css
.recipe-item {
  display: flex;
  margin-bottom: 20rpx;
  background: #fff;
  border-radius: 16rpx;
  overflow: hidden;
}

.recipe-cover {
  width: 240rpx;
  height: 180rpx;
  flex-shrink: 0;
}

.recipe-info {
  flex: 1;
  padding: 20rpx;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.recipe-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.recipe-desc {
  font-size: 24rpx;
  color: #999;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.recipe-stats {
  display: flex;
  gap: 20rpx;
  font-size: 24rpx;
  color: #666;
}
```

---

## 6. 完整示例代码

### 6.1 发布页面完整代码

```javascript
// pages/publish/publish.js
const request = require('../../utils/request');

Page({
  data: {
    // 表单数据
    coverImage: '',           // 封面URL
    title: '',                // 标题
    description: '',          // 简介
    difficulty: '简单',       // 难度
    cookTime: 30,            // 烹饪时间
    servings: 2,             // 份量
    ingredients: [],         // 食材
    steps: [],               // 步骤
    categoryId: null,        // 分类
    
    // 难度选项
    difficultyOptions: ['超简单', '简单', '中等', '困难']
  },
  
  /**
   * 选择封面
   */
  chooseCover() {
    wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera'],
      success: (res) => {
        this.uploadCover(res.tempFilePaths[0]);
      }
    });
  },
  
  /**
   * 上传封面
   */
  uploadCover(filePath) {
    wx.showLoading({ title: '上传封面中...', mask: true });
    
    wx.uploadFile({
      url: 'https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/v1/upload/image',
      filePath: filePath,
      name: 'file',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('cooktip_token')}`
      },
      success: (res) => {
        wx.hideLoading();
        
        try {
          const data = JSON.parse(res.data);
          
          if (data.code === 200) {
            this.setData({
              coverImage: data.data.url
            });
            
            wx.showToast({
              title: '封面上传成功',
              icon: 'success'
            });
          } else {
            wx.showToast({
              title: data.message || '上传失败',
              icon: 'none'
            });
          }
        } catch (error) {
          console.error('解析失败:', error);
          wx.showToast({
            title: '上传失败',
            icon: 'none'
          });
        }
      },
      fail: (err) => {
        wx.hideLoading();
        console.error('上传失败:', err);
        wx.showToast({
          title: '上传失败，请重试',
          icon: 'none'
        });
      }
    });
  },
  
  /**
   * 表单输入
   */
  onTitleInput(e) {
    this.setData({ title: e.detail.value });
  },
  
  onDescInput(e) {
    this.setData({ description: e.detail.value });
  },
  
  onDifficultyChange(e) {
    this.setData({ 
      difficulty: this.data.difficultyOptions[e.detail.value] 
    });
  },
  
  onCookTimeChange(e) {
    this.setData({ cookTime: parseInt(e.detail.value) });
  },
  
  onServingsChange(e) {
    this.setData({ servings: parseInt(e.detail.value) });
  },
  
  /**
   * 发布食谱
   */
  async publishRecipe() {
    // 验证必填项
    if (!this.data.coverImage) {
      wx.showToast({
        title: '请上传封面图片',
        icon: 'none'
      });
      return;
    }
    
    if (!this.data.title || !this.data.title.trim()) {
      wx.showToast({
        title: '请输入食谱标题',
        icon: 'none'
      });
      return;
    }
    
    wx.showLoading({ title: '发布中...', mask: true });
    
    try {
      const recipe = await request({
        url: '/recipes',
        method: 'POST',
        data: {
          title: this.data.title,
          cover_image: this.data.coverImage,
          description: this.data.description,
          difficulty: this.data.difficulty,
          cook_time: this.data.cookTime,
          servings: this.data.servings,
          ingredients: this.data.ingredients,
          steps: this.data.steps,
          category_id: this.data.categoryId
        }
      });
      
      wx.hideLoading();
      
      wx.showToast({
        title: '发布成功',
        icon: 'success',
        duration: 2000
      });
      
      // 跳转到详情页
      setTimeout(() => {
        wx.redirectTo({
          url: `/pages/recipe-detail/recipe-detail?id=${recipe.id}`
        });
      }, 2000);
      
    } catch (error) {
      wx.hideLoading();
      console.error('发布失败:', error);
      
      wx.showModal({
        title: '发布失败',
        content: error.message || '网络错误，请重试',
        showCancel: false
      });
    }
  }
});
```

### 6.2 发布页面 WXML

```xml
<!-- pages/publish/publish.wxml -->
<view class="container">
  <view class="form">
    <!-- 封面 -->
    <view class="form-item">
      <text class="label">封面图片 *</text>
      <view class="cover-upload" bindtap="chooseCover">
        <image 
          wx:if="{{coverImage}}" 
          class="cover-preview" 
          src="{{coverImage}}" 
          mode="aspectFill"
        />
        <view wx:else class="upload-placeholder">
          <text class="icon">📷</text>
          <text class="text">点击上传封面</text>
        </view>
      </view>
    </view>
    
    <!-- 标题 -->
    <view class="form-item">
      <text class="label">标题 *</text>
      <input 
        class="input" 
        placeholder="请输入食谱标题" 
        value="{{title}}"
        bindinput="onTitleInput"
        maxlength="50"
      />
    </view>
    
    <!-- 简介 -->
    <view class="form-item">
      <text class="label">简介</text>
      <textarea 
        class="textarea" 
        placeholder="请输入食谱简介" 
        value="{{description}}"
        bindinput="onDescInput"
        maxlength="200"
      />
    </view>
    
    <!-- 难度 -->
    <view class="form-item">
      <text class="label">难度</text>
      <picker 
        mode="selector" 
        range="{{difficultyOptions}}"
        bindchange="onDifficultyChange"
      >
        <view class="picker">{{difficulty}}</view>
      </picker>
    </view>
    
    <!-- 烹饪时间 -->
    <view class="form-item">
      <text class="label">烹饪时间（分钟）</text>
      <input 
        class="input" 
        type="number" 
        value="{{cookTime}}"
        bindinput="onCookTimeChange"
      />
    </view>
    
    <!-- 份量 -->
    <view class="form-item">
      <text class="label">份量（人）</text>
      <input 
        class="input" 
        type="number" 
        value="{{servings}}"
        bindinput="onServingsChange"
      />
    </view>
  </view>
  
  <!-- 发布按钮 -->
  <button class="publish-btn" bindtap="publishRecipe">
    发布食谱
  </button>
</view>
```

---

## 7. 常见问题

### Q1: 封面必须上传吗？

**A**: 封面不是必填字段，但强烈建议上传。有封面的食谱在列表中更吸引用户点击。

### Q2: 支持哪些图片格式？

**A**: 支持 JPG、JPEG、PNG、GIF、WebP 格式。

### Q3: 图片大小有限制吗？

**A**: 单个图片最大 5MB。建议上传前进行压缩，小程序选择图片时使用 `sizeType: ['compressed']`。

### Q4: 推荐的封面尺寸是多少？

**A**: 
- **宽度**：750px - 1200px
- **高度**：500px - 800px
- **比例**：3:2 或 4:3
- **格式**：JPG（压缩后文件较小）

### Q5: 上传失败怎么办？

**A**: 常见原因：
1. 文件大小超过 5MB → 压缩图片
2. Token 过期 → 重新登录
3. 网络问题 → 检查网络连接
4. 文件格式不支持 → 使用 JPG/PNG 格式

### Q6: 可以不上传封面，后续再补充吗？

**A**: 可以。创建食谱时不传 `cover_image`，后续通过 `PUT /recipes/:id` 接口更新。

### Q7: 封面可以更换吗？

**A**: 可以。使用 `PUT /recipes/:id` 接口，传入新的 `cover_image` URL。

### Q8: 如何处理图片加载失败？

**A**: 使用小程序 `image` 组件的 `binderror` 事件：

```xml
<image 
  src="{{item.cover_image}}" 
  binderror="onImageError"
  data-id="{{item.id}}"
/>
```

```javascript
onImageError(e) {
  const id = e.currentTarget.dataset.id;
  const index = this.data.recipes.findIndex(r => r.id === id);
  
  if (index !== -1) {
    // 使用默认图片
    this.setData({
      [`recipes[${index}].cover_image`]: '/images/default-cover.png'
    });
  }
}
```

### Q9: 如何优化图片加载性能？

**A**: 
1. 使用 `lazy-load` 属性懒加载
2. 使用 `mode="aspectFill"` 保持比例
3. 列表中使用缩略图
4. 启用 CDN 加速

```xml
<image 
  src="{{item.cover_image}}" 
  mode="aspectFill"
  lazy-load="{{true}}"
  show-menu-by-longpress="{{true}}"
/>
```

### Q10: 微信服务器域名如何配置？

**A**: 在微信公众平台配置以下域名：

**uploadFile 合法域名**：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```

**request 合法域名**：
```
https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```

**配置路径**：
`微信公众平台 → 开发管理 → 开发设置 → 服务器域名`

---

## 📞 技术支持

如有问题，请联系：
- **邮箱**：3509204288@qq.com
- **在线文档**：https://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com/api/docs
- **GitHub**：https://github.com/David07aa/CookTip-Backend

---

**文档版本**：v1.0.0  
**更新时间**：2025-10-08

