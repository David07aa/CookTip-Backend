# 修复 404 错误 - 云函数部署指南

## 🔍 问题诊断

**错误信息**：
```
Cannot POST /auth/wechat-login (404 Not Found)
Cannot POST /auth/login (404 Not Found)
Cannot POST /auth/register (404 Not Found)
```

**根本原因**：
- 前端请求路径：`/auth/login`
- 后端实际路径：`/api/v1/auth/login`
- 云函数没有自动添加 `/api/v1` 前缀

## ✅ 解决方案

已修改 `cloudfunctions/api-proxy/index.js`，让云函数自动添加 `/api/v1` 前缀。

## 📦 部署步骤

### 方法一：使用微信开发者工具（推荐）⭐⭐⭐⭐⭐

1. **打开微信开发者工具**
   - 打开你的小程序项目

2. **找到云函数**
   - 在左侧文件树中找到 `cloudfunctions/api-proxy` 文件夹

3. **右键上传**
   - 右键点击 `api-proxy` 文件夹
   - 选择 **"上传并部署：云端安装依赖"**
   - 等待上传完成（通常需要 10-30 秒）

4. **验证部署**
   - 看到 "上传成功" 提示
   - 在云开发控制台的"云函数"页面可以看到更新时间

### 方法二：使用命令行

1. **进入云函数目录**
   ```bash
   cd cloudfunctions/api-proxy
   ```

2. **部署云函数**
   ```bash
   # 方式1: 使用 tcb CLI
   tcb fn deploy api-proxy
   
   # 方式2: 使用 wx-server-sdk
   npm run deploy
   ```

3. **查看部署状态**
   ```bash
   tcb fn list
   ```

### 方法三：使用云开发控制台

1. **打开云开发控制台**
   - 访问：https://console.cloud.tencent.com/tcb
   - 选择你的环境

2. **上传云函数**
   - 进入 "云函数" 页面
   - 点击 "新建云函数" 或找到 `api-proxy`
   - 选择 "本地上传文件夹"
   - 上传 `cloudfunctions/api-proxy` 整个文件夹

3. **配置并部署**
   - 点击 "确定" 完成部署

## 🧪 测试验证

### 1. 在微信开发者工具控制台测试

```javascript
// 在小程序的调试控制台执行
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'POST',
    path: '/auth/wechat-login',  // 不需要 /api/v1 前缀
    body: {
      code: 'test-code-123',
      nickname: 'TestUser',
      avatar: 'https://example.com/avatar.png'
    }
  }
}).then(res => {
  console.log('测试结果:', res)
}).catch(err => {
  console.error('测试失败:', err)
})
```

**预期结果**：
- ✅ 不再返回 404 错误
- ✅ 返回正常的业务错误（如 "Invalid code"）或成功响应

### 2. 查看云函数日志

1. **微信开发者工具**
   - 云开发控制台 → 云函数 → api-proxy → 日志
   
2. **查看关键日志**
   ```
   ✅ 收到请求: {method: "POST", path: "/auth/wechat-login"}
   ✅ 转发请求到: http://xxx.com/api/v1/auth/wechat-login  ← 注意这里有 /api/v1
   ✅ 后端响应: {status: 200}
   ```

### 3. 完整登录流程测试

#### 测试 1：微信登录
```javascript
// 1. 获取 code
wx.login({
  success: (res) => {
    const code = res.code
    
    // 2. 调用登录接口
    wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'POST',
        path: '/auth/wechat-login',
        body: { code }
      }
    }).then(result => {
      console.log('登录成功:', result)
      // 应该返回 access_token 和 user 信息
    })
  }
})
```

#### 测试 2：账号注册
```javascript
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'POST',
    path: '/auth/register',
    body: {
      username: 'testuser123',
      password: 'Test123456',
      email: 'test@example.com'
    }
  }
}).then(result => {
  console.log('注册结果:', result)
})
```

#### 测试 3：账号登录
```javascript
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'POST',
    path: '/auth/login',
    body: {
      account: 'testuser123',
      password: 'Test123456'
    }
  }
}).then(result => {
  console.log('登录结果:', result)
})
```

## 📋 部署检查清单

- [ ] 云函数 `api-proxy` 已重新部署
- [ ] 云函数日志显示 `/api/v1` 前缀被正确添加
- [ ] 微信登录不再返回 404
- [ ] 账号登录不再返回 404
- [ ] 注册功能不再返回 404
- [ ] 其他 API（如获取食谱）仍然正常工作

## ⚠️ 注意事项

1. **环境一致性**
   - 确保部署到正确的云开发环境
   - 生产环境和开发环境可能需要分别部署

2. **缓存问题**
   - 部署后可能需要等待 1-2 分钟
   - 如果还有问题，尝试：
     - 重启微信开发者工具
     - 清除小程序缓存（开发者工具 → 清缓存）
     - 重新编译项目

3. **版本控制**
   - 确保本地代码是最新的
   - 提交前检查 `cloudfunctions/api-proxy/index.js` 的修改

4. **监控日志**
   - 部署后密切关注云函数日志
   - 检查是否有其他错误

## 🐛 如果问题仍然存在

### 检查 1：确认云函数代码
查看 `cloudfunctions/api-proxy/index.js` 第 41-45 行：

```javascript
// 自动添加 API 前缀（如果路径不是以 /api/v1 开头）
let apiPath = path
if (!path.startsWith('/api/v1') && !path.startsWith('/health')) {
  apiPath = `/api/v1${path}`
}
```

### 检查 2：确认后端服务状态
```bash
# 测试后端健康状态
curl https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/health
```

预期返回：
```json
{
  "status": "ok",
  "timestamp": "2025-10-17T14:30:00.000Z"
}
```

### 检查 3：查看完整的云函数日志

在云开发控制台 → 云函数 → api-proxy → 日志中查看：
- 请求路径转换前后的值
- 后端返回的状态码
- 任何错误信息

### 检查 4：验证 API 路径

使用 curl 直接测试后端 API：

```bash
# 测试完整路径（应该成功）
curl -X POST https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code":"test"}'

# 测试不带前缀的路径（应该 404）
curl -X POST https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code":"test"}'
```

## 📞 需要帮助？

如果按照以上步骤操作后问题仍未解决，请提供：

1. **云函数日志截图**（包含完整的请求路径）
2. **前端控制台错误信息**
3. **云函数部署时间**
4. **使用的云开发环境 ID**

---

## 📝 修改记录

### v1.0 (2025-10-17)
- ✅ 修复云函数路径前缀问题
- ✅ 自动添加 `/api/v1` 前缀
- ✅ 兼容已有的完整路径调用

**修改文件**：
- `cloudfunctions/api-proxy/index.js`

**影响范围**：
- 所有认证相关接口
- 新增的注册/登录功能
- 不影响现有的微信登录（只要重新部署）

---

**部署后记得测试！** 🚀

