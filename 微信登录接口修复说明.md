# 微信登录接口 404 错误修复说明

## 🐛 问题描述

前端请求微信登录接口时返回 404 错误：

```
POST https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wx-login
404 (Not Found)
```

## 🔍 问题原因

**路由名称不匹配**：

- 前端请求的路由：`/api/v1/auth/wx-login`
- 后端实际路由：`/api/v1/auth/wechat-login`

前端使用的是简写 `wx-login`，而后端使用的是完整名称 `wechat-login`。

## ✅ 解决方案

在 `src/modules/auth/auth.controller.ts` 中添加了 `wx-login` 路由别名，兼容前端请求：

```typescript
// 兼容前端的 wx-login 路由
@Public()
@Post('wx-login')
@HttpCode(200)
@ApiOperation({ summary: '微信登录（兼容路由）' })
@ApiResponse({ status: 200, description: '登录成功' })
@ApiResponse({ status: 401, description: '登录失败' })
async wxLogin(@Body() wechatLoginDto: WechatLoginDto) {
  return this.authService.wechatLogin(wechatLoginDto);
}
```

## 📝 支持的登录接口

现在后端同时支持两个登录路由：

### 1️⃣ 完整路由（推荐）
```
POST /api/v1/auth/wechat-login
```

### 2️⃣ 简写路由（兼容前端）
```
POST /api/v1/auth/wx-login
```

**两个路由功能完全相同**，都调用同一个 `wechatLogin` 服务方法。

## 📋 接口详情

### 请求方式
`POST /api/v1/auth/wx-login`

### 请求参数

```json
{
  "code": "微信登录凭证code"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 通过 wx.login() 获取的临时登录凭证 |

### 响应示例

#### 成功响应 (200)

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "openid": "oXXXXXXXXXXXXXXXXXXXX",
      "nickname": "微信用户",
      "avatar": "https://...",
      "phone": null,
      "created_at": "2025-10-09T08:00:00.000Z"
    }
  }
}
```

#### 失败响应 (401)

```json
{
  "code": 401,
  "message": "微信登录失败",
  "error": "Unauthorized"
}
```

## 🧪 测试方法

### 方法 1: 使用 curl 测试

```bash
curl -X POST "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wx-login" \
  -H "Content-Type: application/json" \
  -d '{"code":"测试code"}'
```

### 方法 2: 在小程序中测试

```javascript
// 微信小程序登录
wx.login({
  success: async (res) => {
    if (res.code) {
      try {
        const loginRes = await wx.request({
          url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wx-login',
          method: 'POST',
          data: {
            code: res.code
          }
        });
        
        if (loginRes.data.code === 200) {
          console.log('登录成功:', loginRes.data.data);
          
          // 保存 token
          wx.setStorageSync('token', loginRes.data.data.access_token);
          
          // 保存用户信息
          wx.setStorageSync('userInfo', loginRes.data.data.user);
          
          wx.showToast({
            title: '登录成功',
            icon: 'success'
          });
        } else {
          console.error('登录失败:', loginRes.data);
          wx.showToast({
            title: '登录失败',
            icon: 'none'
          });
        }
      } catch (error) {
        console.error('请求错误:', error);
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        });
      }
    }
  }
});
```

## 🚀 部署步骤

### 1️⃣ 代码已推送 ✅
修复代码已推送到 GitHub `main` 分支。

### 2️⃣ 重新部署云托管（必须执行）

1. 打开 [微信云托管控制台](https://console.cloud.tencent.com/tcb)
2. 找到服务 `yjsp-ytg`
3. 点击「新建版本」
4. 选择从 GitHub 拉取代码（`main` 分支）
5. 等待构建完成（约 2-3 分钟）

### 3️⃣ 验证修复

部署完成后，测试登录接口：

```bash
# 测试 wx-login 路由（前端使用的）
curl -X POST "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wx-login" \
  -H "Content-Type: application/json" \
  -d '{"code":"test"}'

# 测试 wechat-login 路由（原路由）
curl -X POST "https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/auth/wechat-login" \
  -H "Content-Type: application/json" \
  -d '{"code":"test"}'
```

**期望结果**：
- 状态码应该是 `200` 或 `401`（取决于 code 是否有效）
- **不应该是 404**

## ⚠️ 注意事项

### 1. 微信配置

确保在 `.env` 中配置了正确的微信小程序信息：

```env
WX_APPID=wx8486e57500ac0a55
WX_SECRET=bd4c652097608bb064350cc7e3b5801c
```

### 2. Token 使用

登录成功后，将返回的 `access_token` 保存到本地存储，后续请求需要携带 token：

```javascript
// 保存 token
wx.setStorageSync('token', access_token);

// 发起需要认证的请求
wx.request({
  url: 'https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com/api/v1/user/profile',
  method: 'GET',
  header: {
    'Authorization': `Bearer ${wx.getStorageSync('token')}`
  }
});
```

### 3. 测试环境

在开发环境中，微信小程序模拟器可能无法获取真实的 `code`，建议在真机上测试登录功能。

## 🔗 相关接口

### 刷新 Token
```
POST /api/v1/auth/refresh
Authorization: Bearer {token}
```

### 退出登录
```
POST /api/v1/auth/logout
Authorization: Bearer {token}
```

## 📚 相关文档

- `后端API开发文档.md` - 完整的 API 文档
- `部署指南.md` - 云托管部署步骤

## 🎯 常见问题

### Q1: 为什么需要两个登录路由？
**A**: 为了兼容前端代码。前端已经使用 `wx-login`，修改前端需要更多时间，所以后端添加别名支持。

### Q2: 两个路由有什么区别？
**A**: 没有区别，功能完全相同，都调用同一个服务方法。

### Q3: 登录接口返回 401 怎么办？
**A**: 401 是微信登录失败，可能的原因：
- 微信 code 已过期（有效期 5 分钟）
- 微信 AppID 或 Secret 配置错误
- 网络问题导致无法访问微信服务器

### Q4: 如何在本地测试登录？
**A**: 
1. 确保 `.env` 配置正确
2. 运行 `npm run start:dev`
3. 使用小程序开发者工具或真机测试
4. 查看后端控制台日志排查问题

---

**修复已完成，请重新部署云托管服务后测试！** 🚀

