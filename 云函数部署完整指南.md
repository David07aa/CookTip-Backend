# 🚀 云函数部署完整指南

**目标**：通过云函数实现 API 网关，让小程序可以访问后端 API  
**时间**：30 分钟  
**难度**：⭐⭐

---

## 📋 准备工作

### 检查清单

- [ ] 已有微信小程序（已注册）
- [ ] 已安装微信开发者工具
- [ ] 后端服务正常运行
- [ ] 了解云托管内网地址

### 需要的信息

| 项目 | 信息 |
|------|------|
| 云托管内网地址 | `rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com` |
| 云托管公网地址 | `https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com` |
| 对象存储域名 | `https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com` |

---

## 🎯 部署步骤

### 第 1 步：开通云开发环境（5 分钟）

#### 1.1 打开微信开发者工具

1. 打开您的小程序项目
2. 如果没有项目，先创建一个新项目

#### 1.2 开通云开发

1. 点击工具栏的 **云开发** 按钮
2. 首次使用会提示开通
3. 点击 **开通** 按钮
4. 选择套餐：
   - **免费版**（推荐）：10 万次调用/月，足够测试使用
   - 或根据需求选择付费版
5. 环境名称：输入 `cooktip-prod`（或其他名称）
6. 点击 **确定**，等待创建（约 2-3 分钟）

#### 1.3 记录环境 ID

创建完成后，会显示环境 ID，类似：
```
cooktip-prod-7g6xhb9y7a0f8
```

**重要**：复制这个环境 ID，后面要用！

---

### 第 2 步：部署云函数（10 分钟）

#### 2.1 准备云函数代码

1. 在小程序项目根目录创建 `cloudfunctions` 文件夹
2. 将本项目的 `cloudfunctions/api-proxy` 整个文件夹复制到小程序项目的 `cloudfunctions` 目录下

**目录结构**：
```
your-miniprogram/
├── cloudfunctions/
│   └── api-proxy/
│       ├── index.js         # 云函数主文件
│       ├── package.json     # 依赖配置
│       ├── config.json      # 云函数配置
│       └── README.md        # 说明文档
├── miniprogram/
│   ├── app.js
│   └── ...
└── project.config.json
```

#### 2.2 配置云函数根目录

1. 在微信开发者工具中
2. 右键点击项目根目录
3. 选择 **项目配置** → **云函数根目录**
4. 选择 `cloudfunctions` 文件夹

或者在 `project.config.json` 中添加：

```json
{
  "cloudfunctionRoot": "cloudfunctions/",
  "miniprogramRoot": "miniprogram/"
}
```

#### 2.3 上传并部署云函数

1. 在微信开发者工具中展开 `cloudfunctions` 文件夹
2. 右键点击 `api-proxy` 文件夹
3. 选择 **上传并部署：云端安装依赖**
4. 等待部署完成（约 1-2 分钟）

**提示**：
- 如果看不到云函数文件夹，点击工具栏的 **刷新** 按钮
- 首次部署可能较慢，耐心等待

#### 2.4 验证云函数部署

在微信开发者工具控制台运行：

```javascript
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'GET',
    path: '/health'
  },
  success: res => {
    console.log('✅ 云函数部署成功:', res)
  },
  fail: err => {
    console.error('❌ 云函数调用失败:', err)
  }
})
```

**期望结果**：
```javascript
{
  errMsg: "cloud.callFunction:ok",
  result: {
    statusCode: 200,
    data: {
      code: 200,
      message: "success",
      data: {
        status: "healthy",
        service: "cooktip-backend"
      }
    }
  }
}
```

---

### 第 3 步：前端集成（10 分钟）

#### 3.1 初始化云开发

在 `app.js` 中添加：

```javascript
// app.js
App({
  onLaunch: function () {
    // 初始化云开发
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力')
    } else {
      wx.cloud.init({
        env: 'cooktip-prod-7g6xhb9y7a0f8', // ⚠️ 替换为您的环境 ID
        traceUser: true
      })
      console.log('✅ 云开发初始化成功')
    }
  }
})
```

#### 3.2 复制工具类

将以下文件复制到小程序项目：

```
将此文件：  miniprogram-utils/cloudRequest.js
复制到：    miniprogram/utils/cloudRequest.js

将此文件：  miniprogram-utils/api.js
复制到：    miniprogram/utils/api.js
```

#### 3.3 测试 API 调用

在任意页面（如 `pages/index/index.js`）测试：

```javascript
const api = require('../../utils/api')

Page({
  async onLoad() {
    try {
      // 测试获取分类列表
      const res = await api.getCategoryList()
      console.log('✅ API 调用成功:', res)
      
      this.setData({
        categories: res.data
      })
    } catch (error) {
      console.error('❌ API 调用失败:', error)
    }
  }
})
```

---

### 第 4 步：配置域名白名单（5 分钟）

#### 4.1 登录微信公众平台

访问：https://mp.weixin.qq.com

#### 4.2 配置服务器域名

路径：`开发` → `开发管理` → `开发设置` → `服务器域名`

#### 4.3 添加域名

**downloadFile 合法域名**（必须配置）：
```
https://796a-yjsp-wxxcx-2g4wvlv66f316313-1367462091.storage.ap-shanghai.myqcloud.com
https://yjsp-ytg-191595-4-1367462091.sh.run.tcloudbase.com
```

**注意**：
- request 和 uploadFile 域名**不需要**配置（通过云函数访问）
- 只需要配置 downloadFile 域名用于图片下载
- 配置后等待 5-10 分钟生效

---

## ✅ 验证部署

### 测试清单

- [ ] 云开发环境已开通
- [ ] 云函数部署成功
- [ ] 云函数调用成功
- [ ] API 接口调用成功
- [ ] 域名白名单已配置
- [ ] 图片可以正常显示

### 完整测试代码

在控制台运行以下代码进行完整测试：

```javascript
// 测试 1：健康检查
wx.cloud.callFunction({
  name: 'api-proxy',
  data: { method: 'GET', path: '/health' },
  success: res => console.log('✅ 健康检查:', res.result.data)
})

// 测试 2：获取分类
wx.cloud.callFunction({
  name: 'api-proxy',
  data: { method: 'GET', path: '/api/v1/categories' },
  success: res => console.log('✅ 分类列表:', res.result.data)
})

// 测试 3：获取食谱（带参数）
wx.cloud.callFunction({
  name: 'api-proxy',
  data: {
    method: 'GET',
    path: '/api/v1/recipes',
    query: { page: 1, limit: 5 }
  },
  success: res => console.log('✅ 食谱列表:', res.result.data)
})
```

**期望结果**：所有测试都返回 200 状态码和正确的数据

---

## 🔍 故障排查

### 问题 1：云函数部署失败

**错误信息**：`上传失败` 或 `部署失败`

**解决方法**：
1. 检查网络连接
2. 确认云开发环境已创建
3. 检查云函数根目录配置是否正确
4. 重新上传并部署

### 问题 2：云函数调用失败

**错误信息**：`cloud.callFunction:fail`

**解决方法**：
1. 检查 `app.js` 中云开发是否已初始化
2. 确认环境 ID 是否正确
3. 检查云函数是否部署成功
4. 查看云函数日志

### 问题 3：API 返回 504 超时

**错误信息**：`网关超时`

**原因**：
- 后端服务未启动
- 内网地址配置错误
- 网络连接问题

**解决方法**：
1. 检查云托管服务状态
2. 验证内网地址：`rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com`
3. 在云函数 `index.js` 中检查 `API_INTERNAL_URL` 配置

### 问题 4：图片无法显示

**原因**：域名白名单未配置

**解决方法**：
1. 登录微信公众平台
2. 配置 downloadFile 合法域名
3. 等待 5-10 分钟生效
4. 重启小程序

### 问题 5：开发工具正常，真机预览失败

**原因**：
- 云开发环境 ID 不正确
- 域名白名单未生效
- 缓存问题

**解决方法**：
1. 确认环境 ID 正确
2. 等待域名白名单生效
3. 清除小程序缓存
4. 重新预览

---

## 📊 部署检查表

### 云函数部署

- [ ] 云开发环境已开通
- [ ] 环境 ID 已记录
- [ ] 云函数代码已复制
- [ ] 云函数根目录已配置
- [ ] 云函数已上传部署
- [ ] 云函数调用测试通过

### 前端集成

- [ ] app.js 已初始化云开发
- [ ] 环境 ID 已替换
- [ ] 工具类文件已复制
- [ ] API 调用测试通过

### 域名配置

- [ ] downloadFile 域名已配置（对象存储）
- [ ] downloadFile 域名已配置（云托管）
- [ ] 域名白名单已生效
- [ ] 图片可以正常显示

### 功能测试

- [ ] 首页数据加载正常
- [ ] 食谱详情页正常
- [ ] 搜索功能正常
- [ ] 登录功能正常
- [ ] 评论功能正常

---

## 📈 性能监控

### 查看云函数统计

1. 打开云开发控制台
2. 选择 **云函数** → **api-proxy**
3. 查看调用次数、成功率等统计数据

### 查看云函数日志

1. 点击 **日志** 标签
2. 查看实时日志
3. 筛选错误日志
4. 分析性能瓶颈

### 监控指标

| 指标 | 正常范围 | 说明 |
|------|---------|------|
| 调用成功率 | >99% | 云函数调用成功的比例 |
| 平均响应时间 | <500ms | 包含网络和后端处理时间 |
| 错误率 | <1% | 失败请求的比例 |
| 超时率 | <0.1% | 超过 15 秒的请求比例 |

---

## 💰 成本估算

### 免费额度（每月）

| 资源 | 免费额度 | 说明 |
|------|---------|------|
| 云函数调用 | 10 万次 | 通常够用 |
| 云函数执行时长 | 4 万 GBs | 256MB × 20s × ~7800 次 |
| 数据库读 | 5 万次 | 后端数据库操作 |
| 数据库写 | 3 万次 | 后端数据库操作 |
| 对象存储容量 | 5 GB | 图片存储 |
| CDN 流量 | 5 GB | 图片下载流量 |

### 超出费用

| 项目 | 价格 | 说明 |
|------|------|------|
| 云函数调用 | 0.0133 元/万次 | 很便宜 |
| 云函数执行时长 | 0.00011108 元/GBs | 按实际使用计费 |

**结论**：免费额度通常够小程序使用，超出费用也很低廉。

---

## 🎯 下一步

### 已完成 ✅

- [x] 云函数部署
- [x] 前端集成
- [x] 域名配置
- [x] 功能测试

### 可选优化 📋

1. **配置自定义域名**（长期运营）
   - 参考：`自定义域名配置指南.md`
   - 更专业、更稳定

2. **性能优化**
   - 使用缓存减少 API 调用
   - 图片懒加载
   - 分页加载数据

3. **错误监控**
   - 接入第三方监控（如腾讯云监控）
   - 设置告警规则
   - 定期检查日志

4. **安全加固**
   - API 请求签名
   - 频率限制
   - 数据加密

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `cloudfunctions/api-proxy/README.md` | 云函数详细说明 |
| `miniprogram-utils/使用示例.md` | 前端使用示例 |
| `自定义域名配置指南.md` | 自定义域名配置 |
| `临时解决方案-无需自定义域名.md` | 方案说明 |
| `域名配置完整方案.md` | 方案对比 |

---

## 🎉 部署完成！

恭喜！您已成功通过云函数实现 API 网关，现在：

- ✅ 小程序可以正常访问后端 API
- ✅ 无需购买和备案域名
- ✅ 可以进行真机预览和发布
- ✅ 成本低廉，免费额度够用

**享受您的美食菜谱小程序吧！** 🍳

---

**更新时间**：2025-10-16  
**版本**：1.0.0

