# 微信小程序一键登录 - 完整实现文档

## 📚 文档概述

本文档提供了基于**微信原生小程序 + NestJS后端**的完整登录解决方案，参考 [CSDN 教程](https://blog.csdn.net/zmz1196167569/article/details/150635408)，完全适配您的项目架构。

---

## 🎯 实现内容

### ✅ 已完成的工作

| 序号 | 内容 | 状态 |
|------|------|------|
| 1 | 前端登录工具封装 | ✅ 完成 |
| 2 | 前端登录页面示例 | ✅ 完成 |
| 3 | 后端登录 API | ✅ 完成 |
| 4 | 数据库表结构优化 | ✅ 完成 |
| 5 | session_key 存储 | ✅ 完成 |
| 6 | JWT Token 认证 | ✅ 完成 |
| 7 | 完整文档 | ✅ 完成 |

---

## 📁 文件清单

### 前端文件（小程序）

```
miniprogram-utils/
├── wechat-login.js                      # 登录核心逻辑（必需）
├── wechat-login-page-example.js         # 登录页面示例 JS
├── wechat-login-page-example.wxml       # 登录页面示例 WXML
├── wechat-login-page-example.wxss       # 登录页面示例 WXSS
└── 微信原生小程序登录集成指南.md        # 前端集成完整指南
```

### 后端文件

```
src/modules/auth/
├── auth.controller.ts          # 认证控制器（已优化）
├── auth.service.ts             # 认证服务（已优化）
└── dto/wechat-login.dto.ts     # 登录DTO

src/entities/
└── user.entity.ts              # 用户实体（已添加 session_key）

database/migrations/
├── add-session-key-to-users.sql    # SQL 迁移脚本
└── ...

scripts/
├── add-session-key-field.js        # 自动迁移脚本（已执行）
└── ...
```

---

## 🔄 完整登录流程

### 时序图

```
微信小程序                云函数                    NestJS后端                微信服务器
    │                      │                          │                         │
    │ 1. 用户点击登录      │                          │                         │
    │─────────────────────>│                          │                         │
    │                      │                          │                         │
    │ 2. wx.login()        │                          │                         │
    │─────────────────────>│───────────────────────>  │                         │
    │    返回 code         │                          │  3. jscode2session      │
    │<─────────────────────│                          │────────────────────────>│
    │                      │                          │  返回 openid,session_key│
    │ 4. wx.getUserProfile│                          │<────────────────────────│
    │─────────────────────>│                          │                         │
    │  返回 nickName,avatar│                          │                         │
    │<─────────────────────│                          │                         │
    │                      │                          │                         │
    │ 5. 发送登录请求      │                          │                         │
    │    {code,nickName,   │   6. 转发请求            │                         │
    │     avatarUrl}       │                          │                         │
    │─────────────────────>│─────────────────────────>│                         │
    │                      │                          │  7. 查询/创建用户       │
    │                      │                          │  8. 保存 session_key    │
    │                      │                          │  9. 生成 JWT token      │
    │                      │   10. 返回响应           │                         │
    │  11. 保存 token      │  {token, userInfo}       │                         │
    │<─────────────────────│<─────────────────────────│                         │
    │   到本地存储         │                          │                         │
```

### 详细步骤说明

#### 前端流程

1. **用户点击登录按钮**
   ```javascript
   // 必须由用户主动触发
   <button bindtap="handleWechatLogin">微信一键登录</button>
   ```

2. **调用 wx.login() 获取 code**
   ```javascript
   wx.login({
     success: (res) => {
       const code = res.code; // 临时登录凭证，有效期5分钟
     }
   });
   ```

3. **调用 wx.getUserProfile() 获取用户信息**
   ```javascript
   wx.getUserProfile({
     desc: '用于完善用户资料',
     success: (res) => {
       const { nickName, avatarUrl } = res.userInfo;
     }
   });
   ```

4. **发送登录请求到后端**
   ```javascript
   wx.cloud.callFunction({
     name: 'api-proxy',
     data: {
       method: 'POST',
       path: '/api/v1/auth/wx-login',
       body: { code, nickName, avatarUrl }
     }
   });
   ```

5. **保存 token 到本地**
   ```javascript
   wx.setStorageSync('access_token', token);
   wx.setStorageSync('user_info', userInfo);
   ```

#### 后端流程

1. **接收登录请求**
   ```typescript
   @Post('wx-login')
   async wxLogin(@Body() wechatLoginDto: WechatLoginDto) {
     return this.authService.wechatLogin(wechatLoginDto);
   }
   ```

2. **调用微信 API 换取 openid**
   ```typescript
   const url = 'https://api.weixin.qq.com/sns/jscode2session';
   const response = await axios.get(url, {
     params: { appid, secret, js_code: code, grant_type: 'authorization_code' }
   });
   const { openid, session_key } = response.data;
   ```

3. **查询或创建用户**
   ```typescript
   let user = await this.userRepository.findOne({ where: { openid } });
   
   if (!user) {
     // 新用户，创建账户
     user = this.userRepository.create({
       openid,
       session_key,
       nickname: userNickname,
       avatar: userAvatar
     });
   } else {
     // 老用户，更新信息
     user.nickname = userNickname;
     user.avatar = userAvatar;
     user.session_key = session_key; // 更新 session_key
   }
   
   await this.userRepository.save(user);
   ```

4. **生成 JWT Token**
   ```typescript
   const payload = {
     sub: user.id,
     openid: user.openid,
     nickname: user.nickname
   };
   
   const access_token = this.jwtService.sign(payload);
   ```

5. **返回响应**
   ```typescript
   return {
     access_token,
     token_type: 'Bearer',
     expires_in: 604800, // 7天
     user: {
       id: user.id,
       openid: user.openid,
       nickname: user.nickname,
       avatar: user.avatar,
       created_at: user.created_at
     }
   };
   ```

---

## 🗄️ 数据库表结构

### users 表

| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | INT | 用户ID，主键 | |
| openid | VARCHAR(100) | 微信OpenID，唯一 | |
| nickname | VARCHAR(50) | 昵称 | |
| avatar | VARCHAR(255) | 头像URL | |
| **session_key** | **VARCHAR(200)** | **微信会话密钥** | **✅ 新增** |
| bio | VARCHAR(200) | 个人简介 | |
| recipe_count | INT | 发布食谱数 | |
| follower_count | INT | 粉丝数 | |
| following_count | INT | 关注数 | |
| favorite_count | INT | 收藏数 | |
| created_at | TIMESTAMP | 创建时间 | |
| updated_at | TIMESTAMP | 更新时间 | |

**✅ session_key 字段已添加**
- 存储微信返回的 session_key
- 用于后续解密敏感数据（如手机号）
- 每次登录自动更新

---

## 📡 API 接口文档

### 1. 微信登录

**端点**: `POST /api/v1/auth/wx-login`

**请求头**:
```
Content-Type: application/json
```

**请求体**:
```json
{
  "code": "081abc123...",
  "nickName": "张三",
  "avatarUrl": "https://..."
}
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 604800,
    "user": {
      "id": 1,
      "openid": "oXXXX...",
      "nickname": "张三",
      "avatar": "https://...",
      "created_at": "2024-10-16T12:00:00.000Z"
    }
  },
  "timestamp": "2024-10-16T12:00:00.000Z"
}
```

**错误响应** (401):
```json
{
  "code": 401,
  "message": "微信登录失败: invalid code (错误码: 40029)",
  "error": "Unauthorized",
  "timestamp": "2024-10-16T12:00:00.000Z"
}
```

---

### 2. 刷新 Token

**端点**: `POST /api/v1/auth/refresh`

**请求头**:
```
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 604800
  }
}
```

---

### 3. 退出登录

**端点**: `POST /api/v1/auth/logout`

**请求头**:
```
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "退出成功",
  "data": {
    "message": "退出成功"
  }
}
```

---

## 🚀 快速集成指南

### 前端集成（3步）

#### 步骤1：复制工具文件

```bash
# 将 wechat-login.js 复制到小程序项目
cp miniprogram-utils/wechat-login.js your-miniprogram/utils/
```

#### 步骤2：在登录页面引入

```javascript
// pages/login/login.js
const wechatAuth = require('../../utils/wechat-login.js');

Page({
  handleWechatLogin() {
    wechatAuth.wechatLogin()
      .then(result => {
        console.log('登录成功:', result);
        wx.switchTab({ url: '/pages/index/index' });
      })
      .catch(error => {
        console.error('登录失败:', error);
        wx.showToast({ title: error.message, icon: 'none' });
      });
  }
});
```

#### 步骤3：添加登录按钮

```xml
<!-- pages/login/login.wxml -->
<button bindtap="handleWechatLogin">微信一键登录</button>
```

### 后端集成（已完成）

✅ 后端代码已全部完成，无需额外配置！

---

## 🔐 环境变量配置

确保云托管环境变量中已配置微信AppID和Secret：

```json
// cloudbase-env-vars.json
{
  "WX_APPID": "wx1234567890abcdef",  // 小程序 AppID
  "WX_SECRET": "your_secret_key_here" // 小程序 Secret
}
```

**获取方式**：
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置
3. 复制 AppID 和 AppSecret

---

## 🧪 测试清单

### 前端测试

- [ ] 能够成功调用 `wx.login()` 获取 code
- [ ] 能够成功调用 `wx.getUserProfile()` 获取用户信息
- [ ] 能够成功发送登录请求到后端
- [ ] 能够正确保存 token 到本地存储
- [ ] 能够正确读取本地用户信息
- [ ] 能够正确处理用户拒绝授权的情况
- [ ] 退出登录功能正常

### 后端测试

- [ ] 能够成功接收前端登录请求
- [ ] 能够成功调用微信 API 获取 openid
- [ ] 能够正确创建新用户
- [ ] 能够正确更新老用户信息
- [ ] 能够正确保存 session_key
- [ ] 能够成功生成 JWT token
- [ ] Token 验证功能正常

---

## 📝 使用示例

### 示例1：登录页面

参考文件：
- `miniprogram-utils/wechat-login-page-example.js`
- `miniprogram-utils/wechat-login-page-example.wxml`
- `miniprogram-utils/wechat-login-page-example.wxss`

### 示例2：检查登录状态

```javascript
// 在需要登录的页面
const wechatAuth = require('../../utils/wechat-login.js');

Page({
  onLoad() {
    // 检查是否已登录
    if (!wechatAuth.checkLoginStatus()) {
      // 未登录，跳转到登录页
      wx.navigateTo({ url: '/pages/login/login' });
      return;
    }
    
    // 已登录，加载页面数据
    this.loadPageData();
  },
  
  loadPageData() {
    const token = wechatAuth.getLocalToken();
    const userInfo = wechatAuth.getLocalUserInfo();
    
    console.log('当前用户:', userInfo.nickname);
    
    // 使用 token 请求后端API
    // ...
  }
});
```

### 示例3：带 Token 的 API 请求

```javascript
const wechatAuth = require('../../utils/wechat-login.js');

// 获取用户信息
function getUserProfile() {
  const token = wechatAuth.getLocalToken();
  
  return new Promise((resolve, reject) => {
    wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'GET',
        path: '/api/v1/user/profile',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      },
      success: (res) => {
        if (res.result.statusCode === 200) {
          resolve(res.result.data.data);
        } else if (res.result.statusCode === 401) {
          // Token 过期，跳转到登录页
          wx.reLaunch({ url: '/pages/login/login' });
          reject(new Error('登录已过期'));
        } else {
          reject(new Error('请求失败'));
        }
      },
      fail: reject
    });
  });
}
```

---

## ⚠️ 注意事项

### 1. wx.getUserProfile 必须由用户主动触发

```javascript
// ✅ 正确：绑定到按钮点击
<button bindtap="handleLogin">登录</button>

// ❌ 错误：在 onLoad 中自动调用
onLoad() {
  wechatAuth.wechatLogin(); // 会失败！
}
```

### 2. code 只能使用一次

每次调用 `wx.login()` 获取的 code 只能使用一次，请确保：
- 获取 code 后立即发送到后端
- 不要重复使用同一个 code
- code 有效期为 5 分钟

### 3. session_key 的作用

`session_key` 用于解密以下敏感数据：
- 手机号（通过 `getPhoneNumber`）
- 运动步数（通过 `getWeRunData`）
- 群ID（通过 `getShareInfo`）

### 4. Token 过期处理

Token 有效期为 7 天，建议：
- 在 API 请求失败时检查 401 错误
- 自动调用 `refreshToken()` 刷新token
- 如果刷新失败，跳转到登录页重新登录

---

## 🐛 常见问题

### Q1: 登录报错 "invalid code"

**原因**：
- code 已被使用
- code 已过期（超过5分钟）
- AppID 或 Secret 配置错误

**解决**：
1. 确保每次登录重新获取 code
2. 获取 code 后立即发送到后端
3. 检查云托管环境变量配置

---

### Q2: wx.getUserProfile 报错 "fail auth deny"

**原因**：
- 没有在用户主动操作中调用
- 小程序基础库版本过低

**解决**：
1. 确保在按钮点击事件中调用
2. 检查基础库版本 ≥ 2.10.4

---

### Q3: 登录成功但没有返回用户信息

**原因**：后端环境变量配置错误

**解决**：
1. 检查 `cloudbase-env-vars.json`
2. 确认 `WX_APPID` 和 `WX_SECRET` 正确
3. 重启云托管服务

---

## 📊 数据库迁移记录

✅ **2024-10-16**: 添加 `session_key` 字段到 `users` 表
- 字段类型: VARCHAR(200)
- 可为空: YES
- 用途: 存储微信 session_key
- 影响用户数: 3
- 迁移状态: 成功

---

## 📖 参考资料

- [微信小程序登录官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [wx.getUserProfile API](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)
- [NestJS 官方文档](https://nestjs.com/)
- [参考教程 - CSDN](https://blog.csdn.net/zmz1196167569/article/details/150635408)

---

## ✅ 总结

### 已实现的功能

✅ **前端**
- 微信一键登录封装
- 登录状态管理
- Token 自动保存
- 退出登录功能
- 完整的页面示例

✅ **后端**
- 微信 code 换取 openid
- 用户自动注册/登录
- session_key 存储
- JWT Token 生成
- Token 验证和刷新

✅ **数据库**
- users 表优化
- session_key 字段添加
- 自动迁移脚本

✅ **文档**
- 前端集成指南
- 后端API文档
- 常见问题解答
- 完整示例代码

---

**文档版本**: v1.0.0  
**最后更新**: 2024-10-16  
**作者**: CookTip Team

