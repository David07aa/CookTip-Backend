# å¾®ä¿¡å°ç¨‹åºä¸€é”®ç™»å½• - å®Œæ•´å®ç°æ–‡æ¡£

## ğŸ“š æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†åŸºäº**å¾®ä¿¡åŸç”Ÿå°ç¨‹åº + NestJSåç«¯**çš„å®Œæ•´ç™»å½•è§£å†³æ–¹æ¡ˆï¼Œå‚è€ƒ [CSDN æ•™ç¨‹](https://blog.csdn.net/zmz1196167569/article/details/150635408)ï¼Œå®Œå…¨é€‚é…æ‚¨çš„é¡¹ç›®æ¶æ„ã€‚

---

## ğŸ¯ å®ç°å†…å®¹

### âœ… å·²å®Œæˆçš„å·¥ä½œ

| åºå· | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | å‰ç«¯ç™»å½•å·¥å…·å°è£… | âœ… å®Œæˆ |
| 2 | å‰ç«¯ç™»å½•é¡µé¢ç¤ºä¾‹ | âœ… å®Œæˆ |
| 3 | åç«¯ç™»å½• API | âœ… å®Œæˆ |
| 4 | æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ– | âœ… å®Œæˆ |
| 5 | session_key å­˜å‚¨ | âœ… å®Œæˆ |
| 6 | JWT Token è®¤è¯ | âœ… å®Œæˆ |
| 7 | å®Œæ•´æ–‡æ¡£ | âœ… å®Œæˆ |

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### å‰ç«¯æ–‡ä»¶ï¼ˆå°ç¨‹åºï¼‰

```
miniprogram-utils/
â”œâ”€â”€ wechat-login.js                      # ç™»å½•æ ¸å¿ƒé€»è¾‘ï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ wechat-login-page-example.js         # ç™»å½•é¡µé¢ç¤ºä¾‹ JS
â”œâ”€â”€ wechat-login-page-example.wxml       # ç™»å½•é¡µé¢ç¤ºä¾‹ WXML
â”œâ”€â”€ wechat-login-page-example.wxss       # ç™»å½•é¡µé¢ç¤ºä¾‹ WXSS
â””â”€â”€ å¾®ä¿¡åŸç”Ÿå°ç¨‹åºç™»å½•é›†æˆæŒ‡å—.md        # å‰ç«¯é›†æˆå®Œæ•´æŒ‡å—
```

### åç«¯æ–‡ä»¶

```
src/modules/auth/
â”œâ”€â”€ auth.controller.ts          # è®¤è¯æ§åˆ¶å™¨ï¼ˆå·²ä¼˜åŒ–ï¼‰
â”œâ”€â”€ auth.service.ts             # è®¤è¯æœåŠ¡ï¼ˆå·²ä¼˜åŒ–ï¼‰
â””â”€â”€ dto/wechat-login.dto.ts     # ç™»å½•DTO

src/entities/
â””â”€â”€ user.entity.ts              # ç”¨æˆ·å®ä½“ï¼ˆå·²æ·»åŠ  session_keyï¼‰

database/migrations/
â”œâ”€â”€ add-session-key-to-users.sql    # SQL è¿ç§»è„šæœ¬
â””â”€â”€ ...

scripts/
â”œâ”€â”€ add-session-key-field.js        # è‡ªåŠ¨è¿ç§»è„šæœ¬ï¼ˆå·²æ‰§è¡Œï¼‰
â””â”€â”€ ...
```

---

## ğŸ”„ å®Œæ•´ç™»å½•æµç¨‹

### æ—¶åºå›¾

```
å¾®ä¿¡å°ç¨‹åº                äº‘å‡½æ•°                    NestJSåç«¯                å¾®ä¿¡æœåŠ¡å™¨
    â”‚                      â”‚                          â”‚                         â”‚
    â”‚ 1. ç”¨æˆ·ç‚¹å‡»ç™»å½•      â”‚                          â”‚                         â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                         â”‚
    â”‚                      â”‚                          â”‚                         â”‚
    â”‚ 2. wx.login()        â”‚                          â”‚                         â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                         â”‚
    â”‚    è¿”å› code         â”‚                          â”‚  3. jscode2session      â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                      â”‚                          â”‚  è¿”å› openid,session_keyâ”‚
    â”‚ 4. wx.getUserProfileâ”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                         â”‚
    â”‚  è¿”å› nickName,avatarâ”‚                          â”‚                         â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚                         â”‚
    â”‚                      â”‚                          â”‚                         â”‚
    â”‚ 5. å‘é€ç™»å½•è¯·æ±‚      â”‚                          â”‚                         â”‚
    â”‚    {code,nickName,   â”‚   6. è½¬å‘è¯·æ±‚            â”‚                         â”‚
    â”‚     avatarUrl}       â”‚                          â”‚                         â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
    â”‚                      â”‚                          â”‚  7. æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·       â”‚
    â”‚                      â”‚                          â”‚  8. ä¿å­˜ session_key    â”‚
    â”‚                      â”‚                          â”‚  9. ç”Ÿæˆ JWT token      â”‚
    â”‚                      â”‚   10. è¿”å›å“åº”           â”‚                         â”‚
    â”‚  11. ä¿å­˜ token      â”‚  {token, userInfo}       â”‚                         â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
    â”‚   åˆ°æœ¬åœ°å­˜å‚¨         â”‚                          â”‚                         â”‚
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### å‰ç«¯æµç¨‹

1. **ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®**
   ```javascript
   // å¿…é¡»ç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘
   <button bindtap="handleWechatLogin">å¾®ä¿¡ä¸€é”®ç™»å½•</button>
   ```

2. **è°ƒç”¨ wx.login() è·å– code**
   ```javascript
   wx.login({
     success: (res) => {
       const code = res.code; // ä¸´æ—¶ç™»å½•å‡­è¯ï¼Œæœ‰æ•ˆæœŸ5åˆ†é’Ÿ
     }
   });
   ```

3. **è°ƒç”¨ wx.getUserProfile() è·å–ç”¨æˆ·ä¿¡æ¯**
   ```javascript
   wx.getUserProfile({
     desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™',
     success: (res) => {
       const { nickName, avatarUrl } = res.userInfo;
     }
   });
   ```

4. **å‘é€ç™»å½•è¯·æ±‚åˆ°åç«¯**
   ```javascript
   wx.cloud.callFunction({
     name: 'api-proxy',
     data: {
       method: 'POST',
       path: '/api/v1/auth/wx-login',
       body: { code, nickName, avatarUrl }
     }
   });
   ```

5. **ä¿å­˜ token åˆ°æœ¬åœ°**
   ```javascript
   wx.setStorageSync('access_token', token);
   wx.setStorageSync('user_info', userInfo);
   ```

#### åç«¯æµç¨‹

1. **æ¥æ”¶ç™»å½•è¯·æ±‚**
   ```typescript
   @Post('wx-login')
   async wxLogin(@Body() wechatLoginDto: WechatLoginDto) {
     return this.authService.wechatLogin(wechatLoginDto);
   }
   ```

2. **è°ƒç”¨å¾®ä¿¡ API æ¢å– openid**
   ```typescript
   const url = 'https://api.weixin.qq.com/sns/jscode2session';
   const response = await axios.get(url, {
     params: { appid, secret, js_code: code, grant_type: 'authorization_code' }
   });
   const { openid, session_key } = response.data;
   ```

3. **æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·**
   ```typescript
   let user = await this.userRepository.findOne({ where: { openid } });
   
   if (!user) {
     // æ–°ç”¨æˆ·ï¼Œåˆ›å»ºè´¦æˆ·
     user = this.userRepository.create({
       openid,
       session_key,
       nickname: userNickname,
       avatar: userAvatar
     });
   } else {
     // è€ç”¨æˆ·ï¼Œæ›´æ–°ä¿¡æ¯
     user.nickname = userNickname;
     user.avatar = userAvatar;
     user.session_key = session_key; // æ›´æ–° session_key
   }
   
   await this.userRepository.save(user);
   ```

4. **ç”Ÿæˆ JWT Token**
   ```typescript
   const payload = {
     sub: user.id,
     openid: user.openid,
     nickname: user.nickname
   };
   
   const access_token = this.jwtService.sign(payload);
   ```

5. **è¿”å›å“åº”**
   ```typescript
   return {
     access_token,
     token_type: 'Bearer',
     expires_in: 604800, // 7å¤©
     user: {
       id: user.id,
       openid: user.openid,
       nickname: user.nickname,
       avatar: user.avatar,
       created_at: user.created_at
     }
   };
   ```

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

### users è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ–°å¢ |
|------|------|------|------|
| id | INT | ç”¨æˆ·IDï¼Œä¸»é”® | |
| openid | VARCHAR(100) | å¾®ä¿¡OpenIDï¼Œå”¯ä¸€ | |
| nickname | VARCHAR(50) | æ˜µç§° | |
| avatar | VARCHAR(255) | å¤´åƒURL | |
| **session_key** | **VARCHAR(200)** | **å¾®ä¿¡ä¼šè¯å¯†é’¥** | **âœ… æ–°å¢** |
| bio | VARCHAR(200) | ä¸ªäººç®€ä»‹ | |
| recipe_count | INT | å‘å¸ƒé£Ÿè°±æ•° | |
| follower_count | INT | ç²‰ä¸æ•° | |
| following_count | INT | å…³æ³¨æ•° | |
| favorite_count | INT | æ”¶è—æ•° | |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | |

**âœ… session_key å­—æ®µå·²æ·»åŠ **
- å­˜å‚¨å¾®ä¿¡è¿”å›çš„ session_key
- ç”¨äºåç»­è§£å¯†æ•æ„Ÿæ•°æ®ï¼ˆå¦‚æ‰‹æœºå·ï¼‰
- æ¯æ¬¡ç™»å½•è‡ªåŠ¨æ›´æ–°

---

## ğŸ“¡ API æ¥å£æ–‡æ¡£

### 1. å¾®ä¿¡ç™»å½•

**ç«¯ç‚¹**: `POST /api/v1/auth/wx-login`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
```

**è¯·æ±‚ä½“**:
```json
{
  "code": "081abc123...",
  "nickName": "å¼ ä¸‰",
  "avatarUrl": "https://..."
}
```

**æˆåŠŸå“åº”** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 604800,
    "user": {
      "id": 1,
      "openid": "oXXXX...",
      "nickname": "å¼ ä¸‰",
      "avatar": "https://...",
      "created_at": "2024-10-16T12:00:00.000Z"
    }
  },
  "timestamp": "2024-10-16T12:00:00.000Z"
}
```

**é”™è¯¯å“åº”** (401):
```json
{
  "code": 401,
  "message": "å¾®ä¿¡ç™»å½•å¤±è´¥: invalid code (é”™è¯¯ç : 40029)",
  "error": "Unauthorized",
  "timestamp": "2024-10-16T12:00:00.000Z"
}
```

---

### 2. åˆ·æ–° Token

**ç«¯ç‚¹**: `POST /api/v1/auth/refresh`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <access_token>
```

**æˆåŠŸå“åº”** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 604800
  }
}
```

---

### 3. é€€å‡ºç™»å½•

**ç«¯ç‚¹**: `POST /api/v1/auth/logout`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <access_token>
```

**æˆåŠŸå“åº”** (200):
```json
{
  "code": 200,
  "message": "é€€å‡ºæˆåŠŸ",
  "data": {
    "message": "é€€å‡ºæˆåŠŸ"
  }
}
```

---

## ğŸš€ å¿«é€Ÿé›†æˆæŒ‡å—

### å‰ç«¯é›†æˆï¼ˆ3æ­¥ï¼‰

#### æ­¥éª¤1ï¼šå¤åˆ¶å·¥å…·æ–‡ä»¶

```bash
# å°† wechat-login.js å¤åˆ¶åˆ°å°ç¨‹åºé¡¹ç›®
cp miniprogram-utils/wechat-login.js your-miniprogram/utils/
```

#### æ­¥éª¤2ï¼šåœ¨ç™»å½•é¡µé¢å¼•å…¥

```javascript
// pages/login/login.js
const wechatAuth = require('../../utils/wechat-login.js');

Page({
  handleWechatLogin() {
    wechatAuth.wechatLogin()
      .then(result => {
        console.log('ç™»å½•æˆåŠŸ:', result);
        wx.switchTab({ url: '/pages/index/index' });
      })
      .catch(error => {
        console.error('ç™»å½•å¤±è´¥:', error);
        wx.showToast({ title: error.message, icon: 'none' });
      });
  }
});
```

#### æ­¥éª¤3ï¼šæ·»åŠ ç™»å½•æŒ‰é’®

```xml
<!-- pages/login/login.wxml -->
<button bindtap="handleWechatLogin">å¾®ä¿¡ä¸€é”®ç™»å½•</button>
```

### åç«¯é›†æˆï¼ˆå·²å®Œæˆï¼‰

âœ… åç«¯ä»£ç å·²å…¨éƒ¨å®Œæˆï¼Œæ— éœ€é¢å¤–é…ç½®ï¼

---

## ğŸ” ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿äº‘æ‰˜ç®¡ç¯å¢ƒå˜é‡ä¸­å·²é…ç½®å¾®ä¿¡AppIDå’ŒSecretï¼š

```json
// cloudbase-env-vars.json
{
  "WX_APPID": "wx1234567890abcdef",  // å°ç¨‹åº AppID
  "WX_SECRET": "your_secret_key_here" // å°ç¨‹åº Secret
}
```

**è·å–æ–¹å¼**ï¼š
1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½®
3. å¤åˆ¶ AppID å’Œ AppSecret

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### å‰ç«¯æµ‹è¯•

- [ ] èƒ½å¤ŸæˆåŠŸè°ƒç”¨ `wx.login()` è·å– code
- [ ] èƒ½å¤ŸæˆåŠŸè°ƒç”¨ `wx.getUserProfile()` è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] èƒ½å¤ŸæˆåŠŸå‘é€ç™»å½•è¯·æ±‚åˆ°åç«¯
- [ ] èƒ½å¤Ÿæ­£ç¡®ä¿å­˜ token åˆ°æœ¬åœ°å­˜å‚¨
- [ ] èƒ½å¤Ÿæ­£ç¡®è¯»å–æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
- [ ] èƒ½å¤Ÿæ­£ç¡®å¤„ç†ç”¨æˆ·æ‹’ç»æˆæƒçš„æƒ…å†µ
- [ ] é€€å‡ºç™»å½•åŠŸèƒ½æ­£å¸¸

### åç«¯æµ‹è¯•

- [ ] èƒ½å¤ŸæˆåŠŸæ¥æ”¶å‰ç«¯ç™»å½•è¯·æ±‚
- [ ] èƒ½å¤ŸæˆåŠŸè°ƒç”¨å¾®ä¿¡ API è·å– openid
- [ ] èƒ½å¤Ÿæ­£ç¡®åˆ›å»ºæ–°ç”¨æˆ·
- [ ] èƒ½å¤Ÿæ­£ç¡®æ›´æ–°è€ç”¨æˆ·ä¿¡æ¯
- [ ] èƒ½å¤Ÿæ­£ç¡®ä¿å­˜ session_key
- [ ] èƒ½å¤ŸæˆåŠŸç”Ÿæˆ JWT token
- [ ] Token éªŒè¯åŠŸèƒ½æ­£å¸¸

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç™»å½•é¡µé¢

å‚è€ƒæ–‡ä»¶ï¼š
- `miniprogram-utils/wechat-login-page-example.js`
- `miniprogram-utils/wechat-login-page-example.wxml`
- `miniprogram-utils/wechat-login-page-example.wxss`

### ç¤ºä¾‹2ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€

```javascript
// åœ¨éœ€è¦ç™»å½•çš„é¡µé¢
const wechatAuth = require('../../utils/wechat-login.js');

Page({
  onLoad() {
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    if (!wechatAuth.checkLoginStatus()) {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      wx.navigateTo({ url: '/pages/login/login' });
      return;
    }
    
    // å·²ç™»å½•ï¼ŒåŠ è½½é¡µé¢æ•°æ®
    this.loadPageData();
  },
  
  loadPageData() {
    const token = wechatAuth.getLocalToken();
    const userInfo = wechatAuth.getLocalUserInfo();
    
    console.log('å½“å‰ç”¨æˆ·:', userInfo.nickname);
    
    // ä½¿ç”¨ token è¯·æ±‚åç«¯API
    // ...
  }
});
```

### ç¤ºä¾‹3ï¼šå¸¦ Token çš„ API è¯·æ±‚

```javascript
const wechatAuth = require('../../utils/wechat-login.js');

// è·å–ç”¨æˆ·ä¿¡æ¯
function getUserProfile() {
  const token = wechatAuth.getLocalToken();
  
  return new Promise((resolve, reject) => {
    wx.cloud.callFunction({
      name: 'api-proxy',
      data: {
        method: 'GET',
        path: '/api/v1/user/profile',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      },
      success: (res) => {
        if (res.result.statusCode === 200) {
          resolve(res.result.data.data);
        } else if (res.result.statusCode === 401) {
          // Token è¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          wx.reLaunch({ url: '/pages/login/login' });
          reject(new Error('ç™»å½•å·²è¿‡æœŸ'));
        } else {
          reject(new Error('è¯·æ±‚å¤±è´¥'));
        }
      },
      fail: reject
    });
  });
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. wx.getUserProfile å¿…é¡»ç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘

```javascript
// âœ… æ­£ç¡®ï¼šç»‘å®šåˆ°æŒ‰é’®ç‚¹å‡»
<button bindtap="handleLogin">ç™»å½•</button>

// âŒ é”™è¯¯ï¼šåœ¨ onLoad ä¸­è‡ªåŠ¨è°ƒç”¨
onLoad() {
  wechatAuth.wechatLogin(); // ä¼šå¤±è´¥ï¼
}
```

### 2. code åªèƒ½ä½¿ç”¨ä¸€æ¬¡

æ¯æ¬¡è°ƒç”¨ `wx.login()` è·å–çš„ code åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè¯·ç¡®ä¿ï¼š
- è·å– code åç«‹å³å‘é€åˆ°åç«¯
- ä¸è¦é‡å¤ä½¿ç”¨åŒä¸€ä¸ª code
- code æœ‰æ•ˆæœŸä¸º 5 åˆ†é’Ÿ

### 3. session_key çš„ä½œç”¨

`session_key` ç”¨äºè§£å¯†ä»¥ä¸‹æ•æ„Ÿæ•°æ®ï¼š
- æ‰‹æœºå·ï¼ˆé€šè¿‡ `getPhoneNumber`ï¼‰
- è¿åŠ¨æ­¥æ•°ï¼ˆé€šè¿‡ `getWeRunData`ï¼‰
- ç¾¤IDï¼ˆé€šè¿‡ `getShareInfo`ï¼‰

### 4. Token è¿‡æœŸå¤„ç†

Token æœ‰æ•ˆæœŸä¸º 7 å¤©ï¼Œå»ºè®®ï¼š
- åœ¨ API è¯·æ±‚å¤±è´¥æ—¶æ£€æŸ¥ 401 é”™è¯¯
- è‡ªåŠ¨è°ƒç”¨ `refreshToken()` åˆ·æ–°token
- å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé‡æ–°ç™»å½•

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç™»å½•æŠ¥é”™ "invalid code"

**åŸå› **ï¼š
- code å·²è¢«ä½¿ç”¨
- code å·²è¿‡æœŸï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰
- AppID æˆ– Secret é…ç½®é”™è¯¯

**è§£å†³**ï¼š
1. ç¡®ä¿æ¯æ¬¡ç™»å½•é‡æ–°è·å– code
2. è·å– code åç«‹å³å‘é€åˆ°åç«¯
3. æ£€æŸ¥äº‘æ‰˜ç®¡ç¯å¢ƒå˜é‡é…ç½®

---

### Q2: wx.getUserProfile æŠ¥é”™ "fail auth deny"

**åŸå› **ï¼š
- æ²¡æœ‰åœ¨ç”¨æˆ·ä¸»åŠ¨æ“ä½œä¸­è°ƒç”¨
- å°ç¨‹åºåŸºç¡€åº“ç‰ˆæœ¬è¿‡ä½

**è§£å†³**ï¼š
1. ç¡®ä¿åœ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶ä¸­è°ƒç”¨
2. æ£€æŸ¥åŸºç¡€åº“ç‰ˆæœ¬ â‰¥ 2.10.4

---

### Q3: ç™»å½•æˆåŠŸä½†æ²¡æœ‰è¿”å›ç”¨æˆ·ä¿¡æ¯

**åŸå› **ï¼šåç«¯ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯

**è§£å†³**ï¼š
1. æ£€æŸ¥ `cloudbase-env-vars.json`
2. ç¡®è®¤ `WX_APPID` å’Œ `WX_SECRET` æ­£ç¡®
3. é‡å¯äº‘æ‰˜ç®¡æœåŠ¡

---

## ğŸ“Š æ•°æ®åº“è¿ç§»è®°å½•

âœ… **2024-10-16**: æ·»åŠ  `session_key` å­—æ®µåˆ° `users` è¡¨
- å­—æ®µç±»å‹: VARCHAR(200)
- å¯ä¸ºç©º: YES
- ç”¨é€”: å­˜å‚¨å¾®ä¿¡ session_key
- å½±å“ç”¨æˆ·æ•°: 3
- è¿ç§»çŠ¶æ€: æˆåŠŸ

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [å¾®ä¿¡å°ç¨‹åºç™»å½•å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [wx.getUserProfile API](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)
- [NestJS å®˜æ–¹æ–‡æ¡£](https://nestjs.com/)
- [å‚è€ƒæ•™ç¨‹ - CSDN](https://blog.csdn.net/zmz1196167569/article/details/150635408)

---

## âœ… æ€»ç»“

### å·²å®ç°çš„åŠŸèƒ½

âœ… **å‰ç«¯**
- å¾®ä¿¡ä¸€é”®ç™»å½•å°è£…
- ç™»å½•çŠ¶æ€ç®¡ç†
- Token è‡ªåŠ¨ä¿å­˜
- é€€å‡ºç™»å½•åŠŸèƒ½
- å®Œæ•´çš„é¡µé¢ç¤ºä¾‹

âœ… **åç«¯**
- å¾®ä¿¡ code æ¢å– openid
- ç”¨æˆ·è‡ªåŠ¨æ³¨å†Œ/ç™»å½•
- session_key å­˜å‚¨
- JWT Token ç”Ÿæˆ
- Token éªŒè¯å’Œåˆ·æ–°

âœ… **æ•°æ®åº“**
- users è¡¨ä¼˜åŒ–
- session_key å­—æ®µæ·»åŠ 
- è‡ªåŠ¨è¿ç§»è„šæœ¬

âœ… **æ–‡æ¡£**
- å‰ç«¯é›†æˆæŒ‡å—
- åç«¯APIæ–‡æ¡£
- å¸¸è§é—®é¢˜è§£ç­”
- å®Œæ•´ç¤ºä¾‹ä»£ç 

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024-10-16  
**ä½œè€…**: CookTip Team

