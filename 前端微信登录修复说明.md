# 前端微信登录修复说明

## 📋 问题总结

用户在真机测试时遇到两个关键问题：

### 问题1：getUserProfile 调用时机错误
```
getUserProfile:fail can only be invoked by user TAP gesture.
```
**原因**：`getUserProfile` 在 `wx.login()` 的异步回调中调用，违反了微信的规则

### 问题2：网络连接超时
```
getaddrinfo ENOTFOUND rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```
**原因**：前端通过 `api-proxy` 云函数转发 HTTP 请求到云托管内网域名，但真机环境无法解析

---

## ✅ 解决方案

### 1. 调整 getUserProfile 调用顺序
**修改前**（错误）：
```javascript
wx.login({
  success: (loginRes) => {
    wx.getUserProfile({ ... }) // ❌ 在异步回调中调用
  }
})
```

**修改后**（正确）：
```javascript
// ✅ 先在用户点击事件中直接调用 getUserProfile
let userInfo = await wx.getUserProfile({ ... });

// ✅ 再调用 wx.login
let loginRes = await wx.login();
```

### 2. 改用云函数登录
**修改前**（问题）：
```javascript
// ❌ 通过 api-proxy 云函数转发 HTTP 请求
const result = await Request.post('/auth/wechat-login', {
  code: loginRes.code,
  nickname: userInfo?.nickName,
  avatar: userInfo?.avatarUrl
});
```

**修改后**（正确）：
```javascript
// ✅ 直接调用 wechat-login 云函数
const cloudRes = await wx.cloud.callFunction({
  name: 'wechat-login',
  data: {
    code: loginRes.code,
    nickname: userInfo?.nickName,
    avatar: userInfo?.avatarUrl
  }
});
```

---

## 📝 前端需要修改的文件

### 文件：`pages/login/login.js`
**位置**：前端项目 `CookTip/pages/login/login.js`
**方法**：`wechatLogin()`

**完整修复代码**：
```javascript
async wechatLogin() {
  try {
    wx.showLoading({ title: '登录中...', mask: true });
    
    // 1. 先获取用户信息（必须在用户点击事件中直接调用）
    let userInfo = null;
    try {
      userInfo = await this.getUserProfile();
      console.log('[Login] Got user profile:', userInfo);
    } catch (error) {
      console.log('[Login] User declined profile authorization:', error);
      // 用户拒绝授权，继续登录但不传用户信息
    }
    
    // 2. 再获取微信登录code
    const loginRes = await new Promise((resolve, reject) => {
      wx.login({
        success: resolve,
        fail: reject
      });
    });
    
    if (!loginRes.code) {
      throw new Error('获取微信code失败');
    }
    
    console.log('[Login] Got wx code:', loginRes.code);
    
    // 3. 直接调用 wechat-login 云函数（不走 api-proxy）
    const cloudRes = await wx.cloud.callFunction({
      name: 'wechat-login',
      data: {
        code: loginRes.code,
        nickname: userInfo?.nickName,
        avatar: userInfo?.avatarUrl
      }
    });
    
    console.log('[Login] Cloud function response:', cloudRes);
    
    wx.hideLoading();
    
    // 4. 检查云函数响应
    if (!cloudRes.result || !cloudRes.result.success) {
      throw new Error(cloudRes.result?.message || '登录失败');
    }
    
    const result = cloudRes.result.data;
    
    // 5. 检查后端响应
    if (result.code === 200 || result.code === 201) {
      const { access_token, user } = result.data;
      
      // 6. 保存Token和用户信息
      AuthManager.saveToken(access_token, user);
      
      console.log('[Login] Login success:', user);
      
      // 7. 成功提示
      wx.showToast({
        title: '登录成功',
        icon: 'success',
        duration: 1500
      });
      
      // 8. 跳转到首页
      setTimeout(() => {
        wx.switchTab({ 
          url: '/pages/index/index',
          fail: (err) => {
            console.error('[Login] Switch tab failed:', err);
            wx.reLaunch({ url: '/pages/index/index' });
          }
        });
      }, 1500);
      
    } else {
      throw new Error(result.message || '登录失败');
    }
    
  } catch (error) {
    wx.hideLoading();
    
    console.error('[Login] Wechat login error:', error);
    
    let errorMsg = '登录失败';
    if (error.message) {
      errorMsg = error.message;
    } else if (error.errMsg) {
      if (error.errMsg.includes('cancel')) {
        errorMsg = '用户取消授权';
      } else if (error.errMsg.includes('getUserProfile:fail can only be invoked by user TAP gesture')) {
        errorMsg = '请点击按钮后重试';
      } else {
        errorMsg = '登录失败，请重试';
      }
    }
    
    wx.showToast({
      title: errorMsg,
      icon: 'none',
      duration: 2000
    });
  }
}
```

---

## 🎯 前端测试清单

前端开发者需要确认：

### 部署检查
- [ ] 云函数 `wechat-login` 已部署
- [ ] 云函数 `api-proxy` 已部署（用于其他接口）
- [ ] 小程序已重新编译

### 功能测试
- [ ] 微信登录（授权）：成功
- [ ] 微信登录（拒绝授权）：成功
- [ ] 账号密码注册：成功
- [ ] 账号密码登录：成功

### 错误验证
- [ ] 不再出现 `getUserProfile:fail can only be invoked by user TAP gesture.`
- [ ] 不再出现 `getaddrinfo ENOTFOUND rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com`

---

## 📊 技术架构说明

### 修复前（有问题的架构）
```
小程序前端
  ↓ (HTTP Request)
api-proxy 云函数
  ↓ (HTTP Request)
云托管内网域名 (rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com)
  ↓
后端 API (/api/v1/auth/wechat-login)
  ↓ (HTTP Request)
微信 API (api.weixin.qq.com)
```
**问题**：真机环境无法解析云托管内网域名

### 修复后（正确的架构）
```
小程序前端
  ↓ (Cloud Function Call)
wechat-login 云函数
  ↓ (cloud.getWXContext() - 直接获取 OpenID)
  ↓ (HTTP Request to Internal Network)
云托管内网地址 (http://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com)
  ↓
后端 API (/api/v1/auth/cloud-login)
```
**优点**：
1. 云函数可以直接获取 OpenID，无需调用微信 API
2. 云函数在腾讯云内网，可以访问云托管内网地址
3. 避免了 IP 白名单问题
4. 避免了网络超时问题

---

## 🔧 后端相关接口

### 接口：POST /api/v1/auth/cloud-login
**用途**：处理云函数转发的登录请求
**请求头**：
- `x-wx-openid`（可选）：云托管身份注入的 OpenID
- `x-wx-unionid`（可选）：云托管身份注入的 UnionID

**请求体**：
```json
{
  "openid": "oXXXX-xxxxxxxxxxxxx",
  "unionid": "oYYYY-yyyyyyyyyyyy",
  "nickname": "用户昵称",
  "avatar": "https://头像URL"
}
```

**响应**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "access_token": "eyJhbGci...",
    "token_type": "Bearer",
    "expires_in": 604800,
    "user": {
      "id": 1,
      "openid": "oXXXX-xxxxxxxxxxxxx",
      "nickname": "用户昵称",
      "avatar": "https://头像URL",
      "created_at": "2025-01-01T00:00:00.000Z"
    }
  }
}
```

---

## 📚 相关文档

- `cloudfunctions/wechat-login/README.md` - 云函数使用说明
- `微信云托管身份注入配置指南.md` - 身份注入配置
- `微信登录IP白名单问题完整解决方案.md` - 问题分析

---

## 🎉 修复完成

所有修改已完成，前端开发者可以按照以上说明进行测试。

**修复日期**：2025-01-XX
**修复内容**：
1. ✅ getUserProfile 调用顺序
2. ✅ 改用云函数登录
3. ✅ 网络超时问题

**测试状态**：待前端开发者测试

