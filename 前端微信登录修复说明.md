# å‰ç«¯å¾®ä¿¡ç™»å½•ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æ€»ç»“

ç”¨æˆ·åœ¨çœŸæœºæµ‹è¯•æ—¶é‡åˆ°ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

### é—®é¢˜1ï¼šgetUserProfile è°ƒç”¨æ—¶æœºé”™è¯¯
```
getUserProfile:fail can only be invoked by user TAP gesture.
```
**åŸå› **ï¼š`getUserProfile` åœ¨ `wx.login()` çš„å¼‚æ­¥å›è°ƒä¸­è°ƒç”¨ï¼Œè¿åäº†å¾®ä¿¡çš„è§„åˆ™

### é—®é¢˜2ï¼šç½‘ç»œè¿æ¥è¶…æ—¶
```
getaddrinfo ENOTFOUND rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com
```
**åŸå› **ï¼šå‰ç«¯é€šè¿‡ `api-proxy` äº‘å‡½æ•°è½¬å‘ HTTP è¯·æ±‚åˆ°äº‘æ‰˜ç®¡å†…ç½‘åŸŸåï¼Œä½†çœŸæœºç¯å¢ƒæ— æ³•è§£æ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. è°ƒæ•´ getUserProfile è°ƒç”¨é¡ºåº
**ä¿®æ”¹å‰**ï¼ˆé”™è¯¯ï¼‰ï¼š
```javascript
wx.login({
  success: (loginRes) => {
    wx.getUserProfile({ ... }) // âŒ åœ¨å¼‚æ­¥å›è°ƒä¸­è°ƒç”¨
  }
})
```

**ä¿®æ”¹å**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```javascript
// âœ… å…ˆåœ¨ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ä¸­ç›´æ¥è°ƒç”¨ getUserProfile
let userInfo = await wx.getUserProfile({ ... });

// âœ… å†è°ƒç”¨ wx.login
let loginRes = await wx.login();
```

### 2. æ”¹ç”¨äº‘å‡½æ•°ç™»å½•
**ä¿®æ”¹å‰**ï¼ˆé—®é¢˜ï¼‰ï¼š
```javascript
// âŒ é€šè¿‡ api-proxy äº‘å‡½æ•°è½¬å‘ HTTP è¯·æ±‚
const result = await Request.post('/auth/wechat-login', {
  code: loginRes.code,
  nickname: userInfo?.nickName,
  avatar: userInfo?.avatarUrl
});
```

**ä¿®æ”¹å**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```javascript
// âœ… ç›´æ¥è°ƒç”¨ wechat-login äº‘å‡½æ•°
const cloudRes = await wx.cloud.callFunction({
  name: 'wechat-login',
  data: {
    code: loginRes.code,
    nickname: userInfo?.nickName,
    avatar: userInfo?.avatarUrl
  }
});
```

---

## ğŸ“ å‰ç«¯éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### æ–‡ä»¶ï¼š`pages/login/login.js`
**ä½ç½®**ï¼šå‰ç«¯é¡¹ç›® `CookTip/pages/login/login.js`
**æ–¹æ³•**ï¼š`wechatLogin()`

**å®Œæ•´ä¿®å¤ä»£ç **ï¼š
```javascript
async wechatLogin() {
  try {
    wx.showLoading({ title: 'ç™»å½•ä¸­...', mask: true });
    
    // 1. å…ˆè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ä¸­ç›´æ¥è°ƒç”¨ï¼‰
    let userInfo = null;
    try {
      userInfo = await this.getUserProfile();
      console.log('[Login] Got user profile:', userInfo);
    } catch (error) {
      console.log('[Login] User declined profile authorization:', error);
      // ç”¨æˆ·æ‹’ç»æˆæƒï¼Œç»§ç»­ç™»å½•ä½†ä¸ä¼ ç”¨æˆ·ä¿¡æ¯
    }
    
    // 2. å†è·å–å¾®ä¿¡ç™»å½•code
    const loginRes = await new Promise((resolve, reject) => {
      wx.login({
        success: resolve,
        fail: reject
      });
    });
    
    if (!loginRes.code) {
      throw new Error('è·å–å¾®ä¿¡codeå¤±è´¥');
    }
    
    console.log('[Login] Got wx code:', loginRes.code);
    
    // 3. ç›´æ¥è°ƒç”¨ wechat-login äº‘å‡½æ•°ï¼ˆä¸èµ° api-proxyï¼‰
    const cloudRes = await wx.cloud.callFunction({
      name: 'wechat-login',
      data: {
        code: loginRes.code,
        nickname: userInfo?.nickName,
        avatar: userInfo?.avatarUrl
      }
    });
    
    console.log('[Login] Cloud function response:', cloudRes);
    
    wx.hideLoading();
    
    // 4. æ£€æŸ¥äº‘å‡½æ•°å“åº”
    if (!cloudRes.result || !cloudRes.result.success) {
      throw new Error(cloudRes.result?.message || 'ç™»å½•å¤±è´¥');
    }
    
    const result = cloudRes.result.data;
    
    // 5. æ£€æŸ¥åç«¯å“åº”
    if (result.code === 200 || result.code === 201) {
      const { access_token, user } = result.data;
      
      // 6. ä¿å­˜Tokenå’Œç”¨æˆ·ä¿¡æ¯
      AuthManager.saveToken(access_token, user);
      
      console.log('[Login] Login success:', user);
      
      // 7. æˆåŠŸæç¤º
      wx.showToast({
        title: 'ç™»å½•æˆåŠŸ',
        icon: 'success',
        duration: 1500
      });
      
      // 8. è·³è½¬åˆ°é¦–é¡µ
      setTimeout(() => {
        wx.switchTab({ 
          url: '/pages/index/index',
          fail: (err) => {
            console.error('[Login] Switch tab failed:', err);
            wx.reLaunch({ url: '/pages/index/index' });
          }
        });
      }, 1500);
      
    } else {
      throw new Error(result.message || 'ç™»å½•å¤±è´¥');
    }
    
  } catch (error) {
    wx.hideLoading();
    
    console.error('[Login] Wechat login error:', error);
    
    let errorMsg = 'ç™»å½•å¤±è´¥';
    if (error.message) {
      errorMsg = error.message;
    } else if (error.errMsg) {
      if (error.errMsg.includes('cancel')) {
        errorMsg = 'ç”¨æˆ·å–æ¶ˆæˆæƒ';
      } else if (error.errMsg.includes('getUserProfile:fail can only be invoked by user TAP gesture')) {
        errorMsg = 'è¯·ç‚¹å‡»æŒ‰é’®åé‡è¯•';
      } else {
        errorMsg = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
      }
    }
    
    wx.showToast({
      title: errorMsg,
      icon: 'none',
      duration: 2000
    });
  }
}
```

---

## ğŸ¯ å‰ç«¯æµ‹è¯•æ¸…å•

å‰ç«¯å¼€å‘è€…éœ€è¦ç¡®è®¤ï¼š

### éƒ¨ç½²æ£€æŸ¥
- [ ] äº‘å‡½æ•° `wechat-login` å·²éƒ¨ç½²
- [ ] äº‘å‡½æ•° `api-proxy` å·²éƒ¨ç½²ï¼ˆç”¨äºå…¶ä»–æ¥å£ï¼‰
- [ ] å°ç¨‹åºå·²é‡æ–°ç¼–è¯‘

### åŠŸèƒ½æµ‹è¯•
- [ ] å¾®ä¿¡ç™»å½•ï¼ˆæˆæƒï¼‰ï¼šæˆåŠŸ
- [ ] å¾®ä¿¡ç™»å½•ï¼ˆæ‹’ç»æˆæƒï¼‰ï¼šæˆåŠŸ
- [ ] è´¦å·å¯†ç æ³¨å†Œï¼šæˆåŠŸ
- [ ] è´¦å·å¯†ç ç™»å½•ï¼šæˆåŠŸ

### é”™è¯¯éªŒè¯
- [ ] ä¸å†å‡ºç° `getUserProfile:fail can only be invoked by user TAP gesture.`
- [ ] ä¸å†å‡ºç° `getaddrinfo ENOTFOUND rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com`

---

## ğŸ“Š æŠ€æœ¯æ¶æ„è¯´æ˜

### ä¿®å¤å‰ï¼ˆæœ‰é—®é¢˜çš„æ¶æ„ï¼‰
```
å°ç¨‹åºå‰ç«¯
  â†“ (HTTP Request)
api-proxy äº‘å‡½æ•°
  â†“ (HTTP Request)
äº‘æ‰˜ç®¡å†…ç½‘åŸŸå (rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com)
  â†“
åç«¯ API (/api/v1/auth/wechat-login)
  â†“ (HTTP Request)
å¾®ä¿¡ API (api.weixin.qq.com)
```
**é—®é¢˜**ï¼šçœŸæœºç¯å¢ƒæ— æ³•è§£æäº‘æ‰˜ç®¡å†…ç½‘åŸŸå

### ä¿®å¤åï¼ˆæ­£ç¡®çš„æ¶æ„ï¼‰
```
å°ç¨‹åºå‰ç«¯
  â†“ (Cloud Function Call)
wechat-login äº‘å‡½æ•°
  â†“ (cloud.getWXContext() - ç›´æ¥è·å– OpenID)
  â†“ (HTTP Request to Internal Network)
äº‘æ‰˜ç®¡å†…ç½‘åœ°å€ (http://rnvvjhwh.yjsp-ytg.0er4gbxk.1tj8lj27.com)
  â†“
åç«¯ API (/api/v1/auth/cloud-login)
```
**ä¼˜ç‚¹**ï¼š
1. äº‘å‡½æ•°å¯ä»¥ç›´æ¥è·å– OpenIDï¼Œæ— éœ€è°ƒç”¨å¾®ä¿¡ API
2. äº‘å‡½æ•°åœ¨è…¾è®¯äº‘å†…ç½‘ï¼Œå¯ä»¥è®¿é—®äº‘æ‰˜ç®¡å†…ç½‘åœ°å€
3. é¿å…äº† IP ç™½åå•é—®é¢˜
4. é¿å…äº†ç½‘ç»œè¶…æ—¶é—®é¢˜

---

## ğŸ”§ åç«¯ç›¸å…³æ¥å£

### æ¥å£ï¼šPOST /api/v1/auth/cloud-login
**ç”¨é€”**ï¼šå¤„ç†äº‘å‡½æ•°è½¬å‘çš„ç™»å½•è¯·æ±‚
**è¯·æ±‚å¤´**ï¼š
- `x-wx-openid`ï¼ˆå¯é€‰ï¼‰ï¼šäº‘æ‰˜ç®¡èº«ä»½æ³¨å…¥çš„ OpenID
- `x-wx-unionid`ï¼ˆå¯é€‰ï¼‰ï¼šäº‘æ‰˜ç®¡èº«ä»½æ³¨å…¥çš„ UnionID

**è¯·æ±‚ä½“**ï¼š
```json
{
  "openid": "oXXXX-xxxxxxxxxxxxx",
  "unionid": "oYYYY-yyyyyyyyyyyy",
  "nickname": "ç”¨æˆ·æ˜µç§°",
  "avatar": "https://å¤´åƒURL"
}
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "access_token": "eyJhbGci...",
    "token_type": "Bearer",
    "expires_in": 604800,
    "user": {
      "id": 1,
      "openid": "oXXXX-xxxxxxxxxxxxx",
      "nickname": "ç”¨æˆ·æ˜µç§°",
      "avatar": "https://å¤´åƒURL",
      "created_at": "2025-01-01T00:00:00.000Z"
    }
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `cloudfunctions/wechat-login/README.md` - äº‘å‡½æ•°ä½¿ç”¨è¯´æ˜
- `å¾®ä¿¡äº‘æ‰˜ç®¡èº«ä»½æ³¨å…¥é…ç½®æŒ‡å—.md` - èº«ä»½æ³¨å…¥é…ç½®
- `å¾®ä¿¡ç™»å½•IPç™½åå•é—®é¢˜å®Œæ•´è§£å†³æ–¹æ¡ˆ.md` - é—®é¢˜åˆ†æ

---

## ğŸ‰ ä¿®å¤å®Œæˆ

æ‰€æœ‰ä¿®æ”¹å·²å®Œæˆï¼Œå‰ç«¯å¼€å‘è€…å¯ä»¥æŒ‰ç…§ä»¥ä¸Šè¯´æ˜è¿›è¡Œæµ‹è¯•ã€‚

**ä¿®å¤æ—¥æœŸ**ï¼š2025-01-XX
**ä¿®å¤å†…å®¹**ï¼š
1. âœ… getUserProfile è°ƒç”¨é¡ºåº
2. âœ… æ”¹ç”¨äº‘å‡½æ•°ç™»å½•
3. âœ… ç½‘ç»œè¶…æ—¶é—®é¢˜

**æµ‹è¯•çŠ¶æ€**ï¼šå¾…å‰ç«¯å¼€å‘è€…æµ‹è¯•

