# 微信登录 401 错误排查指南

## 🐛 问题现象

真机调试时，微信登录返回 401 错误：

```json
{
  "code": 401,
  "message": "微信登录失败，请重试",
  "error": "Unauthorized",
  "timestamp": "2025-10-09T08:51:41.928Z",
  "path": "/api/v1/auth/wx-login"
}
```

## 🔍 可能的原因

401 错误表示调用微信 API (`code2Session`) 失败，可能的原因包括：

### 1️⃣ 环境变量未配置或配置错误 ⚠️ **最常见**
- `WX_APPID` 或 `WX_SECRET` 未配置
- AppID 或 Secret 配置错误（拼写错误、多余空格等）
- 环境变量名称错误

### 2️⃣ 微信 API 返回错误
- Code 已过期（有效期 5 分钟）
- AppID 与小程序不匹配
- Secret 错误
- 网络问题无法访问微信服务器

### 3️⃣ 小程序配置问题
- 使用的 AppID 与后端配置的不一致
- 小程序未发布或体验版未配置

## 🚀 排查步骤

### 第一步：重新部署云托管（必须）

1. 打开 [微信云托管控制台](https://console.cloud.tencent.com/tcb)
2. 找到服务 `yjsp-ytg`
3. 点击「新建版本」
4. 选择从 GitHub 拉取代码（`main` 分支）
5. 等待构建完成（约 2-3 分钟）

**为什么要重新部署？**
我刚刚添加了详细的调试日志，重新部署后可以在日志中看到详细的错误信息。

### 第二步：检查环境变量配置

在云托管控制台，检查环境变量是否正确配置：

#### 必需的环境变量

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `WX_APPID` | `wx8486e57500ac0a55` | 微信小程序 AppID |
| `WX_SECRET` | `bd4c652097608bb064350cc7e3b5801c` | 微信小程序 Secret |

**或者使用：**

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `WECHAT_APPID` | `wx8486e57500ac0a55` | 微信小程序 AppID |
| `WECHAT_SECRET` | `bd4c652097608bb064350cc7e3b5801c` | 微信小程序 Secret |

**⚠️ 注意事项**：
- 变量名区分大小写，必须完全一致
- 值前后不要有空格
- 确保 AppID 和 Secret 对应同一个小程序

#### 如何配置环境变量

1. 进入云托管控制台
2. 选择服务 `yjsp-ytg`
3. 点击「版本管理」→「环境变量」
4. 添加或修改环境变量
5. 保存后**必须重新部署**才能生效

### 第三步：查看云托管日志

部署完成后，再次测试登录，然后查看日志：

1. 在云托管控制台，选择服务 `yjsp-ytg`
2. 点击「日志」或「实时日志」
3. 查找包含以下内容的日志：

#### 正常日志（如果配置正确）
```
🔐 微信登录 - code2Session 开始
  - Code 长度: 32
  - AppID 存在: true (wx8486...)
  - Secret 存在: true (已配置)
📡 调用微信 API: https://api.weixin.qq.com/sns/jscode2session
📥 微信 API 响应: {"openid":"oXXXX...","session_key":"XXXX..."}
✅ 获取 openid 成功: oXXXXXXX...
```

#### 异常日志（如果配置有问题）

**场景 1: 环境变量未配置**
```
🔐 微信登录 - code2Session 开始
  - Code 长度: 32
  - AppID 存在: false 未配置
  - Secret 存在: false 未配置
❌ 微信配置缺失: AppID 或 Secret 未配置
```

**场景 2: 微信 API 返回错误**
```
📥 微信 API 响应: {"errcode":40029,"errmsg":"invalid code"}
❌ 微信返回错误码: 40029 invalid code
```

**场景 3: Code 已过期**
```
📥 微信 API 响应: {"errcode":40163,"errmsg":"code been used"}
❌ 微信返回错误码: 40163 code been used
```

### 第四步：根据日志修复问题

#### 问题 A: 环境变量未配置

**日志**：`AppID 存在: false` 或 `Secret 存在: false`

**解决方案**：
1. 在云托管控制台添加环境变量
2. 确保变量名正确：`WX_APPID` 和 `WX_SECRET`
3. 重新部署服务

#### 问题 B: Code 已过期（errcode: 40029 或 40163）

**日志**：`errcode:40029` 或 `errcode:40163`

**解决方案**：
- 这是正常现象，Code 有效期只有 5 分钟
- 重新登录获取新的 Code 即可
- 如果频繁出现，检查前端是否重复使用了同一个 Code

#### 问题 C: AppID 或 Secret 错误（errcode: 40013）

**日志**：`errcode:40013` `invalid appid`

**解决方案**：
1. 检查环境变量中的 `WX_APPID` 是否正确
2. 确保 AppID 与小程序一致
3. 检查是否有多余的空格或特殊字符

#### 问题 D: Secret 错误（errcode: 40125）

**日志**：`errcode:40125` `invalid appsecret`

**解决方案**：
1. 重新从微信公众平台获取 Secret
2. 更新云托管环境变量
3. 重新部署

## 📝 完整的环境变量配置示例

### 方式 1: 在云托管控制台配置

```
变量名: WX_APPID
变量值: wx8486e57500ac0a55

变量名: WX_SECRET  
变量值: bd4c652097608bb064350cc7e3b5801c

变量名: JWT_SECRET
变量值: /U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=

变量名: JWT_EXPIRES_IN
变量值: 7d

变量名: DB_HOST
变量值: 10.32.104.72

变量名: DB_PORT
变量值: 3306

变量名: DB_USERNAME
变量值: david_x

变量名: DB_PASSWORD
变量值: NVRvnX3rP88UyUET

变量名: DB_DATABASE
变量值: onefoodlibrary

变量名: NODE_ENV
变量值: production
```

### 方式 2: 使用 JSON 批量导入（如果支持）

```json
{
  "WX_APPID": "wx8486e57500ac0a55",
  "WX_SECRET": "bd4c652097608bb064350cc7e3b5801c",
  "JWT_SECRET": "/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=",
  "JWT_EXPIRES_IN": "7d",
  "DB_HOST": "10.32.104.72",
  "DB_PORT": "3306",
  "DB_USERNAME": "david_x",
  "DB_PASSWORD": "NVRvnX3rP88UyUET",
  "DB_DATABASE": "onefoodlibrary",
  "NODE_ENV": "production"
}
```

## 🧪 本地测试

如果你想在本地测试微信登录，创建 `.env` 文件：

```env
# 微信配置
WX_APPID=wx8486e57500ac0a55
WX_SECRET=bd4c652097608bb064350cc7e3b5801c

# JWT 配置
JWT_SECRET=/U6EkG+Zwgr99V642k6CHexH6CCwgoPQL2Pl7/QCQZ8=
JWT_EXPIRES_IN=7d

# 数据库配置（本地开发使用外网地址）
DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
DB_PORT=27821
DB_USERNAME=david_x
DB_PASSWORD=NVRvnX3rP88UyUET
DB_DATABASE=onefoodlibrary

# 其他配置
NODE_ENV=development
PORT=3000
```

然后运行：
```bash
npm run start:dev
```

使用小程序开发者工具测试登录，查看后端控制台日志。

## 🔗 微信官方文档

### 常见错误码

| 错误码 | 说明 | 解决方法 |
|--------|------|----------|
| 40029 | code 无效 | Code 已过期或不存在，重新获取 |
| 40163 | code 已使用 | Code 被重复使用，重新获取 |
| 40013 | 无效的 AppID | 检查 AppID 是否正确 |
| 40125 | 无效的 Secret | 检查 Secret 是否正确 |
| -1 | 系统繁忙 | 稍后重试 |

参考文档：https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html

## 📞 后续支持

### 如果按照上述步骤仍然无法解决

请提供以下信息：

1. **云托管日志截图**（包含完整的错误日志）
2. **环境变量配置截图**（隐藏敏感信息）
3. **小程序 AppID**（前6位即可）
4. **前端错误详情**

示例：
```
日志：
🔐 微信登录 - code2Session 开始
  - Code 长度: 32
  - AppID 存在: true (wx8486...)
  - Secret 存在: true (已配置)
📡 调用微信 API: https://api.weixin.qq.com/sns/jscode2session
📥 微信 API 响应: {"errcode":XXXXX,"errmsg":"XXXXX"}
❌ 微信返回错误码: XXXXX XXXXX
```

## ✅ 快速检查清单

部署后，按此清单逐项检查：

- [ ] 已重新部署云托管服务
- [ ] 环境变量 `WX_APPID` 已配置且正确
- [ ] 环境变量 `WX_SECRET` 已配置且正确
- [ ] 变量名没有拼写错误（区分大小写）
- [ ] 变量值前后没有空格
- [ ] AppID 与小程序一致
- [ ] 查看了云托管日志
- [ ] 使用真实的微信 Code 测试（不是测试 Code）
- [ ] Code 在 5 分钟内使用

---

**如果所有检查项都完成，登录应该可以成功！** 🎉

