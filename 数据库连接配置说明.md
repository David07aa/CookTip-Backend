# CookTip 数据库连接配置说明

## 📊 数据库连接信息

### 微信云托管 MySQL 数据库

| 连接类型 | 地址 | 端口 | 使用场景 |
|---------|------|------|---------|
| **内网地址** | `10.32.104.72` | `3306` | 云托管环境（生产/测试） |
| **外网地址** | `sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com` | `27821` | 本地开发 |

### 基本信息

- **数据库类型**: MySQL 5.7
- **数据库名称**: `cooktip`
- **字符集**: `utf8mb4`
- **时区**: `+08:00` (Asia/Shanghai)

---

## 🔧 配置方式

### 1. 云托管环境配置（生产/测试）

**使用内网地址，性能最佳**

`.env` 配置：

```env
DB_TYPE=mysql
DB_HOST=10.32.104.72
DB_PORT=3306
DB_USER=您的数据库账号
DB_PASSWORD=您的数据库密码
DB_NAME=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false
```

**优势**：
- ✅ 内网高速连接，延迟低
- ✅ 无需配置白名单
- ✅ 安全性高
- ✅ 免费流量

---

### 2. 本地开发环境配置

**使用外网地址，便于本地调试**

`.env` 配置：

```env
DB_TYPE=mysql
DB_HOST=sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
DB_PORT=27821
DB_USER=您的数据库账号
DB_PASSWORD=您的数据库密码
DB_NAME=cooktip
DB_CHARSET=utf8mb4
DB_SYNCHRONIZE=false
```

**⚠️ 前置条件**：
1. 在云数据库控制台开启外网访问
2. 将您的公网IP添加到白名单

**如何添加IP白名单**：
1. 登录[腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入「云数据库 MySQL」→ 选择实例
3. 点击「安全组」或「访问管理」
4. 添加您的公网IP（访问 https://ip.cn 查看）

---

## 🗄️ 数据库初始化

### 方式一：从云托管服务器初始化（推荐）

```bash
# SSH 登录到云托管服务器
# 使用内网地址连接
mysql -h 10.32.104.72 -P 3306 -u 数据库账号 -p

# 导入初始化脚本
mysql -h 10.32.104.72 -P 3306 -u 数据库账号 -p cooktip < database/init.sql

# （可选）导入测试数据
mysql -h 10.32.104.72 -P 3306 -u 数据库账号 -p cooktip < database/seed.sql
```

### 方式二：从本地初始化

```bash
# 使用外网地址连接
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u 数据库账号 -p

# 导入初始化脚本
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u 数据库账号 -p cooktip < database/init.sql

# （可选）导入测试数据
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u 数据库账号 -p cooktip < database/seed.sql
```

### 方式三：使用数据库管理工具

**Navicat / DBeaver / MySQL Workbench**

连接配置：
- **主机**: `sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com`
- **端口**: `27821`
- **用户名**: 您的数据库账号
- **密码**: 您的数据库密码
- **数据库**: `cooktip`

连接成功后，执行 `database/init.sql` 脚本。

---

## ✅ 验证连接

### 1. 命令行验证

```bash
# 使用内网地址（云托管环境）
mysql -h 10.32.104.72 -P 3306 -u 数据库账号 -p -e "SELECT VERSION();"

# 使用外网地址（本地环境）
mysql -h sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com -P 27821 -u 数据库账号 -p -e "SELECT VERSION();"
```

### 2. 应用程序验证

启动应用后查看日志：

```bash
npm run start:dev
```

成功连接会显示：
```
[TypeORM] Database connection established
[Nest] Mapped {/api/v1/...}
```

### 3. 验证数据表

```sql
USE cooktip;

-- 查看所有表
SHOW TABLES;
-- 应该显示 7 张表

-- 验证表结构
DESCRIBE users;
DESCRIBE recipes;

-- 验证分类数据
SELECT COUNT(*) FROM categories;
-- 应该返回 10
```

---

## 🔧 常见连接问题

### 问题1：本地连接外网地址失败

**错误信息**：
```
ERROR 2003 (HY000): Can't connect to MySQL server on 'sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com'
```

**解决方案**：
1. ✅ 检查是否开启了外网访问
2. ✅ 检查IP白名单是否包含您的公网IP
3. ✅ 检查本地防火墙是否放行 27821 端口
4. ✅ 尝试使用 telnet 测试连通性：
   ```bash
   telnet sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com 27821
   ```

### 问题2：密码错误

**错误信息**：
```
ERROR 1045 (28000): Access denied for user 'xxx'@'xxx.xxx.xxx.xxx'
```

**解决方案**：
1. 确认数据库账号密码是否正确
2. 检查账号权限是否足够
3. 尝试在云数据库控制台重置密码

### 问题3：数据库不存在

**错误信息**：
```
ERROR 1049 (42000): Unknown database 'cooktip'
```

**解决方案**：
```sql
-- 手动创建数据库
CREATE DATABASE cooktip DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 问题4：连接超时

**错误信息**：
```
ETIMEDOUT
```

**解决方案**：
1. 检查网络连接
2. 检查安全组配置
3. 尝试使用 ping 测试网络：
   ```bash
   ping sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com
   ```

---

## 🔒 安全建议

### 1. 生产环境

- ✅ 使用内网地址 `10.32.104.72:3306`
- ✅ 关闭公网访问
- ✅ 使用强密码（16位以上）
- ✅ 定期更换密码
- ✅ 最小权限原则

### 2. 开发环境

- ✅ 使用外网地址 `sh-cynosdbmysql-grp-pjq5f472.sql.tencentcdb.com:27821`
- ✅ 配置IP白名单（限制特定IP）
- ✅ 不要使用生产数据库
- ✅ 定期清理测试数据

### 3. IP白名单管理

```
建议白名单配置：
- 办公室固定IP
- 开发人员家庭IP
- CI/CD服务器IP
- 避免使用 0.0.0.0/0（所有IP）
```

---

## 📊 性能优化

### 连接池配置

已在 `src/app.module.ts` 中配置：

```typescript
TypeOrmModule.forRootAsync({
  useFactory: (configService: ConfigService) => ({
    type: 'mysql',
    host: configService.get('DB_HOST'),
    port: configService.get('DB_PORT'),
    username: configService.get('DB_USER'),
    password: configService.get('DB_PASSWORD'),
    database: configService.get('DB_NAME'),
    charset: 'utf8mb4',
    timezone: '+08:00',
    
    // 连接池配置
    extra: {
      connectionLimit: 10,        // 最大连接数
      waitForConnections: true,   // 等待可用连接
      queueLimit: 0,              // 队列限制
    },
    
    // 其他配置
    entities: [__dirname + '/**/*.entity{.ts,.js}'],
    synchronize: false,
    logging: process.env.NODE_ENV === 'development',
  }),
}),
```

### 监控建议

1. **慢查询监控**: 在云数据库控制台查看慢查询日志
2. **连接数监控**: 监控当前连接数，避免超过限制
3. **性能分析**: 使用 `EXPLAIN` 分析慢查询

---

## 📚 相关文档

- [快速启动.md](./快速启动.md) - 项目快速启动指南
- [云数据库配置.md](./云数据库配置.md) - 云数据库详细配置
- [项目说明.md](./项目说明.md) - 项目完整说明

---

## 📞 技术支持

如遇到连接问题：

1. 查看本文档的常见问题部分
2. 检查云数据库控制台的连接信息
3. 查看应用日志排查问题
4. 联系技术支持

---

**最后更新**: 2025-01-08  
**数据库版本**: MySQL 5.7  
**文档版本**: v1.0

